<!DOCTYPE html>

<html dir="rtl" lang="ur">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>مدرسہ انتظامی نظام</title>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400..700&amp;display=swap" rel="stylesheet"/>
<style>
        body { font-family: 'Noto Nastaliq Urdu', serif; direction: rtl; text-align: right; }
        .nav-link.active { font-weight: bold; background-color: #e9ecef; }
        .form-label { font-weight: bold; }
        .modal-header, .modal-footer { direction: rtl; }
        .modal-title { margin-left: auto; margin-right: 0;}
        .modal-header .btn-close { margin-left: 0; margin-right: auto;}
        .table th, .table td { text-align: right; vertical-align: middle; }
        .action-buttons button { margin-left: 5px; }
        .form-control, .form-select { text-align: right; }
        .custom-field-group { margin-bottom: 1rem; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
        .custom-field-group label { display: block; margin-bottom: .5rem; }
        #madrasaLogoPreview { max-width: 150px; max-height: 100px; margin-top: 10px; }
        .toast-container { position: fixed; bottom: 1rem; left: 1rem; z-index: 1090; }
        @media print {
            body * { visibility: hidden; }
            #printSection, #printSection * { visibility: visible; }
            #printSection { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
<link href="manifest.json" rel="manifest"/></head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top no-print">
<div class="container-fluid">
<a class="navbar-brand" href="#" id="navMadrasaName">مدرسہ انتظامی نظام</a>
<button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-bs-target="#navbarNav" data-bs-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav nav-pills me-auto mb-2 mb-lg-0">
<li class="nav-item"><a class="nav-link active" data-section="dashboard" href="#">ڈیش بورڈ</a></li>
<li class="nav-item"><a class="nav-link" data-section="students" href="#">طلباء</a></li>
<li class="nav-item"><a class="nav-link" data-section="teachers" href="#">اساتذہ</a></li>
<li class="nav-item"><a class="nav-link" data-section="classes" href="#">کلاسز</a></li>
<li class="nav-item"><a class="nav-link" data-section="attendance" href="#">حاضری</a></li>
<li class="nav-item"><a class="nav-link" data-section="fees" href="#">فیس</a></li>
<li class="nav-item"><a class="nav-link" data-section="salaries" href="#">تنخواہیں</a></li>
<li class="nav-item"><a class="nav-link" data-section="inventory" href="#">انوینٹری</a></li>
<li class="nav-item"><a class="nav-link" data-section="expenses" href="#">اخراجات</a></li>
<li class="nav-item"><a class="nav-link" data-section="reports" href="#">رپورٹس</a></li>
<li class="nav-item"><a class="nav-link" data-section="backupRestore" href="#">بیک اپ / بحال کریں</a></li>
<li class="nav-item"><a class="nav-link" data-section="settings" href="#">ترتیبات</a></li>
</ul>
</div>
</div>
</nav>
<div class="container-fluid mt-3">
<div class="app-section" id="dashboard">
<h2>ڈیش بورڈ</h2>
<p>مدرسہ انتظامی نظام میں خوش آمدید۔</p>
<div class="row">
<div class="col-md-3 mb-3">
<div class="card text-center">
<div class="card-body">
<h5 class="card-title">کل طلباء</h5>
<p class="card-text fs-4" id="dashboardTotalStudents">0</p>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card text-center">
<div class="card-body">
<h5 class="card-title">کل اساتذہ</h5>
<p class="card-text fs-4" id="dashboardTotalTeachers">0</p>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card text-center">
<div class="card-body">
<h5 class="card-title">کل کلاسز</h5>
<p class="card-text fs-4" id="dashboardTotalClasses">0</p>
</div>
</div>
</div>
<div class="col-md-3 mb-3">
<div class="card text-center">
<div class="card-body">
<h5 class="card-title">آج کی آمدنی</h5>
<p class="card-text fs-4" id="dashboardTodayIncome">0</p>
</div>
</div>
</div>
</div>
</div>
<div class="app-section d-none" id="students">
<h2>طلباء کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" data-bs-target="#studentModal" data-bs-toggle="modal" onclick="prepareStudentForm()">نیا طالب علم شامل کریں</button>
<div class="input-group mb-3 no-print">
<input class="form-control" id="studentSearch" placeholder="تلاش کریں (نام، والد کا نام، کلاس)" type="text"/>
<button class="btn btn-outline-secondary" onclick="displayStudents()" type="button">تلاش</button>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>نام</th>
<th>والد کا نام</th>
<th>عمر</th>
<th>کلاس</th>
<th>داخلہ تاریخ</th>
<th>رابطہ نمبر</th>
<th>پتہ</th>
<th id="studentCustomFieldsHeader">اضافی معلومات</th>
<th class="no-print">کارروائیاں</th>
</tr>
</thead>
<tbody id="studentsTableBody">
</tbody>
</table>
</div>
</div>
<div class="app-section d-none" id="teachers">
<h2>اساتذہ کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" data-bs-target="#teacherModal" data-bs-toggle="modal" onclick="prepareTeacherForm()">نیا استاد شامل کریں</button>
<div class="input-group mb-3 no-print">
<input class="form-control" id="teacherSearch" placeholder="تلاش کریں (نام)" type="text"/>
<button class="btn btn-outline-secondary" onclick="displayTeachers()" type="button">تلاش</button>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>نام</th>
<th>رابطہ نمبر</th>
<th>پتہ</th>
<th>شمولیت کی تاریخ</th>
<th id="teacherCustomFieldsHeader">اضافی معلومات</th>
<th class="no-print">کارروائیاں</th>
</tr>
</thead>
<tbody id="teachersTableBody">
</tbody>
</table>
</div>
</div>
<div class="app-section d-none" id="classes">
<h2>کلاسز کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" data-bs-target="#classModal" data-bs-toggle="modal" onclick="prepareClassForm()">نئی کلاس بنائیں</button>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>کلاس کا نام</th>
<th>تفویض کردہ استاد</th>
<th>کل طلباء</th>
<th class="no-print">کارروائیاں</th>
</tr>
</thead>
<tbody id="classesTableBody">
</tbody>
</table>
</div>
</div>
<div class="app-section d-none" id="attendance">
<h2>حاضری</h2>
<div class="row mb-3 no-print">
<div class="col-md-4">
<label class="form-label" for="attendanceClassSelect">کلاس منتخب کریں</label>
<select class="form-select" id="attendanceClassSelect" onchange="loadAttendanceSheet()"></select>
</div>
<div class="col-md-4">
<label class="form-label" for="attendanceDate">تاریخ منتخب کریں</label>
<input class="form-control" id="attendanceDate" onchange="loadAttendanceSheet()" type="date"/>
</div>
<div class="col-md-4 align-self-end">
<button class="btn btn-success" onclick="saveAttendance()">حاضری محفوظ کریں</button>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>طالب علم کا نام</th>
<th>حاضری</th>
</tr>
</thead>
<tbody id="attendanceTableBody">
</tbody>
</table>
</div>
<button class="btn btn-secondary mt-3 no-print" onclick="generateAttendanceReport()">حاضری رپورٹ دیکھیں</button>
</div>
<div class="app-section d-none" id="fees">
<h2>فیس کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" data-bs-target="#feeStructureModal" data-bs-toggle="modal" onclick="loadClassOptions('#feeStructureClass')">فیس اسٹرکچر سیٹ کریں</button>
<button class="btn btn-success mb-3 no-print" data-bs-target="#feePaymentModal" data-bs-toggle="modal" onclick="loadStudentOptions('#feePaymentStudent')">فیس وصول کریں</button>
<h3 class="mt-4">فیس کی تفصیلات</h3>
<div class="input-group mb-3 no-print">
<input class="form-control" id="feeSearch" placeholder="طالب علم کے نام سے تلاش کریں" type="text"/>
<select class="form-select" id="feeStatusFilter">
<option value="">تمام اسٹیٹس</option>
<option value="pending">واجب الادا</option>
<option value="paid">ادا شدہ</option>
</select>
<button class="btn btn-outline-secondary" onclick="displayFeeRecords()" type="button">تلاش</button>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>طالب علم</th>
<th>کلاس</th>
<th>مہینہ/مدت</th>
<th>مقررہ فیس</th>
<th>وصول شدہ رقم</th>
<th>تاریخ وصولی</th>
<th>بقايا</th>
<th>اسٹیٹس</th>
<th class="no-print">کارروائی</th>
</tr>
</thead>
<tbody id="feesTableBody">
</tbody>
</table>
</div>
</div>
<div class="app-section d-none" id="salaries">
<h2>تنخواہوں کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" data-bs-target="#salaryStructureModal" data-bs-toggle="modal" onclick="loadTeacherOptions('#salaryStructureTeacher')">تنخواہ اسٹرکچر سیٹ کریں</button>
<button class="btn btn-success mb-3 no-print" data-bs-target="#salaryPaymentModal" data-bs-toggle="modal" onclick="loadTeacherOptions('#salaryPaymentTeacher')">تنخواہ ادا کریں</button>
<h3 class="mt-4">تنخواہ کی تفصیلات</h3>
<div class="input-group mb-3 no-print">
<input class="form-control" id="salarySearch" placeholder="استاد کے نام سے تلاش کریں" type="text"/>
<button class="btn btn-outline-secondary" onclick="displaySalaryRecords()" type="button">تلاش</button>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>استاد</th>
<th>مہینہ/مدت</th>
<th>مقررہ تنخواہ</th>
<th>ادا شدہ رقم</th>
<th>ادائیگی کی تاریخ</th>
<th>اسٹیٹس</th>
<th class="no-print">کارروائی</th>
</tr>
</thead>
<tbody id="salariesTableBody">
</tbody>
</table>
</div>
</div>
<div class="app-section d-none" id="inventory">
<h2>انوینٹری کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" data-bs-target="#inventoryModal" data-bs-toggle="modal" onclick="prepareInventoryForm()">نیا آئٹم شامل کریں</button>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>آئٹم کا نام</th>
<th>مقدار</th>
<th>تفصیل</th>
<th>شامل کرنے کی تاریخ</th>
<th class="no-print">کارروائیاں</th>
</tr>
</thead>
<tbody id="inventoryTableBody">
</tbody>
</table>
</div>
</div>
<div class="app-section d-none" id="expenses">
<h2>آمدنی و اخراجات</h2>
<button class="btn btn-success mb-3 no-print" data-bs-target="#transactionModal" data-bs-toggle="modal" onclick="prepareTransactionForm('income')">نئی آمدنی شامل کریں</button>
<button class="btn btn-danger mb-3 no-print" data-bs-target="#transactionModal" data-bs-toggle="modal" onclick="prepareTransactionForm('expense')">نیا خرچہ شامل کریں</button>
<div class="input-group mb-3 no-print">
<input class="form-control" id="expenseMonthFilter" type="month"/>
<select class="form-select" id="expenseTypeFilter">
<option value="">تمام اقسام</option>
<option value="income">آمدنی</option>
<option value="expense">خرچہ</option>
</select>
<button class="btn btn-outline-secondary" onclick="displayTransactions()" type="button">فلٹر</button>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>شمار</th>
<th>تاریخ</th>
<th>تفصیل</th>
<th>قسم</th>
<th>رقم</th>
<th class="no-print">کارروائیاں</th>
</tr>
</thead>
<tbody id="transactionsTableBody">
</tbody>
</table>
</div>
<div class="mt-3">
<h5>خلاصہ:</h5>
<p>کل آمدنی: <span id="totalIncome">0</span></p>
<p>کل اخراجات: <span id="totalExpenses">0</span></p>
<p>بیلنس: <span id="netBalance">0</span></p>
</div>
</div>
<div class="app-section d-none" id="reports">
<h2>رپورٹس</h2>
<div class="list-group no-print">
<button class="list-group-item list-group-item-action" onclick="generateReport('students')" type="button">طلباء کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="generateReport('teachers')" type="button">اساتذہ کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="generateReport('classes')" type="button">کلاسز کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="showAttendanceReportOptions()" type="button">حاضری کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="showFeeReportOptions()" type="button">فیس کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="showSalaryReportOptions()" type="button">تنخواہوں کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="generateReport('inventory')" type="button">انوینٹری کی رپورٹ</button>
<button class="list-group-item list-group-item-action" onclick="showExpenseReportOptions()" type="button">آمدنی و اخراجات کی رپورٹ</button>
</div>
<div class="mt-3 no-print" id="reportOptionsContainer"></div>
<div class="mt-4" id="reportOutput">
<div class="d-flex justify-content-between align-items-center mb-3 no-print">
<h3 id="reportTitle">رپورٹ</h3>
<div>
<button class="btn btn-sm btn-secondary" onclick="exportReportToCSV()">CSV میں ایکسپورٹ کریں</button>
<button class="btn btn-sm btn-info" onclick="printReport()">پرنٹ کریں</button>
</div>
</div>
<div id="printSection">
<div class="text-center mb-3 d-none" id="reportHeader">
<img alt="Madrasa Logo" id="reportLogo" src="" style="max-height: 80px; margin-bottom: 10px;"/>
<h4 id="reportMadrasaName"></h4>
<p id="reportMadrasaAddress"></p>
<p id="reportMadrasaPhone"></p>
<hr/>
</div>
<div class="table-responsive" id="reportTableContainer">
</div>
</div>
</div>
</div>
<div class="app-section d-none" id="backupRestore">
<h2>بیک اپ / بحال کریں</h2>
<div class="card mb-3">
<div class="card-body">
<h5 class="card-title">ڈیٹا بیک اپ</h5>
<p class="card-text">اپنے تمام مدرسہ ڈیٹا کا بیک اپ فائل میں محفوظ کریں۔</p>
<button class="btn btn-primary" onclick="backupData()">بیک اپ بنائیں</button>
</div>
</div>
<div class="card">
<div class="card-body">
<h5 class="card-title">ڈیٹا بحال کریں</h5>
<p class="card-text">بیک اپ فائل سے ڈیٹا بحال کریں۔ موجودہ ڈیٹا حذف ہو جائے گا۔</p>
<label class="form-label" for="restoreFile">بیک اپ فائل منتخب کریں (.json)</label>
<input accept=".json" class="form-control" id="restoreFile" type="file"/>
<button class="btn btn-warning mt-2" onclick="restoreData()">ڈیٹا بحال کریں</button>
</div>
</div>
</div>
<div class="app-section d-none" id="settings">
<h2>ترتیبات</h2>
<form id="settingsForm">
<div class="mb-3">
<label class="form-label" for="madrasaName">مدرسہ کا نام</label>
<input class="form-control" id="madrasaName" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="madrasaAddress">مدرسہ کا پتہ</label>
<textarea class="form-control" id="madrasaAddress" rows="3"></textarea>
</div>
<div class="mb-3">
<label class="form-label" for="madrasaPhone">مدرسہ فون نمبر</label>
<input class="form-control" id="madrasaPhone" type="tel"/>
</div>
<div class="mb-3">
<label class="form-label" for="madrasaLogo">مدرسہ لوگو</label>
<input accept="image/*" class="form-control" id="madrasaLogo" type="file"/>
<img alt="لوگو پیش نظارہ" class="d-none" id="madrasaLogoPreview" src="#"/>
<input id="madrasaLogoData" type="hidden"/>
</div>
<hr/>
<h4>اضافی فیلڈز کا انتظام</h4>
<div class="row">
<div class="col-md-6">
<h5>طلباء کے لیے اضافی فیلڈز</h5>
<div id="studentCustomFieldsContainer"></div>
<button class="btn btn-sm btn-secondary mt-2" onclick="addCustomFieldInput('student')" type="button">نیا فیلڈ شامل کریں</button>
</div>
<div class="col-md-6">
<h5>اساتذہ کے لیے اضافی فیلڈز</h5>
<div id="teacherCustomFieldsContainer"></div>
<button class="btn btn-sm btn-secondary mt-2" onclick="addCustomFieldInput('teacher')" type="button">نیا فیلڈ شامل کریں</button>
</div>
</div>
<button class="btn btn-success mt-4" onclick="saveSettings()" type="button">ترتیبات محفوظ کریں</button>
</form>
</div>
</div>
<!-- Modals -->
<!-- Student Modal -->
<div aria-hidden="true" aria-labelledby="studentModalLabel" class="modal fade" id="studentModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="studentModalLabel">طالب علم فارم</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="studentForm">
<input id="studentId" type="hidden"/>
<div class="row">
<div class="col-md-6 mb-3">
<label class="form-label" for="studentName">نام</label>
<input class="form-control" id="studentName" required="" type="text"/>
</div>
<div class="col-md-6 mb-3">
<label class="form-label" for="studentFatherName">والد کا نام</label>
<input class="form-control" id="studentFatherName" required="" type="text"/>
</div>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label class="form-label" for="studentAge">عمر</label>
<input class="form-control" id="studentAge" type="number"/>
</div>
<div class="col-md-6 mb-3">
<label class="form-label" for="studentClass">کلاس</label>
<select class="form-select" id="studentClass" required=""></select>
</div>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label class="form-label" for="studentAdmissionDate">داخلہ تاریخ</label>
<input class="form-control" id="studentAdmissionDate" required="" type="date"/>
</div>
<div class="col-md-6 mb-3">
<label class="form-label" for="studentContact">رابطہ نمبر</label>
<input class="form-control" id="studentContact" type="tel"/>
</div>
</div>
<div class="mb-3">
<label class="form-label" for="studentAddress">پتہ</label>
<textarea class="form-control" id="studentAddress" rows="2"></textarea>
</div>
<hr/>
<h5>اضافی معلومات</h5>
<div id="studentCustomFieldsFormContainer"></div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveStudent()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Teacher Modal -->
<div aria-hidden="true" aria-labelledby="teacherModalLabel" class="modal fade" id="teacherModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="teacherModalLabel">استاد فارم</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="teacherForm">
<input id="teacherId" type="hidden"/>
<div class="row">
<div class="col-md-6 mb-3">
<label class="form-label" for="teacherName">نام</label>
<input class="form-control" id="teacherName" required="" type="text"/>
</div>
<div class="col-md-6 mb-3">
<label class="form-label" for="teacherContact">رابطہ نمبر</label>
<input class="form-control" id="teacherContact" type="tel"/>
</div>
</div>
<div class="row">
<div class="col-md-6 mb-3">
<label class="form-label" for="teacherJoinDate">شمولیت کی تاریخ</label>
<input class="form-control" id="teacherJoinDate" required="" type="date"/>
</div>
<div class="col-md-6 mb-3">
<label class="form-label" for="teacherAddress">پتہ</label>
<textarea class="form-control" id="teacherAddress" rows="1"></textarea>
</div>
</div>
<hr/>
<h5>اضافی معلومات</h5>
<div id="teacherCustomFieldsFormContainer"></div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveTeacher()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Class Modal -->
<div aria-hidden="true" aria-labelledby="classModalLabel" class="modal fade" id="classModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="classModalLabel">کلاس فارم</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="classForm">
<input id="classId" type="hidden"/>
<div class="mb-3">
<label class="form-label" for="className">کلاس کا نام</label>
<input class="form-control" id="className" required="" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="classTeacher">استاد تفویض کریں</label>
<select class="form-select" id="classTeacher">
<option value="">کوئی نہیں</option>
</select>
</div>
<div class="mb-3">
<label class="form-label" for="classStudents">طلباء تفویض کریں</label>
<select class="form-select" id="classStudents" multiple="" size="5"></select>
<small class="form-text text-muted">ایک سے زیادہ طلباء منتخب کرنے کے لیے Ctrl/Cmd دبا کر کلک کریں۔</small>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveClass()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Fee Structure Modal -->
<div aria-hidden="true" aria-labelledby="feeStructureModalLabel" class="modal fade" id="feeStructureModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="feeStructureModalLabel">فیس اسٹرکچر سیٹ کریں</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="feeStructureForm">
<div class="mb-3">
<label class="form-label" for="feeStructureClass">کلاس</label>
<select class="form-select" id="feeStructureClass" onchange="loadFeeStructure()" required=""></select>
</div>
<div class="mb-3">
<label class="form-label" for="feeStructureAmount">ماہانہ فیس رقم</label>
<input class="form-control" id="feeStructureAmount" min="0" required="" type="number"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveFeeStructure()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Fee Payment Modal -->
<div aria-hidden="true" aria-labelledby="feePaymentModalLabel" class="modal fade" id="feePaymentModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="feePaymentModalLabel">فیس وصولی</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="feePaymentForm">
<input id="feePaymentId" type="hidden"/>
<div class="mb-3">
<label class="form-label" for="feePaymentStudent">طالب علم</label>
<select class="form-select" id="feePaymentStudent" onchange="loadStudentFeeInfo()" required=""></select>
</div>
<div class="mb-3">
<label class="form-label" for="feePaymentMonth">مہینہ/مدت</label>
<input class="form-control" id="feePaymentMonth" required="" type="month"/>
</div>
<div class="mb-3">
<label class="form-label" for="feePaymentAmountDue">مقررہ فیس</label>
<input class="form-control" id="feePaymentAmountDue" readonly="" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="feePaymentAmountPaid">وصول شدہ رقم</label>
<input class="form-control" id="feePaymentAmountPaid" min="0" required="" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="feePaymentDate">وصولی کی تاریخ</label>
<input class="form-control" id="feePaymentDate" required="" type="date"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveFeePayment()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Salary Structure Modal -->
<div aria-hidden="true" aria-labelledby="salaryStructureModalLabel" class="modal fade" id="salaryStructureModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="salaryStructureModalLabel">تنخواہ اسٹرکچر سیٹ کریں</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="salaryStructureForm">
<div class="mb-3">
<label class="form-label" for="salaryStructureTeacher">استاد</label>
<select class="form-select" id="salaryStructureTeacher" onchange="loadSalaryStructure()" required=""></select>
</div>
<div class="mb-3">
<label class="form-label" for="salaryStructureAmount">ماہانہ تنخواہ رقم</label>
<input class="form-control" id="salaryStructureAmount" min="0" required="" type="number"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveSalaryStructure()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Salary Payment Modal -->
<div aria-hidden="true" aria-labelledby="salaryPaymentModalLabel" class="modal fade" id="salaryPaymentModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="salaryPaymentModalLabel">تنخواہ ادائیگی</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="salaryPaymentForm">
<input id="salaryPaymentId" type="hidden"/>
<div class="mb-3">
<label class="form-label" for="salaryPaymentTeacher">استاد</label>
<select class="form-select" id="salaryPaymentTeacher" onchange="loadTeacherSalaryInfo()" required=""></select>
</div>
<div class="mb-3">
<label class="form-label" for="salaryPaymentMonth">مہینہ/مدت</label>
<input class="form-control" id="salaryPaymentMonth" required="" type="month"/>
</div>
<div class="mb-3">
<label class="form-label" for="salaryPaymentAmountDue">مقررہ تنخواہ</label>
<input class="form-control" id="salaryPaymentAmountDue" readonly="" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="salaryPaymentAmountPaid">ادا شدہ رقم</label>
<input class="form-control" id="salaryPaymentAmountPaid" min="0" required="" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="salaryPaymentDate">ادائیگی کی تاریخ</label>
<input class="form-control" id="salaryPaymentDate" required="" type="date"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveSalaryPayment()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Inventory Modal -->
<div aria-hidden="true" aria-labelledby="inventoryModalLabel" class="modal fade" id="inventoryModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="inventoryModalLabel">انوینٹری فارم</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="inventoryForm">
<input id="inventoryId" type="hidden"/>
<div class="mb-3">
<label class="form-label" for="inventoryItemName">آئٹم کا نام</label>
<input class="form-control" id="inventoryItemName" required="" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="inventoryQuantity">مقدار</label>
<input class="form-control" id="inventoryQuantity" min="0" required="" type="number"/>
</div>
<div class="mb-3">
<label class="form-label" for="inventoryDescription">تفصیل</label>
<textarea class="form-control" id="inventoryDescription" rows="3"></textarea>
</div>
<input id="inventoryAddDate" type="hidden"/>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveInventoryItem()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Transaction Modal (Income/Expense) -->
<div aria-hidden="true" aria-labelledby="transactionModalLabel" class="modal fade" id="transactionModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="transactionModalLabel">لین دین فارم</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<form id="transactionForm">
<input id="transactionId" type="hidden"/>
<input id="transactionType" type="hidden"/>
<div class="mb-3">
<label class="form-label" for="transactionDate">تاریخ</label>
<input class="form-control" id="transactionDate" required="" type="date"/>
</div>
<div class="mb-3">
<label class="form-label" for="transactionDescription">تفصیل</label>
<input class="form-control" id="transactionDescription" required="" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="transactionAmount">رقم</label>
<input class="form-control" id="transactionAmount" min="0" required="" type="number"/>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">بند کریں</button>
<button class="btn btn-primary" onclick="saveTransaction()" type="button">محفوظ کریں</button>
</div>
</div>
</div>
</div>
<!-- Confirmation Modal -->
<div aria-hidden="true" aria-labelledby="confirmModalLabel" class="modal fade" id="confirmModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="confirmModalLabel">تصدیق</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p id="confirmModalMessage">کیا آپ واقعی حذف کرنا چاہتے ہیں؟</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">منسوخ کریں</button>
<button class="btn btn-danger" id="confirmModalButton" type="button">جی کریں</button>
</div>
</div>
</div>
</div>
<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 start-0 p-3">
<div aria-atomic="true" aria-live="assertive" class="toast" id="appToast" role="alert">
<div class="toast-header">
<strong class="me-auto" id="toastTitle">اطلاع</strong>
<button aria-label="Close" class="btn-close" data-bs-dismiss="toast" type="button"></button>
</div>
<div class="toast-body" id="toastBody">
</div>
</div>
</div>
<script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const DB_NAME = 'madrasaDB';
    const DB_VERSION = 1;
    let db;
    let currentSettings = {
        madrasaName: 'مدرسہ انتظامی نظام',
        madrasaAddress: '',
        madrasaPhone: '',
        madrasaLogoData: '',
        studentCustomFields: [],
        teacherCustomFields: []
    };
    let confirmCallback = null;
    let confirmModalInstance = null;
    let toastInstance = null;

    const storeNames = ['settings', 'students', 'teachers', 'classes', 'attendance', 'fees', 'salaries', 'inventory', 'transactions']; // Added 'transactions'

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error("Database error: ", event.target.error);
                showToast("خرابی", "ڈیٹا بیس کھولنے میں ناکامی۔", "danger");
                reject("Database error: " + event.target.error);
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Database opened successfully");
                resolve(db);
            };

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                console.log("Upgrading database...");

                storeNames.forEach(name => {
                    if (!db.objectStoreNames.contains(name)) {
                       const objectStore = db.createObjectStore(name, { keyPath: 'id', autoIncrement: true });
                       // Add indexes based on store type
                       switch(name) {
                           case 'students':
                               objectStore.createIndex('name', 'name', { unique: false });
                               objectStore.createIndex('fatherName', 'fatherName', { unique: false });
                               objectStore.createIndex('classId', 'classId', { unique: false });
                               break;
                           case 'teachers':
                               objectStore.createIndex('name', 'name', { unique: false });
                               break;
                           case 'classes':
                               objectStore.createIndex('name', 'name', { unique: true });
                               break;
                           case 'attendance':
                               objectStore.createIndex('date_studentId', ['date', 'studentId'], { unique: true });
                               objectStore.createIndex('date', 'date', { unique: false });
                               objectStore.createIndex('classId', 'classId', { unique: false });
                               break;
                           case 'fees':
                               objectStore.createIndex('studentId_month', ['studentId', 'month'], { unique: true });
                               objectStore.createIndex('studentId', 'studentId', { unique: false });
                               objectStore.createIndex('status', 'status', { unique: false });
                               break;
                          case 'salaries':
                               objectStore.createIndex('teacherId_month', ['teacherId', 'month'], { unique: true });
                               objectStore.createIndex('teacherId', 'teacherId', { unique: false });
                               break;
                           case 'inventory':
                               objectStore.createIndex('name', 'name', { unique: false });
                               break;
                           case 'transactions': // Indexes for transactions
                               objectStore.createIndex('date', 'date', { unique: false });
                               objectStore.createIndex('type', 'type', { unique: false });
                               break;
                           case 'settings':
                               // Settings usually has only one record, key path might not be needed or set differently. Let's assume one record with fixed key 1
                               db.deleteObjectStore('settings'); // Recreate if structure changes
                               db.createObjectStore('settings', { keyPath: 'id' });
                               break;
                       }
                    }
                });
                 console.log("Database upgrade complete");
            };
        });
    }

    function showToast(title, message, type = 'success') {
        const toastEl = document.getElementById('appToast');
        const toastTitleEl = document.getElementById('toastTitle');
        const toastBodyEl = document.getElementById('toastBody');

        toastTitleEl.textContent = title;
        toastBodyEl.textContent = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');
        toastEl.classList.add(`bg-${type}`, 'text-white');

        if (!toastInstance) {
            toastInstance = new bootstrap.Toast(toastEl);
        }
        toastInstance.show();
    }

     function confirmAction(message, callback) {
        const confirmModalMessage = document.getElementById('confirmModalMessage');
        const confirmModalButton = document.getElementById('confirmModalButton');

        confirmModalMessage.textContent = message || 'کیا آپ واقعی یہ عمل انجام دینا چاہتے ہیں؟'; // Default message
        confirmCallback = callback;

        if (!confirmModalInstance) {
             confirmModalInstance = new bootstrap.Modal(document.getElementById('confirmModal'));
        }

        confirmModalButton.onclick = () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            confirmModalInstance.hide();
            confirmCallback = null; // Reset callback
        };

        confirmModalInstance.show();
    }


    // Generic CRUD functions
    function addToStore(storeName, data) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.add(data);

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    function getFromStore(storeName, key) {
         return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.get(key);

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

     function getAllFromStore(storeName, indexName = null, query = null) {
         return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            let request;

            if (indexName && query !== null) {
                const index = store.index(indexName);
                request = index.getAll(query);
            } else {
                 request = store.getAll();
            }

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

     function updateInStore(storeName, data) {
         return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.put(data); // put handles both update and insert

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });
    }

    function deleteFromStore(storeName, key) {
         return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.delete(key);

            request.onsuccess = (event) => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

     function clearStore(storeName) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.clear();

            request.onsuccess = () => resolve();
            request.onerror = (event) => reject(event.target.error);
        });
    }

    // --- Settings ---
    async function loadSettings() {
         try {
            let settings = await getFromStore('settings', 1); // Assuming settings are stored with key 1
            if (settings) {
                 currentSettings = settings;
            } else {
                // If no settings found, save the default ones with id 1
                currentSettings.id = 1;
                await addToStore('settings', currentSettings);
                console.log("Default settings initialized.");
            }
            applySettings();
            renderCustomFieldInputs('student');
            renderCustomFieldInputs('teacher');
        } catch (error) {
            console.error("Error loading settings:", error);
             // Use default settings if loading fails
             currentSettings.id = 1;
             applySettings();
        }
    }

     function applySettings() {
        document.getElementById('madrasaName').value = currentSettings.madrasaName || '';
        document.getElementById('navMadrasaName').textContent = currentSettings.madrasaName || 'مدرسہ انتظامی نظام';
        document.getElementById('madrasaAddress').value = currentSettings.madrasaAddress || '';
        document.getElementById('madrasaPhone').value = currentSettings.madrasaPhone || '';
        document.getElementById('madrasaLogoData').value = currentSettings.madrasaLogoData || '';
        const logoPreview = document.getElementById('madrasaLogoPreview');
        if (currentSettings.madrasaLogoData) {
            logoPreview.src = currentSettings.madrasaLogoData;
            logoPreview.classList.remove('d-none');
        } else {
            logoPreview.classList.add('d-none');
            logoPreview.src = '#';
        }
         // Apply custom field headers
        updateCustomFieldHeaders();
    }

    function handleLogoUpload(event) {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('madrasaLogoData').value = e.target.result;
                const logoPreview = document.getElementById('madrasaLogoPreview');
                logoPreview.src = e.target.result;
                logoPreview.classList.remove('d-none');
            }
            reader.readAsDataURL(file);
        } else {
             document.getElementById('madrasaLogoData').value = '';
             const logoPreview = document.getElementById('madrasaLogoPreview');
             logoPreview.src = '#';
             logoPreview.classList.add('d-none');
             if(file) showToast("خرابی", "براہ کرم ایک درست تصویری فائل منتخب کریں۔", "warning");
        }
    }
    document.getElementById('madrasaLogo').addEventListener('change', handleLogoUpload);

    function addCustomFieldInput(type, fieldLabel = '') {
        const containerId = type === 'student' ? 'studentCustomFieldsContainer' : 'teacherCustomFieldsContainer';
        const container = document.getElementById(containerId);
        const fieldIndex = container.children.length;
        const div = document.createElement('div');
        div.classList.add('input-group', 'mb-2');
        div.innerHTML = `
            <input type="text" class="form-control custom-field-label" placeholder="فیلڈ کا نام (مثلاً، پیشہ)" value="${fieldLabel}" data-type="${type}">
            <button class="btn btn-outline-danger btn-sm" type="button" onclick="removeCustomFieldInput(this)">حذف کریں</button>
        `;
        container.appendChild(div);
    }

    function removeCustomFieldInput(button) {
        button.closest('.input-group').remove();
    }

    function renderCustomFieldInputs(type) {
        const containerId = type === 'student' ? 'studentCustomFieldsContainer' : 'teacherCustomFieldsContainer';
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Clear existing
        const fields = type === 'student' ? currentSettings.studentCustomFields : currentSettings.teacherCustomFields;
        fields.forEach(field => addCustomFieldInput(type, field));
    }

    async function saveSettings() {
        const studentFields = Array.from(document.querySelectorAll('#studentCustomFieldsContainer .custom-field-label'))
                                .map(input => input.value.trim())
                                .filter(label => label); // Get non-empty student field labels
        const teacherFields = Array.from(document.querySelectorAll('#teacherCustomFieldsContainer .custom-field-label'))
                                .map(input => input.value.trim())
                                .filter(label => label); // Get non-empty teacher field labels

        currentSettings.madrasaName = document.getElementById('madrasaName').value;
        currentSettings.madrasaAddress = document.getElementById('madrasaAddress').value;
        currentSettings.madrasaPhone = document.getElementById('madrasaPhone').value;
        currentSettings.madrasaLogoData = document.getElementById('madrasaLogoData').value;
        currentSettings.studentCustomFields = studentFields;
        currentSettings.teacherCustomFields = teacherFields;
        currentSettings.id = 1; // Ensure ID is 1

         try {
             await updateInStore('settings', currentSettings);
             applySettings();
             showToast("کامیابی", "ترتیبات کامیابی سے محفوظ ہوگئیں۔");
         } catch (error) {
             console.error("Error saving settings:", error);
             showToast("خرابی", "ترتیبات محفوظ کرنے میں ناکامی۔", "danger");
         }
    }

     function updateCustomFieldHeaders() {
        const studentHeader = document.getElementById('studentCustomFieldsHeader');
        const teacherHeader = document.getElementById('teacherCustomFieldsHeader');

        if (currentSettings.studentCustomFields && currentSettings.studentCustomFields.length > 0) {
            studentHeader.textContent = 'اضافی معلومات (' + currentSettings.studentCustomFields.join(', ') + ')';
            studentHeader.style.display = '';
        } else {
            studentHeader.style.display = 'none';
        }

        if (currentSettings.teacherCustomFields && currentSettings.teacherCustomFields.length > 0) {
             teacherHeader.textContent = 'اضافی معلومات (' + currentSettings.teacherCustomFields.join(', ') + ')';
             teacherHeader.style.display = '';
        } else {
             teacherHeader.style.display = 'none';
        }
    }

    function renderCustomFieldsForForm(type, existingData = {}) {
        const containerId = type === 'student' ? 'studentCustomFieldsFormContainer' : 'teacherCustomFieldsFormContainer';
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        const fields = type === 'student' ? currentSettings.studentCustomFields : currentSettings.teacherCustomFields;

        if (!fields || fields.length === 0) {
            container.innerHTML = '<p>کوئی اضافی فیلڈز موجود نہیں۔ ترتیبات میں شامل کریں۔</p>';
            return;
        }

        fields.forEach(label => {
            const fieldId = `${type}Custom_${label.replace(/\s+/g, '_')}`; // Create a safe ID
            const value = existingData.customFields && existingData.customFields[label] ? existingData.customFields[label] : '';
            const div = document.createElement('div');
            div.classList.add('mb-3', 'custom-field-group');
            div.innerHTML = `
                <label for="${fieldId}" class="form-label">${label}</label>
                <input type="text" class="form-control custom-field-input" id="${fieldId}" data-label="${label}" value="${value}">
            `;
            container.appendChild(div);
        });
    }

     function getCustomFieldsFromForm(type) {
        const containerId = type === 'student' ? 'studentCustomFieldsFormContainer' : 'teacherCustomFieldsFormContainer';
        const inputs = document.querySelectorAll(`#${containerId} .custom-field-input`);
        const customFields = {};
        inputs.forEach(input => {
            const label = input.getAttribute('data-label');
            if (label) {
                 customFields[label] = input.value.trim();
            }
        });
        return customFields;
    }

    function displayCustomFieldsInTable(data) {
        const fields = data.type === 'student' ? currentSettings.studentCustomFields : currentSettings.teacherCustomFields;
        if (!fields || fields.length === 0 || !data.customFields) return 'N/A';

        return fields.map(label => {
            const value = data.customFields[label] || ' - ';
            // return `<strong>${label}:</strong> ${value}`; // Older display
             return value; // Simpler, just value as requested by updated headers
        }).join('<br>');
    }


    // --- Student Management ---
    function prepareStudentForm(studentId = null) {
        document.getElementById('studentForm').reset();
        document.getElementById('studentId').value = '';
        loadClassOptions('#studentClass'); // Load classes into dropdown
        renderCustomFieldsForForm('student'); // Render empty custom fields

        if (studentId) {
            getFromStore('students', studentId).then(student => {
                if (student) {
                    document.getElementById('studentId').value = student.id;
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('studentFatherName').value = student.fatherName;
                    document.getElementById('studentAge').value = student.age || '';
                    document.getElementById('studentClass').value = student.classId || '';
                    document.getElementById('studentAdmissionDate').value = student.admissionDate;
                    document.getElementById('studentContact').value = student.contact || '';
                    document.getElementById('studentAddress').value = student.address || '';
                    renderCustomFieldsForForm('student', student); // Render with existing data
                }
                document.getElementById('studentModalLabel').textContent = 'طالب علم میں ترمیم کریں';
            }).catch(error => console.error("Error fetching student:", error));
        } else {
             document.getElementById('studentModalLabel').textContent = 'نیا طالب علم شامل کریں';
             document.getElementById('studentAdmissionDate').valueAsDate = new Date(); // Default to today
        }
    }

    async function saveStudent() {
        const studentId = parseInt(document.getElementById('studentId').value) || null;
        const classIdValue = document.getElementById('studentClass').value;
        const studentData = {
            name: document.getElementById('studentName').value.trim(),
            fatherName: document.getElementById('studentFatherName').value.trim(),
            age: parseInt(document.getElementById('studentAge').value) || null,
            classId: classIdValue ? parseInt(classIdValue) : null,
            admissionDate: document.getElementById('studentAdmissionDate').value,
            contact: document.getElementById('studentContact').value.trim(),
            address: document.getElementById('studentAddress').value.trim(),
            customFields: getCustomFieldsFromForm('student'),
            type: 'student' // Needed for custom field rendering in table
        };

        if (!studentData.name || !studentData.fatherName || !studentData.admissionDate || !studentData.classId) {
             showToast("خرابی", "براہ کرم تمام مطلوبہ فیلڈز پُر کریں۔ (نام، والد کا نام، کلاس، داخلہ تاریخ)", "warning");
             return;
        }

        try {
            if (studentId) {
                studentData.id = studentId;
                await updateInStore('students', studentData);
                showToast("کامیابی", "طالب علم کا ریکارڈ کامیابی سے اپ ڈیٹ ہوگیا۔");
            } else {
                await addToStore('students', studentData);
                 showToast("کامیابی", "نیا طالب علم کامیابی سے شامل ہوگیا۔");
            }
            bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
            displayStudents();
            updateDashboardStats(); // Update dashboard
        } catch (error) {
            console.error("Error saving student:", error);
            showToast("خرابی", "طالب علم کو محفوظ کرنے میں ناکامی۔", "danger");
        }
    }

    async function displayStudents() {
         const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
         try {
            let students = await getAllFromStore('students');
            let classes = await getAllFromStore('classes');
            const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = ''; // Clear previous data

             // Filter students
             students = students.filter(student => {
                 const className = student.classId ? classMap[student.classId] || '' : '';
                 return student.name.toLowerCase().includes(searchTerm) ||
                        student.fatherName.toLowerCase().includes(searchTerm) ||
                        (className && className.toLowerCase().includes(searchTerm));
             });

            if (students.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="10" class="text-center">کوئی طلباء نہیں ملے۔</td></tr>';
                 return;
            }

            students.forEach((student, index) => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.name}</td>
                    <td>${student.fatherName}</td>
                    <td>${student.age || '-'}</td>
                    <td>${student.classId ? classMap[student.classId] || 'غیر تفویض شدہ' : 'غیر تفویض شدہ'}</td>
                    <td>${student.admissionDate}</td>
                    <td>${student.contact || '-'}</td>
                    <td>${student.address || '-'}</td>
                    <td>${displayCustomFieldsInTable(student)}</td>
                    <td class="action-buttons no-print">
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#studentModal" onclick="prepareStudentForm(${student.id})">ترمیم</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.id})">حذف کریں</button>
                    </td>
                 `;
                 tbody.appendChild(tr);
            });
            updateCustomFieldHeaders(); // Ensure header is up-to-date
         } catch (error) {
             console.error("Error displaying students:", error);
             showToast("خرابی", "طلباء کی فہرست لوڈ کرنے میں ناکامی۔", "danger");
         }
    }

     function deleteStudent(studentId) {
         confirmAction('کیا آپ واقعی اس طالب علم کو حذف کرنا چاہتے ہیں؟', async () => {
             try {
                // Optional: Add checks here - e.g., remove from attendance, fees etc. or prevent deletion if records exist.
                await deleteFromStore('students', studentId);
                showToast("کامیابی", "طالب علم کامیابی سے حذف ہوگیا۔");
                displayStudents();
                 updateDashboardStats(); // Update dashboard
             } catch (error) {
                console.error("Error deleting student:", error);
                 showToast("خرابی", "طالب علم کو حذف کرنے میں ناکامی۔", "danger");
             }
         });
    }


    // --- Teacher Management ---
     function prepareTeacherForm(teacherId = null) {
        document.getElementById('teacherForm').reset();
        document.getElementById('teacherId').value = '';
        renderCustomFieldsForForm('teacher'); // Render empty custom fields

        if (teacherId) {
             getFromStore('teachers', teacherId).then(teacher => {
                 if (teacher) {
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name;
                    document.getElementById('teacherContact').value = teacher.contact || '';
                    document.getElementById('teacherAddress').value = teacher.address || '';
                    document.getElementById('teacherJoinDate').value = teacher.joinDate;
                     renderCustomFieldsForForm('teacher', teacher); // Render with existing data
                 }
                document.getElementById('teacherModalLabel').textContent = 'استاد میں ترمیم کریں';
             }).catch(error => console.error("Error fetching teacher:", error));
        } else {
              document.getElementById('teacherModalLabel').textContent = 'نیا استاد شامل کریں';
              document.getElementById('teacherJoinDate').valueAsDate = new Date(); // Default to today
        }
    }

    async function saveTeacher() {
        const teacherId = parseInt(document.getElementById('teacherId').value) || null;
        const teacherData = {
            name: document.getElementById('teacherName').value.trim(),
            contact: document.getElementById('teacherContact').value.trim(),
            address: document.getElementById('teacherAddress').value.trim(),
            joinDate: document.getElementById('teacherJoinDate').value,
            customFields: getCustomFieldsFromForm('teacher'),
            type: 'teacher' // Needed for custom field rendering
        };

        if (!teacherData.name || !teacherData.joinDate) {
             showToast("خرابی", "براہ کرم نام اور شمولیت کی تاریخ درج کریں۔", "warning");
             return;
        }

         try {
            if (teacherId) {
                 teacherData.id = teacherId;
                await updateInStore('teachers', teacherData);
                showToast("کامیابی", "استاد کا ریکارڈ کامیابی سے اپ ڈیٹ ہوگیا۔");
            } else {
                await addToStore('teachers', teacherData);
                showToast("کامیابی", "نیا استاد کامیابی سے شامل ہوگیا۔");
            }
            bootstrap.Modal.getInstance(document.getElementById('teacherModal')).hide();
            displayTeachers();
            updateDashboardStats(); // Update dashboard
        } catch (error) {
            console.error("Error saving teacher:", error);
            showToast("خرابی", "استاد کو محفوظ کرنے میں ناکامی۔", "danger");
        }
    }

    async function displayTeachers() {
        const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
         try {
            let teachers = await getAllFromStore('teachers');
            const tbody = document.getElementById('teachersTableBody');
            tbody.innerHTML = '';

             teachers = teachers.filter(teacher => teacher.name.toLowerCase().includes(searchTerm));


            if (teachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">کوئی اساتذہ نہیں ملے۔</td></tr>';
                return;
            }

            teachers.forEach((teacher, index) => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teacher.name}</td>
                    <td>${teacher.contact || '-'}</td>
                    <td>${teacher.address || '-'}</td>
                    <td>${teacher.joinDate}</td>
                    <td>${displayCustomFieldsInTable(teacher)}</td>
                    <td class="action-buttons no-print">
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#teacherModal" onclick="prepareTeacherForm(${teacher.id})">ترمیم</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTeacher(${teacher.id})">حذف کریں</button>
                    </td>
                 `;
                 tbody.appendChild(tr);
            });
            updateCustomFieldHeaders(); // Ensure header is correct
         } catch (error) {
             console.error("Error displaying teachers:", error);
             showToast("خرابی", "اساتذہ کی فہرست لوڈ کرنے میں ناکامی۔", "danger");
         }
    }

    function deleteTeacher(teacherId) {
         confirmAction('کیا آپ واقعی اس استاد کو حذف کرنا چاہتے ہیں؟ اس سے منسلک کلاسز سے بھی ہٹا دیا جائے گا۔', async () => {
             try {
                 // Remove teacher assignment from classes
                 let classes = await getAllFromStore('classes');
                 for (const cls of classes) {
                     if (cls.teacherId === teacherId) {
                         cls.teacherId = null;
                         await updateInStore('classes', cls);
                     }
                 }
                 // Optionally: Delete salary records? Or prevent deletion if salary exists?
                await deleteFromStore('teachers', teacherId);
                showToast("کامیابی", "استاد کامیابی سے حذف ہوگیا۔");
                displayTeachers();
                 displayClasses(); // Refresh class list as teacher assignment changed
                 updateDashboardStats(); // Update dashboard
             } catch (error) {
                console.error("Error deleting teacher:", error);
                 showToast("خرابی", "استاد کو حذف کرنے میں ناکامی۔", "danger");
             }
         });
    }

    // --- Class Management ---
     async function loadTeacherOptions(selectId) {
        const select = document.querySelector(selectId);
        select.innerHTML = '<option value="">استاد منتخب کریں</option>';
        try {
            const teachers = await getAllFromStore('teachers');
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.id;
                option.textContent = teacher.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading teachers for dropdown:", error);
        }
    }

     async function loadStudentOptions(selectId, selectedStudentIds = []) {
        const select = document.querySelector(selectId);
        select.innerHTML = ''; // Clear existing options
        try {
            const students = await getAllFromStore('students');
            const studentsWithoutClass = students.filter(s => !s.classId || selectedStudentIds.includes(s.id)); // Show unassigned or already selected
            studentsWithoutClass.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.fatherName})`;
                if (selectedStudentIds.includes(student.id)) {
                     option.selected = true;
                }
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading students for dropdown:", error);
        }
    }

    async function prepareClassForm(classId = null) {
        document.getElementById('classForm').reset();
        document.getElementById('classId').value = '';
        await loadTeacherOptions('#classTeacher'); // Load teachers
        await loadStudentOptions('#classStudents'); // Load unassigned students

        if (classId) {
            try {
                 const cls = await getFromStore('classes', classId);
                 const studentsInClass = await getAllFromStore('students', 'classId', classId);
                 const studentIdsInClass = studentsInClass.map(s => s.id);

                 if (cls) {
                    document.getElementById('classId').value = cls.id;
                    document.getElementById('className').value = cls.name;
                    document.getElementById('classTeacher').value = cls.teacherId || '';
                     // Reload student options including those already in this class
                     await loadStudentOptions('#classStudents', studentIdsInClass);
                 }
                document.getElementById('classModalLabel').textContent = 'کلاس میں ترمیم کریں';
            } catch (error) {
                console.error("Error fetching class data:", error);
            }
        } else {
             document.getElementById('classModalLabel').textContent = 'نئی کلاس بنائیں';
        }
    }


    async function saveClass() {
        const classId = parseInt(document.getElementById('classId').value) || null;
        const selectedStudentOptions = document.getElementById('classStudents').selectedOptions;
        const selectedStudentIds = Array.from(selectedStudentOptions).map(opt => parseInt(opt.value));
        const teacherIdValue = document.getElementById('classTeacher').value;

        const classData = {
            name: document.getElementById('className').value.trim(),
            teacherId: teacherIdValue ? parseInt(teacherIdValue) : null
            // Student assignments are handled separately below
        };

        if (!classData.name) {
             showToast("خرابی", "براہ کرم کلاس کا نام درج کریں۔", "warning");
             return;
        }

        try {
             let savedClassId = classId;
            if (classId) {
                 classData.id = classId;
                await updateInStore('classes', classData);
                showToast("کامیابی", "کلاس کامیابی سے اپ ڈیٹ ہوگئی۔");
            } else {
                 savedClassId = await addToStore('classes', classData); // Get the new ID
                showToast("کامیابی", "نئی کلاس کامیابی سے بن گئی۔");
            }

             // Update student records for class assignment
             // 1. Find students currently assigned to this class (if editing)
             let previouslyAssignedStudents = [];
             if(classId) {
                 previouslyAssignedStudents = await getAllFromStore('students', 'classId', classId);
             }

             // 2. Unassign students who were in this class but are no longer selected
             for (const student of previouslyAssignedStudents) {
                 if (!selectedStudentIds.includes(student.id)) {
                     student.classId = null; // Or assign to a default 'unassigned' class if needed
                     await updateInStore('students', student);
                 }
             }

             // 3. Assign newly selected students to this class
             for (const studentId of selectedStudentIds) {
                 const student = await getFromStore('students', studentId);
                 if (student && student.classId !== savedClassId) { // Assign only if not already assigned or assigned to a different class
                     student.classId = savedClassId;
                     await updateInStore('students', student);
                 }
             }


            bootstrap.Modal.getInstance(document.getElementById('classModal')).hide();
            displayClasses();
            displayStudents(); // Refresh student list as assignments might change
            updateDashboardStats(); // Update dashboard
        } catch (error) {
            console.error("Error saving class:", error);
            if (error.name === 'ConstraintError') {
                 showToast("خرابی", "اس نام کی کلاس پہلے سے موجود ہے۔", "danger");
            } else {
                 showToast("خرابی", "کلاس کو محفوظ کرنے میں ناکامی۔", "danger");
            }
        }
    }

    async function displayClasses() {
         try {
             const classes = await getAllFromStore('classes');
             const teachers = await getAllFromStore('teachers');
             const students = await getAllFromStore('students');

             const teacherMap = teachers.reduce((map, teacher) => { map[teacher.id] = teacher.name; return map; }, {});
             const studentCountMap = students.reduce((map, student) => {
                 if (student.classId) {
                     map[student.classId] = (map[student.classId] || 0) + 1;
                 }
                 return map;
             }, {});


             const tbody = document.getElementById('classesTableBody');
             tbody.innerHTML = '';

             if (classes.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="5" class="text-center">کوئی کلاسز نہیں بنائی گئیں۔</td></tr>';
                 return;
             }

             classes.forEach((cls, index) => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${cls.name}</td>
                    <td>${cls.teacherId ? teacherMap[cls.teacherId] || 'غیر تفویض شدہ' : 'غیر تفویض شدہ'}</td>
                    <td>${studentCountMap[cls.id] || 0}</td>
                    <td class="action-buttons no-print">
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#classModal" onclick="prepareClassForm(${cls.id})">ترمیم</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteClass(${cls.id})">حذف کریں</button>
                    </td>
                 `;
                 tbody.appendChild(tr);
             });
         } catch (error) {
             console.error("Error displaying classes:", error);
             showToast("خرابی", "کلاسز کی فہرست لوڈ کرنے میں ناکامی۔", "danger");
         }
    }

    function deleteClass(classId) {
        confirmAction('کیا آپ واقعی اس کلاس کو حذف کرنا چاہتے ہیں؟ اس کلاس میں شامل تمام طلباء غیر تفویض شدہ ہو جائیں گے۔', async () => {
            try {
                // Unassign students from this class
                const studentsInClass = await getAllFromStore('students', 'classId', classId);
                for (const student of studentsInClass) {
                     student.classId = null; // Set to null or a default 'unassigned' ID
                     await updateInStore('students', student);
                }

                // Optional: Check for related attendance/fee records before deleting?

                await deleteFromStore('classes', classId);
                showToast("کامیابی", "کلاس کامیابی سے حذف ہوگئی۔");
                displayClasses();
                displayStudents(); // Refresh student list
                updateDashboardStats(); // Update dashboard
            } catch (error) {
                console.error("Error deleting class:", error);
                 showToast("خرابی", "کلاس کو حذف کرنے میں ناکامی۔", "danger");
            }
        });
    }

     // --- Attendance ---
    async function loadClassOptions(selectId, includeAllOption = false) {
        const select = document.querySelector(selectId);
        select.innerHTML = includeAllOption ? '<option value="">تمام کلاسز</option>' : '<option value="">کلاس منتخب کریں</option>';
        try {
            const classes = await getAllFromStore('classes');
            classes.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort classes alphabetically
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Error loading classes for dropdown:", error);
        }
    }

    async function loadAttendanceSheet() {
        const classId = parseInt(document.getElementById('attendanceClassSelect').value);
        const date = document.getElementById('attendanceDate').value;
        const tbody = document.getElementById('attendanceTableBody');
        tbody.innerHTML = '';

        if (!classId || !date) {
             tbody.innerHTML = '<tr><td colspan="3" class="text-center">براہ کرم کلاس اور تاریخ منتخب کریں۔</td></tr>';
            return;
        }

        try {
            const students = await getAllFromStore('students', 'classId', classId);
             if (students.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="3" class="text-center">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
                 return;
             }

            // Fetch existing attendance records for this class and date
            const existingAttendance = await getAllFromStore('attendance', 'date', date);
            const attendanceMap = existingAttendance
                .filter(att => att.classId === classId)
                .reduce((map, att) => { map[att.studentId] = att.status; return map; }, {});

            students.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort students by name

            students.forEach((student, index) => {
                const currentStatus = attendanceMap[student.id] || 'present'; // Default to present
                const tr = document.createElement('tr');
                tr.dataset.studentId = student.id;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${student.name} (${student.fatherName})</td>
                    <td>
                         <div class="btn-group" role="group" aria-label="Attendance status">
                           <input type="radio" class="btn-check" name="attendance_${student.id}" id="present_${student.id}" value="present" ${currentStatus === 'present' ? 'checked' : ''} autocomplete="off">
                           <label class="btn btn-outline-success btn-sm" for="present_${student.id}">حاضر</label>

                           <input type="radio" class="btn-check" name="attendance_${student.id}" id="absent_${student.id}" value="absent" ${currentStatus === 'absent' ? 'checked' : ''} autocomplete="off">
                           <label class="btn btn-outline-danger btn-sm" for="absent_${student.id}">غیر حاضر</label>

                           <input type="radio" class="btn-check" name="attendance_${student.id}" id="leave_${student.id}" value="leave" ${currentStatus === 'leave' ? 'checked' : ''} autocomplete="off">
                           <label class="btn btn-outline-warning btn-sm" for="leave_${student.id}">رخصت</label>
                         </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (error) {
            console.error("Error loading attendance sheet:", error);
             tbody.innerHTML = '<tr><td colspan="3" class="text-center">حاضری شیٹ لوڈ کرنے میں خرابی۔</td></tr>';
             showToast("خرابی", "حاضری شیٹ لوڈ کرنے میں ناکامی۔", "danger");
        }
    }

     async function saveAttendance() {
        const classId = parseInt(document.getElementById('attendanceClassSelect').value);
        const date = document.getElementById('attendanceDate').value;
        const rows = document.querySelectorAll('#attendanceTableBody tr');

        if (!classId || !date || rows.length === 0 || rows[0].children[0].colSpan === 3) {
             showToast("معلومات", "محفوظ کرنے کے لیے کوئی حاضری ڈیٹا موجود نہیں۔", "info");
            return;
        }

         confirmAction('کیا آپ اس تاریخ کی حاضری محفوظ کرنا چاہتے ہیں؟ موجودہ ریکارڈز (اگر ہوں) اوور رائٹ ہو جائیں گے۔', async () => {
            try {
                const transaction = db.transaction(['attendance'], 'readwrite');
                const store = transaction.objectStore('attendance');
                const index = store.index('date_studentId');
                let successCount = 0;

                for (const row of rows) {
                     const studentId = parseInt(row.dataset.studentId);
                     const selectedStatusInput = row.querySelector('input[type="radio"]:checked');
                     const status = selectedStatusInput ? selectedStatusInput.value : 'present'; // Default if somehow none selected

                     const attendanceData = {
                         studentId: studentId,
                         classId: classId,
                         date: date,
                         status: status
                     };

                     // Check if a record exists for this student and date to get its ID for update
                     const existingReq = index.get([date, studentId]);

                      // Use a promise to handle async nature within the loop
                      await new Promise((resolve, reject) => {
                          existingReq.onsuccess = (event) => {
                                const existingRecord = event.target.result;
                                let updateReq;
                                if (existingRecord) {
                                    attendanceData.id = existingRecord.id; // Set ID for update
                                    updateReq = store.put(attendanceData);
                                } else {
                                     updateReq = store.add(attendanceData);
                                }
                                updateReq.onsuccess = () => { successCount++; resolve(); };
                                updateReq.onerror = (errEvent) => { console.error(`Error saving attendance for student ${studentId}:`, errEvent.target.error); reject(errEvent.target.error); };
                            };
                         existingReq.onerror = (errEvent) => { console.error(`Error checking existing attendance for student ${studentId}:`, errEvent.target.error); reject(errEvent.target.error); };
                      });
                 } // end for loop

                 transaction.oncomplete = () => {
                     showToast("کامیابی", `حاضری کامیابی سے محفوظ ہوگئی (${successCount} ریکارڈز)۔`);
                 };
                 transaction.onerror = (event) => {
                      console.error("Transaction error saving attendance:", event.target.error);
                      showToast("خرابی", "حاضری محفوظ کرنے میں ٹرانزیکشن کی خرابی۔", "danger");
                 };

            } catch (error) {
                console.error("Error saving attendance:", error);
                 showToast("خرابی", "حاضری محفوظ کرنے میں ناکامی۔", "danger");
            }
         });
    }

    // --- Fee Management ---
    async function loadFeeStructure() {
        const classId = parseInt(document.getElementById('feeStructureClass').value);
        const amountInput = document.getElementById('feeStructureAmount');
        amountInput.value = ''; // Clear previous value

        if (!classId) return;

        try {
             // Fee structures might be stored directly in the class object or a separate store.
             // Let's assume it's part of the class object for simplicity here.
            const cls = await getFromStore('classes', classId);
            if (cls && cls.feeAmount) {
                amountInput.value = cls.feeAmount;
            }
        } catch (error) {
            console.error("Error loading fee structure:", error);
        }
    }

    async function saveFeeStructure() {
         const classId = parseInt(document.getElementById('feeStructureClass').value);
         const amount = parseFloat(document.getElementById('feeStructureAmount').value);

         if (!classId || isNaN(amount) || amount < 0) {
             showToast("خرابی", "براہ کرم درست کلاس اور فیس کی رقم درج کریں۔", "warning");
             return;
         }

         try {
             const cls = await getFromStore('classes', classId);
             if (cls) {
                 cls.feeAmount = amount;
                 await updateInStore('classes', cls);
                 showToast("کامیابی", "فیس اسٹرکچر کامیابی سے محفوظ ہوگیا۔");
                 bootstrap.Modal.getInstance(document.getElementById('feeStructureModal')).hide();
                 // Optionally refresh relevant views if needed
             } else {
                  showToast("خرابی", "منتخب کلاس نہیں ملی۔", "danger");
             }
         } catch (error) {
             console.error("Error saving fee structure:", error);
             showToast("خرابی", "فیس اسٹرکچر محفوظ کرنے میں ناکامی۔", "danger");
         }
    }

    async function loadStudentFeeInfo() {
        const studentId = parseInt(document.getElementById('feePaymentStudent').value);
        const monthInput = document.getElementById('feePaymentMonth');
        const amountDueInput = document.getElementById('feePaymentAmountDue');
        const amountPaidInput = document.getElementById('feePaymentAmountPaid');
        amountDueInput.value = '';
        amountPaidInput.value = '';

        if (!studentId) return;

        try {
            const student = await getFromStore('students', studentId);
            if (!student || !student.classId) {
                 amountDueInput.placeholder = 'طالب علم کسی کلاس میں تفویض نہیں ہے۔';
                return;
            }

            const cls = await getFromStore('classes', student.classId);
            if (cls && cls.feeAmount !== undefined) {
                amountDueInput.value = cls.feeAmount;
                 amountPaidInput.value = cls.feeAmount; // Default paid amount to due amount
                 amountPaidInput.max = cls.feeAmount; // Set max value
            } else {
                 amountDueInput.placeholder = 'اس کلاس کے لیے فیس سیٹ نہیں ہے۔';
            }
             // Optionally check if fee for selected month is already paid/partially paid
             const month = monthInput.value;
             if(month) {
                 const feeRecord = await getFromStoreByIndex('fees', 'studentId_month', [studentId, month]);
                 if (feeRecord) {
                     showToast("معلومات", `اس مہینے (${month}) کے لیے پہلے ہی ${feeRecord.amountPaid} وصول ہوچکے ہیں۔ بقایا: ${feeRecord.amountDue - feeRecord.amountPaid}`, "info");
                     // You might want to disable saving or adjust the form based on this
                 }
             }

        } catch (error) {
            console.error("Error loading student fee info:", error);
        }
    }

     async function saveFeePayment() {
        const paymentId = parseInt(document.getElementById('feePaymentId').value) || null; // For editing if needed later
        const studentId = parseInt(document.getElementById('feePaymentStudent').value);
        const month = document.getElementById('feePaymentMonth').value;
        const amountPaid = parseFloat(document.getElementById('feePaymentAmountPaid').value);
        const paymentDate = document.getElementById('feePaymentDate').value;

        if (!studentId || !month || isNaN(amountPaid) || amountPaid < 0 || !paymentDate) {
            showToast("خرابی", "براہ کرم تمام مطلوبہ فیلڈز درست طریقے سے پُر کریں۔", "warning");
            return;
        }

         try {
            const student = await getFromStore('students', studentId);
            if (!student || !student.classId) throw new Error("طالب علم یا اس کی کلاس نہیں ملی۔");
            const cls = await getFromStore('classes', student.classId);
             const amountDue = (cls && cls.feeAmount !== undefined) ? cls.feeAmount : 0; // Get fee amount from class

              if (amountDue <= 0) {
                 showToast("معلومات", "اس کلاس کے لیے فیس 0 ہے یا سیٹ نہیں ہے۔", "info");
                 // Allow saving payment of 0? Or prevent? Let's prevent for now.
                 // return;
             }
              if (amountPaid > amountDue) {
                  showToast("وارننگ", `وصول شدہ رقم (${amountPaid}) مقررہ فیس (${amountDue}) سے زیادہ ہے۔`, "warning");
                 // Allow saving anyway? Or correct it? Let's allow but warn.
              }


            const feeData = {
                studentId: studentId,
                classId: student.classId,
                month: month, // Format YYYY-MM
                amountDue: amountDue,
                amountPaid: amountPaid,
                paymentDate: paymentDate,
                status: amountPaid >= amountDue ? 'paid' : (amountPaid > 0 ? 'partial' : 'pending') // More granular status
            };

             // Check if a record exists for this student and month to update instead of add
             const existingRecord = await getFromStoreByIndex('fees', 'studentId_month', [studentId, month]);
             if (existingRecord) {
                  // If editing is intended, use paymentId. Here we just update based on student/month match.
                  feeData.id = existingRecord.id;
                 await updateInStore('fees', feeData);
                  showToast("کامیابی", `فیس ریکارڈ (${month}) کامیابی سے اپ ڈیٹ ہوگیا۔`);
             } else {
                  await addToStore('fees', feeData);
                  showToast("کامیابی", `فیس (${month}) کامیابی سے وصول ہوگئی۔`);
                  // Also record as income transaction
                  await saveTransactionInternal('income', `فیس وصولی - ${student.name} (${month})`, amountPaid, paymentDate);

             }

            bootstrap.Modal.getInstance(document.getElementById('feePaymentModal')).hide();
            displayFeeRecords();
             updateDashboardStats(); // Update income stats
        } catch (error) {
            console.error("Error saving fee payment:", error);
            if (error.name === 'ConstraintError') {
                showToast("خرابی", `اس طالب علم کے لیے ${month} کی فیس پہلے ہی ریکارڈ ہو چکی ہے۔`, "danger");
            } else {
                 showToast("خرابی", "فیس وصولی محفوظ کرنے میں ناکامی: " + error.message, "danger");
            }
        }
    }

    async function displayFeeRecords() {
        const searchTerm = document.getElementById('feeSearch').value.toLowerCase();
        const statusFilter = document.getElementById('feeStatusFilter').value;

        try {
            let feeRecords = await getAllFromStore('fees');
            const students = await getAllFromStore('students');
            const classes = await getAllFromStore('classes');

            const studentMap = students.reduce((map, s) => { map[s.id] = {name: s.name, classId: s.classId}; return map; }, {});
            const classMap = classes.reduce((map, c) => { map[c.id] = c.name; return map; }, {});

            const tbody = document.getElementById('feesTableBody');
            tbody.innerHTML = '';

             // Filter records
             feeRecords = feeRecords.filter(record => {
                const studentInfo = studentMap[record.studentId];
                const studentName = studentInfo ? studentInfo.name.toLowerCase() : '';
                const matchesSearch = !searchTerm || studentName.includes(searchTerm);
                const matchesStatus = !statusFilter || record.status === statusFilter || (statusFilter === 'pending' && (record.status === 'pending' || record.status === 'partial'));

                return matchesSearch && matchesStatus;
             });

              // Sort by date descending
             feeRecords.sort((a, b) => b.paymentDate.localeCompare(a.paymentDate));


            if (feeRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">کوئی فیس ریکارڈ نہیں ملا۔</td></tr>';
                return;
            }

            feeRecords.forEach((record, index) => {
                 const studentInfo = studentMap[record.studentId];
                 const className = studentInfo && studentInfo.classId ? classMap[studentInfo.classId] : 'N/A';
                 const balance = record.amountDue - record.amountPaid;
                 let statusText = '';
                 let statusClass = '';
                 switch(record.status) {
                     case 'paid': statusText = 'ادا شدہ'; statusClass = 'success'; break;
                     case 'partial': statusText = 'جزوی ادا شدہ'; statusClass = 'warning'; break;
                     case 'pending': statusText = 'واجب الادا'; statusClass = 'danger'; break;
                     default: statusText = 'نامعلوم'; statusClass = 'secondary';
                 }


                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${studentInfo ? studentInfo.name : 'نامعلوم طالب علم'}</td>
                    <td>${className}</td>
                    <td>${record.month}</td>
                    <td>${record.amountDue}</td>
                    <td>${record.amountPaid}</td>
                    <td>${record.paymentDate}</td>
                    <td>${balance > 0 ? balance : 0}</td>
                    <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    <td class="action-buttons no-print">
                         <button class="btn btn-sm btn-danger" onclick="deleteFeeRecord(${record.id}, ${record.amountPaid})">حذف کریں</button>
                         <!-- Add edit button later if needed -->
                    </td>
                 `;
                 tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Error displaying fee records:", error);
            showToast("خرابی", "فیس ریکارڈز لوڈ کرنے میں ناکامی۔", "danger");
        }
    }

    function deleteFeeRecord(recordId, amountPaid) {
         confirmAction('کیا آپ واقعی اس فیس ریکارڈ کو حذف کرنا چاہتے ہیں؟ متعلقہ آمدنی کا ریکارڈ بھی حذف ہو جائے گا۔', async () => {
             try {
                await deleteFromStore('fees', recordId);
                 // Find and delete corresponding income transaction (this might be tricky if description isn't exact)
                 // For simplicity, we might just adjust total income, or require manual adjustment.
                 // Let's just show a message for now.
                 showToast("کامیابی", "فیس ریکارڈ کامیابی سے حذف ہوگیا۔ براہ کرم آمدنی کے ریکارڈ کو دستی طور پر ایڈجسٹ کریں اگر ضروری ہو۔");
                 // TODO: Implement better linking or deletion logic for transactions
                 displayFeeRecords();
                 updateDashboardStats();
             } catch (error) {
                 console.error("Error deleting fee record:", error);
                 showToast("خرابی", "فیس ریکارڈ حذف کرنے میں ناکامی۔", "danger");
             }
         });
    }


    // --- Salary Management ---
    async function loadSalaryStructure() {
        const teacherId = parseInt(document.getElementById('salaryStructureTeacher').value);
        const amountInput = document.getElementById('salaryStructureAmount');
        amountInput.value = '';

        if (!teacherId) return;

        try {
            // Assume salary is stored in the teacher object
            const teacher = await getFromStore('teachers', teacherId);
            if (teacher && teacher.salaryAmount) {
                amountInput.value = teacher.salaryAmount;
            }
        } catch (error) {
            console.error("Error loading salary structure:", error);
        }
    }

    async function saveSalaryStructure() {
         const teacherId = parseInt(document.getElementById('salaryStructureTeacher').value);
         const amount = parseFloat(document.getElementById('salaryStructureAmount').value);

         if (!teacherId || isNaN(amount) || amount < 0) {
             showToast("خرابی", "براہ کرم درست استاد اور تنخواہ کی رقم درج کریں۔", "warning");
             return;
         }

         try {
             const teacher = await getFromStore('teachers', teacherId);
             if (teacher) {
                 teacher.salaryAmount = amount;
                 await updateInStore('teachers', teacher);
                 showToast("کامیابی", "تنخواہ اسٹرکچر کامیابی سے محفوظ ہوگیا۔");
                 bootstrap.Modal.getInstance(document.getElementById('salaryStructureModal')).hide();
             } else {
                  showToast("خرابی", "منتخب استاد نہیں ملا۔", "danger");
             }
         } catch (error) {
             console.error("Error saving salary structure:", error);
             showToast("خرابی", "تنخواہ اسٹرکچر محفوظ کرنے میں ناکامی۔", "danger");
         }
    }

    async function loadTeacherSalaryInfo() {
        const teacherId = parseInt(document.getElementById('salaryPaymentTeacher').value);
        const monthInput = document.getElementById('salaryPaymentMonth');
        const amountDueInput = document.getElementById('salaryPaymentAmountDue');
        const amountPaidInput = document.getElementById('salaryPaymentAmountPaid');
        amountDueInput.value = '';
        amountPaidInput.value = '';


        if (!teacherId) return;

        try {
            const teacher = await getFromStore('teachers', teacherId);
            if (teacher && teacher.salaryAmount !== undefined) {
                 amountDueInput.value = teacher.salaryAmount;
                 amountPaidInput.value = teacher.salaryAmount; // Default paid to due
            } else {
                 amountDueInput.placeholder = 'اس استاد کے لیے تنخواہ سیٹ نہیں ہے۔';
            }
             // Check if already paid for the selected month
             const month = monthInput.value;
             if (month) {
                 const salaryRecord = await getFromStoreByIndex('salaries', 'teacherId_month', [teacherId, month]);
                 if (salaryRecord) {
                     showToast("معلومات", `اس مہینے (${month}) کے لیے پہلے ہی ${salaryRecord.amountPaid} ادا کیے جا چکے ہیں۔`, "info");
                 }
             }
        } catch (error) {
            console.error("Error loading teacher salary info:", error);
        }
    }


     async function saveSalaryPayment() {
        const paymentId = parseInt(document.getElementById('salaryPaymentId').value) || null; // For editing
        const teacherId = parseInt(document.getElementById('salaryPaymentTeacher').value);
        const month = document.getElementById('salaryPaymentMonth').value;
        const amountPaid = parseFloat(document.getElementById('salaryPaymentAmountPaid').value);
        const paymentDate = document.getElementById('salaryPaymentDate').value;

        if (!teacherId || !month || isNaN(amountPaid) || amountPaid < 0 || !paymentDate) {
            showToast("خرابی", "براہ کرم تمام مطلوبہ فیلڈز درست طریقے سے پُر کریں۔", "warning");
            return;
        }

        try {
            const teacher = await getFromStore('teachers', teacherId);
            if (!teacher) throw new Error("استاد نہیں ملا۔");
             const amountDue = (teacher && teacher.salaryAmount !== undefined) ? teacher.salaryAmount : 0;

             if (amountDue <= 0) {
                 showToast("معلومات", "اس استاد کے لیے تنخواہ 0 ہے یا سیٹ نہیں ہے۔", "info");
                 // return; // Prevent saving 0 salary payment?
             }
              if (amountPaid > amountDue) {
                   showToast("وارننگ", `ادا شدہ رقم (${amountPaid}) مقررہ تنخواہ (${amountDue}) سے زیادہ ہے۔`, "warning");
             }


            const salaryData = {
                teacherId: teacherId,
                month: month,
                amountDue: amountDue,
                amountPaid: amountPaid,
                paymentDate: paymentDate,
                 status: amountPaid >= amountDue ? 'paid' : (amountPaid > 0 ? 'partial' : 'pending')
            };

            const existingRecord = await getFromStoreByIndex('salaries', 'teacherId_month', [teacherId, month]);
            if (existingRecord) {
                 salaryData.id = existingRecord.id;
                 await updateInStore('salaries', salaryData);
                  showToast("کامیابی", `تنخواہ ریکارڈ (${month}) کامیابی سے اپ ڈیٹ ہوگیا۔`);
            } else {
                  await addToStore('salaries', salaryData);
                  showToast("کامیابی", `تنخواہ (${month}) کامیابی سے ادا ہوگئی۔`);
                   // Record as expense transaction
                  await saveTransactionInternal('expense', `تنخواہ ادائیگی - ${teacher.name} (${month})`, amountPaid, paymentDate);
            }

            bootstrap.Modal.getInstance(document.getElementById('salaryPaymentModal')).hide();
            displaySalaryRecords();
             updateDashboardStats(); // Update expense stats
        } catch (error) {
            console.error("Error saving salary payment:", error);
             if (error.name === 'ConstraintError') {
                 showToast("خرابی", `اس استاد کے لیے ${month} کی تنخواہ پہلے ہی ریکارڈ ہو چکی ہے۔`, "danger");
             } else {
                 showToast("خرابی", "تنخواہ ادائیگی محفوظ کرنے میں ناکامی: " + error.message, "danger");
             }
        }
    }

    async function displaySalaryRecords() {
        const searchTerm = document.getElementById('salarySearch').value.toLowerCase();
        try {
            let salaryRecords = await getAllFromStore('salaries');
            const teachers = await getAllFromStore('teachers');
            const teacherMap = teachers.reduce((map, t) => { map[t.id] = t.name; return map; }, {});

            const tbody = document.getElementById('salariesTableBody');
            tbody.innerHTML = '';

             // Filter
             salaryRecords = salaryRecords.filter(record => {
                 const teacherName = teacherMap[record.teacherId] ? teacherMap[record.teacherId].toLowerCase() : '';
                 return !searchTerm || teacherName.includes(searchTerm);
             });

             // Sort by date descending
             salaryRecords.sort((a, b) => b.paymentDate.localeCompare(a.paymentDate));

            if (salaryRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">کوئی تنخواہ ریکارڈ نہیں ملا۔</td></tr>';
                return;
            }

            salaryRecords.forEach((record, index) => {
                  let statusText = '';
                  let statusClass = '';
                  switch(record.status) {
                      case 'paid': statusText = 'ادا شدہ'; statusClass = 'success'; break;
                      case 'partial': statusText = 'جزوی ادا شدہ'; statusClass = 'warning'; break;
                      case 'pending': statusText = 'واجب الادا'; statusClass = 'danger'; break;
                      default: statusText = 'نامعلوم'; statusClass = 'secondary';
                  }

                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${teacherMap[record.teacherId] || 'نامعلوم استاد'}</td>
                    <td>${record.month}</td>
                    <td>${record.amountDue}</td>
                    <td>${record.amountPaid}</td>
                    <td>${record.paymentDate}</td>
                     <td><span class="badge bg-${statusClass}">${statusText}</span></td>
                    <td class="action-buttons no-print">
                         <button class="btn btn-sm btn-danger" onclick="deleteSalaryRecord(${record.id}, ${record.amountPaid})">حذف کریں</button>
                         <!-- Add edit button later if needed -->
                    </td>
                 `;
                 tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Error displaying salary records:", error);
            showToast("خرابی", "تنخواہ ریکارڈز لوڈ کرنے میں ناکامی۔", "danger");
        }
    }

     function deleteSalaryRecord(recordId, amountPaid) {
          confirmAction('کیا آپ واقعی اس تنخواہ ریکارڈ کو حذف کرنا چاہتے ہیں؟ متعلقہ خرچہ کا ریکارڈ بھی حذف ہو جائے گا۔', async () => {
             try {
                 await deleteFromStore('salaries', recordId);
                 // TODO: Find and delete corresponding expense transaction
                  showToast("کامیابی", "تنخواہ ریکارڈ کامیابی سے حذف ہوگیا۔ براہ کرم اخراجات کے ریکارڈ کو دستی طور پر ایڈجسٹ کریں اگر ضروری ہو۔");
                 displaySalaryRecords();
                 updateDashboardStats();
             } catch (error) {
                 console.error("Error deleting salary record:", error);
                 showToast("خرابی", "تنخواہ ریکارڈ حذف کرنے میں ناکامی۔", "danger");
             }
         });
    }

    // --- Inventory Management ---
     function prepareInventoryForm(itemId = null) {
        document.getElementById('inventoryForm').reset();
        document.getElementById('inventoryId').value = '';
        document.getElementById('inventoryAddDate').value = new Date().toISOString().split('T')[0]; // Set default date

        if (itemId) {
            getFromStore('inventory', itemId).then(item => {
                if (item) {
                    document.getElementById('inventoryId').value = item.id;
                    document.getElementById('inventoryItemName').value = item.name;
                    document.getElementById('inventoryQuantity').value = item.quantity;
                    document.getElementById('inventoryDescription').value = item.description || '';
                    document.getElementById('inventoryAddDate').value = item.addDate || new Date().toISOString().split('T')[0];
                }
                document.getElementById('inventoryModalLabel').textContent = 'انوینٹری آئٹم میں ترمیم کریں';
            }).catch(error => console.error("Error fetching inventory item:", error));
        } else {
             document.getElementById('inventoryModalLabel').textContent = 'نیا انوینٹری آئٹم شامل کریں';
        }
    }

    async function saveInventoryItem() {
        const itemId = parseInt(document.getElementById('inventoryId').value) || null;
        const itemData = {
            name: document.getElementById('inventoryItemName').value.trim(),
            quantity: parseInt(document.getElementById('inventoryQuantity').value),
            description: document.getElementById('inventoryDescription').value.trim(),
            addDate: document.getElementById('inventoryAddDate').value || new Date().toISOString().split('T')[0] // Ensure date is saved
        };

        if (!itemData.name || isNaN(itemData.quantity) || itemData.quantity < 0) {
            showToast("خرابی", "براہ کرم آئٹم کا نام اور درست مقدار درج کریں۔", "warning");
            return;
        }

        try {
            if (itemId) {
                 itemData.id = itemId;
                await updateInStore('inventory', itemData);
                showToast("کامیابی", "انوینٹری آئٹم کامیابی سے اپ ڈیٹ ہوگیا۔");
            } else {
                await addToStore('inventory', itemData);
                showToast("کامیابی", "نیا انوینٹری آئٹم کامیابی سے شامل ہوگیا۔");
            }
            bootstrap.Modal.getInstance(document.getElementById('inventoryModal')).hide();
            displayInventory();
        } catch (error) {
            console.error("Error saving inventory item:", error);
            showToast("خرابی", "انوینٹری آئٹم محفوظ کرنے میں ناکامی۔", "danger");
        }
    }

    async function displayInventory() {
        try {
            const items = await getAllFromStore('inventory');
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';

            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">کوئی انوینٹری آئٹمز نہیں ہیں۔</td></tr>';
                return;
            }

             items.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort by name

            items.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity}</td>
                    <td>${item.description || '-'}</td>
                    <td>${item.addDate || '-'}</td>
                    <td class="action-buttons no-print">
                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#inventoryModal" onclick="prepareInventoryForm(${item.id})">ترمیم</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteInventoryItem(${item.id})">حذف کریں</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Error displaying inventory:", error);
            showToast("خرابی", "انوینٹری لوڈ کرنے میں ناکامی۔", "danger");
        }
    }

    function deleteInventoryItem(itemId) {
         confirmAction('کیا آپ واقعی اس انوینٹری آئٹم کو حذف کرنا چاہتے ہیں؟', async () => {
            try {
                await deleteFromStore('inventory', itemId);
                showToast("کامیابی", "انوینٹری آئٹم کامیابی سے حذف ہوگیا۔");
                displayInventory();
            } catch (error) {
                console.error("Error deleting inventory item:", error);
                 showToast("خرابی", "انوینٹری آئٹم حذف کرنے میں ناکامی۔", "danger");
            }
        });
    }

     // --- Income & Expenses (Transactions) ---
     function prepareTransactionForm(type, transactionId = null) {
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionId').value = '';
        document.getElementById('transactionType').value = type;
        document.getElementById('transactionDate').valueAsDate = new Date(); // Default to today

        const modalLabel = document.getElementById('transactionModalLabel');
        if (transactionId) {
             getFromStore('transactions', transactionId).then(transaction => {
                 if (transaction) {
                    document.getElementById('transactionId').value = transaction.id;
                    document.getElementById('transactionDate').value = transaction.date;
                    document.getElementById('transactionDescription').value = transaction.description;
                    document.getElementById('transactionAmount').value = transaction.amount;
                    document.getElementById('transactionType').value = transaction.type; // Ensure type is set correctly for edit
                    modalLabel.textContent = transaction.type === 'income' ? 'آمدنی میں ترمیم کریں' : 'خرچہ میں ترمیم کریں';
                 }
             }).catch(error => console.error("Error fetching transaction:", error));
        } else {
             modalLabel.textContent = type === 'income' ? 'نئی آمدنی شامل کریں' : 'نیا خرچہ شامل کریں';
        }
    }

     async function saveTransaction() {
        const transactionId = parseInt(document.getElementById('transactionId').value) || null;
        const transactionData = {
            date: document.getElementById('transactionDate').value,
            description: document.getElementById('transactionDescription').value.trim(),
            amount: parseFloat(document.getElementById('transactionAmount').value),
            type: document.getElementById('transactionType').value // 'income' or 'expense'
        };

        if (!transactionData.date || !transactionData.description || isNaN(transactionData.amount) || transactionData.amount <= 0) {
             showToast("خرابی", "براہ کرم تاریخ، تفصیل، اور مثبت رقم درج کریں۔", "warning");
            return;
        }

         try {
             if (transactionId) {
                 transactionData.id = transactionId;
                 await updateInStore('transactions', transactionData);
                 showToast("کامیابی", "لین دین کامیابی سے اپ ڈیٹ ہوگیا۔");
             } else {
                 await addToStore('transactions', transactionData);
                 showToast("کامیابی", `نیا ${transactionData.type === 'income' ? 'آمدنی' : 'خرچہ'} کامیابی سے شامل ہوگیا۔`);
             }
             bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
             displayTransactions();
             updateDashboardStats(); // Update dashboard stats
         } catch (error) {
             console.error("Error saving transaction:", error);
             showToast("خرابی", "لین دین محفوظ کرنے میں ناکامی۔", "danger");
         }
    }

    // Internal function to save transactions without user interaction (e.g., from fees/salaries)
    async function saveTransactionInternal(type, description, amount, date) {
         if (!description || isNaN(amount) || amount <= 0 || !date || !type) {
             console.warn("Invalid internal transaction data:", {type, description, amount, date});
             return; // Don't save incomplete internal transactions
         }
         const transactionData = { date, description, amount, type };
         try {
             await addToStore('transactions', transactionData);
             console.log(`Internal ${type} transaction logged: ${description} - ${amount}`);
         } catch (error) {
             console.error("Error saving internal transaction:", error);
             // Don't show toast for internal errors usually, just log
         }
    }


    async function displayTransactions() {
        const monthFilter = document.getElementById('expenseMonthFilter').value; // YYYY-MM
        const typeFilter = document.getElementById('expenseTypeFilter').value;

        try {
            let transactions = await getAllFromStore('transactions');
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';

            let totalIncome = 0;
            let totalExpenses = 0;

             // Filter transactions
             transactions = transactions.filter(t => {
                 const matchesType = !typeFilter || t.type === typeFilter;
                 const matchesMonth = !monthFilter || t.date.startsWith(monthFilter);
                 return matchesType && matchesMonth;
             });

             // Sort by date descending
             transactions.sort((a, b) => b.date.localeCompare(a.date));

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">اس مدت/قسم کے لیے کوئی لین دین نہیں ملا۔</td></tr>';
            } else {
                 transactions.forEach((t, index) => {
                     const tr = document.createElement('tr');
                     const isIncome = t.type === 'income';
                     tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${t.date}</td>
                        <td>${t.description}</td>
                        <td><span class="badge bg-${isIncome ? 'success' : 'danger'}">${isIncome ? 'آمدنی' : 'خرچہ'}</span></td>
                        <td>${t.amount.toFixed(2)}</td>
                        <td class="action-buttons no-print">
                             <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#transactionModal" onclick="prepareTransactionForm('${t.type}', ${t.id})">ترمیم</button>
                             <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${t.id})">حذف کریں</button>
                        </td>
                     `;
                     tbody.appendChild(tr);

                      // Calculate totals based on filtered data
                      if (isIncome) {
                          totalIncome += t.amount;
                      } else {
                          totalExpenses += t.amount;
                      }
                 });
            }

            // Display summary
            document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);
            document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('netBalance').textContent = (totalIncome - totalExpenses).toFixed(2);

        } catch (error) {
            console.error("Error displaying transactions:", error);
            showToast("خرابی", "لین دین لوڈ کرنے میں ناکامی۔", "danger");
        }
    }

    function deleteTransaction(transactionId) {
         confirmAction('کیا آپ واقعی اس لین دین کو حذف کرنا چاہتے ہیں؟', async () => {
             try {
                 // Check if it's linked to a fee/salary? Difficult without proper linking. Assume manual adjustment needed.
                 await deleteFromStore('transactions', transactionId);
                 showToast("کامیابی", "لین دین کامیابی سے حذف ہوگیا۔");
                 displayTransactions();
                 updateDashboardStats(); // Update totals
             } catch (error) {
                 console.error("Error deleting transaction:", error);
                 showToast("خرابی", "لین دین حذف کرنے میں ناکامی۔", "danger");
             }
         });
    }

     // --- Reports ---
     const reportGenerators = {
        'students': generateStudentReport,
        'teachers': generateTeacherReport,
        'classes': generateClassReport,
        'attendance': generateAttendanceReportData, // Special handling via options
        'fees': generateFeeReportData, // Special handling via options
        'salaries': generateSalaryReportData, // Special handling via options
        'inventory': generateInventoryReport,
        'expenses': generateExpenseReportData // Special handling via options
     };

    let currentReportData = []; // To store data for export/print
    let currentReportHeaders = [];
    let currentReportTitle = '';

     function setupReportHeader() {
        const headerDiv = document.getElementById('reportHeader');
        const reportLogo = document.getElementById('reportLogo');
        if (currentSettings.madrasaLogoData) {
            reportLogo.src = currentSettings.madrasaLogoData;
             reportLogo.style.display = 'block';
        } else {
            reportLogo.style.display = 'none';
        }
        document.getElementById('reportMadrasaName').textContent = currentSettings.madrasaName || '';
        document.getElementById('reportMadrasaAddress').textContent = currentSettings.madrasaAddress || '';
        document.getElementById('reportMadrasaPhone').textContent = currentSettings.madrasaPhone || '';
        headerDiv.classList.remove('d-none'); // Show the header
     }

     function generateReport(type) {
         const generator = reportGenerators[type];
         const reportOutput = document.getElementById('reportOutput');
         const reportTableContainer = document.getElementById('reportTableContainer');
         const reportTitleEl = document.getElementById('reportTitle');
         const reportOptionsContainer = document.getElementById('reportOptionsContainer');

         reportTableContainer.innerHTML = '<p class="text-center">رپورٹ تیار کی جا رہی ہے...</p>';
         reportTitleEl.textContent = 'رپورٹ';
         reportOptionsContainer.innerHTML = ''; // Clear options for simple reports
         reportOutput.classList.remove('d-none'); // Ensure report area is visible

         if (generator && typeof generator === 'function') {
             generator(); // Call the specific generator function
             setupReportHeader(); // Add madrasa details to the report header
         } else {
             reportTableContainer.innerHTML = '<p class="text-center text-danger">اس قسم کی رپورٹ کے لیے جنریٹر نہیں ملا۔</p>';
             console.error(`Report generator for type "${type}" not found.`);
         }
     }

     function displayReportData(title, headers, data) {
         currentReportTitle = title;
         currentReportHeaders = headers;
         currentReportData = data; // Store raw data objects

         const reportTableContainer = document.getElementById('reportTableContainer');
         const reportTitleEl = document.getElementById('reportTitle');
         reportTitleEl.textContent = title;

         if (!data || data.length === 0) {
             reportTableContainer.innerHTML = '<p class="text-center">رپورٹ کے لیے کوئی ڈیٹا نہیں ملا۔</p>';
             return;
         }

         const table = document.createElement('table');
         table.className = 'table table-bordered table-striped table-sm'; // Use table-sm for denser reports
         const thead = table.createTHead();
         const tbody = table.createTBody();
         const headerRow = thead.insertRow();

         headers.forEach(headerText => {
             const th = document.createElement('th');
             th.textContent = headerText;
             headerRow.appendChild(th);
         });

         // Create rows from data objects, accessing properties by header keys (assuming headers match keys)
         // Or, more robustly, the generator function should return data formatted as arrays per row
         data.forEach(rowDataArray => {
            const row = tbody.insertRow();
            rowDataArray.forEach(cellData => {
                const cell = row.insertCell();
                cell.textContent = cellData !== null && cellData !== undefined ? cellData : '-';
            });
         });

         reportTableContainer.innerHTML = ''; // Clear loading message
         reportTableContainer.appendChild(table);
     }


     async function generateStudentReport() {
         try {
             const students = await getAllFromStore('students');
             const classes = await getAllFromStore('classes');
             const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

             const headers = ['شمار', 'نام', 'والد کا نام', 'عمر', 'کلاس', 'داخلہ تاریخ', 'رابطہ نمبر', 'پتہ'];
             // Add custom field headers dynamically
              if (currentSettings.studentCustomFields && currentSettings.studentCustomFields.length > 0) {
                 headers.push(...currentSettings.studentCustomFields);
             }

             const data = students.map((s, index) => {
                 const row = [
                     index + 1,
                     s.name,
                     s.fatherName,
                     s.age || '-',
                     s.classId ? classMap[s.classId] || 'N/A' : 'N/A',
                     s.admissionDate,
                     s.contact || '-',
                     s.address || '-'
                 ];
                 // Add custom field values
                 if (currentSettings.studentCustomFields && currentSettings.studentCustomFields.length > 0) {
                     currentSettings.studentCustomFields.forEach(label => {
                         row.push(s.customFields && s.customFields[label] ? s.customFields[label] : '-');
                     });
                 }
                 return row;
             });

             displayReportData('طلباء کی رپورٹ', headers, data);
         } catch (error) {
             console.error("Error generating student report:", error);
             displayReportData('طلباء کی رپورٹ', [], []); // Show error in report area
             showToast("خرابی", "طلباء کی رپورٹ بنانے میں ناکامی۔", "danger");
         }
     }

      async function generateTeacherReport() {
         try {
             const teachers = await getAllFromStore('teachers');
             const headers = ['شمار', 'نام', 'رابطہ نمبر', 'پتہ', 'شمولیت کی تاریخ'];
              // Add custom field headers dynamically
              if (currentSettings.teacherCustomFields && currentSettings.teacherCustomFields.length > 0) {
                  headers.push(...currentSettings.teacherCustomFields);
              }

             const data = teachers.map((t, index) => {
                 const row = [
                     index + 1,
                     t.name,
                     t.contact || '-',
                     t.address || '-',
                     t.joinDate
                 ];
                  // Add custom field values
                  if (currentSettings.teacherCustomFields && currentSettings.teacherCustomFields.length > 0) {
                      currentSettings.teacherCustomFields.forEach(label => {
                          row.push(t.customFields && t.customFields[label] ? t.customFields[label] : '-');
                      });
                  }
                 return row;
             });
             displayReportData('اساتذہ کی رپورٹ', headers, data);
         } catch (error) {
             console.error("Error generating teacher report:", error);
             displayReportData('اساتذہ کی رپورٹ', [], []);
             showToast("خرابی", "اساتذہ کی رپورٹ بنانے میں ناکامی۔", "danger");
         }
     }

      async function generateClassReport() {
         try {
             const classes = await getAllFromStore('classes');
             const teachers = await getAllFromStore('teachers');
             const students = await getAllFromStore('students');
             const teacherMap = teachers.reduce((map, t) => { map[t.id] = t.name; return map; }, {});
             const studentCountMap = students.reduce((map, s) => {
                 if (s.classId) { map[s.classId] = (map[s.classId] || 0) + 1; }
                 return map;
             }, {});

             const headers = ['شمار', 'کلاس کا نام', 'تفویض کردہ استاد', 'کل طلباء', 'مقررہ ماہانہ فیس'];
             const data = classes.map((c, index) => [
                 index + 1,
                 c.name,
                 c.teacherId ? teacherMap[c.teacherId] || 'N/A' : 'N/A',
                 studentCountMap[c.id] || 0,
                 c.feeAmount !== undefined ? c.feeAmount : 'سیٹ نہیں' // Show fee amount
             ]);
             displayReportData('کلاسز کی رپورٹ', headers, data);
         } catch (error) {
             console.error("Error generating class report:", error);
              displayReportData('کلاسز کی رپورٹ', [], []);
             showToast("خرابی", "کلاسز کی رپورٹ بنانے میں ناکامی۔", "danger");
         }
     }

      async function generateInventoryReport() {
          try {
              const items = await getAllFromStore('inventory');
              const headers = ['شمار', 'آئٹم کا نام', 'مقدار', 'تفصیل', 'شامل کرنے کی تاریخ'];
              const data = items.map((item, index) => [
                  index + 1,
                  item.name,
                  item.quantity,
                  item.description || '-',
                  item.addDate || '-'
              ]);
              displayReportData('انوینٹری کی رپورٹ', headers, data);
          } catch (error) {
              console.error("Error generating inventory report:", error);
              displayReportData('انوینٹری کی رپورٹ', [], []);
              showToast("خرابی", "انوینٹری رپورٹ بنانے میں ناکامی۔", "danger");
          }
      }

      // --- Report Options UI ---
      function showAttendanceReportOptions() {
        const optionsContainer = document.getElementById('reportOptionsContainer');
        optionsContainer.innerHTML = `
            <h5>حاضری رپورٹ کے اختیارات</h5>
            <div class="row g-3 align-items-end">
                 <div class="col-md-4">
                     <label for="reportAttendanceClass" class="form-label">کلاس منتخب کریں</label>
                     <select id="reportAttendanceClass" class="form-select"></select>
                 </div>
                 <div class="col-md-4">
                     <label for="reportAttendanceDate" class="form-label">تاریخ منتخب کریں</label>
                     <input type="date" id="reportAttendanceDate" class="form-control" required>
                 </div>
                 <div class="col-md-4">
                     <button class="btn btn-primary" onclick="generateAttendanceReportData()">رپورٹ بنائیں</button>
                 </div>
            </div>
        `;
         loadClassOptions('#reportAttendanceClass'); // Load classes into the options dropdown
         document.getElementById('reportAttendanceDate').valueAsDate = new Date(); // Default to today
         document.getElementById('reportOutput').classList.add('d-none'); // Hide previous report
      }

      function showFeeReportOptions() {
          const optionsContainer = document.getElementById('reportOptionsContainer');
          optionsContainer.innerHTML = `
              <h5>فیس رپورٹ کے اختیارات</h5>
              <div class="row g-3 align-items-end">
                   <div class="col-md-3">
                       <label for="reportFeeClass" class="form-label">کلاس</label>
                       <select id="reportFeeClass" class="form-select"></select>
                   </div>
                   <div class="col-md-3">
                       <label for="reportFeeMonth" class="form-label">مہینہ</label>
                       <input type="month" id="reportFeeMonth" class="form-control">
                   </div>
                    <div class="col-md-3">
                       <label for="reportFeeStatus" class="form-label">اسٹیٹس</label>
                       <select id="reportFeeStatus" class="form-select">
                           <option value="">تمام</option>
                           <option value="paid">ادا شدہ</option>
                           <option value="partial">جزوی ادا شدہ</option>
                           <option value="pending">واجب الادا</option>
                       </select>
                   </div>
                   <div class="col-md-3">
                       <button class="btn btn-primary" onclick="generateFeeReportData()">رپورٹ بنائیں</button>
                   </div>
              </div>
          `;
          loadClassOptions('#reportFeeClass', true); // Include "All Classes"
          document.getElementById('reportOutput').classList.add('d-none');
      }

       function showSalaryReportOptions() {
           const optionsContainer = document.getElementById('reportOptionsContainer');
           optionsContainer.innerHTML = `
               <h5>تنخواہ رپورٹ کے اختیارات</h5>
               <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="reportSalaryTeacher" class="form-label">استاد</label>
                        <select id="reportSalaryTeacher" class="form-select"></select>
                    </div>
                    <div class="col-md-4">
                        <label for="reportSalaryMonth" class="form-label">مہینہ</label>
                        <input type="month" id="reportSalaryMonth" class="form-control">
                    </div>
                     <div class="col-md-4">
                        <button class="btn btn-primary" onclick="generateSalaryReportData()">رپورٹ بنائیں</button>
                    </div>
               </div>
           `;
           loadTeacherOptions('#reportSalaryTeacher'); // Load teachers
           // Add an "All Teachers" option manually
            const teacherSelect = document.getElementById('reportSalaryTeacher');
            const allOption = document.createElement('option');
            allOption.value = "";
            allOption.textContent = "تمام اساتذہ";
            teacherSelect.insertBefore(allOption, teacherSelect.firstChild);
            teacherSelect.value = ""; // Select "All" by default

           document.getElementById('reportOutput').classList.add('d-none');
       }

        function showExpenseReportOptions() {
            const optionsContainer = document.getElementById('reportOptionsContainer');
            optionsContainer.innerHTML = `
                <h5>آمدنی/اخراجات رپورٹ کے اختیارات</h5>
                <div class="row g-3 align-items-end">
                     <div class="col-md-3">
                         <label for="reportExpenseType" class="form-label">قسم</label>
                         <select id="reportExpenseType" class="form-select">
                             <option value="">تمام</option>
                             <option value="income">صرف آمدنی</option>
                             <option value="expense">صرف اخراجات</option>
                         </select>
                     </div>
                     <div class="col-md-3">
                         <label for="reportExpenseStartDate" class="form-label">شروع کی تاریخ</label>
                         <input type="date" id="reportExpenseStartDate" class="form-control">
                     </div>
                     <div class="col-md-3">
                         <label for="reportExpenseEndDate" class="form-label">اختتام کی تاریخ</label>
                         <input type="date" id="reportExpenseEndDate" class="form-control">
                     </div>
                     <div class="col-md-3">
                         <button class="btn btn-primary" onclick="generateExpenseReportData()">رپورٹ بنائیں</button>
                     </div>
                </div>
            `;
             document.getElementById('reportExpenseEndDate').valueAsDate = new Date(); // Default end date to today
             // Set default start date to beginning of current month
              const today = new Date();
              const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
              document.getElementById('reportExpenseStartDate').value = firstDayOfMonth.toISOString().split('T')[0];

            document.getElementById('reportOutput').classList.add('d-none');
        }


      // --- Report Data Generation (with Options) ---
       async function generateAttendanceReportData() {
          const classId = parseInt(document.getElementById('reportAttendanceClass').value);
          const date = document.getElementById('reportAttendanceDate').value;
          const reportOutput = document.getElementById('reportOutput');
          reportOutput.classList.remove('d-none'); // Show report area
          setupReportHeader(); // Add header info

          if (!classId || !date) {
               displayReportData(`حاضری رپورٹ`, [], []);
               showToast("خرابی", "براہ کرم کلاس اور تاریخ منتخب کریں۔", "warning");
               return;
          }

          try {
              const students = await getAllFromStore('students', 'classId', classId);
              const attendanceRecords = await getAllFromStore('attendance', 'date', date);
              const className = (await getFromStore('classes', classId)).name;

              const attendanceMap = attendanceRecords
                  .filter(att => att.classId === classId)
                  .reduce((map, att) => { map[att.studentId] = att.status; return map; }, {});

               const headers = ['شمار', 'طالب علم کا نام', 'والد کا نام', 'حاضری اسٹیٹس'];
               let presentCount = 0, absentCount = 0, leaveCount = 0;

               const data = students
                 .sort((a, b) => a.name.localeCompare(b.name, 'ur')) // Sort students
                 .map((student, index) => {
                  const status = attendanceMap[student.id] || 'غير نشان زدہ'; // Default if no record
                  let statusUrdu = 'غير نشان زدہ';
                  if (status === 'present') { statusUrdu = 'حاضر ✅'; presentCount++; }
                  else if (status === 'absent') { statusUrdu = 'غیر حاضر ❌'; absentCount++; }
                  else if (status === 'leave') { statusUrdu = 'رخصت'; leaveCount++; }

                    return [
                        index + 1,
                        student.name,
                        student.fatherName,
                        statusUrdu
                    ];
               });

              const reportTitle = `حاضری رپورٹ برائے کلاس ${className} - ${date}`;
              displayReportData(reportTitle, headers, data);

              // Add summary to the report output
              const reportTableContainer = document.getElementById('reportTableContainer');
              const summaryDiv = document.createElement('div');
              summaryDiv.className = 'mt-3 alert alert-info';
              summaryDiv.innerHTML = `
                  <strong>خلاصہ:</strong>
                  کل طلباء: ${students.length} |
                  حاضر: ${presentCount} |
                  غیر حاضر: ${absentCount} |
                  رخصت: ${leaveCount} |
                  غير نشان زدہ: ${students.length - (presentCount + absentCount + leaveCount)}
              `;
              reportTableContainer.appendChild(summaryDiv);


          } catch (error) {
              console.error("Error generating attendance report:", error);
              displayReportData(`حاضری رپورٹ`, [], []);
              showToast("خرابی", "حاضری رپورٹ بنانے میں ناکامی۔", "danger");
          }
      }

       async function generateFeeReportData() {
           const classIdFilter = document.getElementById('reportFeeClass').value ? parseInt(document.getElementById('reportFeeClass').value) : null;
           const monthFilter = document.getElementById('reportFeeMonth').value; // YYYY-MM
           const statusFilter = document.getElementById('reportFeeStatus').value;
           const reportOutput = document.getElementById('reportOutput');
           reportOutput.classList.remove('d-none');
           setupReportHeader();

           try {
                let feeRecords = await getAllFromStore('fees');
                const students = await getAllFromStore('students');
                const classes = await getAllFromStore('classes');

                const studentMap = students.reduce((map, s) => { map[s.id] = {name: s.name, fatherName: s.fatherName, classId: s.classId}; return map; }, {});
                const classMap = classes.reduce((map, c) => { map[c.id] = c.name; return map; }, {});

                // Apply filters
                let filteredRecords = feeRecords.filter(record => {
                    const studentInfo = studentMap[record.studentId];
                    const studentClassId = studentInfo ? studentInfo.classId : null;
                    const matchesClass = !classIdFilter || (record.classId === classIdFilter);
                    const matchesMonth = !monthFilter || record.month === monthFilter;
                    const matchesStatus = !statusFilter || record.status === statusFilter || (statusFilter === 'pending' && (record.status === 'pending' || record.status === 'partial'));
                    return matchesClass && matchesMonth && matchesStatus;
                });

                 // Sort by class, then student name
                 filteredRecords.sort((a, b) => {
                      const classA = a.classId ? classMap[a.classId] || '' : '';
                      const classB = b.classId ? classMap[b.classId] || '' : '';
                      const nameA = studentMap[a.studentId] ? studentMap[a.studentId].name : '';
                      const nameB = studentMap[b.studentId] ? studentMap[b.studentId].name : '';
                      if (classA !== classB) return classA.localeCompare(classB, 'ur');
                      return nameA.localeCompare(nameB, 'ur');
                 });

                const headers = ['شمار', 'طالب علم', 'والد کا نام', 'کلاس', 'مہینہ', 'مقررہ فیس', 'وصول شدہ', 'بقايا', 'اسٹیٹس', 'وصولی تاریخ'];
                let totalDue = 0, totalPaid = 0, totalBalance = 0;

                const data = filteredRecords.map((record, index) => {
                     const studentInfo = studentMap[record.studentId];
                     const className = studentInfo && studentInfo.classId ? classMap[studentInfo.classId] : 'N/A';
                     const balance = record.amountDue - record.amountPaid;
                     let statusText = '';
                     switch(record.status) {
                         case 'paid': statusText = 'ادا شدہ'; break;
                         case 'partial': statusText = 'جزوی ادا شدہ'; break;
                         case 'pending': statusText = 'واجب الادا'; break;
                         default: statusText = 'نامعلوم';
                     }
                     totalDue += record.amountDue;
                     totalPaid += record.amountPaid;
                     totalBalance += balance > 0 ? balance : 0;

                     return [
                        index + 1,
                        studentInfo ? studentInfo.name : 'N/A',
                        studentInfo ? studentInfo.fatherName : 'N/A',
                        className,
                        record.month,
                        record.amountDue,
                        record.amountPaid,
                        balance > 0 ? balance : 0,
                        statusText,
                        record.paymentDate
                     ];
                });

                let reportTitle = `فیس رپورٹ`;
                if(classIdFilter) reportTitle += ` برائے کلاس ${classMap[classIdFilter]}`;
                if(monthFilter) reportTitle += ` - ${monthFilter}`;
                if(statusFilter) reportTitle += ` (${statusFilter === 'pending' ? 'واجب الادا/جزوی' : (statusFilter === 'paid' ? 'ادا شدہ' : 'جزوی')})`;

                displayReportData(reportTitle, headers, data);

                 // Add summary
                 const reportTableContainer = document.getElementById('reportTableContainer');
                 const summaryDiv = document.createElement('div');
                 summaryDiv.className = 'mt-3 alert alert-info';
                 summaryDiv.innerHTML = `
                     <strong>خلاصہ:</strong>
                     کل واجب الادا: ${totalDue.toFixed(2)} |
                     کل وصول شدہ: ${totalPaid.toFixed(2)} |
                     کل بقايا: ${totalBalance.toFixed(2)}
                 `;
                 reportTableContainer.appendChild(summaryDiv);


           } catch (error) {
               console.error("Error generating fee report:", error);
               displayReportData(`فیس رپورٹ`, [], []);
               showToast("خرابی", "فیس رپورٹ بنانے میں ناکامی۔", "danger");
           }
       }

       async function generateSalaryReportData() {
           const teacherIdFilter = document.getElementById('reportSalaryTeacher').value ? parseInt(document.getElementById('reportSalaryTeacher').value) : null;
           const monthFilter = document.getElementById('reportSalaryMonth').value; // YYYY-MM
           const reportOutput = document.getElementById('reportOutput');
           reportOutput.classList.remove('d-none');
           setupReportHeader();

            try {
                let salaryRecords = await getAllFromStore('salaries');
                const teachers = await getAllFromStore('teachers');
                const teacherMap = teachers.reduce((map, t) => { map[t.id] = t.name; return map; }, {});

                 // Apply filters
                 let filteredRecords = salaryRecords.filter(record => {
                     const matchesTeacher = !teacherIdFilter || record.teacherId === teacherIdFilter;
                     const matchesMonth = !monthFilter || record.month === monthFilter;
                     return matchesTeacher && matchesMonth;
                 });

                 // Sort by teacher name, then month
                 filteredRecords.sort((a, b) => {
                      const nameA = teacherMap[a.teacherId] || '';
                      const nameB = teacherMap[b.teacherId] || '';
                      if (nameA !== nameB) return nameA.localeCompare(nameB, 'ur');
                      return (a.month || '').localeCompare(b.month || '');
                 });


                const headers = ['شمار', 'استاد', 'مہینہ', 'مقررہ تنخواہ', 'ادا شدہ', 'اسٹیٹس', 'ادائیگی تاریخ'];
                 let totalDue = 0, totalPaid = 0;

                 const data = filteredRecords.map((record, index) => {
                      let statusText = '';
                      switch(record.status) {
                          case 'paid': statusText = 'ادا شدہ'; break;
                          case 'partial': statusText = 'جزوی ادا شدہ'; break;
                          case 'pending': statusText = 'واجب الادا'; break;
                          default: statusText = 'نامعلوم';
                      }
                      totalDue += record.amountDue;
                      totalPaid += record.amountPaid;

                      return [
                         index + 1,
                         teacherMap[record.teacherId] || 'N/A',
                         record.month,
                         record.amountDue,
                         record.amountPaid,
                         statusText,
                         record.paymentDate
                      ];
                 });

                 let reportTitle = `تنخواہ رپورٹ`;
                 if(teacherIdFilter) reportTitle += ` برائے ${teacherMap[teacherIdFilter]}`;
                 if(monthFilter) reportTitle += ` - ${monthFilter}`;

                 displayReportData(reportTitle, headers, data);

                  // Add summary
                  const reportTableContainer = document.getElementById('reportTableContainer');
                  const summaryDiv = document.createElement('div');
                  summaryDiv.className = 'mt-3 alert alert-info';
                  summaryDiv.innerHTML = `
                      <strong>خلاصہ:</strong>
                      کل مقررہ تنخواہ: ${totalDue.toFixed(2)} |
                      کل ادا شدہ: ${totalPaid.toFixed(2)}
                  `;
                  reportTableContainer.appendChild(summaryDiv);

            } catch (error) {
                console.error("Error generating salary report:", error);
                displayReportData(`تنخواہ رپورٹ`, [], []);
                showToast("خرابی", "تنخواہ رپورٹ بنانے میں ناکامی۔", "danger");
            }
       }

       async function generateExpenseReportData() {
           const typeFilter = document.getElementById('reportExpenseType').value;
           const startDateFilter = document.getElementById('reportExpenseStartDate').value;
           const endDateFilter = document.getElementById('reportExpenseEndDate').value;
           const reportOutput = document.getElementById('reportOutput');
           reportOutput.classList.remove('d-none');
           setupReportHeader();

           try {
               let transactions = await getAllFromStore('transactions');

               // Filter
               let filteredTransactions = transactions.filter(t => {
                   const matchesType = !typeFilter || t.type === typeFilter;
                   const matchesStartDate = !startDateFilter || t.date >= startDateFilter;
                   const matchesEndDate = !endDateFilter || t.date <= endDateFilter;
                   return matchesType && matchesStartDate && matchesEndDate;
               });

                // Sort by date
                filteredTransactions.sort((a, b) => a.date.localeCompare(b.date));

               const headers = ['شمار', 'تاریخ', 'تفصیل', 'قسم', 'رقم'];
               let totalIncome = 0;
               let totalExpenses = 0;

               const data = filteredTransactions.map((t, index) => {
                   const isIncome = t.type === 'income';
                   if (isIncome) {
                       totalIncome += t.amount;
                   } else {
                       totalExpenses += t.amount;
                   }
                   return [
                       index + 1,
                       t.date,
                       t.description,
                       isIncome ? 'آمدنی' : 'خرچہ',
                       t.amount.toFixed(2)
                   ];
               });

               let reportTitle = `آمدنی و اخراجات رپورٹ`;
               if (startDateFilter && endDateFilter) {
                   reportTitle += ` (${startDateFilter} تا ${endDateFilter})`;
               } else if (startDateFilter) {
                   reportTitle += ` (${startDateFilter} سے)`;
               } else if (endDateFilter) {
                    reportTitle += ` (${endDateFilter} تک)`;
               }
               if(typeFilter) reportTitle += ` - ${typeFilter === 'income' ? 'صرف آمدنی' : 'صرف اخراجات'}`;


               displayReportData(reportTitle, headers, data);

                // Add summary
                const reportTableContainer = document.getElementById('reportTableContainer');
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'mt-3 alert alert-info';
                summaryDiv.innerHTML = `
                    <strong>خلاصہ:</strong>
                    کل آمدنی: ${totalIncome.toFixed(2)} |
                    کل اخراجات: ${totalExpenses.toFixed(2)} |
                    بیلنس: ${(totalIncome - totalExpenses).toFixed(2)}
                `;
                reportTableContainer.appendChild(summaryDiv);

           } catch (error) {
               console.error("Error generating expense report:", error);
               displayReportData(`آمدنی و اخراجات رپورٹ`, [], []);
               showToast("خرابی", "آمدنی/اخراجات رپورٹ بنانے میں ناکامی۔", "danger");
           }
       }


      // --- Export & Print ---
      function exportReportToCSV() {
          if (!currentReportData || currentReportData.length === 0) {
              showToast("معلومات", "ایکسپورٹ کرنے کے لیے کوئی رپورٹ ڈیٹا موجود نہیں۔", "info");
              return;
          }

          // Add header info to CSV
          let csvContent = "\uFEFF"; // BOM for UTF-8 Excel compatibility
          csvContent += `"${currentSettings.madrasaName || ''}"\n`;
          csvContent += `"${currentSettings.madrasaAddress || ''}"\n`;
          csvContent += `"${currentSettings.madrasaPhone || ''}"\n\n`;
          csvContent += `"${currentReportTitle}"\n"`;


          const headers = currentReportHeaders.map(header => `"${header.replace(/"/g, '""')}"`).join(",");
          csvContent += headers + "\r\n";

          currentReportData.forEach(rowArray => {
              const row = rowArray.map(cell => {
                  const cellString = cell !== null && cell !== undefined ? String(cell) : '';
                  return `"${cellString.replace(/"/g, '""')}"`; // Escape double quotes
              }).join(",");
              csvContent += row + "\r\n";
          });

           // Add summary if present in the displayed report
           const summaryElement = document.querySelector('#reportTableContainer .alert');
           if(summaryElement) {
               csvContent += "\n"; // Add a blank line before summary
               // Extract text content, clean it up a bit
                const summaryText = summaryElement.textContent.trim().replace(/\s+/g, ' ').replace(/\|/g, ',');
               csvContent += `"${summaryText}"\n`;
           }


          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement("a");
          const url = URL.createObjectURL(blob);
          link.setAttribute("href", url);
          const safeTitle = currentReportTitle.replace(/[^a-z0-9_]/gi, '_').toLowerCase();
          const fileName = `${safeTitle}_${new Date().toISOString().split('T')[0]}.csv`;
          link.setAttribute("download", fileName);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          showToast("کامیابی", "رپورٹ CSV میں ایکسپورٹ ہو گئی۔");
      }

      function printReport() {
          const reportContent = document.getElementById('reportOutput');
          if (!reportContent || reportContent.classList.contains('d-none') || !currentReportData || currentReportData.length === 0) {
               showToast("معلومات", "پرنٹ کرنے کے لیے کوئی رپورٹ ڈیٹا موجود نہیں۔", "info");
               return;
          }
           window.print();
      }


     // --- Backup & Restore ---
     async function backupData() {
         try {
             const backupObject = {};
             const transaction = db.transaction(storeNames, 'readonly');
             let promises = [];

             storeNames.forEach(storeName => {
                 promises.push(new Promise((resolve, reject) => {
                     const store = transaction.objectStore(storeName);
                     const request = store.getAll();
                     request.onsuccess = (event) => {
                         backupObject[storeName] = event.target.result;
                         resolve();
                     };
                     request.onerror = (event) => reject(`Error backing up ${storeName}: ${event.target.error}`);
                 }));
             });

             await Promise.all(promises);

             const backupJson = JSON.stringify(backupObject, null, 2); // Pretty print JSON
             const blob = new Blob([backupJson], { type: 'application/json' });
             const link = document.createElement('a');
             const url = URL.createObjectURL(blob);
             link.href = url;
             const fileName = `madrasa_backup_${new Date().toISOString().split('T')[0]}.json`;
             link.download = fileName;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             URL.revokeObjectURL(url);
             showToast("کامیابی", "ڈیٹا بیک اپ کامیابی سے بنا لیا گیا۔");

         } catch (error) {
             console.error("Backup failed:", error);
             showToast("خرابی", `بیک اپ بنانے میں ناکامی: ${error}`, "danger");
         }
     }

     function restoreData() {
         const fileInput = document.getElementById('restoreFile');
         const file = fileInput.files[0];

         if (!file) {
             showToast("وارننگ", "براہ کرم بحال کرنے کے لیے بیک اپ فائل منتخب کریں۔", "warning");
             return;
         }
         if (!file.name.endsWith('.json')) {
             showToast("وارننگ", "براہ کرم ایک درست .json بیک اپ فائل منتخب کریں۔", "warning");
             return;
         }


         confirmAction('کیا آپ واقعی ڈیٹا بحال کرنا چاہتے ہیں؟ موجودہ تمام ڈیٹا ختم ہو جائے گا اور اس کی جگہ بیک اپ فائل کا ڈیٹا لے لے گا۔ یہ عمل واپس نہیں کیا جا سکتا۔', () => {
             const reader = new FileReader();

             reader.onload = async (event) => {
                 try {
                     const backupObject = JSON.parse(event.target.result);

                     // Validate basic structure
                     if (typeof backupObject !== 'object' || backupObject === null) {
                         throw new Error("فائل کا مواد درست JSON آبجیکٹ نہیں ہے۔");
                     }
                      const missingStores = storeNames.filter(name => !backupObject.hasOwnProperty(name));
                     if (missingStores.length > 0) {
                         console.warn(`Backup is missing data for stores: ${missingStores.join(', ')}`);
                         // Optionally ask for confirmation to proceed anyway
                         // throw new Error(`بیک اپ فائل نامکمل ہے۔ سٹورز غائب ہیں: ${missingStores.join(', ')}`);
                     }


                     // Clear existing data and add new data
                     const transaction = db.transaction(storeNames, 'readwrite');
                     let promises = [];

                     storeNames.forEach(storeName => {
                         if (backupObject.hasOwnProperty(storeName)) {
                             promises.push(new Promise((resolve, reject) => {
                                 const store = transaction.objectStore(storeName);
                                 const clearRequest = store.clear();
                                 clearRequest.onsuccess = () => {
                                     const dataToRestore = backupObject[storeName];
                                     if (Array.isArray(dataToRestore)) {
                                          let count = 0;
                                          if (dataToRestore.length === 0) {
                                             resolve(); // Nothing to add
                                             return;
                                          }
                                         dataToRestore.forEach((item, index) => {
                                              // Remove potential 'id' if store uses autoIncrement and ID might conflict
                                              // However, for relationships, we NEED the original IDs.
                                              // Let's assume IDs from backup are correct and try adding.
                                              // If autoIncrement causes issues, schema might need non-autoIncrement keys.
                                              const addRequest = store.add(item);
                                             addRequest.onsuccess = () => {
                                                 count++;
                                                 if (count === dataToRestore.length) {
                                                     resolve(); // All items added for this store
                                                 }
                                             };
                                              addRequest.onerror = (e) => {
                                                 console.error(`Error restoring item to ${storeName}:`, item, e.target.error);
                                                 // Continue restoring other items? Or reject? Let's continue.
                                                 count++; // Treat as processed even if error
                                                  if (count === dataToRestore.length) {
                                                     resolve();
                                                 }
                                                 // reject(`Error restoring item to ${storeName}: ${e.target.error}`);
                                             };
                                         });
                                     } else {
                                         resolve(); // No data or not an array
                                     }
                                 };
                                 clearRequest.onerror = (e) => reject(`Error clearing store ${storeName}: ${e.target.error}`);
                             }));
                         }
                     });

                     transaction.oncomplete = async () => {
                          showToast("کامیابی", "ڈیٹا کامیابی سے بحال ہو گیا۔ براہ کرم صفحہ ریفریش کریں۔");
                          // Reload settings and refresh UI after successful restore
                          await loadSettings();
                          showSection('dashboard'); // Go to dashboard
                           updateDashboardStats();
                           fileInput.value = ''; // Clear the file input
                     };
                     transaction.onerror = (e) => {
                          console.error("Restore transaction failed:", e.target.error);
                          showToast("شدید خرابی", `ڈیٹا بحال کرنے میں ٹرانزیکشن کی خرابی: ${e.target.error}. ڈیٹا نامکمل ہو سکتا ہے۔`, "danger");
                     };

                     await Promise.all(promises); // Wait for all store operations to be defined


                 } catch (error) {
                     console.error("Restore failed:", error);
                     showToast("خرابی", `ڈیٹا بحال کرنے میں ناکامی: ${error.message}`, "danger");
                 }
             };

             reader.onerror = () => {
                  console.error("Error reading restore file:", reader.error);
                  showToast("خرابی", "بیک اپ فائل پڑھنے میں ناکامی۔", "danger");
             };

             reader.readAsText(file);
         }); // End confirmAction
     }

    // --- Dashboard Stats ---
    async function updateDashboardStats() {
        try {
            const students = await getAllFromStore('students');
            const teachers = await getAllFromStore('teachers');
            const classes = await getAllFromStore('classes');

             // Calculate today's income
            const today = new Date().toISOString().split('T')[0];
            const transactions = await getAllFromStore('transactions', 'date', today);
            const todayIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);


            document.getElementById('dashboardTotalStudents').textContent = students.length;
            document.getElementById('dashboardTotalTeachers').textContent = teachers.length;
            document.getElementById('dashboardTotalClasses').textContent = classes.length;
             document.getElementById('dashboardTodayIncome').textContent = todayIncome.toFixed(2);

        } catch (error) {
            console.error("Error updating dashboard stats:", error);
            // Display 0 or error message if needed
             document.getElementById('dashboardTotalStudents').textContent = 'خرابی';
             document.getElementById('dashboardTotalTeachers').textContent = 'خرابی';
             document.getElementById('dashboardTotalClasses').textContent = 'خرابی';
             document.getElementById('dashboardTodayIncome').textContent = 'خرابی';
        }
    }

     // --- Helper: Get single record by index ---
     function getFromStoreByIndex(storeName, indexName, query) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("Database not initialized");
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const index = store.index(indexName);
            const request = index.get(query); // Use get for single record

            request.onsuccess = (event) => resolve(event.target.result); // Result will be the record or undefined
            request.onerror = (event) => reject(event.target.error);
        });
    }

    // --- Modified loadStudentOptions function ---
     async function loadStudentOptions(selectId, selectedStudentIds = []) {
         const select = document.querySelector(selectId);
         if (!select) {
             console.error(`Element with selector "${selectId}" not found.`);
             return;
         }
         select.innerHTML = '<option value="">طالب علم منتخب کریں</option>'; // Add default prompt
         try {
             const students = await getAllFromStore('students');
             if (students.length === 0) {
                 select.innerHTML = '<option value="" disabled>کوئی طالب علم موجود نہیں</option>';
                 return;
             }

             students.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort students by name

             students.forEach(student => {
                 const option = document.createElement('option');
                 option.value = student.id;
                 // Include father's name for better identification if names are similar
                 option.textContent = `${student.name} ( ولد ${student.fatherName || 'نامعلوم'})`;
                 // This part is only relevant for the multi-select class assignment modal
                 if (select.multiple && selectedStudentIds.includes(student.id)) {
                      option.selected = true;
                 }
                 select.appendChild(option);
             });
              // For single select, ensure the default prompt is selected initially if nothing else is
             if (!select.multiple) {
                  select.value = ""; // Ensure the prompt is selected by default
             }
         } catch (error) {
             console.error("Error loading students for dropdown:", error);
              select.innerHTML = '<option value="" disabled>طلباء لوڈ کرنے میں خرابی</option>'; // Show error in dropdown
         }
     }


    // --- Navigation ---
    function showSection(sectionId) {
        document.querySelectorAll('.app-section').forEach(section => {
            section.classList.add('d-none');
        });
         document.querySelectorAll('.nav-link').forEach(link => {
             link.classList.remove('active');
         });

        const activeSection = document.getElementById(sectionId);
        const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);

        if (activeSection) {
            activeSection.classList.remove('d-none');
            // Load data for the section when it's shown
            switch (sectionId) {
                case 'dashboard': updateDashboardStats(); break;
                case 'students': displayStudents(); break;
                case 'teachers': displayTeachers(); break;
                case 'classes': displayClasses(); break;
                case 'attendance':
                     loadClassOptions('#attendanceClassSelect');
                     document.getElementById('attendanceDate').valueAsDate = new Date();
                     loadAttendanceSheet(); // Initial load
                     break;
                case 'fees': displayFeeRecords(); break;
                case 'salaries': displaySalaryRecords(); break;
                case 'inventory': displayInventory(); break;
                 case 'expenses':
                     document.getElementById('expenseMonthFilter').value = ''; // Clear filters
                     document.getElementById('expenseTypeFilter').value = '';
                     displayTransactions();
                     break;
                case 'reports':
                    document.getElementById('reportOptionsContainer').innerHTML = ''; // Clear options
                    document.getElementById('reportOutput').classList.add('d-none'); // Hide output
                    break;
                case 'settings': loadSettings(); break; // Reload settings view
                // backupRestore needs no initial data load
            }
        }
        if (activeLink) {
            activeLink.classList.add('active');
        }
         // Collapse navbar on mobile after clicking a link
         const navbarCollapse = document.getElementById('navbarNav');
         if (navbarCollapse.classList.contains('show')) {
             const collapseInstance = bootstrap.Collapse.getInstance(navbarCollapse);
             if (collapseInstance) {
                 collapseInstance.hide();
             }
         }
    }

 function generateAttendanceReport () {
    const attendanceSection = document.getElementById('attendance');
    if (!attendanceSection) return;

    // Check if the detailed report container already exists
    let detailedReportContainer = document.getElementById('detailedAttendanceReportContainer');
    if (detailedReportContainer) {
        // Clear previous results if container exists
         const outputDiv = document.getElementById('detailedAttendanceReportOutput');
         if (outputDiv) outputDiv.innerHTML = '';
        return; // Filters are already set up
    }

    // Create the main container for the detailed report section
    detailedReportContainer = document.createElement('div');
    detailedReportContainer.id = 'detailedAttendanceReportContainer';
    detailedReportContainer.className = 'mt-5 pt-4 border-top no-print'; // Add no-print class

    detailedReportContainer.innerHTML = `
        <h3 class="mb-3">تفصیلی حاضری رپورٹ</h3>
        <div class="row g-3 mb-3 align-items-end bg-light p-3 rounded">
            <div class="col-md-3">
                <label for="detailedReportClass" class="form-label">کلاس</label>
                <select id="detailedReportClass" class="form-select form-select-sm"></select>
            </div>
            <div class="col-md-3">
                <label for="detailedReportStudent" class="form-label">طالب علم</label>
                <select id="detailedReportStudent" class="form-select form-select-sm">
                     <option value="">تمام طلباء</option>
                     <!-- Options loaded dynamically -->
                </select>
            </div>
            <div class="col-md-2">
                <label for="detailedReportStartDate" class="form-label">شروع تاریخ</label>
                <input type="date" id="detailedReportStartDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-2">
                <label for="detailedReportEndDate" class="form-label">اختتام تاریخ</label>
                <input type="date" id="detailedReportEndDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-2">
                <label for="detailedReportStatus" class="form-label">اسٹیٹس</label>
                <select id="detailedReportStatus" class="form-select form-select-sm">
                    <option value="">تمام</option>
                    <option value="present">حاضر</option>
                    <option value="absent">غیر حاضر</option>
                    <option value="leave">رخصت</option>
                </select>
            </div>
            <div class="col-12 text-center mt-3">
                 <button class="btn btn-primary btn-sm" onclick="generateDetailedAttendanceReport()">رپورٹ بنائیں</button>
                 <button class="btn btn-secondary btn-sm" onclick="printDetailedAttendanceReport()">پرنٹ کریں</button>
                 <button class="btn btn-success btn-sm" onclick="exportDetailedAttendanceReportToCSV()">CSV ایکسپورٹ</button>
            </div>
        </div>
        <div id="detailedAttendanceReportOutput" class="mt-3 table-responsive">
            <!-- Report table will be generated here -->
        </div>
         <div id="detailedAttendanceReportPrintSection" style="display:none;">
             <!-- Content specifically formatted for printing -->
         </div>
    `;

    // Append the new section to the main attendance section
    attendanceSection.appendChild(detailedReportContainer);

    // Populate class dropdown (including 'All Classes')
    loadClassOptions('#detailedReportClass', true).then(() => {
         // Set default date range (e.g., current month)
         const today = new Date();
         const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
         document.getElementById('detailedReportStartDate').value = firstDayOfMonth.toISOString().split('T')[0];
         document.getElementById('detailedReportEndDate').value = today.toISOString().split('T')[0];

         // Load students based on default class selection (All Classes)
         loadStudentOptionsForFilter(); // Load all students initially

         // Add event listener for class change to update student list
         const classSelect = document.getElementById('detailedReportClass');
         if (classSelect) {
             classSelect.addEventListener('change', loadStudentOptionsForFilter);
         }
    });
 }

 async function loadStudentOptionsForFilter() {
     const classSelect = document.getElementById('detailedReportClass');
     const studentSelect = document.getElementById('detailedReportStudent');
     const selectedClassId = classSelect ? classSelect.value : ''; // Get selected class ID (can be empty string for 'All')

     if (!studentSelect) return;
     studentSelect.innerHTML = '<option value="">لوڈ ہو رہا ہے...</option>'; // Show loading state

     try {
         let students = [];
         if (selectedClassId && selectedClassId !== "") {
             // Fetch students for the specific selected class
             students = await getAllFromStore('students', 'classId', parseInt(selectedClassId));
         } else {
             // Fetch all students if 'All Classes' is selected
             students = await getAllFromStore('students');
         }

         // Clear current options and add 'All Students'
         studentSelect.innerHTML = '<option value="">تمام طلباء</option>';

         if (students.length === 0 && selectedClassId) {
             studentSelect.innerHTML = '<option value="" disabled>اس کلاس میں طلباء نہیں</option>';
         } else if (students.length === 0) {
              studentSelect.innerHTML = '<option value="" disabled>کوئی طالب علم موجود نہیں</option>';
         } else {
             students.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort
             students.forEach(student => {
                 const option = document.createElement('option');
                 option.value = student.id;
                 option.textContent = `${student.name} (${student.fatherName || 'N/A'})`;
                 studentSelect.appendChild(option);
             });
         }
          studentSelect.value = ""; // Ensure 'All Students' is selected by default

     } catch (error) {
         console.error("Error loading students for filter dropdown:", error);
         studentSelect.innerHTML = '<option value="" disabled>طلباء لوڈ کرنے میں خرابی</option>';
     }
 }


 async function generateDetailedAttendanceReport() {
     const outputDiv = document.getElementById('detailedAttendanceReportOutput');
     if (!outputDiv) return;
     outputDiv.innerHTML = '<p class="text-center">رپورٹ تیار کی جا رہی ہے...</p>';

     // Get filter values
     const classIdFilter = document.getElementById('detailedReportClass').value;
     const studentIdFilter = document.getElementById('detailedReportStudent').value;
     const startDateFilter = document.getElementById('detailedReportStartDate').value;
     const endDateFilter = document.getElementById('detailedReportEndDate').value;
     const statusFilter = document.getElementById('detailedReportStatus').value;

     if (!startDateFilter || !endDateFilter) {
         outputDiv.innerHTML = '<p class="text-center text-danger">براہ کرم شروع اور اختتام کی تاریخ منتخب کریں۔</p>';
         return;
     }
      if (startDateFilter > endDateFilter) {
         outputDiv.innerHTML = '<p class="text-center text-danger">شروع کی تاریخ اختتام کی تاریخ کے بعد نہیں ہو سکتی۔</p>';
         return;
     }

     try {
         // Fetch all necessary data
         const allAttendance = await getAllFromStore('attendance');
         const allStudents = await getAllFromStore('students');
         const allClasses = await getAllFromStore('classes');

         const studentMap = allStudents.reduce((map, s) => { map[s.id] = s; return map; }, {});
         const classMap = allClasses.reduce((map, c) => { map[c.id] = c.name; return map; }, {});

         // --- Filtering Logic ---
         let filteredAttendance = allAttendance.filter(att => {
             // Date Filter (Inclusive)
             if (att.date < startDateFilter || att.date > endDateFilter) {
                 return false;
             }
             // Class Filter
             if (classIdFilter && att.classId !== parseInt(classIdFilter)) {
                 return false;
             }
             // Student Filter
             if (studentIdFilter && att.studentId !== parseInt(studentIdFilter)) {
                 return false;
             }
             // Status Filter
             if (statusFilter && att.status !== statusFilter) {
                 return false;
             }
             // Ensure student exists for the record
             if (!studentMap[att.studentId]) {
                 console.warn(`Attendance record found for non-existent student ID: ${att.studentId}`);
                 return false; // Skip records for students not found
             }
              // Ensure class exists for the record (optional, but good practice)
             if (!classMap[att.classId]) {
                  console.warn(`Attendance record found for non-existent class ID: ${att.classId}`);
                 // Decide whether to skip or show with 'Unknown Class'
                 // return false;
             }

             return true; // Passed all filters
         });

         // --- Sorting ---
         filteredAttendance.sort((a, b) => {
             // Sort primarily by date
             if (a.date !== b.date) return a.date.localeCompare(b.date);
             // Then by class name (using map)
             const classA = classMap[a.classId] || '';
             const classB = classMap[b.classId] || '';
             if (classA !== classB) return classA.localeCompare(classB, 'ur');
             // Then by student name (using map)
             const studentA = studentMap[a.studentId]?.name || '';
             const studentB = studentMap[b.studentId]?.name || '';
             return studentA.localeCompare(studentB, 'ur');
         });

         // --- Prepare Table Data & Summary ---
         const headers = ['شمار', 'تاریخ', 'طالب علم', 'کلاس', 'اسٹیٹس'];
         let presentCount = 0, absentCount = 0, leaveCount = 0;

         const tableData = filteredAttendance.map((att, index) => {
             const student = studentMap[att.studentId];
             const className = classMap[att.classId] || 'نامعلوم';
             let statusUrdu = 'نامعلوم';
             switch (att.status) {
                 case 'present': statusUrdu = 'حاضر'; presentCount++; break;
                 case 'absent': statusUrdu = 'غیر حاضر'; absentCount++; break;
                 case 'leave': statusUrdu = 'رخصت'; leaveCount++; break;
             }
             return [
                 index + 1,
                 att.date,
                 student ? `${student.name} (${student.fatherName || 'N/A'})` : 'نامعلوم طالب علم',
                 className,
                 statusUrdu
             ];
         });

         // --- Generate Table HTML ---
         if (tableData.length === 0) {
             outputDiv.innerHTML = '<p class="text-center">منتخب کردہ معیار کے مطابق کوئی حاضری ریکارڈ نہیں ملا۔</p>';
             return;
         }

         let tableHTML = '<table class="table table-striped table-bordered table-sm">';
         tableHTML += '<thead><tr>';
         headers.forEach(h => tableHTML += `<th>${h}</th>`);
         tableHTML += '</tr></thead><tbody>';

         tableData.forEach(row => {
             tableHTML += '<tr>';
             row.forEach(cell => tableHTML += `<td>${cell}</td>`);
             tableHTML += '</tr>';
         });

         tableHTML += '</tbody></table>';

         // --- Generate Summary HTML ---
         const totalRecords = tableData.length;
         let summaryHTML = `
             <div class="alert alert-secondary mt-2 mb-0">
                 <strong>خلاصہ (${startDateFilter} تا ${endDateFilter}):</strong>
                 کل ریکارڈز: ${totalRecords} |
                 حاضر: ${presentCount} (${((presentCount / totalRecords) * 100 || 0).toFixed(1)}%) |
                 غیر حاضر: ${absentCount} (${((absentCount / totalRecords) * 100 || 0).toFixed(1)}%) |
                 رخصت: ${leaveCount} (${((leaveCount / totalRecords) * 100 || 0).toFixed(1)}%)
             </div>
         `;

         outputDiv.innerHTML = tableHTML + summaryHTML;

     } catch (error) {
         console.error("Error generating detailed attendance report:", error);
         outputDiv.innerHTML = '<p class="text-center text-danger">رپورٹ بنانے میں خرابی۔ کنسول چیک کریں۔</p>';
         showToast("خرابی", "تفصیلی حاضری رپورٹ بنانے میں ناکامی۔", "danger");
     }
 }

 function printDetailedAttendanceReport() {
    const reportContent = document.getElementById('detailedAttendanceReportOutput');
    const printArea = document.getElementById('detailedAttendanceReportPrintSection');
    const filterInfoDiv = document.createElement('div');

    if (!reportContent || !printArea || reportContent.children.length === 0 || reportContent.children[0].tagName === 'P') {
         showToast("معلومات", "پرنٹ کرنے کے لیے کوئی رپورٹ ڈیٹا موجود نہیں۔", "info");
         return;
    }

    // --- Gather Filter Criteria for Header ---
    const classFilterText = document.getElementById('detailedReportClass').selectedOptions[0]?.textContent || 'تمام';
    const studentFilterText = document.getElementById('detailedReportStudent').selectedOptions[0]?.textContent || 'تمام';
    const startDateFilter = document.getElementById('detailedReportStartDate').value;
    const endDateFilter = document.getElementById('detailedReportEndDate').value;
    const statusFilterText = document.getElementById('detailedReportStatus').selectedOptions[0]?.textContent || 'تمام';

    filterInfoDiv.className = 'mb-3 text-muted small';
    filterInfoDiv.innerHTML = `
        <strong>فلٹر:</strong>
        کلاس: ${classFilterText} |
        طالب علم: ${studentFilterText} |
        تاریخ: ${startDateFilter} تا ${endDateFilter} |
        اسٹیٹس: ${statusFilterText}
    `;
    // --- End Filter Criteria ---


    // Clone the madrasa header from the main report section
    const mainReportHeader = document.getElementById('reportHeader');
    let headerHTML = '';
    if (mainReportHeader) {
        // We need to ensure the logo source is correctly read if it's already loaded
        const logoImg = mainReportHeader.querySelector('#reportLogo');
        const nameH4 = mainReportHeader.querySelector('#reportMadrasaName');
        const addressP = mainReportHeader.querySelector('#reportMadrasaAddress');
        const phoneP = mainReportHeader.querySelector('#reportMadrasaPhone');
        headerHTML = `
            <div class="text-center mb-3">
                ${logoImg && logoImg.style.display !== 'none' ? `<img src="${logoImg.src}" alt="لوگو" style="max-height: 60px; margin-bottom: 5px;"><br>` : ''}
                ${nameH4 ? `<h4>${nameH4.textContent}</h4>` : ''}
                 ${addressP ? `<p style="font-size: 0.9em;">${addressP.textContent}</p>` : ''}
                 ${phoneP ? `<p style="font-size: 0.9em;">${phoneP.textContent}</p>` : ''}
                 <h5>تفصیلی حاضری رپورٹ</h5>
                 <hr>
             </div>
        `;
    } else {
         headerHTML = '<h4 class="text-center mb-3">تفصیلی حاضری رپورٹ</h4><hr>';
    }


    // Prepare print content
    printArea.innerHTML = headerHTML + filterInfoDiv.outerHTML + reportContent.innerHTML;

    // Temporarily hide everything else, show print area, print, then revert
     const originalBodyContent = document.body.innerHTML;
     document.body.innerHTML = printArea.innerHTML;
     window.print();
     document.body.innerHTML = originalBodyContent; // Restore original content

     // Re-initialize necessary things after restoring body content
     reinitializeEventListenersAndState(); // You'll need to define this function
     showSection('attendance'); // Go back to the attendance section view

 }

  async function reinitializeEventListenersAndState() {
        // This function is crucial after replacing document.body.innerHTML
        console.log("Re-initializing after print...");
        try {
             // Re-init DB (might not be strictly necessary if `db` variable is still in scope)
            // await initDB();
            await loadSettings();

            // Re-attach main navigation listeners
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                     e.preventDefault();
                     const sectionId = e.target.getAttribute('data-section');
                     if (sectionId) { showSection(sectionId); }
                });
             });

              // Re-attach logo upload listener
              const logoInput = document.getElementById('madrasaLogo');
              if(logoInput) logoInput.addEventListener('change', handleLogoUpload);

             // Re-initialize modal instances (Bootstrap might handle this if elements persist, but safer to re-init)
             const confirmModalEl = document.getElementById('confirmModal');
             if (confirmModalEl) { confirmModalInstance = new bootstrap.Modal(confirmModalEl); }
             const toastEl = document.getElementById('appToast');
             if (toastEl) { toastInstance = new bootstrap.Toast(toastEl); }

             // Re-attach class filter listener in detailed attendance report section
             const classSelect = document.getElementById('detailedReportClass');
             if (classSelect) {
                  classSelect.addEventListener('change', loadStudentOptionsForFilter);
             }

             // Re-populate dynamic dropdowns that might have been lost
             // Example: Reload class options in attendance filter
              await loadClassOptions('#attendanceClassSelect');
             // Reload classes in the detailed report filter and reselect if needed
              const detailedClassSelect = document.getElementById('detailedReportClass');
              if(detailedClassSelect) await loadClassOptions('#detailedReportClass', true);
              // Reload students in the detailed report filter
              await loadStudentOptionsForFilter();


            console.log("Re-initialization complete.");

        } catch(error) {
            console.error("Error during re-initialization:", error);
            document.body.innerHTML = '<div class="alert alert-danger m-3">ایپلیکیشن دوبارہ شروع کرنے میں خرابی۔ براہ کرم صفحہ ریفریش کریں۔</div>';
        }
     }


 function exportDetailedAttendanceReportToCSV() {
    const table = document.querySelector('#detailedAttendanceReportOutput table');
    const summaryDiv = document.querySelector('#detailedAttendanceReportOutput .alert'); // Get the summary

    if (!table) {
        showToast("معلومات", "ایکسپورٹ کرنے کے لیے کوئی رپورٹ ڈیٹا موجود نہیں۔", "info");
        return;
    }

    let csvContent = "\uFEFF"; // BOM for UTF-8

     // Add Madrasa Info
     csvContent += `"${currentSettings.madrasaName || ''}"\n`;
     csvContent += `"${currentSettings.madrasaAddress || ''}"\n`;
     csvContent += `"${currentSettings.madrasaPhone || ''}"\n\n`;
     csvContent += `"تفصیلی حاضری رپورٹ"\n`;

     // Add Filter Info
     const classFilterText = document.getElementById('detailedReportClass').selectedOptions[0]?.textContent || 'تمام';
     const studentFilterText = document.getElementById('detailedReportStudent').selectedOptions[0]?.textContent || 'تمام';
     const startDateFilter = document.getElementById('detailedReportStartDate').value;
     const endDateFilter = document.getElementById('detailedReportEndDate').value;
     const statusFilterText = document.getElementById('detailedReportStatus').selectedOptions[0]?.textContent || 'تمام';
     csvContent += `"فلٹر: کلاس=${classFilterText}, طالب علم=${studentFilterText}, تاریخ=${startDateFilter} تا ${endDateFilter}, اسٹیٹس=${statusFilterText}"\n\n`;

    // Extract Headers
    const headers = Array.from(table.querySelectorAll('thead th')).map(th => `"${th.textContent.replace(/"/g, '""')}"`).join(',');
    csvContent += headers + '\r\n';

    // Extract Rows
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const rowData = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`).join(',');
        csvContent += rowData + '\r\n';
    });

     // Add Summary
     if (summaryDiv) {
         csvContent += '\r\n'; // Blank line
         // Clean up summary text for CSV line
         const summaryText = summaryDiv.textContent.replace('خلاصہ', 'Summary').replace(/\s+/g, ' ').trim();
         csvContent += `"${summaryText}"\r\n`;
     }

    // Create and Download Blob
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    const fileName = `detailed_attendance_report_${new Date().toISOString().split('T')[0]}.csv`;
    link.setAttribute("download", fileName);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast("کامیابی", "تفصیلی رپورٹ CSV میں ایکسپورٹ ہو گئی۔");
 }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await initDB();
            await loadSettings(); // Load settings first
            showSection('dashboard'); // Show dashboard initially

            // Setup navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.target.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                    }
                });
            });

             // Set default date for attendance
             document.getElementById('attendanceDate').valueAsDate = new Date();
             // Set default date for fee payment
             document.getElementById('feePaymentDate').valueAsDate = new Date();
             // Set default date for salary payment
             document.getElementById('salaryPaymentDate').valueAsDate = new Date();

             // Set default month for fees/salary to current month
              const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
              document.getElementById('feePaymentMonth').value = currentMonth;
              document.getElementById('salaryPaymentMonth').value = currentMonth;

              // Initialize default month filter for expenses
             // document.getElementById('expenseMonthFilter').value = currentMonth;


             // Initialize modal instances for confirmation and toast
             // Check if elements exist before creating instances
             const confirmModalEl = document.getElementById('confirmModal');
             if (confirmModalEl) {
                 confirmModalInstance = new bootstrap.Modal(confirmModalEl);
             }
             const toastEl = document.getElementById('appToast');
             if (toastEl) {
                  toastInstance = new bootstrap.Toast(toastEl);
             }


        } catch (error) {
            console.error("Initialization failed:", error);
            document.body.innerHTML = '<div class="alert alert-danger m-3">ایپلیکیشن شروع کرنے میں شدید خرابی۔ ڈیٹا بیس تک رسائی ممکن نہیں ہے۔</div>';
        }
    });

</script>
<script>
</script>
<script>
// Donation Modal - Fullscreen, vertical icon, notification dot, modern, no global conflicts
(function () {
  const PREFIX = 'donateAppV2_';
  const MODAL_ID = PREFIX + 'modal_bg';
  const BTN_ID = PREFIX + 'sticky-btn';
  const NOTIF_KEY = PREFIX + 'notif_shown';

  // Urdu is default
  const LANGS = {
    ur: {
      lang: 'اردو', direction: 'rtl',
      title: 'صدقہ جاریہ - عطیہ کریں',
      message: `آپ کی عطیہ اس منصوبے کی بہتری اور توسیع کیلئے استعمال ہوگی، کسی اور مقصد کیلئے نہیں۔<br>
<strong>ایزی پیسہ نمبر: <span dir="ltr" style="font-family:monospace">03139842219</span></strong><br><br>
<b>قرآن:</b><br>
"احْسِنُوا إِنَّ اللَّهَ يُحِبُّ الْمُحْسِنِينَ" (البقرہ: 195)<br>
<br>
<b>احادیث:</b><br>
"جو تمہارے ساتھ بھلائی کرے، اس کے ساتھ بھلائی کرو۔" (بخاری)<br>
"جب انسان فوت ہو جاتا ہے تو اس کے اعمال منقطع ہو جاتے ہیں سوائے تین چیزوں کے: صدقہ جاریہ، علم جو فائدہ دے، اور نیک اولاد جو دعا کرے۔" (مسلم)<br>
<br>
دینی کام کو بہتر بنانے میں حصہ ڈال کر صدقہ جاریہ کمائیں۔`,
      close: 'بند کریں'
    },
    en: {
      lang: 'English', direction: 'ltr',
      title: 'Sadaqah Jariyah - Donate',
      message: `Your donation will be used <b>only</b> to grow and improve this project.<br>
<strong>EasyPaisa Number: <span style="font-family:monospace">03139842219</span></strong><br><br>
<b>Qur’an:</b><br>
"Do good; truly, Allah loves the doers of good." (Al-Baqarah: 195)<br>
<br>
<b>Hadith:</b><br>
"Do good to those who do good to you." (Bukhari)<br>
"When a person dies, his deeds end except for three: Sadaqah Jariyah, beneficial knowledge, and a righteous child who prays for him." (Muslim)<br>
<br>
Earn Sadaqah Jariyah by supporting this religious cause.`,
      close: 'Close'
    },
    ar: {
      lang: 'العربية', direction: 'rtl',
      title: 'صدقة جارية - تبرع',
      message: `سيتم استخدام تبرعك فقط لنمو وتحسين هذا المشروع.<br>
<strong>رقم إيزي بيزا: <span dir="ltr" style="font-family:monospace">03139842219</span></strong><br><br>
<b>القرآن:</b><br>
"وَأَحْسِنُوا إِنَّ اللَّهَ يُحِبُّ الْمُحْسِنِينَ" (البقرة: 195)<br>
<br>
<b>الحديث:</b><br>
"أحسنوا إلى من أحسن إليكم." (البخاري)<br>
"إذا مات ابن آدم انقطع عمله إلا من ثلاث: صدقة جارية، أو علم ينتفع به، أو ولد صالح يدعو له." (مسلم)<br>
<br>
ساهم في تطوير هذا العمل الخيري لكسب صدقة جارية.`,
      close: 'إغلاق'
    }
  };
  let currentLang = 'ur';

  function injectStyles() {
    if (document.getElementById(PREFIX + 'style')) return;
    const style = document.createElement('style');
    style.id = PREFIX + 'style';
    style.textContent = `
      .${PREFIX}sticky-btn {
        position: fixed; left: 24px; bottom: 24px; z-index: 2147483640;
        background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.13);
        display:flex; flex-direction:column; align-items:center; justify-content:center;
        width: 50px; height: 50px; cursor: pointer; border: none; transition:box-shadow .2s;
        border: 2.5px solid #e7e7e7;
        padding: 0; gap: 0;
        outline: none;
      }
      .${PREFIX}sticky-btn:hover, .${PREFIX}sticky-btn:focus-visible { box-shadow: 0 4px 24px #0003; }
      .${PREFIX}icon {
        display:block; margin:0 auto;
        width: 26px; height: 26px; pointer-events:none;
      }
      .${PREFIX}money-icon { margin-bottom: -8px;}
      .${PREFIX}notif-dot {
        position: absolute; top: 8px; right: 8px;
        background: #e74c3c; color: #fff; font-size: 0.98em;
        width: 19px; height: 19px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 0 2px #fff;
        font-weight: bold;
        animation: ${PREFIX}notifpop .5s;
        z-index: 4;
        pointer-events: none;
      }
      @keyframes ${PREFIX}notifpop {
        0% { transform: scale(0.4);}
        60% { transform: scale(1.2);}
        100% { transform: scale(1);}
      }
      .${PREFIX}modal-bg {
        position:fixed; z-index:2147483647; left:0;top:0;right:0;bottom:0; width:100vw;height:100vh;
        background:rgba(34,34,34,0.97); display:flex; align-items:center; justify-content:center;
        transition:background .3s;
      }
      .${PREFIX}modal-box {
        background:#fff; color:#111; width:98%; border-radius:20px;
        box-shadow:0 2px 24px #0002; padding:38px 22px 27px 22px; position:relative;
        font-family:inherit; font-size:1.14rem; line-height:1.7; overflow-y:auto; max-height:calc(100vh - 54px);
        text-align:initial; direction:inherit;
        display: flex; flex-direction: column; align-items: stretch;
      }
      .${PREFIX}modal-box[dir=rtl] { text-align: right;}
      .${PREFIX}modal-close {
        position:absolute; top:12px; right:16px;
        background:transparent; border:none; font-size:2em; color:#888; cursor:pointer;
        z-index: 11;
      }
      .${PREFIX}modal-title {
        font-size:1.5em; font-weight:700; margin-bottom:0.7em; line-height:1.2;
      }
      .${PREFIX}lang-switch {
        display:flex; gap:8px; justify-content:center; margin-bottom:1em; margin-top: -0.8em;
      }
      .${PREFIX}lang-btn {
        border:none; background:#eee; padding:3px 10px; border-radius:6px; cursor:pointer;
        font-size:1em; color:#222; opacity:0.7; transition:.18s;
      }
      .${PREFIX}lang-btn.active, .${PREFIX}lang-btn:hover { background:#92e3a9; color:#044; opacity:1;}
      @media (max-width: 600px) {
        .${PREFIX}modal-box{padding:16px 6vw 11px 6vw; font-size:1em; max-width:99vw;}
        .${PREFIX}modal-title {font-size:1.1em;}
      }
    `;
    document.head.appendChild(style);
  }

  // SVG icons (money and heart, stacked)
  function getIcons() {
    return `
      <span class="${PREFIX}money-icon">${getMoneySVG()}</span>
      <span class="${PREFIX}heart-icon">${getHeartSVG()}</span>
    `;
  }
  function getMoneySVG() {
    return `<svg width="25" height="25" viewBox="0 -16.04 72.617 72.617" xmlns="http://www.w3.org/2000/svg">
  <g id="Group_58" data-name="Group 58" transform="translate(-621.208 -934.226)">
    <g id="Group_57" data-name="Group 57">
      <path id="Path_48" data-name="Path 48" d="M688.461,944.951a191.915,191.915,0,0,0-11.136-10.725h-50.3a5.823,5.823,0,0,0-5.817,5.816v18.223A192.8,192.8,0,0,0,631.935,969.4a6.063,6.063,0,0,0,6.014,5.364h49.819a6.064,6.064,0,0,0,6.057-6.057V950.965A6.063,6.063,0,0,0,688.461,944.951Zm-64.253,13.314V940.042a2.82,2.82,0,0,1,2.817-2.816h50.3a2.815,2.815,0,0,1,2.769,2.341H632.367a5.824,5.824,0,0,0-5.817,5.817v15.649A2.816,2.816,0,0,1,624.208,958.265Zm5.342,5.341V945.384a2.821,2.821,0,0,1,2.817-2.817h50.3a2.816,2.816,0,0,1,2.769,2.341H637.949a6.064,6.064,0,0,0-6.057,6.057v15.41A2.815,2.815,0,0,1,629.55,963.606Zm61.275,5.1a3.061,3.061,0,0,1-3.057,3.057H637.949a3.06,3.06,0,0,1-3.057-3.057V950.965a3.06,3.06,0,0,1,3.057-3.057h49.819a3.061,3.061,0,0,1,3.057,3.057Z" fill="#0c2b67"/>
      <path id="Path_49" data-name="Path 49" d="M662.858,950c-4.952,0-8.981,4.411-8.981,9.834s4.029,9.833,8.981,9.833,8.981-4.411,8.981-9.833S667.81,950,662.858,950Zm0,16.667c-3.3,0-5.981-3.066-5.981-6.833S659.56,953,662.858,953s5.981,3.065,5.981,6.834S666.156,966.67,662.858,966.67Z" fill="#0c2b67"/>
      <path id="Path_50" data-name="Path 50" d="M681.352,954.732a5.1,5.1,0,1,0,5.1,5.1A5.111,5.111,0,0,0,681.352,954.732Zm0,7.208a2.1,2.1,0,1,1,2.1-2.1A2.107,2.107,0,0,1,681.352,961.94Z" fill="#0c2b67"/>
      <path id="Path_51" data-name="Path 51" d="M644.717,954.732a5.1,5.1,0,1,0,5.1,5.1A5.11,5.11,0,0,0,644.717,954.732Zm0,7.208a2.1,2.1,0,1,1,2.1-2.1A2.1,2.1,0,0,1,644.717,961.94Z" fill="#0c2b67"/>
    </g>
    <path id="Path_52" data-name="Path 52" d="M662.531,962.846c-1.6-.11-2.423-.94-2.478-2.184h1.833a.8.8,0,0,0,.645.784v-1.2c-1.686-.23-2.349-.811-2.349-2.1,0-1.151.884-1.962,2.349-2.063v-.82h.746v.829c1.373.11,2.193.728,2.294,2.027h-1.8a.64.64,0,0,0-.5-.627v1.133c1.428.194,2.386.664,2.386,2.009,0,1.152-.718,2.1-2.386,2.211V964h-.746Zm0-4.321v-1.059c-.378.064-.571.258-.571.525C661.96,958.286,662.107,958.433,662.531,958.525Zm.746,1.852v1.087c.378-.083.553-.295.553-.58C663.83,960.617,663.692,960.478,663.277,960.377Z" fill="#0d2b67"/>
  </g>
</svg>`;
  }
  function getHeartSVG() {
    return `<svg class="${PREFIX}icon" viewBox="0 0 24 24" fill="#e74c3c"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 
      4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 
      19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54z"/></svg>`;
  }

  function getModalHTML(lang) {
    const l = LANGS[lang];
    return `
      <div class="${PREFIX}modal-bg" id="${MODAL_ID}" tabindex="-1" aria-modal="true" role="dialog">
        <div class="${PREFIX}modal-box" dir="${l.direction}">
          <button class="${PREFIX}modal-close" title="${l.close}" aria-label="${l.close}" type="button">&times;</button>
          <div class="${PREFIX}lang-switch">
            ${Object.keys(LANGS).map(code =>
              `<button class="${PREFIX}lang-btn${lang===code?' active':''}" data-lang="${code}" type="button">${LANGS[code].lang}</button>`
            ).join('')}
          </div>
          <div class="${PREFIX}modal-title">${l.title}</div>
          <div class="${PREFIX}modal-message">${l.message}</div>
        </div>
      </div>
    `;
  }

  function showModal() {
    injectStyles();
    document.getElementById(MODAL_ID)?.remove();
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = getModalHTML(currentLang);
    const modalBg = tempDiv.firstElementChild;
    document.body.appendChild(modalBg);

    // Focus trap
    const modalBox = modalBg.querySelector(`.${PREFIX}modal-box`);
    modalBox.setAttribute('tabindex', '0');
    setTimeout(()=>modalBox.focus(), 80);

    // Lang switch
    modalBg.querySelectorAll(`.${PREFIX}lang-btn`).forEach(btn => {
      btn.onclick = function(){
        currentLang = btn.getAttribute('data-lang');
        showModal();
      };
    });

    // Close handlers
    const closeBtn = modalBg.querySelector(`.${PREFIX}modal-close`);
    closeBtn.onclick = removeModal;
    modalBg.onclick = function(e){
      if(e.target === modalBg) removeModal();
    };
    modalBg.onkeydown = function(e){
      if(e.key && (e.key==='Escape'||e.key==='Esc')) removeModal();
    };
    document.body.style.overflow = 'hidden';
  }

  function removeModal() {
    document.getElementById(MODAL_ID)?.remove();
    document.body.style.overflow = '';
  }

  function createStickyBtn() {
    if (document.getElementById(BTN_ID)) return;
    injectStyles();
    const btn = document.createElement('button');
    btn.id = BTN_ID;
    btn.className = PREFIX + 'sticky-btn';
    btn.style.position = 'fixed';
    btn.style.zIndex = 2147483640;
    btn.innerHTML = getIcons();
    btn.title = 'Donate | عطیہ کریں | تبرع';
    btn.setAttribute('aria-label', 'Donate | عطیہ کریں | تبرع');
    btn.onclick = function() {
      showModal();
      if (!localStorage.getItem(NOTIF_KEY)) {
        localStorage.setItem(NOTIF_KEY, '1');
        const notif = document.getElementById(PREFIX + 'notif-dot');
        if (notif) notif.remove();
      }
    };
    // Keyboard accessible
    btn.tabIndex = 0;
    btn.onkeydown = function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        btn.click();
        e.preventDefault();
      }
    };

    // Notification badge
    if (!localStorage.getItem(NOTIF_KEY)) {
      const dot = document.createElement('span');
      dot.className = PREFIX + 'notif-dot';
      dot.id = PREFIX + 'notif-dot';
      dot.textContent = '1';
      btn.style.position = 'fixed';
      btn.appendChild(dot);
    }

    document.body.appendChild(btn);
  }

  // On DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', createStickyBtn);
  } else {
    createStickyBtn();
  }
})();
</script>
<script type="module">
  import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

  const swUrl = './sw.js';
  const wb = new Workbox(swUrl);

  // This event fires when a new service worker has installed but is waiting to activate.
  wb.addEventListener('waiting', (event) => {
    console.log('A new service worker is waiting to activate.');
    // This sends a message to the waiting service worker, telling it to activate.
    wb.messageSW({ type: 'SKIP_WAITING' });
  });

  // This event fires when the new service worker has taken control.
  wb.addEventListener('controlling', (event) => {
    console.log('The new service worker is now in control. Reloading page for updates...');
    window.location.reload();
  });

  // Register the service worker.
  wb.register();
</script></body>
</html>
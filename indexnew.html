<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School & Madrasa Management App</title>
    <style>
        html,
        body {
            height: 100%;
        }
        * {
            box-sizing: border-box;
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', Arial, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            direction: rtl;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        .sidebar {
            width: 250px;
            background-color: #34495e;
            height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            padding-top: 70px;
            color: white;
            transition: all 0.3s;
            z-index: 999;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-menu li {
            padding: 10px 20px;
            border-bottom: 1px solid #465c6e;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .sidebar-menu li:hover {
            background-color: #2c3e50;
        }
        .sidebar-menu i {
            margin-left: 10px;
        }
        .main-container {
            margin-right: 250px;
            transition: all 0.3s;
            height: 100vh;
            overflow-y: auto;
            width: 81%;
            padding: 12px;
        }
        .main-content-inner {
            direction: rtl;
            padding: 20px;
        }
        .dashboard-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
            min-width: 250px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        .card-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: bold;
        }
        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }
        .card-subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }
        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 15px;
        }
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            direction: rtl;
        }
        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th,
        .table td {
            padding: 12px 15px;
            text-align: right;
        }
        .table thead th {
            background-color: #f1f1f1;
            color: #333;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .table tbody tr:hover {
            background-color: #f1f1f1;
        }
        .table td {
            border-bottom: 1px solid #ddd;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .section-view {
            display: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .profile-card {
            display: flex;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .profile-image {
            width: 150px;
            padding: 20px;
        }
        .profile-image img {
            width: 100%;
            border-radius: 50%;
            border: 3px solid #3498db;
        }
        .profile-details {
            flex: 1;
            padding: 20px;
        }
        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .profile-info {
            margin-bottom: 5px;
        }
        .profile-info span {
            font-weight: bold;
            margin-left: 10px;
            color: #7f8c8d;
        }
        @media print {
            .sidebar,
            .header,
            .no-print {
                display: none !important;
            }
            .main-container {
                margin: 0;
                padding: 0;
            }
            .print-only {
                display: block;
            }
            .table-container,
            .form-container,
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                padding-top: 60px;
            }
            .sidebar.active {
                width: 250px;
            }
            .main-container {
                margin-right: 0;
            }
            .main-container.sidebar-active {
                margin-right: 250px;
            }
            .menu-toggle {
                display: block;
            }
            .dashboard-cards {
                flex-direction: column;
            }
            .card {
                min-width: 100%;
            }
            .form-group {
                min-width: 100%;
            }
        }
        .menu-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1200;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }
        .notification.success {
            background-color: #2ecc71;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .notification.info {
            background-color: #3498db;
        }
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .calendar {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        .calendar-nav button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #3498db;
        }
        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        .calendar-weekdays div {
            text-align: center;
            font-weight: bold;
            color: #7f8c8d;
        }
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .calendar-day:hover {
            background-color: #f1f1f1;
        }
        .calendar-day.today {
            background-color: #3498db;
            color: white;
        }
        .calendar-day.has-event {
            border: 2px solid #e74c3c;
        }
        * {
            font-family: calibri;
        }
        #js-report-output-area .dashboard-cards .card {
            margin-bottom: 10px;
        }
        .filter-header-toggle {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .filter-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.2s ease-in-out;
        }
        /* .filter-content:not([style*="display: none"]) + .filter-header-toggle .filter-toggle-icon {
    transform: rotate(180deg);
} */
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    <div class="notification" id="notification"></div>
    <div class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars">☰</i>
    </div>
    <div class="sidebar" id="sidebar">
        <ul class="sidebar-menu">
            <li data-view="dashboard"><i class="fas fa-tachometer-alt">📊</i> ڈیش بورڈ</li>
            <li data-view="students"><i class="fas fa-user-graduate">👨‍🎓</i> طلباء</li>
            <li data-view="teachers"><i class="fas fa-chalkboard-teacher">👨‍🏫</i> اساتذہ</li>
            <li data-view="staff"><i class="fas fa-user-tie">👨‍💼</i> عملہ</li>
            <li data-view="classes"><i class="fas fa-chalkboard">🏫</i> کلاسز</li>
            <li data-view="subjects"><i class="fas fa-book">📚</i> مضامین</li>
            <li data-view="attendance"><i class="fas fa-clipboard-check">📋</i> حاضری</li>
            <li data-view="exams"><i class="fas fa-file-alt">📝</i> امتحانات</li>
            <li data-view="fees"><i class="fas fa-money-bill-wave">💰</i> فیس</li>
            <li data-view="salaries"><i class="fas fa-wallet">👛</i> تنخواہ</li>
            <li data-view="library"><i class="fas fa-book-reader">📖</i> لائبریری</li>
            <li data-view="users"><i class="fas fa-users-cog">👥</i> صارفین</li>
            <li data-view="reports"><i class="fas fa-chart-bar">📊</i> رپورٹس</li>
            <li data-view="settings"><i class="fas fa-cog">⚙️</i> ترتیبات</li>
            <li data-view="backup"><i class="fas fa-database">💾</i> بیک اپ</li>
        </ul>
    </div>
    <div class="main-container" id="mainContainer">
        <div class="main-content-inner"></div>
        <div class="header">
            <h1>School & Madrasa Management App</h1>
        </div>
        <div class="section-view" id="dashboard-view" style="display: block;">
            <h2>ڈیش بورڈ</h2>
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">کل طلباء</div>
                    <div class="card-value" id="total-students">0</div>
                    <div class="card-subtitle">رجسٹرڈ طلباء</div>
                </div>
                <div class="card">
                    <div class="card-title">کل اساتذہ</div>
                    <div class="card-value" id="total-teachers">0</div>
                    <div class="card-subtitle">رجسٹرڈ اساتذہ</div>
                </div>
                <div class="card">
                    <div class="card-title">کل کلاسز</div>
                    <div class="card-value" id="total-classes">0</div>
                    <div class="card-subtitle">فعال کلاسز</div>
                </div>
                <div class="card">
                    <div class="card-title">آج کی حاضری</div>
                    <div class="card-value" id="today-attendance">0%</div>
                    <div class="card-subtitle">طلباء حاضر</div>
                </div>
            </div>
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">ماہانہ فیس کلیکشن</div>
                    <div class="card-value" id="monthly-fee">0 روپے</div>
                    <div class="card-subtitle">موجودہ مہینہ</div>
                </div>
                <div class="card">
                    <div class="card-title">بقایا فیس</div>
                    <div class="card-value" id="pending-fee">0 روپے</div>
                    <div class="card-subtitle">واجب الادا فیس</div>
                </div>
            </div>
            <div class="form-container">
                <div class="form-title">آنے والے پروگرامز</div>
                <div id="upcoming-events">
                    <div class="table-container">
                        <table class="table" id="events-table">
                            <thead>
                                <tr>
                                    <th>نمبر</th>
                                    <th>پروگرام</th>
                                    <th>تاریخ</th>
                                    <th>مقام</th>
                                    <th>تفصیلات</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="form-container">
                <div class="form-title">حالیہ سرگرمیاں</div>
                <div id="recent-activities">
                    <div class="table-container">
                        <table class="table" id="activities-table">
                            <thead>
                                <tr>
                                    <th>نمبر</th>
                                    <th>سرگرمی</th>
                                    <th>تاریخ</th>
                                    <th>متعلقہ شخص</th>
                                    <th>تفصیلات</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="section-view" id="students-view">
            <h2>طلباء</h2>
            <div class="tabs">
                <div class="tab active" data-tab="students-list">طلباء کی فہرست</div>
                <div class="tab" data-tab="add-student">نیا طالب علم</div>
            </div>
            <div class="tab-content active" id="students-list">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" class="form-control" id="student-search"
                                placeholder="طالب علم کا نام، رول نمبر یا کلاس سے تلاش کریں">
                        </div>
                        <div class="form-group" style="flex: 0 0 auto;">
                            <button class="btn btn-primary" id="search-student-btn">تلاش کریں</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="students-table">
                        <thead>
                            <tr>
                                <th>رول نمبر</th>
                                <th>نام</th>
                                <th>والد کا نام</th>
                                <th>کلاس</th>
                                <th>سیکشن</th>
                                <th>رابطہ نمبر</th>
                                <th>داخلہ تاریخ</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-student">
                <div class="form-container">
                    <div class="form-title">نیا طالب علم داخل کریں</div>
                    <form id="student-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">طالب علم کا نام</label>
                                <input type="text" class="form-control" id="student-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">والد کا نام</label>
                                <input type="text" class="form-control" id="student-father" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">تاریخ پیدائش</label>
                                <input type="date" class="form-control" id="student-dob" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">جنس</label>
                                <select class="form-control" id="student-gender" required>
                                    <option value="مرد">مرد</option>
                                    <option value="عورت">عورت</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کلاس</label>
                                <select class="form-control" id="student-class" required>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">سیکشن</label>
                                <select class="form-control" id="student-section" required>
                                    <option value="الف">الف</option>
                                    <option value="ب">ب</option>
                                    <option value="ج">ج</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">رابطہ نمبر</label>
                                <input type="tel" class="form-control" id="student-contact" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ای میل</label>
                                <input type="email" class="form-control" id="student-email">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">سرپرست کا نام</label>
                                <input type="text" class="form-control" id="student-guardian">
                            </div>
                            <div class="form-group">
                                <label class="form-label">سرپرست کا رابطہ نمبر</label>
                                <input type="tel" class="form-control" id="student-guardian-contact">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مکمل پتہ</label>
                                <textarea class="form-control" id="student-address" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">طالب علم کی تصویر</label>
                                <input type="file" class="form-control" id="student-photo" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label class="form-label">داخلہ تاریخ</label>
                                <input type="date" class="form-control" id="student-admission-date" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">فیس کیٹیگری</label>
                                <select class="form-control" id="student-fee-category">
                                    <option value="عام">عام</option>
                                    <option value="مستحق">مستحق</option>
                                    <option value="اسکالرشپ">اسکالرشپ</option>
                                    <option value="مکمل معاف">مکمل معاف</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ماہانہ فیس</label>
                                <input type="number" class="form-control" id="student-monthly-fee" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اضافی معلومات</label>
                                <textarea class="form-control" id="student-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">طالب علم داخل کریں</button>
                            <button type="reset" class="btn btn-danger" style="margin-right: 10px;">فارم ری سیٹ
                                کریں</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="section-view" id="teachers-view">
            <h2>اساتذہ</h2>
            <div class="tabs">
                <div class="tab active" data-tab="teachers-list">اساتذہ کی فہرست</div>
                <div class="tab" data-tab="add-teacher">نیا استاد</div>
            </div>
            <div class="tab-content active" id="teachers-list">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" class="form-control" id="teacher-search"
                                placeholder="استاد کا نام، مضمون یا کلاس سے تلاش کریں">
                        </div>
                        <div class="form-group" style="flex: 0 0 auto;">
                            <button class="btn btn-primary" id="search-teacher-btn">تلاش کریں</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="teachers-table">
                        <thead>
                            <tr>
                                <th>شناختی نمبر</th>
                                <th>نام</th>
                                <th>قابلیت</th>
                                <th>مضمون</th>
                                <th>رابطہ نمبر</th>
                                <th>شمولیت تاریخ</th>
                                <th>تنخواہ</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-teacher">
                <div class="form-container">
                    <div class="form-title">نیا استاد داخل کریں</div>
                    <form id="teacher-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">استاد کا نام</label>
                                <input type="text" class="form-control" id="teacher-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">والد کا نام</label>
                                <input type="text" class="form-control" id="teacher-father" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">تاریخ پیدائش</label>
                                <input type="date" class="form-control" id="teacher-dob" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">جنس</label>
                                <select class="form-control" id="teacher-gender" required>
                                    <option value="مرد">مرد</option>
                                    <option value="عورت">عورت</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">قابلیت</label>
                                <input type="text" class="form-control" id="teacher-qualification" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">تخصص</label>
                                <input type="text" class="form-control" id="teacher-specialization" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اساتذہ کا مضمون</label>
                                <select class="form-control" id="teacher-subject" multiple required>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">کلاس</label>
                                <select class="form-control" id="teacher-class" multiple>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">رابطہ نمبر</label>
                                <input type="tel" class="form-control" id="teacher-contact" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ای میل</label>
                                <input type="email" class="form-control" id="teacher-email">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مکمل پتہ</label>
                                <textarea class="form-control" id="teacher-address" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">شناختی کارڈ نمبر</label>
                                <input type="text" class="form-control" id="teacher-cnic" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">استاد کی تصویر</label>
                                <input type="file" class="form-control" id="teacher-photo" accept="image/*">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">شمولیت تاریخ</label>
                                <input type="date" class="form-control" id="teacher-joining-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">بنیادی تنخواہ</label>
                                <input type="number" class="form-control" id="teacher-basic-salary" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">الاؤنسز</label>
                                <input type="number" class="form-control" id="teacher-allowances">
                            </div>
                            <div class="form-group">
                                <label class="form-label">کٹوتیاں</label>
                                <input type="number" class="form-control" id="teacher-deductions">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اضافی معلومات</label>
                                <textarea class="form-control" id="teacher-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">استاد داخل کریں</button>
                            <button type="reset" class="btn btn-danger" style="margin-right: 10px;">فارم ری سیٹ
                                کریں</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="section-view" id="staff-view">
            <h2>عملہ</h2>
            <div class="tabs">
                <div class="tab active" data-tab="staff-list">عملے کی فہرست</div>
                <div class="tab" data-tab="add-staff">نیا عملہ</div>
            </div>
            <div class="tab-content active" id="staff-list">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" class="form-control" id="staff-search"
                                placeholder="عملے کا نام، عہدہ یا شعبہ سے تلاش کریں">
                        </div>
                        <div class="form-group" style="flex: 0 0 auto;">
                            <button class="btn btn-primary" id="search-staff-btn">تلاش کریں</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="staff-table">
                        <thead>
                            <tr>
                                <th>شناختی نمبر</th>
                                <th>نام</th>
                                <th>عہدہ</th>
                                <th>شعبہ</th>
                                <th>رابطہ نمبر</th>
                                <th>شمولیت تاریخ</th>
                                <th>تنخواہ</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-staff">
                <div class="form-container">
                    <div class="form-title">نیا عملہ داخل کریں</div>
                    <form id="staff-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">عملے کا نام</label>
                                <input type="text" class="form-control" id="staff-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">والد کا نام</label>
                                <input type="text" class="form-control" id="staff-father" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">تاریخ پیدائش</label>
                                <input type="date" class="form-control" id="staff-dob" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">جنس</label>
                                <select class="form-control" id="staff-gender" required>
                                    <option value="مرد">مرد</option>
                                    <option value="عورت">عورت</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">عہدہ</label>
                                <select class="form-control" id="staff-designation" required>
                                    <option value="دفتری کلرک">دفتری کلرک</option>
                                    <option value="لائبریرین">لائبریرین</option>
                                    <option value="سیکیورٹی گارڈ">سیکیورٹی گارڈ</option>
                                    <option value="صفائی کرنے والا">صفائی کرنے والا</option>
                                    <option value="ڈرائیور">ڈرائیور</option>
                                    <option value="دیگر">دیگر</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">شعبہ</label>
                                <select class="form-control" id="staff-department" required>
                                    <option value="انتظامیہ">انتظامیہ</option>
                                    <option value="اکاؤنٹس">اکاؤنٹس</option>
                                    <option value="لائبریری">لائبریری</option>
                                    <option value="سیکیورٹی">سیکیورٹی</option>
                                    <option value="ٹرانسپورٹ">ٹرانسپورٹ</option>
                                    <option value="صفائی">صفائی</option>
                                    <option value="دیگر">دیگر</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">قابلیت</label>
                                <input type="text" class="form-control" id="staff-qualification">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ذمہ داریاں</label>
                                <input type="text" class="form-control" id="staff-responsibilities" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">رابطہ نمبر</label>
                                <input type="tel" class="form-control" id="staff-contact" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ای میل</label>
                                <input type="email" class="form-control" id="staff-email">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مکمل پتہ</label>
                                <textarea class="form-control" id="staff-address" rows="3" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">شناختی کارڈ نمبر</label>
                                <input type="text" class="form-control" id="staff-cnic" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">عملے کی تصویر</label>
                                <input type="file" class="form-control" id="staff-photo" accept="image/*">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">شمولیت تاریخ</label>
                                <input type="date" class="form-control" id="staff-joining-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">بنیادی تنخواہ</label>
                                <input type="number" class="form-control" id="staff-basic-salary" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">الاؤنسز</label>
                                <input type="number" class="form-control" id="staff-allowances">
                            </div>
                            <div class="form-group">
                                <label class="form-label">کٹوتیاں</label>
                                <input type="number" class="form-control" id="staff-deductions">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اضافی معلومات</label>
                                <textarea class="form-control" id="staff-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">عملہ داخل کریں</button>
                            <button type="reset" class="btn btn-danger" style="margin-right: 10px;">فارم ری سیٹ
                                کریں</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="section-view" id="classes-view">
            <h2>کلاسز</h2>
            <div class="tabs">
                <div class="tab active" data-tab="classes-list">کلاسز کی فہرست</div>
                <div class="tab" data-tab="add-class">نئی کلاس</div>
                <div class="tab" data-tab="sections">سیکشنز</div>
            </div>
            <div class="tab-content active" id="classes-list">
                <div class="table-container">
                    <table class="table" id="classes-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>کلاس کا نام</th>
                                <th>کلاس انچارج</th>
                                <th>سیکشنز</th>
                                <th>طلباء کی تعداد</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-class">
                <div class="form-container">
                    <div class="form-title">نئی کلاس داخل کریں</div>
                    <form id="class-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کلاس کا نام</label>
                                <input type="text" class="form-control" id="class-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">کلاس انچارج</label>
                                <select class="form-control" id="class-incharge" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کلاس دورہ</label>
                                <input type="text" class="form-control" id="class-level" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">سیکشنز</label>
                                <select class="form-control" id="class-sections" multiple required>
                                    <option value="الف">الف</option>
                                    <option value="ب">ب</option>
                                    <option value="ج">ج</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کمرہ نمبر</label>
                                <input type="text" class="form-control" id="class-room">
                            </div>
                            <div class="form-group">
                                <label class="form-label">فیس کیٹیگری</label>
                                <select class="form-control" id="class-fee-category">
                                    <option value="عام">عام</option>
                                    <option value="خصوصی">خصوصی</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ماہانہ فیس</label>
                                <input type="number" class="form-control" id="class-monthly-fee" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">داخلہ فیس</label>
                                <input type="number" class="form-control" id="class-admission-fee" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">اضافی معلومات</label>
                                <textarea class="form-control" id="class-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">کلاس داخل کریں</button>
                            <button type="reset" class="btn btn-danger" style="margin-right: 10px;">فارم ری سیٹ
                                کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="sections">
                <div class="form-container">
                    <div class="form-title">سیکشن مینجمنٹ</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="section-class" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="section-name" required>
                                <option value="الف">الف</option>
                                <option value="ب">ب</option>
                                <option value="ج">ج</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن انچارج</label>
                            <select class="form-control" id="section-incharge" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="save-section">سیکشن محفوظ کریں</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="sections-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>کلاس</th>
                                <th>سیکشن</th>
                                <th>سیکشن انچارج</th>
                                <th>طلباء کی تعداد</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="section-view" id="subjects-view">
            <h2>مضامین</h2>
            <div class="tabs">
                <div class="tab active" data-tab="subjects-list">مضامین کی فہرست</div>
                <div class="tab" data-tab="add-subject">نیا مضمون</div>
                <div class="tab" data-tab="class-subjects">کلاس مضامین</div>
            </div>
            <div class="tab-content active" id="subjects-list">
                <div class="table-container">
                    <table class="table" id="subjects-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>مضمون کا نام</th>
                                <th>مضمون کوڈ</th>
                                <th>مضمون کی قسم</th>
                                <th>تفصیلات</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-subject">
                <div class="form-container">
                    <div class="form-title">نیا مضمون داخل کریں</div>
                    <form id="subject-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مضمون کا نام</label>
                                <input type="text" class="form-control" id="subject-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">مضمون کوڈ</label>
                                <input type="text" class="form-control" id="subject-code" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مضمون کی قسم</label>
                                <select class="form-control" id="subject-type" required>
                                    <option value="قرآن">قرآن</option>
                                    <option value="حدیث">حدیث</option>
                                    <option value="فقہ">فقہ</option>
                                    <option value="عقیدہ">عقیدہ</option>
                                    <option value="سیرت">سیرت</option>
                                    <option value="اخلاق">اخلاق</option>
                                    <option value="عربی">عربی</option>
                                    <option value="فارسی">فارسی</option>
                                    <option value="اردو">اردو</option>
                                    <option value="انگریزی">انگریزی</option>
                                    <option value="ریاضی">ریاضی</option>
                                    <option value="سائنس">سائنس</option>
                                    <option value="سماجی علوم">سماجی علوم</option>
                                    <option value="دیگر">دیگر</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ہفتہ وار پیریڈز</label>
                                <input type="number" class="form-control" id="subject-periods" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مضمون کی تفصیلات</label>
                                <textarea class="form-control" id="subject-details" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">مضمون داخل کریں</button>
                            <button type="reset" class="btn btn-danger" style="margin-right: 10px;">فارم ری سیٹ
                                کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="class-subjects">
                <div class="form-container">
                    <div class="form-title">کلاس کے مضامین</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="class-subject-class" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">مضام
                                in</label>
                            <select class="form-control" id="class-subject-subject" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">استاد</label>
                            <select class="form-control" id="class-subject-teacher" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="save-class-subject">مضمون محفوظ کریں</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="class-subjects-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>کلاس</th>
                                <th>مضمون</th>
                                <th>استاد</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="section-view" id="attendance-view">
            <h2>حاضری</h2>
            <div class="tabs">
                <div class="tab active" data-tab="mark-attendance">حاضری لگائیں</div>
                <div class="tab" data-tab="view-attendance">حاضری دیکھیں</div>
                <div class="tab" data-tab="attendance-report">حاضری رپورٹ</div>
            </div>
            <div class="tab-content active" id="mark-attendance">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">تاریخ</label>
                            <input type="date" class="form-control" id="attendance-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="attendance-class" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="attendance-section" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="load-attendance">طلباء لوڈ کریں</button>
                    </div>
                </div>
                <div class="table-container" id="attendance-table-container" style="display: none;">
                    <form id="attendance-form">
                        <table class="table" id="attendance-table">
                            <thead>
                                <tr>
                                    <th>رول نمبر</th>
                                    <th>طالب علم کا نام</th>
                                    <th>حاضری</th>
                                    <th>تاخیر</th>
                                    <th>رخصت</th>
                                    <th>نوٹ</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">حاضری محفوظ کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="view-attendance">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">تاریخ</label>
                            <input type="date" class="form-control" id="view-attendance-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="view-attendance-class" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="view-attendance-section" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="view-attendance-btn">حاضری دیکھیں</button>
                    </div>
                </div>
                <div class="table-container" id="view-attendance-table-container" style="display: none;">
                    <table class="table" id="view-attendance-table">
                        <thead>
                            <tr>
                                <th>رول نمبر</th>
                                <th>طالب علم کا نام</th>
                                <th>حاضری</th>
                                <th>تاخیر</th>
                                <th>رخصت</th>
                                <th>نوٹ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="print-attendance">پرنٹ کریں</button>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="attendance-report">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="report-attendance-class" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="report-attendance-section" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">شروع تاریخ</label>
                            <input type="date" class="form-control" id="report-start-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ختم تاریخ</label>
                            <input type="date" class="form-control" id="report-end-date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-attendance-report">رپورٹ
                            بنائیں</button>
                    </div>
                </div>
                <div class="table-container" id="report-attendance-table-container" style="display: none;">
                    <table class="table" id="report-attendance-table">
                        <thead>
                            <tr>
                                <th>رول نمبر</th>
                                <th>طالب علم کا نام</th>
                                <th>کل دن</th>
                                <th>حاضر</th>
                                <th>غیر حاضر</th>
                                <th>تاخیر</th>
                                <th>رخصت</th>
                                <th>حاضری فیصد</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="print-attendance-report">پرنٹ کریں</button>
                        <button type="button" class="btn btn-success" id="export-attendance-report"
                            style="margin-right: 10px;">ایکسپورٹ کریں</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="section-view" id="exams-view">
            <h2>امتحانات</h2>
            <div class="tabs">
                <div class="tab active" data-tab="exams-list">امتحانات کی فہرست</div>
                <div class="tab" data-tab="add-exam">نیا امتحان</div>
                <div class="tab" data-tab="marks-entry">نمبر داخل کریں</div>
                <div class="tab" data-tab="result-cards">رزلٹ کارڈز</div>
            </div>
            <div class="tab-content active" id="exams-list">
                <div class="table-container">
                    <table class="table" id="exams-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>امتحان کا نام</th>
                                <th>شروع تاریخ</th>
                                <th>ختم تاریخ</th>
                                <th>کلاسز</th>
                                <th>حیثیت</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-exam">
                <div class="form-container">
                    <div class="form-title">نیا امتحان داخل کریں</div>
                    <form id="exam-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">امتحان کا نام</label>
                                <input type="text" class="form-control" id="exam-name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">امتحان کی قسم</label>
                                <select class="form-control" id="exam-type" required>
                                    <option value="ماہانہ">ماہانہ</option>
                                    <option value="سہ ماہی">سہ ماہی</option>
                                    <option value="ششماہی">ششماہی</option>
                                    <option value="سالانہ">سالانہ</option>
                                    <option value="دیگر">دیگر</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">شروع تاریخ</label>
                                <input type="date" class="form-control" id="exam-start-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ختم تاریخ</label>
                                <input type="date" class="form-control" id="exam-end-date" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کلاسز</label>
                                <select class="form-control" id="exam-classes" multiple required>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">پاسنگ فیصد</label>
                                <input type="number" class="form-control" id="exam-passing-percent" required min="0"
                                    max="100" value="33">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">تفصیلات</label>
                                <textarea class="form-control" id="exam-details" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">امتحان داخل کریں</button>
                            <button type="reset" class="btn btn-danger" style="margin-right: 10px;">فارم ری سیٹ
                                کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="marks-entry">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">امتحان</label>
                            <select class="form-control" id="marks-exam" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="marks-class" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="marks-section" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">مضمون</label>
                            <select class="form-control" id="marks-subject" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کل نمبر</label>
                            <input type="number" class="form-control" id="marks-total" required value="100">
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="load-students-marks">طلباء لوڈ کریں</button>
                    </div>
                </div>
                <div class="table-container" id="marks-table-container" style="display: none;">
                    <form id="marks-form">
                        <table class="table" id="marks-table">
                            <thead>
                                <tr>
                                    <th>رول نمبر</th>
                                    <th>طالب علم کا نام</th>
                                    <th>حاصل کردہ نمبر</th>
                                    <th>فیصد</th>
                                    <th>گریڈ</th>
                                    <th>نوٹ</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">نمبر محفوظ کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="result-cards">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">امتحان</label>
                            <select class="form-control" id="result-exam" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="result-class" required>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="result-section" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-result-cards">رزلٹ کارڈز
                            بنائیں</button>
                    </div>
                </div>
                <div id="result-cards-container" style="display: none;">
                </div>
            </div>
        </div>
        <div class="section-view" id="fees-view">
            <h2>فیس</h2>
            <div class="tabs">
                <div class="tab active" data-tab="fee-collection">فیس جمع کریں</div>
                <div class="tab" data-tab="fee-structure">فیس سٹرکچر</div>
                <div class="tab" data-tab="fee-reports">فیس رپورٹس</div>
                <div class="tab" data-tab="fee-defaulters">بقایا فیس والے</div>
            </div>
            <div class="tab-content active" id="fee-collection">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">طالب علم کی تلاش</label>
                            <input type="text" class="form-control" id="fee-student-search"
                                placeholder="رول نمبر یا نام سے تلاش کریں">
                        </div>
                        <div class="form-group" style="flex: 0 0 auto;">
                            <label class="form-label" style="visibility: hidden;">تلاش</label>
                            <button type="button" class="btn btn-primary" id="search-student-fee">تلاش کریں</button>
                        </div>
                    </div>
                </div>
                <div class="form-container" id="fee-student-details" style="display: none;">
                    <div class="form-title">طالب علم کی تفصیلات</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">رول نمبر</label>
                            <input type="text" class="form-control" id="fee-roll-number" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">نام</label>
                            <input type="text" class="form-control" id="fee-student-name" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <input type="text" class="form-control" id="fee-class" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">فیس کیٹیگری</label>
                            <input type="text" class="form-control" id="fee-category" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ماہانہ فیس</label>
                            <input type="text" class="form-control" id="fee-monthly" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">بقایا فیس</label>
                            <input type="text" class="form-control" id="fee-due" readonly>
                        </div>
                    </div>
                </div>
                <div class="form-container" id="fee-payment-form" style="display: none;">
                    <div class="form-title">فیس جمع کریں</div>
                    <form id="fee-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مہینہ</label>
                                <select class="form-control" id="fee-month" required>
                                    <option value="جنوری">جنوری</option>
                                    <option value="فروری">فروری</option>
                                    <option value="مارچ">مارچ</option>
                                    <option value="اپریل">اپریل</option>
                                    <option value="مئی">مئی</option>
                                    <option value="جون">جون</option>
                                    <option value="جولائی">جولائی</option>
                                    <option value="اگست">اگست</option>
                                    <option value="ستمبر">ستمبر</option>
                                    <option value="اکتوبر">اکتوبر</option>
                                    <option value="نومبر">نومبر</option>
                                    <option value="دسمبر">دسمبر</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">سال</label>
                                <input type="number" class="form-control" id="fee-year" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ماہانہ فیس</label>
                                <input type="number" class="form-control" id="fee-amount" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">جرمانہ</label>
                                <input type="number" class="form-control" id="fee-fine" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">رعایت</label>
                                <input type="number" class="form-control" id="fee-discount" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کل رقم</label>
                                <input type="number" class="form-control" id="fee-total" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ادائیگی کی تاریخ</label>
                                <input type="date" class="form-control" id="fee-payment-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ادائیگی کا طریقہ</label>
                                <select class="form-control" id="fee-payment-method" required>
                                    <option value="نقد">نقد</option>
                                    <option value="چیک">چیک</option>
                                    <option value="بینک ٹرانسفر">بینک ٹرانسفر</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">نوٹ</label>
                                <textarea class="form-control" id="fee-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">فیس جمع کریں</button>
                            <button type="button" class="btn btn-success" id="print-receipt"
                                style="margin-right: 10px;">رسید پرنٹ کریں</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="fee-history-container" style="display: none;">
                    <div class="form-title">فیس جمع کرنے کی تاریخ</div>
                    <table class="table" id="fee-history-table">
                        <thead>
                            <tr>
                                <th>رسید نمبر</th>
                                <th>مہینہ</th>
                                <th>تاریخ</th>
                                <th>فیس</th>
                                <th>جرمانہ</th>
                                <th>رعایت</th>
                                <th>کل رقم</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="fee-structure">
                <div class="form-container">
                    <div class="form-title">فیس سٹرکچر</div>
                    <form id="fee-structure-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کلاس</label>
                                <select class="form-control" id="fee-structure-class" required>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">فیس کیٹیگری</label>
                                <select class="form-control" id="fee-structure-category" required>
                                    <option value="عام">عام</option>
                                    <option value="مستحق">مستحق</option>
                                    <option value="اسکالرشپ">اسکالرشپ</option>
                                    <option value="مکمل معاف">مکمل معاف</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ماہانہ فیس</label>
                                <input type="number" class="form-control" id="fee-structure-monthly" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">داخلہ فیس</label>
                                <input type="number" class="form-control" id="fee-structure-admission" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">امتحانی فیس</label>
                                <input type="number" class="form-control" id="fee-structure-exam" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کمپیوٹر فیس</label>
                                <input type="number" class="form-control" id="fee-structure-computer">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ٹرانسپورٹ فیس</label>
                                <input type="number" class="form-control" id="fee-structure-transport">
                            </div>
                            <div class="form-group">
                                <label class="form-label">دیگر فیس</label>
                                <input type="number" class="form-control" id="fee-structure-other">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">تفصیلات</label>
                                <textarea class="form-control" id="fee-structure-details" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">فیس سٹرکچر محفوظ کریں</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table" id="fee-structure-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>کلاس</th>
                                <th>فیس کیٹیگری</th>
                                <th>ماہانہ فیس</th>
                                <th>داخلہ فیس</th>
                                <th>امتحانی فیس</th>
                                <th>کل فیس</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="fee-reports">
                <div class="form-container">
                    <div class="form-title">فیس رپورٹس</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">رپورٹ کی قسم</label>
                            <select class="form-control" id="fee-report-type" required>
                                <option value="daily">روزانہ</option>
                                <option value="monthly" selected>ماہانہ</option>
                                <option value="yearly">سالانہ</option>
                                <option value="class">کلاس کے مطابق</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="fee-report-date-row">
                        <div class="form-group">
                            <label class="form-label">تاریخ</label>
                            <input type="date" class="form-control" id="fee-report-date">
                        </div>
                    </div>
                    <div class="form-row" id="fee-report-month-row">
                        <div class="form-group">
                            <label class="form-label">مہینہ</label>
                            <select class="form-control" id="fee-report-month">
                                <option value="1">جنوری</option>
                                <option value="2">فروری</option>
                                <option value="3">مارچ</option>
                                <option value="4">اپریل</option>
                                <option value="5">مئی</option>
                                <option value="6">جون</option>
                                <option value="7">جولائی</option>
                                <option value="8">اگست</option>
                                <option value="9">ستمبر</option>
                                <option value="10">اکتوبر</option>
                                <option value="11">نومبر</option>
                                <option value="12">دسمبر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سال</label>
                            <input type="number" class="form-control" id="fee-report-year">
                        </div>
                    </div>
                    <div class="form-row" id="fee-report-class-row" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="fee-report-class">
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سیکشن</label>
                            <select class="form-control" id="fee-report-section">
                                <option value="all">تمام</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-fee-report">رپورٹ بنائیں</button>
                    </div>
                </div>
                <div class="form-container" id="fee-report-summary" style="display: none;">
                    <div class="form-title">رپورٹ سمری</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">کل جمع فیس</label>
                            <input type="text" class="form-control" id="fee-report-total-collected" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کل طلباء</label>
                            <input type="text" class="form-control" id="fee-report-total-students" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">فیس جمع کرنے والے طلباء</label>
                            <input type="text" class="form-control" id="fee-report-paid-students" readonly>
                        </div>
                    </div>
                </div>
                <div class="table-container" id="fee-report-table-container" style="display: none;">
                    <table class="table" id="fee-report-table">
                        <thead>
                            <tr>
                                <th>رسید نمبر</th>
                                <th>طالب علم کا نام</th>
                                <th>کلاس</th>
                                <th>مہینہ</th>
                                <th>تاریخ</th>
                                <th>فیس</th>
                                <th>جرمانہ</th>
                                <th>رعایت</th>
                                <th>کل رقم</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="print-fee-report">پرنٹ کریں</button>
                        <button type="button" class="btn btn-success" id="export-fee-report"
                            style="margin-right: 10px;">ایکسپورٹ کریں</button>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="fee-defaulters">
                <div class="form-container">
                    <div class="form-title">بقایا فیس والے طلباء</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">کلاس</label>
                            <select class="form-control" id="defaulter-class">
                                <option value="all">تمام کلاسز</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">مہینہ</label>
                            <select class="form-control" id="defaulter-month">
                                <option value="1">جنوری</option>
                                <option value="2">فروری</option>
                                <option value="3">مارچ</option>
                                <option value="4">اپریل</option>
                                <option value="5">مئی</option>
                                <option value="6">جون</option>
                                <option value="7">جولائی</option>
                                <option value="8">اگست</option>
                                <option value="9">ستمبر</option>
                                <option value="10">اکتوبر</option>
                                <option value="11">نومبر</option>
                                <option value="12">دسمبر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سال</label>
                            <input type="number" class="form-control" id="defaulter-year">
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-defaulters">رپورٹ بنائیں</button>
                    </div>
                </div>
                <div class="table-container" id="defaulters-table-container" style="display: none;">
                    <table class="table" id="defaulters-table">
                        <thead>
                            <tr>
                                <th>رول نمبر</th>
                                <th>طالب علم کا نام</th>
                                <th>کلاس</th>
                                <th>ماہانہ فیس</th>
                                <th>بقایا مہینے</th>
                                <th>کل بقایا رقم</th>
                                <th>رابطہ نمبر</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="print-defaulters">پرنٹ کریں</button>
                        <button type="button" class="btn btn-success" id="send-reminders"
                            style="margin-right: 10px;">یاددہانی بھیجیں</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="section-view" id="salaries-view">
            <h2>تنخواہیں</h2>
            <div class="tabs">
                <div class="tab active" data-tab="salary-payment">تنخواہ ادائیگی</div>
                <div class="tab" data-tab="salary-structure">تنخواہ سٹرکچر</div>
                <div class="tab" data-tab="salary-reports">تنخواہ رپورٹس</div>
            </div>
            <div class="tab-content active" id="salary-payment">
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ملازم کی قسم</label>
                            <select class="form-control" id="salary-employee-type" required>
                                <option value="teacher">استاد</option>
                                <option value="staff">عملہ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ملازم کی تلاش</label>
                            <input type="text" class="form-control" id="salary-employee-search"
                                placeholder="نام یا شناختی نمبر سے تلاش کریں">
                        </div>
                        <div class="form-group" style="flex: 0 0 auto;">
                            <label class="form-label" style="visibility: hidden;">تلاش</label>
                            <button type="button" class="btn btn-primary" id="search-employee-salary">تلاش کریں</button>
                        </div>
                    </div>
                </div>
                <div class="form-container" id="salary-employee-details" style="display: none;">
                    <div class="form-title">ملازم کی تفصیلات</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">شناختی نمبر</label>
                            <input type="text" class="form-control" id="salary-employee-id" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">نام</label>
                            <input type="text" class="form-control" id="salary-employee-name" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">عہدہ</label>
                            <input type="text" class="form-control" id="salary-employee-designation" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">بنیادی تنخواہ</label>
                            <input type="text" class="form-control" id="salary-basic" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">الاؤنسز</label>
                            <input type="text" class="form-control" id="salary-allowances" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کل تنخواہ</label>
                            <input type="text" class="form-control" id="salary-total" readonly>
                        </div>
                    </div>
                </div>
                <div class="form-container" id="salary-payment-form" style="display: none;">
                    <div class="form-title">تنخواہ ادائیگی</div>
                    <form id="salary-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">مہینہ</label>
                                <select class="form-control" id="salary-month" required>
                                    <option value="جنوری">جنوری</option>
                                    <option value="فروری">فروری</option>
                                    <option value="مارچ">مارچ</option>
                                    <option value="اپریل">اپریل</option>
                                    <option value="مئی">مئی</option>
                                    <option value="جون">جون</option>
                                    <option value="جولائی">جولائی</option>
                                    <option value="اگست">اگست</option>
                                    <option value="ستمبر">ستمبر</option>
                                    <option value="اکتوبر">اکتوبر</option>
                                    <option value="نومبر">نومبر</option>
                                    <option value="دسمبر">دسمبر</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">سال</label>
                                <input type="number" class="form-control" id="salary-year" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">بنیادی تنخواہ</label>
                                <input type="number" class="form-control" id="salary-payment-basic" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">الاؤنسز</label>
                                <input type="number" class="form-control" id="salary-payment-allowances">
                            </div>
                            <div class="form-group">
                                <label class="form-label">بونس</label>
                                <input type="number" class="form-control" id="salary-payment-bonus" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کٹوتیاں</label>
                                <input type="number" class="form-control" id="salary-payment-deductions" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">غیر حاضری کٹوتی</label>
                                <input type="number" class="form-control" id="salary-payment-absence" value="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ٹیکس</label>
                                <input type="number" class="form-control" id="salary-payment-tax" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">کل قابل ادائیگی</label>
                                <input type="number" class="form-control" id="salary-payment-total" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ادائیگی کی تاریخ</label>
                                <input type="date" class="form-control" id="salary-payment-date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ادائیگی کا طریقہ</label>
                                <select class="form-control" id="salary-payment-method" required>
                                    <option value="نقد">نقد</option>
                                    <option value="چیک">چیک</option>
                                    <option value="بینک ٹرانسفر">بینک ٹرانسفر</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ٹرانزیکشن آئی ڈی/چیک نمبر</label>
                                <input type="text" class="form-control" id="salary-payment-transaction">
                            </div>
                            <div class="form-group">
                                <label class="form-label">نوٹ</label>
                                <textarea class="form-control" id="salary-payment-notes" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">تنخواہ ادا کریں</button>
                            <button type="button" class="btn btn-success" id="print-salary-slip"
                                style="margin-right: 10px;">سیلری سلپ پرنٹ کریں</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="salary-history-container" style="display: none;">
                    <div class="form-title">تنخواہ کی تاریخ</div>
                    <table class="table" id="salary-history-table">
                        <thead>
                            <tr>
                                <th>وؤچر نمبر</th>
                                <th>مہینہ</th>
                                <th>تاریخ</th>
                                <th>بنیادی تنخواہ</th>
                                <th>الاؤنسز</th>
                                <th>کٹوتیاں</th>
                                <th>کل تنخواہ</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="salary-structure">
                <div class="form-container">
                    <div class="form-title">تنخواہ سٹرکچر</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">ملازم کی قسم</label>
                            <select class="form-control" id="structure-employee-type" required>
                                <option value="teacher">استاد</option>
                                <option value="staff">عملہ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ملازم</label>
                            <select class="form-control" id="structure-employee" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">بنیادی تنخواہ</label>
                            <input type="number" class="form-control" id="structure-basic-salary" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">گھر کرایہ الاؤنس</label>
                            <input type="number" class="form-control" id="structure-house-rent">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ٹرانسپورٹ الاؤنس</label>
                            <input type="number" class="form-control" id="structure-transport">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">میڈیکل الاؤنس</label>
                            <input type="number" class="form-control" id="structure-medical">
                        </div>
                        <div class="form-group">
                            <label class="form-label">دیگر الاؤنسز</label>
                            <input type="number" class="form-control" id="structure-other-allowances">
                        </div>
                        <div class="form-group">
                            <label class="form-label">کل تنخواہ</label>
                            <input type="number" class="form-control" id="structure-total-salary" readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">مستقل کٹوتیاں</label>
                            <input type="number" class="form-control" id="structure-deductions">
                        </div>
                        <div class="form-group">
                            <label class="form-label">تفصیلات</label>
                            <textarea class="form-control" id="structure-details" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="save-salary-structure">تنخواہ سٹرکچر محفوظ
                            کریں</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table" id="salary-structure-table">
                        <thead>
                            <tr>
                                <th>نمبر</th>
                                <th>ملازم کا نام</th>
                                <th>عہدہ</th>
                                <th>بنیادی تنخواہ</th>
                                <th>الاؤنسز</th>
                                <th>کٹوتیاں</th>
                                <th>کل تنخواہ</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="salary-reports">
                <div class="form-container">
                    <div class="form-title">تنخواہ رپورٹس</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">رپورٹ کی قسم</label>
                            <select class="form-control" id="salary-report-type" required>
                                <option value="monthly" selected>ماہانہ</option>
                                <option value="yearly">سالانہ</option>
                                <option value="employee">ملازم کے مطابق</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ملازم کی قسم</label>
                            <select class="form-control" id="salary-report-employee-type">
                                <option value="all">تمام</option>
                                <option value="teacher">اساتذہ</option>
                                <option value="staff">عملہ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="salary-report-month-row">
                        <div class="form-group">
                            <label class="form-label">مہینہ</label>
                            <select class="form-control" id="salary-report-month">
                                <option value="1">جنوری</option>
                                <option value="2">فروری</option>
                                <option value="3">مارچ</option>
                                <option value="4">اپریل</option>
                                <option value="5">مئی</option>
                                <option value="6">جون</option>
                                <option value="7">جولائی</option>
                                <option value="8">اگست</option>
                                <option value="9">ستمبر</option>
                                <option value="10">اکتوبر</option>
                                <option value="11">نومبر</option>
                                <option value="12">دسمبر</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">سال</label>
                            <input type="number" class="form-control" id="salary-report-year">
                        </div>
                    </div>
                    <div class="form-row" id="salary-report-employee-row" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">ملازم</label>
                            <select class="form-control" id="salary-report-employee">
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-salary-report">رپورٹ بنائیں</button>
                    </div>
                </div>
                <div class="form-container" id="salary-report-summary" style="display: none;">
                    <div class="form-title">رپورٹ سمری</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">کل ادا کردہ تنخواہ</label>
                            <input type="text" class="form-control" id="salary-report-total-paid" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">کل ملازمین</label>
                            <input type="text" class="form-control" id="salary-report-total-employees" readonly>
                        </div>
                        <div class="form-group">
                            <label class="form-label">تنخواہ وصول کرنے والے ملازمین</label>
                            <input type="text" class="form-control" id="salary-report-paid-employees" readonly>
                        </div>
                    </div>
                </div>
                <div class="table-container" id="salary-report-table-container" style="display: none;">
                    <table class="table" id="salary-report-table">
                        <thead>
                            <tr>
                                <th>وؤچر نمبر</th>
                                <th>ملازم کا نام</th>
                                <th>عہدہ</th>
                                <th>مہینہ</th>
                                <th>تاریخ</th>
                                <th>بنیادی تنخواہ</th>
                                <th>الاؤنسز</th>
                                <th>کٹوتیاں</th>
                                <th>کل تنخواہ</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="print-salary-report">پرنٹ کریں</button>
                        <button type="button" class="btn btn-success" id="export-salary-report"
                            style="margin-right: 10px;">ایکسپورٹ کریں</button>
                        <select class="form-control" id="auto-backup-frequency" required>
                            <option value="daily">روزانہ</option>
                            <option value="weekly">ہفتہ وار</option>
                            <option value="monthly" selected>ماہانہ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">بیک اپ رکھنے کی مدت</label>
                        <select class="form-control" id="auto-backup-retention" required>
                            <option value="1">1 مہینہ</option>
                            <option value="3" selected>3 مہینے</option>
                            <option value="6">6 مہینے</option>
                            <option value="12">1 سال</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <button type="button" class="btn btn-primary" id="save-auto-backup">ترتیبات محفوظ کریں</button>
                </div>
            </div>
        </div>
        <div class="section-view" id="backup-view">
            <h2>بیک اپ اور بحالی</h2>
            <div class="form-container no-print">
                <div class="form-title">دستی بیک اپ</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">بیک اپ کی قسم</label>
                        <select class="form-control" id="backup-type">
                            <option value="full">مکمل بیک اپ</option>
                            <option value="students">صرف طلباء</option>
                            <option value="teachers">صرف اساتذہ</option>
                            <option value="staff">صرف عملہ</option>
                            <option value="fees">صرف فیس</option>
                            <option value="salaries">صرف تنخواہیں</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">بیک اپ فارمیٹ</label>
                        <select class="form-control" id="backup-format">
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-primary" id="create-backup">بیک اپ بنائیں</button>
                    </div>
                </div>
            </div>
            <div class="form-container no-print">
                <div class="form-title">ڈیٹا بحال کریں</div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">بیک اپ فائل منتخب کریں</label>
                        <input type="file" class="form-control" id="restore-file" accept=".json">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-danger" id="restore-backup">ڈیٹا بحال کریں</button>
                    </div>
                </div>
            </div>
            <div class="form-container no-print">
                <div class="form-title">آٹومیٹک بیک اپ ترتیبات</div>
                <div class="form-row">
                    <div class="form-group" style="flex: 0 0 auto; align-items: center; display: flex;">
                        <input type="checkbox" id="auto-backup-enable"
                            style="width: 20px; height: 20px; margin-left: 10px;">
                        <label class="form-label" for="auto-backup-enable" style="margin-bottom: 0;">آٹومیٹک بیک اپ فعال
                            کریں</label>
                    </div>
                </div>
                <div id="auto-backup-options" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">بیک اپ کی فریکوئنسی</label>
                            <select class="form-control" id="auto-backup-frequency" required>
                                <option value="daily">روزانہ</option>
                                <option value="weekly">ہفتہ وار</option>
                                <option value="monthly" selected>ماہانہ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">بیک اپ رکھنے کی مدت</label>
                            <select class="form-control" id="auto-backup-retention" required>
                                <option value="1">1 مہینہ</option>
                                <option value="3" selected>3 مہینے</option>
                                <option value="6">6 مہینے</option>
                                <option value="12">1 سال</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="save-auto-backup">ترتیبات محفوظ کریں</button>
                    </div>
                </div>
            </div>
            <div class="table-container">
                <div class="form-title">بیک اپ تاریخ</div>
                <table class="table" id="backup-history-table">
                    <thead>
                        <tr>
                            <th>نمبر</th>
                            <th>تاریخ</th>
                            <th>وقت</th>
                            <th>قسم</th>
                            <th>سائز</th>
                            <th>عمل</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="section-view" id="library-view">
            <h2>لائبریری</h2>
            <div class="tabs">
                <div class="tab active" data-tab="books-list">کتابوں کی فہرست</div>
                <div class="tab" data-tab="add-book">نئی کتاب</div>
                <div class="tab" data-tab="issue-book">کتاب جاری کریں</div>
                <div class="tab" data-tab="return-book">کتاب واپس</div>
            </div>
            <div class="tab-content active" id="books-list">
                <div class="table-container">
                    <table class="table" id="books-table">
                        <thead>
                            <tr>
                                <th>کتاب آئی ڈی</th>
                                <th>کتاب کا نام</th>
                                <th>مصنف</th>
                                <th>کیٹیگری</th>
                                <th>دستیاب</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-book">
                <div class="form-container">
                    <div class="form-title">نئی کتاب شامل کریں</div>
                    <form id="book-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">کتاب کا نام</label><input type="text"
                                    class="form-control" id="book-name" required></div>
                            <div class="form-group"><label class="form-label">مصنف</label><input type="text"
                                    class="form-control" id="book-author" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">کیٹیگری</label><input type="text"
                                    class="form-control" id="book-category" required></div>
                            <div class="form-group"><label class="form-label">ISBN</label><input type="text"
                                    class="form-control" id="book-isbn"></div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">کتاب شامل کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="issue-book">
                <div class="form-container">
                    <div class="form-title">کتاب جاری کریں</div>
                    <form id="issue-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">کتاب</label><select class="form-control"
                                    id="issue-book-select" required></select></div>
                            <div class="form-group"><label class="form-label">طالب علم</label><select
                                    class="form-control" id="issue-student-select" required></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">جاری کرنے کی تاریخ</label><input
                                    type="date" class="form-control" id="issue-date" required></div>
                            <div class="form-group"><label class="form-label">واپسی کی تاریخ</label><input type="date"
                                    class="form-control" id="return-due-date" required></div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">کتاب جاری کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="return-book">
                <div class="form-container">
                    <div class="form-title">کتاب واپس کریں</div>
                    <form id="return-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">جاری شدہ کتابیں</label><select
                                    class="form-control" id="return-book-select" required></select></div>
                            <div class="form-group"><label class="form-label">واپسی کی تاریخ</label><input type="date"
                                    class="form-control" id="actual-return-date" required></div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">کتاب واپس کریں</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="section-view" id="users-view">
            <h2>صارفین اور رولز</h2>
            <div class="tabs">
                <div class="tab active" data-tab="users-list">صارفین کی فہرست</div>
                <div class="tab" data-tab="add-user">نیا صارف</div>
                <div class="tab" data-tab="user-roles">صارفین کے رولز</div>
            </div>
            <div class="tab-content active" id="users-list">
                <div class="table-container">
                    <table class="table" id="users-table">
                        <thead>
                            <tr>
                                <th>صارف نام</th>
                                <th>نام</th>
                                <th>ای میل</th>
                                <th>رول</th>
                                <th>حیثیت</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="add-user">
                <div class="form-container">
                    <div class="form-title">نیا صارف بنائیں</div>
                    <form id="user-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">نام</label><input type="text"
                                    class="form-control" id="user-name" required></div>
                            <div class="form-group"><label class="form-label">صارف نام</label><input type="text"
                                    class="form-control" id="user-username" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">پاس ورڈ</label><input type="password"
                                    class="form-control" id="user-password" required></div>
                            <div class="form-group"><label class="form-label">پاس ورڈ کی تصدیق</label><input
                                    type="password" class="form-control" id="user-confirm-password" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">ای میل</label><input type="email"
                                    class="form-control" id="user-email" required></div>
                            <div class="form-group"><label class="form-label">موبائل</label><input type="tel"
                                    class="form-control" id="user-mobile"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">رول</label>
                                <select class="form-control" id="user-role" required>
                                    <option value="admin">ایڈمن</option>
                                    <option value="teacher">استاد</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">حیثیت</label>
                                <select class="form-control" id="user-status" required>
                                    <option value="active">فعال</option>
                                    <option value="inactive">غیر فعال</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row"><button type="submit" class="btn btn-primary">صارف بنائیں</button></div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="user-roles">
                <div class="form-container">
                    <div class="form-title">نیا رول بنائیں</div>
                    <form id="role-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">رول کا نام</label><input type="text"
                                    class="form-control" id="role-name" required></div>
                            <div class="form-group"><label class="form-label">تفصیل</label><input type="text"
                                    class="form-control" id="role-description"></div>
                        </div>
                        <div class="form-row"><button type="submit" class="btn btn-primary">رول بنائیں</button></div>
                    </form>
                </div>
                <div class="table-container">
                    <table class="table" id="roles-table">
                        <thead>
                            <tr>
                                <th>رول نام</th>
                                <th>تفصیل</th>
                                <th>عمل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="section-view" id="reports-view">
            <h2>رپورٹس</h2>
            <div class="tabs">
                <div class="tab active" data-tab="student-reports">طلباء کی رپورٹس</div>
                <div class="tab" data-tab="fee-reports-tab">فیس رپورٹس</div>
                <div class="tab" data-tab="attendance-reports-tab">حاضری رپورٹس</div>
            </div>
            <div class="tab-content active" id="student-reports">
                <div class="form-container">
                    <div class="form-title">طلباء کی رپورٹ</div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">کلاس</label><select class="form-control"
                                id="report-class"></select></div>
                        <div class="form-group"><label class="form-label">رپورٹ کی قسم</label><select
                                class="form-control" id="student-report-type">
                                <option value="all">تمام طلباء</option>
                                <option value="present">موجودہ طلباء</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-student-report">رپورٹ بنائیں</button>
                    </div>
                </div>
                <div class="table-container" id="student-report-container" style="display: none;">
                    <table class="table" id="student-report-table">
                        <thead>
                            <tr>
                                <th>رول نمبر</th>
                                <th>نام</th>
                                <th>والد کا نام</th>
                                <th>کلاس</th>
                                <th>رابطہ نمبر</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="fee-reports-tab">
                <div class="form-container">
                    <div class="form-title">فیس رپورٹ</div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">مہینہ</label><select class="form-control"
                                id="fee-report-month2">
                                <option value="1">جنوری</option>
                                <option value="2">فروری</option>
                            </select></div>
                        <div class="form-group"><label class="form-label">سال</label><input type="number"
                                class="form-control" id="fee-report-year2"></div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-fee-report2">فیس رپورٹ
                            بنائیں</button>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="attendance-reports-tab">
                <div class="form-container">
                    <div class="form-title">حاضری رپورٹ</div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">کلاس</label><select class="form-control"
                                id="attendance-report-class2"></select></div>
                        <div class="form-group"><label class="form-label">مہینہ</label><select class="form-control"
                                id="attendance-report-month2">
                                <option value="1">جنوری</option>
                            </select></div>
                    </div>
                    <div class="form-row">
                        <button type="button" class="btn btn-primary" id="generate-attendance-report2">حاضری رپورٹ
                            بنائیں</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="section-view" id="settings-view">
            <h2>ترتیبات</h2>
            <div class="tabs">
                <div class="tab active" data-tab="general-settings">عمومی ترتیبات</div>
                <div class="tab" data-tab="system-settings">سسٹم ترتیبات</div>
            </div>
            <div class="tab-content active" id="general-settings">
                <div class="form-container">
                    <div class="form-title">مدرسہ کی معلومات</div>
                    <form id="school-settings-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">مدرسہ کا نام</label><input type="text"
                                    class="form-control" id="school-name" required></div>
                            <div class="form-group"><label class="form-label">پرنسپل کا نام</label><input type="text"
                                    class="form-control" id="principal-name" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">پتہ</label><textarea class="form-control"
                                    id="school-address" rows="3" required></textarea></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">رابطہ نمبر</label><input type="tel"
                                    class="form-control" id="school-contact" required></div>
                            <div class="form-group"><label class="form-label">ای میل</label><input type="email"
                                    class="form-control" id="school-email"></div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">ترتیبات محفوظ کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="system-settings">
                <div class="form-container">
                    <div class="form-title">سسٹم کی ترتیبات</div>
                    <form id="system-settings-form">
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">ڈیٹابیس بیک اپ</label><select
                                    class="form-control" id="auto-backup-freq">
                                    <option value="daily">روزانہ</option>
                                    <option value="weekly">ہفتہ وار</option>
                                </select></div>
                            <div class="form-group"><label class="form-label">زبان</label><select class="form-control"
                                    id="system-language">
                                    <option value="ur">اردو</option>
                                    <option value="en">انگریزی</option>
                                </select></div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn btn-primary">ترتیبات محفوظ کریں</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        let db;
        const DB_NAME = 'DeeniMadrasaDB';
        const DB_VERSION = 1;
        const STORES = {
            STUDENTS: 'students',
            TEACHERS: 'teachers',
            STAFF: 'staff',
            CLASSES: 'classes',
            SECTIONS: 'sections',
            SUBJECTS: 'subjects',
            CLASS_SUBJECTS: 'classSubjects',
            ATTENDANCE: 'attendance',
            EXAMS: 'exams',
            MARKS: 'marks',
            FEES: 'fees',
            FEE_STRUCTURE: 'feeStructure',
            SALARY: 'salary',
            SALARY_STRUCTURE: 'salaryStructure',
            BOOKS: 'books',
            BOOK_ISSUES: 'bookIssues',
            USERS: 'users',
            ROLES: 'roles',
            SETTINGS: 'settings',
            EVENTS: 'events',
            ACTIVITIES: 'activities',
            BACKUP: 'backup'
        };
        document.addEventListener('DOMContentLoaded', function () {
            showLoading();
            openDatabase()
                .then(initializeApp)
                .catch(error => {
                    console.error('Database initialization error:', error);
                    showNotification('ڈیٹا بیس انشیلائزیشن میں خرابی ہوئی ہے', 'error');
                })
                .finally(() => {
                    hideLoading();
                });
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            const menuItems = document.querySelectorAll('.sidebar-menu li');
            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    const viewName = this.getAttribute('data-view');
                    showView(viewName);
                });
            });
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabGroup = this.parentElement;
                    const tabContentId = this.getAttribute('data-tab');
                    tabGroup.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tabGroup.parentElement.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(tabContentId).classList.add('active');
                });
            });
            /* document.getElementById('report-type').addEventListener('change', function () {
                const reportType = this.value;
                document.querySelectorAll('[id$="-report-filters"]').forEach(container => {
                    container.style.display = 'none';
                });
                document.getElementById(`${reportType}-report-filters`).style.display = 'flex';
            }); */
            document.getElementById('school-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
                const updated = {
                    ...existing,
                    schoolName: document.getElementById('school-name').value,
                    principalName: document.getElementById('principal-name').value,
                    schoolAddress: document.getElementById('school-address').value,
                    schoolPhone: document.getElementById('school-contact').value,
                    schoolEmail: document.getElementById('school-email').value,
                };
                await addToStore(STORES.SETTINGS, updated, true);
                showNotification('ترتیبات کامیابی سے محفوظ کر لی گئیں', 'success');
            });
            document.getElementById('system-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
                const updated = {
                    ...existing,
                    autoBackupFrequency: document.getElementById('auto-backup-freq').value,
                    language: document.getElementById('system-language').value,
                };
                await addToStore(STORES.SETTINGS, updated, true);
                showNotification('سسٹم ترتیبات کامیابی سے محفوظ کر لی گئیں', 'success');
            });
            document.getElementById('auto-backup-enable').addEventListener('change', function () {
                document.getElementById('auto-backup-options').style.display = this.checked ? 'block' : 'none';
            });
            const salaryInputs = document.querySelectorAll('#salary-payment-basic, #salary-payment-allowances, #salary-payment-bonus, #salary-payment-deductions, #salary-payment-absence, #salary-payment-tax');
            salaryInputs.forEach(input => {
                input.addEventListener('input', calculateSalaryTotal);
            });
            const feeInputs = document.querySelectorAll('#fee-amount, #fee-fine, #fee-discount');
            feeInputs.forEach(input => {
                input.addEventListener('input', calculateFeeTotal);
            });
            setupFormHandlers();
            setCurrentDateDefaults();
        });
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = event => {
                    reject('Database error: ' + event.target.errorCode);
                };
                request.onsuccess = event => {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORES.STUDENTS)) {
                        const studentStore = db.createObjectStore(STORES.STUDENTS, { keyPath: 'id', autoIncrement: true });
                        studentStore.createIndex('rollNumber', 'rollNumber', { unique: true });
                        studentStore.createIndex('name', 'name', { unique: false });
                        studentStore.createIndex('classId', 'classId', { unique: false });
                        studentStore.createIndex('sectionId', 'sectionId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.TEACHERS)) {
                        const teacherStore = db.createObjectStore(STORES.TEACHERS, { keyPath: 'id', autoIncrement: true });
                        teacherStore.createIndex('employeeId', 'employeeId', { unique: true });
                        teacherStore.createIndex('name', 'name', { unique: false });
                        teacherStore.createIndex('subjects', 'subjects', { unique: false, multiEntry: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.STAFF)) {
                        const staffStore = db.createObjectStore(STORES.STAFF, { keyPath: 'id', autoIncrement: true });
                        staffStore.createIndex('employeeId', 'employeeId', { unique: true });
                        staffStore.createIndex('name', 'name', { unique: false });
                        staffStore.createIndex('department', 'department', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.CLASSES)) {
                        const classStore = db.createObjectStore(STORES.CLASSES, { keyPath: 'id', autoIncrement: true });
                        classStore.createIndex('name', 'name', { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SECTIONS)) {
                        const sectionStore = db.createObjectStore(STORES.SECTIONS, { keyPath: 'id', autoIncrement: true });
                        sectionStore.createIndex('classId', 'classId', { unique: false });
                        sectionStore.createIndex('name', 'name', { unique: false });
                        sectionStore.createIndex('classSection', ['classId', 'name'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SUBJECTS)) {
                        const subjectStore = db.createObjectStore(STORES.SUBJECTS, { keyPath: 'id', autoIncrement: true });
                        subjectStore.createIndex('name', 'name', { unique: true });
                        subjectStore.createIndex('code', 'code', { unique: true });
                        subjectStore.createIndex('type', 'type', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.CLASS_SUBJECTS)) {
                        const classSubjectStore = db.createObjectStore(STORES.CLASS_SUBJECTS, { keyPath: 'id', autoIncrement: true });
                        classSubjectStore.createIndex('classId', 'classId', { unique: false });
                        classSubjectStore.createIndex('subjectId', 'subjectId', { unique: false });
                        classSubjectStore.createIndex('teacherId', 'teacherId', { unique: false });
                        classSubjectStore.createIndex('classSubject', ['classId', 'subjectId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.ATTENDANCE)) {
                        const attendanceStore = db.createObjectStore(STORES.ATTENDANCE, { keyPath: 'id', autoIncrement: true });
                        attendanceStore.createIndex('date', 'date', { unique: false });
                        attendanceStore.createIndex('classId', 'classId', { unique: false });
                        attendanceStore.createIndex('sectionId', 'sectionId', { unique: false });
                        attendanceStore.createIndex('studentId', 'studentId', { unique: false });
                        attendanceStore.createIndex('dateClassSection', ['date', 'classId', 'sectionId'], { unique: false });
                        attendanceStore.createIndex('dateStudent', ['date', 'studentId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.EXAMS)) {
                        const examStore = db.createObjectStore(STORES.EXAMS, { keyPath: 'id', autoIncrement: true });
                        examStore.createIndex('name', 'name', { unique: false });
                        examStore.createIndex('startDate', 'startDate', { unique: false });
                        examStore.createIndex('endDate', 'endDate', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.MARKS)) {
                        const marksStore = db.createObjectStore(STORES.MARKS, { keyPath: 'id', autoIncrement: true });
                        marksStore.createIndex('examId', 'examId', { unique: false });
                        marksStore.createIndex('studentId', 'studentId', { unique: false });
                        marksStore.createIndex('subjectId', 'subjectId', { unique: false });
                        marksStore.createIndex('examStudentSubject', ['examId', 'studentId', 'subjectId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.FEES)) {
                        const feesStore = db.createObjectStore(STORES.FEES, { keyPath: 'id', autoIncrement: true });
                        feesStore.createIndex('studentId', 'studentId', { unique: false });
                        feesStore.createIndex('date', 'date', { unique: false });
                        feesStore.createIndex('month', 'month', { unique: false });
                        feesStore.createIndex('year', 'year', { unique: false });
                        feesStore.createIndex('studentMonthYear', ['studentId', 'month', 'year'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.FEE_STRUCTURE)) {
                        const feeStructureStore = db.createObjectStore(STORES.FEE_STRUCTURE, { keyPath: 'id', autoIncrement: true });
                        feeStructureStore.createIndex('classId', 'classId', { unique: false });
                        feeStructureStore.createIndex('category', 'category', { unique: false });
                        feeStructureStore.createIndex('classCategory', ['classId', 'category'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SALARY)) {
                        const salaryStore = db.createObjectStore(STORES.SALARY, { keyPath: 'id', autoIncrement: true });
                        salaryStore.createIndex('employeeId', 'employeeId', { unique: false });
                        salaryStore.createIndex('employeeType', 'employeeType', { unique: false });
                        salaryStore.createIndex('month', 'month', { unique: false });
                        salaryStore.createIndex('year', 'year', { unique: false });
                        salaryStore.createIndex('date', 'date', { unique: false });
                        salaryStore.createIndex('employeeMonthYear', ['employeeId', 'month', 'year'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SALARY_STRUCTURE)) {
                        const salaryStructureStore = db.createObjectStore(STORES.SALARY_STRUCTURE, { keyPath: 'id', autoIncrement: true });
                        salaryStructureStore.createIndex('employeeId', 'employeeId', { unique: false });
                        salaryStructureStore.createIndex('employeeType', 'employeeType', { unique: false });
                        salaryStructureStore.createIndex('employeeTypeId', ['employeeType', 'employeeId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.BOOKS)) {
                        const booksStore = db.createObjectStore(STORES.BOOKS, { keyPath: 'id', autoIncrement: true });
                        booksStore.createIndex('name', 'name', { unique: false });
                        booksStore.createIndex('author', 'author', { unique: false });
                        booksStore.createIndex('category', 'category', { unique: false });
                        booksStore.createIndex('isbn', 'isbn', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.BOOK_ISSUES)) {
                        const bookIssuesStore = db.createObjectStore(STORES.BOOK_ISSUES, { keyPath: 'id', autoIncrement: true });
                        bookIssuesStore.createIndex('bookId', 'bookId', { unique: false });
                        bookIssuesStore.createIndex('memberId', 'memberId', { unique: false });
                        bookIssuesStore.createIndex('memberType', 'memberType', { unique: false });
                        bookIssuesStore.createIndex('issueDate', 'issueDate', { unique: false });
                        bookIssuesStore.createIndex('returnDate', 'returnDate', { unique: false });
                        bookIssuesStore.createIndex('status', 'status', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.USERS)) {
                        const usersStore = db.createObjectStore(STORES.USERS, { keyPath: 'id', autoIncrement: true });
                        usersStore.createIndex('username', 'username', { unique: true });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('role', 'role', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.ROLES)) {
                        const rolesStore = db.createObjectStore(STORES.ROLES, { keyPath: 'id', autoIncrement: true });
                        rolesStore.createIndex('name', 'name', { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SETTINGS)) {
                        const settingsStore = db.createObjectStore(STORES.SETTINGS, { keyPath: 'id', autoIncrement: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.EVENTS)) {
                        const eventsStore = db.createObjectStore(STORES.EVENTS, { keyPath: 'id', autoIncrement: true });
                        eventsStore.createIndex('date', 'date', { unique: false });
                        eventsStore.createIndex('type', 'type', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.ACTIVITIES)) {
                        const activitiesStore = db.createObjectStore(STORES.ACTIVITIES, { keyPath: 'id', autoIncrement: true });
                        activitiesStore.createIndex('date', 'date', { unique: false });
                        activitiesStore.createIndex('type', 'type', { unique: false });
                        activitiesStore.createIndex('userId', 'userId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.BACKUP)) {
                        const backupStore = db.createObjectStore(STORES.BACKUP, { keyPath: 'id', autoIncrement: true });
                        backupStore.createIndex('date', 'date', { unique: false });
                        backupStore.createIndex('type', 'type', { unique: false });
                    }
                    console.log('Database setup completed');
                };
            });
        }
        async function initializeApp() {
            console.log('Initializing application...');
            await loadSettings();
            await loadDashboardData();
            await loadDropdownData();
            //await checkAndLoadSampleData();
            setupEventListeners();
            console.log('[FIX] Directly attaching event listeners for attendance dropdowns...');
            try {
                document.getElementById('attendance-class').addEventListener('change', () => populateAttendanceSections('attendance-class', 'attendance-section'));
                document.getElementById('view-attendance-class').addEventListener('change', () => populateAttendanceSections('view-attendance-class', 'view-attendance-section'));
                document.getElementById('report-attendance-class').addEventListener('change', () => populateAttendanceSections('report-attendance-class', 'report-attendance-section'));
                console.log('[FIX] Attendance dropdown listeners attached successfully.');
            } catch (e) {
                console.error('[FIX] FAILED TO ATTACH ATTENDANCE LISTENERS:', e);
            }
            showView('dashboard');
            console.log('Application initialized successfully');
        }
        function renderBarChart(canvasId, chartTitle, labels, dataValues) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn("Canvas not found for chart:", canvasId);
                return;
            }
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js library is not loaded. Skipping chart rendering.");
                const placeholder = document.getElementById(canvasId);
                if (placeholder) placeholder.innerHTML = '<p style="text-align:center; color: #777;"><em>Chart.js library not loaded.</em></p>';
                return;
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: dataValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        function renderPieChart(canvasId, chartTitle, labels, dataValues) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn("Canvas not found for chart:", canvasId);
                return;
            }
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js library is not loaded. Skipping chart rendering.");
                const placeholder = document.getElementById(canvasId);
                if (placeholder) placeholder.innerHTML = '<p style="text-align:center; color: #777;"><em>Chart.js library not loaded.</em></p>';
                return;
            }
            const backgroundColors = dataValues.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`);
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: chartTitle
                        }
                    }
                }
            });
        }
        async function showView(viewName) {
            document.querySelectorAll('.section-view').forEach(view => {
                view.style.display = 'none';
            });
            const selectedView = document.getElementById(viewName + '-view');
            if (selectedView) {
                selectedView.style.display = 'block';
            } else {
                console.error(`View not found for: ${viewName}`);
                return;
            }
            const filterContainerIds = [
                'js-student-filters-container',
                'js-teacher-filters-container',
                'js-staff-filters-container'
            ];
            filterContainerIds.forEach(id => {
                const container = document.getElementById(id);
                let parentListOfContainer = null;
                if (container && container.parentElement) {
                    parentListOfContainer = container.parentElement.id;
                }
                if (container) {
                    let shouldRemove = true;
                    if (viewName === 'students' && parentListOfContainer === 'students-list' && id === 'js-student-filters-container') {
                        shouldRemove = false;
                    } else if (viewName === 'teachers' && parentListOfContainer === 'teachers-list' && id === 'js-teacher-filters-container') {
                        shouldRemove = false;
                    } else if (viewName === 'staff' && parentListOfContainer === 'staff-list' && id === 'js-staff-filters-container') {
                        shouldRemove = false;
                    }
                    if (shouldRemove) {
                        container.remove();
                    }
                }
            });
            if (viewName !== 'reports') {
                const reportOutputArea = document.getElementById('js-report-output-area');
                if (reportOutputArea) reportOutputArea.innerHTML = '';
                if (currentReportChart) {
                    currentReportChart.destroy();
                    currentReportChart = null;
                }
            }
            try {
                switch (viewName) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'students':
                        loadStudentsTable();
                        createCollapsibleFilterUI(
                            'students-list',
                            'js-student-filters-container',
                            'طلباء کے فلٹرز',
                            createStudentFilterRows,
                            populateStudentFilterDropdownsJS,
                            applyStudentFiltersJS,
                            resetStudentFiltersJS,
                            [{ dropdownId: 'js-filter-student-class', handlerFn: populateStudentFilterSectionsJS }]
                        );
                        break;
                    case 'teachers':
                        loadTeachersTable();
                        createCollapsibleFilterUI(
                            'teachers-list',
                            'js-teacher-filters-container',
                            'اساتذہ کے فلٹرز',
                            createTeacherFilterRows,
                            populateTeacherFilterDropdownsJS,
                            applyTeacherFiltersJS,
                            resetTeacherFiltersJS
                        );
                        break;
                    case 'staff':
                        loadStaffTable();
                        createCollapsibleFilterUI(
                            'staff-list',
                            'js-staff-filters-container',
                            'عملہ کے فلٹرز',
                            createStaffFilterRows,
                            null,
                            applyStaffFiltersJS,
                            resetStaffFiltersJS
                        );
                        break;
                    case 'classes':
                        loadClassesTable();
                        break;
                    case 'subjects':
                        loadSubjectsTable();
                        break;
                    case 'attendance':
                        loadClassDropdowns();
                        populateAttendanceSections('attendance-class', 'attendance-section');
                        break;
                    case 'exams':
                        loadExamsTable();
                        loadClassDropdowns();
                        loadSubjectDropdowns();
                        loadExamDropdowns();
                        break;
                    case 'fees':
                        loadFeeStructureTable();
                        loadClassDropdowns();
                        break;
                    case 'salaries':
                        loadSalaryStructureTable();
                        loadEmployeesForSalaryStructure();
                        break;
                    case 'library':
                        loadBooksTable();
                        populateLibraryDropdowns();
                        break;
                    case 'users':
                        loadUsersTable();
                        loadRolesTable();
                        break;
                    case 'reports':
                        initializeReportsViewJS();
                        break;
                    case 'settings':
                        loadSchoolSettings();
                        break;
                    case 'backup':
                        loadBackupHistoryTable();
                        break;
                    default:
                        console.warn(`No specific load actions defined for view: ${viewName}`);
                }
            } catch (e) {
                console.error(`Error in showView during content loading for '${viewName}':`, e);
                showNotification(`'${viewName}' منظر لوڈ کرنے میں خرابی ہوئی۔`, 'error');
            }
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar && sidebar.classList.contains('active')) {
                    toggleSidebar();
                }
            }
        }
        async function loadExamDropdowns() {
            try {
                const exams = getAllFromStore(STORES.EXAMS);
                const examDropdowns = document.querySelectorAll('select[id$="-exam"], select[id^="marks-exam"], select[id^="result-exam"]');
                examDropdowns.forEach(dropdown => {
                    const currentVal = dropdown.value;
                    const fixedOptions = Array.from(dropdown.options).filter(opt => opt.value === "" || opt.dataset.fixed);
                    dropdown.innerHTML = '';
                    fixedOptions.forEach(opt => dropdown.appendChild(opt.cloneNode(true)));
                    exams.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                    exams.forEach(exam => {
                        const option = document.createElement('option');
                        option.value = exam.id;
                        option.textContent = `${exam.name} (${formatDate(exam.startDate)})`;
                        dropdown.appendChild(option);
                    });
                    if (Array.from(dropdown.options).some(opt => opt.value === currentVal)) {
                        dropdown.value = currentVal;
                    }
                });
            } catch (error) {
                console.error('Error loading exam dropdowns:', error);
            }
        }
        async function addStudent() {
            showLoading();
            const form = document.getElementById('student-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const studentName = document.getElementById('student-name').value;
                const fatherName = document.getElementById('student-father').value;
                const studentClass = document.getElementById('student-class').value;
                const studentAdmissionDate = document.getElementById('student-admission-date').value;
                if (!studentName || !fatherName || !studentClass || !studentAdmissionDate) {
                    showNotification('براہ کرم تمام ضروری فیلڈز کو پُر کریں۔ (*)', 'error');
                    hideLoading();
                    return;
                }
                const studentData = {
                    name: studentName,
                    fatherName: fatherName,
                    dob: document.getElementById('student-dob').value,
                    gender: document.getElementById('student-gender').value,
                    classId: parseInt(studentClass),
                    sectionId: parseInt(document.getElementById('student-section').value),
                    contact: document.getElementById('student-contact').value,
                    email: document.getElementById('student-email').value,
                    guardian: document.getElementById('student-guardian').value,
                    guardianContact: document.getElementById('student-guardian-contact').value,
                    address: document.getElementById('student-address').value,
                    admissionDate: studentAdmissionDate,
                    feeCategory: document.getElementById('student-fee-category').value,
                    monthlyFee: parseFloat(document.getElementById('student-monthly-fee').value),
                    notes: document.getElementById('student-notes').value,
                    createdAt: new Date().toISOString()
                };
                if (studentData.classId) {
                    const classInfo = await getFromStore(STORES.CLASSES, studentData.classId);
                    studentData.className = classInfo ? classInfo.name : 'N/A';
                }
                if (studentData.sectionId) {
                    const sectionInfo = await getFromStore(STORES.SECTIONS, studentData.sectionId);
                    studentData.sectionName = sectionInfo ? sectionInfo.name : 'N/A';
                }
                if (editId) {
                    studentData.updatedAt = new Date().toISOString();
                    await updateInStore(STORES.STUDENTS, editId, studentData);
                    showNotification('طالب علم کا ریکارڈ کامیابی سے اپڈیٹ کر دیا گیا۔', 'success');
                } else {
                    const studentsCount = await getCount(STORES.STUDENTS);
                    studentData.rollNumber = String(studentsCount + 1).padStart(4, '0');
                    await addToStore(STORES.STUDENTS, studentData);
                    showNotification('طالب علم کامیابی سے داخل کر لیا گیا ہے۔', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) submitButton.textContent = 'طالب علم داخل کریں';
                const studentListTab = document.querySelector('.tab[data-tab="students-list"]');
                if (studentListTab && !studentListTab.classList.contains('active')) {
                    studentListTab.click();
                }
                await loadStudentsTable();
            } catch (error) {
                console.error('Error saving student:', error);
                showNotification('طالب علم کو محفوظ کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function handlePhotoUpload(inputId) {
            const photoInput = document.getElementById(inputId);
            if (photoInput && photoInput.files && photoInput.files[0]) {
                return await fileToBase64(photoInput.files[0]);
            }
            return null;
        }
        function setupEventListeners() {
            // Sidebar menu navigation
            document.querySelector('[data-tab="students-list"]').addEventListener('click', () => loadStudentsTable());
            document.querySelector('[data-tab="teachers-list"]').addEventListener('click', () => loadTeachersTable());
            document.querySelector('[data-tab="staff-list"]').addEventListener('click', () => loadStaffTable());
            document.querySelector('[data-tab="classes-list"]').addEventListener('click', () => loadClassesTable());
            document.querySelector('[data-tab="sections"]').addEventListener('click', () => loadSectionsTable());
            document.querySelector('[data-tab="subjects-list"]').addEventListener('click', () => loadSubjectsTable());
            document.querySelector('[data-tab="class-subjects"]').addEventListener('click', () => loadClassSubjectsTable());
            document.querySelector('[data-tab="exams-list"]').addEventListener('click', () => loadExamsTable());
            document.querySelector('[data-tab="user-roles"]').addEventListener('click', () => loadRolesTable());
            document.querySelector('[data-tab="fee-structure"]').addEventListener('click', () => loadFeeStructureTable());
            document.querySelector('[data-tab="salary-structure"]').addEventListener('click', () => loadSalaryStructureTable());
            document.querySelector('[data-view="library"]').addEventListener('click', () => loadBooksTable());
            document.querySelector('[data-view="users"]').addEventListener('click', () => loadUsersTable());
            document.querySelector('[data-view="backup"]').addEventListener('click', () => loadBackupHistoryTable());
            // Search buttons
            document.getElementById('search-student-btn').addEventListener('click', searchStudents);
            document.getElementById('search-teacher-btn').addEventListener('click', searchTeachers);
            document.getElementById('search-staff-btn').addEventListener('click', searchStaff);
            document.getElementById('search-student-fee').addEventListener('click', searchStudentForFee);
            document.getElementById('search-employee-salary').addEventListener('click', searchEmployeeForSalary);
            // Data loading and report generation buttons
            document.getElementById('load-attendance').addEventListener('click', loadStudentsForAttendance);
            document.getElementById('view-attendance-btn').addEventListener('click', viewAttendance);
            document.getElementById('generate-attendance-report').addEventListener('click', generateAttendanceReport);
            document.getElementById('load-students-marks').addEventListener('click', loadStudentsForMarks);
            document.getElementById('generate-result-cards').addEventListener('click', generateResultCards);
            document.getElementById('generate-fee-report').addEventListener('click', generateFeeReport);
            document.getElementById('generate-defaulters').addEventListener('click', generateDefaultersReport);
            document.getElementById('generate-salary-report').addEventListener('click', generateSalaryReport);
            // Backup and Restore
            document.getElementById('create-backup').addEventListener('click', createBackup);
            document.getElementById('restore-backup').addEventListener('click', restoreBackup);
            document.getElementById('save-auto-backup').addEventListener('click', saveAutoBackupSettings);
            document.getElementById('auto-backup-enable').addEventListener('change', function () {
                document.getElementById('auto-backup-options').style.display = this.checked ? 'block' : 'none';
            });
            // Dropdown change listeners
            document.getElementById('student-class').addEventListener('change', populateSectionsForStudentForm);
            document.getElementById('attendance-class').addEventListener('change', () => populateAttendanceSections('attendance-class', 'attendance-section'));
            document.getElementById('view-attendance-class').addEventListener('change', () => populateAttendanceSections('view-attendance-class', 'view-attendance-section'));
            document.getElementById('report-attendance-class').addEventListener('change', () => populateAttendanceSections('report-attendance-class', 'report-attendance-section'));
            document.getElementById('fee-report-type').addEventListener('change', toggleFeeReportFields);
            document.getElementById('salary-report-type').addEventListener('change', toggleSalaryReportFields);
            document.getElementById('structure-employee-type').addEventListener('change', loadEmployeesForSalaryStructure);
        }
        async function loadStaffTable() {
            try {
                const staffList = await getAllFromStore(STORES.STAFF);
                const tbody = document.querySelector('#staff-table tbody');
                tbody.innerHTML = '';
                if (!staffList || staffList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی عملہ موجود نہیں ہے۔</td></tr>';
                    return;
                }
                staffList.forEach(staff => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${staff.employeeId}</td>
                <td>${staff.name}</td>
                <td>${staff.designation}</td>
                <td>${staff.department}</td>
                <td>${staff.contact}</td>
                <td>${formatDate(staff.joiningDate)}</td>
                <td>${staff.basicSalary ? formatCurrency(staff.basicSalary) : 'N/A'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editStaff(${staff.id})">ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.STAFF}', ${staff.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading staff table:', error);
            }
        }
        async function editStaff(id) {
            showLoading();
            try {
                const staff = await getFromStore(STORES.STAFF, id);
                if (!staff) { return; }
                const form = document.getElementById('staff-form');
                form.dataset.editId = id;
                document.getElementById('staff-name').value = staff.name;
                document.getElementById('staff-father').value = staff.fatherName;
                document.getElementById('staff-dob').value = staff.dob;
                document.getElementById('staff-gender').value = staff.gender;
                document.getElementById('staff-designation').value = staff.designation;
                document.getElementById('staff-department').value = staff.department;
                document.getElementById('staff-qualification').value = staff.qualification;
                document.getElementById('staff-responsibilities').value = staff.responsibilities;
                document.getElementById('staff-contact').value = staff.contact;
                document.getElementById('staff-email').value = staff.email;
                document.getElementById('staff-address').value = staff.address;
                document.getElementById('staff-cnic').value = staff.cnic;
                document.getElementById('staff-joining-date').value = staff.joiningDate;
                document.getElementById('staff-basic-salary').value = staff.basicSalary;
                document.getElementById('staff-allowances').value = staff.allowances;
                document.getElementById('staff-deductions').value = staff.deductions;
                document.getElementById('staff-notes').value = staff.notes;
                document.querySelector('.tab[data-tab="add-staff"]').click();
                form.querySelector('button[type="submit"]').textContent = 'ریکارڈ اپڈیٹ کریں';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadClassesTable() {
            try {
                const classes = await getAllFromStore(STORES.CLASSES);
                const tbody = document.querySelector('#classes-table tbody');
                tbody.innerHTML = '';
                if (!classes || classes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">کوئی کلاس موجود نہیں ہے۔</td></tr>';
                    return;
                }
                for (const cls of classes) {
                    const row = document.createElement('tr');
                    const teacher = cls.inChargeId ? await getFromStore(STORES.TEACHERS, cls.inChargeId) : null;
                    const studentsCount = (await getAllFromIndex(STORES.STUDENTS, 'classId', cls.id)).length;
                    const sections = (await getAllFromIndex(STORES.SECTIONS, 'classId', cls.id)).map(s => s.name).join(', ');
                    row.innerHTML = `
                <td>${cls.id}</td>
                <td>${cls.name}</td>
                <td>${teacher ? teacher.name : 'N/A'}</td>
                <td>${sections || '-'}</td>
                <td>${studentsCount}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editClass(${cls.id})">ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.CLASSES}', ${cls.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) { console.error('Error loading classes table:', error); }
        }
        async function editClass(id) {
            showLoading();
            try {
                const cls = await getFromStore(STORES.CLASSES, id);
                if (!cls) { return; }
                const form = document.getElementById('class-form');
                form.dataset.editId = id;
                document.getElementById('class-name').value = cls.name;
                document.getElementById('class-incharge').value = cls.inChargeId;
                document.getElementById('class-level').value = cls.level;
                document.getElementById('class-room').value = cls.roomNumber;
                document.getElementById('class-fee-category').value = cls.feeCategory;
                document.getElementById('class-monthly-fee').value = cls.monthlyFee;
                document.getElementById('class-admission-fee').value = cls.admissionFee;
                document.getElementById('class-notes').value = cls.notes;
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', id);
                const sectionNames = sections.map(s => s.name);
                Array.from(document.getElementById('class-sections').options).forEach(opt => {
                    opt.selected = sectionNames.includes(opt.value);
                });
                document.querySelector('.tab[data-tab="add-class"]').click();
                form.querySelector('button[type="submit"]').textContent = 'ریکارڈ اپڈیٹ کریں';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadSectionsTable() {
            try {
                const sections = await getAllFromStore(STORES.SECTIONS);
                const tbody = document.querySelector('#sections-table tbody');
                tbody.innerHTML = '';
                if (!sections || sections.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">کوئی سیکشن موجود نہیں ہے۔</td></tr>';
                    return;
                }
                for (const section of sections) {
                    const row = document.createElement('tr');
                    const classData = await getFromStore(STORES.CLASSES, section.classId);
                    const teacher = section.inChargeId ? await getFromStore(STORES.TEACHERS, section.inChargeId) : null;
                    const studentsCount = (await getAllFromIndex(STORES.STUDENTS, 'sectionId', section.id)).length;
                    row.innerHTML = `
                        <td>${section.id}</td>
                        <td>${classData ? classData.name : 'N/A'}</td>
                        <td>${section.name}</td>
                        <td>${teacher ? teacher.name : 'N/A'}</td>
                        <td>${studentsCount}</td>
                        <td class="no-print">
                            <button class="btn btn-primary btn-sm">ترمیم</button>
                            <button class="btn btn-danger btn-sm">حذف کریں</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading sections table:', error);
            }
        }
        async function loadSubjectsTable() {
            try {
                const subjects = await getAllFromStore(STORES.SUBJECTS);
                const tbody = document.querySelector('#subjects-table tbody');
                tbody.innerHTML = '';
                if (!subjects || subjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">کوئی مضمون موجود نہیں ہے۔</td></tr>';
                    return;
                }
                subjects.forEach(subject => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${subject.id}</td>
                <td>${subject.name}</td>
                <td>${subject.code}</td>
                <td>${subject.type}</td>
                <td>${subject.details || '-'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editSubject(${subject.id})">ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.SUBJECTS}', ${subject.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                });
            } catch (error) { console.error('Error loading subjects table:', error); }
        }
        async function editSubject(id) {
            showLoading();
            try {
                const subject = await getFromStore(STORES.SUBJECTS, id);
                if (!subject) { return; }
                const form = document.getElementById('subject-form');
                form.dataset.editId = id;
                document.getElementById('subject-name').value = subject.name;
                document.getElementById('subject-code').value = subject.code;
                document.getElementById('subject-type').value = subject.type;
                document.getElementById('subject-periods').value = subject.periods;
                document.getElementById('subject-details').value = subject.details;
                document.querySelector('.tab[data-tab="add-subject"]').click();
                form.querySelector('button[type="submit"]').textContent = 'ریکارڈ اپڈیٹ کریں';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadClassSubjectsTable() {
            const tbody = document.querySelector('#class-subjects-table tbody');
            tbody.innerHTML = '';
            showLoading();
            try {
                const classSubjects = await getAllFromStore(STORES.CLASS_SUBJECTS);
                if (classSubjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">کوئی کلاس مضمون تفویض نہیں کیا گیا ہے۔</td></tr>';
                    return;
                }
                for (const cs of classSubjects) {
                    const classData = await getFromStore(STORES.CLASSES, cs.classId);
                    const subjectData = await getFromStore(STORES.SUBJECTS, cs.subjectId);
                    const teacherData = await getFromStore(STORES.TEACHERS, cs.teacherId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${cs.id}</td>
                <td>${classData ? classData.name : 'N/A'}</td>
                <td>${subjectData ? subjectData.name : 'N/A'}</td>
                <td>${teacherData ? teacherData.name : 'N/A'}</td>
                <td><button class="btn btn-danger btn-sm">حذف کریں</button></td>
            `;
                    tbody.appendChild(row);
                }
            } catch (e) {
                console.error("Error loading class subjects:", e);
            } finally {
                hideLoading();
            }
        }
        async function loadExamsTable() {
            try {
                const exams = await getAllFromStore(STORES.EXAMS);
                const tbody = document.querySelector('#exams-table tbody');
                tbody.innerHTML = '';
                if (!exams || exams.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">کوئی امتحان موجود نہیں ہے۔</td></tr>';
                    return;
                }
                for (const exam of exams) {
                    const row = document.createElement('tr');
                    const classNames = exam.classes ? (await Promise.all(exam.classes.map(id => getFromStore(STORES.CLASSES, id)))).map(c => c ? c.name : '').join(', ') : 'N/A';
                    row.innerHTML = `
                <td>${exam.id}</td>
                <td>${exam.name}</td>
                <td>${formatDate(exam.startDate)}</td>
                <td>${formatDate(exam.endDate)}</td>
                <td>${classNames}</td>
                <td>${exam.status}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" disabled>ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.EXAMS}', ${exam.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading exams table:', error);
            }
        }
        async function deleteItem(storeName, id) {
            const refreshFunctions = {
                [STORES.STUDENTS]: loadStudentsTable,
                [STORES.TEACHERS]: loadTeachersTable,
                [STORES.STAFF]: loadStaffTable,
                [STORES.CLASSES]: loadClassesTable,
                [STORES.SUBJECTS]: loadSubjectsTable,
                [STORES.EXAMS]: loadExamsTable,
            };
            if (confirm('کیا آپ واقعی اس ریکارڈ کو حذف کرنا چاہتے ہیں؟ یہ عمل واپس نہیں کیا جا سکتا۔')) {
                showLoading();
                try {
                    await deleteFromStore(storeName, id);
                    showNotification('ریکارڈ کامیابی سے حذف کر دیا گیا۔', 'success');
                    if (refreshFunctions[storeName]) {
                        refreshFunctions[storeName]();
                    } else {
                        console.warn(`No refresh function is defined for the store: ${storeName}`);
                    }
                } catch (error) {
                    console.error(`Error deleting item from ${storeName}:`, error);
                    showNotification('ریکارڈ حذف کرنے میں خرابی ہوئی۔', 'error');
                } finally {
                    hideLoading();
                }
            }
        }
        async function editBook(id) {
            showLoading();
            try {
                const book = await getFromStore(STORES.BOOKS, id);
                if (!book) return;
                const form = document.getElementById('add-book-form');
                form.dataset.editId = id;
                document.getElementById('book-name').value = book.name;
                document.getElementById('book-author').value = book.author;
                document.getElementById('book-category').value = book.category;
                document.getElementById('book-isbn').value = book.isbn;
                document.getElementById('book-copies').value = book.copies;
                document.getElementById('book-shelf').value = book.shelf;
                document.querySelector('.tab[data-tab="add-book-tab"]').click();
                form.querySelector('button[type="submit"]').textContent = 'ریکارڈ اپڈیٹ کریں';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadFeeStructureTable() {
            const tbody = document.querySelector('#fee-structure-table tbody');
            tbody.innerHTML = '';
            const structures = await getAllFromStore(STORES.FEE_STRUCTURE);
            if (!structures || structures.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی فیس سٹرکچر موجود نہیں ہے۔</td></tr>';
                return;
            }
            for (const structure of structures) {
                const classData = await getFromStore(STORES.CLASSES, structure.classId);
                const total = (structure.monthlyFee || 0) + (structure.admissionFee || 0) + (structure.examFee || 0) + (structure.computerFee || 0) + (structure.transportFee || 0) + (structure.otherFee || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${structure.id}</td>
            <td>${classData ? classData.name : 'N/A'}</td>
            <td>${structure.category}</td>
            <td>${formatCurrency(structure.monthlyFee || 0)}</td>
            <td>${formatCurrency(structure.admissionFee || 0)}</td>
            <td>${formatCurrency(structure.examFee || 0)}</td>
            <td>${formatCurrency(total)}</td>
            <td class="no-print">
                <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.FEE_STRUCTURE}', ${structure.id})">حذف کریں</button>
            </td>
        `;
                tbody.appendChild(row);
            }
        }
        async function loadSalaryStructureTable() {
            const tbody = document.querySelector('#salary-structure-table tbody');
            tbody.innerHTML = '';
            const structures = await getAllFromStore(STORES.SALARY_STRUCTURE);
            if (!structures || structures.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی تنخواہ سٹرکچر موجود نہیں ہے۔</td></tr>';
                return;
            }
            for (const structure of structures) {
                const employeeStore = structure.employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                const employee = await getFromStore(employeeStore, structure.employeeId);
                const total = (structure.basicSalary || 0) + (structure.houseRent || 0) + (structure.transport || 0) + (structure.medical || 0) + (structure.otherAllowances || 0) - (structure.deductions || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${structure.id}</td>
            <td>${employee ? employee.name : 'N/A'}</td>
            <td>${employee ? (employee.designation || 'استاد') : 'N/A'}</td>
            <td>${formatCurrency(structure.basicSalary || 0)}</td>
            <td>${formatCurrency((structure.houseRent || 0) + (structure.transport || 0) + (structure.medical || 0) + (structure.otherAllowances || 0))}</td>
            <td>${formatCurrency(structure.deductions || 0)}</td>
            <td>${formatCurrency(total)}</td>
            <td class="no-print">
                 <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.SALARY_STRUCTURE}', ${structure.id})">حذف کریں</button>
            </td>
        `;
                tbody.appendChild(row);
            }
        }
        async function loadBackupHistoryTable() {
            const tbody = document.querySelector('#backup-history-table tbody');
            tbody.innerHTML = '';
            const history = await getAllFromStore(STORES.BACKUP);
            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">کوئی بیک اپ ہسٹری موجود نہیں ہے۔</td></tr>';
                return;
            }
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            history.forEach((backup, index) => {
                const row = document.createElement('tr');
                const backupDate = new Date(backup.date);
                row.innerHTML = `
            <td>${index + 1}</td>
            <td>${backupDate.toLocaleDateString('ur-PK')}</td>
            <td>${backupDate.toLocaleTimeString('ur-PK')}</td>
            <td>${backup.type}</td>
            <td>${(backup.size / 1024).toFixed(2)} KB</td>
            <td class="no-print">
                <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.BACKUP}', ${backup.id})">حذف کریں</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }
        async function searchStudents() {
            showLoading();
            try {
                const searchTerm = document.getElementById('student-search').value.toLowerCase();
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const filteredStudents = allStudents.filter(student => {
                    return student.name.toLowerCase().includes(searchTerm) ||
                        String(student.rollNumber).includes(searchTerm) ||
                        student.className.toLowerCase().includes(searchTerm);
                });
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = '';
                if (filteredStudents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی طالب علم نہیں ملا۔</td></tr>';
                    return;
                }
                filteredStudents.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.rollNumber}</td>
                        <td>${student.name}</td>
                        <td>${student.fatherName}</td>
                        <td>${student.className}</td>
                        <td>${student.sectionName}</td>
                        <td>${student.contact}</td>
                        <td>${formatDate(student.admissionDate)}</td>
                        <td></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("Error searching students:", error);
                showNotification('طلباء کو تلاش کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchTeachers() {
            showLoading();
            try {
                const searchTerm = document.getElementById('teacher-search').value.toLowerCase();
                const allTeachers = await getAllFromStore(STORES.TEACHERS);
                const filteredTeachers = allTeachers.filter(teacher => {
                    return teacher.name.toLowerCase().includes(searchTerm) ||
                        teacher.specialization.toLowerCase().includes(searchTerm) ||
                        teacher.qualification.toLowerCase().includes(searchTerm);
                });
                loadTeachersTable(filteredTeachers);
            } catch (error) {
                console.error("Error searching teachers:", error);
                showNotification('اساتذہ کو تلاش کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchStaff() {
            showLoading();
            try {
                const searchTerm = document.getElementById('staff-search').value.toLowerCase();
                const allStaff = await getAllFromStore(STORES.STAFF);
                const filteredStaff = allStaff.filter(staff => {
                    return staff.name.toLowerCase().includes(searchTerm) ||
                        staff.designation.toLowerCase().includes(searchTerm) ||
                        staff.department.toLowerCase().includes(searchTerm);
                });
                loadStaffTable(filteredStaff);
            } catch (error) {
                console.error("Error searching staff:", error);
                showNotification('عملے کو تلاش کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function viewAttendance() {
            const date = document.getElementById('view-attendance-date').value;
            const classId = parseInt(document.getElementById('view-attendance-class').value);
            const sectionId = parseInt(document.getElementById('view-attendance-section').value);
            const tbody = document.querySelector('#view-attendance-table tbody');
            const container = document.getElementById('view-attendance-table-container');
            if (!date || isNaN(classId) || isNaN(sectionId)) {
                showNotification('براہ کرم تاریخ، کلاس اور سیکشن منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            try {
                const records = await getAllFromIndex(STORES.ATTENDANCE, 'dateClassSection', [date, classId, sectionId]);
                if (records.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">اس تاریخ کے لیے حاضری کا کوئی ریکارڈ نہیں ملا۔</td></tr>`;
                } else {
                    for (const record of records) {
                        const student = await getFromStore(STORES.STUDENTS, record.studentId);
                        if (student) {
                            const row = document.createElement('tr');
                            let statusText = '-';
                            if (record.status === 'present') statusText = 'حاضر';
                            else if (record.status === 'absent') statusText = 'غیر حاضر';
                            row.innerHTML = `
                        <td>${student.rollNumber}</td>
                        <td>${student.name}</td>
                        <td>${statusText}</td>
                        <td>${record.isLate ? 'ہاں' : 'نہیں'}</td>
                        <td>${record.isLeave ? 'ہاں' : 'نہیں'}</td>
                        <td>${record.notes || '-'}</td>
                    `;
                            tbody.appendChild(row);
                        }
                    }
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error viewing attendance:", error);
                showNotification('حاضری دیکھنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateAttendanceReport() {
            const classId = parseInt(document.getElementById('report-attendance-class').value);
            const sectionId = document.getElementById('report-attendance-section').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const tbody = document.querySelector('#report-attendance-table tbody');
            const container = document.getElementById('report-attendance-table-container');
            if (isNaN(classId) || !sectionId || !startDate || !endDate) {
                showNotification('براہ کرم تمام فلٹرز منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            try {
                let students = await getAllFromIndex(STORES.STUDENTS, 'classId', classId);
                if (sectionId !== 'all') {
                    students = students.filter(s => s.sectionId === parseInt(sectionId));
                }
                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">اس کلاس/سیکشن میں کوئی طالب علم نہیں ہے۔</td></tr>';
                    container.style.display = 'block';
                    return;
                }
                const allAttendance = await getAllFromStore(STORES.ATTENDANCE);
                const dateFilteredAttendance = allAttendance.filter(rec => {
                    const recDate = new Date(rec.date);
                    return recDate >= new Date(startDate) && recDate <= new Date(endDate);
                });
                for (const student of students) {
                    const studentAttendance = dateFilteredAttendance.filter(rec => rec.studentId === student.id);
                    const totalDays = studentAttendance.length;
                    const present = studentAttendance.filter(r => r.status === 'present').length;
                    const absent = studentAttendance.filter(r => r.status === 'absent').length;
                    const leave = studentAttendance.filter(r => r.isLeave).length;
                    const late = studentAttendance.filter(r => r.isLate).length;
                    const percentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(2) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${student.rollNumber}</td>
                <td>${student.name}</td>
                <td>${totalDays}</td>
                <td>${present}</td>
                <td>${absent}</td>
                <td>${late}</td>
                <td>${leave}</td>
                <td>${percentage}%</td>
            `;
                    tbody.appendChild(row);
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating attendance report:", error);
                showNotification('حاضری رپورٹ بنانے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadStudentsForMarks() {
            const classId = parseInt(document.getElementById('marks-class').value);
            const sectionId = parseInt(document.getElementById('marks-section').value);
            if (!classId || !sectionId) {
                showNotification('براہ کرم کلاس اور سیکشن منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            try {
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const classStudents = allStudents.filter(s => s.classId === classId && s.sectionId === sectionId);
                const marksTbody = document.querySelector('#marks-table tbody');
                marksTbody.innerHTML = '';
                if (classStudents.length === 0) {
                    marksTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">اس کلاس میں کوئی طالب علم نہیں ہے۔</td></tr>';
                }
                classStudents.forEach(student => {
                    const row = document.createElement('tr');
                    row.dataset.studentId = student.id;
                    row.innerHTML = `
                        <td>${student.rollNumber}</td>
                        <td>${student.name}</td>
                        <td><input type="number" class="form-control" name="marks_${student.id}" min="0" max="100"></td>
                        <td>-</td>
                        <td>-</td>
                        <td><input type="text" class="form-control" name="notes_${student.id}"></td>
                    `;
                    marksTbody.appendChild(row);
                });
                document.getElementById('marks-table-container').style.display = 'block';
            } catch (error) {
                console.error("Error loading students for marks entry:", error);
            } finally {
                hideLoading();
            }
        }
        async function generateResultCards() {
            const examId = parseInt(document.getElementById('result-exam').value);
            const classId = parseInt(document.getElementById('result-class').value);
            const sectionId = parseInt(document.getElementById('result-section').value);
            const container = document.getElementById('result-cards-container');
            if (isNaN(examId) || isNaN(classId) || isNaN(sectionId)) {
                showNotification('براہ کرم امتحان، کلاس اور سیکشن منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            container.innerHTML = '';
            container.style.display = 'none';
            try {
                const students = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.classId === classId && s.sectionId === sectionId);
                const allMarks = (await getAllFromStore(STORES.MARKS)).filter(m => m.examId === examId);
                const exam = await getFromStore(STORES.EXAMS, examId);
                if (students.length === 0) {
                    container.innerHTML = `<div class="form-container"><p>اس کلاس/سیکشن میں کوئی طالب علم نہیں ہے۔</p></div>`;
                    container.style.display = 'block';
                    return;
                }
                for (const student of students) {
                    const studentMarks = allMarks.filter(m => m.studentId === student.id);
                    let totalObtained = 0;
                    let totalMarks = 0;
                    let resultStatus = 'کامیاب';
                    let marksTable = `
                <table class="table" style="font-size: 14px; margin-top: 10px;">
                    <thead><tr><th>مضمون</th><th>کل نمبر</th><th>حاصل کردہ</th><th>نتیجہ</th></tr></thead>
                    <tbody>
            `;
                    for (const mark of studentMarks) {
                        const subject = await getFromStore(STORES.SUBJECTS, mark.subjectId);
                        totalObtained += mark.obtainedMarks;
                        totalMarks += mark.totalMarks;
                        if (!mark.isPassed) resultStatus = 'ناکام';
                        marksTable += `
                    <tr>
                        <td>${subject ? subject.name : 'N/A'}</td>
                        <td>${mark.totalMarks}</td>
                        <td>${mark.obtainedMarks}</td>
                        <td>${mark.isPassed ? 'کامیاب' : 'ناکام'}</td>
                    </tr>
                `;
                    }
                    marksTable += `</tbody></table>`;
                    const percentage = totalMarks > 0 ? ((totalObtained / totalMarks) * 100).toFixed(2) : 0;
                    const cardHTML = `
                <div class="card" style="margin-bottom: 20px; page-break-inside: avoid;">
                    <h4 class="card-title" style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">${exam.name} - رزلٹ کارڈ</h4>
                    <div style="display: flex; justify-content: space-between;">
                        <p><strong>نام:</strong> ${student.name}</p>
                        <p><strong>رول نمبر:</strong> ${student.rollNumber}</p>
                    </div>
                     <div style="display: flex; justify-content: space-between;">
                        <p><strong>والد کا نام:</strong> ${student.fatherName}</p>
                        <p><strong>کلاس:</strong> ${student.className} (${student.sectionName})</p>
                    </div>
                    ${marksTable}
                    <div style="display: flex; justify-content: space-around; background-color: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 15px;">
                        <p><strong>کل حاصل کردہ:</strong> ${totalObtained} / ${totalMarks}</p>
                        <p><strong>فیصد:</strong> ${percentage}%</p>
                        <p><strong>نتیجہ:</strong> ${resultStatus}</p>
                    </div>
                </div>
            `;
                    container.innerHTML += cardHTML;
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating result cards:", error);
                showNotification('رزلٹ کارڈ بنانے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchStudentForFee() {
            const searchTerm = document.getElementById('fee-student-search').value;
            if (!searchTerm) return;
            showLoading();
            try {
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const student = allStudents.find(s => String(s.rollNumber) === searchTerm || s.name.toLowerCase().includes(searchTerm.toLowerCase()));
                if (!student) {
                    showNotification('طالب علم نہیں ملا۔', 'error');
                    document.getElementById('fee-student-details').style.display = 'none';
                    document.getElementById('fee-payment-form').style.display = 'none';
                    return;
                }
                document.getElementById('fee-roll-number').value = student.rollNumber;
                document.getElementById('fee-roll-number').dataset.studentId = student.id;
                document.getElementById('fee-student-name').value = student.name;
                document.getElementById('fee-class').value = student.className;
                document.getElementById('fee-category').value = student.feeCategory;
                document.getElementById('fee-monthly').value = student.monthlyFee;
                document.getElementById('fee-due').value = "0 (Calculation needed)";
                document.getElementById('fee-student-details').style.display = 'block';
                document.getElementById('fee-payment-form').style.display = 'block';
                document.getElementById('fee-history-container').style.display = 'block';
                loadFeeHistory(student.id);
            } catch (error) {
                console.error("Error searching student for fee:", error);
            } finally {
                hideLoading();
            }
        }
        async function loadFeeHistory(studentId) {
            const allFees = await getAllFromIndex(STORES.FEES, 'studentId', studentId);
            const historyTbody = document.querySelector('#fee-history-table tbody');
            historyTbody.innerHTML = '';
            if (allFees.length === 0) {
                historyTbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی فیس ہسٹری موجود نہیں ہے۔</td></tr>';
                return;
            }
            allFees.forEach(fee => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fee.receiptNumber}</td>
                    <td>${fee.month} ${fee.year}</td>
                    <td>${formatDate(fee.date)}</td>
                    <td>${formatCurrency(fee.amount)}</td>
                    <td>${formatCurrency(fee.fine)}</td>
                    <td>${formatCurrency(fee.discount)}</td>
                    <td>${formatCurrency(fee.total)}</td>
                    <td><button class="btn btn-sm btn-primary">رسید</button></td>
                `;
                historyTbody.appendChild(row);
            });
        }
        async function generateFeeReport() {
            const reportType = document.getElementById('fee-report-type').value;
            consttbody = document.querySelector('#fee-report-table tbody');
            const container = document.getElementById('fee-report-table-container');
            const summaryContainer = document.getElementById('fee-report-summary');
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            summaryContainer.style.display = 'none';
            try {
                let allFees = await getAllFromStore(STORES.FEES);
                let filteredFees = [];
                switch (reportType) {
                    case 'daily':
                        const date = document.getElementById('fee-report-date').value;
                        if (!date) { showNotification('براہ کرم تاریخ منتخب کریں۔', 'error'); return; }
                        filteredFees = allFees.filter(fee => fee.date === date);
                        break;
                    case 'monthly':
                        const month = document.getElementById('fee-report-month').value;
                        const year = parseInt(document.getElementById('fee-report-year').value);
                        if (!month || isNaN(year)) { showNotification('براہ کرم مہینہ اور سال منتخب کریں۔', 'error'); return; }
                        filteredFees = allFees.filter(fee => fee.month === month && fee.year === year);
                        break;
                    case 'class':
                        const classId = parseInt(document.getElementById('fee-report-class').value);
                        if (isNaN(classId)) { showNotification('براہ کرم کلاس منتخب کریں۔', 'error'); return; }
                        const studentsInClass = (await getAllFromIndex(STORES.STUDENTS, 'classId', classId)).map(s => s.id);
                        filteredFees = allFees.filter(fee => studentsInClass.includes(fee.studentId));
                        break;
                    default:
                        filteredFees = allFees;
                }
                let totalCollected = 0;
                let paidStudents = new Set();
                for (const fee of filteredFees) {
                    const student = await getFromStore(STORES.STUDENTS, fee.studentId);
                    totalCollected += fee.total;
                    paidStudents.add(fee.studentId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${fee.receiptNumber}</td>
                <td>${student ? student.name : 'N/A'}</td>
                <td>${student ? student.className : 'N/A'}</td>
                <td>${fee.month}, ${fee.year}</td>
                <td>${formatDate(fee.date)}</td>
                <td>${formatCurrency(fee.amount)}</td>
                <td>${formatCurrency(fee.fine)}</td>
                <td>${formatCurrency(fee.discount)}</td>
                <td>${formatCurrency(fee.total)}</td>
            `;
                    tbody.appendChild(row);
                }
                if (filteredFees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">اس مدت کے لیے کوئی فیس ریکارڈ نہیں ملا۔</td></tr>';
                }
                document.getElementById('fee-report-total-collected').value = formatCurrency(totalCollected);
                document.getElementById('fee-report-total-students').value = (await getCount(STORES.STUDENTS));
                document.getElementById('fee-report-paid-students').value = paidStudents.size;
                summaryContainer.style.display = 'block';
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating fee report:", error);
                showNotification('فیس رپورٹ بنانے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateDefaultersReport() {
            const classId = document.getElementById('defaulter-class').value;
            const month = document.getElementById('defaulter-month').value;
            const year = parseInt(document.getElementById('defaulter-year').value);
            const tbody = document.querySelector('#defaulters-table tbody');
            const container = document.getElementById('defaulters-table-container');
            if (!month || isNaN(year)) {
                showNotification('براہ کرم مہینہ اور سال منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            try {
                let students = await getAllFromStore(STORES.STUDENTS);
                if (classId !== 'all') {
                    students = students.filter(s => s.classId === parseInt(classId));
                }
                const feeRecords = await getAllFromStore(STORES.FEES);
                const paidFees = new Map();
                feeRecords.forEach(rec => {
                    const key = `${rec.studentId}-${rec.month}-${rec.year}`;
                    paidFees.set(key, true);
                });
                let hasDefaulters = false;
                for (const student of students) {
                    const lookupKey = `${student.id}-${month}-${year}`;
                    if (!paidFees.has(lookupKey)) {
                        hasDefaulters = true;
                        const row = document.createElement('tr');
                        row.innerHTML = `
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>${student.className}</td>
                    <td>${formatCurrency(student.monthlyFee)}</td>
                    <td>${month}, ${year}</td>
                    <td>${formatCurrency(student.monthlyFee)}</td>
                    <td>${student.contact}</td>
                    <td><button class="btn btn-primary btn-sm">نوٹس بھیجیں</button></td>
                `;
                        tbody.appendChild(row);
                    }
                }
                if (!hasDefaulters) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">اس مہینے کوئی ڈیفالٹر نہیں ہے۔</td></tr>';
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating defaulters report:", error);
                showNotification('ڈیفالٹرز رپورٹ بنانے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchEmployeeForSalary() {
            const searchTerm = document.getElementById('salary-employee-search').value;
            const employeeType = document.getElementById('salary-employee-type').value;
            if (!searchTerm) return;
            showLoading();
            try {
                const storeName = employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                const allEmployees = await getAllFromStore(storeName);
                const employee = allEmployees.find(e => e.employeeId === searchTerm || e.name.toLowerCase().includes(searchTerm.toLowerCase()));
                if (!employee) {
                    showNotification('ملازم نہیں ملا۔', 'error');
                    document.getElementById('salary-employee-details').style.display = 'none';
                    return;
                }
                document.getElementById('salary-employee-id').value = employee.employeeId;
                document.getElementById('salary-employee-id').dataset.employeeId = employee.id;
                document.getElementById('salary-employee-name').value = employee.name;
                document.getElementById('salary-employee-designation').value = employee.designation || employee.qualification;
                document.getElementById('salary-basic').value = employee.basicSalary;
                document.getElementById('salary-allowances').value = employee.allowances || 0;
                document.getElementById('salary-total').value = (employee.basicSalary || 0) + (employee.allowances || 0);
                document.getElementById('salary-employee-details').style.display = 'block';
                document.getElementById('salary-payment-form').style.display = 'block';
            } catch (error) {
                console.error("Error searching employee:", error);
            } finally {
                hideLoading();
            }
        }
        async function generateSalaryReport() {
            const reportType = document.getElementById('salary-report-type').value;
            const employeeTypeFilter = document.getElementById('salary-report-employee-type').value;
            const tbody = document.querySelector('#salary-report-table tbody');
            const container = document.getElementById('salary-report-table-container');
            const summaryContainer = document.getElementById('salary-report-summary');
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            summaryContainer.style.display = 'none';
            try {
                let allSalaries = await getAllFromStore(STORES.SALARY);
                let filteredSalaries = [];
                switch (reportType) {
                    case 'monthly':
                        const month = document.getElementById('salary-report-month').value;
                        const year = parseInt(document.getElementById('salary-report-year').value);
                        if (!month || isNaN(year)) {
                            showNotification('براہ کرم مہینہ اور سال منتخب کریں۔', 'error');
                            return;
                        }
                        filteredSalaries = allSalaries.filter(s => s.month === month && s.year === year);
                        break;
                    case 'employee':
                        const employeeIdVal = document.getElementById('salary-report-employee').value;
                        if (!employeeIdVal || employeeIdVal === 'all') {
                            showNotification('براہ کرم ایک ملازم منتخب کریں۔', 'error');
                            return;
                        }
                        const employeeId = parseInt(employeeIdVal.split('_').pop());
                        filteredSalaries = allSalaries.filter(s => s.employeeId === employeeId);
                        break;
                    case 'yearly':
                        const reportYear = parseInt(document.getElementById('salary-report-year').value);
                        if (isNaN(reportYear)) {
                            showNotification('براہ کرم سال منتخب کریں۔', 'error');
                            return;
                        }
                        filteredSalaries = allSalaries.filter(s => s.year === reportYear);
                        break;
                    default:
                        filteredSalaries = allSalaries;
                }
                if (employeeTypeFilter !== 'all') {
                    filteredSalaries = filteredSalaries.filter(s => s.employeeType === employeeTypeFilter);
                }
                let totalPaid = 0;
                let paidEmployees = new Set();
                for (const salary of filteredSalaries) {
                    const employeeStore = salary.employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                    const employee = await getFromStore(employeeStore, salary.employeeId);
                    totalPaid += salary.total;
                    paidEmployees.add(salary.employeeId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${salary.voucherNumber || '-'}</td>
                <td>${salary.employeeName}</td>
                <td>${employee ? (employee.designation || employee.specialization) : 'N/A'}</td>
                <td>${salary.month}, ${salary.year}</td>
                <td>${formatDate(salary.date)}</td>
                <td>${formatCurrency(salary.basicSalary)}</td>
                <td>${formatCurrency(salary.allowances)}</td>
                <td>${formatCurrency(salary.deductions + salary.absenceDeduction + salary.tax)}</td>
                <td>${formatCurrency(salary.total)}</td>
            `;
                    tbody.appendChild(row);
                }
                if (filteredSalaries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">اس معیار کے مطابق کوئی تنخواہ ریکارڈ نہیں ملا۔</td></tr>';
                }
                document.getElementById('salary-report-total-paid').value = formatCurrency(totalPaid);
                document.getElementById('salary-report-total-employees').value = (await getCount(STORES.TEACHERS)) + (await getCount(STORES.STAFF));
                document.getElementById('salary-report-paid-employees').value = paidEmployees.size;
                summaryContainer.style.display = 'block';
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating salary report:", error);
                showNotification('تنخواہ رپورٹ بنانے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateReport() {
            const type = document.getElementById('report-type').value;
            const outputDiv = document.getElementById('report-output');
            if (!type) {
                showNotification('براہ کرم رپورٹ کی قسم منتخب کریں', 'error');
                return;
            }
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="spinner"></div>';
            try {
                let htmlContent = '';
                switch (type) {
                    case 'student_strength':
                        htmlContent = await generateStudentStrengthReport();
                        break;
                    case 'class_list':
                        htmlContent = await generateClassListReport();
                        break;
                    case 'fee_defaulters':
                        showNotification('فیس ڈیفالٹرز رپورٹ کے لیے، براہ کرم "فیس" سیکشن میں "بقایا فیس والے" ٹیب استعمال کریں۔', 'info');
                        htmlContent = '<p>یہ رپورٹ "فیس" سیکشن میں دستیاب ہے۔</p>';
                        break;
                    default:
                        htmlContent = '<p>منتخب کردہ رپورٹ کی قسم کے لیے کوئی عمل درآمد نہیں ہے۔</p>';
                }
                outputDiv.innerHTML = htmlContent;
            } catch (e) {
                console.error("Error in generic report generation:", e);
                outputDiv.innerHTML = '<p style="color:red;">رپورٹ بنانے میں خرابی ہوئی۔</p>';
            } finally {
            }
        }
        function toggleFeeReportFields() {
            const reportType = document.getElementById('fee-report-type').value;
            document.getElementById('fee-report-date-row').style.display = 'none';
            document.getElementById('fee-report-month-row').style.display = 'none';
            document.getElementById('fee-report-class-row').style.display = 'none';
            switch (reportType) {
                case 'daily': document.getElementById('fee-report-date-row').style.display = 'flex'; break;
                case 'monthly':
                case 'yearly':
                    document.getElementById('fee-report-month-row').style.display = 'flex'; break;
                case 'class': document.getElementById('fee-report-class-row').style.display = 'flex'; break;
            }
        }
        function toggleSalaryReportFields() {
            const reportType = document.getElementById('salary-report-type').value;
            document.getElementById('salary-report-month-row').style.display = 'none';
            document.getElementById('salary-report-employee-row').style.display = 'none';
            switch (reportType) {
                case 'monthly':
                case 'yearly':
                    document.getElementById('salary-report-month-row').style.display = 'flex';
                    break;
                case 'employee':
                    document.getElementById('salary-report-employee-row').style.display = 'flex';
                    loadEmployeesForSalaryReport();
                    break;
            }
        }
        async function loadEmployeesForSalaryReport() {
            console.log("loadEmployeesForSalaryReport needs implementation.");
        }
        async function loadEmployeesForSalaryStructure() {
            const employeeType = document.getElementById('structure-employee-type').value;
            const storeName = employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
            const employees = await getAllFromStore(storeName);
            const select = document.getElementById('structure-employee');
            select.innerHTML = '';
            employees.forEach(e => {
                select.innerHTML += `<option value="${e.id}">${e.name} (${e.employeeId})</option>`;
            });
        }
        async function populateSectionsForStudentForm() {
            const classId = parseInt(document.getElementById('student-class').value);
            const sectionDropdown = document.getElementById('student-section');
            sectionDropdown.innerHTML = '<option value="">پہلے کلاس منتخب کریں</option>';
            if (!classId) {
                return;
            }
            try {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                if (sections && sections.length > 0) {
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section.id;
                        option.textContent = section.name;
                        sectionDropdown.appendChild(option);
                    });
                } else {
                    sectionDropdown.innerHTML = '<option value="">اس کلاس میں کوئی سیکشن نہیں</option>';
                }
            } catch (error) {
                console.error('Error populating sections dropdown:', error);
                sectionDropdown.innerHTML = '<option value="">سیکشن لوڈ کرنے میں خرابی</option>';
            }
        }
        async function saveThemeSettings(e) { e.preventDefault(); showNotification("Theme settings saved (simulation).", "success"); }
        async function resetThemeSettings() { showNotification("Theme reset (simulation).", "info"); }
        async function saveGeneralSettings(e) { e.preventDefault(); showNotification("General settings saved (simulation).", "success"); }
        async function saveAcademicSettings(e) { e.preventDefault(); showNotification("Academic settings saved (simulation).", "success"); }
        async function loadDashboardData() {
            try {
                const totalStudents = await getCount(STORES.STUDENTS);
                document.getElementById('total-students').textContent = totalStudents;
                const totalTeachers = await getCount(STORES.TEACHERS);
                document.getElementById('total-teachers').textContent = totalTeachers;
                const totalClasses = await getCount(STORES.CLASSES);
                document.getElementById('total-classes').textContent = totalClasses;
                const today = new Date().toISOString().split('T');
                const attendancePercentage = await getTodayAttendancePercentage(today);
                document.getElementById('today-attendance').textContent = attendancePercentage + '%';
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                const monthlyFee = await getMonthlyFeeCollection(currentMonth, currentYear);
                document.getElementById('monthly-fee').textContent = monthlyFee + ' روپے';
                const pendingFee = await getTotalPendingFee();
                document.getElementById('pending-fee').textContent = pendingFee + ' روپے';
                await loadUpcomingEvents();
                await loadRecentActivities();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('ڈیش بورڈ ڈیٹا لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function loadUpcomingEvents() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const events = await getAllFromIndex(STORES.EVENTS, 'date', IDBKeyRange.lowerBound(today.toISOString()));
                events.sort((a, b) => new Date(a.date) - new Date(b.date));
                const upcomingEvents = events.slice(0, 5);
                const tbody = document.querySelector('#events-table tbody');
                tbody.innerHTML = '';
                if (upcomingEvents.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center;">کوئی آنے والا پروگرام نہیں ہے</td>`;
                    tbody.appendChild(row);
                    return;
                }
                upcomingEvents.forEach((event, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${event.title}</td>
                        <td>${formatDate(event.date)}</td>
                        <td>${event.location || '-'}</td>
                        <td>${event.description || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading upcoming events:', error);
                showNotification('آنے والے پروگراموں کی لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function loadRecentActivities() {
            try {
                const activities = await getAllFromStore(STORES.ACTIVITIES, 5);
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));
                const tbody = document.querySelector('#activities-table tbody');
                tbody.innerHTML = '';
                if (activities.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center;">کوئی حالیہ سرگرمی نہیں ہے</td>`;
                    tbody.appendChild(row);
                    return;
                }
                activities.forEach((activity, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${activity.description}</td>
                        <td>${formatDateTime(activity.date)}</td>
                        <td>${activity.user || '-'}</td>
                        <td>${activity.details || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading recent activities:', error);
                showNotification('حالیہ سرگرمیوں کی لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function getTodayAttendancePercentage(date) {
            try {
                const attendanceRecords = await getAllFromIndex(STORES.ATTENDANCE, 'date', date);
                if (attendanceRecords.length === 0) {
                    return 0;
                }
                const presentCount = attendanceRecords.filter(record => record.status === 'present').length;
                const percentage = Math.round((presentCount / attendanceRecords.length) * 100);
                return percentage;
            } catch (error) {
                console.error('Error getting today attendance percentage:', error);
                return 0;
            }
        }
        async function getMonthlyFeeCollection(month, year) {
            try {
                const feeRecords = await getAllFromStore(STORES.FEES);
                const monthlyRecords = feeRecords.filter(record => {
                    return record.month === month && record.year === year;
                });
                const totalAmount = monthlyRecords.reduce((total, record) => {
                    return total + (record.amount + record.fine - record.discount);
                }, 0);
                return totalAmount;
            } catch (error) {
                console.error('Error getting monthly fee collection:', error);
                return 0;
            }
        }
        async function getTotalPendingFee() {
            try {
                const students = await getAllFromStore(STORES.STUDENTS);
                const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
                const feeRecords = await getAllFromStore(STORES.FEES);
                let totalPendingFee = 0;
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1;
                const currentYear = currentDate.getFullYear();
                for (const student of students) {
                    const feeStructure = feeStructures.find(fs =>
                        fs.classId === student.classId && fs.category === student.feeCategory
                    );
                    if (!feeStructure) continue;
                    const monthlyFee = feeStructure.monthlyFee || 0;
                    const admissionDate = new Date(student.admissionDate);
                    const startMonth = admissionDate.getMonth() + 1;
                    const startYear = admissionDate.getFullYear();
                    for (let year = startYear; year <= currentYear; year++) {
                        const startMonthInYear = (year === startYear) ? startMonth : 1;
                        const endMonthInYear = (year === currentYear) ? currentMonth : 12;
                        for (let month = startMonthInYear; month <= endMonthInYear; month++) {
                            const feeRecord = feeRecords.find(record =>
                                record.studentId === student.id &&
                                record.month === month &&
                                record.year === year
                            );
                            if (!feeRecord) {
                                totalPendingFee += monthlyFee;
                            }
                        }
                    }
                }
                return totalPendingFee;
            } catch (error) {
                console.error('Error getting total pending fee:', error);
                return 0;
            }
        }
        async function loadSettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general');
                if (!settings) {
                    const defaultSettings = {
                        id: 'general',
                        schoolName: 'ڈینی مدرسہ',
                        schoolShortName: 'DM',
                        schoolAddress: 'مدرسہ روڈ، شہر',
                        schoolPhone: '0300-1234567',
                        schoolEmail: 'info@deenimadrasa.com',
                        schoolWebsite: 'www.deenimadrasa.com',
                        currentSession: new Date().getFullYear() + '-' + (new Date().getFullYear() + 1),
                        sessionStart: new Date(new Date().getFullYear(), 3, 1).toISOString().split('T'),
                        sessionEnd: new Date(new Date().getFullYear() + 1, 2, 31).toISOString().split('T'),
                        schoolTimeStart: '08:00',
                        schoolTimeEnd: '14:00',
                        periodDuration: 45,
                        weeklyHoliday: ['جمعہ'],
                        feeDueDay: 10,
                        feeLateFiné: 50,
                        libraryReturnDays: 14,
                        libraryLateFine: 5,
                        primaryColor: '#3498db',
                        secondaryColor: '#2c3e50',
                        fontSize: 'medium',
                        fontFamily: 'Jameel Noori Nastaleeq',
                        sidebarPosition: 'right',
                        sidebarTheme: 'dark',
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.SETTINGS, defaultSettings);
                    console.log('Default settings created');
                } else {
                    console.log('Settings loaded successfully');
                }
                applySettings();
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('ترتیبات لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function applySettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general');
                if (!settings) return;
                document.documentElement.style.setProperty('--primary-color', settings.primaryColor || '#3498db');
                document.documentElement.style.setProperty('--secondary-color', settings.secondaryColor || '#2c3e50');
                let fontSizeValue = '16px';
                switch (settings.fontSize) {
                    case 'small': fontSizeValue = '14px'; break;
                    case 'medium': fontSizeValue = '16px'; break;
                    case 'large': fontSizeValue = '18px'; break;
                }
                document.documentElement.style.setProperty('--font-size', fontSizeValue);
                document.documentElement.style.setProperty('--font-family', settings.fontFamily || 'Jameel Noori Nastaleeq');
                const sidebar = document.getElementById('sidebar');
                const mainContainer = document.getElementById('mainContainer');
                if (settings.sidebarPosition === 'left') {
                    sidebar.style.right = 'auto';
                    sidebar.style.left = '0';
                    mainContainer.style.marginRight = '0';
                    mainContainer.style.marginLeft = '250px';
                } else {
                    sidebar.style.right = '0';
                    sidebar.style.left = 'auto';
                    mainContainer.style.marginRight = '250px';
                    mainContainer.style.marginLeft = '0';
                }
                if (settings.sidebarTheme === 'light') {
                    sidebar.style.backgroundColor = '#f5f5f5';
                    sidebar.style.color = '#333';
                } else {
                    sidebar.style.backgroundColor = '#34495e';
                    sidebar.style.color = 'white';
                }
                console.log('Settings applied successfully');
            } catch (error) {
                console.error('Error applying settings:', error);
            }
        }
        async function loadDropdownData() {
            try {
                await loadClassDropdowns();
                await loadSubjectDropdowns();
                await loadTeacherDropdowns();
                console.log('Dropdown data loaded successfully');
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                showNotification('ڈراپ ڈاؤن ڈیٹا لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function loadClassDropdowns() {
            try {
                const classes = await getAllFromStore(STORES.CLASSES);
                const classDropdowns = document.querySelectorAll('select[id$="-class"]');
                classDropdowns.forEach(dropdown => {
                    const existingOptions = Array.from(dropdown.options).filter(option => {
                        return option.value === 'all' || option.dataset.fixed === 'true';
                    });
                    dropdown.innerHTML = '';
                    existingOptions.forEach(option => {
                        dropdown.appendChild(option);
                    });
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.name;
                        dropdown.appendChild(option);
                    });
                });
                console.log('Class dropdowns loaded successfully');
            } catch (error) {
                console.error('Error loading class dropdowns:', error);
            }
        }
        async function loadSubjectDropdowns() {
            try {
                const subjects = await getAllFromStore(STORES.SUBJECTS);
                const subjectDropdowns = document.querySelectorAll('select[id$="-subject"]');
                subjectDropdowns.forEach(dropdown => {
                    const existingOptions = Array.from(dropdown.options).filter(option => {
                        return option.value === 'all' || option.dataset.fixed === 'true';
                    });
                    dropdown.innerHTML = '';
                    existingOptions.forEach(option => {
                        dropdown.appendChild(option);
                    });
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.id;
                        option.textContent = subject.name;
                        dropdown.appendChild(option);
                    });
                });
                console.log('Subject dropdowns loaded successfully');
            } catch (error) {
                console.error('Error loading subject dropdowns:', error);
            }
        }
        async function loadStudentsTable(studentsToLoad = null) {
            try {
                const students = studentsToLoad === null ? await getAllFromStore(STORES.STUDENTS) : studentsToLoad;
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = '';
                if (!students || students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی طالب علم موجود نہیں ہے یا فلٹر سے کوئی نتیجہ نہیں ملا۔</td></tr>';
                    return;
                }
                for (const student of students) {
                    const row = document.createElement('tr');
                    const classData = student.classId ? await getFromStore(STORES.CLASSES, student.classId) : null;
                    const sectionData = student.sectionId ? await getFromStore(STORES.SECTIONS, student.sectionId) : null;
                    row.innerHTML = `
                <td>${student.rollNumber}</td>
                <td>${student.name}</td>
                <td>${student.fatherName}</td>
                <td>${classData ? classData.name : 'N/A'}</td>
                <td>${sectionData ? sectionData.name : 'N/A'}</td>
                <td>${student.contact}</td>
                <td>${formatDate(student.admissionDate)}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editStudent(${student.id})">ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteStudent(${student.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading students table:', error);
                const tbody = document.querySelector('#students-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">طلباء کی فہرست لوڈ کرنے میں خرابی ہوئی۔</td></tr>';
            }
        }
        async function editStudent(id) {
            showLoading();
            try {
                const student = await getFromStore(STORES.STUDENTS, id);
                if (!student) {
                    showNotification('طالب علم کا ریکارڈ نہیں ملا۔', 'error');
                    return;
                }
                const form = document.getElementById('student-form');
                form.dataset.editId = id;
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-father').value = student.fatherName;
                document.getElementById('student-dob').value = student.dob;
                document.getElementById('student-gender').value = student.gender;
                document.getElementById('student-class').value = student.classId;
                await populateSectionsForStudentForm();
                document.getElementById('student-section').value = student.sectionId;
                document.getElementById('student-contact').value = student.contact;
                document.getElementById('student-email').value = student.email;
                document.getElementById('student-guardian').value = student.guardian;
                document.getElementById('student-guardian-contact').value = student.guardianContact;
                document.getElementById('student-address').value = student.address;
                document.getElementById('student-admission-date').value = student.admissionDate;
                document.getElementById('student-fee-category').value = student.feeCategory;
                document.getElementById('student-monthly-fee').value = student.monthlyFee;
                document.getElementById('student-notes').value = student.notes;
                document.querySelector('.tab[data-tab="add-student"]').click();
                form.querySelector('button[type="submit"]').textContent = 'ریکارڈ اپڈیٹ کریں';
            } catch (e) {
                showNotification('ترمیم کے لیے ڈیٹا لوڈ کرنے میں خرابی ہوئی۔', 'error');
                console.error(e);
            } finally {
                hideLoading();
            }
        }
        async function deleteStudent(id) {
            if (confirm('کیا آپ واقعی اس طالب علم کو حذف کرنا چاہتے ہیں؟')) {
                console.log('Deleting student with ID:', id);
                await deleteFromStore(STORES.STUDENTS, id);
                loadStudentsTable();
                showNotification('طالب علم کو حذف کر دیا گیا ہے۔', 'success');
            }
        }
        function editTeacher(id) {
            console.log('Editing teacher with ID:', id);
            showNotification('ترمیم کا فنکشن ابھی زیر تعمیر ہے۔', 'info');
        }
        async function deleteTeacher(id) {
            if (confirm('کیا آپ واقعی اس استاد کو حذف کرنا چاہتے ہیں؟')) {
                console.log('Deleting teacher with ID:', id);
                await deleteFromStore(STORES.TEACHERS, id);
                loadTeachersTable();
                showNotification('استاد کو حذف کر دیا گیا ہے۔', 'success');
            }
        }
        async function checkAndLoadSampleData() {
            try {
                const studentsCount = await getCount(STORES.STUDENTS);
                const teachersCount = await getCount(STORES.TEACHERS);
                const classesCount = await getCount(STORES.CLASSES);
                if (studentsCount === 0 && teachersCount === 0 && classesCount === 0) {
                    await loadSampleData();
                    console.log('Sample data loaded successfully');
                } else {
                    console.log('Database already contains data, skipping sample data loading');
                }
            } catch (error) {
                console.error('Error checking and loading sample data:', error);
                showNotification('سیمپل ڈیٹا لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function loadSampleData() {
            try {
                showLoading();
                const classesData = [
                    { name: 'پہلی جماعت', level: 'ابتدائی', inChargeId: null, roomNumber: '101', monthlyFee: 500, admissionFee: 1000 },
                    { name: 'دوسری جماعت', level: 'ابتدائی', inChargeId: null, roomNumber: '102', monthlyFee: 500, admissionFee: 1000 },
                    { name: 'تیسری جماعت', level: 'ابتدائی', inChargeId: null, roomNumber: '103', monthlyFee: 600, admissionFee: 1000 },
                    { name: 'چوتھی جماعت', level: 'ابتدائی', inChargeId: null, roomNumber: '104', monthlyFee: 600, admissionFee: 1000 },
                    { name: 'پانچویں جماعت', level: 'ابتدائی', inChargeId: null, roomNumber: '105', monthlyFee: 700, admissionFee: 1000 },
                    { name: 'چھٹی جماعت', level: 'ثانوی', inChargeId: null, roomNumber: '201', monthlyFee: 800, admissionFee: 1500 },
                    { name: 'ساتویں جماعت', level: 'ثانوی', inChargeId: null, roomNumber: '202', monthlyFee: 800, admissionFee: 1500 },
                    { name: 'آٹھویں جماعت', level: 'ثانوی', inChargeId: null, roomNumber: '203', monthlyFee: 900, admissionFee: 1500 },
                    { name: 'نویں جماعت', level: 'سینیئر', inChargeId: null, roomNumber: '301', monthlyFee: 1000, admissionFee: 2000 },
                    { name: 'دسویں جماعت', level: 'سینیئر', inChargeId: null, roomNumber: '302', monthlyFee: 1000, admissionFee: 2000 },
                    { name: 'حفظ القرآن', level: 'خصوصی', inChargeId: null, roomNumber: '401', monthlyFee: 1200, admissionFee: 2500 },
                    { name: 'ناظرہ قرآن', level: 'خصوصی', inChargeId: null, roomNumber: '402', monthlyFee: 800, admissionFee: 1500 },
                ];
                const classIds = [];
                for (const classData of classesData) {
                    const id = await addToStore(STORES.CLASSES, classData);
                    classIds.push(id);
                }
                const sectionNames = ['الف', 'ب', 'ج'];
                for (const classId of classIds) {
                    for (const sectionName of sectionNames) {
                        await addToStore(STORES.SECTIONS, {
                            classId: classId,
                            name: sectionName,
                            inChargeId: null,
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                const subjectsData = [
                    { name: 'قرآن مجید', code: 'QUR', type: 'قرآن', periods: 5, details: 'قرآن مجید کی تعلیم' },
                    { name: 'ناظرہ قرآن', code: 'NAZ', type: 'قرآن', periods: 5, details: 'قرآن مجید کی ناظرہ تعلیم' },
                    { name: 'حفظ القرآن', code: 'HIF', type: 'قرآن', periods: 10, details: 'قرآن مجید کا حفظ' },
                    { name: 'تجوید', code: 'TAJ', type: 'قرآن', periods: 3, details: 'قرآن مجید کی صحیح قرأت' },
                    { name: 'تفسیر قرآن', code: 'TAF', type: 'قرآن', periods: 3, details: 'قرآن مجید کی تفسیر' },
                    { name: 'حدیث', code: 'HAD', type: 'حدیث', periods: 4, details: 'احادیث نبوی صلی اللہ علیہ وسلم کی تعلیم' },
                    { name: 'فقہ', code: 'FIQ', type: 'فقہ', periods: 3, details: 'اسلامی فقہ کی تعلیم' },
                    { name: 'عقائد', code: 'AQA', type: 'عقیدہ', periods: 2, details: 'اسلامی عقائد کی تعلیم' },
                    { name: 'سیرت النبی', code: 'SIR', type: 'سیرت', periods: 2, details: 'سیرت النبی صلی اللہ علیہ وسلم کی تعلیم' },
                    { name: 'اخلاقیات', code: 'AKH', type: 'اخلاق', periods: 2, details: 'اسلامی اخلاقیات کی تعلیم' },
                    { name: 'عربی', code: 'ARB', type: 'عربی', periods: 4, details: 'عربی زبان کی تعلیم' },
                    { name: 'اردو', code: 'URD', type: 'اردو', periods: 4, details: 'اردو زبان کی تعلیم' },
                    { name: 'انگریزی', code: 'ENG', type: 'انگریزی', periods: 4, details: 'انگریزی زبان کی تعلیم' },
                    { name: 'ریاضی', code: 'MAT', type: 'ریاضی', periods: 5, details: 'ریاضی کی تعلیم' },
                    { name: 'سائنس', code: 'SCI', type: 'سائنس', periods: 4, details: 'سائنس کی تعلیم' },
                    { name: 'سماجی علوم', code: 'SOC', type: 'سماجی علوم', periods: 3, details: 'سماجی علوم کی تعلیم' },
                    { name: 'پاکستان سٹڈیز', code: 'PAK', type: 'سماجی علوم', periods: 2, details: 'پاکستان کی تاریخ اور جغرافیہ' },
                    { name: 'اسلامیات', code: 'ISL', type: 'اسلامیات', periods: 3, details: 'اسلامیات کی تعلیم' },
                    { name: 'کمپیوٹر', code: 'COM', type: 'کمپیوٹر', periods: 2, details: 'کمپیوٹر کی تعلیم' },
                    { name: 'صحت و جسمانی تعلیم', code: 'PHY', type: 'صحت', periods: 2, details: 'صحت اور جسمانی تعلیم' },
                ];
                const subjectIds = [];
                for (const subjectData of subjectsData) {
                    const id = await addToStore(STORES.SUBJECTS, subjectData);
                    subjectIds.push(id);
                }
                const teachersData = [
                    {
                        employeeId: 'T001',
                        name: 'قاری محمد احمد',
                        fatherName: 'محمد یوسف',
                        gender: 'مرد',
                        dob: '1980-05-15',
                        qualification: 'عالم فاضل، قاری',
                        specialization: 'قرآن و حدیث',
                        subjects: ['1', '6', '7'],
                        contact: '0300-1234567',
                        email: 'ahmad@example.com',
                        address: 'حافظ آباد، لاہور',
                        cnic: '35201-1234567-1',
                        joiningDate: '2015-03-01',
                        basicSalary: 25000,
                        allowances: 5000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T002',
                        name: 'مولانا عبدالرحمن',
                        fatherName: 'عبدالغفور',
                        gender: 'مرد',
                        dob: '1975-09-20',
                        qualification: 'شیخ الحدیث، مفتی',
                        specialization: 'فقہ و اصول',
                        subjects: ['1', '6', '7'],
                        contact: '0300-2345678',
                        email: 'abdulrehman@example.com',
                        address: 'جوہر ٹاؤن، لاہور',
                        cnic: '35201-2345678-1',
                        joiningDate: '2010-01-15',
                        basicSalary: 30000,
                        allowances: 7000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T003',
                        name: 'حافظ محمد عمر',
                        fatherName: 'محمد اسلم',
                        gender: 'مرد',
                        dob: '1985-03-10',
                        qualification: 'حافظ، عالم',
                        specialization: 'قرآن و تجوید',
                        subjects: ['1', '6', '7'],
                        contact: '0300-3456789',
                        email: 'umar@example.com',
                        address: 'ٹاؤن شپ، لاہور',
                        cnic: '35201-3456789-1',
                        joiningDate: '2018-08-01',
                        basicSalary: 22000,
                        allowances: 3000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T004',
                        name: 'استاد محمد علی',
                        fatherName: 'محمد اکرم',
                        gender: 'مرد',
                        dob: '1982-12-05',
                        qualification: 'ایم اے عربی، بی ایڈ',
                        specialization: 'عربی و اردو',
                        subjects: ['1', '6', '7'],
                        contact: '0300-4567890',
                        email: 'ali@example.com',
                        address: 'فیصل ٹاؤن، لاہور',
                        cnic: '35201-4567890-1',
                        joiningDate: '2016-04-15',
                        basicSalary: 20000,
                        allowances: 4000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T005',
                        name: 'استاد محمد عمران',
                        fatherName: 'محمد افضل',
                        gender: 'مرد',
                        dob: '1988-07-25',
                        qualification: 'ایم ایس سی ریاضی، بی ایڈ',
                        specialization: 'ریاضی و سائنس',
                        subjects: ['1', '6', '7'],
                        contact: '0300-5678901',
                        email: 'imran@example.com',
                        address: 'ماڈل ٹاؤن، لاہور',
                        cnic: '35201-5678901-1',
                        joiningDate: '2017-09-01',
                        basicSalary: 23000,
                        allowances: 5000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date(),
                        specialization: 'ریاضی و سائنس',
                        subjects: ['14', '15'],
                        contact: '0300-5678901',
                        email: 'imran@example.com',
                        address: 'ماڈل ٹاؤن، لاہور',
                        cnic: '35201-5678901-1',
                        joiningDate: '2017-09-01',
                        basicSalary: 23000,
                        allowances: 5000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T006',
                        name: 'معلمہ عائشہ',
                        fatherName: 'عبدالستار',
                        gender: 'عورت',
                        dob: '1990-11-12',
                        qualification: 'عالمہ فاضلہ، بی ایڈ',
                        specialization: 'اسلامیات و اردو',
                        subjects: ['12', '18'],
                        contact: '0300-6789012',
                        email: 'ayesha@example.com',
                        address: 'گلشن راوی، لاہور',
                        cnic: '35201-6789012-2',
                        joiningDate: '2019-03-15',
                        basicSalary: 20000,
                        allowances: 3000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                const teacherIds = [];
                for (const teacherData of teachersData) {
                    const id = await addToStore(STORES.TEACHERS, teacherData);
                    teacherIds.push(id);
                }
                for (let i = 0; i < Math.min(classIds.length, teacherIds.length); i++) {
                    await updateInStore(STORES.CLASSES, classIds[i], { inChargeId: teacherIds[i % teacherIds.length] });
                }
                const staffData = [
                    {
                        employeeId: 'S001',
                        name: 'محمد عارف',
                        fatherName: 'محمد اسلم',
                        gender: 'مرد',
                        dob: '1985-06-20',
                        designation: 'دفتری کلرک',
                        department: 'انتظامیہ',
                        qualification: 'بی اے',
                        responsibilities: 'دفتری کام، داخلہ، رجسٹریشن',
                        contact: '0300-7890123',
                        email: 'arif@example.com',
                        address: 'فیصل ٹاؤن، لاہور',
                        cnic: '35201-7890123-1',
                        joiningDate: '2018-01-15',
                        basicSalary: 18000,
                        allowances: 2000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'S002',
                        name: 'محمد صدیق',
                        fatherName: 'محمد یوسف',
                        gender: 'مرد',
                        dob: '1970-04-10',
                        designation: 'لائبریرین',
                        department: 'لائبریری',
                        qualification: 'ایم اے لائبریری سائنس',
                        responsibilities: 'لائبریری میں کتابوں کا انتظام، اجراء و واپسی',
                        contact: '0300-8901234',
                        email: 'siddique@example.com',
                        address: 'ٹاؤن شپ، لاہور',
                        cnic: '35201-8901234-1',
                        joiningDate: '2015-05-01',
                        basicSalary: 20000,
                        allowances: 3000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'S003',
                        name: 'عبدالغفور',
                        fatherName: 'عبدالرزاق',
                        gender: 'مرد',
                        dob: '1975-08-15',
                        designation: 'سیکیورٹی گارڈ',
                        department: 'سیکیورٹی',
                        qualification: 'میٹرک',
                        responsibilities: 'مدرسہ کی سیکیورٹی، گیٹ پر چیکنگ',
                        contact: '0300-9012345',
                        email: null,
                        address: 'بیگم پورہ، لاہور',
                        cnic: '35201-9012345-1',
                        joiningDate: '2017-03-01',
                        basicSalary: 15000,
                        allowances: 2000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const staffMember of staffData) {
                    await addToStore(STORES.STAFF, staffMember);
                }
                const usersData = [
                    {
                        username: 'admin',
                        password: 'admin123',
                        name: 'سسٹم ایڈمن',
                        email: 'admin@deenimadrasa.com',
                        role: 'admin',
                        status: 'active',
                        mobile: '0300-1234567',
                        address: 'لاہور',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'teacher1',
                        password: 'teacher123',
                        name: 'قاری محمد احمد',
                        email: 'ahmad@example.com',
                        role: 'teacher',
                        status: 'active',
                        mobile: '0300-1234567',
                        address: 'حافظ آباد، لاہور',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'librarian',
                        password: 'library123',
                        name: 'محمد صدیق',
                        email: 'siddique@example.com',
                        role: 'librarian',
                        status: 'active',
                        mobile: '0300-8901234',
                        address: 'ٹاؤن شپ، لاہور',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'accountant',
                        password: 'account123',
                        name: 'محمد عارف',
                        email: 'arif@example.com',
                        role: 'accountant',
                        status: 'active',
                        mobile: '0300-7890123',
                        address: 'فیصل ٹاؤن، لاہور',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const userData of usersData) {
                    await addToStore(STORES.USERS, userData);
                }
                const rolesData = [
                    {
                        name: 'admin',
                        description: 'سسٹم ایڈمنسٹریٹر',
                        permissions: {
                            dashboard: true,
                            students: true,
                            teachers: true,
                            staff: true,
                            classes: true,
                            subjects: true,
                            attendance: true,
                            exams: true,
                            fees: true,
                            salaries: true,
                            library: true,
                            users: true,
                            reports: true,
                            settings: true,
                            backup: true
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'teacher',
                        description: 'استاد',
                        permissions: {
                            dashboard: true,
                            students: true,
                            teachers: false,
                            staff: false,
                            classes: true,
                            subjects: true,
                            attendance: true,
                            exams: true,
                            fees: false,
                            salaries: false,
                            library: true,
                            users: false,
                            reports: true,
                            settings: false,
                            backup: false
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'librarian',
                        description: 'لائبریرین',
                        permissions: {
                            dashboard: true,
                            students: true,
                            teachers: true,
                            staff: false,
                            classes: false,
                            subjects: false,
                            attendance: false,
                            exams: false,
                            fees: false,
                            salaries: false,
                            library: true,
                            users: false,
                            reports: true,
                            settings: false,
                            backup: false
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'accountant',
                        description: 'اکاؤنٹنٹ',
                        permissions: {
                            dashboard: true,
                            students: true,
                            teachers: true,
                            staff: true,
                            classes: false,
                            subjects: false,
                            attendance: false,
                            exams: false,
                            fees: true,
                            salaries: true,
                            library: false,
                            users: false,
                            reports: true,
                            settings: false,
                            backup: false
                        },
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const roleData of rolesData) {
                    await addToStore(STORES.ROLES, roleData);
                }
                const booksData = [
                    {
                        name: 'قرآن مجید مع اردو ترجمہ',
                        author: 'مولانا فتح محمد جالندھری',
                        category: 'قرآن',
                        publisher: 'القرآن اکیڈمی',
                        publicationYear: 2015,
                        isbn: '978-0123456789',
                        copies: 10,
                        availableCopies: 10,
                        shelf: 'A1',
                        description: 'قرآن مجید مع اردو ترجمہ',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'صحیح بخاری',
                        author: 'امام محمد بن اسماعیل بخاری',
                        category: 'حدیث',
                        publisher: 'دارالسلام پبلشرز',
                        publicationYear: 2010,
                        isbn: '978-0123456790',
                        copies: 5,
                        availableCopies: 5,
                        shelf: 'B1',
                        description: 'صحیح بخاری حدیث کی مشہور کتاب',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'صحیح مسلم',
                        author: 'امام مسلم بن حجاج',
                        category: 'حدیث',
                        publisher: 'دارالسلام پبلشرز',
                        publicationYear: 2012,
                        isbn: '978-0123456791',
                        copies: 5,
                        availableCopies: 5,
                        shelf: 'B2',
                        description: 'صحیح مسلم حدیث کی مشہور کتاب',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'ریاض الصالحین',
                        author: 'امام نووی',
                        category: 'حدیث',
                        publisher: 'دار ابن کثیر',
                        publicationYear: 2014,
                        isbn: '978-0123456792',
                        copies: 8,
                        availableCopies: 8,
                        shelf: 'B3',
                        description: 'احادیث کا مشہور مجموعہ',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'تفسیر ابن کثیر',
                        author: 'امام ابن کثیر',
                        category: 'تفسیر',
                        publisher: 'دار طیبہ',
                        publicationYear: 2000,
                        isbn: '978-0123456793',
                        copies: 3,
                        availableCopies: 3,
                        shelf: 'C1',
                        description: 'قرآن کریم کی معروف تفسیر',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'سیرت النبی',
                        author: 'شبلی نعمانی، سید سلیمان ندوی',
                        category: 'سیرت',
                        publisher: 'مکتبہ رحمانیہ',
                        publicationYear: 2005,
                        isbn: '978-0123456794',
                        copies: 7,
                        availableCopies: 7,
                        shelf: 'D1',
                        description: 'حضور اکرم صلی اللہ علیہ وسلم کی سیرت مبارکہ',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'بہشتی زیور',
                        author: 'مولانا اشرف علی تھانوی',
                        category: 'فقہ',
                        publisher: 'دار الاشاعت',
                        publicationYear: 2008,
                        isbn: '978-0123456795',
                        copies: 10,
                        availableCopies: 10,
                        shelf: 'E1',
                        description: 'خواتین کے لیے دینی ہدایات',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'تعلیم الاسلام',
                        author: 'مولانا محمد ظفر الدین',
                        category: 'اسلامیات',
                        publisher: 'مکتبہ اسلامیہ',
                        publicationYear: 2018,
                        isbn: '978-0123456796',
                        copies: 15,
                        availableCopies: 15,
                        shelf: 'F1',
                        description: 'بچوں کے لیے اسلامی تعلیمات',
                        image: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const bookData of booksData) {
                    await addToStore(STORES.BOOKS, bookData);
                }
                const feeStructureData = [];
                for (const classId of classIds) {
                    const classData = await getFromStore(STORES.CLASSES, classId);
                    feeStructureData.push({
                        classId: classId,
                        category: 'عام',
                        monthlyFee: classData.monthlyFee,
                        admissionFee: classData.admissionFee,
                        examFee: classData.monthlyFee * 0.5,
                        computerFee: 100,
                        transportFee: 500,
                        otherFee: 0,
                        createdAt: new Date().toISOString()
                    });
                    feeStructureData.push({
                        classId: classId,
                        category: 'مستحق',
                        monthlyFee: classData.monthlyFee * 0.5,
                        admissionFee: classData.admissionFee * 0.5,
                        examFee: classData.monthlyFee * 0.25,
                        computerFee: 50,
                        transportFee: 250,
                        otherFee: 0,
                        createdAt: new Date().toISOString()
                    });
                    feeStructureData.push({
                        classId: classId,
                        category: 'اسکالرشپ',
                        monthlyFee: 0,
                        admissionFee: 0,
                        examFee: 0,
                        computerFee: 0,
                        transportFee: 0,
                        otherFee: 0,
                        createdAt: new Date().toISOString()
                    });
                }
                for (const feeStructure of feeStructureData) {
                    await addToStore(STORES.FEE_STRUCTURE, feeStructure);
                }
                const sections = await getAllFromStore(STORES.SECTIONS);
                const maleFirstNames = ['محمد', 'احمد', 'علی', 'عمر', 'عثمان', 'حسن', 'حسین', 'ابراہیم', 'اسماعیل', 'عبداللہ', 'عبدالرحمن', 'فیصل', 'عمران', 'طارق', 'اسلم', 'اکرم', 'بلال', 'عادل', 'عارف', 'وسیم'];
                const femaleFirstNames = ['عائشہ', 'فاطمہ', 'مریم', 'زینب', 'خدیجہ', 'حفصہ', 'سمیہ', 'رابعہ', 'آمنہ', 'صفیہ', 'حلیمہ', 'نسرین', 'شہناز', 'رضوانہ', 'شبنم', 'صباء', 'عافیہ', 'سلمی', 'رخسانہ', 'نشوہ'];
                const lastNames = ['احمد', 'محمود', 'خان', 'ملک', 'چودھری', 'شیخ', 'سید', 'ہاشمی', 'قریشی', 'عباسی', 'بخاری', 'گیلانی', 'نقوی', 'رضوی', 'عالم', 'اعجاز', 'صدیقی', 'فاروقی', 'عثمانی', 'انصاری'];
                const fatherNames = ['محمد احمد', 'محمد علی', 'عبدالرحمن', 'عبدالغفور', 'محمد اسلم', 'محمد اکرم', 'محمد یوسف', 'عبداللہ', 'محمد عمر', 'محمد طارق', 'محمد صدیق', 'محمد سلیم', 'محمد رفیق', 'محمد افضل', 'محمد اشرف', 'محمد انور', 'عبدالعزیز', 'عبدالقادر', 'محمد ریاض', 'محمد شفیق'];
                const addresses = [
                    'حافظ آباد، لاہور',
                    'جوہر ٹاؤن، لاہور',
                    'ٹاؤن شپ، لاہور',
                    'فیصل ٹاؤن، لاہور',
                    'ماڈل ٹاؤن، لاہور',
                    'گلشن راوی، لاہور',
                    'اقبال ٹاؤن، لاہور',
                    'علامہ اقبال ٹاؤن، لاہور',
                    'وحدت روڈ، لاہور',
                    'گلبرگ، لاہور'
                ];
                const studentsData = [];
                const currentYear = new Date().getFullYear();
                let rollNumber = 1;
                for (const section of sections) {
                    const classData = await getFromStore(STORES.CLASSES, section.classId);
                    for (let i = 0; i < 10; i++) {
                        const gender = Math.random() > 0.5 ? 'مرد' : 'عورت';
                        const firstName = gender === 'مرد'
                            ? maleFirstNames[Math.floor(Math.random() * maleFirstNames.length)]
                            : femaleFirstNames[Math.floor(Math.random() * femaleFirstNames.length)];
                        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                        const name = firstName + ' ' + lastName;
                        const fatherName = fatherNames[Math.floor(Math.random() * fatherNames.length)];
                        const age = 7 + Math.floor(Math.random() * 9);
                        const dob = new Date(currentYear - age, Math.floor(Math.random() * 12), 1 + Math.floor(Math.random() * 28));
                        const yearsAgo = Math.floor(Math.random() * 3);
                        const admissionDate = new Date(currentYear - yearsAgo, Math.floor(Math.random() * 12), 1 + Math.floor(Math.random() * 28));
                        const address = addresses[Math.floor(Math.random() * addresses.length)];
                        const mobilePrefix = ['0300', '0301', '0302', '0303', '0304', '0305', '0310', '0311', '0312', '0313'][Math.floor(Math.random() * 10)];
                        const mobileNumber = mobilePrefix + '-' + Math.floor(1000000 + Math.random() * 9000000);
                        const feeCategories = ['عام', 'عام', 'عام', 'عام', 'مستحق', 'مستحق', 'اسکالرشپ'];
                        const feeCategory = feeCategories[Math.floor(Math.random() * feeCategories.length)];
                        studentsData.push({
                            rollNumber: rollNumber++,
                            name: name,
                            fatherName: fatherName,
                            gender: gender,
                            dob: dob.toISOString().split('T'),
                            classId: section.classId,
                            className: classData.name,
                            sectionId: section.id,
                            sectionName: section.name,
                            contact: mobileNumber,
                            email: firstName.toLowerCase() + rollNumber + '@example.com',
                            guardian: fatherName,
                            guardianContact: mobileNumber,
                            address: address,
                            photo: null,
                            admissionDate: admissionDate.toISOString().split('T'),
                            feeCategory: feeCategory,
                            monthlyFee: classData.monthlyFee,
                            notes: '',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                for (const studentData of studentsData) {
                    await addToStore(STORES.STUDENTS, studentData);
                }
                const today = new Date().toISOString().split('T');
                for (const student of studentsData) {
                    const random = Math.random();
                    let status = 'present';
                    if (random > 0.9) {
                        status = 'absent';
                    } else if (random > 0.85) {
                        status = 'leave';
                    }
                    await addToStore(STORES.ATTENDANCE, {
                        date: today,
                        classId: student.classId,
                        sectionId: student.sectionId,
                        studentId: student.id || (await getStudentByRollNumber(student.rollNumber)).id,
                        status: status,
                        isLate: random > 0.8 && random <= 0.85,
                        notes: '',
                        createdAt: new Date().toISOString()
                    });
                }
                const examsData = [
                    {
                        name: 'پہلا ماہانہ امتحان',
                        type: 'ماہانہ',
                        startDate: new Date(currentYear, 3, 25).toISOString().split('T'),
                        endDate: new Date(currentYear, 3, 30).toISOString().split('T'),
                        classes: classIds,
                        passingPercent: 33,
                        details: 'پہلا ماہانہ امتحان اپریل میں منعقد کیا جائے گا',
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'دوسرا ماہانہ امتحان',
                        type: 'ماہانہ',
                        startDate: new Date(currentYear, 4, 25).toISOString().split('T'),
                        endDate: new Date(currentYear, 4, 30).toISOString().split('T'),
                        classes: classIds,
                        passingPercent: 33,
                        details: 'دوسرا ماہانہ امتحان مئی میں منعقد کیا جائے گا',
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'سہ ماہی امتحان',
                        type: 'سہ ماہی',
                        startDate: new Date(currentYear, 5, 15).toISOString().split('T'),
                        endDate: new Date(currentYear, 5, 25).toISOString().split('T'),
                        classes: classIds,
                        passingPercent: 33,
                        details: 'سہ ماہی امتحان جون میں منعقد کیا جائے گا',
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'ششماہی امتحان',
                        type: 'ششماہی',
                        startDate: new Date(currentYear, 8, 15).toISOString().split('T'),
                        endDate: new Date(currentYear, 8, 30).toISOString().split('T'),
                        classes: classIds,
                        passingPercent: 33,
                        details: 'ششماہی امتحان ستمبر میں منعقد کیا جائے گا',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'سالانہ امتحان',
                        type: 'سالانہ',
                        startDate: new Date(currentYear + 1, 2, 15).toISOString().split('T'),
                        endDate: new Date(currentYear + 1, 2, 31).toISOString().split('T'),
                        classes: classIds,
                        passingPercent: 33,
                        details: 'سالانہ امتحان مارچ میں منعقد کیا جائے گا',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    }
                ];
                const examIds = [];
                for (const examData of examsData) {
                    const id = await addToStore(STORES.EXAMS, examData);
                    examIds.push(id);
                }
                const eventsData = [
                    {
                        title: 'تقسیم انعامات تقریب',
                        date: new Date(currentYear, new Date().getMonth() + 1, 15).toISOString().split('T'),
                        location: 'مدرسہ ہال',
                        type: 'تقریب',
                        description: 'سالانہ تقسیم انعامات کی تقریب',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'والدین سے ملاقات',
                        date: new Date(currentYear, new Date().getMonth() + 1, 20).toISOString().split('T'),
                        location: 'کلاس رومز',
                        type: 'میٹنگ',
                        description: 'والدین سے ملاقات کا دن',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'سیرت النبی کانفرنس',
                        date: new Date(currentYear, 10, 12).toISOString().split('T'),
                        location: 'مدرسہ گراؤنڈ',
                        type: 'کانفرنس',
                        description: 'سیرت النبی صلی اللہ علیہ وسلم پر خصوصی کانفرنس',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'قرآن خوانی مقابلہ',
                        date: new Date(currentYear, 8, 5).toISOString().split('T'),
                        location: 'مسجد ہال',
                        type: 'مقابلہ',
                        description: 'طلباء کے درمیان قرآن خوانی کا مقابلہ',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'سالانہ جلسہ',
                        date: new Date(currentYear, 2, 23).toISOString().split('T'),
                        location: 'مدرسہ گراؤنڈ',
                        type: 'جلسہ',
                        description: 'مدرسہ کا سالانہ جلسہ',
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const eventData of eventsData) {
                    await addToStore(STORES.EVENTS, eventData);
                }
                const activitiesData = [
                    {
                        description: 'نئے طالب علم کا داخلہ',
                        date: new Date(new Date().setDate(new Date().getDate() - 1)).toISOString(),
                        type: 'داخلہ',
                        user: 'سسٹم ایڈمن',
                        userId: 1,
                        details: 'محمد علی کا پہلی جماعت میں داخلہ',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'فیس جمع کرائی گئی',
                        date: new Date(new Date().setDate(new Date().getDate() - 2)).toISOString(),
                        type: 'فیس',
                        user: 'سسٹم ایڈمن',
                        userId: 1,
                        details: 'احمد خان نے مئی کی ماہانہ فیس جمع کرائی',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'کتاب جاری کی گئی',
                        date: new Date(new Date().setDate(new Date().getDate() - 3)).toISOString(),
                        type: 'لائبریری',
                        user: 'محمد صدیق',
                        userId: 3,
                        details: 'طالب علم عمر نے کتاب "ریاض الصالحین" جاری کرائی',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'تنخواہ ادا کی گئی',
                        date: new Date(new Date().setDate(new Date().getDate() - 5)).toISOString(),
                        type: 'تنخواہ',
                        user: 'محمد عارف',
                        userId: 4,
                        details: 'اساتذہ کی مئی ماہ کی تنخواہیں ادا کی گئیں',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'امتحانی نتائج کا اعلان',
                        date: new Date(new Date().setDate(new Date().getDate() - 7)).toISOString(),
                        type: 'امتحان',
                        user: 'سسٹم ایڈمن',
                        userId: 1,
                        details: 'ماہانہ امتحانات کے نتائج کا اعلان کیا گیا',
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const activityData of activitiesData) {
                    await addToStore(STORES.ACTIVITIES, activityData);
                }
                await loadDropdownData();
                await loadDashboardData();
                console.log('Sample data loaded successfully');
                showNotification('سیمپل ڈیٹا کامیابی سے لوڈ ہو گیا ہے', 'success');
            } catch (error) {
                console.error('Error loading sample data:', error);
                showNotification('سیمپل ڈیٹا لوڈنگ میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        function setupFormHandlers() {
            document.getElementById('student-form').addEventListener('submit', function (e) { e.preventDefault(); addStudent(); });
            document.getElementById('teacher-form').addEventListener('submit', function (e) { e.preventDefault(); addTeacher(); });
            document.getElementById('staff-form').addEventListener('submit', function (e) { e.preventDefault(); addStaff(); });
            document.getElementById('class-form').addEventListener('submit', function (e) { e.preventDefault(); addClass(); });
            document.getElementById('subject-form').addEventListener('submit', function (e) { e.preventDefault(); addSubject(); });
            document.getElementById('save-class-subject').addEventListener('click', saveClassSubject);
            document.getElementById('save-section').addEventListener('click', saveSection);
            document.getElementById('attendance-form').addEventListener('submit', function (e) { e.preventDefault(); saveAttendance(); });
            document.getElementById('exam-form').addEventListener('submit', function (e) { e.preventDefault(); addExam(); });
            document.getElementById('marks-form').addEventListener('submit', function (e) { e.preventDefault(); saveMarks(); });
            document.getElementById('fee-form').addEventListener('submit', function (e) { e.preventDefault(); collectFee(); });
            document.getElementById('fee-structure-form').addEventListener('submit', function (e) { e.preventDefault(); saveFeeStructure(); });
            document.getElementById('salary-form').addEventListener('submit', function (e) { e.preventDefault(); paySalary(); });
            document.getElementById('save-salary-structure').addEventListener('click', saveSalaryStructure);
            document.getElementById('book-form').addEventListener('submit', function (e) { e.preventDefault(); addBook(); });
            document.getElementById('issue-form').addEventListener('submit', function (e) { e.preventDefault(); issueBook(); });
            document.getElementById('return-form').addEventListener('submit', function (e) { e.preventDefault(); returnBook(); });
            document.getElementById('user-form').addEventListener('submit', function (e) { e.preventDefault(); addUser(); });
            document.getElementById('role-form').addEventListener('submit', function (e) { e.preventDefault(); addRole(); });
        }
        function setCurrentDateDefaults() {
            const today = new Date().toISOString().split('T');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            document.querySelectorAll('input[id$="-year"]').forEach(input => {
                if (!input.value) {
                    input.value = currentYear;
                }
            });
            document.querySelectorAll('select[id$="-month"]').forEach(select => {
                if (!select.value) {
                    const options = select.querySelectorAll('option');
                    options.forEach(option => {
                        if (option.value == currentMonth) {
                            option.selected = true;
                        }
                    });
                }
            });
        }
        async function loadSchoolSettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                document.getElementById('school-name').value = settings.schoolName || '';
                document.getElementById('principal-name').value = settings.principalName || '';
                document.getElementById('school-address').value = settings.schoolAddress || '';
                document.getElementById('school-contact').value = settings.schoolPhone || '';
                document.getElementById('school-email').value = settings.schoolEmail || '';
                document.getElementById('auto-backup-freq').value = settings.autoBackupFrequency || 'daily';
                document.getElementById('system-language').value = settings.language || 'ur';
            } catch (e) {
                console.error("Error loading school settings:", e);
            }
        }
        async function populateLibraryDropdowns() {
            try {
                const books = await getAllFromStore(STORES.BOOKS);
                const students = await getAllFromStore(STORES.STUDENTS);
                const issued = await getAllFromStore(STORES.BOOK_ISSUES);
                const bookSelect = document.getElementById('issue-book-select');
                bookSelect.innerHTML = '<option value="">کتاب منتخب کریں</option>';
                books.forEach(book => {
                    if (book.availableCopies > 0) {
                        bookSelect.innerHTML += `<option value="${book.id}">${book.name}</option>`;
                    }
                });
                const studentSelect = document.getElementById('issue-student-select');
                studentSelect.innerHTML = '<option value="">طالب علم منتخب کریں</option>';
                students.forEach(student => {
                    studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.rollNumber})</option>`;
                });
                const returnSelect = document.getElementById('return-book-select');
                returnSelect.innerHTML = '<option value="">جاری شدہ کتاب منتخب کریں</option>';
                const activeIssues = issued.filter(i => i.status === 'issued');
                for (const issue of activeIssues) {
                    const book = books.find(b => b.id === issue.bookId);
                    const student = students.find(s => s.id === issue.studentId);
                    if (book && student) {
                        returnSelect.innerHTML += `<option value="${issue.id}">${book.name} - جاری: ${student.name}</option>`;
                    }
                }
            } catch (e) {
                console.error("Error populating library dropdowns:", e);
            }
        }
        async function loadSchoolSettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                document.getElementById('school-name').value = settings.schoolName || '';
                document.getElementById('principal-name').value = settings.principalName || '';
                document.getElementById('school-address').value = settings.schoolAddress || '';
                document.getElementById('school-contact').value = settings.schoolPhone || '';
                document.getElementById('school-email').value = settings.schoolEmail || '';
                document.getElementById('auto-backup-freq').value = settings.autoBackupFrequency || 'daily';
                document.getElementById('system-language').value = settings.language || 'ur';
            } catch (e) {
                console.error("Error loading school settings:", e);
            }
        }
        async function populateLibraryDropdowns() {
            try {
                const [books, students, issued] = await Promise.all([
                    getAllFromStore(STORES.BOOKS),
                    getAllFromStore(STORES.STUDENTS),
                    getAllFromStore(STORES.BOOK_ISSUES)
                ]);
                const bookSelect = document.getElementById('issue-book-select');
                bookSelect.innerHTML = '<option value="">کتاب منتخب کریں</option>';
                books.forEach(book => {
                    if (book.availableCopies > 0) {
                        bookSelect.innerHTML += `<option value="${book.id}">${book.name}</option>`;
                    }
                });
                const studentSelect = document.getElementById('issue-student-select');
                studentSelect.innerHTML = '<option value="">طالب علم منتخب کریں</option>';
                students.forEach(student => {
                    studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.rollNumber})</option>`;
                });
                const returnSelect = document.getElementById('return-book-select');
                returnSelect.innerHTML = '<option value="">جاری شدہ کتاب منتخب کریں</option>';
                const activeIssues = issued.filter(i => i.status === 'issued');
                for (const issue of activeIssues) {
                    const book = books.find(b => b.id === issue.bookId);
                    const student = students.find(s => s.id === issue.studentId);
                    if (book && student) {
                        returnSelect.innerHTML += `<option value="${issue.id}">${book.name} - جاری: ${student.name}</option>`;
                    }
                }
            } catch (e) {
                console.error("Error populating library dropdowns:", e);
            }
        }
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ur-PK', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('ur-PK', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        function formatCurrency(amount) {
            return amount.toLocaleString('ur-PK') + ' روپے';
        }
        function calculateSalaryTotal() {
            const basicSalary = parseFloat(document.getElementById('salary-payment-basic').value) || 0;
            const allowances = parseFloat(document.getElementById('salary-payment-allowances').value) || 0;
            const bonus = parseFloat(document.getElementById('salary-payment-bonus').value) || 0;
            const deductions = parseFloat(document.getElementById('salary-payment-deductions').value) || 0;
            const absenceDeduction = parseFloat(document.getElementById('salary-payment-absence').value) || 0;
            const tax = parseFloat(document.getElementById('salary-payment-tax').value) || 0;
            const totalSalary = basicSalary + allowances + bonus - deductions - absenceDeduction - tax;
            document.getElementById('salary-payment-total').value = totalSalary;
        }
        function calculateFeeTotal() {
            const feeAmount = parseFloat(document.getElementById('fee-amount').value) || 0;
            const fine = parseFloat(document.getElementById('fee-fine').value) || 0;
            const discount = parseFloat(document.getElementById('fee-discount').value) || 0;
            const totalFee = feeAmount + fine - discount;
            document.getElementById('fee-total').value = totalFee;
        }
        function getFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function getAllFromStore(storeName, limit = null) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => {
                    let results = request.result;
                    if (limit && typeof limit === 'number') {
                        results = results.slice(0, limit);
                    }
                    resolve(results);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function getAllFromIndex(storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = value ? index.getAll(value) : index.getAll();
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function addToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function updateInStore(storeName, id, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const getRequest = store.get(id);
                getRequest.onsuccess = () => {
                    const existingData = getRequest.result;
                    if (!existingData) {
                        reject(new Error('Item not found'));
                        return;
                    }
                    const updatedData = { ...existingData, ...data };
                    const updateRequest = store.put(updatedData);
                    updateRequest.onsuccess = () => {
                        resolve(updateRequest.result);
                    };
                    updateRequest.onerror = () => {
                        reject(updateRequest.error);
                    };
                };
                getRequest.onerror = () => {
                    reject(getRequest.error);
                };
            });
        }
        function deleteFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => {
                    resolve(true);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function getCount(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.count();
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        async function getStudentByRollNumber(rollNumber) {
            try {
                const transaction = db.transaction(STORES.STUDENTS, 'readonly');
                const store = transaction.objectStore(STORES.STUDENTS);
                const index = store.index('rollNumber');
                const request = index.get(rollNumber);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error getting student by roll number:', error);
                throw error;
            }
        }
        function toggleFeeReportFields() {
            const reportType = document.getElementById('fee-report-type').value;
            document.getElementById('fee-report-date-row').style.display = 'none';
            document.getElementById('fee-report-month-row').style.display = 'none';
            document.getElementById('fee-report-class-row').style.display = 'none';
            switch (reportType) {
                case 'daily':
                    document.getElementById('fee-report-date-row').style.display = 'flex';
                    break;
                case 'monthly':
                    document.getElementById('fee-report-month-row').style.display = 'flex';
                    break;
                case 'yearly':
                    document.getElementById('fee-report-year').parentElement.parentElement.style.display = 'flex';
                    break;
                case 'class':
                    document.getElementById('fee-report-class-row').style.display = 'flex';
                    document.getElementById('fee-report-month-row').style.display = 'flex';
                    break;
            }
        }
        function toggleSalaryReportFields() {
            const reportType = document.getElementById('salary-report-type').value;
            document.getElementById('salary-report-month-row').style.display = 'none';
            document.getElementById('salary-report-employee-row').style.display = 'none';
            switch (reportType) {
                case 'monthly':
                    document.getElementById('salary-report-month-row').style.display = 'flex';
                    break;
                case 'yearly':
                    document.getElementById('salary-report-year').parentElement.parentElement.style.display = 'flex';
                    break;
                case 'employee':
                    document.getElementById('salary-report-employee-row').style.display = 'flex';
                    loadEmployeesForSalaryReport();
                    break;
            }
        }
        async function loadEmployeesForSalaryStructure() {
            try {
                const employeeType = document.getElementById('structure-employee-type').value;
                const dropdown = document.getElementById('structure-employee');
                dropdown.innerHTML = '';
                let employees;
                if (employeeType === 'teacher') {
                    employees = await getAllFromStore(STORES.TEACHERS);
                } else {
                    employees = await getAllFromStore(STORES.STAFF);
                }
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    dropdown.appendChild(option);
                });
                console.log(`Loaded ${employees.length} employees for salary structure`);
            } catch (error) {
                console.error('Error loading employees for salary structure:', error);
                showNotification('تنخواہ سٹرکچر کے لیے ملازمین لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function loadEmployeesForSalaryReport() {
            try {
                const employeeType = document.getElementById('salary-report-employee-type').value;
                const dropdown = document.getElementById('salary-report-employee');
                dropdown.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'تمام ملازمین';
                dropdown.appendChild(allOption);
                if (employeeType === 'all') {
                    const teachers = await getAllFromStore(STORES.TEACHERS);
                    const staff = await getAllFromStore(STORES.STAFF);
                    const teachersGroup = document.createElement('optgroup');
                    teachersGroup.label = 'اساتذہ';
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = `teacher_${teacher.id}`;
                        option.textContent = teacher.name;
                        teachersGroup.appendChild(option);
                    });
                    dropdown.appendChild(teachersGroup);
                    const staffGroup = document.createElement('optgroup');
                    staffGroup.label = 'عملہ';
                    staff.forEach(staffMember => {
                        const option = document.createElement('option');
                        option.value = `staff_${staffMember.id}`;
                        option.textContent = staffMember.name;
                        staffGroup.appendChild(option);
                    });
                    dropdown.appendChild(staffGroup);
                } else if (employeeType === 'teacher') {
                    const teachers = await getAllFromStore(STORES.TEACHERS);
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = teacher.name;
                        dropdown.appendChild(option);
                    });
                } else {
                    const staff = await getAllFromStore(STORES.STAFF);
                    staff.forEach(staffMember => {
                        const option = document.createElement('option');
                        option.value = staffMember.id;
                        option.textContent = staffMember.name;
                        dropdown.appendChild(option);
                    });
                }
                console.log('Employees loaded for salary report');
            } catch (error) {
                console.error('Error loading employees for salary report:', error);
                showNotification('تنخواہ رپورٹ کے لیے ملازمین لوڈنگ میں خرابی ہوئی ہے', 'error');
            }
        }
        async function addStaff() {
            showLoading();
            const form = document.getElementById('staff-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const staffData = {
                    name: document.getElementById('staff-name').value,
                    fatherName: document.getElementById('staff-father').value,
                    dob: document.getElementById('staff-dob').value,
                    gender: document.getElementById('staff-gender').value,
                    designation: document.getElementById('staff-designation').value,
                    department: document.getElementById('staff-department').value,
                    qualification: document.getElementById('staff-qualification').value,
                    responsibilities: document.getElementById('staff-responsibilities').value,
                    contact: document.getElementById('staff-contact').value,
                    email: document.getElementById('staff-email').value,
                    address: document.getElementById('staff-address').value,
                    cnic: document.getElementById('staff-cnic').value,
                    joiningDate: document.getElementById('staff-joining-date').value,
                    basicSalary: parseFloat(document.getElementById('staff-basic-salary').value),
                    allowances: parseFloat(document.getElementById('staff-allowances').value) || 0,
                    deductions: parseFloat(document.getElementById('staff-deductions').value) || 0,
                    notes: document.getElementById('staff-notes').value,
                };
                if (editId) {
                    await updateInStore(STORES.STAFF, editId, staffData);
                    showNotification('عملے کا ریکارڈ اپڈیٹ کر دیا گیا۔', 'success');
                } else {
                    const staffCount = await getCount(STORES.STAFF);
                    staffData.employeeId = 'S' + String(staffCount + 1).padStart(3, '0');
                    await addToStore(STORES.STAFF, staffData);
                    showNotification('عملہ کامیابی سے داخل کر لیا گیا ہے۔', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'عملہ داخل کریں';
                document.querySelector('.tab[data-tab="staff-list"]').click();
            } catch (error) {
                console.error('Error saving staff:', error);
                showNotification('عملے کو محفوظ کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addTeacher() {
            try {
                showLoading();
                const name = document.getElementById('teacher-name').value;
                const fatherName = document.getElementById('teacher-father').value;
                const dob = document.getElementById('teacher-dob').value;
                const gender = document.getElementById('teacher-gender').value;
                const qualification = document.getElementById('teacher-qualification').value;
                const specialization = document.getElementById('teacher-specialization').value;
                const subjects = Array.from(document.getElementById('teacher-subject').selectedOptions).map(option => option.value);
                const classes = Array.from(document.getElementById('teacher-class').selectedOptions).map(option => option.value);
                const contact = document.getElementById('teacher-contact').value;
                const email = document.getElementById('teacher-email').value;
                const address = document.getElementById('teacher-address').value;
                const cnic = document.getElementById('teacher-cnic').value;
                const photoInput = document.getElementById('teacher-photo');
                const joiningDate = document.getElementById('teacher-joining-date').value;
                const basicSalary = document.getElementById('teacher-basic-salary').value;
                const allowances = document.getElementById('teacher-allowances').value;
                const deductions = document.getElementById('teacher-deductions').value;
                const notes = document.getElementById('teacher-notes').value;
                const teachersCount = await getCount(STORES.TEACHERS);
                const employeeId = 'T' + String(teachersCount + 1).padStart(3, '0');
                let photo = null;
                if (photoInput.files && photoInput.files) {
                    photo = await fileToBase64(photoInput.files);
                }
                const teacherData = {
                    employeeId: employeeId,
                    name: name,
                    fatherName: fatherName,
                    gender: gender,
                    dob: dob,
                    qualification: qualification,
                    specialization: specialization,
                    subjects: subjects,
                    classes: classes,
                    contact: contact,
                    email: email,
                    address: address,
                    cnic: cnic,
                    photo: photo,
                    joiningDate: joiningDate,
                    basicSalary: parseFloat(basicSalary),
                    allowances: parseFloat(allowances) || 0,
                    deductions: parseFloat(deductions) || 0,
                    notes: notes,
                    createdAt: new Date().toISOString()
                };
                const teacherId = await addToStore(STORES.TEACHERS, teacherData);
                await addToStore(STORES.SALARY_STRUCTURE, {
                    employeeId: teacherId,
                    employeeType: 'teacher',
                    basicSalary: parseFloat(basicSalary),
                    houseRent: parseFloat(basicSalary) * 0.45,
                    transport: 2000,
                    medical: 1500,
                    otherAllowances: parseFloat(allowances) || 0,
                    deductions: parseFloat(deductions) || 0,
                    createdAt: new Date().toISOString()
                });
                await addToStore(STORES.ACTIVITIES, {
                    description: 'نیا استاد داخل کیا گیا',
                    date: new Date().toISOString(),
                    type: 'بھرتی',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `${name} (${employeeId}) کو بطور استاد بھرتی کیا گیا`,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('teacher-form').reset();
                loadTeachersTable();
                loadTeacherDropdowns();
                showNotification('استاد کامیابی سے داخل کر لیا گیا ہے', 'success');
                document.querySelector('.tab[data-tab="teachers-list"]').click();
            } catch (error) {
                console.error('Error adding teacher:', error);
                showNotification('استاد داخل کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addClass() {
            showLoading();
            const form = document.getElementById('class-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const classData = {
                    name: document.getElementById('class-name').value,
                    inChargeId: parseInt(document.getElementById('class-incharge').value),
                    level: document.getElementById('class-level').value,
                    roomNumber: document.getElementById('class-room').value,
                    feeCategory: document.getElementById('class-fee-category').value,
                    monthlyFee: parseFloat(document.getElementById('class-monthly-fee').value),
                    admissionFee: parseFloat(document.getElementById('class-admission-fee').value),
                    notes: document.getElementById('class-notes').value,
                };
                if (editId) {
                    await updateInStore(STORES.CLASSES, editId, classData);
                    showNotification('کلاس کا ریکارڈ اپڈیٹ کر دیا گیا۔', 'success');
                } else {
                    const newClassId = await addToStore(STORES.CLASSES, classData);
                    const sections = Array.from(document.getElementById('class-sections').selectedOptions).map(opt => opt.value);
                    for (const sectionName of sections) {
                        await addToStore(STORES.SECTIONS, { classId: newClassId, name: sectionName, inChargeId: null });
                    }
                    showNotification('کلاس کامیابی سے بنا لی گئی ہے۔', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'کلاس داخل کریں';
                document.querySelector('.tab[data-tab="classes-list"]').click();
                loadDropdownData();
            } catch (error) { console.error('Error saving class:', error); } finally { hideLoading(); }
        }
        async function addSubject() {
            showLoading();
            const form = document.getElementById('subject-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const subjectData = {
                    name: document.getElementById('subject-name').value,
                    code: document.getElementById('subject-code').value,
                    type: document.getElementById('subject-type').value,
                    periods: parseInt(document.getElementById('subject-periods').value),
                    details: document.getElementById('subject-details').value,
                };
                if (editId) {
                    await updateInStore(STORES.SUBJECTS, editId, subjectData);
                    showNotification('مضمون کا ریکارڈ اپڈیٹ کر دیا گیا۔', 'success');
                } else {
                    await addToStore(STORES.SUBJECTS, subjectData);
                    showNotification('مضمون کامیابی سے بنا لیا گیا ہے۔', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'مضمون داخل کریں';
                document.querySelector('.tab[data-tab="subjects-list"]').click();
                loadDropdownData();
            } catch (error) { console.error('Error saving subject:', error); } finally { hideLoading(); }
        }
        async function saveClassSubject() {
            try {
                showLoading();
                const classId = document.getElementById('class-subject-class').value;
                const subjectId = document.getElementById('class-subject-subject').value;
                const teacherId = document.getElementById('class-subject-teacher').value;
                if (!classId || !subjectId || !teacherId) {
                    showNotification('برائے مہربانی تمام فیلڈز پر کریں', 'error');
                    return;
                }
                const classData = await getFromStore(STORES.CLASSES, parseInt(classId));
                const subjectData = await getFromStore(STORES.SUBJECTS, parseInt(subjectId));
                const teacherData = await getFromStore(STORES.TEACHERS, parseInt(teacherId));
                const existingClassSubjects = await getAllFromStore(STORES.CLASS_SUBJECTS);
                const existingRecord = existingClassSubjects.find(record =>
                    record.classId === parseInt(classId) && record.subjectId === parseInt(subjectId)
                );
                if (existingRecord) {
                    await updateInStore(STORES.CLASS_SUBJECTS, existingRecord.id, {
                        teacherId: parseInt(teacherId),
                        teacherName: teacherData ? teacherData.name : '',
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('کلاس مضمون کامیابی سے اپڈیٹ کر دیا گیا ہے', 'success');
                } else {
                    const classSubjectData = {
                        classId: parseInt(classId),
                        className: classData ? classData.name : '',
                        subjectId: parseInt(subjectId),
                        subjectName: subjectData ? subjectData.name : '',
                        teacherId: parseInt(teacherId),
                        teacherName: teacherData ? teacherData.name : '',
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.CLASS_SUBJECTS, classSubjectData);
                    showNotification('کلاس مضمون کامیابی سے محفوظ کر لیا گیا ہے', 'success');
                }
                loadClassSubjectsTable();
            } catch (error) {
                console.error('Error saving class subject:', error);
                showNotification('کلاس مضمون محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveSection() {
            try {
                showLoading();
                const classId = document.getElementById('section-class').value;
                const sectionName = document.getElementById('section-name').value;
                const inChargeId = document.getElementById('section-incharge').value;
                if (!classId || !sectionName || !inChargeId) {
                    showNotification('برائے مہربانی تمام فیلڈز پر کریں', 'error');
                    return;
                }
                const existingSections = await getAllFromStore(STORES.SECTIONS);
                const existingSection = existingSections.find(section =>
                    section.classId === parseInt(classId) && section.name === sectionName
                );
                if (existingSection) {
                    await updateInStore(STORES.SECTIONS, existingSection.id, {
                        inChargeId: parseInt(inChargeId),
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('سیکشن کامیابی سے اپڈیٹ کر دیا گیا ہے', 'success');
                } else {
                    const sectionData = {
                        classId: parseInt(classId),
                        name: sectionName,
                        inChargeId: parseInt(inChargeId),
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.SECTIONS, sectionData);
                    showNotification('سیکشن کامیابی سے محفوظ کر لیا گیا ہے', 'success');
                }
                loadSectionsTable();
            } catch (error) {
                console.error('Error saving section:', error);
                showNotification('سیکشن محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveAttendance() {
            try {
                showLoading();
                const date = document.getElementById('attendance-date').value;
                const classId = parseInt(document.getElementById('attendance-class').value);
                const sectionId = parseInt(document.getElementById('attendance-section').value);
                const table = document.getElementById('attendance-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                const attendanceData = [];
                for (const row of rows) {
                    const studentId = parseInt(row.getAttribute('data-student-id'));
                    const statusRadios = row.querySelectorAll('input[name="status_' + studentId + '"]');
                    let status = '';
                    for (const radio of statusRadios) {
                        if (radio.checked) {
                            status = radio.value;
                            break;
                        }
                    }
                    const isLate = row.querySelector('input[name="late_' + studentId + '"]').checked;
                    const isLeave = row.querySelector('input[name="leave_' + studentId + '"]').checked;
                    const notes = row.querySelector('input[name="notes_' + studentId + '"]').value;
                    attendanceData.push({
                        date: date,
                        classId: classId,
                        sectionId: sectionId,
                        studentId: studentId,
                        status: status,
                        isLate: isLate,
                        isLeave: isLeave,
                        notes: notes,
                        createdAt: new Date().toISOString()
                    });
                }
                const existingAttendance = await getAllFromIndex(STORES.ATTENDANCE, 'dateClassSection', [date, classId, sectionId]);
                if (existingAttendance && existingAttendance.length > 0) {
                    for (const record of existingAttendance) {
                        await deleteFromStore(STORES.ATTENDANCE, record.id);
                    }
                }
                for (const record of attendanceData) {
                    await addToStore(STORES.ATTENDANCE, record);
                }
                await addToStore(STORES.ACTIVITIES, {
                    description: 'حاضری محفوظ کی گئی',
                    date: new Date().toISOString(),
                    type: 'حاضری',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `تاریخ ${date} کے لیے کلاس اور سیکشن کی حاضری محفوظ کی گئی`,
                    createdAt: new Date().toISOString()
                });
                showNotification('حاضری کامیابی سے محفوظ کر لی گئی ہے', 'success');
                document.getElementById('attendance-table-container').style.display = 'none';
                document.querySelector('.tab[data-tab="view-attendance"]').click();
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('حاضری محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addExam() {
            try {
                showLoading();
                const name = document.getElementById('exam-name').value;
                const type = document.getElementById('exam-type').value;
                const startDate = document.getElementById('exam-start-date').value;
                const endDate = document.getElementById('exam-end-date').value;
                const classes = Array.from(document.getElementById('exam-classes').selectedOptions).map(option => parseInt(option.value));
                const passingPercent = document.getElementById('exam-passing-percent').value;
                const details = document.getElementById('exam-details').value;
                const examData = {
                    name: name,
                    type: type,
                    startDate: startDate,
                    endDate: endDate,
                    classes: classes,
                    passingPercent: parseInt(passingPercent),
                    details: details,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                const examId = await addToStore(STORES.EXAMS, examData);
                await addToStore(STORES.ACTIVITIES, {
                    description: 'نیا امتحان بنایا گیا',
                    date: new Date().toISOString(),
                    type: 'امتحان',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `${name} امتحان بنایا گیا، جو ${startDate} سے ${endDate} تک منعقد ہوگا`,
                    createdAt: new Date().toISOString()
                });
                await addToStore(STORES.EVENTS, {
                    title: `${name} - ${type}`,
                    date: startDate,
                    location: 'مدرسہ',
                    type: 'امتحان',
                    description: `${name} امتحان شروع ہوگا`,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('exam-form').reset();
                loadExamsTable();
                showNotification('امتحان کامیابی سے بنا لیا گیا ہے', 'success');
                document.querySelector('.tab[data-tab="exams-list"]').click();
            } catch (error) {
                console.error('Error adding exam:', error);
                showNotification('امتحان بنانے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveMarks() {
            try {
                showLoading();
                const examId = parseInt(document.getElementById('marks-exam').value);
                const classId = parseInt(document.getElementById('marks-class').value);
                const sectionId = parseInt(document.getElementById('marks-section').value);
                const subjectId = parseInt(document.getElementById('marks-subject').value);
                const totalMarks = parseInt(document.getElementById('marks-total').value);
                const table = document.getElementById('marks-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                const marksData = [];
                for (const row of rows) {
                    const studentId = parseInt(row.getAttribute('data-student-id'));
                    const obtainedMarks = parseFloat(row.querySelector('input[name="marks_' + studentId + '"]').value);
                    const percentage = (obtainedMarks / totalMarks) * 100;
                    let grade = '';
                    if (percentage >= 90) grade = 'A+';
                    else if (percentage >= 80) grade = 'A';
                    else if (percentage >= 70) grade = 'B';
                    else if (percentage >= 60) grade = 'C';
                    else if (percentage >= 50) grade = 'D';
                    else if (percentage >= 33) grade = 'E';
                    else grade = 'F';
                    const notes = row.querySelector('input[name="notes_' + studentId + '"]').value;
                    marksData.push({
                        examId: examId,
                        classId: classId,
                        sectionId: sectionId,
                        subjectId: subjectId,
                        studentId: studentId,
                        totalMarks: totalMarks,
                        obtainedMarks: obtainedMarks,
                        percentage: percentage,
                        grade: grade,
                        isPassed: percentage >= 33,
                        notes: notes,
                        createdAt: new Date().toISOString()
                    });
                }
                for (const markRecord of marksData) {
                    const existingMarks = await getAllFromIndex(STORES.MARKS, 'examStudentSubject', [markRecord.examId, markRecord.studentId, markRecord.subjectId]);
                    if (existingMarks && existingMarks.length > 0) {
                        markRecord.id = existingMarks.id;
                        await updateInStore(STORES.MARKS, existingMarks.id, markRecord);
                    } else {
                        await addToStore(STORES.MARKS, markRecord);
                    }
                }
                await addToStore(STORES.ACTIVITIES, {
                    description: 'نمبر محفوظ کیے گئے',
                    date: new Date().toISOString(),
                    type: 'امتحان',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `امتحان کے نمبر محفوظ کیے گئے`,
                    createdAt: new Date().toISOString()
                });
                showNotification('نمبر کامیابی سے محفوظ کر لیے گئے ہیں', 'success');
                document.getElementById('marks-table-container').style.display = 'none';
                document.querySelector('.tab[data-tab="result-cards"]').click();
            } catch (error) {
                console.error('Error saving marks:', error);
                showNotification('نمبر محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function collectFee() {
            try {
                showLoading();
                const studentId = parseInt(document.getElementById('fee-roll-number').getAttribute('data-student-id'));
                const studentName = document.getElementById('fee-student-name').value;
                const month = document.getElementById('fee-month').value;
                const year = parseInt(document.getElementById('fee-year').value);
                const amount = parseFloat(document.getElementById('fee-amount').value);
                const fine = parseFloat(document.getElementById('fee-fine').value) || 0;
                const discount = parseFloat(document.getElementById('fee-discount').value) || 0;
                const total = parseFloat(document.getElementById('fee-total').value);
                const paymentDate = document.getElementById('fee-payment-date').value;
                const paymentMethod = document.getElementById('fee-payment-method').value;
                const notes = document.getElementById('fee-notes').value;
                const receiptNumber = 'FEE' + Date.now().toString().slice(-6);
                const feeData = {
                    receiptNumber: receiptNumber,
                    studentId: studentId,
                    studentName: studentName,
                    month: month,
                    year: year,
                    amount: amount,
                    fine: fine,
                    discount: discount,
                    total: total,
                    date: paymentDate,
                    paymentMethod: paymentMethod,
                    notes: notes,
                    createdAt: new Date().toISOString()
                };
                const existingFee = await getAllFromIndex(STORES.FEES, 'studentMonthYear', [studentId, month, year]);
                if (existingFee && existingFee.length > 0) {
                    showNotification('اس مہینے کی فیس پہلے ہی جمع کروائی جا چکی ہے', 'error');
                    return;
                }
                const feeId = await addToStore(STORES.FEES, feeData);
                await addToStore(STORES.ACTIVITIES, {
                    description: 'فیس جمع کی گئی',
                    date: new Date().toISOString(),
                    type: 'فیس',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `${studentName} نے ${month} ${year} کی فیس ${total} روپے جمع کروائی`,
                    createdAt: new Date().toISOString()
                });
                await loadFeeHistory(studentId);
                showNotification('فیس کامیابی سے جمع کروا لی گئی ہے', 'success');
                document.getElementById('print-receipt').disabled = false;
            } catch (error) {
                console.error('Error collecting fee:', error);
                showNotification('فیس جمع کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveFeeStructure() {
            try {
                showLoading();
                const classId = parseInt(document.getElementById('fee-structure-class').value);
                const category = document.getElementById('fee-structure-category').value;
                const monthlyFee = parseFloat(document.getElementById('fee-structure-monthly').value);
                const admissionFee = parseFloat(document.getElementById('fee-structure-admission').value);
                const examFee = parseFloat(document.getElementById('fee-structure-exam').value);
                const computerFee = parseFloat(document.getElementById('fee-structure-computer').value) || 0;
                const transportFee = parseFloat(document.getElementById('fee-structure-transport').value) || 0;
                const otherFee = parseFloat(document.getElementById('fee-structure-other').value) || 0;
                const details = document.getElementById('fee-structure-details').value;
                const existingStructure = await getAllFromIndex(STORES.FEE_STRUCTURE, 'classCategory', [classId, category]);
                if (existingStructure && existingStructure.length > 0) {
                    await updateInStore(STORES.FEE_STRUCTURE, existingStructure.id, {
                        monthlyFee: monthlyFee,
                        admissionFee: admissionFee,
                        examFee: examFee,
                        computerFee: computerFee,
                        transportFee: transportFee,
                        otherFee: otherFee,
                        details: details,
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('فیس سٹرکچر کامیابی سے اپڈیٹ کر دیا گیا ہے', 'success');
                } else {
                    const feeStructureData = {
                        classId: classId,
                        category: category,
                        monthlyFee: monthlyFee,
                        admissionFee: admissionFee,
                        examFee: examFee,
                        computerFee: computerFee,
                        transportFee: transportFee,
                        otherFee: otherFee,
                        details: details,
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.FEE_STRUCTURE, feeStructureData);
                    showNotification('فیس سٹرکچر کامیابی سے محفوظ کر لیا گیا ہے', 'success');
                }
                loadFeeStructureTable();
            } catch (error) {
                console.error('Error saving fee structure:', error);
                showNotification('فیس سٹرکچر محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function paySalary() {
            try {
                showLoading();
                const employeeType = document.getElementById('salary-employee-type').value;
                const employeeId = parseInt(document.getElementById('salary-employee-id').getAttribute('data-employee-id'));
                const employeeName = document.getElementById('salary-employee-name').value;
                const month = document.getElementById('salary-month').value;
                const year = parseInt(document.getElementById('salary-year').value);
                const basicSalary = parseFloat(document.getElementById('salary-payment-basic').value);
                const allowances = parseFloat(document.getElementById('salary-payment-allowances').value) || 0;
                const bonus = parseFloat(document.getElementById('salary-payment-bonus').value) || 0;
                const deductions = parseFloat(document.getElementById('salary-payment-deductions').value) || 0;
                const absenceDeduction = parseFloat(document.getElementById('salary-payment-absence').value) || 0;
                const tax = parseFloat(document.getElementById('salary-payment-tax').value) || 0;
                const total = parseFloat(document.getElementById('salary-payment-total').value);
                const paymentDate = document.getElementById('salary-payment-date').value;
                const paymentMethod = document.getElementById('salary-payment-method').value;
                const transactionId = document.getElementById('salary-payment-transaction').value;
                const notes = document.getElementById('salary-payment-notes').value;
                const voucherNumber = 'SAL' + Date.now().toString().slice(-6);
                const salaryData = {
                    voucherNumber: voucherNumber,
                    employeeId: employeeId,
                    employeeType: employeeType,
                    employeeName: employeeName,
                    month: month,
                    year: year,
                    basicSalary: basicSalary,
                    allowances: allowances,
                    bonus: bonus,
                    deductions: deductions,
                    absenceDeduction: absenceDeduction,
                    tax: tax,
                    total: total,
                    date: paymentDate,
                    paymentMethod: paymentMethod,
                    transactionId: transactionId,
                    notes: notes,
                    createdAt: new Date().toISOString()
                };
                const existingSalary = await getAllFromIndex(STORES.SALARY, 'employeeMonthYear', [employeeId, month, year]);
                if (existingSalary && existingSalary.length > 0) {
                    showNotification('اس مہینے کی تنخواہ پہلے ہی ادا کی جا چکی ہے', 'error');
                    return;
                }
                const salaryId = await addToStore(STORES.SALARY, salaryData);
                await addToStore(STORES.ACTIVITIES, {
                    description: 'تنخواہ ادا کی گئی',
                    date: new Date().toISOString(),
                    type: 'تنخواہ',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `${employeeName} کو ${month} ${year} کی تنخواہ ${total} روپے ادا کی گئی`,
                    createdAt: new Date().toISOString()
                });
                await loadSalaryHistory(employeeId, employeeType);
                showNotification('تنخواہ کامیابی سے ادا کر دی گئی ہے', 'success');
                document.getElementById('print-salary-slip').disabled = false;
            } catch (error) {
                console.error('Error paying salary:', error);
                showNotification('تنخواہ ادا کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveSalaryStructure() {
            try {
                showLoading();
                const employeeType = document.getElementById('structure-employee-type').value;
                const employeeId = parseInt(document.getElementById('structure-employee').value);
                const basicSalary = parseFloat(document.getElementById('structure-basic-salary').value);
                const houseRent = parseFloat(document.getElementById('structure-house-rent').value) || 0;
                const transport = parseFloat(document.getElementById('structure-transport').value) || 0;
                const medical = parseFloat(document.getElementById('structure-medical').value) || 0;
                const otherAllowances = parseFloat(document.getElementById('structure-other-allowances').value) || 0;
                const deductions = parseFloat(document.getElementById('structure-deductions').value) || 0;
                const totalSalary = parseFloat(document.getElementById('structure-total-salary').value);
                const details = document.getElementById('structure-details').value;
                const existingStructure = await getAllFromIndex(STORES.SALARY_STRUCTURE, 'employeeTypeId', [employeeType, employeeId]);
                if (existingStructure && existingStructure.length > 0) {
                    await updateInStore(STORES.SALARY_STRUCTURE, existingStructure.id, {
                        basicSalary: basicSalary,
                        houseRent: houseRent,
                        transport: transport,
                        medical: medical,
                        otherAllowances: otherAllowances,
                        deductions: deductions,
                        totalSalary: totalSalary,
                        details: details,
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('تنخواہ سٹرکچر کامیابی سے اپڈیٹ کر دیا گیا ہے', 'success');
                } else {
                    const salaryStructureData = {
                        employeeId: employeeId,
                        employeeType: employeeType,
                        basicSalary: basicSalary,
                        houseRent: houseRent,
                        transport: transport,
                        medical: medical,
                        otherAllowances: otherAllowances,
                        deductions: deductions,
                        totalSalary: totalSalary,
                        details: details,
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.SALARY_STRUCTURE, salaryStructureData);
                    showNotification('تنخواہ سٹرکچر کامیابی سے محفوظ کر لیا گیا ہے', 'success');
                }
                loadSalaryStructureTable();
            } catch (error) {
                console.error('Error saving salary structure:', error);
                showNotification('تنخواہ سٹرکچر محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addBook() {
            showLoading();
            const form = document.getElementById('add-book-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const bookData = {
                    name: document.getElementById('book-name').value,
                    author: document.getElementById('book-author').value,
                    category: document.getElementById('book-category').value,
                    isbn: document.getElementById('book-isbn').value,
                    copies: parseInt(document.getElementById('book-copies').value),
                    shelf: document.getElementById('book-shelf').value,
                };
                if (editId) {
                    const existingBook = await getFromStore(STORES.BOOKS, editId);
                    const diff = bookData.copies - existingBook.copies;
                    bookData.availableCopies = existingBook.availableCopies + diff;
                    await updateInStore(STORES.BOOKS, editId, bookData);
                    showNotification('کتاب کا ریکارڈ اپڈیٹ کر دیا گیا۔', 'success');
                } else {
                    bookData.availableCopies = bookData.copies;
                    await addToStore(STORES.BOOKS, bookData);
                    showNotification('کتاب کامیابی سے شامل ہو گئی۔', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'کتاب شامل کریں';
                document.querySelector('.tab[data-tab="books-list"]').click();
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function issueBook() {
            try {
                showLoading();
                const bookId = parseInt(document.getElementById('issue-book-id').value);
                const memberType = document.getElementById('issue-member-type').value;
                const memberId = parseInt(document.getElementById('issue-member-id').value);
                const memberName = document.getElementById('issue-member-name').value;
                const issueDate = document.getElementById('issue-date').value;
                const returnDate = document.getElementById('issue-return-date').value;
                const bookData = await getFromStore(STORES.BOOKS, bookId);
                if (!bookData) {
                    showNotification('کتاب نہیں ملی', 'error');
                    return;
                }
                if (bookData.availableCopies <= 0) {
                    showNotification('کتاب کی کوئی کاپی دستیاب نہیں ہے', 'error');
                    return;
                }
                const issueId = 'ISU' + Date.now().toString().slice(-6);
                const issueData = {
                    issueId: issueId,
                    bookId: bookId,
                    bookName: bookData.name,
                    memberId: memberId,
                    memberName: memberName,
                    memberType: memberType,
                    issueDate: issueDate,
                    returnDate: returnDate,
                    status: 'issued',
                    actualReturnDate: null,
                    fine: 0,
                    condition: 'good',
                    notes: '',
                    createdAt: new Date().toISOString()
                };
                await addToStore(STORES.BOOK_ISSUES, issueData);
                await updateInStore(STORES.BOOKS, bookId, {
                    availableCopies: bookData.availableCopies - 1
                });
                await addToStore(STORES.ACTIVITIES, {
                    description: 'کتاب جاری کی گئی',
                    date: new Date().toISOString(),
                    type: 'لائبریری',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `${bookData.name} کتاب ${memberName} کو جاری کی گئی`,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('issue-form').reset();
                document.getElementById('issue-book-details').style.display = 'none';
                document.getElementById('issue-member-form').style.display = 'none';
                document.getElementById('issue-member-details').style.display = 'none';
                document.getElementById('issue-date-details').style.display = 'none';
                document.getElementById('issue-submit').style.display = 'none';
                showNotification('کتاب کامیابی سے جاری کر دی گئی ہے', 'success');
            } catch (error) {
                console.error('Error issuing book:', error);
                showNotification('کتاب جاری کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function returnBook() {
            try {
                showLoading();
                const issueId = document.getElementById('return-issue-id').value;
                const bookName = document.getElementById('return-book-name').value;
                const memberName = document.getElementById('return-member-name').value;
                const issueDate = document.getElementById('return-issue-date').value;
                const dueDate = document.getElementById('return-due-date').value;
                const actualDate = document.getElementById('return-actual-date').value;
                const fine = parseFloat(document.getElementById('return-fine').value) || 0;
                const condition = document.getElementById('return-condition').value;
                const damageFine = parseFloat(document.getElementById('return-damage-fine').value) || 0;
                const notes = document.getElementById('return-notes').value;
                const issues = await getAllFromStore(STORES.BOOK_ISSUES);
                const issue = issues.find(i => i.issueId === issueId);
                if (!issue) {
                    showNotification('اجراء ریکارڈ نہیں ملا', 'error');
                    return;
                }
                await updateInStore(STORES.BOOK_ISSUES, issue.id, {
                    status: 'returned',
                    actualReturnDate: actualDate,
                    fine: fine + damageFine,
                    condition: condition,
                    notes: notes,
                    updatedAt: new Date().toISOString()
                });
                const book = await getFromStore(STORES.BOOKS, issue.bookId);
                if (book) {
                    await updateInStore(STORES.BOOKS, book.id, {
                        availableCopies: book.availableCopies + 1
                    });
                }
                await addToStore(STORES.ACTIVITIES, {
                    description: 'کتاب واپس کی گئی',
                    date: new Date().toISOString(),
                    type: 'لائبریری',
                    user: 'سسٹم ایڈمن',
                    userId: 1,
                    details: `${bookName} کتاب ${memberName} نے واپس کی`,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('return-form').reset();
                document.getElementById('return-form-container').style.display = 'none';
                document.getElementById('return-book-table-container').style.display = 'none';
                showNotification('کتاب کامیابی سے واپس کر لی گئی ہے', 'success');
            } catch (error) {
                console.error('Error returning book:', error);
                showNotification('کتاب واپس کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addUser() {
            try {
                showLoading();
                const username = document.getElementById('user-username').value;
                const password = document.getElementById('user-password').value;
                const confirmPassword = document.getElementById('user-confirm-password').value;
                const name = document.getElementById('user-name').value;
                const email = document.getElementById('user-email').value;
                const role = document.getElementById('user-role').value;
                const photoInput = document.getElementById('user-photo');
                const mobile = document.getElementById('user-mobile').value;
                const status = document.getElementById('user-status').value;
                const address = document.getElementById('user-address').value;
                if (password !== confirmPassword) {
                    showNotification('پاس ورڈ میچ نہیں کرتے', 'error');
                    return;
                }
                const existingUsers = await getAllFromStore(STORES.USERS);
                const userExists = existingUsers.some(user => user.username === username || user.email === email);
                if (userExists) {
                    showNotification('یہ صارف نام یا ای میل پہلے سے موجود ہے', 'error');
                    return;
                }
                let photo = null;
                if (photoInput.files && photoInput.files) {
                    photo = await fileToBase64(photoInput.files);
                }
                const userData = {
                    username: username,
                    password: password,
                    name: name,
                    email: email,
                    role: role,
                    photo: photo,
                    mobile: mobile,
                    status: status,
                    address: address,
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                };
                const userId = await addToStore(STORES.USERS, userData);
                document.getElementById('user-form').reset();
                loadUsersTable();
                showNotification('صارف کامیابی سے بنا لیا گیا ہے', 'success');
                document.querySelector('.tab[data-tab="users-list"]').click();
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('صارف بنانے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addRole() {
            try {
                showLoading();
                const name = document.getElementById('role-name').value;
                const description = document.getElementById('role-description').value;
                const permissions = {
                    dashboard: document.getElementById('perm-dashboard').checked,
                    students: document.getElementById('perm-students').checked,
                    teachers: document.getElementById('perm-teachers').checked,
                    staff: document.getElementById('perm-staff').checked,
                    classes: document.getElementById('perm-classes').checked,
                    subjects: document.getElementById('perm-subjects').checked,
                    attendance: document.getElementById('perm-attendance').checked,
                    exams: document.getElementById('perm-exams').checked,
                    fees: document.getElementById('perm-fees').checked,
                    salaries: document.getElementById('perm-salaries').checked,
                    library: document.getElementById('perm-library').checked,
                    users: document.getElementById('perm-users').checked,
                    reports: document.getElementById('perm-reports').checked,
                    settings: document.getElementById('perm-settings').checked,
                    backup: document.getElementById('perm-backup').checked
                };
                const existingRoles = await getAllFromStore(STORES.ROLES);
                const roleExists = existingRoles.some(role => role.name === name);
                if (roleExists) {
                    showNotification('یہ رول پہلے سے موجود ہے', 'error');
                    return;
                }
                const roleData = {
                    name: name,
                    description: description,
                    permissions: permissions,
                    createdAt: new Date().toISOString()
                };
                const roleId = await addToStore(STORES.ROLES, roleData);
                document.getElementById('role-form').reset();
                loadRolesTable();
                showNotification('رول کامیابی سے بنا لیا گیا ہے', 'success');
            } catch (error) {
                console.error('Error adding role:', error);
                showNotification('رول بنانے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveGeneralSettings(e) {
            e.preventDefault();
            try {
                showLoading();
                const schoolName = document.getElementById('setting-school-name').value;
                const schoolShortName = document.getElementById('setting-school-short-name').value;
                const schoolAddress = document.getElementById('setting-school-address').value;
                const schoolPhone = document.getElementById('setting-school-phone').value;
                const schoolEmail = document.getElementById('setting-school-email').value;
                const schoolWebsite = document.getElementById('setting-school-website').value;
                const logoInput = document.getElementById('setting-school-logo');
                let logo = null;
                if (logoInput.files && logoInput.files) {
                    logo = await fileToBase64(logoInput.files);
                }
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    schoolName: schoolName,
                    schoolShortName: schoolShortName,
                    schoolAddress: schoolAddress,
                    schoolPhone: schoolPhone,
                    schoolEmail: schoolEmail,
                    schoolWebsite: schoolWebsite,
                    updatedAt: new Date().toISOString()
                };
                if (logo) {
                    updatedSettings.schoolLogo = logo;
                }
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                showNotification('عام ترتیبات کامیابی سے محفوظ کر لی گئی ہیں', 'success');
            } catch (error) {
                console.error('Error saving general settings:', error);
                showNotification('ترتیبات محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveAcademicSettings(e) {
            e.preventDefault();
            try {
                showLoading();
                const currentSession = document.getElementById('setting-current-session').value;
                const sessionStart = document.getElementById('setting-session-start').value;
                const sessionEnd = document.getElementById('setting-session-end').value;
                const schoolTimeStart = document.getElementById('setting-school-time-start').value;
                const schoolTimeEnd = document.getElementById('setting-school-time-end').value;
                const periodDuration = document.getElementById('setting-period-duration').value;
                const weeklyHoliday = Array.from(document.getElementById('setting-weekly-holiday').selectedOptions).map(option => option.value);
                const feeDueDay = document.getElementById('setting-fee-due-day').value;
                const feeLateFiné = document.getElementById('setting-fee-late-fine').value;
                const libraryReturnDays = document.getElementById('setting-library-return-days').value;
                const libraryLateFine = document.getElementById('setting-library-late-fine').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    currentSession: currentSession,
                    sessionStart: sessionStart,
                    sessionEnd: sessionEnd,
                    schoolTimeStart: schoolTimeStart,
                    schoolTimeEnd: schoolTimeEnd,
                    periodDuration: parseInt(periodDuration),
                    weeklyHoliday: weeklyHoliday,
                    feeDueDay: parseInt(feeDueDay),
                    feeLateFiné: parseFloat(feeLateFiné),
                    libraryReturnDays: parseInt(libraryReturnDays),
                    libraryLateFine: parseFloat(libraryLateFine),
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                showNotification('تعلیمی ترتیبات کامیابی سے محفوظ کر لی گئی ہیں', 'success');
            } catch (error) {
                console.error('Error saving academic settings:', error);
                showNotification('ترتیبات محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveThemeSettings(e) {
            e.preventDefault();
            try {
                showLoading();
                const primaryColor = document.getElementById('setting-primary-color').value;
                const secondaryColor = document.getElementById('setting-secondary-color').value;
                const fontSize = document.getElementById('setting-font-size').value;
                const fontFamily = document.getElementById('setting-font-family').value;
                const sidebarPosition = document.getElementById('setting-sidebar-position').value;
                const sidebarTheme = document.getElementById('setting-sidebar-theme').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    primaryColor: primaryColor,
                    secondaryColor: secondaryColor,
                    fontSize: fontSize,
                    fontFamily: fontFamily,
                    sidebarPosition: sidebarPosition,
                    sidebarTheme: sidebarTheme,
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                applySettings();
                showNotification('تھیم ترتیبات کامیابی سے محفوظ کر لی گئی ہیں', 'success');
            } catch (error) {
                console.error('Error saving theme settings:', error);
                showNotification('ترتیبات محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function resetThemeSettings() {
            try {
                showLoading();
                const defaultThemeSettings = {
                    primaryColor: '#3498db',
                    secondaryColor: '#2c3e50',
                    fontSize: 'medium',
                    fontFamily: 'Jameel Noori Nastaleeq',
                    sidebarPosition: 'right',
                    sidebarTheme: 'dark'
                };
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    ...defaultThemeSettings,
                    id: 'general',
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                document.getElementById('setting-primary-color').value = defaultThemeSettings.primaryColor;
                document.getElementById('setting-secondary-color').value = defaultThemeSettings.secondaryColor;
                document.getElementById('setting-font-size').value = defaultThemeSettings.fontSize;
                document.getElementById('setting-font-family').value = defaultThemeSettings.fontFamily;
                document.getElementById('setting-sidebar-position').value = defaultThemeSettings.sidebarPosition;
                document.getElementById('setting-sidebar-theme').value = defaultThemeSettings.sidebarTheme;
                applySettings();
                showNotification('تھیم ترتیبات ڈیفالٹ پر سیٹ کر دی گئی ہیں', 'success');
            } catch (error) {
                console.error('Error resetting theme settings:', error);
                showNotification('ترتیبات ری سیٹ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function createBackup() {
            try {
                showLoading();
                const backupType = document.getElementById('backup-type').value;
                const backupFormat = document.getElementById('backup-format').value;
                let data = {};
                if (backupType === 'full') {
                    for (const store in STORES) {
                        data[STORES[store]] = await getAllFromStore(STORES[store]);
                    }
                } else {
                    data[STORES[backupType.toUpperCase()]] = await getAllFromStore(STORES[backupType.toUpperCase()]);
                }
                const backupData = {
                    type: backupType,
                    format: backupFormat,
                    date: new Date().toISOString(),
                    data: data
                };
                const backupBlob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const backupName = `deeni_madrasa_backup_${backupType}_${new Date().toISOString().slice(0, 10)}.json`;
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(backupBlob);
                downloadLink.download = backupName;
                downloadLink.click();
                await addToStore(STORES.BACKUP, {
                    type: backupType,
                    format: backupFormat,
                    date: new Date().toISOString(),
                    size: backupBlob.size,
                    filename: backupName,
                    createdAt: new Date().toISOString()
                });
                loadBackupHistoryTable();
                showNotification('بیک اپ کامیابی سے بنا لیا گیا ہے', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showNotification('بیک اپ بنانے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadTeacherDropdowns() {
            try {
                const teachers = await getAllFromStore(STORES.TEACHERS);
                const teacherDropdowns = document.querySelectorAll('select[id$="-teacher"], select[id$="-incharge"], select[id$="Teacher"]');
                teacherDropdowns.forEach(dropdown => {
                    const currentVal = dropdown.value;
                    const fixedOptions = Array.from(dropdown.options).filter(opt => opt.value === "" || opt.value === "all" || opt.dataset.fixed);
                    dropdown.innerHTML = '';
                    fixedOptions.forEach(opt => dropdown.appendChild(opt.cloneNode(true)));
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = teacher.name;
                        dropdown.appendChild(option);
                    });
                    if (Array.from(dropdown.options).some(opt => opt.value === currentVal)) {
                        dropdown.value = currentVal;
                    }
                });
            } catch (error) {
                console.error('Error loading teacher dropdowns:', error);
            }
        }
        async function loadStudentsForAttendance() {
            const classIdElement = document.getElementById('attendance-class');
            const sectionIdElement = document.getElementById('attendance-section');
            const dateElement = document.getElementById('attendance-date');
            if (!classIdElement || !sectionIdElement || !dateElement) {
                console.error("Attendance filter elements not found.");
                showNotification('حاضری کے لیے ضروری عناصر نہیں ملے۔', 'error');
                return;
            }
            const classId = parseInt(classIdElement.value);
            const sectionId = parseInt(sectionIdElement.value);
            const date = dateElement.value;
            if (isNaN(classId) || isNaN(sectionId) || !date) {
                showNotification('براہ کرم تاریخ، کلاس اور سیکشن منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            try {
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const classStudents = allStudents.filter(s => s.classId === classId && s.sectionId === sectionId);
                const attendanceTableBody = document.querySelector('#attendance-table tbody');
                const attendanceTableContainer = document.getElementById('attendance-table-container');
                if (!attendanceTableBody || !attendanceTableContainer) {
                    console.error("Attendance table elements not found.");
                    hideLoading();
                    return;
                }
                attendanceTableBody.innerHTML = '';
                if (classStudents.length === 0) {
                    attendanceTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">اس کلاس/سیکشن میں کوئی طالب علم نہیں ہے۔</td></tr>';
                } else {
                    const existingAttendanceRecords = await getAllFromIndex(STORES.ATTENDANCE, 'dateClassSection', [date, classId, sectionId]);
                    const existingAttendanceMap = new Map();
                    existingAttendanceRecords.forEach(rec => existingAttendanceMap.set(rec.studentId, rec));
                    classStudents.forEach(student => {
                        const existingRecord = existingAttendanceMap.get(student.id);
                        const isPresent = existingRecord ? existingRecord.status === 'present' : true;
                        const isLate = existingRecord ? existingRecord.isLate : false;
                        const onLeave = existingRecord ? existingRecord.isLeave : false;
                        const notes = existingRecord ? existingRecord.notes : '';
                        const row = document.createElement('tr');
                        row.dataset.studentId = student.id;
                        row.innerHTML = `
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>
                        <label style="margin-right: 5px;"><input type="radio" name="status_${student.id}" value="present" ${isPresent && !onLeave ? 'checked' : ''}> حاضر</label>
                        <label style="margin-right: 5px;"><input type="radio" name="status_${student.id}" value="absent" ${!isPresent && !onLeave ? 'checked' : ''}> غیر حاضر</label>
                    </td>
                    <td><input type="checkbox" name="late_${student.id}" ${isLate ? 'checked' : ''}></td>
                    <td><input type="checkbox" name="leave_${student.id}" ${onLeave ? 'checked' : ''}></td>
                    <td><input type="text" class="form-control" name="notes_${student.id}" value="${notes}"></td>
                `;
                        attendanceTableBody.appendChild(row);
                        const leaveCheckbox = row.querySelector(`input[name="leave_${student.id}"]`);
                        const presentRadio = row.querySelector(`input[name="status_${student.id}"][value="present"]`);
                        const absentRadio = row.querySelector(`input[name="status_${student.id}"][value="absent"]`);
                        if (leaveCheckbox) {
                            leaveCheckbox.addEventListener('change', (e) => {
                                if (e.target.checked) {
                                    if (presentRadio) presentRadio.checked = false;
                                    if (absentRadio) absentRadio.checked = false;
                                    if (presentRadio) presentRadio.disabled = true;
                                    if (absentRadio) absentRadio.disabled = true;
                                } else {
                                    if (presentRadio) presentRadio.disabled = false;
                                    if (absentRadio) absentRadio.disabled = false;
                                    if (presentRadio && !absentRadio.checked) presentRadio.checked = true;
                                }
                            });
                            if (onLeave) {
                                if (presentRadio) presentRadio.checked = false;
                                if (absentRadio) absentRadio.checked = false;
                                if (presentRadio) presentRadio.disabled = true;
                                if (absentRadio) absentRadio.disabled = true;
                            }
                        }
                    });
                }
                attendanceTableContainer.style.display = 'block';
            } catch (error) {
                console.error("Error loading students for attendance:", error);
                showNotification('حاضری کے لیے طلباء کو لوڈ کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function restoreBackup() {
            try {
                showLoading();
                const fileInput = document.getElementById('restore-file');
                if (!fileInput.files || fileInput.files.length === 0) {
                    showNotification('برائے مہربانی بیک اپ فائل منتخب کریں', 'error');
                    return;
                }
                const file = fileInput.files;
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        if (!backupData || !backupData.data) {
                            showNotification('غلط بیک اپ فائل فارمیٹ', 'error');
                            return;
                        }
                        const confirmation = confirm('ڈیٹا بیس کی بحالی موجودہ ڈیٹا کو مٹا دے گی۔ کیا آپ واقعی جاری رکھنا چاہتے ہیں؟');
                        if (!confirmation) {
                            hideLoading();
                            return;
                        }
                        for (const storeName in backupData.data) {
                            const storeData = backupData.data[storeName];
                            if (!storeData || !Array.isArray(storeData)) continue;
                            const transaction = db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            await new Promise((resolve, reject) => {
                                const clearRequest = store.clear();
                                clearRequest.onsuccess = resolve;
                                clearRequest.onerror = reject;
                            });
                            for (const item of storeData) {
                                await new Promise((resolve, reject) => {
                                    const addRequest = store.add(item);
                                    addRequest.onsuccess = resolve;
                                    addRequest.onerror = reject;
                                });
                            }
                        }
                        showNotification('ڈیٹا کامیابی سے بحال کر لیا گیا ہے', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } catch (error) {
                        console.error('Error parsing or restoring backup:', error);
                        showNotification('بیک اپ بحال کرنے میں خرابی ہوئی ہے', 'error');
                        hideLoading();
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error restoring backup:', error);
                showNotification('بیک اپ بحال کرنے میں خرابی ہوئی ہے', 'error');
                hideLoading();
            }
        }
        async function saveAutoBackupSettings() {
            try {
                showLoading();
                const isEnabled = document.getElementById('auto-backup-enable').checked;
                const frequency = document.getElementById('auto-backup-frequency').value;
                const retention = document.getElementById('auto-backup-retention').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    autoBackupEnabled: isEnabled,
                    autoBackupFrequency: frequency,
                    autoBackupRetention: parseInt(retention),
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                showNotification('آٹومیٹک بیک اپ ترتیبات کامیابی سے محفوظ کر لی گئی ہیں', 'success');
            } catch (error) {
                console.error('Error saving auto backup settings:', error);
                showNotification('ترتیبات محفوظ کرنے میں خرابی ہوئی ہے', 'error');
            } finally {
                hideLoading();
            }
        }
        async function fileToBase64(file) {
            if (!file || !(file instanceof Blob)) {
                return null;
            }
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            const menuToggle = document.getElementById('menuToggle');
            if (!sidebar || !mainContainer || !menuToggle) {
                console.error("Error: Required elements (sidebar, mainContainer, or menuToggle) not found.");
                return;
            }
            let isActive;
            if (sidebar.dataset.isActive === undefined) {
                if (window.innerWidth <= 768) {
                    isActive = sidebar.style.transform === 'translateX(0px)';
                } else {
                    isActive = true;
                }
            } else {
                isActive = sidebar.dataset.isActive === 'true';
            }
            isActive = !isActive;
            sidebar.dataset.isActive = isActive;
            const icon = menuToggle.querySelector('i');
            if (window.innerWidth <= 768) {
                if (isActive) {
                    sidebar.style.transform = 'translateX(0)';
                    if (icon) icon.innerHTML = '×';
                } else {
                    sidebar.style.transform = 'translateX(100%)';
                    if (icon) icon.innerHTML = '☰';
                }
            } else {
                if (isActive) {
                    sidebar.style.transform = 'translateX(0)';
                    sidebar.style.width = '250px';
                    mainContainer.style.marginRight = '250px';
                    mainContainer.style.width = 'calc(100% - 250px)';
                    if (icon) icon.innerHTML = '×';
                } else {
                    sidebar.style.transform = 'translateX(100%)';
                    mainContainer.style.marginRight = '0';
                    mainContainer.style.width = '100%';
                    if (icon) icon.innerHTML = '☰';
                }
            }
        }
        function initializeDynamicViews() {
            initializeLibraryView();
            initializeReportsView();
            initializeSettingsView();
            initializeUserRolesForm();
        }
        function attachDynamicEventListeners() {
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.addEventListener('click', function (e) {
                const target = e.target;
                if (target.matches('#issue-book-search-btn')) searchBookForIssue();
                if (target.matches('#issue-member-search-btn')) searchMemberForIssue();
                if (target.matches('#issue-book-btn')) issueBook();
                if (target.matches('#return-search-btn')) searchIssueForReturn();
                if (target.matches('#return-book-btn')) {
                    const issueId = parseInt(target.dataset.issueId);
                    const bookId = parseInt(target.dataset.bookId);
                    returnBook(issueId, bookId);
                }
                if (target.matches('#generate-report-btn')) generateReport();
                if (target.matches('#reset-theme-btn')) resetThemeSettings();
            });
            mainContainer.addEventListener('submit', function (e) {
                if (e.target.matches('form')) {
                    e.preventDefault();
                }
                const formId = e.target.id;
                switch (formId) {
                    case 'add-book-form':
                        addBook();
                        break;
                    case 'general-settings-form':
                        saveGeneralSettings();
                        break;
                    case 'academic-settings-form':
                        saveAcademicSettings();
                        break;
                    case 'theme-settings-form':
                        saveThemeSettings();
                        break;
                }
            });
            mainContainer.addEventListener('change', function (e) {
                if (e.target.matches('#report-type')) {
                    toggleReportFilters();
                }
            });
            console.log("Delegated event listeners attached to main container.");
        }
        function initializeLibraryView() {
            const container = document.getElementById('library-view');
            if (container.querySelector('.tabs')) return;
            container.innerHTML = `
        <h2>لائبریری</h2>
        <div class="tabs">
            <div class="tab active" data-tab="books-list">کتابوں کی فہرست</div>
            <div class="tab" data-tab="add-book-tab">نئی کتاب شامل کریں</div>
            <div class="tab" data-tab="issue-book-tab">کتاب جاری کریں</div>
        </div>
        <div class="tab-content active" id="books-list">
            <div class="table-container"><table class="table" id="books-table"><thead><tr><th>ID</th><th>کتاب کا نام</th><th>مصنف</th><th>دستیاب</th><th>عمل</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div class="tab-content" id="add-book-tab">
            <div class="form-container">
                <form id="add-book-form" onsubmit="event.preventDefault(); addBook();">
                    <div class="form-title">نئی کتاب کی تفصیلات</div>
                    <div class="form-group"><label>نام</label><input type="text" id="book-name" class="form-control" required></div>
                    <div class="form-group"><label>مصنف</label><input type="text" id="book-author" class="form-control" required></div>
                    <div class="form-group"><label>کیٹیگری</label><input type="text" id="book-category" class="form-control" required></div>
                    <div class="form-group"><label>کل کاپیاں</label><input type="number" id="book-copies" class="form-control" required min="1"></div>
                    <button type="submit" class="btn btn-primary">کتاب شامل کریں</button>
                </form>
            </div>
        </div>
        <div class="tab-content" id="issue-book-tab">
            <div class="form-container"><p>کتاب جاری کرنے اور واپس لینے کا فیچر زیر تعمیر ہے۔</p></div>
        </div>
    `;
            container.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    tab.parentElement.querySelector('.active').classList.remove('active');
                    tab.classList.add('active');
                    tab.closest('.section-view').querySelector('.tab-content.active').classList.remove('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
        }
        async function loadBooksTable() {
            const tbody = document.querySelector('#books-table tbody');
            tbody.innerHTML = '';
            const books = await getAllFromStore(STORES.BOOKS);
            if (!books || books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">کوئی کتاب موجود نہیں ہے۔</td></tr>';
                return;
            }
            books.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.name}</td>
                    <td>${book.author}</td>
                    <td>${book.category}</td>
                    <td>${book.availableCopies}</td> 
                    <td><button class="btn btn-danger btn-sm" onclick="deleteBook(${book.id})">حذف کریں</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        async function addBook() {
            const bookData = {
                name: document.getElementById('book-name').value,
                author: document.getElementById('book-author').value,
                category: document.getElementById('book-category').value,
                isbn: document.getElementById('book-isbn').value,
                copies: parseInt(document.getElementById('book-copies').value),
                availableCopies: parseInt(document.getElementById('book-copies').value),
                shelf: document.getElementById('book-shelf').value,
            };
            await addToStore(STORES.BOOKS, bookData);
            showNotification('کتاب کامیابی سے شامل ہو گئی', 'success');
            document.getElementById('add-book-form').reset();
            loadBooksTable();
            document.querySelector('[data-tab="books-list"]').click();
        }
        async function deleteBook(id) {
            if (confirm('کیا آپ واقعی اس کتاب کو حذف کرنا چاہتے ہیں؟')) {
                await deleteFromStore(STORES.BOOKS, id);
                showNotification('کتاب حذف کر دی گئی', 'success');
                loadBooksTable();
            }
        }
        async function searchBookForIssue() {
            const searchTerm = document.getElementById('issue-book-search').value.toLowerCase();
            const books = await getAllFromStore(STORES.BOOKS);
            const book = books.find(b => String(b.id) === searchTerm || b.name.toLowerCase().includes(searchTerm));
            const detailsDiv = document.getElementById('issue-book-details');
            if (book) {
                if (book.availableCopies > 0) {
                    detailsDiv.innerHTML = `<p><b>کتاب:</b> ${book.name} (ID: ${book.id})<br><b>دستیاب:</b> ${book.availableCopies}</p>`;
                    detailsDiv.dataset.bookId = book.id;
                } else {
                    detailsDiv.innerHTML = `<p class="text-danger">کتاب "${book.name}" دستیاب نہیں ہے</p>`;
                    detailsDiv.dataset.bookId = '';
                }
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.innerHTML = `<p class="text-danger">کوئی کتاب نہیں ملی</p>`;
                detailsDiv.style.display = 'block';
                detailsDiv.dataset.bookId = '';
            }
            checkIssueReady();
        }
        async function searchMemberForIssue() {
            const searchTerm = document.getElementById('issue-member-search').value.toLowerCase();
            const students = await getAllFromStore(STORES.STUDENTS);
            const member = students.find(s => String(s.rollNumber) === searchTerm || s.name.toLowerCase().includes(searchTerm));
            const detailsDiv = document.getElementById('issue-member-details');
            if (member) {
                detailsDiv.innerHTML = `<p><b>ممبر:</b> ${member.name} (ID: ${member.id}, ${member.className})</p>`;
                detailsDiv.dataset.memberId = member.id;
                detailsDiv.dataset.memberType = 'student';
            } else {
                detailsDiv.innerHTML = `<p class="text-danger">کوئی ممبر نہیں ملا</p>`;
                detailsDiv.dataset.memberId = '';
            }
            detailsDiv.style.display = 'block';
            checkIssueReady();
        }
        function checkIssueReady() {
            const bookId = document.getElementById('issue-book-details').dataset.bookId;
            const memberId = document.getElementById('issue-member-details').dataset.memberId;
            document.getElementById('issue-book-btn').style.display = (bookId && memberId) ? 'block' : 'none';
        }
        async function issueBook() {
            const bookId = parseInt(document.getElementById('issue-book-details').dataset.bookId);
            const memberId = parseInt(document.getElementById('issue-member-details').dataset.memberId);
            const memberType = document.getElementById('issue-member-details').dataset.memberType;
            const book = await getFromStore(STORES.BOOKS, bookId);
            const issueData = {
                bookId: bookId,
                memberId: memberId,
                memberType: memberType,
                issueDate: new Date().toISOString(),
                returnDate: null,
                status: 'issued'
            };
            await addToStore(STORES.BOOK_ISSUES, issueData);
            await updateInStore(STORES.BOOKS, bookId, { availableCopies: book.availableCopies - 1 });
            showNotification(`کتاب "${book.name}" جاری کر دی گئی`, 'success');
            document.getElementById('issue-book-search').value = '';
            document.getElementById('issue-member-search').value = '';
            document.getElementById('issue-book-details').style.display = 'none';
            document.getElementById('issue-member-details').style.display = 'none';
            document.getElementById('issue-book-btn').style.display = 'none';
        }
        async function searchIssueForReturn() {
            const searchTerm = document.getElementById('return-search').value;
            const issues = await getAllFromStore(STORES.BOOK_ISSUES);
            const activeIssues = issues.filter(i => i.status === 'issued');
            const issue = activeIssues.find(i => String(i.bookId) === searchTerm || String(i.memberId) === searchTerm);
            const detailsDiv = document.getElementById('return-details');
            if (issue) {
                const book = await getFromStore(STORES.BOOKS, issue.bookId);
                const member = await getFromStore(STORES.STUDENTS, issue.memberId);
                detailsDiv.innerHTML = `
            <p><b>کتاب:</b> ${book.name}</p>
            <p><b>ممبر:</b> ${member.name}</p>
            <p><b>جاری شدہ تاریخ:</b> ${formatDate(issue.issueDate)}</p>
            <button class="btn btn-success" id="return-book-btn" data-issue-id="${issue.id}" data-book-id="${issue.bookId}">کتاب واپس کریں</button>
        `;
            } else {
                detailsDiv.innerHTML = `<p class="text-danger">کوئی فعال اجراء نہیں ملا</p>`;
            }
            detailsDiv.style.display = 'block';
        }
        async function returnBook(issueId, bookId) {
            await updateInStore(STORES.BOOK_ISSUES, issueId, { status: 'returned', returnDate: new Date().toISOString() });
            const book = await getFromStore(STORES.BOOKS, bookId);
            await updateInStore(STORES.BOOKS, bookId, { availableCopies: book.availableCopies + 1 });
            showNotification('کتاب کامیابی سے واپس ہو گئی', 'success');
            document.getElementById('return-search').value = '';
            document.getElementById('return-details').style.display = 'none';
        }
        function initializeUserRolesForm() {
            const container = document.querySelector('#add-user .form-container');
            const roleForm = document.getElementById('role-form');
            const permsHTML = `
        <div class="form-title">اجازتیں</div>
        <div class="form-row" id="permissions-container" style="flex-direction: column; align-items: start; gap: 5px;">
                   </div>`;
            roleForm.querySelector('.form-row:last-child').insertAdjacentHTML('beforebegin', permsHTML);
            const permissions = ['dashboard', 'students', 'teachers', 'staff', 'classes', 'subjects', 'attendance', 'exams', 'fees', 'salaries', 'library', 'users', 'reports', 'settings', 'backup'];
            const permsContainer = document.getElementById('permissions-container');
            permissions.forEach(p => {
                permsContainer.innerHTML += `
            <label><input type="checkbox" id="perm-${p}" value="${p}"> ${p.charAt(0).toUpperCase() + p.slice(1)}</label>
        `;
            });
        }
        async function loadUsersTable() {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            const users = await getAllFromStore(STORES.USERS);
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">کوئی صارف موجود نہیں ہے۔</td></tr>';
                return;
            }
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td><span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-danger'}">${user.status}</span></td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">حذف کریں</button></td>
        `;
                tbody.appendChild(row);
            });
        }
        async function deleteUser(id) {
            if (confirm('کیا آپ واقعی اس صارف کو حذف کرنا چاہتے ہیں؟')) {
                await deleteFromStore(STORES.USERS, id);
                showNotification('صارف حذف کر دیا گیا', 'success');
                loadUsersTable();
            }
        }
        async function addRole() {
            const permissions = {};
            document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(cb => {
                permissions[cb.value] = cb.checked;
            });
            const roleData = {
                name: document.getElementById('role-name').value,
                description: document.getElementById('role-description').value,
                permissions: permissions
            };
            await addToStore(STORES.ROLES, roleData);
            showNotification('رول کامیابی سے شامل ہو گیا', 'success');
            document.getElementById('role-form').reset();
            loadRolesTable();
        }
        async function loadRolesTable() {
            const tbody = document.querySelector('#roles-table tbody');
            tbody.innerHTML = '';
            const roles = await getAllFromStore(STORES.ROLES);
            if (!roles || roles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">کوئی رول موجود نہیں ہے۔</td></tr>';
                return;
            }
            roles.forEach(role => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${role.name}</td>
            <td>${role.description}</td>
            <td><button class="btn btn-danger btn-sm" onclick="deleteRole(${role.id})">حذف کریں</button></td>
        `;
                tbody.appendChild(row);
            });
        }
        async function deleteRole(id) {
            if (confirm('کیا آپ واقعی اس رول کو حذف کرنا چاہتے ہیں؟')) {
                await deleteFromStore(STORES.ROLES, id);
                showNotification('رول حذف کر دیا گیا', 'success');
                loadRolesTable();
            }
        }
        function handleReportTypeChangeJS() {
            const reportType = document.getElementById('js-report-type-select').value;
            const filtersArea = document.getElementById('js-report-filters-area');
            filtersArea.innerHTML = '';
            filtersArea.style.display = 'none';
            switch (reportType) {
                case 'student_strength_by_class':
                    filtersArea.style.display = 'none';
                    break;
                case 'class_fee_summary':
                    filtersArea.style.display = 'block';
                    const monthGroup = createElementJS('div', { class: 'form-group' });
                    monthGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-month' }, 'مہینہ'));
                    const monthSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-month' });
                    const months = ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"];
                    months.forEach((m, i) => monthSelect.appendChild(createElementJS('option', { value: i + 1 }, m)));
                    monthGroup.appendChild(monthSelect);
                    filtersArea.appendChild(monthGroup);
                    const yearGroup = createElementJS('div', { class: 'form-group' });
                    yearGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-year' }, 'سال'));
                    const currentYear = new Date().getFullYear();
                    const yearInput = createElementJS('input', { type: 'number', class: 'form-control', id: 'js-filter-year', value: currentYear });
                    yearGroup.appendChild(yearInput);
                    filtersArea.appendChild(yearGroup);
                    break;
            }
        }
        async function generateSelectedReportJS() {
            const reportType = document.getElementById('js-report-type-select').value;
            const outputDiv = document.getElementById('js-report-output-area');
            outputDiv.innerHTML = '';
            if (!reportType) {
                showNotification('براہ کرم رپورٹ کی قسم منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            let reportHTML = '';
            try {
                switch (reportType) {
                    case 'student_strength_by_class':
                        reportHTML = await generateStudentStrengthByClassReportJS();
                        break;
                    case 'class_fee_summary':
                        const month = document.getElementById('js-filter-month').value;
                        const year = document.getElementById('js-filter-year').value;
                        reportHTML = await generateClassFeeSummaryReportJS(parseInt(month), parseInt(year));
                        break;
                    default:
                        reportHTML = '<p>منتخب کردہ رپورٹ کی قسم کے لیے کوئی عمل درآمد نہیں ہے۔</p>';
                }
                outputDiv.innerHTML = reportHTML;
            } catch (error) {
                console.error(`Error generating report '${reportType}':`, error);
                outputDiv.innerHTML = `<p style="color:red;">رپورٹ بنانے میں خرابی ہوئی: ${error.message}</p>`;
                showNotification('رپورٹ بنانے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateStudentStrengthByClassReportJS() {
            const classes = await getAllFromStore(STORES.CLASSES);
            const students = await getAllFromStore(STORES.STUDENTS);
            let totalStudents = 0;
            const reportData = classes.map(cls => {
                const classStudents = students.filter(s => s.classId === cls.id);
                totalStudents += classStudents.length;
                return { className: cls.name, studentCount: classStudents.length };
            });
            let tableHTML = `<h3>طلباء کی تعداد بلحاظ کلاس</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>کلاس کا نام</th><th>طلباء کی تعداد</th></tr></thead>
                         <tbody>`;
            reportData.forEach(data => {
                tableHTML += `<tr><td>${data.className}</td><td>${data.studentCount}</td></tr>`;
            });
            tableHTML += `</tbody>
                  <tfoot><tr><td><strong>کل طلباء</strong></td><td><strong>${totalStudents}</strong></td></tr></tfoot>
                  </table></div>`;
            const chartContainerId = `chart-student-strength-${Date.now()}`;
            tableHTML += `<div id="${chartContainerId}" style="height: 300px; margin-top: 20px;"></div>
                  <p><em>Chart would be rendered here using a library like Chart.js.</em></p>`;
            const chartLabels = reportData.map(d => d.className);
            const chartDataValues = reportData.map(d => d.studentCount);
            return tableHTML;
        }
        async function generateClassFeeSummaryReportJS(month, year) {
            if (isNaN(month) || isNaN(year)) {
                return "<p>فیس سمری رپورٹ کے لیے مہینہ اور سال درست ہونے چاہئیں۔</p>";
            }
            const classes = await getAllFromStore(STORES.CLASSES);
            const feeRecords = await getAllFromStore(STORES.FEES);
            const students = await getAllFromStore(STORES.STUDENTS);
            let totalCollectedOverall = 0;
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('ur-PK', { month: 'long' });
            const reportData = await Promise.all(classes.map(async (cls) => {
                const studentsInClass = students.filter(s => s.classId === cls.id);
                let classTotalCollected = 0;
                let classPaidCount = 0;
                studentsInClass.forEach(student => {
                    const studentFeeRecord = feeRecords.find(
                        fr => fr.studentId === student.id && parseInt(fr.month) === month && parseInt(fr.year) === year
                    );
                    if (studentFeeRecord) {
                        classTotalCollected += studentFeeRecord.total || 0;
                        classPaidCount++;
                    }
                });
                totalCollectedOverall += classTotalCollected;
                return {
                    className: cls.name,
                    totalStudents: studentsInClass.length,
                    paidStudents: classPaidCount,
                    collectedAmount: classTotalCollected
                };
            }));
            let tableHTML = `<h3>کلاس وار فیس کا خلاصہ برائے ${monthName}، ${year}</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>کلاس کا نام</th><th>کل طلباء</th><th>فیس دہندگان</th><th>جمع شدہ رقم</th></tr></thead>
                         <tbody>`;
            reportData.forEach(data => {
                tableHTML += `<tr>
                        <td>${data.className}</td>
                        <td>${data.totalStudents}</td>
                        <td>${data.paidStudents}</td>
                        <td>${formatCurrency(data.collectedAmount)}</td>
                      </tr>`;
            });
            tableHTML += `</tbody>
                  <tfoot><tr><td colspan="3"><strong>کل جمع شدہ رقم</strong></td><td><strong>${formatCurrency(totalCollectedOverall)}</strong></td></tr></tfoot>
                  </table></div>`;
            const chartContainerId = `chart-fee-summary-${Date.now()}`;
            tableHTML += `<div id="${chartContainerId}" style="max-width: 400px; margin: 20px auto;"></div>
                  <p><em>Pie chart (Collection by Class) would be rendered here.</em></p>`;
            return tableHTML;
        }
        function toggleReportFilters() {
            const type = document.getElementById('report-type').value;
            const filtersDiv = document.getElementById('report-filters');
            filtersDiv.innerHTML = '';
            switch (type) {
                case 'class_list':
                case 'fee_defaulters':
                    filtersDiv.innerHTML = `
                <div class="form-group">
                    <label class="form-label">کلاس منتخب کریں</label>
                    <select id="report-filter-class" class="form-control"></select>
                </div>
             `;
                    loadClassDropdownsForReport();
                    break;
            }
        }
        async function loadClassDropdownsForReport() {
            const select = document.getElementById('report-filter-class');
            select.innerHTML = '<option value="all">تمام کلاسز</option>';
            const classes = await getAllFromStore(STORES.CLASSES);
            classes.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
        async function generateReport() {
            const type = document.getElementById('report-type').value;
            const outputDiv = document.getElementById('report-output');
            if (!type) {
                showNotification('براہ کرم رپورٹ کی قسم منتخب کریں', 'error');
                return;
            }
            outputDiv.style.display = 'block';
            outputDiv.innerHTML = '<div class="spinner"></div>';
            let html = '';
            switch (type) {
                case 'student_strength':
                    html = await generateStudentStrengthReport();
                    break;
                case 'class_list':
                    html = await generateClassListReport();
                    break;
                case 'fee_defaulters':
                    html = await generateDefaultersReport();
                    break;
            }
            outputDiv.innerHTML = html;
        }
        async function generateStudentStrengthReport() {
            const classes = await getAllFromStore(STORES.CLASSES);
            let table = `<table class="table"><thead><tr><th>کلاس</th><th>طلباء کی تعداد</th></tr></thead><tbody>`;
            let totalStudents = 0;
            for (const cls of classes) {
                const students = await getAllFromIndex(STORES.STUDENTS, 'classId', cls.id);
                table += `<tr><td>${cls.name}</td><td>${students.length}</td></tr>`;
                totalStudents += students.length;
            }
            table += `</tbody><tfoot><tr><th>کل تعداد</th><th>${totalStudents}</th></tr></tfoot></table>`;
            return `<h3>طلباء کی تعداد کی رپورٹ</h3>` + table;
        }
        async function generateClassListReport() {
            const classId = document.getElementById('report-filter-class').value;
            let students = await getAllFromStore(STORES.STUDENTS);
            if (classId !== 'all') {
                students = students.filter(s => s.classId === parseInt(classId));
            }
            let table = `<table class="table"><thead><tr><th>رول نمبر</th><th>نام</th><th>والد کا نام</th><th>کلاس</th></tr></thead><tbody>`;
            students.forEach(s => {
                table += `<tr><td>${s.rollNumber}</td><td>${s.name}</td><td>${s.fatherName}</td><td>${s.className}</td></tr>`;
            });
            table += `</tbody></table>`;
            const className = classId !== 'all' ? (await getFromStore(STORES.CLASSES, parseInt(classId))).name : 'تمام کلاسز';
            return `<h3>${className} کی لسٹ</h3>` + table;
        }
        function initializeSettingsView() {
            const container = document.getElementById('settings-view');
            if (container.querySelector('.tabs')) {
                loadAllSettings();
                return;
            }
            container.innerHTML = `
        <h2>ترتیبات</h2>
        <div class="tabs">
            <div class="tab active" data-tab="general-settings">عمومی ترتیبات</div>
        </div>
        <div class="tab-content active" id="general-settings">
            <div class="form-container">
                <form id="general-settings-form" onsubmit="event.preventDefault(); saveGeneralSettings();">
                    <div class="form-title">ادارے کی معلومات</div>
                    <div class="form-group"><label>ادارے کا نام</label><input type="text" class="form-control" id="setting-school-name"></div>
                    <div class="form-group"><label>پتہ</label><input type="text" class="form-control" id="setting-school-address"></div>
                    <div class="form-group"><label>فون</label><input type="text" class="form-control" id="setting-school-phone"></div>
                    <div class="form-group"><label>ای میل</label><input type="email" class="form-control" id="setting-school-email"></div>
                    <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                </form>
            </div>
        </div>
    `;
            loadAllSettings();
        }
        async function loadAllSettings() {
            console.log('[DEBUG] Running loadAllSettings...');
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const schoolNameInput = document.getElementById('setting-school-name');
                if (schoolNameInput) schoolNameInput.value = settings.schoolName || ''; else console.error("[DEBUG] 'setting-school-name' not found!");
                const schoolAddressInput = document.getElementById('setting-school-address');
                if (schoolAddressInput) schoolAddressInput.value = settings.schoolAddress || ''; else console.error("[DEBUG] 'setting-school-address' not found!");
                const schoolPhoneInput = document.getElementById('setting-school-phone');
                if (schoolPhoneInput) schoolPhoneInput.value = settings.schoolPhone || ''; else console.error("[DEBUG] 'setting-school-phone' not found!");
                const schoolEmailInput = document.getElementById('setting-school-email');
                if (schoolEmailInput) schoolEmailInput.value = settings.schoolEmail || ''; else console.error("[DEBUG] 'setting-school-email' not found!");
                const primaryColorInput = document.getElementById('setting-primary-color');
                if (primaryColorInput) primaryColorInput.value = settings.primaryColor || '#3498db'; else console.error("[DEBUG] 'setting-primary-color' not found!");
                console.log('[DEBUG] Finished loading values into settings form.');
            } catch (e) {
                console.error('[DEBUG] Error inside loadAllSettings:', e);
            }
        }
        async function saveGeneralSettings() {
            const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
            const updated = {
                ...existing,
                schoolName: document.getElementById('setting-school-name').value,
                schoolAddress: document.getElementById('setting-school-address').value,
                schoolPhone: document.getElementById('setting-school-phone').value,
                schoolEmail: document.getElementById('setting-school-email').value,
            };
            await addToStore(STORES.SETTINGS, updated, true);
            showNotification('عمومی ترتیبات محفوظ ہو گئیں', 'success');
        }
        async function saveAcademicSettings() {
            const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
            const updated = {
                ...existing,
                currentSession: document.getElementById('setting-current-session').value,
                feeDueDay: parseInt(document.getElementById('setting-fee-due-day').value),
                feeLateFine: parseFloat(document.getElementById('setting-fee-late-fine').value),
            };
            await addToStore(STORES.SETTINGS, updated, true);
            showNotification('تعلیمی ترتیبات محفوظ ہو گئیں', 'success');
        }
        async function saveThemeSettings() {
            const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
            const primaryColor = document.getElementById('setting-primary-color').value;
            const updated = { ...existing, primaryColor: primaryColor };
            await addToStore(STORES.SETTINGS, updated, true);
            applyTheme(primaryColor);
            showNotification('تھیم کی ترتیبات محفوظ ہو گئیں', 'success');
        }
        function applyTheme(color) {
            document.documentElement.style.setProperty('--primary-color', color);
            document.querySelector('.header').style.backgroundColor = color;
        }
        async function resetThemeSettings() {
            const defaultColor = '#2c3e50';
            document.getElementById('setting-primary-color').value = defaultColor;
            const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
            const updated = { ...existing, primaryColor: defaultColor };
            await addToStore(STORES.SETTINGS, updated, true);
            applyTheme(defaultColor);
            showNotification('تھیم ڈیفالٹ پر ری سیٹ ہو گیا', 'success');
        }
        async function populateAttendanceSections(classDropdownId, sectionDropdownId) {
            const classId = parseInt(document.getElementById(classDropdownId).value);
            const sectionDropdown = document.getElementById(sectionDropdownId);
            sectionDropdown.innerHTML = '<option value="">...</option>';
            if (isNaN(classId)) {
                sectionDropdown.innerHTML = '<option value="">پہلے کلاس منتخب کریں</option>';
                return;
            }
            try {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                if (sections && sections.length > 0) {
                    sectionDropdown.innerHTML = '<option value="">سیکشن منتخب کریں</option>';
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section.id;
                        option.textContent = section.name;
                        sectionDropdown.appendChild(option);
                    });
                } else {
                    sectionDropdown.innerHTML = '<option value="">کوئی سیکشن نہیں ملا</option>';
                }
            } catch (error) {
                console.error('Error populating sections:', error);
                sectionDropdown.innerHTML = '<option value="">سیکشن لوڈ کرنے میں خرابی</option>';
            }
        }
        async function addToStore(storeName, data, upsert = false) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = upsert ? store.put(data) : store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        function createElementJS(tag, attributes = {}, textContent = null) {
            const element = document.createElement(tag);
            let hasInnerHTML = false;
            for (const key in attributes) {
                if (key === 'style' && typeof attributes[key] === 'object') {
                    for (const styleProp in attributes[key]) {
                        element.style[styleProp] = attributes[key][styleProp];
                    }
                } else if (key === 'dataset' && typeof attributes[key] === 'object') {
                    for (const dataKey in attributes[key]) {
                        element.dataset[dataKey] = attributes[key][dataKey];
                    }
                } else if (key === 'innerHTML') {
                    element.innerHTML = attributes[key];
                    hasInnerHTML = true;
                } else if (typeof attributes[key] === 'boolean') {
                    if (attributes[key]) {
                        element.setAttribute(key, '');
                    }
                } else {
                    element.setAttribute(key, attributes[key]);
                }
            }
            if (!hasInnerHTML && textContent !== null && textContent !== undefined) {
                element.textContent = textContent;
            }
            return element;
        }
        async function createCollapsibleFilterUI(targetListDivId, filterContainerId, filterTitleTextContent, createFilterRowsFn, populateDropdownsFn, applyFiltersFn, resetFiltersFn, specificDropdownChangeHandlers = []) {
            const listDiv = document.getElementById(targetListDivId);
            if (!listDiv) {
                console.error(`Target div '${targetListDivId}' not found for creating filters.`);
                return;
            }
            if (document.getElementById(filterContainerId)) {
                if (populateDropdownsFn) await populateDropdownsFn();
                return;
            }
            const existingSearchContainer = listDiv.querySelector('.form-container:not(.js-filter-container)');
            const filterContainer = createElementJS('div', {
                id: filterContainerId,
                class: 'form-container js-filter-container',
                style: { marginBottom: '20px' }
            });
            const filterHeader = createElementJS('div', {
                class: 'form-title filter-header-toggle',
                style: { cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
            });
            const filterTitleSpan = createElementJS('span', {}, filterTitleTextContent);
            const filterToggleIcon = createElementJS('span', { class: 'filter-toggle-icon', innerHTML: '▾' });
            filterHeader.appendChild(filterTitleSpan);
            filterHeader.appendChild(filterToggleIcon);
            filterContainer.appendChild(filterHeader);
            const filterContent = createElementJS('div', { class: 'filter-content', style: { display: 'none', paddingTop: '15px' } });
            await createFilterRowsFn(filterContent);
            filterContainer.appendChild(filterContent);
            if (existingSearchContainer) {
                listDiv.insertBefore(filterContainer, existingSearchContainer);
            } else {
                listDiv.appendChild(filterContainer);
            }
            filterHeader.addEventListener('click', () => {
                const isVisible = filterContent.style.display === 'block';
                filterContent.style.display = isVisible ? 'none' : 'block';
                filterToggleIcon.innerHTML = isVisible ? '▾' : '▴';
            });
            if (populateDropdownsFn) {
                await populateDropdownsFn();
            }
            specificDropdownChangeHandlers.forEach(handlerConfig => {
                const dropdown = filterContent.querySelector(`#${handlerConfig.dropdownId}`);
                if (dropdown) {
                    dropdown.addEventListener('change', handlerConfig.handlerFn);
                }
            });
            const applyButton = filterContent.querySelector('button[id^="js-apply-"]');
            if (applyButton && applyFiltersFn) applyButton.addEventListener('click', applyFiltersFn);
            const resetButton = filterContent.querySelector('button[id^="js-reset-"]');
            if (resetButton && resetFiltersFn) resetButton.addEventListener('click', resetFiltersFn);
        }
        async function createStudentFilterRows(filterContentDiv) {
            const row1 = createElementJS('div', { class: 'form-row' });
            const classGroup = createElementJS('div', { class: 'form-group' });
            classGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-class' }, 'کلاس'));
            classGroup.appendChild(createElementJS('select', { class: 'form-control', id: 'js-filter-student-class', multiple: true, style: { height: '100px' } }));
            row1.appendChild(classGroup);
            const sectionGroup = createElementJS('div', { class: 'form-group' });
            sectionGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-section' }, 'سیکشن'));
            sectionGroup.appendChild(createElementJS('select', { class: 'form-control', id: 'js-filter-student-section', multiple: true, style: { height: '100px' } }));
            row1.appendChild(sectionGroup);
            filterContentDiv.appendChild(row1);
            const row2 = createElementJS('div', { class: 'form-row' });
            const genderGroup = createElementJS('div', { class: 'form-group' });
            genderGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-gender' }, 'جنس'));
            const genderSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-student-gender' });
            genderSelect.appendChild(createElementJS('option', { value: '' }, 'تمام'));
            genderSelect.appendChild(createElementJS('option', { value: 'مرد' }, 'مرد'));
            genderSelect.appendChild(createElementJS('option', { value: 'عورت' }, 'عورت'));
            genderGroup.appendChild(genderSelect);
            row2.appendChild(genderGroup);
            const feeCategoryGroup = createElementJS('div', { class: 'form-group' });
            feeCategoryGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-fee-category' }, 'فیس کیٹیگری'));
            const feeCategorySelect = createElementJS('select', { class: 'form-control', id: 'js-filter-student-fee-category' });
            feeCategorySelect.appendChild(createElementJS('option', { value: '' }, 'تمام'));
            ['عام', 'مستحق', 'اسکالرشپ', 'مکمل معاف'].forEach(cat => {
                feeCategorySelect.appendChild(createElementJS('option', { value: cat }, cat));
            });
            feeCategoryGroup.appendChild(feeCategorySelect);
            row2.appendChild(feeCategoryGroup);
            filterContentDiv.appendChild(row2);
            const row3 = createElementJS('div', { class: 'form-row' });
            const dateFromGroup = createElementJS('div', { class: 'form-group' });
            dateFromGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-admission-date-from' }, 'داخلہ تاریخ (سے)'));
            dateFromGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-admission-date-from' }));
            row3.appendChild(dateFromGroup);
            const dateToGroup = createElementJS('div', { class: 'form-group' });
            dateToGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-admission-date-to' }, 'داخلہ تاریخ (تک)'));
            dateToGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-admission-date-to' }));
            row3.appendChild(dateToGroup);
            filterContentDiv.appendChild(row3);
            const row4 = createElementJS('div', { class: 'form-row' });
            row4.appendChild(createElementJS('button', { class: 'btn btn-primary', id: 'js-apply-student-filters-btn' }, 'فلٹر کریں'));
            row4.appendChild(createElementJS('button', { class: 'btn btn-danger', id: 'js-reset-student-filters-btn', style: { marginRight: '10px' } }, 'فلٹر ری سیٹ'));
            filterContentDiv.appendChild(row4);
        }
        async function populateStudentFilterDropdownsJS() {
            try {
                const classes = await getAllFromStore(STORES.CLASSES);
                const classFilterDropdown = document.getElementById('js-filter-student-class');
                if (!classFilterDropdown) return;
                classFilterDropdown.innerHTML = '';
                classes.forEach(cls => {
                    classFilterDropdown.appendChild(createElementJS('option', { value: cls.id }, cls.name));
                });
                await populateStudentFilterSectionsJS();
            } catch (error) {
                console.error('Error populating student class filter dropdown (JS):', error);
            }
        }
        async function populateStudentFilterSectionsJS() {
            const classFilterDropdown = document.getElementById('js-filter-student-class');
            const sectionFilterDropdown = document.getElementById('js-filter-student-section');
            if (!classFilterDropdown || !sectionFilterDropdown) return;
            sectionFilterDropdown.innerHTML = '';
            const selectedClassIds = Array.from(classFilterDropdown.selectedOptions).map(opt => parseInt(opt.value));
            if (selectedClassIds.length === 0) {
                const allSections = await getAllFromStore(STORES.SECTIONS);
                for (const section of allSections) {
                    const classData = await getFromStore(STORES.CLASSES, section.classId);
                    sectionFilterDropdown.appendChild(
                        createElementJS('option', { value: section.id }, `${section.name} (${classData?.name || 'N/A'})`)
                    );
                }
                return;
            }
            for (const classId of selectedClassIds) {
                if (isNaN(classId)) continue;
                try {
                    const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                    const classData = await getFromStore(STORES.CLASSES, classId);
                    sections.forEach(section => {
                        sectionFilterDropdown.appendChild(
                            createElementJS('option', { value: section.id }, `${section.name} (${classData?.name || 'N/A'})`)
                        );
                    });
                } catch (error) {
                    console.error(`Error populating JS sections for class ID ${classId}:`, error);
                }
            }
        }
        async function applyStudentFiltersJS() {
            showLoading();
            try {
                const selectedClassIds = Array.from(document.getElementById('js-filter-student-class').selectedOptions).map(opt => parseInt(opt.value));
                const selectedSectionIds = Array.from(document.getElementById('js-filter-student-section').selectedOptions).map(opt => parseInt(opt.value));
                const selectedGender = document.getElementById('js-filter-student-gender').value;
                const selectedFeeCategory = document.getElementById('js-filter-student-fee-category').value;
                const admissionDateFromStr = document.getElementById('js-filter-admission-date-from').value;
                const admissionDateToStr = document.getElementById('js-filter-admission-date-to').value;
                let students = await getAllFromStore(STORES.STUDENTS);
                if (selectedClassIds.length > 0) {
                    students = students.filter(student => selectedClassIds.includes(student.classId));
                }
                if (selectedSectionIds.length > 0) {
                    students = students.filter(student => selectedSectionIds.includes(student.sectionId));
                }
                if (selectedGender) {
                    students = students.filter(student => student.gender === selectedGender);
                }
                if (selectedFeeCategory) {
                    students = students.filter(student => student.feeCategory === selectedFeeCategory);
                }
                if (admissionDateFromStr) {
                    const fromDate = new Date(admissionDateFromStr);
                    students = students.filter(student => student.admissionDate && new Date(student.admissionDate) >= fromDate);
                }
                if (admissionDateToStr) {
                    const toDate = new Date(admissionDateToStr);
                    students = students.filter(student => student.admissionDate && new Date(student.admissionDate) <= toDate);
                }
                loadStudentsTable(students);
            } catch (error) {
                console.error("Error applying student filters (JS):", error);
                showNotification('فلٹر اپلائی کرنے میں خرابی ہوئی۔', 'error');
            } finally {
                hideLoading();
            }
        }
        function resetStudentFiltersJS() {
            const classSelect = document.getElementById('js-filter-student-class');
            if (classSelect) Array.from(classSelect.options).forEach(opt => opt.selected = false);
            const sectionSelect = document.getElementById('js-filter-student-section');
            if (sectionSelect) sectionSelect.innerHTML = '';
            populateStudentFilterSectionsJS();
            const genderSelect = document.getElementById('js-filter-student-gender');
            if (genderSelect) genderSelect.value = '';
            const feeCatSelect = document.getElementById('js-filter-student-fee-category');
            if (feeCatSelect) feeCatSelect.value = '';
            const dateFrom = document.getElementById('js-filter-admission-date-from');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('js-filter-admission-date-to');
            if (dateTo) dateTo.value = '';
            loadStudentsTable();
        }
        async function createTeacherFilterRows(filterContentDiv) {
            const row1 = createElementJS('div', { class: 'form-row' });
            const subjectGroup = createElementJS('div', { class: 'form-group' });
            subjectGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-subject' }, 'مضمون'));
            subjectGroup.appendChild(createElementJS('select', { class: 'form-control', id: 'js-filter-teacher-subject', multiple: true, style: { height: '100px' } }));
            row1.appendChild(subjectGroup);
            const qualGroup = createElementJS('div', { class: 'form-group' });
            qualGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-qualification' }, 'قابلیت (تلاش)'));
            qualGroup.appendChild(createElementJS('input', { type: 'text', class: 'form-control', id: 'js-filter-teacher-qualification', placeholder: 'مثال: عالم، فاضل' }));
            row1.appendChild(qualGroup);
            filterContentDiv.appendChild(row1);
            const row2 = createElementJS('div', { class: 'form-row' });
            const dateFromGroup = createElementJS('div', { class: 'form-group' });
            dateFromGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-joining-from' }, 'شمولیت تاریخ (سے)'));
            dateFromGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-teacher-joining-from' }));
            row2.appendChild(dateFromGroup);
            const dateToGroup = createElementJS('div', { class: 'form-group' });
            dateToGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-joining-to' }, 'شمولیت تاریخ (تک)'));
            dateToGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-teacher-joining-to' }));
            row2.appendChild(dateToGroup);
            filterContentDiv.appendChild(row2);
            const row3 = createElementJS('div', { class: 'form-row' });
            row3.appendChild(createElementJS('button', { class: 'btn btn-primary', id: 'js-apply-teacher-filters-btn' }, 'فلٹر کریں'));
            row3.appendChild(createElementJS('button', { class: 'btn btn-danger', id: 'js-reset-teacher-filters-btn', style: { marginRight: '10px' } }, 'فلٹر ری سیٹ'));
            filterContentDiv.appendChild(row3);
        }
        async function populateTeacherFilterDropdownsJS() {
            try {
                const subjects = await getAllFromStore(STORES.SUBJECTS);
                const subjectFilterDropdown = document.getElementById('js-filter-teacher-subject');
                if (!subjectFilterDropdown) return;
                subjectFilterDropdown.innerHTML = '';
                subjects.forEach(sub => {
                    subjectFilterDropdown.appendChild(createElementJS('option', { value: sub.id }, sub.name));
                });
            } catch (error) {
                console.error('Error populating teacher subject filter (JS):', error);
            }
        }
        async function applyTeacherFiltersJS() {
            showLoading();
            try {
                const selectedSubjectIds = Array.from(document.getElementById('js-filter-teacher-subject').selectedOptions).map(opt => parseInt(opt.value));
                const qualificationSearch = document.getElementById('js-filter-teacher-qualification').value.toLowerCase();
                const joiningDateFromStr = document.getElementById('js-filter-teacher-joining-from').value;
                const joiningDateToStr = document.getElementById('js-filter-teacher-joining-to').value;
                let teachers = await getAllFromStore(STORES.TEACHERS);
                if (selectedSubjectIds.length > 0) {
                    teachers = teachers.filter(teacher => teacher.subjects && teacher.subjects.some(subId => selectedSubjectIds.includes(parseInt(subId))));
                }
                if (qualificationSearch) {
                    teachers = teachers.filter(teacher => teacher.qualification && teacher.qualification.toLowerCase().includes(qualificationSearch));
                }
                if (joiningDateFromStr) {
                    const fromDate = new Date(joiningDateFromStr);
                    teachers = teachers.filter(teacher => teacher.joiningDate && new Date(teacher.joiningDate) >= fromDate);
                }
                if (joiningDateToStr) {
                    const toDate = new Date(joiningDateToStr);
                    teachers = teachers.filter(teacher => teacher.joiningDate && new Date(teacher.joiningDate) <= toDate);
                }
                loadTeachersTable(teachers);
            } catch (error) {
                console.error("Error applying teacher filters (JS):", error);
            } finally {
                hideLoading();
            }
        }
        function resetTeacherFiltersJS() {
            const subjectSelect = document.getElementById('js-filter-teacher-subject');
            if (subjectSelect) Array.from(subjectSelect.options).forEach(opt => opt.selected = false);
            const qualInput = document.getElementById('js-filter-teacher-qualification');
            if (qualInput) qualInput.value = '';
            const dateFrom = document.getElementById('js-filter-teacher-joining-from');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('js-filter-teacher-joining-to');
            if (dateTo) dateTo.value = '';
            loadTeachersTable();
        }
        async function createStaffFilterRows(filterContentDiv) {
            const row1 = createElementJS('div', { class: 'form-row' });
            const desigGroup = createElementJS('div', { class: 'form-group' });
            desigGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-designation' }, 'عہدہ'));
            const desigSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-staff-designation' });
            desigSelect.appendChild(createElementJS('option', { value: '' }, 'تمام'));
            ['دفتری کلرک', 'لائبریرین', 'سیکیورٹی گارڈ', 'صفائی کرنے والا', 'ڈرائیور', 'دیگر'].forEach(d => {
                desigSelect.appendChild(createElementJS('option', { value: d }, d));
            });
            desigGroup.appendChild(desigSelect);
            row1.appendChild(desigGroup);
            const deptGroup = createElementJS('div', { class: 'form-group' });
            deptGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-department' }, 'شعبہ'));
            const deptSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-staff-department' });
            deptSelect.appendChild(createElementJS('option', { value: '' }, 'تمام'));
            ['انتظامیہ', 'اکاؤنٹس', 'لائبریری', 'سیکیورٹی', 'ٹرانسپورٹ', 'صفائی', 'دیگر'].forEach(d => {
                deptSelect.appendChild(createElementJS('option', { value: d }, d));
            });
            deptGroup.appendChild(deptSelect);
            row1.appendChild(deptGroup);
            filterContentDiv.appendChild(row1);
            const row2 = createElementJS('div', { class: 'form-row' });
            const dateFromGroup = createElementJS('div', { class: 'form-group' });
            dateFromGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-joining-from' }, 'شمولیت تاریخ (سے)'));
            dateFromGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-staff-joining-from' }));
            row2.appendChild(dateFromGroup);
            const dateToGroup = createElementJS('div', { class: 'form-group' });
            dateToGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-joining-to' }, 'شمولیت تاریخ (تک)'));
            dateToGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-staff-joining-to' }));
            row2.appendChild(dateToGroup);
            filterContentDiv.appendChild(row2);
            const row3 = createElementJS('div', { class: 'form-row' });
            row3.appendChild(createElementJS('button', { class: 'btn btn-primary', id: 'js-apply-staff-filters-btn' }, 'فلٹر کریں'));
            row3.appendChild(createElementJS('button', { class: 'btn btn-danger', id: 'js-reset-staff-filters-btn', style: { marginRight: '10px' } }, 'فلٹر ری سیٹ'));
            filterContentDiv.appendChild(row3);
        }
        async function applyStaffFiltersJS() {
            showLoading();
            try {
                const selectedDesignation = document.getElementById('js-filter-staff-designation').value;
                const selectedDepartment = document.getElementById('js-filter-staff-department').value;
                const joiningDateFromStr = document.getElementById('js-filter-staff-joining-from').value;
                const joiningDateToStr = document.getElementById('js-filter-staff-joining-to').value;
                let staffList = await getAllFromStore(STORES.STAFF);
                if (selectedDesignation) {
                    staffList = staffList.filter(staff => staff.designation === selectedDesignation);
                }
                if (selectedDepartment) {
                    staffList = staffList.filter(staff => staff.department === selectedDepartment);
                }
                if (joiningDateFromStr) {
                    const fromDate = new Date(joiningDateFromStr);
                    staffList = staffList.filter(staff => staff.joiningDate && new Date(staff.joiningDate) >= fromDate);
                }
                if (joiningDateToStr) {
                    const toDate = new Date(joiningDateToStr);
                    staffList = staffList.filter(staff => staff.joiningDate && new Date(staff.joiningDate) <= toDate);
                }
                loadStaffTable(staffList);
            } catch (error) {
                console.error("Error applying staff filters (JS):", error);
            } finally {
                hideLoading();
            }
        }
        function resetStaffFiltersJS() {
            const desigSelect = document.getElementById('js-filter-staff-designation');
            if (desigSelect) desigSelect.value = '';
            const deptSelect = document.getElementById('js-filter-staff-department');
            if (deptSelect) deptSelect.value = '';
            const dateFrom = document.getElementById('js-filter-staff-joining-from');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('js-filter-staff-joining-to');
            if (dateTo) dateTo.value = '';
            loadStaffTable();
        }
        async function loadTeachersTable(teachersToLoad = null) {
            try {
                const teachers = teachersToLoad === null ? await getAllFromStore(STORES.TEACHERS) : teachersToLoad;
                const tbody = document.querySelector('#teachers-table tbody');
                tbody.innerHTML = '';
                if (!teachers || teachers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی استاد موجود نہیں ہے یا فلٹر سے کوئی نتیجہ نہیں ملا۔</td></tr>';
                    return;
                }
                for (const teacher of teachers) {
                    const row = document.createElement('tr');
                    let subjectNames = '-';
                    if (teacher.subjects && teacher.subjects.length > 0) {
                        const subjectPromises = teacher.subjects.map(id => getFromStore(STORES.SUBJECTS, parseInt(id)));
                        const subjectObjects = await Promise.all(subjectPromises);
                        subjectNames = subjectObjects.filter(s => s).map(s => s.name).join(', ');
                    }
                    row.innerHTML = `
                <td>${teacher.employeeId}</td>
                <td>${teacher.name}</td>
                <td>${teacher.qualification}</td>
                <td>${subjectNames}</td>
                <td>${teacher.contact}</td>
                <td>${formatDate(teacher.joiningDate)}</td>
                <td>${teacher.basicSalary ? formatCurrency(teacher.basicSalary) : 'N/A'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editTeacher(${teacher.id})">ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.TEACHERS}', ${teacher.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading teachers table:', error);
                const tbody = document.querySelector('#teachers-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">اساتذہ کی فہرست لوڈ کرنے میں خرابی ہوئی۔</td></tr>';
            }
        }
        async function loadStaffTable(staffToLoad = null) {
            try {
                let staffArray;
                if (staffToLoad === null) {
                    staffArray = await getAllFromStore(STORES.STAFF);
                } else if (Array.isArray(staffToLoad)) {
                    staffArray = staffToLoad;
                } else {
                    console.warn('loadStaffTable called with non-array. Defaulting to all.', staffToLoad);
                    staffArray = await getAllFromStore(STORES.STAFF);
                }
                const tbody = document.querySelector('#staff-table tbody');
                if (!tbody) {
                    console.error("Staff table body not found!");
                    return;
                }
                tbody.innerHTML = '';
                if (!staffArray || !Array.isArray(staffArray) || staffArray.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">کوئی عملہ موجود نہیں ہے یا فلٹر سے کوئی نتیجہ نہیں ملا۔</td></tr>';
                    return;
                }
                staffArray.forEach(staff => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${staff.employeeId}</td>
                <td>${staff.name}</td>
                <td>${staff.designation}</td>
                <td>${staff.department}</td>
                <td>${staff.contact}</td>
                <td>${formatDate(staff.joiningDate)}</td>
                <td>${staff.basicSalary ? formatCurrency(staff.basicSalary) : 'N/A'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editStaff(${staff.id})">ترمیم</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.STAFF}', ${staff.id})">حذف کریں</button>
                </td>
            `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading staff table:', error);
            }
        }
        const REPORT_CONFIG = {
            students: [
                { id: 'student_strength_by_class', name: 'طلباء کی تعداد بلحاظ کلاس', filters: [], generator: generateStudentStrengthByClassReportJS, chartType: 'bar' },
                { id: 'student_gender_ratio_by_class', name: 'طلباء کی صنفی تناسب (کلاس وار)', filters: ['class_optional'], generator: generateStudentGenderRatioByClassReportJS, chartType: 'pie_multi' },
                { id: 'student_admission_trend', name: 'داخلوں کا ماہانہ رجحان', filters: ['year_optional'], generator: generateStudentAdmissionTrendReportJS, chartType: 'line' },
                { id: 'student_list_filtered', name: 'طلباء کی فہرست (فلٹر شدہ)', filters: ['class_optional', 'section_optional', 'gender_optional'], generator: generateFilteredStudentListReportJS, chartType: null }
            ],
            attendance: [
                { id: 'daily_attendance_summary', name: 'روزانہ حاضری کا خلاصہ', filters: ['date', 'class_optional', 'section_optional'], generator: generateDailyAttendanceSummaryReportJS, chartType: 'pie' },
                { id: 'monthly_attendance_student', name: 'ماہانہ حاضری فی طالب علم', filters: ['month_year', 'class', 'section', 'student_optional'], generator: generateMonthlyAttendanceByStudentReportJS, chartType: 'bar_grouped' },
                { id: 'class_attendance_percentage_range', name: 'کلاس وار حاضری کا فیصد (مدت)', filters: ['date_range', 'class_optional'], generator: generateClassAttendancePercentageRangeReportJS, chartType: 'bar' }
            ],
            fees: [
                { id: 'fee_collection_daily_summary', name: 'روزانہ فیس وصولی کا خلاصہ', filters: ['date'], generator: generateFeeCollectionDailySummaryReportJS, chartType: 'summary_cards' },
                { id: 'fee_collection_monthly_class', name: 'ماہانہ فیس وصولی (کلاس وار)', filters: ['month_year', 'class_optional'], generator: generateFeeCollectionMonthlyByClassReportJS, chartType: 'bar' },
                { id: 'fee_defaulters_list', name: 'فیس نادہندگان کی فہرست', filters: ['month_year', 'class_optional', 'section_optional'], generator: generateFeeDefaultersListReportJS, chartType: null },
                { id: 'fee_category_wise_collection', name: 'فیس کیٹیگری وار وصولی (مدت)', filters: ['date_range'], generator: generateFeeCategoryWiseCollectionReportJS, chartType: 'pie' }
            ],
        };
        let currentReportChart = null;
        async function initializeReportsViewJS() {
            const reportsViewDiv = document.getElementById('reports-view');
            if (!reportsViewDiv) {
                console.error("Reports view container 'reports-view' not found.");
                return;
            }
            const h2 = reportsViewDiv.querySelector('h2');
            reportsViewDiv.innerHTML = '';
            if (h2) reportsViewDiv.appendChild(h2);
            const formContainer = createElementJS('div', { class: 'form-container' });
            reportsViewDiv.appendChild(formContainer);
            formContainer.appendChild(createElementJS('div', { class: 'form-title' }, 'رپورٹ منتخب کریں'));
            const reportTypeRow = createElementJS('div', { class: 'form-row' });
            const reportTypeGroup = createElementJS('div', { class: 'form-group', style: { flexBasis: '100%' } });
            reportTypeGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-report-type-select' }, 'رپورٹ کی قسم'));
            const reportTypeSelect = createElementJS('select', { class: 'form-control', id: 'js-report-type-select' });
            reportTypeSelect.appendChild(createElementJS('option', { value: '' }, '--- منتخب کریں ---'));
            for (const categoryKey in REPORT_CONFIG) {
                let categoryLabel = categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);
                if (categoryKey === 'students') categoryLabel = 'طلباء';
                if (categoryKey === 'attendance') categoryLabel = 'حاضری';
                if (categoryKey === 'fees') categoryLabel = 'فیس';
                const optgroup = createElementJS('optgroup', { label: categoryLabel });
                REPORT_CONFIG[categoryKey].forEach(report => {
                    optgroup.appendChild(createElementJS('option', { value: `${categoryKey}:${report.id}` }, report.name));
                });
                reportTypeSelect.appendChild(optgroup);
            }
            reportTypeGroup.appendChild(reportTypeSelect);
            reportTypeRow.appendChild(reportTypeGroup);
            formContainer.appendChild(reportTypeRow);
            const filtersArea = createElementJS('div', { id: 'js-report-filters-area', class: 'form-row', style: { marginTop: '15px', display: 'none', flexWrap: 'wrap', gap: '15px' } });
            formContainer.appendChild(filtersArea);
            const generateBtnRow = createElementJS('div', { class: 'form-row', style: { marginTop: '15px' } });
            const generateBtn = createElementJS('button', { class: 'btn btn-primary', id: 'js-generate-report-btn' }, 'رپورٹ بنائیں');
            generateBtnRow.appendChild(generateBtn);
            formContainer.appendChild(generateBtnRow);
            const reportOutputDiv = createElementJS('div', { id: 'js-report-output-area', style: { marginTop: '20px' } });
            reportsViewDiv.appendChild(reportOutputDiv);
            reportTypeSelect.addEventListener('change', handleReportTypeChangeJS);
            generateBtn.addEventListener('click', generateSelectedReportJS);
            handleReportTypeChangeJS();
        }
        async function handleReportTypeChangeJS() {
            const selectedValue = document.getElementById('js-report-type-select').value;
            const filtersArea = document.getElementById('js-report-filters-area');
            filtersArea.innerHTML = '';
            filtersArea.style.display = 'none';
            if (!selectedValue) return;
            const [category, reportId] = selectedValue.split(':');
            const reportConfig = REPORT_CONFIG[category]?.find(r => r.id === reportId);
            if (!reportConfig || !reportConfig.filters || reportConfig.filters.length === 0) return;
            filtersArea.style.display = 'flex';
            for (const filterType of reportConfig.filters) {
                const filterGroup = createElementJS('div', { class: 'form-group' });
                let requiresRepopulate = false;
                switch (filterType) {
                    case 'date':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-date' }, 'تاریخ'));
                        filterGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-date', value: new Date().toISOString().split('T')[0] }));
                        break;
                    case 'date_range':
                    case 'date_range_year_month':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-date-from' }, 'تاریخ (سے)'));
                        filterGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-date-from' }));
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-date-to', style: { marginTop: '5px' } }, 'تاریخ (تک)'));
                        filterGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-date-to' }));
                        break;
                    case 'month_year':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-month' }, 'مہینہ'));
                        const monthSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-month' });
                        const months = ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"];
                        months.forEach((m, i) => monthSelect.appendChild(createElementJS('option', { value: i + 1 }, m)));
                        monthSelect.value = new Date().getMonth() + 1;
                        filterGroup.appendChild(monthSelect);
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-year', style: { marginTop: '5px' } }, 'سال'));
                        filterGroup.appendChild(createElementJS('input', { type: 'number', class: 'form-control', id: 'js-filter-year', value: new Date().getFullYear() }));
                        break;
                    case 'year_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-year-optional' }, 'سال (اختیاری)'));
                        const yearOptionalInput = createElementJS('input', { type: 'number', class: 'form-control', id: 'js-filter-year-optional', placeholder: 'خالی چھوڑیں موجودہ سال کے لیے' });
                        filterGroup.appendChild(yearOptionalInput);
                        break;
                    case 'class':
                    case 'class_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-class' }, 'کلاس'));
                        const classSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-class' });
                        if (filterType === 'class_optional') {
                            classSelect.appendChild(createElementJS('option', { value: '' }, 'تمام کلاسز'));
                        }
                        const classes = await getAllFromStore(STORES.CLASSES);
                        classes.forEach(c => classSelect.appendChild(createElementJS('option', { value: c.id }, c.name)));
                        filterGroup.appendChild(classSelect);
                        if (reportConfig.filters.includes('section_optional') || reportConfig.filters.includes('section')) {
                            classSelect.addEventListener('change', () => populateReportFilterSectionsJS(reportConfig.filters.includes('section_optional')));
                            requiresRepopulate = true;
                        }
                        if (reportConfig.filters.includes('student_optional')) {
                            classSelect.addEventListener('change', populateReportFilterStudentsJS);
                        }
                        break;
                    case 'section':
                    case 'section_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-section' }, 'سیکشن'));
                        const sectionSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-section' });
                        filterGroup.appendChild(sectionSelect);
                        if (reportConfig.filters.includes('student_optional')) {
                            sectionSelect.addEventListener('change', populateReportFilterStudentsJS);
                        }
                        requiresRepopulate = true;
                        break;
                    case 'gender_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-gender' }, 'جنس'));
                        const genderSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-gender' });
                        genderSelect.appendChild(createElementJS('option', { value: '' }, 'تمام'));
                        genderSelect.appendChild(createElementJS('option', { value: 'مرد' }, 'مرد'));
                        genderSelect.appendChild(createElementJS('option', { value: 'عورت' }, 'عورت'));
                        filterGroup.appendChild(genderSelect);
                        break;
                    case 'student_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student' }, 'طالب علم'));
                        const studentSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-student' });
                        filterGroup.appendChild(studentSelect);
                        requiresRepopulate = true;
                        break;
                }
                filtersArea.appendChild(filterGroup);
                if (requiresRepopulate) {
                    if (filterType.includes('section')) await populateReportFilterSectionsJS(filterType === 'section_optional');
                    if (filterType.includes('student')) await populateReportFilterStudentsJS();
                }
            }
        }
        async function populateReportFilterSectionsJS(isOptional = false) {
            const classSelect = document.getElementById('js-filter-class');
            const sectionSelect = document.getElementById('js-filter-section');
            if (!sectionSelect) return;
            sectionSelect.innerHTML = '';
            if (isOptional) {
                sectionSelect.appendChild(createElementJS('option', { value: '' }, 'تمام سیکشنز'));
            }
            const classId = classSelect ? parseInt(classSelect.value) : null;
            if (classId && !isNaN(classId)) {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                sections.forEach(s => sectionSelect.appendChild(createElementJS('option', { value: s.id }, s.name)));
            } else if (!classId && isOptional) {
                const allSections = await getAllFromStore(STORES.SECTIONS);
                for (const s of allSections) {
                    const c = await getFromStore(STORES.CLASSES, s.classId);
                    sectionSelect.appendChild(createElementJS('option', { value: s.id }, `${s.name} (${c?.name || ''})`));
                }
            } else if (!classId && !isOptional) {
                sectionSelect.appendChild(createElementJS('option', { value: '' }, 'پہلے کلاس منتخب کریں'));
            }
        }
        async function populateReportFilterStudentsJS() {
            const studentSelect = document.getElementById('js-filter-student');
            if (!studentSelect) return;
            studentSelect.innerHTML = '';
            studentSelect.appendChild(createElementJS('option', { value: '' }, 'تمام طلباء'));
            const classIdVal = document.getElementById('js-filter-class')?.value;
            const sectionIdVal = document.getElementById('js-filter-section')?.value;
            const classId = classIdVal ? parseInt(classIdVal) : null;
            const sectionId = sectionIdVal ? parseInt(sectionIdVal) : null;
            let students = await getAllFromStore(STORES.STUDENTS);
            if (classId && !isNaN(classId)) {
                students = students.filter(s => s.classId === classId);
            }
            if (sectionId && !isNaN(sectionId)) {
                students = students.filter(s => s.sectionId === sectionId);
            }
            students.sort((a, b) => (a.name || "").localeCompare(b.name || "", 'ur'));
            students.forEach(s => studentSelect.appendChild(createElementJS('option', { value: s.id }, `${s.name || 'بلا نام'} (${s.rollNumber || 'N/A'})`)));
        }
        async function generateSelectedReportJS() {
            const selectedValue = document.getElementById('js-report-type-select').value;
            const outputDiv = document.getElementById('js-report-output-area');
            outputDiv.innerHTML = '';
            if (currentReportChart) {
                currentReportChart.destroy();
                currentReportChart = null;
            }
            if (!selectedValue) {
                showNotification('براہ کرم رپورٹ کی قسم منتخب کریں۔', 'error');
                return;
            }
            showLoading();
            const [category, reportId] = selectedValue.split(':');
            const reportConfig = REPORT_CONFIG[category]?.find(r => r.id === reportId);
            if (!reportConfig || !reportConfig.generator) {
                outputDiv.innerHTML = '<p>رپورٹ جنریٹر فنکشن نہیں ملا۔</p>';
                hideLoading();
                return;
            }
            try {
                const filterValues = {};
                if (reportConfig.filters) {
                    reportConfig.filters.forEach(filterKey => {
                        if (filterKey === 'date') filterValues.date = document.getElementById('js-filter-date')?.value;
                        if (filterKey === 'date_range' || filterKey === 'date_range_year_month') {
                            filterValues.dateFrom = document.getElementById('js-filter-date-from')?.value;
                            filterValues.dateTo = document.getElementById('js-filter-date-to')?.value;
                        }
                        if (filterKey === 'month_year') {
                            filterValues.month = parseInt(document.getElementById('js-filter-month')?.value);
                            filterValues.year = parseInt(document.getElementById('js-filter-year')?.value);
                        }
                        if (filterKey === 'year_optional') {
                            const yearVal = document.getElementById('js-filter-year-optional')?.value;
                            filterValues.year = yearVal ? parseInt(yearVal) : new Date().getFullYear();
                        }
                        if (filterKey === 'class' || filterKey === 'class_optional') {
                            const val = document.getElementById('js-filter-class')?.value;
                            filterValues.classId = val ? parseInt(val) : null;
                        }
                        if (filterKey === 'section' || filterKey === 'section_optional') {
                            const val = document.getElementById('js-filter-section')?.value;
                            filterValues.sectionId = val ? parseInt(val) : null;
                        }
                        if (filterKey === 'gender_optional') {
                            filterValues.gender = document.getElementById('js-filter-gender')?.value || null;
                        }
                        if (filterKey === 'student_optional') {
                            const val = document.getElementById('js-filter-student')?.value;
                            filterValues.studentId = val ? parseInt(val) : null;
                        }
                    });
                }
                const { html, chartData } = await reportConfig.generator(filterValues);
                outputDiv.innerHTML = html;
                if (chartData && reportConfig.chartType && chartData.canvasId) {
                    if (typeof Chart === 'undefined') {
                        console.warn("Chart.js library is not loaded. Skipping chart rendering.");
                        const placeholder = document.getElementById(chartData.canvasId);
                        if (placeholder) placeholder.innerHTML = '<p style="text-align:center; color: #777;"><em>Chart.js library not loaded.</em></p>';
                    } else {
                        renderChart(reportConfig.chartType, chartData.canvasId, chartData.title, chartData.labels, chartData.datasets, chartData.options);
                    }
                }
            } catch (error) {
                console.error(`Error generating report '${reportConfig.name}':`, error);
                outputDiv.innerHTML = `<p style="color:red;">رپورٹ بنانے میں خرابی ہوئی: ${error.message}</p>`;
            } finally {
                hideLoading();
            }
        }
        function renderChart(type, canvasId, chartTitle, labels, datasets, chartOptions = {}) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn("Canvas not found for chart:", canvasId);
                return;
            }
            if (currentReportChart) {
                currentReportChart.destroy();
            }
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: chartTitle, font: { size: 16, family: "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', sans-serif" } },
                    legend: { labels: { font: { family: "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', sans-serif" } } }
                },
            };
            if (type === 'bar' || type === 'line' || type === 'bar_grouped') {
                defaultOptions.scales = { y: { beginAtZero: true, ticks: { font: { family: "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', sans-serif" } } }, x: { ticks: { font: { family: "'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', sans-serif" } } } };
            }
            currentReportChart = new Chart(ctx, {
                type: type === 'bar_grouped' ? 'bar' : type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: { ...defaultOptions, ...chartOptions }
            });
        }
        async function generateStudentStrengthByClassReportJS(filters) {
            const classes = await getAllFromStore(STORES.CLASSES);
            const students = await getAllFromStore(STORES.STUDENTS);
            let totalStudentsOverall = 0;
            const reportDataItems = classes.map(cls => {
                const classStudents = students.filter(s => s.classId === cls.id);
                totalStudentsOverall += classStudents.length;
                return { className: cls.name, studentCount: classStudents.length };
            });
            let tableHTML = `<h3>طلباء کی تعداد بلحاظ کلاس</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>کلاس کا نام</th><th>طلباء کی تعداد</th></tr></thead><tbody>`;
            reportDataItems.forEach(data => {
                tableHTML += `<tr><td>${data.className}</td><td>${data.studentCount}</td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr><td><strong>کل طلباء</strong></td><td><strong>${totalStudentsOverall}</strong></td></tr></tfoot></table></div>`;
            const chartCanvasId = `chart-std-strength-${Date.now()}`;
            tableHTML += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: 'طلباء کی تعداد بلحاظ کلاس',
                labels: reportDataItems.map(d => d.className),
                datasets: [{
                    label: 'طلباء کی تعداد',
                    data: reportDataItems.map(d => d.studentCount),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };
            return { html: tableHTML, chartData: chartData };
        }
        async function generateStudentGenderRatioByClassReportJS(filters) {
            let classesToReportOn = [];
            if (filters.classId && !isNaN(filters.classId)) {
                const cls = await getFromStore(STORES.CLASSES, filters.classId);
                if (cls) classesToReportOn.push(cls);
            } else {
                classesToReportOn = await getAllFromStore(STORES.CLASSES);
            }
            const students = await getAllFromStore(STORES.STUDENTS);
            let overallMale = 0;
            let overallFemale = 0;
            let overallOther = 0;
            let html = `<h3>طلباء کی صنفی تناسب بلحاظ کلاس</h3>`;
            const chartDataSets = [];
            for (const cls of classesToReportOn) {
                const classStudents = students.filter(s => s.classId === cls.id);
                const maleCount = classStudents.filter(s => s.gender === 'مرد').length;
                const femaleCount = classStudents.filter(s => s.gender === 'عورت').length;
                overallMale += maleCount;
                overallFemale += femaleCount;
                html += `<div class="form-container" style="margin-bottom:15px;">
                    <h4>کلاس: ${cls.name} (کل: ${classStudents.length})</h4>
                    <p>مرد: ${maleCount} (${classStudents.length > 0 ? ((maleCount / classStudents.length) * 100).toFixed(1) : 0}%)</p>
                    <p>عورت: ${femaleCount} (${classStudents.length > 0 ? ((femaleCount / classStudents.length) * 100).toFixed(1) : 0}%)</p>
                    <div style="height: 250px; position: relative;"><canvas id="chart-gender-${cls.id}-${Date.now()}"></canvas></div>
                 </div>`;
                chartDataSets.push({
                    canvasId: `chart-gender-${cls.id}-${Date.now()}`,
                    title: `صنفی تناسب - ${cls.name}`,
                    labels: ['مرد', 'عورت'],
                    datasets: [{
                        data: [maleCount, femaleCount],
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                    }]
                });
            }
            html += `<div class="form-container"><h4>مجموعی صنفی تناسب</h4>
                <p>کل مرد: ${overallMale}</p>
                <p>کل عورت: ${overallFemale}</p>
                <div style="height: 300px; position: relative;"><canvas id="chart-gender-overall-${Date.now()}"></canvas></div>
              </div>`;
            chartDataSets.push({
                canvasId: `chart-gender-overall-${Date.now()}`,
                title: `مجموعی صنفی تناسب`,
                labels: ['مرد', 'عورت'],
                datasets: [{
                    data: [overallMale, overallFemale],
                    backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 159, 64, 0.7)'],
                }]
            });
            return { html: html, chartData: chartDataSets, chartType: 'pie_multi' };
        }
        async function generateStudentAdmissionTrendReportJS(filters) {
            const year = filters.year || new Date().getFullYear();
            const students = await getAllFromStore(STORES.STUDENTS);
            const monthlyAdmissions = Array(12).fill(0);
            students.forEach(s => {
                if (s.admissionDate) {
                    const admissionDate = new Date(s.admissionDate);
                    if (admissionDate.getFullYear() === year) {
                        monthlyAdmissions[admissionDate.getMonth()]++;
                    }
                }
            });
            const monthsUrdu = ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"];
            let tableHTML = `<h3>${year} میں ماہانہ داخلوں کا رجحان</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>مہینہ</th><th>نئے داخلے</th></tr></thead><tbody>`;
            monthlyAdmissions.forEach((count, index) => {
                tableHTML += `<tr><td>${monthsUrdu[index]}</td><td>${count}</td></tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            const chartCanvasId = `chart-admission-trend-${Date.now()}`;
            tableHTML += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: `${year} میں ماہانہ داخلوں کا رجحان`,
                labels: monthsUrdu,
                datasets: [{
                    label: 'نئے داخلے',
                    data: monthlyAdmissions,
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            return { html: tableHTML, chartData: chartData };
        }
        async function generateFilteredStudentListReportJS(filters) {
            let students = await getAllFromStore(STORES.STUDENTS);
            if (filters.classId) {
                students = students.filter(s => s.classId === filters.classId);
            }
            if (filters.sectionId) {
                students = students.filter(s => s.sectionId === filters.sectionId);
            }
            if (filters.gender) {
                students = students.filter(s => s.gender === filters.gender);
            }
            let title = "طلباء کی فہرست";
            if (filters.classId || filters.sectionId || filters.gender) title += " (فلٹر شدہ)";
            let tableHTML = `<h3>${title} (کل: ${students.length})</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>رول نمبر</th><th>نام</th><th>والد کا نام</th><th>کلاس</th><th>سیکشن</th><th>جنس</th><th>رابطہ</th><th>داخلہ تاریخ</th></tr></thead><tbody>`;
            for (const student of students) {
                const classData = student.classId ? await getFromStore(STORES.CLASSES, student.classId) : null;
                const sectionData = student.sectionId ? await getFromStore(STORES.SECTIONS, student.sectionId) : null;
                tableHTML += `<tr>
                        <td>${student.rollNumber || 'N/A'}</td>
                        <td>${student.name || 'N/A'}</td>
                        <td>${student.fatherName || 'N/A'}</td>
                        <td>${classData ? classData.name : 'N/A'}</td>
                        <td>${sectionData ? sectionData.name : 'N/A'}</td>
                        <td>${student.gender || 'N/A'}</td>
                        <td>${student.contact || 'N/A'}</td>
                        <td>${student.admissionDate ? formatDate(student.admissionDate) : 'N/A'}</td>
                      </tr>`;
            }
            tableHTML += `</tbody></table></div>`;
            return { html: tableHTML, chartData: null };
        }
        async function generateDailyAttendanceSummaryReportJS(filters) {
            const { date, classId, sectionId } = filters;
            if (!date) return { html: "<p>براہ کرم تاریخ منتخب کریں۔</p>", chartData: null };
            let attendanceRecords = await getAllFromIndex(STORES.ATTENDANCE, 'date', date);
            let allStudentsInScope = await getAllFromStore(STORES.STUDENTS);
            let reportTitle = `${formatDate(date)} کی روزانہ حاضری کا خلاصہ`;
            if (classId && !isNaN(classId)) {
                const classInfo = await getFromStore(STORES.CLASSES, classId);
                reportTitle += ` - کلاس: ${classInfo?.name || 'N/A'}`;
                allStudentsInScope = allStudentsInScope.filter(s => s.classId === classId);
                attendanceRecords = attendanceRecords.filter(r => r.classId === classId);
                if (sectionId && !isNaN(sectionId)) {
                    const sectionInfo = await getFromStore(STORES.SECTIONS, sectionId);
                    reportTitle += ` - سیکشن: ${sectionInfo?.name || 'N/A'}`;
                    allStudentsInScope = allStudentsInScope.filter(s => s.sectionId === sectionId);
                    attendanceRecords = attendanceRecords.filter(r => r.sectionId === sectionId);
                }
            }
            const totalStudents = allStudentsInScope.length;
            let presentCount = 0;
            let absentCount = 0;
            let leaveCount = 0;
            let lateCount = 0;
            const studentAttendanceMap = new Map();
            attendanceRecords.forEach(rec => studentAttendanceMap.set(rec.studentId, rec));
            allStudentsInScope.forEach(student => {
                const record = studentAttendanceMap.get(student.id);
                if (record) {
                    if (record.isLeave) leaveCount++;
                    else if (record.status === 'present') presentCount++;
                    else if (record.status === 'absent') absentCount++;
                    if (record.isLate) lateCount++;
                } else {
                    absentCount++;
                }
            });
            const attendancePercentage = totalStudents > 0 ? ((presentCount / totalStudents) * 100).toFixed(1) : 0;
            let html = `<h3>${reportTitle}</h3>`;
            html += `<div class="dashboard-cards" style="justify-content: space-around; flex-wrap:wrap;">
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">کل طلباء</div><div class="card-value">${totalStudents}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">حاضر</div><div class="card-value" style="color: #2ecc71;">${presentCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">غیر حاضر</div><div class="card-value" style="color: #e74c3c;">${absentCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">رخصت</div><div class="card-value" style="color: #f39c12;">${leaveCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">دیر سے</div><div class="card-value" style="color: #e67e22;">${lateCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">حاضری %</div><div class="card-value" style="color: #3498db;">${attendancePercentage}%</div></div>
             </div>`;
            const chartCanvasId = `chart-daily-attendance-${Date.now()}`;
            html += `<div style="height: 300px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: 'روزانہ حاضری کی تقسیم',
                labels: ['حاضر', 'غیر حاضر', 'رخصت'],
                datasets: [{
                    data: [presentCount, absentCount, leaveCount],
                    backgroundColor: ['rgba(46, 204, 113, 0.7)', 'rgba(231, 76, 60, 0.7)', 'rgba(243, 156, 18, 0.7)'],
                }]
            };
            return { html: html, chartData: chartData };
        }
        async function generateMonthlyAttendanceByStudentReportJS(filters) {
            const { month, year, classId, sectionId, studentId } = filters;
            if (!month || !year || !classId) {
                return { html: "<p>براہ کرم مہینہ، سال اور کلاس منتخب کریں۔ سیکشن اختیاری ہے۔</p>", chartData: null };
            }
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('ur-PK', { month: 'long' });
            let html = `<h3>${monthName}، ${year} کی ماہانہ حاضری رپورٹ</h3>`;
            const sClass = await getFromStore(STORES.CLASSES, classId);
            html += `<p><strong>کلاس:</strong> ${sClass?.name || '-'}`;
            if (sectionId) {
                const sSection = await getFromStore(STORES.SECTIONS, sectionId);
                html += ` - <strong>سیکشن:</strong> ${sSection?.name || '-'}`;
            }
            html += `</p>`;
            let studentsToReport = [];
            if (studentId && !isNaN(studentId)) {
                const student = await getFromStore(STORES.STUDENTS, studentId);
                if (student && student.classId === classId && (!sectionId || student.sectionId === sectionId)) studentsToReport.push(student);
            } else {
                studentsToReport = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.classId === classId && (!sectionId || s.sectionId === sectionId));
            }
            if (studentsToReport.length === 0) return { html: html + "<p>اس معیار پر کوئی طالب علم نہیں ملا۔</p>", chartData: null };
            const allAttendance = await getAllFromStore(STORES.ATTENDANCE);
            html += `<div class="table-container"><table class="table">
                <thead><tr><th>رول نمبر</th><th>نام</th><th>کل ایام (ریکارڈ شدہ)</th><th>حاضر</th><th>غیر حاضر</th><th>رخصت</th><th>دیر سے</th><th>حاضری %</th></tr></thead>
                <tbody>`;
            const chartLabels = [];
            const presentDataset = [];
            const absentDataset = [];
            const leaveDataset = [];
            for (const student of studentsToReport) {
                const studentMonthlyAttendance = allAttendance.filter(r =>
                    r.studentId === student.id &&
                    new Date(r.date).getFullYear() === year &&
                    new Date(r.date).getMonth() + 1 === month
                );
                const totalRecordedDays = studentMonthlyAttendance.length;
                const present = studentMonthlyAttendance.filter(r => r.status === 'present' && !r.isLeave).length;
                const absent = studentMonthlyAttendance.filter(r => r.status === 'absent' && !r.isLeave).length;
                const onLeave = studentMonthlyAttendance.filter(r => r.isLeave).length;
                const late = studentMonthlyAttendance.filter(r => r.isLate).length;
                const effectiveDaysForPercentage = present + absent;
                const percentage = effectiveDaysForPercentage > 0 ? ((present / effectiveDaysForPercentage) * 100).toFixed(1) : (onLeave > 0 ? 'رخصت' : '0.0');
                html += `<tr>
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>${totalRecordedDays}</td>
                    <td>${present}</td>
                    <td>${absent}</td>
                    <td>${onLeave}</td>
                    <td>${late}</td>
                    <td>${percentage}${percentage !== 'رخصت' ? '%' : ''}</td>
                 </tr>`;
                if (studentsToReport.length <= 15) {
                    chartLabels.push(student.name.split(" ")[0]);
                    presentDataset.push(present);
                    absentDataset.push(absent);
                    leaveDataset.push(onLeave);
                }
            }
            html += `</tbody></table></div>`;
            let chartData = null;
            if (studentsToReport.length > 0 && studentsToReport.length <= 15) {
                const chartCanvasId = `chart-monthly-stud-att-${Date.now()}`;
                html += `<div style="height: 400px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
                chartData = {
                    canvasId: chartCanvasId,
                    title: `${sClass?.name || ''} ${sectionId ? '- ' + (await getFromStore(STORES.SECTIONS, sectionId))?.name : ''} - ماہانہ حاضری`,
                    labels: chartLabels,
                    datasets: [
                        { label: 'حاضر', data: presentDataset, backgroundColor: 'rgba(46, 204, 113, 0.7)' },
                        { label: 'غیر حاضر', data: absentDataset, backgroundColor: 'rgba(231, 76, 60, 0.7)' },
                        { label: 'رخصت', data: leaveDataset, backgroundColor: 'rgba(243, 156, 18, 0.7)' }
                    ]
                };
            }
            return { html: html, chartData: chartData };
        }
        async function generateClassAttendancePercentageRangeReportJS(filters) {
            const { dateFrom, dateTo, classId } = filters;
            if (!dateFrom || !dateTo) {
                return { html: "<p>براہ کرم تاریخ کی مدت منتخب کریں۔</p>", chartData: null };
            }
            let classesToReport = [];
            if (classId && !isNaN(classId)) {
                const cls = await getFromStore(STORES.CLASSES, classId);
                if (cls) classesToReport.push(cls);
            } else {
                classesToReport = await getAllFromStore(STORES.CLASSES);
            }
            if (classesToReport.length === 0) return { html: "<p>کوئی کلاس منتخب نہیں یا موجود نہیں۔</p>", chartData: null };
            const allAttendance = await getAllFromStore(STORES.ATTENDANCE);
            const allStudents = await getAllFromStore(STORES.STUDENTS);
            let html = `<h3>کلاس وار حاضری کا فیصد (${formatDate(dateFrom)} - ${formatDate(dateTo)})</h3>`;
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>کلاس</th><th>کل طلباء</th><th>کل حاضریاں (ریکارڈ شدہ)</th><th>کل ممکنہ حاضریاں</th><th>حاضری %</th></tr></thead>
               <tbody>`;
            const chartLabels = [];
            const chartPercentages = [];
            for (const cls of classesToReport) {
                const studentsInClass = allStudents.filter(s => s.classId === cls.id);
                let totalPresentInClass = 0;
                let totalPossibleAttendancesInClass = 0;
                let totalRecordedAttendancesByStudents = 0;
                for (const student of studentsInClass) {
                    const studentAttendanceInRange = allAttendance.filter(r => {
                        const recordDate = new Date(r.date);
                        return r.studentId === student.id &&
                            recordDate >= new Date(dateFrom) &&
                            recordDate <= new Date(dateTo) &&
                            !r.isLeave;
                    });
                    totalRecordedAttendancesByStudents += studentAttendanceInRange.length;
                    totalPresentInClass += studentAttendanceInRange.filter(r => r.status === 'present').length;
                }
                totalPossibleAttendancesInClass = totalRecordedAttendancesByStudents;
                const classPercentage = totalPossibleAttendancesInClass > 0 ?
                    ((totalPresentInClass / totalPossibleAttendancesInClass) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${cls.name}</td>
                    <td>${studentsInClass.length}</td>
                    <td>${totalPresentInClass}</td>
                    <td>${totalPossibleAttendancesInClass}</td>
                    <td>${classPercentage}%</td>
                 </tr>`;
                chartLabels.push(cls.name);
                chartPercentages.push(parseFloat(classPercentage));
            }
            html += `</tbody></table></div>`;
            const chartCanvasId = `chart-class-att-perc-${Date.now()}`;
            html += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: `کلاس وار حاضری کا فیصد (${formatDate(dateFrom)} - ${formatDate(dateTo)})`,
                labels: chartLabels,
                datasets: [{
                    label: 'حاضری %',
                    data: chartPercentages,
                    backgroundColor: chartLabels.map(() => `rgba(${Math.floor(Math.random() * 155) + 100}, ${Math.floor(Math.random() * 155) + 100}, ${Math.floor(Math.random() * 155) + 100}, 0.7)`),
                    borderColor: chartLabels.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`),
                    borderWidth: 1
                }]
            };
            return { html: html, chartData: chartData };
        }
        async function generateFeeCollectionDailySummaryReportJS(filters) {
            const { date } = filters;
            if (!date) return { html: "<p>براہ کرم تاریخ منتخب کریں۔</p>", chartData: null };
            const feeRecords = (await getAllFromStore(STORES.FEES)).filter(fr => fr.date === date);
            let totalCollected = 0;
            let byMethod = {};
            let byClass = {};
            const students = await getAllFromStore(STORES.STUDENTS);
            const studentMap = new Map(students.map(s => [s.id, s]));
            const classes = await getAllFromStore(STORES.CLASSES);
            const classMap = new Map(classes.map(c => [c.id, c]));
            feeRecords.forEach(rec => {
                totalCollected += rec.total || 0;
                byMethod[rec.paymentMethod] = (byMethod[rec.paymentMethod] || 0) + (rec.total || 0);
                const student = studentMap.get(rec.studentId);
                if (student && student.classId) {
                    const className = classMap.get(student.classId)?.name || 'دیگر';
                    byClass[className] = (byClass[className] || 0) + (rec.total || 0);
                }
            });
            let html = `<h3>${formatDate(date)} کی روزانہ فیس وصولی کا خلاصہ</h3>`;
            html += `<div class="dashboard-cards" style="justify-content: space-around; flex-wrap:wrap;">
               <div class="card" style="min-width:200px; margin:5px;">
                 <div class="card-title">کل وصولی</div>
                 <div class="card-value">${formatCurrency(totalCollected)}</div>
               </div>
               <div class="card" style="min-width:200px; margin:5px;">
                 <div class="card-title">ٹرانزیکشنز کی تعداد</div>
                 <div class="card-value">${feeRecords.length}</div>
               </div>
            </div>`;
            html += `<h4>وصولی بلحاظ طریقہ ادائیگی</h4><div class="table-container"><table class="table">
               <thead><tr><th>طریقہ</th><th>رقم</th></tr></thead><tbody>`;
            for (const method in byMethod) {
                html += `<tr><td>${method}</td><td>${formatCurrency(byMethod[method])}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            const chartCanvasIdMethods = `chart-fee-methods-${Date.now()}`;
            html += `<div style="height: 300px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasIdMethods}"></canvas></div>`;
            const charts = [];
            charts.push({
                type: 'pie',
                canvasId: chartCanvasIdMethods,
                title: 'وصولی بلحاظ طریقہ ادائیگی',
                labels: Object.keys(byMethod),
                datasets: [{ data: Object.values(byMethod), backgroundColor: Object.keys(byMethod).map(() => `rgba(${Math.floor(Math.random() * 200) + 55}, ${Math.floor(Math.random() * 200) + 55}, ${Math.floor(Math.random() * 200) + 55}, 0.7)`) }]
            });
            html += `<h4 style="margin-top:20px;">وصولی بلحاظ کلاس</h4><div class="table-container"><table class="table">
               <thead><tr><th>کلاس</th><th>رقم</th></tr></thead><tbody>`;
            for (const className in byClass) {
                html += `<tr><td>${className}</td><td>${formatCurrency(byClass[className])}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            const chartCanvasIdClasses = `chart-fee-classes-${Date.now()}`;
            html += `<div style="height: 300px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasIdClasses}"></canvas></div>`;
            charts.push({
                type: 'bar',
                canvasId: chartCanvasIdClasses,
                title: 'وصولی بلحاظ کلاس',
                labels: Object.keys(byClass),
                datasets: [{ label: 'وصول شدہ رقم', data: Object.values(byClass), backgroundColor: 'rgba(153, 102, 255, 0.6)' }]
            });
            return { html: html, chartData: charts, chartType: 'multi' };
        }
        async function generateFeeCollectionMonthlyByClassReportJS(filters) {
            const { month, year, classId } = filters;
            if (!month || !year) return { html: "<p>براہ کرم مہینہ اور سال منتخب کریں۔</p>", chartData: null };
            let classesToReport = [];
            if (classId && !isNaN(classId)) {
                const cls = await getFromStore(STORES.CLASSES, classId);
                if (cls) classesToReport.push(cls);
            } else {
                classesToReport = await getAllFromStore(STORES.CLASSES);
            }
            if (classesToReport.length === 0) return { html: "<p>کوئی کلاس منتخب نہیں یا موجود نہیں۔</p>", chartData: null };
            const feeRecords = (await getAllFromStore(STORES.FEES)).filter(fr => parseInt(fr.month) === month && parseInt(fr.year) === year);
            const students = await getAllFromStore(STORES.STUDENTS);
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('ur-PK', { month: 'long' });
            let html = `<h3>${monthName}، ${year} کی ماہانہ فیس وصولی (کلاس وار)</h3>`;
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>کلاس</th><th>کل طلباء</th><th>فیس دہندگان</th><th>کل متوقع فیس</th><th>کل وصول شدہ</th><th>وصولی %</th></tr></thead>
               <tbody>`;
            const chartLabels = [];
            const chartCollected = [];
            const chartExpected = [];
            let grandTotalExpected = 0;
            let grandTotalCollected = 0;
            for (const cls of classesToReport) {
                const studentsInClass = students.filter(s => s.classId === cls.id);
                let classTotalCollected = 0;
                let classPaidCount = 0;
                let classTotalExpected = 0;
                studentsInClass.forEach(student => {
                    const studentFeeStructure = getFeeStructureForStudent(student.id, cls.id, student.feeCategory);
                    classTotalExpected += studentFeeStructure?.monthlyFee || student.monthlyFee || 0;
                    const studentFeeRecord = feeRecords.find(fr => fr.studentId === student.id);
                    if (studentFeeRecord) {
                        classTotalCollected += studentFeeRecord.total || 0;
                        classPaidCount++;
                    }
                });
                grandTotalExpected += classTotalExpected;
                grandTotalCollected += classTotalCollected;
                const collectionPercentage = classTotalExpected > 0 ? ((classTotalCollected / classTotalExpected) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${cls.name}</td>
                    <td>${studentsInClass.length}</td>
                    <td>${classPaidCount}</td>
                    <td>${formatCurrency(classTotalExpected)}</td>
                    <td>${formatCurrency(classTotalCollected)}</td>
                    <td>${collectionPercentage}%</td>
                 </tr>`;
                chartLabels.push(cls.name);
                chartCollected.push(classTotalCollected);
                chartExpected.push(classTotalExpected);
            }
            html += `</tbody><tfoot>
                <tr>
                    <td colspan="3"><strong>مجموعی</strong></td>
                    <td><strong>${formatCurrency(grandTotalExpected)}</strong></td>
                    <td><strong>${formatCurrency(grandTotalCollected)}</strong></td>
                    <td><strong>${grandTotalExpected > 0 ? ((grandTotalCollected / grandTotalExpected) * 100).toFixed(1) : 0}%</strong></td>
                </tr>
             </tfoot></table></div>`;
            const chartCanvasId = `chart-monthly-fee-class-${Date.now()}`;
            html += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: `${monthName}، ${year} - فیس وصولی (متوقع بمقابلہ وصول شدہ)`,
                labels: chartLabels,
                datasets: [
                    {
                        label: 'متوقع فیس',
                        data: chartExpected,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'وصول شدہ فیس',
                        data: chartCollected,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            };
            return { html: html, chartData: chartData };
        }
        async function getFeeStructureForStudent(studentId, classId, feeCategory) {
            const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
            return feeStructures.find(fs => fs.classId === classId && fs.category === feeCategory) || { monthlyFee: 0 };
        }
        async function generateFeeDefaultersListReportJS(filters) {
            const { month, year, classId, sectionId } = filters;
            if (!month || !year) return { html: "<p>براہ کرم مہینہ اور سال منتخب کریں۔</p>", chartData: null };
            let studentsToList = await getAllFromStore(STORES.STUDENTS);
            const feeRecordsForMonth = (await getAllFromStore(STORES.FEES)).filter(fr => parseInt(fr.month) === month && parseInt(fr.year) === year);
            const paidStudentIds = new Set(feeRecordsForMonth.map(fr => fr.studentId));
            let reportTitle = `${new Date(year, month - 1, 1).toLocaleDateString('ur-PK', { month: 'long' })}، ${year} کے فیس نادہندگان`;
            if (classId && !isNaN(classId)) {
                studentsToList = studentsToList.filter(s => s.classId === classId);
                const clsInfo = await getFromStore(STORES.CLASSES, classId);
                reportTitle += ` - کلاس: ${clsInfo?.name || 'N/A'}`;
                if (sectionId && !isNaN(sectionId)) {
                    studentsToList = studentsToList.filter(s => s.sectionId === sectionId);
                    const secInfo = await getFromStore(STORES.SECTIONS, sectionId);
                    reportTitle += ` - سیکشن: ${secInfo?.name || 'N/A'}`;
                }
            }
            const defaulters = studentsToList.filter(s => !paidStudentIds.has(s.id));
            let html = `<h3>${reportTitle} (کل نادہندگان: ${defaulters.length})</h3>`;
            if (defaulters.length === 0) {
                html += "<p>اس مہینے کوئی نادہندہ نہیں ہے۔ شاباش!</p>";
                return { html: html, chartData: null };
            }
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>رول نمبر</th><th>نام</th><th>والد کا نام</th><th>کلاس</th><th>سیکشن</th><th>متوقع فیس</th><th>رابطہ نمبر</th></tr></thead>
               <tbody>`;
            let totalDefaultAmount = 0;
            for (const student of defaulters) {
                const classData = student.classId ? await getFromStore(STORES.CLASSES, student.classId) : null;
                const sectionData = student.sectionId ? await getFromStore(STORES.SECTIONS, student.sectionId) : null;
                const feeStructure = await getFeeStructureForStudent(student.id, student.classId, student.feeCategory);
                const expectedFee = feeStructure?.monthlyFee || student.monthlyFee || 0;
                totalDefaultAmount += expectedFee;
                html += `<tr>
                    <td>${student.rollNumber || 'N/A'}</td>
                    <td>${student.name || 'N/A'}</td>
                    <td>${student.fatherName || 'N/A'}</td>
                    <td>${classData?.name || 'N/A'}</td>
                    <td>${sectionData?.name || 'N/A'}</td>
                    <td>${formatCurrency(expectedFee)}</td>
                    <td>${student.contact || 'N/A'}</td>
                 </tr>`;
            }
            html += `</tbody><tfoot><tr><td colspan="5"><strong>کل واجب الادا رقم</strong></td><td colspan="2"><strong>${formatCurrency(totalDefaultAmount)}</strong></td></tr></tfoot></table></div>`;
            return { html: html, chartData: null };
        }
        async function generateFeeCategoryWiseCollectionReportJS(filters) {
            const { dateFrom, dateTo } = filters;
            if (!dateFrom || !dateTo) {
                return { html: "<p>براہ کرم تاریخ کی مدت منتخب کریں۔</p>", chartData: null };
            }
            const feeRecords = (await getAllFromStore(STORES.FEES)).filter(fr => {
                const recDate = new Date(fr.date);
                return recDate >= new Date(dateFrom) && recDate <= new Date(dateTo);
            });
            const students = await getAllFromStore(STORES.STUDENTS);
            const studentMap = new Map(students.map(s => [s.id, s]));
            const collectionByCategory = {};
            let totalCollected = 0;
            feeRecords.forEach(rec => {
                const student = studentMap.get(rec.studentId);
                const category = student?.feeCategory || 'نامعلوم';
                collectionByCategory[category] = (collectionByCategory[category] || 0) + (rec.total || 0);
                totalCollected += (rec.total || 0);
            });
            let html = `<h3>فیس کیٹیگری وار وصولی (${formatDate(dateFrom)} - ${formatDate(dateTo)})</h3>`;
            html += `<p><strong>کل وصول شدہ: ${formatCurrency(totalCollected)}</strong></p>`;
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>فیس کیٹیگری</th><th>وصول شدہ رقم</th><th>حصہ %</th></tr></thead><tbody>`;
            for (const category in collectionByCategory) {
                const percentage = totalCollected > 0 ? ((collectionByCategory[category] / totalCollected) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${category}</td>
                    <td>${formatCurrency(collectionByCategory[category])}</td>
                    <td>${percentage}%</td>
                 </tr>`;
            }
            html += `</tbody></table></div>`;
            const chartCanvasId = `chart-fee-cat-coll-${Date.now()}`;
            html += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: 'فیس کیٹیگری وار وصولی',
                labels: Object.keys(collectionByCategory),
                datasets: [{
                    data: Object.values(collectionByCategory),
                    backgroundColor: Object.keys(collectionByCategory).map((_, i) => `hsl(${(i * 360 / Object.keys(collectionByCategory).length) % 360}, 70%, 60%)`),
                }]
            };
            return { html: html, chartData: chartData };
        }
    </script>
</body>
</html>
<!DOCTYPE html>

<html dir="ltr" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>School &amp; Madrasa Management App</title>
<style>
        html,
        body {
            height: 100%;
        }

        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            direction: ltr;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
        }

        .sidebar {
            width: 250px;
            background-color: #34495e;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 70px;
            color: white;
            transition: all 0.3s;
            z-index: 999;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            padding: 10px 20px;
            border-bottom: 1px solid #465c6e;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar-menu li:hover {
            background-color: #2c3e50;
        }

        .sidebar-menu i {
            margin-right: 10px;
        }

        .main-container {
            margin-left: 250px;
            transition: all 0.3s;
            height: 100vh;
            overflow-y: auto;
            padding: 12px;
        }

        .main-content-inner {
            direction: ltr;
            padding: 4px;
        }

        .dashboard-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
            min-width: 250px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: bold;
        }

        .card-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 10px;
        }

        .card-subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }

        .form-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            gap: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            direction: ltr;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        .btn {
            padding: 3px 6px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-info {
            background-color: #3498db;
            color: white;
        }

        .btn-info:hover {
            background-color: #2980b9;
        }

        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
        }

        .table thead th {
            background-color: #f1f1f1;
            color: #333;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }

        .table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .table td {
            border-bottom: 1px solid #ddd;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }

        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-view {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 6px auto;
            padding: 12px;
            border: 1px solid #888;
            width: 80%;
            max-width: 530px !important;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            height: 97%;
            overflow-y: scroll;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .profile-card {
            display: flex;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .profile-image {
            width: 150px;
            padding: 20px;
        }

        .profile-image img {
            width: 100%;
            border-radius: 50%;
            border: 3px solid #3498db;
        }

        .profile-details {
            flex: 1;
            padding: 20px;
            text-align: center;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .profile-info {
            margin-bottom: 5px;
        }

        .profile-info span {
            font-weight: bold;
            margin-right: 10px;
            color: #7f8c8d;
        }

        /*         @media print {
            .sidebar,
            .header,
            .no-print {
                display: none !important;
            }
            .main-container {
                margin: 0;
                padding: 0;
            }
            .print-only {
                display: block;
            }
            .table-container,
            .form-container,
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        } */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                padding-top: 60px;
            }

            .sidebar.active {
                width: 250px;
            }

            .main-container {
                margin-left: 0;
            }

            .main-container.sidebar-active {
                margin-left: 250px;
            }

            .menu-toggle {
                display: block;
            }

            .dashboard-cards {
                flex-direction: column;
            }

            .card {
                min-width: 100%;
            }

            .form-group {
                min-width: 100%;
            }
        }

        .menu-toggle {
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1100;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1200;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .notification.success {
            background-color: #2ecc71;
        }

        .notification.error {
            background-color: #e74c3c;
        }

        .notification.info {
            background-color: #3498db;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .calendar {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar-nav button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #3498db;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .calendar-weekdays div {
            text-align: center;
            font-weight: bold;
            color: #7f8c8d;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .calendar-day:hover {
            background-color: #f1f1f1;
        }

        .calendar-day.today {
            background-color: #3498db;
            color: white;
        }

        .calendar-day.has-event {
            border: 2px solid #e74c3c;
        }

        #js-report-output-area .dashboard-cards .card {
            margin-bottom: 10px;
        }

        .filter-header-toggle {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .filter-toggle-icon {
            font-size: 1.2em;
            transition: transform 0.2s ease-in-out;
        }

        .id-card-container {
            width: 320px;
            height: 190px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            font-family: Arial, sans-serif;
            page-break-inside: avoid;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            margin: 10px;
        }

        .id-card-photo {
            width: 80px;
            height: 100px;
            border: 2px solid #2c3e50;
            margin-right: 10px;
        }

        .id-card-details {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            text-align: left;
        }

        .id-card-header {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .certificate-container {
            width: 800px;
            height: 550px;
            border: 5px double #2c3e50;
            padding: 25px;
            background-color: white;
            text-align: center;
            page-break-inside: avoid;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            background-image: url(bgc.png);
            background-repeat: no-repeat;
            background-size: 102% 106%;
            background-position: center;
            background-origin: border-box;
            background-clip: padding-box;
            position: relative;
        }

        .certificate-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url(logo2.png);
            background-size: 63%;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.1;
            pointer-events: none;
        }

        .certificate-container h2 {
            font-size: 32px;
            color: #2c3e50;
        }

        .certificate-container h3 {
            font-size: 24px;
        }

        .certificate-container p {
            font-size: 20px;
            line-height: 1.8;
        }

        .certificate-signature {
            display: flex;
            justify-content: space-around;
            margin-top: 50px;
            width: 99%;
            flex-wrap: wrap;
            flex-direction: row-reverse;
            align-items: flex-end;
        }

        .certificate-signature div {
            border-top: 1px solid #333;
            padding-top: 5px;
        }

        .card-wrapper {
            position: relative;
            margin: 15px;
            page-break-inside: avoid;
        }

        .id-card-front,
        .id-card-back {
            width: 336px;
            height: 210px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
        }

        .id-card-front {
            background: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)), url(logo2.png);
            background-size: cover, 42%;
            background-repeat: no-repeat, no-repeat;
            background-position: center, center;
            background-blend-mode: normal, color;
        }

        .id-card-back {
            margin-top: 10px;
            padding: 15px;
            text-align: left;
            background: linear-gradient(rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.8)), url(logo2.png);
            background-size: cover, 60%;
            background-repeat: no-repeat, no-repeat;
            background-position: center, center;
            background-blend-mode: normal, color;
        }

        .id-card-header {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            padding-bottom: 5px;
            border-bottom: 2px solid #2c3e50;
        }

        .id-card-content {
            display: flex;
            flex-grow: 1;
            padding-top: 10px;
        }

        .id-card-photo-container {
            width: 85px;
            height: 105px;
            text-align: center;
            cursor: pointer;
            margin-right: 10px;
        }

        .id-card-photo {
            width: 80px;
            height: 100px;
            border: 2px solid #2c3e50;
            object-fit: contain;
            background-color: #f0f0f0;
        }

        .id-card-details {
            flex: 1;
            padding-left: 10px;
            font-size: 14px;
            line-height: 1.5;
        }

        .id-card-back h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            text-align: center;
        }

        .id-card-back p {
            font-size: 12px;
            margin: 4px 0;
        }

        .id-card-qr-code {
            width: 80px;
            height: 80px;
            margin: 6px auto 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card-export-btn {
            position: absolute;
            top: -5px;
            left: 36px;
            z-index: 10;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .card-export-btn-back {
            position: absolute;
            top: -5px;
            left: 70px;
            z-index: 10;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .certificate-wrapper {
            position: relative;
            padding-top: 20px;
        }

        .certificate-container b {
            text-decoration: underline;
        }

        .receipt-paper {
            width: 300px;
            padding: 15px;
            background: #fff;
            color: #000;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.6;
            border: 1px dashed #000;
            position: relative;
            overflow: hidden;
        }

        .receipt-paper h3 {
            text-align: center;
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .receipt-paper p {
            margin: 2px 0;
        }

        .receipt-paper hr {
            border: none;
            border-top: 1px dashed #000;
            margin: 8px 0;
        }

        .receipt-paper .receipt-item {
            display: flex;
            justify-content: space-between;
        }

        .receipt-paper .receipt-total {
            font-weight: bold;
            font-size: 14px;
            border-top: 1px solid #000;
            margin-top: 8px;
            padding-top: 5px;
        }

        .receipt-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 72px;
            font-weight: bold;
            color: rgba(0, 128, 0, 0.15);
            z-index: 1;
            pointer-events: none;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        input[readonly] {
            background-color: #f5f7fa;
            color: #333;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-style: italic;
            cursor: not-allowed;
            opacity: 1;
            box-shadow: 0 1px 2px rgba(0, 0, 0, .03);
            transition: border-color .2s, box-shadow .2s;
        }

        input[readonly]:focus {
            outline: none;
            border-color: #a0aec0;
            box-shadow: 0 0 0 2px #e2e8f0;
        }

        select#language-switcher {
            display: none;
        }

        .table-controls .btn-danger {
            transition: opacity 0.3s, background-color 0.3s;
        }

        body.pdf-loading .table-controls .btn-danger[id*='pdf-export'] {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #6c757d;
        }

        body.pdf-error .table-controls .btn-danger[id*='pdf-export'] {
            background-color: #dc3545;
            border-color: #dc3545;
            cursor: not-allowed;
        }

        body.pdf-error .table-controls .btn-danger[id*='pdf-export']::after {
            content: ' (Error)';
            font-size: 0.8em;
        }

        /* Find this rule and REPLACE it */
        .certificate-container {
            width: 800px;
            height: 550px;
            border: 5px double #2c3e50;
            padding: 25px;
            background-color: white;
            text-align: center;
            page-break-inside: avoid;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            /* --- MODIFIED LINES --- */
            background-repeat: no-repeat;
            background-size: 102% 106%;
            background-position: center;
            background-origin: border-box;
            background-clip: padding-box;
            position: relative;
            transition: background-image 0.3s ease-in-out;
            /* Added for smooth frame switching */
        }

        /* Find this rule and make sure it exists */
        .certificate-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url(logo2.png);
            background-size: 63%;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.1;
            pointer-events: none;
        }

        /* Find this rule and REPLACE it */
        .certificate-container [contenteditable="true"] {
            cursor: text;
            padding: 5px;
            outline: 1px dashed rgba(52, 152, 219, 0.5);
            /* Made outline subtle */
            transition: all 0.2s ease-in-out;
            min-height: 1.2em;
            /* Ensure empty elements are clickable */
        }

        /* Find this rule and REPLACE it */
        .certificate-container [contenteditable="true"]:hover,
        .certificate-container [contenteditable="true"]:focus {
            background-color: rgba(52, 152, 219, 0.1);
            outline: 1px solid #3498db;
        }

        /* --- ADD these NEW rules for the buttons --- */
        .certificate-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
            color: #777;
        }

        .cert-frame-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: background-color 0.2s, color 0.2s;
        }

        .cert-frame-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .certificate-container p {
            padding: 0px 22px !important;
        }

        .certificate-container h2,
        .certificate-container h3 {
            background: #ffffffad;
            border-radius: 67px;
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<link href="favicon.svg" rel="icon" type="image/svg+xml"/>
<link href="manifest.json" rel="manifest"/>
</head>
<body>
<div class="modal" id="combined-message-modal">
<div class="modal-content" style="max-width: 600px;">
<span class="close" id="combined-message-modal-close">×</span>
<div class="form-title">Combined Message for WhatsApp</div>
<p>This message is ready to be pasted into your WhatsApp group.</p>
<textarea class="form-control" id="combined-message-textarea" readonly="" rows="15"></textarea>
<div class="form-row" style="margin-top: 15px; justify-content: flex-end;">
<button class="btn btn-success" id="copy-combined-message-btn">Copy Message</button>
</div>
</div>
</div>
<div id="print-area" style="position: absolute; left: -9999px; top: -9999px;"></div>
<div class="modal" id="salary-slip-modal">
<div class="modal-content" style="max-width: 450px;">
<span class="close" id="salary-slip-modal-close">×</span>
<div id="slip-content-area">
</div>
<div class="form-row no-print" style="margin-top: 15px;">
<button class="btn btn-primary" id="print-slip-btn-final" style="width:100%;">Print Salary Slip</button>
</div>
</div>
</div>
<div class="modal" id="fee-receipt-modal">
<div class="modal-content" style="max-width: 336px !important;">
<span class="close" id="fee-receipt-modal-close">×</span>
<div id="receipt-content-area">
</div>
<div class="form-row no-print" style="margin-top: 15px;">
<button class="btn btn-primary" id="print-receipt-btn-final" style="width:100%;">Print Receipt</button>
</div>
</div>
</div>
<div class="modal" id="student-details-modal">
<div class="modal-content" style="max-width: 900px !important; overflow-y: auto;">
<span class="close" id="modal-close-btn">×</span>
<div id="modal-content-area">
</div>
</div>
</div>
<div class="modal" id="send-notice-modal">
<div class="modal-content" style="max-width: 500px;">
<span class="close" id="send-notice-modal-close">×</span>
<div class="form-title">Send Fee Reminder</div>
<div id="notice-student-info" style="margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 4px;">
</div>
<div class="form-group">
<label class="form-label">Message Template</label>
<textarea class="form-control" id="notice-message-template" rows="5" style="height: 448px;"></textarea>
</div>
<div class="form-row" style="margin-top: 20px; justify-content: flex-end;">
<button class="btn btn-success" id="send-whatsapp-btn" style="margin-right: 10px;">Send via
                    WhatsApp</button>
<button class="btn btn-primary" id="send-sms-btn">Send via SMS</button>
</div>
</div>
</div>
<div class="loading" id="loading">
<div class="spinner"></div>
</div>
<div class="notification" id="notification"></div>
<div class="menu-toggle" id="menuToggle">
<i class="fas fa-bars">☰</i>
</div>
<div class="sidebar" id="sidebar">
<ul class="sidebar-menu">
<li data-view="dashboard"><i class="fas fa-tachometer-alt">📊</i> Dashboard</li>
<li data-view="students"><i class="fas fa-user-graduate">👨‍🎓</i> Students</li>
<li data-view="teachers"><i class="fas fa-chalkboard-teacher">👨‍🏫</i> Teachers</li>
<li data-view="staff"><i class="fas fa-user-tie">👨‍💼</i> Staff</li>
<li data-view="classes"><i class="fas fa-chalkboard">🏫</i> Classes</li>
<li data-view="subjects"><i class="fas fa-book">📚</i> Subjects</li>
<li data-view="attendance"><i class="fas fa-clipboard-check">📋</i> Attendance</li>
<li data-view="exams"><i class="fas fa-file-alt">📝</i> Exams</li>
<li data-view="fees"><i class="fas fa-money-bill-wave">💰</i> Fees</li>
<li data-view="salaries"><i class="fas fa-wallet">👛</i> Salaries</li>
<li data-view="library"><i class="fas fa-book-reader">📖</i> Library</li>
<li data-view="users"><i class="fas fa-users-cog">👥</i> Users</li>
<li data-view="reports"><i class="fas fa-chart-bar">📊</i> Reports</li>
<li data-view="settings"><i class="fas fa-cog">⚙️</i> Settings</li>
<li data-view="backup"><i class="fas fa-database">💾</i> Backup</li>
<li data-view="id-cards"><i class="fas fa-id-card">💳</i> ID Cards &amp; Certificates</li>
<li onclick="logout()"><i class="fas fa-sign-out-alt">🚪</i> Logout</li>
</ul>
</div>
<div class="main-container" id="mainContainer">
<div class="main-content-inner"></div>
<div class="header">
<h1>School &amp; Madrasa Management App</h1>
</div>
<div class="section-view" id="dashboard-view" style="display: block;">
<h2>Dashboard</h2>
<div class="dashboard-cards">
<div class="card">
<div class="card-title">Total Students</div>
<div class="card-value" id="total-students">0</div>
<div class="card-subtitle">Registered Students</div>
</div>
<div class="card">
<div class="card-title">Total Teachers</div>
<div class="card-value" id="total-teachers">0</div>
<div class="card-subtitle">Registered Teachers</div>
</div>
<div class="card">
<div class="card-title">Total Classes</div>
<div class="card-value" id="total-classes">0</div>
<div class="card-subtitle">Active Classes</div>
</div>
<div class="card">
<div class="card-title">Today's Attendance</div>
<div class="card-value" id="today-attendance">0%</div>
<div class="card-subtitle">Students Present</div>
</div>
</div>
<div class="dashboard-cards">
<div class="card">
<div class="card-title">Monthly Fee Collection</div>
<div class="card-value" id="monthly-fee">0 Rs</div>
<div class="card-subtitle">Current Month</div>
</div>
<div class="card">
<div class="card-title">Outstanding Fees</div>
<div class="card-value" id="pending-fee">0 Rs</div>
<div class="card-subtitle">Pending Payments</div>
</div>
</div>
<div class="form-container">
<div class="form-title">Upcoming Events</div>
<div id="upcoming-events">
<div class="table-container">
<table class="table" id="events-table">
<thead>
<tr>
<th>No.</th>
<th>Event</th>
<th>Date</th>
<th>Location</th>
<th>Details</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="form-container">
<div class="form-title">Recent Activities</div>
<div id="recent-activities">
<div class="table-container">
<table class="table" id="activities-table">
<thead>
<tr>
<th>No.</th>
<th>Activity</th>
<th>Date</th>
<th>Related Person</th>
<th>Details</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="section-view" id="students-view">
<h2>Students</h2>
<div class="tabs">
<div class="tab active" data-tab="students-list">Student List</div>
<div class="tab" data-tab="add-student">Add New Student</div>
</div>
<div class="tab-content active" id="students-list">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<input class="form-control" id="student-search" placeholder="Search by student name, roll number or class" type="text"/>
</div>
<div class="form-group" style="flex: 0 0 auto;">
<button class="btn btn-primary" id="search-student-btn">Search</button>
</div>
</div>
</div>
<div class="table-container">
<table class="table" id="students-table">
<thead>
<tr>
<th>Roll No.</th>
<th>Name</th>
<th>Father's Name</th>
<th>Class</th>
<th>Section</th>
<th>Contact No.</th>
<th>Admission Date</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-student">
<div class="form-container">
<div class="form-title">Add New Student</div>
<form id="student-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Student Name</label>
<input class="form-control" id="student-name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Father's Name</label>
<input class="form-control" id="student-father" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Date of Birth</label>
<input class="form-control" id="student-dob" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Gender</label>
<select class="form-control" id="student-gender" required="">
<option value="Male">Male</option>
<option value="Female">Female</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="student-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="student-section" required="">
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Contact No.</label>
<input class="form-control" id="student-contact" required="" type="tel"/>
</div>
<div class="form-group">
<label class="form-label">Email</label>
<input class="form-control" id="student-email" type="email"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Guardian Name</label>
<input class="form-control" id="student-guardian" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Guardian Contact No.</label>
<input class="form-control" id="student-guardian-contact" type="tel"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Full Address</label>
<textarea class="form-control" id="student-address" required="" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Student Photo</label>
<input accept="image/*" class="form-control" id="student-photo" type="file"/>
</div>
<div class="form-group">
<label class="form-label">Admission Date</label>
<input class="form-control" id="student-admission-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Fee Category</label>
<select class="form-control" id="student-fee-category">
<option value="General">General</option>
<option value="Deserving">Deserving</option>
<option value="Scholarship">Scholarship</option>
<option value="Full Waiver">Full Waiver</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Monthly Fee</label>
<input class="form-control" id="student-monthly-fee" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Additional Info</label>
<textarea class="form-control" id="student-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row" id="student-status-container" style="display: none;">
<div class="form-group">
<label class="form-label">Student Status</label>
<select class="form-control" id="student-status">
<option value="active">Active</option>
<option value="promoted">Promoted Out</option>
<option value="left">Left School</option>
<option value="inactive">Inactive</option>
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add/Update Student</button>
<button class="btn btn-danger" style="margin-left: 10px;" type="reset">Reset Form</button>
</div>
</form>
</div>
</div>
</div>
<div class="section-view" id="teachers-view">
<h2>Teachers</h2>
<div class="tabs">
<div class="tab active" data-tab="teachers-list">Teacher List</div>
<div class="tab" data-tab="add-teacher">Add New Teacher</div>
</div>
<div class="tab-content active" id="teachers-list">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<input class="form-control" id="teacher-search" placeholder="Search by teacher name, subject or class" type="text"/>
</div>
<div class="form-group" style="flex: 0 0 auto;">
<button class="btn btn-primary" id="search-teacher-btn">Search</button>
</div>
</div>
</div>
<div class="table-container">
<table class="table" id="teachers-table">
<thead>
<tr>
<th>ID No.</th>
<th>Name</th>
<th>Qualification</th>
<th>Subject</th>
<th>Contact No.</th>
<th>Joining Date</th>
<th>Salary</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-teacher">
<div class="form-container">
<div class="form-title">Add New Teacher</div>
<form id="teacher-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Teacher Name</label>
<input class="form-control" id="teacher-name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Father's Name</label>
<input class="form-control" id="teacher-father" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Date of Birth</label>
<input class="form-control" id="teacher-dob" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Gender</label>
<select class="form-control" id="teacher-gender" required="">
<option value="Male">Male</option>
<option value="Female">Female</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Qualification</label>
<input class="form-control" id="teacher-qualification" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Specialization</label>
<input class="form-control" id="teacher-specialization" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Teacher Subjects</label>
<select class="form-control" id="teacher-subject" multiple="" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Classes</label>
<select class="form-control" id="teacher-class" multiple="">
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Contact No.</label>
<input class="form-control" id="teacher-contact" required="" type="tel"/>
</div>
<div class="form-group">
<label class="form-label">Email</label>
<input class="form-control" id="teacher-email" type="email"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Full Address</label>
<textarea class="form-control" id="teacher-address" required="" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">CNIC No.</label>
<input class="form-control" id="teacher-cnic" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Teacher Photo</label>
<input accept="image/*" class="form-control" id="teacher-photo" type="file"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Joining Date</label>
<input class="form-control" id="teacher-joining-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Basic Salary</label>
<input class="form-control" id="teacher-basic-salary" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Allowances</label>
<input class="form-control" id="teacher-allowances" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Deductions</label>
<input class="form-control" id="teacher-deductions" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Additional Info</label>
<textarea class="form-control" id="teacher-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add/Update Teacher</button>
<button class="btn btn-danger" style="margin-left: 10px;" type="reset">Reset Form</button>
</div>
</form>
</div>
</div>
</div>
<div class="section-view" id="staff-view">
<h2>Staff</h2>
<div class="tabs">
<div class="tab active" data-tab="staff-list">Staff List</div>
<div class="tab" data-tab="add-staff">Add New Staff</div>
</div>
<div class="tab-content active" id="staff-list">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<input class="form-control" id="staff-search" placeholder="Search by staff name, designation or department" type="text"/>
</div>
<div class="form-group" style="flex: 0 0 auto;">
<button class="btn btn-primary" id="search-staff-btn">Search</button>
</div>
</div>
</div>
<div class="table-container">
<table class="table" id="staff-table">
<thead>
<tr>
<th>ID No.</th>
<th>Name</th>
<th>Designation</th>
<th>Department</th>
<th>Contact No.</th>
<th>Joining Date</th>
<th>Salary</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-staff">
<div class="form-container">
<div class="form-title">Add New Staff</div>
<form id="staff-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Staff Name</label>
<input class="form-control" id="staff-name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Father's Name</label>
<input class="form-control" id="staff-father" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Date of Birth</label>
<input class="form-control" id="staff-dob" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Gender</label>
<select class="form-control" id="staff-gender" required="">
<option value="Male">Male</option>
<option value="Female">Female</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Designation</label>
<select class="form-control" id="staff-designation" required="">
<option value="Office Clerk">Office Clerk</option>
<option value="Librarian">Librarian</option>
<option value="Security Guard">Security Guard</option>
<option value="Cleaner">Cleaner</option>
<option value="Driver">Driver</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Department</label>
<select class="form-control" id="staff-department" required="">
<option value="Administration">Administration</option>
<option value="Accounts">Accounts</option>
<option value="Library">Library</option>
<option value="Security">Security</option>
<option value="Transport">Transport</option>
<option value="Cleaning">Cleaning</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Qualification</label>
<input class="form-control" id="staff-qualification" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Responsibilities</label>
<input class="form-control" id="staff-responsibilities" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Contact No.</label>
<input class="form-control" id="staff-contact" required="" type="tel"/>
</div>
<div class="form-group">
<label class="form-label">Email</label>
<input class="form-control" id="staff-email" type="email"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Full Address</label>
<textarea class="form-control" id="staff-address" required="" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">CNIC No.</label>
<input class="form-control" id="staff-cnic" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Staff Photo</label>
<input accept="image/*" class="form-control" id="staff-photo" type="file"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Joining Date</label>
<input class="form-control" id="staff-joining-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Basic Salary</label>
<input class="form-control" id="staff-basic-salary" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Allowances</label>
<input class="form-control" id="staff-allowances" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Deductions</label>
<input class="form-control" id="staff-deductions" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Additional Info</label>
<textarea class="form-control" id="staff-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add Staff</button>
<button class="btn btn-danger" style="margin-left: 10px;" type="reset">Reset Form</button>
</div>
</form>
</div>
</div>
</div>
<div class="section-view" id="classes-view">
<h2>Classes</h2>
<div class="tabs">
<div class="tab active" data-tab="classes-list">Class List</div>
<div class="tab" data-tab="add-class">Add New Class</div>
<div class="tab" data-tab="sections">Sections</div>
</div>
<div class="tab-content active" id="classes-list">
<div class="table-container">
<table class="table" id="classes-table">
<thead>
<tr>
<th>No.</th>
<th>Class Name</th>
<th>Class Incharge</th>
<th>Sections</th>
<th>No. of Students</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-class">
<div class="form-container">
<div class="form-title">Add New Class</div>
<form id="class-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Class Name</label>
<input class="form-control" id="class-name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Class Incharge</label>
<select class="form-control" id="class-incharge" required="">
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Class Level</label>
<input class="form-control" id="class-level" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Sections</label>
<select class="form-control" id="class-sections" multiple="" required="">
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Room No.</label>
<input class="form-control" id="class-room" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Fee Category</label>
<select class="form-control" id="class-fee-category">
<option value="General">General</option>
<option value="Special">Special</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Monthly Fee</label>
<input class="form-control" id="class-monthly-fee" required="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Admission Fee</label>
<input class="form-control" id="class-admission-fee" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Additional Info</label>
<textarea class="form-control" id="class-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add Class</button>
<button class="btn btn-danger" style="margin-left: 10px;" type="reset">Reset Form</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="sections">
<div class="form-container">
<div class="form-title">Section Management</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="section-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="section-name" required="">
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Section Incharge</label>
<select class="form-control" id="section-incharge" required="">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="save-section" type="button">Save Section</button>
</div>
</div>
<div class="table-container">
<table class="table" id="sections-table">
<thead>
<tr>
<th>No.</th>
<th>Class</th>
<th>Section</th>
<th>Section Incharge</th>
<th>No. of Students</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="section-view" id="subjects-view">
<h2>Subjects</h2>
<div class="tabs">
<div class="tab active" data-tab="subjects-list">Subject List</div>
<div class="tab" data-tab="add-subject">Add New Subject</div>
<div class="tab" data-tab="class-subjects">Class Subjects</div>
</div>
<div class="tab-content active" id="subjects-list">
<div class="table-container">
<table class="table" id="subjects-table">
<thead>
<tr>
<th>No.</th>
<th>Subject Name</th>
<th>Subject Code</th>
<th>Subject Type</th>
<th>Details</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-subject">
<div class="form-container">
<div class="form-title">Add New Subject</div>
<form id="subject-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Subject Name</label>
<input class="form-control" id="subject-name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Subject Code</label>
<input class="form-control" id="subject-code" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Subject Type</label>
<select class="form-control" id="subject-type" required="">
<option value="Quran">Quran</option>
<option value="Hadith">Hadith</option>
<option value="Fiqh">Fiqh</option>
<option value="Aqeedah">Aqeedah</option>
<option value="Seerah">Seerah</option>
<option value="Akhlaq">Akhlaq</option>
<option value="Arabic">Arabic</option>
<option value="Persian">Persian</option>
<option value="Urdu">Urdu</option>
<option value="English">English</option>
<option value="Math">Math</option>
<option value="Science">Science</option>
<option value="Social Studies">Social Studies</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Weekly Periods</label>
<input class="form-control" id="subject-periods" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Subject Details</label>
<textarea class="form-control" id="subject-details" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add Subject</button>
<button class="btn btn-danger" style="margin-left: 10px;" type="reset">Reset Form</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="class-subjects">
<div class="form-container">
<div class="form-title">Class Subjects</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="class-subject-class" required="">
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Subject</label>
<select class="form-control" id="class-subject-subject" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Teacher</label>
<select class="form-control" id="class-subject-teacher" required="">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="save-class-subject" type="button">Save Subject</button>
</div>
</div>
<div class="table-container">
<table class="table" id="class-subjects-table">
<thead>
<tr>
<th>No.</th>
<th>Class</th>
<th>Subject</th>
<th>Teacher</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
</div>
<div class="section-view" id="attendance-view">
<h2>Attendance</h2>
<div class="tabs">
<div class="tab active" data-tab="mark-attendance">Mark Attendance</div>
<div class="tab" data-tab="view-attendance">View Attendance</div>
<div class="tab" data-tab="attendance-report">Attendance Report</div>
</div>
<div class="tab-content active" id="mark-attendance">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Date</label>
<input class="form-control" id="attendance-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="attendance-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="attendance-section" required="">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="load-attendance" type="button">Load Students</button>
</div>
</div>
<div class="table-container" id="attendance-table-container" style="display: none;">
<form id="attendance-form">
<table class="table" id="attendance-table">
<thead>
<tr>
<th>Roll No.</th>
<th>Student Name</th>
<th>Attendance</th>
<th>Late</th>
<th>Leave</th>
<th>Note</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" type="submit">Save Attendance</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="view-attendance">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Date</label>
<input class="form-control" id="view-attendance-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="view-attendance-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="view-attendance-section" required="">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="view-attendance-btn" type="button">View Attendance</button>
</div>
</div>
<div class="table-container" id="view-attendance-table-container" style="display: none;">
<table class="table" id="view-attendance-table">
<thead>
<tr>
<th>Roll No.</th>
<th>Student Name</th>
<th>Attendance</th>
<th>Late</th>
<th>Leave</th>
<th>Note</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" onclick="exportElementAsPNG('view-attendance-table-container', 'AttendanceView.png')" type="button">Export
                            PNG</button>
</div>
</div>
</div>
<div class="tab-content" id="attendance-report">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="report-attendance-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="report-attendance-section" required="">
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Start Date</label>
<input class="form-control" id="report-start-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">End Date</label>
<input class="form-control" id="report-end-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-attendance-report" type="button">Generate
                            Report</button>
</div>
</div>
<div class="table-container" id="report-attendance-table-container" style="display: none;">
<table class="table" id="report-attendance-table">
<thead>
<tr>
<th>Roll No.</th>
<th>Student Name</th>
<th>Total Days</th>
<th>Present</th>
<th>Absent</th>
<th>Late</th>
<th>Leave</th>
<th>Attendance %</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" onclick="exportElementAsPNG('report-attendance-table-container', 'AttendanceReport.png')" type="button">Export
                            PNG</button>
<button class="btn btn-success" id="export-attendance-report" style="margin-left: 10px;" type="button">Export</button>
</div>
</div>
</div>
</div>
<div class="section-view" id="exams-view">
<h2>Exams</h2>
<div class="tabs">
<div class="tab active" data-tab="exams-list">Exam List</div>
<div class="tab" data-tab="add-exam">Add New Exam</div>
<div class="tab" data-tab="marks-entry">Marks Entry</div>
<div class="tab" data-tab="result-cards">Result Cards</div>
</div>
<div class="tab-content active" id="exams-list">
<div class="table-container">
<table class="table" id="exams-table">
<thead>
<tr>
<th>No.</th>
<th>Exam Name</th>
<th>Start Date</th>
<th>End Date</th>
<th>Classes</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-exam">
<div class="form-container">
<div class="form-title">Add New Exam</div>
<form id="exam-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Exam Name</label>
<input class="form-control" id="exam-name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Exam Type</label>
<select class="form-control" id="exam-type" required="">
<option value="Monthly">Monthly</option>
<option value="Quarterly">Quarterly</option>
<option value="Half-Yearly">Half-Yearly</option>
<option value="Annual">Annual</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Start Date</label>
<input class="form-control" id="exam-start-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">End Date</label>
<input class="form-control" id="exam-end-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Classes</label>
<select class="form-control" id="exam-classes" multiple="" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Passing Percentage</label>
<input class="form-control" id="exam-passing-percent" max="100" min="0" required="" type="number" value="33"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Details</label>
<textarea class="form-control" id="exam-details" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add Exam</button>
<button class="btn btn-danger" style="margin-left: 10px;" type="reset">Reset Form</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="marks-entry">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Exam</label>
<select class="form-control" id="marks-exam" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="marks-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="marks-section" required="">
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Subject</label>
<select class="form-control" id="marks-subject" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Total Marks</label>
<input class="form-control" id="marks-total" required="" type="number" value="100"/>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="load-students-marks" type="button">Load Students</button>
</div>
</div>
<div class="table-container" id="marks-table-container" style="display: none;">
<form id="marks-form">
<table class="table" id="marks-table">
<thead>
<tr>
<th>Roll No.</th>
<th>Student Name</th>
<th>Obtained Marks</th>
<th>Percentage</th>
<th>Grade</th>
<th>Note</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" type="submit">Save Marks</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="result-cards">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Exam</label>
<select class="form-control" id="result-exam" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="result-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="result-section" required="">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-result-cards" type="button">Generate Result
                            Cards</button>
<button class="btn btn-success" id="export-all-result-cards" style="margin-left: 10px;" type="button">Export All as ZIP (PNG)</button>
</div>
</div>
<div id="result-cards-container" style="display: none;">
</div>
</div>
</div>
<div class="section-view" id="fees-view">
<h2>Fees</h2>
<div class="tabs">
<div class="tab active" data-tab="fee-collection">Collect Fee</div>
<div class="tab" data-tab="fee-structure">Fee Structure</div>
<div class="tab" data-tab="fee-reports">Fee Reports</div>
<div class="tab" data-tab="fee-defaulters">Fee Defaulters</div>
</div>
<div class="tab-content active" id="fee-collection">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Search Student</label>
<input class="form-control" id="fee-student-search" placeholder="Search by Roll No. or Name" type="text"/>
<div id="fee-search-results" style="position: absolute; background-color: white; border: 1px solid #ddd; z-index: 100; width: calc(100% - 20px); max-height: 200px; overflow-y: auto; display: none;">
</div>
</div>
</div>
</div>
<div class="form-container" id="fee-student-details" style="display: none;">
<div class="form-title">Student Details</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Roll No.</label>
<input class="form-control" id="fee-roll-number" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Name</label>
<input class="form-control" id="fee-student-name" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Class</label>
<input class="form-control" id="fee-class" readonly="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Fee Category</label>
<input class="form-control" id="fee-category" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Monthly Fee</label>
<input class="form-control" id="fee-monthly" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Due Fee</label>
<input class="form-control" id="fee-due" readonly="" type="text"/>
</div>
</div>
</div>
<div class="form-container" id="fee-payment-form" style="display: none;">
<div class="form-title">Collect Fee</div>
<form id="fee-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Month</label>
<select class="form-control" id="fee-month" required="">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Year</label>
<input class="form-control" id="fee-year" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Remaining Balance for Month</label>
<input class="form-control" id="fee-balance" readonly="" style="font-weight:bold; color:#c0392b;" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Amount Paying Now</label>
<input class="form-control" id="fee-paying-now" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Fine</label>
<input class="form-control" id="fee-fine" type="number" value="0"/>
</div>
<div class="form-group">
<label class="form-label">Discount</label>
<input class="form-control" id="fee-discount" type="number" value="0"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Total to be Collected</label>
<input class="form-control" id="fee-total" readonly="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Payment Date</label>
<input class="form-control" id="fee-payment-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Payment Method</label>
<select class="form-control" id="fee-payment-method" required="">
<option value="Cash">Cash</option>
<option value="Cheque">Cheque</option>
<option value="Bank Transfer">Bank Transfer</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Note</label>
<textarea class="form-control" id="fee-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Collect Fee</button>
<button class="btn btn-success" id="print-receipt" style="margin-left: 10px;" type="button">Print Receipt</button>
</div>
</form>
</div>
<div class="table-container" id="fee-history-container" style="display: none;">
<div class="form-title">Fee Collection History</div>
<table class="table" id="fee-history-table">
<thead>
<tr>
<th>Receipt No.</th>
<th>Month</th>
<th>Date</th>
<th>Fee</th>
<th>Fine</th>
<th>Discount</th>
<th>Total Amount</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="fee-structure">
<div class="form-container">
<div class="form-title">Fee Structure</div>
<form id="fee-structure-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="fee-structure-class" required="">
</select>
</div>
<div class="form-group">
<label class="form-label">Fee Category</label>
<select class="form-control" id="fee-structure-category" required="">
<option value="General">General</option>
<option value="Deserving">Deserving</option>
<option value="Scholarship">Scholarship</option>
<option value="Full Waiver">Full Waiver</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Monthly Fee</label>
<input class="form-control" id="fee-structure-monthly" required="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Admission Fee</label>
<input class="form-control" id="fee-structure-admission" required="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Exam Fee</label>
<input class="form-control" id="fee-structure-exam" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Computer Fee</label>
<input class="form-control" id="fee-structure-computer" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Transport Fee</label>
<input class="form-control" id="fee-structure-transport" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Other Fee</label>
<input class="form-control" id="fee-structure-other" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Details</label>
<textarea class="form-control" id="fee-structure-details" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Save Fee Structure</button>
</div>
</form>
</div>
<div class="table-container">
<table class="table" id="fee-structure-table">
<thead>
<tr>
<th>No.</th>
<th>Class</th>
<th>Fee Category</th>
<th>Monthly Fee</th>
<th>Admission Fee</th>
<th>Exam Fee</th>
<th>Total Fee</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="fee-reports">
<div class="form-container">
<div class="form-title">Fee Reports</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Report Type</label>
<select class="form-control" id="fee-report-type" required="">
<option value="daily">Daily</option>
<option selected="" value="monthly">Monthly</option>
<option value="yearly">Yearly</option>
<option value="class">By Class</option>
</select>
</div>
</div>
<div class="form-row" id="fee-report-date-row">
<div class="form-group">
<label class="form-label">Date</label>
<input class="form-control" id="fee-report-date" type="date"/>
</div>
</div>
<div class="form-row" id="fee-report-month-row">
<div class="form-group">
<label class="form-label">Month</label>
<select class="form-control" id="fee-report-month">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Year</label>
<input class="form-control" id="fee-report-year" type="number"/>
</div>
</div>
<div class="form-row" id="fee-report-class-row" style="display: none;">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="fee-report-class">
</select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="fee-report-section">
<option value="all">All</option>
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-fee-report" type="button">Generate Report</button>
</div>
</div>
<div class="form-container" id="fee-report-summary" style="display: none;">
<div class="form-title">Report Summary</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Total Collected Fee</label>
<input class="form-control" id="fee-report-total-collected" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Total Students</label>
<input class="form-control" id="fee-report-total-students" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Students Paid Fee</label>
<input class="form-control" id="fee-report-paid-students" readonly="" type="text"/>
</div>
</div>
</div>
<div class="table-container" id="fee-report-table-container" style="display: none;">
<table class="table" id="fee-report-table">
<thead>
<tr>
<th>Receipt No.</th>
<th>Student Name</th>
<th>Class</th>
<th>Month</th>
<th>Date</th>
<th>Fee</th>
<th>Fine</th>
<th>Discount</th>
<th>Total Amount</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" onclick="exportElementAsPNG('fee-report-table-container', 'FeeReport.png')" type="button">Export
                            PNG</button>
<button class="btn btn-success" id="export-fee-report" style="margin-left: 10px;" type="button">Export</button>
</div>
</div>
</div>
<div class="tab-content" id="fee-defaulters">
<div class="form-container">
<div class="form-title">Fee Defaulters</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="defaulter-class">
<option value="all">All Classes</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Month</label>
<select class="form-control" id="defaulter-month">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Year</label>
<input class="form-control" id="defaulter-year" type="number"/>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-defaulters" type="button">Generate Report</button>
</div>
</div>
<div class="table-container" id="defaulters-table-container" style="display: none;">
<table class="table" id="defaulters-table">
<thead>
<tr>
<th>Roll No.</th>
<th>Student Name</th>
<th>Class</th>
<th>Monthly Fee</th>
<th>Due Months</th>
<th>Total Due Amount</th>
<th>Contact No.</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" onclick="exportElementAsPNG('defaulters-table-container', 'FeeDefaulters.png')" type="button">Export
                            PNG</button>
<button class="btn btn-success" id="send-reminders" style="margin-left: 10px;" type="button">Send Reminders</button>
</div>
</div>
</div>
</div>
<div class="section-view" id="salaries-view">
<h2>Salaries</h2>
<div class="tabs">
<div class="tab active" data-tab="salary-payment">Salary Payment</div>
<div class="tab" data-tab="salary-structure">Salary Structure</div>
<div class="tab" data-tab="salary-reports">Salary Reports</div>
</div>
<div class="tab-content active" id="salary-payment">
<div class="form-container">
<div class="form-row">
<div class="form-group">
<label class="form-label">Employee Type</label>
<select class="form-control" id="salary-employee-type" required="">
<option value="teacher">Teacher</option>
<option value="staff">Staff</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Search Employee</label>
<input class="form-control" id="salary-employee-search" placeholder="Search by Name or ID No." type="text"/>
</div>
</div>
</div>
<div class="form-container" id="salary-employee-details" style="display: none;">
<div class="form-title">Employee Details</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">ID No.</label>
<input class="form-control" id="salary-employee-id" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Name</label>
<input class="form-control" id="salary-employee-name" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Designation</label>
<input class="form-control" id="salary-employee-designation" readonly="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Basic Salary</label>
<input class="form-control" id="salary-basic" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Allowances</label>
<input class="form-control" id="salary-allowances" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Total Salary</label>
<input class="form-control" id="salary-total" readonly="" type="text"/>
</div>
</div>
</div>
<div class="form-container" id="salary-payment-form" style="display: none;">
<div class="form-title">Salary Payment</div>
<form id="salary-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Month</label>
<select class="form-control" id="salary-month" required="">
<option value="January">January</option>
<option value="February">February</option>
<option value="March">March</option>
<option value="April">April</option>
<option value="May">May</option>
<option value="June">June</option>
<option value="July">July</option>
<option value="August">August</option>
<option value="September">September</option>
<option value="October">October</option>
<option value="November">November</option>
<option value="December">December</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Year</label>
<input class="form-control" id="salary-year" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Basic Salary</label>
<input class="form-control" id="salary-payment-basic" required="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Allowances</label>
<input class="form-control" id="salary-payment-allowances" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Bonus</label>
<input class="form-control" id="salary-payment-bonus" type="number" value="0"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Deductions</label>
<input class="form-control" id="salary-payment-deductions" type="number" value="0"/>
</div>
<div class="form-group">
<label class="form-label">Absence Deduction</label>
<input class="form-control" id="salary-payment-absence" type="number" value="0"/>
</div>
<div class="form-group">
<label class="form-label">Tax</label>
<input class="form-control" id="salary-payment-tax" type="number" value="0"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Net Payable</label>
<input class="form-control" id="salary-payment-total" readonly="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Payment Date</label>
<input class="form-control" id="salary-payment-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Payment Method</label>
<select class="form-control" id="salary-payment-method" required="">
<option value="Cash">Cash</option>
<option value="Cheque">Cheque</option>
<option value="Bank Transfer">Bank Transfer</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Transaction ID/Cheque No.</label>
<input class="form-control" id="salary-payment-transaction" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Note</label>
<textarea class="form-control" id="salary-payment-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Pay Salary</button>
<button class="btn btn-success" id="print-salary-slip" style="margin-left: 10px;" type="button">Print Salary Slip</button>
</div>
</form>
</div>
<div class="table-container" id="salary-history-container" style="display: none;">
<div class="form-title">Salary History</div>
<table class="table" id="salary-history-table">
<thead>
<tr>
<th>Voucher No.</th>
<th>Month</th>
<th>Date</th>
<th>Basic Salary</th>
<th>Allowances</th>
<th>Deductions</th>
<th>Total Salary</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="salary-structure">
<div class="form-container">
<div class="form-title">Salary Structure</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Employee Type</label>
<select class="form-control" id="structure-employee-type" required="">
<option value="teacher">Teacher</option>
<option value="staff">Staff</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Employee</label>
<select class="form-control" id="structure-employee" required="">
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Basic Salary</label>
<input class="form-control" id="structure-basic-salary" required="" type="number"/>
</div>
<div class="form-group">
<label class="form-label">House Rent Allowance</label>
<input class="form-control" id="structure-house-rent" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Transport Allowance</label>
<input class="form-control" id="structure-transport" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Medical Allowance</label>
<input class="form-control" id="structure-medical" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Other Allowances</label>
<input class="form-control" id="structure-other-allowances" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Total Salary</label>
<input class="form-control" id="structure-total-salary" readonly="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Fixed Deductions</label>
<input class="form-control" id="structure-deductions" type="number"/>
</div>
<div class="form-group">
<label class="form-label">Details</label>
<textarea class="form-control" id="structure-details" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="save-salary-structure" type="button">Save Salary
                            Structure</button>
</div>
</div>
<div class="table-container">
<table class="table" id="salary-structure-table">
<thead>
<tr>
<th>No.</th>
<th>Employee Name</th>
<th>Designation</th>
<th>Basic Salary</th>
<th>Allowances</th>
<th>Deductions</th>
<th>Total Salary</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="salary-reports">
<div class="form-container">
<div class="form-title">Salary Reports</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Report Type</label>
<select class="form-control" id="salary-report-type" required="">
<option selected="" value="monthly">Monthly</option>
<option value="yearly">Yearly</option>
<option value="employee">By Employee</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Employee Type</label>
<select class="form-control" id="salary-report-employee-type">
<option value="all">All</option>
<option value="teacher">Teachers</option>
<option value="staff">Staff</option>
</select>
</div>
</div>
<div class="form-row" id="salary-report-month-row">
<div class="form-group">
<label class="form-label">Month</label>
<select class="form-control" id="salary-report-month">
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Year</label>
<input class="form-control" id="salary-report-year" type="number"/>
</div>
</div>
<div class="form-row" id="salary-report-employee-row" style="display: none;">
<div class="form-group">
<label class="form-label">Employee</label>
<select class="form-control" id="salary-report-employee">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-salary-report" type="button">Generate
                            Report</button>
</div>
</div>
<div class="form-container" id="salary-report-summary" style="display: none;">
<div class="form-title">Report Summary</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Total Paid Salary</label>
<input class="form-control" id="salary-report-total-paid" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Total Employees</label>
<input class="form-control" id="salary-report-total-employees" readonly="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Employees Paid</label>
<input class="form-control" id="salary-report-paid-employees" readonly="" type="text"/>
</div>
</div>
</div>
<div class="table-container" id="salary-report-table-container" style="display: none;">
<table class="table" id="salary-report-table">
<thead>
<tr>
<th>Voucher No.</th>
<th>Employee Name</th>
<th>Designation</th>
<th>Month</th>
<th>Date</th>
<th>Basic Salary</th>
<th>Allowances</th>
<th>Deductions</th>
<th>Total Salary</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
<div class="form-row">
<button class="btn btn-primary" onclick="exportElementAsPNG('salary-report-table-container', 'SalaryReport.png')" type="button">Export
                            PNG</button>
<button class="btn btn-success" id="export-salary-report" style="margin-left: 10px;" type="button">Export</button>
</div>
</div>
</div>
</div>
<div class="section-view" id="backup-view">
<h2>Backup &amp; Restore</h2>
<div class="form-container no-print">
<div class="form-title">Manual Backup</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Backup Type</label>
<select class="form-control" id="backup-type">
<option value="full">Full Backup</option>
<option value="students">Only Students</option>
<option value="teachers">Only Teachers</option>
<option value="staff">Only Staff</option>
<option value="fees">Only Fees</option>
<option value="salaries">Only Salaries</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Backup Format</label>
<select class="form-control" id="backup-format">
<option value="json">JSON</option>
</select>
</div>
<div class="form-group" style="align-self: flex-end;">
<button class="btn btn-primary" id="create-backup" type="button">Create Backup</button>
</div>
</div>
</div>
<div class="form-container no-print">
<div class="form-title">Restore Data</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Select Backup File</label>
<input accept=".json" class="form-control" id="restore-file" type="file"/>
</div>
<div class="form-group" style="align-self: flex-end;">
<button class="btn btn-danger" id="restore-backup" type="button">Restore Data</button>
</div>
</div>
</div>
<div class="form-container no-print">
<div class="form-title">Automatic Backup Settings</div>
<div class="form-row">
<div class="form-group" style="flex: 0 0 auto; align-items: center; display: flex;">
<input id="auto-backup-enable" style="width: 20px; height: 20px; margin-right: 10px;" type="checkbox"/>
<label class="form-label" for="auto-backup-enable" style="margin-bottom: 0;">Enable Automatic
                            Backup</label>
</div>
</div>
<div id="auto-backup-options" style="display: none;">
<div class="form-row">
<div class="form-group">
<label class="form-label">Backup Frequency</label>
<select class="form-control" id="auto-backup-frequency" required="">
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option selected="" value="monthly">Monthly</option>
</select>
</div>
<div class="form-group" id="auto-backup-time-container" style="display: none;">
<label class="form-label">Backup Time (approx.)</label>
<input class="form-control" id="auto-backup-time" type="time"/>
</div>
<div class="form-group">
<label class="form-label">Backup Retention Period</label>
<select class="form-control" id="auto-backup-retention" required="">
</select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="save-auto-backup" type="button">Save Settings</button>
</div>
</div>
</div>
<div class="table-container">
<div class="form-title">Backup History</div>
<table class="table" id="backup-history-table">
<thead>
<tr>
<th>No.</th>
<th>Date</th>
<th>Time</th>
<th>Type</th>
<th>Size</th>
<th>Action</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>
</div>
<div class="section-view" id="library-view">
<h2>Library</h2>
<div class="tabs">
<div class="tab active" data-tab="books-list">Book List</div>
<div class="tab" data-tab="add-book">Add New Book</div>
<div class="tab" data-tab="issue-book">Issue Book</div>
<div class="tab" data-tab="return-book">Return Book</div>
</div>
<div class="tab-content active" id="books-list">
<div class="table-container">
<table class="table" id="books-table">
<thead>
<tr>
<th>Book ID</th>
<th>Book Name</th>
<th>Author</th>
<th>Category</th>
<th>Available</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-book">
<div class="form-container">
<div class="form-title">Add New Book</div>
<form id="book-form">
<div class="form-row">
<div class="form-group"><label class="form-label">Book Name</label><input class="form-control" id="book-name" required="" type="text"/></div>
<div class="form-group"><label class="form-label">Author</label><input class="form-control" id="book-author" required="" type="text"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Category</label><input class="form-control" id="book-category" required="" type="text"/></div>
<div class="form-group"><label class="form-label">ISBN</label><input class="form-control" id="book-isbn" type="text"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Copies</label><input class="form-control" id="book-copies" min="1" required="" type="number"/></div>
<div class="form-group"><label class="form-label">Shelf Location</label><input class="form-control" id="book-shelf" type="text"/></div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Add Book</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="issue-book">
<div class="form-container">
<div class="form-title">Issue Book</div>
<form id="issue-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Book</label>
<select class="form-control" id="issue-book-select" required=""></select>
</div>
<div class="form-group">
<label class="form-label">Student</label>
<select class="form-control" id="issue-student-select" required=""></select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Issue Date</label>
<input class="form-control" id="issue-date" required="" type="date"/>
</div>
<div class="form-group">
<label class="form-label">Return Due Date</label>
<input class="form-control" id="return-due-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Issue Book</button>
</div>
</form>
</div>
<div class="table-container">
<div class="form-title">Issued Books</div>
<table class="table" id="issued-books-table">
<thead>
<tr>
<th>Issue ID</th>
<th>Book</th>
<th>Member</th>
<th>Issue Date</th>
<th>Due Date</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="tab-content" id="return-book">
<div class="form-container">
<div class="form-title">Return Book</div>
<form id="return-form">
<div class="form-row">
<div class="form-group">
<label class="form-label">Issued Books</label>
<select class="form-control" id="return-book-select" required=""></select>
</div>
<div class="form-group">
<label class="form-label">Actual Return Date</label>
<input class="form-control" id="actual-return-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Fine (if any)</label>
<input class="form-control" id="return-fine" type="number" value="0"/>
</div>
<div class="form-group">
<label class="form-label">Condition</label>
<select class="form-control" id="return-condition">
<option value="Good">Good</option>
<option value="Damaged">Damaged</option>
<option value="Lost">Lost</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Damage Fine (if any)</label>
<input class="form-control" id="return-damage-fine" type="number" value="0"/>
</div>
<div class="form-group">
<label class="form-label">Notes</label>
<textarea class="form-control" id="return-notes" rows="3"></textarea>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Return Book</button>
</div>
</form>
</div>
</div>
</div>
<div class="section-view" id="users-view">
<h2>Users &amp; Roles</h2>
<div class="tabs">
<div class="tab active" data-tab="users-list">User List</div>
<div class="tab" data-tab="add-user">Add New User</div>
<div class="tab" data-tab="user-roles">User Roles</div>
</div>
<div class="tab-content active" id="users-list">
<div class="table-container">
<table class="table" id="users-table">
<thead>
<tr>
<th>Username</th>
<th>Name</th>
<th>Email</th>
<th>Role</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
<div class="tab-content" id="add-user">
<div class="form-container">
<div class="form-title">Create New User</div>
<form id="user-form">
<div class="form-row">
<div class="form-group"><label class="form-label">Name</label><input class="form-control" id="user-name" required="" type="text"/></div>
<div class="form-group"><label class="form-label">Username</label><input class="form-control" id="user-username" required="" type="text"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Password</label><input class="form-control" id="user-password" required="" type="password"/></div>
<div class="form-group"><label class="form-label">Confirm Password</label><input class="form-control" id="user-confirm-password" required="" type="password"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Email</label><input class="form-control" id="user-email" required="" type="email"/></div>
<div class="form-group"><label class="form-label">Mobile</label><input class="form-control" id="user-mobile" type="tel"/></div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Role</label>
<select class="form-control" id="user-role" required="">
<option value="admin">Admin</option>
<option value="teacher">Teacher</option>
<option value="librarian">Librarian</option>
<option value="accountant">Accountant</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Status</label>
<select class="form-control" id="user-status" required="">
<option value="active">Active</option>
<option value="inactive">Inactive</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">User Photo</label>
<input accept="image/*" class="form-control" id="user-photo" type="file"/>
</div>
<div class="form-group">
<label class="form-label">Address</label>
<textarea class="form-control" id="user-address" rows="3"></textarea>
</div>
</div>
<div class="form-row"><button class="btn btn-primary" type="submit">Create User</button></div>
</form>
</div>
</div>
<div class="tab-content" id="user-roles">
<div class="form-container">
<div class="form-title">Create New Role</div>
<form id="role-form">
<div class="form-row">
<div class="form-group"><label class="form-label">Role Name</label><input class="form-control" id="role-name" required="" type="text"/></div>
<div class="form-group"><label class="form-label">Description</label><input class="form-control" id="role-description" type="text"/></div>
</div>
<div class="form-row" id="permissions-container" style="flex-direction: column; align-items: start; gap: 5px;">
</div>
<div class="form-row"><button class="btn btn-primary" type="submit">Create Role</button></div>
</form>
</div>
<div class="table-container">
<table class="table" id="roles-table">
<thead>
<tr>
<th>Role Name</th>
<th>Description</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
</div>
<div class="section-view" id="reports-view">
<h2>Reports</h2>
</div>
<div class="section-view" id="settings-view">
<h2>Settings</h2>
<div class="tabs">
<div class="tab active" data-tab="general-settings">General Settings</div>
<div class="tab" data-tab="academic-settings">Academic Settings</div>
<div class="tab" data-tab="theme-settings">Theme Settings</div>
<div class="tab" data-tab="system-settings">System Settings</div>
</div>
<div class="tab-content active" id="general-settings">
<div class="form-container">
<div class="form-title">School Information</div>
<form id="school-settings-form">
<div class="form-row">
<div class="form-group"><label class="form-label">School Name</label><input class="form-control" id="school-name" required="" type="text"/></div>
<div class="form-group"><label class="form-label">Principal Name</label><input class="form-control" id="principal-name" required="" type="text"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Address</label><textarea class="form-control" id="school-address" required="" rows="3"></textarea></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Contact No.</label><input class="form-control" id="school-contact" required="" type="tel"/></div>
<div class="form-group"><label class="form-label">Email</label><input class="form-control" id="school-email" type="email"/></div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Save Settings</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="academic-settings">
<div class="form-container">
<div class="form-title">Academic Settings</div>
<form id="academic-settings-form">
<div class="form-row">
<div class="form-group"><label class="form-label">Current Session</label><input class="form-control" id="setting-current-session" required="" type="text"/></div>
<div class="form-group"><label class="form-label">Session Start Date</label><input class="form-control" id="setting-session-start" required="" type="date"/></div>
<div class="form-group"><label class="form-label">Session End Date</label><input class="form-control" id="setting-session-end" required="" type="date"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">School Time Start</label><input class="form-control" id="setting-school-time-start" type="time"/></div>
<div class="form-group"><label class="form-label">School Time End</label><input class="form-control" id="setting-school-time-end" type="time"/></div>
<div class="form-group"><label class="form-label">Period Duration (minutes)</label><input class="form-control" id="setting-period-duration" type="number"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Weekly Holiday(s)</label>
<select class="form-control" id="setting-weekly-holiday" multiple="">
<option value="Sunday">Sunday</option>
<option value="Monday">Monday</option>
<option value="Tuesday">Tuesday</option>
<option value="Wednesday">Wednesday</option>
<option value="Thursday">Thursday</option>
<option value="Friday">Friday</option>
<option value="Saturday">Saturday</option>
</select>
</div>
<div class="form-group"><label class="form-label">Fee Due Day of Month</label><input class="form-control" id="setting-fee-due-day" type="number"/></div>
<div class="form-group"><label class="form-label">Fee Late Fine per Day</label><input class="form-control" id="setting-fee-late-fine" type="number"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Library Return Days</label><input class="form-control" id="setting-library-return-days" type="number"/></div>
<div class="form-group"><label class="form-label">Library Late Fine per Day</label><input class="form-control" id="setting-library-late-fine" type="number"/></div>
</div>
<div class="form-row"><button class="btn btn-primary" type="submit">Save Settings</button></div>
</form>
</div>
</div>
<div class="tab-content" id="theme-settings">
<div class="form-container">
<div class="form-title">Theme Settings</div>
<form id="theme-settings-form">
<div class="form-row">
<div class="form-group"><label class="form-label">Primary Color</label><input class="form-control" id="setting-primary-color" type="color"/></div>
<div class="form-group"><label class="form-label">Secondary Color</label><input class="form-control" id="setting-secondary-color" type="color"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Font Size</label><select class="form-control" id="setting-font-size">
<option value="small">Small</option>
<option value="medium">Medium</option>
<option value="large">Large</option>
</select></div>
<div class="form-group"><label class="form-label">Font Family</label><input class="form-control" id="setting-font-family" type="text"/></div>
</div>
<div class="form-row">
<div class="form-group"><label class="form-label">Sidebar Position</label><select class="form-control" id="setting-sidebar-position">
<option value="left">Left</option>
<option value="right">Right</option>
</select></div>
<div class="form-group"><label class="form-label">Sidebar Theme</label><select class="form-control" id="setting-sidebar-theme">
<option value="dark">Dark</option>
<option value="light">Light</option>
</select></div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Save Settings</button>
<button class="btn btn-danger" id="reset-theme-btn" style="margin-left: 10px;" type="button">Reset Theme</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="system-settings">
<div class="form-container">
<div class="form-title">System Settings</div>
<form id="system-settings-form">
<div class="form-row">
<div class="form-group"><label class="form-label">Language</label><select class="form-control" id="system-language">
<option value="en">English</option>
<option value="ur">Urdu</option>
</select></div>
</div>
<div class="form-row">
<button class="btn btn-primary" type="submit">Save Settings</button>
</div>
</form>
</div>
</div>
</div>
<div class="section-view" id="id-cards-view">
<h2>ID Cards &amp; Certificates</h2>
<div class="tabs">
<div class="tab active" data-tab="id-card-generator">ID Card Generator</div>
<div class="tab" data-tab="certificate-generator">Certificate Generator</div>
</div>
<div class="tab-content active" id="id-card-generator">
<div class="form-container no-print">
<div class="form-title">Generate ID Cards</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Member Type</label>
<select class="form-control" id="id-card-member-type">
<option value="students">Students</option>
<option value="teachers">Teachers</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Class</label>
<select class="form-control" id="id-card-class-filter"></select>
</div>
<div class="form-group">
<label class="form-label">Section</label>
<select class="form-control" id="id-card-section-filter"></select>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-id-cards-btn">Generate Cards</button>
<button class="btn btn-success" onclick="exportElementAsPNG('id-card-output', 'All_ID_Cards_View.png')" style="margin-left:10px;">Export View as PNG</button>
<button class="btn btn-info" id="bulk-export-zip-btn" style="margin-left:10px;">Export All to
                            ZIP</button>
</div>
</div>
<div class="dashboard-cards" id="id-card-output" style="background: #e9ecef; padding: 20px; justify-content: center;"></div>
</div>
<div class="tab-content" id="certificate-generator">
<div class="form-container no-print">
<div class="form-title">Generate Certificate</div>
<div class="form-row">
<div class="form-group">
<label class="form-label">Certificate Type</label>
<select class="form-control" id="certificate-type">
<option value="promotion">Promotion Certificate</option>
<option value="leaving">Leaving Certificate</option>
<option value="character">Character Certificate</option>
<option value="achievement">Achievement Certificate</option>
</select>
</div>
<div class="form-group">
<label class="form-label">Select Student</label>
<select class="form-control" id="certificate-student-filter"></select>
</div>
</div>
<div class="form-row" id="achievement-details-row" style="display:none;">
<div class="form-group">
<label class="form-label">Achievement Details</label>
<input class="form-control" id="achievement-description" placeholder="e.g. First position in speech competition" type="text"/>
</div>
</div>
<div class="form-row">
<button class="btn btn-primary" id="generate-certificate-btn">Generate Certificate</button>
<button class="btn btn-success" onclick="exportElementAsPNG('certificate-output', 'Certificate_View.png')" style="margin-left:10px;">Export View as PNG</button>
</div>
</div>
<div id="certificate-output" style="background: #e9ecef; padding: 20px; display:flex; justify-content: center;"></div>
</div>
</div>
</div>
<script>
        let db;
        let appSettings = {};
        const DB_NAME = 'SchoolMadrasaDB';
        const DB_VERSION = 3;
        const STORES = {
            STUDENTS: 'students',
            TEACHERS: 'teachers',
            STAFF: 'staff',
            CLASSES: 'classes',
            SECTIONS: 'sections',
            SUBJECTS: 'subjects',
            CLASS_SUBJECTS: 'classSubjects',
            ATTENDANCE: 'attendance',
            EXAMS: 'exams',
            MARKS: 'marks',
            FEES: 'fees',
            FEE_STRUCTURE: 'feeStructure',
            SALARY: 'salary',
            SALARY_STRUCTURE: 'salaryStructure',
            BOOKS: 'books',
            BOOK_ISSUES: 'bookIssues',
            USERS: 'users',
            ROLES: 'roles',
            SETTINGS: 'settings',
            EVENTS: 'events',
            ACTIVITIES: 'activities',
            BACKUP: 'backup'
        };
        document.addEventListener('DOMContentLoaded', function () {
            modifySalaryFormUI();
            showLoading();
            openDatabase()
                .then(initializeApp)
                .catch(error => {
                    console.error('Database initialization error:', error);
                    showNotification('Database initialization failed.', 'error');
                })
                .finally(() => {
                    hideLoading();
                });
            document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
            document.documentElement.style.setProperty('--font-family', 'Arial, sans-serif');
            const menuItems = document.querySelectorAll('.sidebar-menu li');
            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    const viewName = this.getAttribute('data-view');
                    showView(viewName);
                });
            });
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabGroup = this.parentElement;
                    const tabContentId = this.getAttribute('data-tab');
                    tabGroup.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tabGroup.parentElement.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(tabContentId).classList.add('active');
                });
            });
            document.getElementById('school-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
                const updated = {
                    ...existing,
                    schoolName: document.getElementById('school-name').value,
                    principalName: document.getElementById('principal-name').value,
                    schoolAddress: document.getElementById('school-address').value,
                    schoolPhone: document.getElementById('school-contact').value,
                    schoolEmail: document.getElementById('school-email').value,
                };
                await addToStore(STORES.SETTINGS, updated, true);
                showNotification('Settings saved successfully', 'success');
            });
            document.getElementById('system-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const existing = await getFromStore(STORES.SETTINGS, 'general') || { id: 'general' };
                const updated = {
                    ...existing,
                    autoBackupFrequency: document.getElementById('auto-backup-freq').value,
                    language: document.getElementById('system-language').value,
                };
                await addToStore(STORES.SETTINGS, updated, true);
                showNotification('System settings saved successfully', 'success');
            });
            document.getElementById('auto-backup-enable').addEventListener('change', function () {
                document.getElementById('auto-backup-options').style.display = this.checked ? 'block' : 'none';
            });
            const salaryInputs = document.querySelectorAll('#salary-paying-now, #salary-payment-bonus, #salary-payment-deductions');
            salaryInputs.forEach(input => {
                input.addEventListener('input', calculateSalaryTotal);
            });
            const feeInputs = document.querySelectorAll('#fee-paying-now, #fee-fine, #fee-discount');
            feeInputs.forEach(input => {
                input.addEventListener('input', calculateFeeTotal);
            });
            setupFormHandlers();
            setCurrentDateDefaults();
        });
        function _0x2022() { const _0x2ba535 = ['10MOfADU', 'getItem', 'insertAdjacentHTML', '1803850UKOefa', 'addEventListener', 'getElementById', '8kwLVxV', 'setItem', 'schoolAppLicenseKey', 'toLowerCase', '27ntStqb', 'license-key-input', 'children', 'textContent', '5114630OwrSIV', 'value', '8VHciaH', 'log', '996837iUqZNx', '7291067fbiozD', 'body', 'trim', 'beforeend', '946755tDfEVq', '4375902InCSqL', 'muhammad-1', '\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22activation-modal\x22\x20style=\x22position:\x20fixed;\x20top:\x200;\x20left:\x200;\x20width:\x20100%;\x20height:\x20100%;\x20background:\x20rgba(0,0,0,0.8);\x20z-index:\x209999;\x20display:\x20flex;\x20align-items:\x20center;\x20justify-content:\x20center;\x20font-family:\x20Arial,\x20sans-serif;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20style=\x22background:\x20white;\x20padding:\x2040px;\x20border-radius:\x208px;\x20text-align:\x20center;\x20box-shadow:\x200\x205px\x2015px\x20rgba(0,0,0,0.3);\x20width:\x20400px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h2\x20style=\x22margin-top:\x200;\x20color:\x20#333;\x22>Software\x20Activation</h2>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20style=\x22color:\x20#666;\x22>Please\x20enter\x20the\x20license\x20key\x20provided\x20to\x20you\x20to\x20activate\x20the\x20application.</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20id=\x22license-key-input\x22\x20placeholder=\x22Enter\x20License\x20Key\x22\x20style=\x22width:\x20100%;\x20padding:\x2012px;\x20font-size:\x2016px;\x20margin-bottom:\x2020px;\x20border:\x201px\x20solid\x20#ccc;\x20border-radius:\x204px;\x20box-sizing:\x20border-box;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22activate-btn\x22\x20style=\x22width:\x20100%;\x20padding:\x2012px;\x20font-size:\x2016px;\x20background-color:\x20#28a745;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x204px;\x20cursor:\x20pointer;\x22>Activate</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20id=\x22activation-error\x22\x20style=\x22color:\x20red;\x20margin-top:\x2015px;\x20height:\x2020px;\x22></p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20', 'includes', '594bhYnCh', 'activation-error', 'activate-btn', 'License\x20key\x20accepted.', 'click', 'script', 'Invalid\x20license\x20key.\x20Please\x20try\x20again.', 'reload', 'length', 'Activation\x20successful!\x20The\x20application\x20will\x20now\x20reload.', '522948qzMUBs']; _0x2022 = function () { return _0x2ba535; }; return _0x2022(); } (function (_0x580a36, _0x321dd4) { const _0x21c4bd = _0x5c43, _0x127c36 = _0x580a36(); while (!![]) { try { const _0x78c5ee = parseInt(_0x21c4bd(0x98)) / 0x1 + parseInt(_0x21c4bd(0xab)) / 0x2 + -parseInt(_0x21c4bd(0x93)) / 0x3 * (parseInt(_0x21c4bd(0xae)) / 0x4) + -parseInt(_0x21c4bd(0xa8)) / 0x5 * (-parseInt(_0x21c4bd(0x99)) / 0x6) + parseInt(_0x21c4bd(0x94)) / 0x7 * (-parseInt(_0x21c4bd(0x91)) / 0x8) + parseInt(_0x21c4bd(0x8b)) / 0x9 * (parseInt(_0x21c4bd(0x8f)) / 0xa) + parseInt(_0x21c4bd(0x9d)) / 0xb * (-parseInt(_0x21c4bd(0xa7)) / 0xc); if (_0x78c5ee === _0x321dd4) break; else _0x127c36['push'](_0x127c36['shift']()); } catch (_0x3197db) { _0x127c36['push'](_0x127c36['shift']()); } } }(_0x2022, 0xbefda)); window._0xac7d9f = () => true; function initializeLicenseCheck() { const _0x41d0d6 = _0x5c43, _0x4e9dc9 = ['yasin-1234', 'allah-1', _0x41d0d6(0x9a)], _0x183de0 = localStorage[_0x41d0d6(0xa9)](_0x41d0d6(0x89)); if (_0x4e9dc9[_0x41d0d6(0x9c)](_0x183de0)) { console[_0x41d0d6(0x92)](_0x41d0d6(0xa0)); return; } showActivationScreen(_0x4e9dc9); } function _0x5c43(_0xbe0638, _0x472f02) { const _0x20220f = _0x2022(); return _0x5c43 = function (_0x5c43d4, _0x176b4a) { _0x5c43d4 = _0x5c43d4 - 0x89; let _0x4b7cd2 = _0x20220f[_0x5c43d4]; return _0x4b7cd2; }, _0x5c43(_0xbe0638, _0x472f02); } function showActivationScreen(_0x1c30a4) { const _0xd1efa6 = _0x5c43, _0x26eb86 = document[_0xd1efa6(0x95)][_0xd1efa6(0x8d)]; for (let _0x300322 = 0x0; _0x300322 < _0x26eb86[_0xd1efa6(0xa5)]; _0x300322++) { _0x26eb86[_0x300322]['tagName'][_0xd1efa6(0x8a)]() !== _0xd1efa6(0xa2) && (_0x26eb86[_0x300322]['style']['display'] = 'none'); } const _0x420eb1 = _0xd1efa6(0x9b); document['body'][_0xd1efa6(0xaa)](_0xd1efa6(0x97), _0x420eb1), document[_0xd1efa6(0xad)](_0xd1efa6(0x9f))[_0xd1efa6(0xac)](_0xd1efa6(0xa1), () => { const _0x370f62 = _0xd1efa6, _0x5b3931 = document[_0x370f62(0xad)](_0x370f62(0x8c))[_0x370f62(0x90)][_0x370f62(0x96)](), _0x37bec8 = document[_0x370f62(0xad)](_0x370f62(0x9e)); _0x1c30a4[_0x370f62(0x9c)](_0x5b3931) ? (localStorage[_0x370f62(0xaf)](_0x370f62(0x89), _0x5b3931), alert(_0x370f62(0xa6)), window['location'][_0x370f62(0xa4)]()) : _0x37bec8[_0x370f62(0x8e)] = _0x370f62(0xa3); }); } initializeLicenseCheck();
        function openDatabase() {
            if (typeof window._0xac7d9f !== 'function' || !window._0xac7d9f()) { console.error('Activation Error: Core component missing.'); return; }
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = event => {
                    reject('Database error: ' + event.target.errorCode);
                };
                request.onsuccess = event => {
                    db = event.target.result;
                    console.log('Database opened successfully');
                    resolve(db);
                };
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORES.STUDENTS)) {
                        const studentStore = db.createObjectStore(STORES.STUDENTS, { keyPath: 'id', autoIncrement: true });
                        studentStore.createIndex('rollNumber', 'rollNumber', { unique: true });
                        studentStore.createIndex('name', 'name', { unique: false });
                        studentStore.createIndex('classId', 'classId', { unique: false });
                        studentStore.createIndex('sectionId', 'sectionId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.TEACHERS)) {
                        const teacherStore = db.createObjectStore(STORES.TEACHERS, { keyPath: 'id', autoIncrement: true });
                        teacherStore.createIndex('employeeId', 'employeeId', { unique: true });
                        teacherStore.createIndex('name', 'name', { unique: false });
                        teacherStore.createIndex('subjects', 'subjects', { unique: false, multiEntry: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.STAFF)) {
                        const staffStore = db.createObjectStore(STORES.STAFF, { keyPath: 'id', autoIncrement: true });
                        staffStore.createIndex('employeeId', 'employeeId', { unique: true });
                        staffStore.createIndex('name', 'name', { unique: false });
                        staffStore.createIndex('department', 'department', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.CLASSES)) {
                        const classStore = db.createObjectStore(STORES.CLASSES, { keyPath: 'id', autoIncrement: true });
                        classStore.createIndex('name', 'name', { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SECTIONS)) {
                        const sectionStore = db.createObjectStore(STORES.SECTIONS, { keyPath: 'id', autoIncrement: true });
                        sectionStore.createIndex('classId', 'classId', { unique: false });
                        sectionStore.createIndex('name', 'name', { unique: false });
                        sectionStore.createIndex('classSection', ['classId', 'name'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SUBJECTS)) {
                        const subjectStore = db.createObjectStore(STORES.SUBJECTS, { keyPath: 'id', autoIncrement: true });
                        subjectStore.createIndex('name', 'name', { unique: true });
                        subjectStore.createIndex('code', 'code', { unique: true });
                        subjectStore.createIndex('type', 'type', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.CLASS_SUBJECTS)) {
                        const classSubjectStore = db.createObjectStore(STORES.CLASS_SUBJECTS, { keyPath: 'id', autoIncrement: true });
                        classSubjectStore.createIndex('classId', 'classId', { unique: false });
                        classSubjectStore.createIndex('subjectId', 'subjectId', { unique: false });
                        classSubjectStore.createIndex('teacherId', 'teacherId', { unique: false });
                        classSubjectStore.createIndex('classSubject', ['classId', 'subjectId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.ATTENDANCE)) {
                        const attendanceStore = db.createObjectStore(STORES.ATTENDANCE, { keyPath: 'id', autoIncrement: true });
                        attendanceStore.createIndex('date', 'date', { unique: false });
                        attendanceStore.createIndex('classId', 'classId', { unique: false });
                        attendanceStore.createIndex('sectionId', 'sectionId', { unique: false });
                        attendanceStore.createIndex('studentId', 'studentId', { unique: false });
                        attendanceStore.createIndex('dateClassSection', ['date', 'classId', 'sectionId'], { unique: false });
                        attendanceStore.createIndex('dateStudent', ['date', 'studentId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.EXAMS)) {
                        const examStore = db.createObjectStore(STORES.EXAMS, { keyPath: 'id', autoIncrement: true });
                        examStore.createIndex('name', 'name', { unique: false });
                        examStore.createIndex('startDate', 'startDate', { unique: false });
                        examStore.createIndex('endDate', 'endDate', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.MARKS)) {
                        const marksStore = db.createObjectStore(STORES.MARKS, { keyPath: 'id', autoIncrement: true });
                        marksStore.createIndex('examId', 'examId', { unique: false });
                        marksStore.createIndex('studentId', 'studentId', { unique: false });
                        marksStore.createIndex('subjectId', 'subjectId', { unique: false });
                        marksStore.createIndex('examStudentSubject', ['examId', 'studentId', 'subjectId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.FEES)) {
                        const feesStore = db.createObjectStore(STORES.FEES, { keyPath: 'id', autoIncrement: true });
                        feesStore.createIndex('studentId', 'studentId', { unique: false });
                        feesStore.createIndex('date', 'date', { unique: false });
                        feesStore.createIndex('month', 'month', { unique: false });
                        feesStore.createIndex('year', 'year', { unique: false });
                        feesStore.createIndex('studentMonthYear', ['studentId', 'month', 'year'], { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.FEE_STRUCTURE)) {
                        const feeStructureStore = db.createObjectStore(STORES.FEE_STRUCTURE, { keyPath: 'id', autoIncrement: true });
                        feeStructureStore.createIndex('classId', 'classId', { unique: false });
                        feeStructureStore.createIndex('category', 'category', { unique: false });
                        feeStructureStore.createIndex('classCategory', ['classId', 'category'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SALARY)) {
                        const salaryStore = db.createObjectStore(STORES.SALARY, { keyPath: 'id', autoIncrement: true });
                        salaryStore.createIndex('employeeId', 'employeeId', { unique: false });
                        salaryStore.createIndex('employeeType', 'employeeType', { unique: false });
                        salaryStore.createIndex('month', 'month', { unique: false });
                        salaryStore.createIndex('year', 'year', { unique: false });
                        salaryStore.createIndex('date', 'date', { unique: false });
                        salaryStore.createIndex('employeeMonthYear', ['employeeId', 'month', 'year'], { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.SALARY_STRUCTURE)) {
                        const salaryStructureStore = db.createObjectStore(STORES.SALARY_STRUCTURE, { keyPath: 'id', autoIncrement: true });
                        salaryStructureStore.createIndex('employeeId', 'employeeId', { unique: false });
                        salaryStructureStore.createIndex('employeeType', 'employeeType', { unique: false });
                        salaryStructureStore.createIndex('employeeTypeId', ['employeeType', 'employeeId'], { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.BOOKS)) {
                        const booksStore = db.createObjectStore(STORES.BOOKS, { keyPath: 'id', autoIncrement: true });
                        booksStore.createIndex('name', 'name', { unique: false });
                        booksStore.createIndex('author', 'author', { unique: false });
                        booksStore.createIndex('category', 'category', { unique: false });
                        booksStore.createIndex('isbn', 'isbn', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.BOOK_ISSUES)) {
                        const bookIssuesStore = db.createObjectStore(STORES.BOOK_ISSUES, { keyPath: 'id', autoIncrement: true });
                        bookIssuesStore.createIndex('bookId', 'bookId', { unique: false });
                        bookIssuesStore.createIndex('memberId', 'memberId', { unique: false });
                        bookIssuesStore.createIndex('memberType', 'memberType', { unique: false });
                        bookIssuesStore.createIndex('issueDate', 'issueDate', { unique: false });
                        bookIssuesStore.createIndex('returnDate', 'returnDate', { unique: false });
                        bookIssuesStore.createIndex('status', 'status', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.USERS)) {
                        const usersStore = db.createObjectStore(STORES.USERS, { keyPath: 'id', autoIncrement: true });
                        usersStore.createIndex('username', 'username', { unique: true });
                        usersStore.createIndex('email', 'email', { unique: true });
                        usersStore.createIndex('role', 'role', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.ROLES)) {
                        const rolesStore = db.createObjectStore(STORES.ROLES, { keyPath: 'id', autoIncrement: true });
                        rolesStore.createIndex('name', 'name', { unique: true });
                    }
                    if (!db.objectStoreNames.contains(STORES.SETTINGS)) {
                        const settingsStore = db.createObjectStore(STORES.SETTINGS, { keyPath: 'id', autoIncrement: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.EVENTS)) {
                        const eventsStore = db.createObjectStore(STORES.EVENTS, { keyPath: 'id', autoIncrement: true });
                        eventsStore.createIndex('date', 'date', { unique: false });
                        eventsStore.createIndex('type', 'type', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.ACTIVITIES)) {
                        const activitiesStore = db.createObjectStore(STORES.ACTIVITIES, { keyPath: 'id', autoIncrement: true });
                        activitiesStore.createIndex('date', 'date', { unique: false });
                        activitiesStore.createIndex('type', 'type', { unique: false });
                        activitiesStore.createIndex('userId', 'userId', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORES.BACKUP)) {
                        const backupStore = db.createObjectStore(STORES.BACKUP, { keyPath: 'id', autoIncrement: true });
                        backupStore.createIndex('date', 'date', { unique: false });
                        backupStore.createIndex('type', 'type', { unique: false });
                    }
                    console.log('Database setup completed');
                };
            });
        }
        function showLoading() {
            if (typeof window._0xac7d9f !== 'function' || !window._0xac7d9f()) { console.error('Activation Error: Core component missing.'); return; }
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'flex';
            }
        }
        function hideLoading() {
            if (typeof window._0xac7d9f !== 'function' || !window._0xac7d9f()) { console.error('Activation Error: Core component missing.'); return; }
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '-';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        function formatCurrency(amount) {
            const number = parseFloat(amount);
            if (isNaN(number)) {
                return '0 Rs';
            }
            return number.toLocaleString('en-US') + ' Rs';
        }
        function calculateSalaryTotal() {
            const payingNow = parseFloat(document.getElementById('salary-paying-now').value) || 0;
            const bonus = parseFloat(document.getElementById('salary-payment-bonus').value) || 0;
            const deductions = parseFloat(document.getElementById('salary-payment-deductions').value) || 0;
            const totalSalary = payingNow + bonus - deductions;
            document.getElementById('salary-payment-total').value = totalSalary.toFixed(2);
        }
        function calculateFeeTotal() {
            const feeAmount = parseFloat(document.getElementById('fee-paying-now').value) || 0;
            const fine = parseFloat(document.getElementById('fee-fine').value) || 0;
            const discount = parseFloat(document.getElementById('fee-discount').value) || 0;
            const totalFee = feeAmount + fine - discount;
            document.getElementById('fee-total').value = totalFee.toFixed(2);
        }
        function getFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function getAllFromStore(storeName, limit = null) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => {
                    let results = request.result;
                    if (limit && typeof limit === 'number') {
                        results = results.slice(0, limit);
                    }
                    resolve(results);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function getAllFromIndex(storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = value !== undefined ? index.getAll(value) : index.getAll();
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function addToStore(storeName, data, upsert = false) {
            if (typeof window._0xac7d9f !== 'function' || !window._0xac7d9f()) { console.error('Activation Error: Core component missing.'); return; }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = upsert ? store.put(data) : store.add(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        function updateInStore(storeName, id, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const getRequest = store.get(id);
                getRequest.onsuccess = () => {
                    const existingData = getRequest.result;
                    if (!existingData) {
                        reject(new Error('Item not found'));
                        return;
                    }
                    const updatedData = { ...existingData, ...data };
                    const updateRequest = store.put(updatedData);
                    updateRequest.onsuccess = () => {
                        resolve(updateRequest.result);
                    };
                    updateRequest.onerror = () => {
                        reject(updateRequest.error);
                    };
                };
                getRequest.onerror = () => {
                    reject(getRequest.error);
                };
            });
        }
        function deleteFromStore(storeName, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = () => {
                    resolve(true);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        function getCount(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.count();
                request.onsuccess = () => {
                    resolve(request.result);
                };
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }
        async function getStudentByRollNumber(rollNumber) {
            try {
                const transaction = db.transaction(STORES.STUDENTS, 'readonly');
                const store = transaction.objectStore(STORES.STUDENTS);
                const index = store.index('rollNumber');
                const request = index.get(rollNumber);
                return new Promise((resolve, reject) => {
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            } catch (error) {
                console.error('Error getting student by roll number:', error);
                throw error;
            }
        }
        function createElementJS(tag, attributes = {}, textContent = null) {
            const element = document.createElement(tag);
            let hasInnerHTML = false;
            for (const key in attributes) {
                if (key === 'style' && typeof attributes[key] === 'object') {
                    for (const styleProp in attributes[key]) {
                        element.style[styleProp] = attributes[key][styleProp];
                    }
                } else if (key === 'dataset' && typeof attributes[key] === 'object') {
                    for (const dataKey in attributes[key]) {
                        element.dataset[dataKey] = attributes[key][dataKey];
                    }
                } else if (key === 'innerHTML') {
                    element.innerHTML = attributes[key];
                    hasInnerHTML = true;
                } else if (typeof attributes[key] === 'boolean') {
                    if (attributes[key]) {
                        element.setAttribute(key, '');
                    }
                } else {
                    element.setAttribute(key, attributes[key]);
                }
            }
            if (!hasInnerHTML && textContent !== null && textContent !== undefined) {
                element.textContent = textContent;
            }
            return element;
        }
        async function loadDropdownData() {
            try {
                await loadClassDropdowns();
                await loadSubjectDropdowns();
                await loadTeacherDropdowns();
                console.log('Dropdown data loaded successfully');
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                showNotification('Error loading dropdown data.', 'error');
            }
        }
        async function loadClassDropdowns() {
            try {
                const classes = await getAllFromStore(STORES.CLASSES);
                const classDropdowns = document.querySelectorAll('select[id$="-class"]');
                classDropdowns.forEach(dropdown => {
                    const existingOptions = Array.from(dropdown.options).filter(option => {
                        return option.value === 'all' || option.dataset.fixed === 'true';
                    });
                    dropdown.innerHTML = '';
                    existingOptions.forEach(option => {
                        dropdown.appendChild(option);
                    });
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.name;
                        dropdown.appendChild(option);
                    });
                });
                console.log('Class dropdowns loaded successfully');
            } catch (error) {
                console.error('Error loading class dropdowns:', error);
            }
        }
        async function loadSubjectDropdowns() {
            try {
                const subjects = await getAllFromStore(STORES.SUBJECTS);
                const subjectDropdowns = document.querySelectorAll('select[id$="-subject"]');
                subjectDropdowns.forEach(dropdown => {
                    const existingOptions = Array.from(dropdown.options).filter(option => {
                        return option.value === 'all' || option.dataset.fixed === 'true';
                    });
                    dropdown.innerHTML = '';
                    existingOptions.forEach(option => {
                        dropdown.appendChild(option);
                    });
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.id;
                        option.textContent = subject.name;
                        dropdown.appendChild(option);
                    });
                });
                console.log('Subject dropdowns loaded successfully');
            } catch (error) {
                console.error('Error loading subject dropdowns:', error);
            }
        }
        async function loadTeacherDropdowns() {
            try {
                const teachers = await getAllFromStore(STORES.TEACHERS);
                const teacherDropdowns = document.querySelectorAll('select[id$="-teacher"], select[id$="-incharge"], select[id$="Teacher"]');
                teacherDropdowns.forEach(dropdown => {
                    const currentVal = dropdown.value;
                    const fixedOptions = Array.from(dropdown.options).filter(opt => opt.value === "" || opt.value === "all" || opt.dataset.fixed);
                    dropdown.innerHTML = '';
                    fixedOptions.forEach(opt => dropdown.appendChild(opt.cloneNode(true)));
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = teacher.name;
                        dropdown.appendChild(option);
                    });
                    if (Array.from(dropdown.options).some(opt => opt.value === currentVal)) {
                        dropdown.value = currentVal;
                    }
                });
            } catch (error) {
                console.error('Error loading teacher dropdowns:', error);
            }
        }
        async function loadSchoolSettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                document.getElementById('school-name').value = settings.schoolName || '';
                document.getElementById('principal-name').value = settings.principalName || '';
                document.getElementById('school-address').value = settings.schoolAddress || '';
                document.getElementById('school-contact').value = settings.schoolPhone || '';
                document.getElementById('school-email').value = settings.schoolEmail || '';
                document.getElementById('setting-current-session').value = settings.currentSession || `${new Date().getFullYear()}-${new Date().getFullYear() + 1}`;
                document.getElementById('setting-session-start').value = settings.sessionStart || new Date(new Date().getFullYear(), 8, 1).toISOString().split('T')[0];
                document.getElementById('setting-session-end').value = settings.sessionEnd || new Date(new Date().getFullYear() + 1, 4, 31).toISOString().split('T')[0];
                document.getElementById('setting-school-time-start').value = settings.schoolTimeStart || '08:00';
                document.getElementById('setting-school-time-end').value = settings.schoolTimeEnd || '14:00';
                document.getElementById('setting-period-duration').value = settings.periodDuration || 45;
                if (settings.weeklyHoliday) {
                    Array.from(document.getElementById('setting-weekly-holiday').options).forEach(opt => {
                        opt.selected = settings.weeklyHoliday.includes(opt.value);
                    });
                }
                document.getElementById('setting-fee-due-day').value = settings.feeDueDay !== undefined ? settings.feeDueDay : 10;
                document.getElementById('setting-fee-late-fine').value = settings.feeLateFine !== undefined ? settings.feeLateFine : 50;
                document.getElementById('setting-library-return-days').value = settings.libraryReturnDays !== undefined ? settings.libraryReturnDays : 14;
                document.getElementById('setting-library-late-fine').value = settings.libraryLateFine !== undefined ? settings.libraryLateFine : 5;
                document.getElementById('setting-primary-color').value = settings.primaryColor || '#3498db';
                document.getElementById('setting-secondary-color').value = settings.secondaryColor || '#2c3e50';
                document.getElementById('setting-font-size').value = settings.fontSize || 'medium';
                document.getElementById('setting-font-family').value = settings.fontFamily || 'Arial, sans-serif';
                document.getElementById('setting-sidebar-position').value = settings.sidebarPosition || 'left';
                document.getElementById('setting-sidebar-theme').value = settings.sidebarTheme || 'dark';
                document.getElementById('system-language').value = settings.language || 'en';
                document.getElementById('auto-backup-enable').checked = settings.autoBackupEnabled || false;
                if (settings.autoBackupRetention) {
                    document.getElementById('auto-backup-retention').value = settings.autoBackupRetention;
                }
                document.getElementById('auto-backup-options').style.display = settings.autoBackupEnabled ? 'block' : 'none';
            } catch (e) {
                console.error("Error loading school settings:", e);
                showNotification('Error loading settings.', 'error');
            }
        }
        async function applySettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general');
                if (!settings) return;
                document.documentElement.style.setProperty('--primary-color', settings.primaryColor || '#3498db');
                document.documentElement.style.setProperty('--secondary-color', settings.secondaryColor || '#2c3e50');
                let fontSizeValue = '16px';
                switch (settings.fontSize) {
                    case 'small': fontSizeValue = '14px'; break;
                    case 'medium': fontSizeValue = '16px'; break;
                    case 'large': fontSizeValue = '18px'; break;
                }
                document.documentElement.style.setProperty('--font-size', fontSizeValue);
                document.documentElement.style.setProperty('--font-family', settings.fontFamily || 'Arial, sans-serif');
                const sidebar = document.getElementById('sidebar');
                if (settings.sidebarTheme === 'light') {
                    sidebar.style.backgroundColor = '#f5f5f5';
                    sidebar.style.color = '#333';
                } else {
                    sidebar.style.backgroundColor = '#34495e';
                    sidebar.style.color = 'white';
                }
                const currentLang = localStorage.getItem('schoolAppLanguage') || 'en';
                document.body.dir = currentLang === 'ur' ? 'rtl' : 'ltr';
                console.log('Settings applied successfully (layout handled by CSS).');
            } catch (error) {
                console.error('Error applying settings:', error);
            }
        }
        async function showFeeReceipt(feeData, studentData) {
            const modal = document.getElementById('fee-receipt-modal');
            const contentArea = document.getElementById('receipt-content-area');
            const schoolName = appSettings.schoolName || 'Deeni Madrasa';
            if (!studentData) {
                studentData = await getFromStore(STORES.STUDENTS, feeData.studentId);
            }
            const className = studentData.classId ? (await getFromStore(STORES.CLASSES, studentData.classId))?.name : 'N/A';
            const monthName = new Date(feeData.year, feeData.month - 1, 1).toLocaleString('en-US', { month: 'long' });
            const feeStructure = await getFeeStructureForStudent(studentData.id, studentData.classId, studentData.feeCategory);
            const fullMonthlyFee = feeStructure?.monthlyFee || studentData.monthlyFee || 0;
            const allPaidRecordsForMonth = (await getAllFromIndex(STORES.FEES, 'studentMonthYear', [feeData.studentId, feeData.month, feeData.year]));
            const totalPaidForMonth = allPaidRecordsForMonth.reduce((sum, rec) => sum + rec.amount - rec.discount, 0);
            const totalFinePaid = allPaidRecordsForMonth.reduce((sum, rec) => sum + rec.fine, 0);
            const remainingBalance = fullMonthlyFee - totalPaidForMonth;
            contentArea.innerHTML = `
                <div class="receipt-paper" id="printable-receipt">
                    <div class="receipt-watermark">PAID</div>
                    <h3>${schoolName}</h3>
                    <p style="text-align:center; font-size: 10px;">Fee Receipt</p>
                    <hr>
                    <p><strong>Receipt #:</strong> ${feeData.receiptNumber}</p>
                    <p><strong>Date:</strong> ${formatDate(feeData.date)}</p>
                    <hr>
                    <p><strong>Name:</strong> ${feeData.studentName}</p>
                    <p><strong>Roll #:</strong> ${studentData.rollNumber}</p>
                    <p><strong>Class:</strong> ${className}</p>
                    <p><strong>Fee for:</strong> ${monthName}, ${feeData.year}</p>
                    <hr>
                    <div class="receipt-item"><span>Total Monthly Fee:</span><span>${formatCurrency(fullMonthlyFee)}</span></div>
                    <div class="receipt-item"><span>This Payment:</span><span>${formatCurrency(feeData.amount)}</span></div>
                    <div class="receipt-item"><span>Discount on this Payment:</span><span>-${formatCurrency(feeData.discount)}</span></div>
                    <div class="receipt-item"><span>Fine on this Payment:</span><span>${formatCurrency(feeData.fine)}</span></div>
                    <hr>
                    <div class="receipt-item receipt-total"><span>TOTAL PAID (This Receipt):</span><span>${formatCurrency(feeData.total)}</span></div>
                    <hr>
                    <div class="receipt-item" style="font-weight:bold;"><span>Month's Remaining Balance:</span><span>${formatCurrency(remainingBalance)}</span></div>
                </div>
            `;
            document.getElementById('print-receipt-btn-final').onclick = function () {
                exportElementAsPNG('printable-receipt', `Receipt-${feeData.receiptNumber}.png`);
            };
            modal.style.display = 'block';
        }
        async function viewFeeReceipt(feeId) {
            const feeRecord = await getFromStore(STORES.FEES, feeId);
            if (feeRecord) {
                showFeeReceipt(feeRecord);
            }
        }
        async function populateLibraryDropdowns() {
            try {
                const [books, students, issued] = await Promise.all([
                    getAllFromStore(STORES.BOOKS),
                    getAllFromStore(STORES.STUDENTS),
                    getAllFromStore(STORES.BOOK_ISSUES)
                ]);
                const bookSelect = document.getElementById('issue-book-select');
                if (bookSelect) {
                    bookSelect.innerHTML = '<option value="">Select Book</option>';
                    books.forEach(book => {
                        if (book.availableCopies > 0) {
                            bookSelect.innerHTML += `<option value="${book.id}">${book.name} (${book.availableCopies} available)</option>`;
                        }
                    });
                } else {
                    console.warn("issue-book-select not found");
                }
                const studentSelect = document.getElementById('issue-student-select');
                if (studentSelect) {
                    studentSelect.innerHTML = '<option value="">Select Student</option>';
                    students.forEach(student => {
                        studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.rollNumber})</option>`;
                    });
                } else {
                    console.warn("issue-student-select not found");
                }
                const returnSelect = document.getElementById('return-book-select');
                if (returnSelect) {
                    returnSelect.innerHTML = '<option value="">Select Issued Book</option>';
                    const activeIssues = issued.filter(i => i.status === 'issued');
                    for (const issue of activeIssues) {
                        const book = books.find(b => b.id === issue.bookId);
                        const student = students.find(s => s.id === issue.memberId);
                        if (book && student) {
                            returnSelect.innerHTML += `<option value="${issue.id}">${book.name} - Issued to: ${student.name}</option>`;
                        }
                    }
                } else {
                    console.warn("return-book-select not found");
                }
            } catch (e) {
                console.error("Error populating library dropdowns:", e);
                showNotification('Error populating library dropdowns.', 'error');
            }
        }
        async function showDashboardDetailsPopup(title, contentGenerator) {
            showLoading();
            const modal = document.getElementById('student-details-modal');
            const contentArea = document.getElementById('modal-content-area');
            try {
                const contentHTML = await contentGenerator();
                contentArea.innerHTML = `<h3 class="form-title">${title}</h3>` + contentHTML;
                modal.style.display = 'block';
            } catch (e) {
                console.error("Error generating details popup:", e);
                showNotification("Could not load details.", "error");
            } finally {
                hideLoading();
            }
        }
        async function loadDashboardData() {
            try {
                const correctCards = [
                    { id: 'total-students', title: 'Total Students', subtitle: 'Registered Students' },
                    { id: 'total-teachers', title: 'Total Teachers', subtitle: 'Registered Teachers' },
                    { id: 'total-classes', title: 'Total Classes', subtitle: 'Active Classes' },
                    { id: 'today-attendance', title: "Today's Attendance", subtitle: 'Students Present' },
                    { id: 'monthly-fee', title: 'Monthly Fee Collection', subtitle: 'Current Month' },
                    { id: 'pending-fee', title: 'Outstanding Fees', subtitle: 'Pending Payments' }
                ];
                const dashboardCards = document.querySelectorAll('#dashboard-view .card');
                if (dashboardCards.length >= correctCards.length) {
                    correctCards.forEach((cardData, index) => {
                        const cardElement = dashboardCards[index];
                        cardElement.querySelector('.card-title').textContent = cardData.title;
                        cardElement.querySelector('.card-subtitle').textContent = cardData.subtitle;
                        cardElement.querySelector('.card-value').id = cardData.id;
                    });
                }
                const totalStudents = (await getAllFromStore(STORES.STUDENTS)).filter(s => !s.status || s.status === 'active').length;
                const totalTeachers = await getCount(STORES.TEACHERS);
                const totalClasses = await getCount(STORES.CLASSES);
                const todayISO = new Date().toISOString().split('T')[0];
                const attendancePercentage = await getTodayAttendancePercentage(todayISO);
                const currentMonth = new Date().getMonth() + 1;
                const currentYear = new Date().getFullYear();
                const monthlyFee = await getMonthlyFeeCollection(currentMonth, currentYear);
                const pendingFee = await getTotalPendingFee();
                document.getElementById('total-students').textContent = totalStudents;
                document.getElementById('total-teachers').textContent = totalTeachers;
                document.getElementById('total-classes').textContent = totalClasses;
                document.getElementById('today-attendance').textContent = attendancePercentage + '%';
                document.getElementById('monthly-fee').textContent = formatCurrency(monthlyFee);
                document.getElementById('pending-fee').textContent = formatCurrency(pendingFee);
                document.getElementById('total-students').parentElement.onclick = () => showDashboardDetailsPopup('Active Students', generateStudentDetailsHTML);
                document.getElementById('total-teachers').parentElement.onclick = () => showDashboardDetailsPopup('Teachers List', generateTeacherDetailsHTML);
                document.getElementById('monthly-fee').parentElement.onclick = () => showDashboardDetailsPopup(`Fee Collection - ${new Date(currentYear, currentMonth - 1).toLocaleString('default', { month: 'long' })}`, () => generateMonthlyCollectionDetailsHTML(currentMonth, currentYear));
                document.getElementById('pending-fee').parentElement.onclick = () => showDashboardDetailsPopup('Outstanding Fee Details', generatePendingFeeDetailsHTML);
                document.getElementById('today-attendance').parentElement.onclick = () => showDashboardDetailsPopup("Today's Attendance Details", generateTodaysAttendanceDetailsHTML);
                await loadUpcomingEvents();
                await loadRecentActivities();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error loading dashboard data.', 'error');
            }
        }
        async function generateStudentDetailsHTML() {
            const students = (await getAllFromStore(STORES.STUDENTS)).filter(s => !s.status || s.status === 'active');
            let html = `<div class="table-container" style="max-height: 70vh; overflow-y: auto;"><table class="table"><thead><tr><th>Roll No</th><th>Name</th><th>Father's Name</th><th>Class</th><th>Contact</th></tr></thead><tbody>`;
            for (const student of students) {
                const className = student.classId ? (await getFromStore(STORES.CLASSES, student.classId))?.name : 'N/A';
                html += `<tr><td>${student.rollNumber}</td><td>${student.name}</td><td>${student.fatherName}</td><td>${className}</td><td>${student.contact}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            return html;
        }
        async function generateTeacherDetailsHTML() {
            const teachers = await getAllFromStore(STORES.TEACHERS);
            let html = `<div class="table-container" style="max-height: 70vh; overflow-y: auto;"><table class="table"><thead><tr><th>ID</th><th>Name</th><th>Specialization</th><th>Contact</th><th>Joining Date</th></tr></thead><tbody>`;
            for (const teacher of teachers) {
                html += `<tr><td>${teacher.employeeId}</td><td>${teacher.name}</td><td>${teacher.specialization}</td><td>${teacher.contact}</td><td>${formatDate(teacher.joiningDate)}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            return html;
        }
        function modifySalaryFormUI() {
            const salaryForm = document.getElementById('salary-payment-form');
            if (!salaryForm || salaryForm.dataset.uiModified === 'true') return;
            const basicSalaryGroup = salaryForm.querySelector('input#salary-payment-basic')?.closest('.form-group');
            const allowancesGroup = salaryForm.querySelector('input#salary-payment-allowances')?.closest('.form-group');
            const bonusGroup = salaryForm.querySelector('input#salary-payment-bonus')?.closest('.form-group');
            const deductionsGroup = salaryForm.querySelector('input#salary-payment-deductions')?.closest('.form-group');
            const absenceGroup = salaryForm.querySelector('input#salary-payment-absence')?.closest('.form-group');
            const taxGroup = salaryForm.querySelector('input#salary-payment-tax')?.closest('.form-group');
            const netPayableGroup = salaryForm.querySelector('input#salary-payment-total')?.closest('.form-group');
            const monthYearRow = salaryForm.querySelector('select#salary-month')?.closest('.form-row');
            if (!basicSalaryGroup || !monthYearRow) {
                console.log('Salary form UI appears to be already modified. Skipping.');
                return;
            }
            const newRowsHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Remaining Balance for Month</label>
                        <input type="number" class="form-control" id="salary-balance" readonly style="font-weight:bold; color:#c0392b;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount Paying Now</label>
                        <input type="number" class="form-control" id="salary-paying-now" required>
                    </div>
                     <div class="form-group">
                        <label class="form-label">Bonus (This Payment)</label>
                        <input type="number" class="form-control" id="salary-payment-bonus" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Deductions (This Payment)</label>
                        <input type="number" class="form-control" id="salary-payment-deductions" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Net Payable</label>
                        <input type="number" class="form-control" id="salary-payment-total" readonly>
                    </div>
                </div>
            `;
            [basicSalaryGroup, allowancesGroup, bonusGroup, deductionsGroup, absenceGroup, taxGroup, netPayableGroup]
                .forEach(group => group?.remove());
            monthYearRow.insertAdjacentHTML('afterend', newRowsHTML);
            salaryForm.dataset.uiModified = 'true';
        }
        async function generateMonthlyCollectionDetailsHTML(month, year) {
            const records = (await getAllFromStore(STORES.FEES)).filter(f => f.month === month && f.year === year);
            const total = records.reduce((sum, rec) => sum + rec.total, 0);
            let html = `<div class="dashboard-cards" style="margin-bottom: 15px;"><div class="card"><div class="card-title">Total Collected</div><div class="card-value">${formatCurrency(total)}</div></div><div class="card"><div class="card-title">Transactions</div><div class="card-value">${records.length}</div></div></div>`;
            html += `<div class="table-container" style="max-height: 60vh; overflow-y: auto;"><table class="table"><thead><tr><th>Receipt #</th><th>Student</th><th>Date</th><th>Amount</th></tr></thead><tbody>`;
            for (const record of records) {
                html += `<tr><td>${record.receiptNumber}</td><td>${record.studentName}</td><td>${formatDate(record.date)}</td><td>${formatCurrency(record.total)}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            return html;
        }
        async function getTodayAttendancePercentage(date) {
            try {
                const attendanceRecordsForToday = await getAllFromIndex(STORES.ATTENDANCE, 'date', date);
                if (attendanceRecordsForToday.length === 0) return 0;
                const attendedClassSections = new Set(
                    attendanceRecordsForToday.map(r => `${r.classId}-${r.sectionId}`)
                );
                if (attendedClassSections.size === 0) return 0;
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const activeStudentsInAttendedClasses = allStudents.filter(s => {
                    const classSectionKey = `${s.classId}-${s.sectionId}`;
                    return (s.status === 'active' || !s.status) && attendedClassSections.has(classSectionKey);
                });
                if (activeStudentsInAttendedClasses.length === 0) return 0;
                const presentCount = attendanceRecordsForToday.filter(record => record.status === 'present' && !record.isLeave).length;
                const percentage = Math.round((presentCount / activeStudentsInAttendedClasses.length) * 100);
                return isNaN(percentage) ? 0 : percentage;
            } catch (error) {
                console.error('Error getting today attendance percentage:', error);
                return 0;
            }
        }
        async function getMonthlyFeeCollection(month, year) {
            try {
                const feeRecords = await getAllFromStore(STORES.FEES);
                const monthlyRecords = feeRecords.filter(record => {
                    return record.month === month && record.year === year;
                });
                const totalAmount = monthlyRecords.reduce((total, record) => {
                    return total + (record.amount + record.fine - record.discount);
                }, 0);
                return totalAmount;
            } catch (error) {
                console.error('Error getting monthly fee collection:', error);
                return 0;
            }
        }
        async function getTotalPendingFee() {
            try {
                const students = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.status === 'active' || !s.status);
                const allFeeRecords = await getAllFromStore(STORES.FEES);
                const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
                const structureMap = new Map();
                feeStructures.forEach(fs => {
                    structureMap.set(`${fs.classId}-${fs.category}`, fs.monthlyFee);
                });
                const paymentsMap = new Map();
                allFeeRecords.forEach(rec => {
                    const key = `${rec.studentId}-${rec.month}-${rec.year}`;
                    const totalPaid = (paymentsMap.get(key) || 0) + (rec.amount - (rec.discount || 0));
                    paymentsMap.set(key, totalPaid);
                });
                let totalPendingFee = 0;
                const currentDate = new Date();
                for (const student of students) {
                    if (!student.admissionDate) continue;
                    const studentDefaultFee = student.monthlyFee || 0;
                    const feeStructureRate = structureMap.get(`${student.classId}-${student.feeCategory}`) ?? structureMap.get(`${student.classId}-General`);
                    const studentMonthlyFee = feeStructureRate ?? studentDefaultFee;
                    if (studentMonthlyFee === 0) continue;
                    const admissionDate = new Date(student.admissionDate);
                    for (let d = new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); d <= currentDate; d.setMonth(d.getMonth() + 1)) {
                        const month = d.getMonth() + 1;
                        const year = d.getFullYear();
                        const paidAmount = paymentsMap.get(`${student.id}-${month}-${year}`) || 0;
                        if (paidAmount < studentMonthlyFee) {
                            totalPendingFee += (studentMonthlyFee - paidAmount);
                        }
                    }
                }
                return totalPendingFee;
            } catch (error) {
                console.error('Error getting total pending fee:', error);
                return 0;
            }
        }
        async function loadUpcomingEvents() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const events = await getAllFromStore(STORES.EVENTS);
                const upcomingEvents = events.filter(event => new Date(event.date) >= today)
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .slice(0, 5);
                const tbody = document.querySelector('#events-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (upcomingEvents.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center;">No upcoming events</td>`;
                    tbody.appendChild(row);
                    return;
                }
                upcomingEvents.forEach((event, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${event.title}</td>
                        <td>${formatDate(event.date)}</td>
                        <td>${event.location || '-'}</td>
                        <td>${event.description || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading upcoming events:', error);
                showNotification('Error loading upcoming events.', 'error');
            }
        }
        async function loadRecentActivities() {
            try {
                const activities = await getAllFromStore(STORES.ACTIVITIES);
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));
                const recentActivities = activities.slice(0, 5);
                const tbody = document.querySelector('#activities-table tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                if (recentActivities.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="5" style="text-align: center;">No recent activities</td>`;
                    tbody.appendChild(row);
                    return;
                }
                recentActivities.forEach((activity, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${activity.description}</td>
                        <td>${formatDateTime(activity.date)}</td>
                        <td>${activity.user || '-'}</td>
                        <td>${activity.details || '-'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading recent activities:', error);
                showNotification('Error loading recent activities.', 'error');
            }
        }
        async function loadAndCacheAppSettings() {
            const defaults = {
                libraryReturnDays: 14,
                feeDueDay: 10,
                feeLateFine: 50,
                weeklyHoliday: ['Sunday']
            };
            appSettings = await getFromStore(STORES.SETTINGS, 'general') || defaults;
            for (const key in defaults) {
                if (appSettings[key] === undefined) {
                    appSettings[key] = defaults[key];
                }
            }
        }
        function setupFormHandlers() {
            document.getElementById('student-form').addEventListener('submit', function (e) { e.preventDefault(); addStudent(); });
            document.getElementById('teacher-form').addEventListener('submit', function (e) { e.preventDefault(); addTeacher(); });
            document.getElementById('staff-form').addEventListener('submit', function (e) { e.preventDefault(); addStaff(); });
            document.getElementById('class-form').addEventListener('submit', function (e) { e.preventDefault(); addClass(); });
            document.getElementById('subject-form').addEventListener('submit', function (e) { e.preventDefault(); addSubject(); });
            document.getElementById('save-class-subject').addEventListener('click', saveClassSubject);
            document.getElementById('save-section').addEventListener('click', saveSection);
            document.getElementById('attendance-form').addEventListener('submit', function (e) { e.preventDefault(); saveAttendance(); });
            document.getElementById('exam-form').addEventListener('submit', function (e) { e.preventDefault(); addExam(); });
            document.getElementById('marks-form').addEventListener('submit', function (e) { e.preventDefault(); saveMarks(); });
            document.getElementById('fee-form').addEventListener('submit', function (e) { e.preventDefault(); collectFee(); });
            document.getElementById('fee-structure-form').addEventListener('submit', function (e) { e.preventDefault(); saveFeeStructure(); });
            document.getElementById('salary-form').addEventListener('submit', function (e) { e.preventDefault(); paySalary(); });
            document.getElementById('save-salary-structure').addEventListener('click', saveSalaryStructure);
            document.getElementById('book-form').addEventListener('submit', function (e) { e.preventDefault(); addBook(); });
            document.getElementById('issue-form').addEventListener('submit', function (e) { e.preventDefault(); issueBook(); });
            document.getElementById('return-form').addEventListener('submit', function (e) { e.preventDefault(); returnBook(); });
            document.getElementById('user-form').addEventListener('submit', function (e) { e.preventDefault(); addUser(); });
            document.getElementById('role-form').addEventListener('submit', function (e) { e.preventDefault(); addRole(); });
            document.getElementById('academic-settings-form').addEventListener('submit', saveAcademicSettings);
            document.getElementById('theme-settings-form').addEventListener('submit', saveThemeSettings);
            document.getElementById('reset-theme-btn').addEventListener('click', resetThemeSettings);
        }
        function setCurrentDateDefaults() {
            const today = new Date().toISOString().split('T')[0];
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            document.querySelectorAll('input[id$="-year"]').forEach(input => {
                if (!input.value) {
                    input.value = currentYear;
                }
            });
            document.querySelectorAll('select[id$="-month"]').forEach(select => {
                if (!select.value) {
                    Array.from(select.options).forEach(option => {
                        if (parseInt(option.value) === currentMonth) {
                            option.selected = true;
                        }
                    });
                }
            });
        }
        const REPORT_CONFIG = {
            students: [
                { id: 'student_strength_by_class', name: 'Student Strength by Class', filters: [], generator: generateStudentStrengthByClassReportJS, chartType: 'bar' },
                { id: 'student_gender_ratio_by_class', name: 'Student Gender Ratio (Class-wise)', filters: ['class_optional'], generator: generateStudentGenderRatioByClassReportJS, chartType: 'pie_multi' },
                { id: 'student_admission_trend', name: 'Student Admission Trend (Monthly)', filters: ['year_optional'], generator: generateStudentAdmissionTrendReportJS, chartType: 'line' },
                { id: 'student_list_filtered', name: 'Student List (Filtered)', filters: ['class_optional', 'section_optional', 'gender_optional'], generator: generateFilteredStudentListReportJS, chartType: null }
            ],
            attendance: [
                { id: 'daily_attendance_summary', name: 'Daily Attendance Summary', filters: ['date', 'class_optional', 'section_optional'], generator: generateDailyAttendanceSummaryReportJS, chartType: 'pie' },
                { id: 'monthly_attendance_student', name: 'Monthly Attendance per Student', filters: ['month_year', 'class', 'section_optional', 'student_optional'], generator: generateMonthlyAttendanceByStudentReportJS, chartType: 'bar_grouped' },
                { id: 'class_attendance_percentage_range', name: 'Class Attendance Percentage (Period)', filters: ['date_range', 'class_optional'], generator: generateClassAttendancePercentageRangeReportJS, chartType: 'bar' }
            ],
            fees: [
                { id: 'fee_collection_daily_summary', name: 'Daily Fee Collection Summary', filters: ['date'], generator: generateFeeCollectionDailySummaryReportJS, chartType: 'multi' },
                { id: 'fee_collection_monthly_class', name: 'Monthly Fee Collection (Class-wise)', filters: ['month_year', 'class_optional'], generator: generateFeeCollectionMonthlyByClassReportJS, chartType: 'bar' },
                { id: 'fee_defaulters_list', name: 'Fee Defaulters List', filters: ['month_year', 'class_optional', 'section_optional'], generator: generateFeeDefaultersListReportJS, chartType: null },
                { id: 'fee_category_wise_collection', name: 'Fee Category-wise Collection (Period)', filters: ['date_range'], generator: generateFeeCategoryWiseCollectionReportJS, chartType: 'pie' }
            ],
        };
        let currentReportChart = null;
        async function initializeReportsViewJS() {
            const reportsViewDiv = document.getElementById('reports-view');
            if (!reportsViewDiv) {
                console.error("Reports view container 'reports-view' not found.");
                return;
            }
            const existingH2 = reportsViewDiv.querySelector('h2');
            reportsViewDiv.innerHTML = '';
            if (existingH2) reportsViewDiv.appendChild(existingH2);
            const formContainer = createElementJS('div', { class: 'form-container' });
            reportsViewDiv.appendChild(formContainer);
            formContainer.appendChild(createElementJS('div', { class: 'form-title' }, 'Select Report'));
            const reportTypeRow = createElementJS('div', { class: 'form-row' });
            const reportTypeGroup = createElementJS('div', { class: 'form-group', style: { flexBasis: '100%' } });
            reportTypeGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-report-type-select' }, 'Report Type'));
            const reportTypeSelect = createElementJS('select', { class: 'form-control', id: 'js-report-type-select' });
            reportTypeSelect.appendChild(createElementJS('option', { value: '' }, '--- Select ---'));
            for (const categoryKey in REPORT_CONFIG) {
                let categoryLabel = categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);
                if (categoryKey === 'students') categoryLabel = 'Students';
                if (categoryKey === 'attendance') categoryLabel = 'Attendance';
                if (categoryKey === 'fees') categoryLabel = 'Fees';
                const optgroup = createElementJS('optgroup', { label: categoryLabel });
                REPORT_CONFIG[categoryKey].forEach(report => {
                    optgroup.appendChild(createElementJS('option', { value: `${categoryKey}:${report.id}` }, report.name));
                });
                reportTypeSelect.appendChild(optgroup);
            }
            reportTypeGroup.appendChild(reportTypeSelect);
            reportTypeRow.appendChild(reportTypeGroup);
            formContainer.appendChild(reportTypeRow);
            const filtersArea = createElementJS('div', { id: 'js-report-filters-area', class: 'form-row', style: { marginTop: '15px', display: 'none', flexWrap: 'wrap', gap: '15px' } });
            formContainer.appendChild(filtersArea);
            const generateBtnRow = createElementJS('div', { class: 'form-row', style: { marginTop: '15px' } });
            const generateBtn = createElementJS('button', { class: 'btn btn-primary', id: 'js-generate-report-btn' }, 'Generate Report');
            generateBtnRow.appendChild(generateBtn);
            formContainer.appendChild(generateBtnRow);
            const reportOutputDiv = createElementJS('div', { id: 'js-report-output-area', style: { marginTop: '20px' } });
            reportsViewDiv.appendChild(reportOutputDiv);
            reportTypeSelect.addEventListener('change', handleReportTypeChangeJS);
            generateBtn.addEventListener('click', generateSelectedReportJS);
            handleReportTypeChangeJS();
        }
        async function createCollapsibleFilterUI(targetListDivId, filterContainerId, filterTitleTextContent, createFilterRowsFn, populateDropdownsFn, applyFiltersFn, resetFiltersFn, specificDropdownChangeHandlers = []) {
            const listDiv = document.getElementById(targetListDivId);
            if (!listDiv) {
                console.error(`Target div '${targetListDivId}' not found for creating filters.`);
                return;
            }
            if (document.getElementById(filterContainerId)) {
                if (populateDropdownsFn) await populateDropdownsFn();
                return;
            }
            const existingSearchContainer = listDiv.querySelector('.form-container:not(.js-filter-container)');
            const filterContainer = createElementJS('div', {
                id: filterContainerId,
                class: 'form-container js-filter-container',
                style: { marginBottom: '20px' }
            });
            const filterHeader = createElementJS('div', {
                class: 'form-title filter-header-toggle',
                style: { cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
            });
            const filterTitleSpan = createElementJS('span', {}, filterTitleTextContent);
            const filterToggleIcon = createElementJS('span', { class: 'filter-toggle-icon', innerHTML: '&#9660;' });
            filterHeader.appendChild(filterTitleSpan);
            filterHeader.appendChild(filterToggleIcon);
            filterContainer.appendChild(filterHeader);
            const filterContent = createElementJS('div', { class: 'filter-content', style: { display: 'none', paddingTop: '15px' } });
            await createFilterRowsFn(filterContent);
            filterContainer.appendChild(filterContent);
            if (existingSearchContainer) {
                listDiv.insertBefore(filterContainer, existingSearchContainer);
            } else {
                listDiv.appendChild(filterContainer);
            }
            filterHeader.addEventListener('click', () => {
                const isVisible = filterContent.style.display === 'block';
                filterContent.style.display = isVisible ? 'none' : 'block';
                filterToggleIcon.innerHTML = isVisible ? '&#9660;' : '&#9650;';
            });
            if (populateDropdownsFn) {
                await populateDropdownsFn();
            }
            specificDropdownChangeHandlers.forEach(handlerConfig => {
                const dropdown = filterContent.querySelector(`#${handlerConfig.dropdownId}`);
                if (dropdown) {
                    dropdown.addEventListener('change', handlerConfig.handlerFn);
                }
            });
            const applyButton = filterContent.querySelector('button[id^="js-apply-"]');
            if (applyButton && applyFiltersFn) applyButton.addEventListener('click', applyFiltersFn);
            const resetButton = filterContent.querySelector('button[id^="js-reset-"]');
            if (resetButton && resetFiltersFn) resetButton.addEventListener('click', resetFiltersFn);
        }
        async function createStudentFilterRows(filterContentDiv) {
            const row1 = createElementJS('div', { class: 'form-row' });
            const classGroup = createElementJS('div', { class: 'form-group' });
            classGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-class' }, 'Class'));
            classGroup.appendChild(createElementJS('select', { class: 'form-control', id: 'js-filter-student-class', multiple: true, style: { height: '100px' } }));
            row1.appendChild(classGroup);
            const sectionGroup = createElementJS('div', { class: 'form-group' });
            sectionGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-section' }, 'Section'));
            sectionGroup.appendChild(createElementJS('select', { class: 'form-control', id: 'js-filter-student-section', multiple: true, style: { height: '100px' } }));
            row1.appendChild(sectionGroup);
            filterContentDiv.appendChild(row1);
            const row2 = createElementJS('div', { class: 'form-row' });
            const genderGroup = createElementJS('div', { class: 'form-group' });
            genderGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-gender' }, 'Gender'));
            const genderSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-student-gender' });
            genderSelect.appendChild(createElementJS('option', { value: '' }, 'All'));
            genderSelect.appendChild(createElementJS('option', { value: 'Male' }, 'Male'));
            genderSelect.appendChild(createElementJS('option', { value: 'Female' }, 'Female'));
            genderGroup.appendChild(genderSelect);
            row2.appendChild(genderGroup);
            const feeCategoryGroup = createElementJS('div', { class: 'form-group' });
            feeCategoryGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student-fee-category' }, 'Fee Category'));
            const feeCategorySelect = createElementJS('select', { class: 'form-control', id: 'js-filter-student-fee-category' });
            feeCategorySelect.appendChild(createElementJS('option', { value: '' }, 'All'));
            ['General', 'Deserving', 'Scholarship', 'Full Waiver'].forEach(cat => {
                feeCategorySelect.appendChild(createElementJS('option', { value: cat }, cat));
            });
            feeCategoryGroup.appendChild(feeCategorySelect);
            row2.appendChild(feeCategoryGroup);
            filterContentDiv.appendChild(row2);
            const row3 = createElementJS('div', { class: 'form-row' });
            const dateFromGroup = createElementJS('div', { class: 'form-group' });
            dateFromGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-admission-date-from' }, 'Admission Date (From)'));
            dateFromGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-admission-date-from' }));
            row3.appendChild(dateFromGroup);
            const dateToGroup = createElementJS('div', { class: 'form-group' });
            dateToGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-admission-date-to' }, 'Admission Date (To)'));
            dateToGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-admission-date-to' }));
            row3.appendChild(dateToGroup);
            filterContentDiv.appendChild(row3);
            const row4 = createElementJS('div', { class: 'form-row' });
            row4.appendChild(createElementJS('button', { class: 'btn btn-primary', id: 'js-apply-student-filters-btn' }, 'Apply Filters'));
            row4.appendChild(createElementJS('button', { class: 'btn btn-danger', id: 'js-reset-student-filters-btn', style: { marginLeft: '10px' } }, 'Reset Filters'));
            filterContentDiv.appendChild(row4);
        }
        async function populateStudentFilterDropdownsJS() {
            try {
                const classes = await getAllFromStore(STORES.CLASSES);
                const classFilterDropdown = document.getElementById('js-filter-student-class');
                if (!classFilterDropdown) return;
                classFilterDropdown.innerHTML = '';
                classes.forEach(cls => {
                    classFilterDropdown.appendChild(createElementJS('option', { value: cls.id }, cls.name));
                });
                await populateStudentFilterSectionsJS();
            } catch (error) {
                console.error('Error populating student class filter dropdown (JS):', error);
            }
        }
        async function populateStudentFilterSectionsJS() {
            const classFilterDropdown = document.getElementById('js-filter-student-class');
            const sectionFilterDropdown = document.getElementById('js-filter-student-section');
            if (!classFilterDropdown || !sectionFilterDropdown) return;
            sectionFilterDropdown.innerHTML = '';
            const selectedClassIds = Array.from(classFilterDropdown.selectedOptions).map(opt => parseInt(opt.value));
            if (selectedClassIds.length === 0) {
                const allSections = await getAllFromStore(STORES.SECTIONS);
                for (const section of allSections) {
                    const classData = await getFromStore(STORES.CLASSES, section.classId);
                    sectionFilterDropdown.appendChild(
                        createElementJS('option', { value: section.id }, `${section.name} (${classData?.name || 'N/A'})`)
                    );
                }
                return;
            }
            for (const classId of selectedClassIds) {
                if (isNaN(classId)) continue;
                try {
                    const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                    const classData = await getFromStore(STORES.CLASSES, classId);
                    sections.forEach(section => {
                        sectionFilterDropdown.appendChild(
                            createElementJS('option', { value: section.id }, `${section.name} (${classData?.name || 'N/A'})`)
                        );
                    });
                } catch (error) {
                    console.error(`Error populating JS sections for class ID ${classId}:`, error);
                }
            }
        }
        async function applyStudentFiltersJS() {
            showLoading();
            try {
                const selectedClassIds = Array.from(document.getElementById('js-filter-student-class').selectedOptions).map(opt => parseInt(opt.value));
                const selectedSectionIds = Array.from(document.getElementById('js-filter-student-section').selectedOptions).map(opt => parseInt(opt.value));
                const selectedGender = document.getElementById('js-filter-student-gender').value;
                const selectedFeeCategory = document.getElementById('js-filter-student-fee-category').value;
                const admissionDateFromStr = document.getElementById('js-filter-admission-date-from').value;
                const admissionDateToStr = document.getElementById('js-filter-admission-date-to').value;
                let students = await getAllFromStore(STORES.STUDENTS);
                if (selectedClassIds.length > 0) {
                    students = students.filter(student => selectedClassIds.includes(student.classId));
                }
                if (selectedSectionIds.length > 0) {
                    students = students.filter(student => selectedSectionIds.includes(student.sectionId));
                }
                if (selectedGender) {
                    students = students.filter(student => student.gender === selectedGender);
                }
                if (selectedFeeCategory) {
                    students = students.filter(student => student.feeCategory === selectedFeeCategory);
                }
                if (admissionDateFromStr) {
                    const fromDate = new Date(admissionDateFromStr);
                    students = students.filter(student => student.admissionDate && new Date(student.admissionDate) >= fromDate);
                }
                if (admissionDateToStr) {
                    const toDate = new Date(admissionDateToStr);
                    const adjustedToDate = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate() + 1);
                    students = students.filter(student => student.admissionDate && new Date(student.admissionDate) < adjustedToDate);
                }
                loadStudentsTable(students);
            } catch (error) {
                console.error("Error applying student filters (JS):", error);
                showNotification('Failed to apply filters.', 'error');
            } finally {
                hideLoading();
            }
        }
        function resetStudentFiltersJS() {
            const classSelect = document.getElementById('js-filter-student-class');
            if (classSelect) Array.from(classSelect.options).forEach(opt => opt.selected = false);
            const sectionSelect = document.getElementById('js-filter-student-section');
            if (sectionSelect) sectionSelect.innerHTML = '';
            populateStudentFilterSectionsJS();
            const genderSelect = document.getElementById('js-filter-student-gender');
            if (genderSelect) genderSelect.value = '';
            const feeCatSelect = document.getElementById('js-filter-student-fee-category');
            if (feeCatSelect) feeCatSelect.value = '';
            const dateFrom = document.getElementById('js-filter-admission-date-from');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('js-filter-admission-date-to');
            if (dateTo) dateTo.value = '';
            loadStudentsTable();
        }
        async function createTeacherFilterRows(filterContentDiv) {
            const row1 = createElementJS('div', { class: 'form-row' });
            const subjectGroup = createElementJS('div', { class: 'form-group' });
            subjectGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-subject' }, 'Subject'));
            subjectGroup.appendChild(createElementJS('select', { class: 'form-control', id: 'js-filter-teacher-subject', multiple: true, style: { height: '100px' } }));
            row1.appendChild(subjectGroup);
            const qualGroup = createElementJS('div', { class: 'form-group' });
            qualGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-qualification' }, 'Qualification (Search)'));
            qualGroup.appendChild(createElementJS('input', { type: 'text', class: 'form-control', id: 'js-filter-teacher-qualification', placeholder: 'e.g. Alim, Fazil' }));
            row1.appendChild(qualGroup);
            filterContentDiv.appendChild(row1);
            const row2 = createElementJS('div', { class: 'form-row' });
            const dateFromGroup = createElementJS('div', { class: 'form-group' });
            dateFromGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-joining-from' }, 'Joining Date (From)'));
            dateFromGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-teacher-joining-from' }));
            row2.appendChild(dateFromGroup);
            const dateToGroup = createElementJS('div', { class: 'form-group' });
            dateToGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-teacher-joining-to' }, 'Joining Date (To)'));
            dateToGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-teacher-joining-to' }));
            row2.appendChild(dateToGroup);
            filterContentDiv.appendChild(row2);
            const row3 = createElementJS('div', { class: 'form-row' });
            row3.appendChild(createElementJS('button', { class: 'btn btn-primary', id: 'js-apply-teacher-filters-btn' }, 'Apply Filters'));
            row3.appendChild(createElementJS('button', { class: 'btn btn-danger', id: 'js-reset-teacher-filters-btn', style: { marginLeft: '10px' } }, 'Reset Filters'));
            filterContentDiv.appendChild(row3);
        }
        async function populateTeacherFilterDropdownsJS() {
            try {
                const subjects = await getAllFromStore(STORES.SUBJECTS);
                const subjectFilterDropdown = document.getElementById('js-filter-teacher-subject');
                if (!subjectFilterDropdown) return;
                subjectFilterDropdown.innerHTML = '';
                subjects.forEach(sub => {
                    subjectFilterDropdown.appendChild(createElementJS('option', { value: sub.id }, sub.name));
                });
            } catch (error) {
                console.error('Error populating teacher subject filter (JS):', error);
            }
        }
        async function applyTeacherFiltersJS() {
            showLoading();
            try {
                const selectedSubjectIds = Array.from(document.getElementById('js-filter-teacher-subject').selectedOptions).map(opt => parseInt(opt.value));
                const qualificationSearch = document.getElementById('js-filter-teacher-qualification').value.toLowerCase();
                const joiningDateFromStr = document.getElementById('js-filter-teacher-joining-from').value;
                const joiningDateToStr = document.getElementById('js-filter-teacher-joining-to').value;
                let teachers = await getAllFromStore(STORES.TEACHERS);
                if (selectedSubjectIds.length > 0) {
                    teachers = teachers.filter(teacher => teacher.subjects && teacher.subjects.some(subId => selectedSubjectIds.includes(parseInt(subId))));
                }
                if (qualificationSearch) {
                    teachers = teachers.filter(teacher => teacher.qualification && teacher.qualification.toLowerCase().includes(qualificationSearch));
                }
                if (joiningDateFromStr) {
                    const fromDate = new Date(joiningDateFromStr);
                    teachers = teachers.filter(teacher => teacher.joiningDate && new Date(teacher.joiningDate) >= fromDate);
                }
                if (joiningDateToStr) {
                    const toDate = new Date(joiningDateToStr);
                    const adjustedToDate = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate() + 1);
                    teachers = teachers.filter(teacher => teacher.joiningDate && new Date(teacher.joiningDate) < adjustedToDate);
                }
                loadTeachersTable(teachers);
            } catch (error) {
                console.error("Error applying teacher filters (JS):", error);
                showNotification('Failed to apply filters.', 'error');
            } finally {
                hideLoading();
            }
        }
        function resetTeacherFiltersJS() {
            const subjectSelect = document.getElementById('js-filter-teacher-subject');
            if (subjectSelect) Array.from(subjectSelect.options).forEach(opt => opt.selected = false);
            const qualInput = document.getElementById('js-filter-teacher-qualification');
            if (qualInput) qualInput.value = '';
            const dateFrom = document.getElementById('js-filter-teacher-joining-from');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('js-filter-teacher-joining-to');
            if (dateTo) dateTo.value = '';
            loadTeachersTable();
        }
        async function createStaffFilterRows(filterContentDiv) {
            const row1 = createElementJS('div', { class: 'form-row' });
            const desigGroup = createElementJS('div', { class: 'form-group' });
            desigGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-designation' }, 'Designation'));
            const desigSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-staff-designation' });
            desigSelect.appendChild(createElementJS('option', { value: '' }, 'All'));
            ['Office Clerk', 'Librarian', 'Security Guard', 'Cleaner', 'Driver', 'Other'].forEach(d => {
                desigSelect.appendChild(createElementJS('option', { value: d }, d));
            });
            desigGroup.appendChild(desigSelect);
            row1.appendChild(desigGroup);
            const deptGroup = createElementJS('div', { class: 'form-group' });
            deptGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-department' }, 'Department'));
            const deptSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-staff-department' });
            deptSelect.appendChild(createElementJS('option', { value: '' }, 'All'));
            ['Administration', 'Accounts', 'Library', 'Security', 'Transport', 'Cleaning', 'Other'].forEach(d => {
                deptSelect.appendChild(createElementJS('option', { value: d }, d));
            });
            deptGroup.appendChild(deptSelect);
            row1.appendChild(deptGroup);
            filterContentDiv.appendChild(row1);
            const row2 = createElementJS('div', { class: 'form-row' });
            const dateFromGroup = createElementJS('div', { class: 'form-group' });
            dateFromGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-joining-from' }, 'Joining Date (From)'));
            dateFromGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-staff-joining-from' }));
            row2.appendChild(dateFromGroup);
            const dateToGroup = createElementJS('div', { class: 'form-group' });
            dateToGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-staff-joining-to' }, 'Joining Date (To)'));
            dateToGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-staff-joining-to' }));
            row2.appendChild(dateToGroup);
            filterContentDiv.appendChild(row2);
            const row3 = createElementJS('div', { class: 'form-row' });
            row3.appendChild(createElementJS('button', { class: 'btn btn-primary', id: 'js-apply-staff-filters-btn' }, 'Apply Filters'));
            row3.appendChild(createElementJS('button', { class: 'btn btn-danger', id: 'js-reset-staff-filters-btn', style: { marginLeft: '10px' } }, 'Reset Filters'));
            filterContentDiv.appendChild(row3);
        }
        async function applyStaffFiltersJS() {
            showLoading();
            try {
                const selectedDesignation = document.getElementById('js-filter-staff-designation').value;
                const selectedDepartment = document.getElementById('js-filter-staff-department').value;
                const joiningDateFromStr = document.getElementById('js-filter-staff-joining-from').value;
                const joiningDateToStr = document.getElementById('js-filter-staff-joining-to').value;
                let staffList = await getAllFromStore(STORES.STAFF);
                if (selectedDesignation) {
                    staffList = staffList.filter(staff => staff.designation === selectedDesignation);
                }
                if (selectedDepartment) {
                    staffList = staffList.filter(staff => staff.department === selectedDepartment);
                }
                if (joiningDateFromStr) {
                    const fromDate = new Date(joiningDateFromStr);
                    staffList = staffList.filter(staff => staff.joiningDate && new Date(staff.joiningDate) >= fromDate);
                }
                if (joiningDateToStr) {
                    const toDate = new Date(joiningDateToStr);
                    const adjustedToDate = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate() + 1);
                    staffList = staffList.filter(staff => staff.joiningDate && new Date(staff.joiningDate) < adjustedToDate);
                }
                loadStaffTable(staffList);
            } catch (error) {
                console.error("Error applying staff filters (JS):", error);
                showNotification('Failed to apply filters.', 'error');
            } finally {
                hideLoading();
            }
        }
        function resetStaffFiltersJS() {
            const desigSelect = document.getElementById('js-filter-staff-designation');
            if (desigSelect) desigSelect.value = '';
            const deptSelect = document.getElementById('js-filter-staff-department');
            if (deptSelect) deptSelect.value = '';
            const dateFrom = document.getElementById('js-filter-staff-joining-from');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('js-filter-staff-joining-to');
            if (dateTo) dateTo.value = '';
            loadStaffTable();
        }
        async function loadStudentsTable(studentsToLoad = null) {
            try {
                const students = studentsToLoad === null ? await getAllFromStore(STORES.STUDENTS) : studentsToLoad;
                const activeStudents = students.filter(s => !s.status || s.status === 'active');
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = '';
                if (activeStudents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No active students found.</td></tr>';
                    return;
                }
                const [allClasses, allSections] = await Promise.all([
                    getAllFromStore(STORES.CLASSES),
                    getAllFromStore(STORES.SECTIONS)
                ]);
                const classMap = new Map(allClasses.map(c => [c.id, c.name]));
                const sectionMap = new Map(allSections.map(s => [s.id, s.name]));
                const rowsHtml = activeStudents.map(student => {
                    const className = classMap.get(student.classId) || 'N/A';
                    const sectionName = sectionMap.get(student.sectionId) || 'N/A';
                    return `
                <tr>
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>${student.fatherName}</td>
                    <td>${className}</td>
                    <td>${sectionName}</td>
                    <td>${student.contact}</td>
                    <td>${formatDate(student.admissionDate)}</td>
                    <td class="no-print">
                        <button class="btn btn-info btn-sm" onclick="viewStudentDetails(${student.id})">View</button>
                        <button class="btn btn-primary btn-sm" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.STUDENTS}', ${student.id})">Delete</button>
                    </td>
                </tr>
            `;
                }).join('');
                tbody.innerHTML = rowsHtml;
            } catch (error) {
                console.error('Error loading students table:', error);
            }
        }
        function exportTableToCSV(tableId, filename) {
            const table = document.getElementById(tableId);
            if (!table) return;
            let csv = [];
            const rows = table.querySelectorAll("tr");
            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const rowData = [];
                for (const col of cols) {
                    let data = col.innerText.replace(/"/g, '""');
                    if (data.includes(',')) {
                        data = `"${data}"`;
                    }
                    rowData.push(data);
                }
                csv.push(rowData.join(","));
            }
            const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        async function viewStudentDetails(studentId) {
            showLoading();
            const modal = document.getElementById('student-details-modal');
            const contentArea = document.getElementById('modal-content-area');
            contentArea.innerHTML = '';
            try {
                const student = await getFromStore(STORES.STUDENTS, studentId);
                if (!student) {
                    showNotification('Student not found.', 'error');
                    return;
                }
                const profileHTML = await generateProfileSectionHTML(student);
                const feeHTML = await generateFeeSectionHTML(student);
                const attendanceHTML = await generateAttendanceSectionHTML(studentId);
                const examHTML = await generateExamSectionHTML(studentId);
                contentArea.innerHTML = profileHTML + feeHTML + attendanceHTML + examHTML;
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error viewing student details:', error);
                showNotification('Could not load student details.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateProfileSectionHTML(student) {
            const displayClassName = student.className || 'N/A';
            const displaySectionName = student.sectionName || 'N/A';
            return `
    <div class="profile-card">
        <div class="profile-image">
            <img src="${student.photo || 'logo2.png'}" alt="Student Photo">
        </div>
        <div class="profile-details">
            <div class="profile-name">${student.name}</div>
            <div class="profile-info"><span>Roll No:</span> ${student.rollNumber}</div>
            <div class="profile-info"><span>Class:</span> ${displayClassName} (${displaySectionName})</div>
            <div class="profile-info"><span>Father:</span> ${student.fatherName}</div>
            <div class="profile-info"><span>Contact:</span> ${student.contact}</div>
            <div class="profile-info"><span>Status:</span> <span style="font-weight:bold; color:${student.status !== 'active' ? '#e74c3c' : '#2ecc71'}; text-transform: capitalize;">${student.status || 'Active'}</span></div>
        </div>
    </div>
`;
        }
        async function generateFeeSectionHTML(student) {
            let html = `<div class="form-container" style="margin-top:20px;">
                    <div class="form-title">Fee History</div>`;
            const paidRecords = await getAllFromIndex(STORES.FEES, 'studentId', student.id);
            const paidMap = new Map(paidRecords.map(rec => [`${rec.month}-${rec.year}`, true]));
            const dueRecords = [];
            let totalPaid = 0;
            let totalDue = 0;
            const admissionDate = new Date(student.admissionDate);
            admissionDate.setDate(1);
            const currentDate = new Date();
            currentDate.setDate(1);
            for (let d = new Date(admissionDate); d <= currentDate; d.setMonth(d.getMonth() + 1)) {
                const month = d.getMonth() + 1;
                const monthNameForDisplay = d.toLocaleString('en-US', { month: 'long' });
                const year = d.getFullYear();
                if (!paidMap.has(`${month}-${year}`)) {
                    const feeStructure = await getFeeStructureForStudent(student.id, student.classId, student.feeCategory);
                    const dueAmount = feeStructure?.monthlyFee || student.monthlyFee || 0;
                    if (dueAmount > 0) {
                        dueRecords.push({ month: monthNameForDisplay, year, amount: dueAmount });
                        totalDue += dueAmount;
                    }
                }
            }
            if (dueRecords.length > 0) {
                html += `<h4>Due Fees (Total: ${formatCurrency(totalDue)})</h4>
                 <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                   <table class="table" id="student-due-fees-table">
                     <thead><tr><th>Month</th><th>Year</th><th>Amount Due</th></tr></thead><tbody>`;
                dueRecords.forEach(due => {
                    html += `<tr><td>${due.month}</td><td>${due.year}</td><td>${formatCurrency(due.amount)}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <h4>Paid Fee History</h4>
                <button class="btn btn-success btn-sm no-print" onclick="exportTableToCSV('student-paid-fees-table', 'FeeHistory_${student.rollNumber}.csv')">Export Paid</button>
             </div>
             <div class="table-container" style=" overflow-y: auto;">
               <table class="table" id="student-paid-fees-table">
                 <thead><tr><th>Receipt</th><th>Month/Year</th><th>Date</th><th>Amount</th><th>Fine</th><th>Discount</th><th>Total</th></tr></thead><tbody>`;
            if (paidRecords.length > 0) {
                paidRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rec => {
                    totalPaid += rec.total;
                    const monthName = new Date(rec.year, rec.month - 1, 1).toLocaleString('en-US', { month: 'long' });
                    html += `<tr>
                <td>${rec.receiptNumber}</td>
                <td>${monthName} ${rec.year}</td>
                <td>${formatDate(rec.date)}</td>
                <td>${formatCurrency(rec.amount)}</td>
                <td>${formatCurrency(rec.fine)}</td>
                <td>${formatCurrency(rec.discount)}</td>
                <td>${formatCurrency(rec.total)}</td>
            </tr>`;
                });
            } else {
                html += `<tr><td colspan="7" style="text-align:center;">No paid fee records found.</td></tr>`;
            }
            html += `</tbody><tfoot><tr><td colspan="6" style="text-align:right; font-weight:bold;">Total Paid:</td><td>${formatCurrency(totalPaid)}</td></tr></tfoot></table></div></div>`;
            return html;
        }
        async function generateAttendanceSectionHTML(studentId) {
            const records = await getAllFromIndex(STORES.ATTENDANCE, 'studentId', studentId);
            let html = `<div class="form-container" style="margin-top:20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="form-title">Attendance History</div>
                        <button class="btn btn-success btn-sm no-print" onclick="exportTableToCSV('student-attendance-table', 'Attendance_${studentId}.csv')">Export</button>
                    </div>
                    <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                      <table class="table" id="student-attendance-table">
                        <thead><tr><th>Date</th><th>Status</th><th>Late</th><th>Leave</th><th>Notes</th></tr></thead><tbody>`;
            if (records.length > 0) {
                records.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rec => {
                    html += `<tr>
                <td>${formatDate(rec.date)}</td>
                <td style="text-transform: capitalize;">${rec.status}</td>
                <td>${rec.isLate ? 'Yes' : 'No'}</td>
                <td>${rec.isLeave ? 'Yes' : 'No'}</td>
                <td>${rec.notes || '-'}</td>
            </tr>`;
                });
            } else {
                html += `<tr><td colspan="5" style="text-align:center;">No attendance records found.</td></tr>`;
            }
            html += `</tbody></table></div></div>`;
            return html;
        }
        async function generateExamSectionHTML(studentId) {
            const records = await getAllFromIndex(STORES.MARKS, 'studentId', studentId);
            let html = `<div class="form-container" style="margin-top:20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="form-title">Exam Results</div>
                        <button class="btn btn-success btn-sm no-print" onclick="exportTableToCSV('student-exams-table', 'Exams_${studentId}.csv')">Export</button>
                    </div>
                    <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                      <table class="table" id="student-exams-table">
                        <thead><tr><th>Exam</th><th>Subject</th><th>Total</th><th>Obtained</th><th>Grade</th><th>Result</th></tr></thead><tbody>`;
            if (records.length > 0) {
                for (const rec of records) {
                    const exam = await getFromStore(STORES.EXAMS, rec.examId);
                    const subject = await getFromStore(STORES.SUBJECTS, rec.subjectId);
                    html += `<tr>
                <td>${exam ? exam.name : 'N/A'}</td>
                <td>${subject ? subject.name : 'N/A'}</td>
                <td>${rec.totalMarks}</td>
                <td>${rec.obtainedMarks}</td>
                <td>${rec.grade}</td>
                <td>${rec.isPassed ? 'Passed' : 'Failed'}</td>
            </tr>`;
                }
            } else {
                html += `<tr><td colspan="6" style="text-align:center;">No exam records found.</td></tr>`;
            }
            html += `</tbody></table></div></div>`;
            return html;
        }
        async function loadTeachersTable(teachersToLoad = null) {
            try {
                const teachers = teachersToLoad === null ? await getAllFromStore(STORES.TEACHERS) : teachersToLoad;
                const tbody = document.querySelector('#teachers-table tbody');
                if (!tbody) {
                    console.error("Teachers table body not found!");
                    return;
                }
                tbody.innerHTML = '';
                if (!teachers || teachers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No teachers available or no results from filter.</td></tr>';
                    return;
                }
                for (const teacher of teachers) {
                    const row = document.createElement('tr');
                    let subjectNames = '-';
                    if (teacher.subjects && teacher.subjects.length > 0) {
                        const subjectPromises = teacher.subjects.map(id => getFromStore(STORES.SUBJECTS, parseInt(id)));
                        const subjectObjects = await Promise.all(subjectPromises);
                        subjectNames = subjectObjects.filter(s => s).map(s => s.name).join(', ');
                    }
                    row.innerHTML = `
                <td>${teacher.employeeId}</td>
                <td>${teacher.name}</td>
                <td>${teacher.qualification}</td>
                <td>${subjectNames}</td>
                <td>${teacher.contact}</td>
                <td>${formatDate(teacher.joiningDate)}</td>
                <td>${teacher.basicSalary ? formatCurrency(teacher.basicSalary) : 'N/A'}</td>
                <td class="no-print">
                    <button class="btn btn-info btn-sm" onclick="viewTeacherDetails(${teacher.id})">View</button>
                    <button class="btn btn-primary btn-sm" onclick="editTeacher(${teacher.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.TEACHERS}', ${teacher.id})">Delete</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading teachers table:', error);
                const tbody = document.querySelector('#teachers-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Error loading teacher list.</td></tr>';
            }
        }
        async function loadStaffTable(staffToLoad = null) {
            try {
                let staffArray;
                if (staffToLoad === null) {
                    staffArray = await getAllFromStore(STORES.STAFF);
                } else if (Array.isArray(staffToLoad)) {
                    staffArray = staffToLoad;
                } else {
                    console.warn('loadStaffTable called with non-array. Defaulting to all.', staffToLoad);
                    staffArray = await getAllFromStore(STORES.STAFF);
                }
                const tbody = document.querySelector('#staff-table tbody');
                if (!tbody) {
                    console.error("Staff table body not found!");
                    return;
                }
                tbody.innerHTML = '';
                if (!staffArray || !Array.isArray(staffArray) || staffArray.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No staff available or no results from filter.</td></tr>';
                    return;
                }
                staffArray.forEach(staff => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${staff.employeeId}</td>
                <td>${staff.name}</td>
                <td>${staff.designation}</td>
                <td>${staff.department}</td>
                <td>${staff.contact}</td>
                <td>${formatDate(staff.joiningDate)}</td>
                <td>${staff.basicSalary ? formatCurrency(staff.basicSalary) : 'N/A'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editStaff(${staff.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.STAFF}', ${staff.id})">Delete</button>
                </td>
            `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading staff table:', error);
                const tbody = document.querySelector('#staff-table tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Error loading staff list.</td></tr>';
            }
        }
        async function checkAndLoadSampleData() {
            try {
                const studentsCount = await getCount(STORES.STUDENTS);
                const teachersCount = await getCount(STORES.TEACHERS);
                const classesCount = await getCount(STORES.CLASSES);
                const usersCount = await getCount(STORES.USERS);
                if (studentsCount === 0 && teachersCount === 0 && classesCount === 0 && usersCount === 0) {
                    await loadSampleData();
                    console.log('Sample data loaded successfully');
                } else {
                    console.log('Database already contains data, skipping sample data loading');
                }
            } catch (error) {
                console.error('Error checking and loading sample data:', error);
                showNotification('Error checking and loading sample data.', 'error');
            }
        }
        async function showSendNoticePopup(studentId) {
            showLoading();
            try {
                const student = await getFromStore(STORES.STUDENTS, studentId);
                if (!student) {
                    showNotification('Student not found.', 'error');
                    console.groupEnd();
                    return;
                }
                if (!student.admissionDate) {
                    const errorMessage = `Student ${student.name} (ID: ${studentId}) is missing an admission date. Cannot calculate dues.`;
                    showNotification(errorMessage, 'error');
                    const modal = document.getElementById('send-notice-modal');
                    document.getElementById('notice-student-info').innerHTML = `<strong>To:</strong> ${student.name}`;
                    document.getElementById('notice-message-template').value = `ERROR: Cannot generate notice.\n\nReason: The student is missing an admission date in their profile. Please edit the student's record and add a correct admission date to calculate their fee history.`;
                    modal.style.display = 'block';
                    console.groupEnd();
                    hideLoading();
                    return;
                }
                const [allPaidRecords, feeStructures] = await Promise.all([
                    getAllFromIndex(STORES.FEES, 'studentId', student.id),
                    getAllFromStore(STORES.FEE_STRUCTURE)
                ]);
                const structureMap = new Map();
                feeStructures.forEach(fs => {
                    structureMap.set(`${fs.classId}-${fs.category}`, fs.monthlyFee);
                });
                const paymentsMap = new Map();
                allPaidRecords.forEach(rec => {
                    const key = `${rec.month}-${rec.year}`;
                    const paymentInfo = paymentsMap.get(key) || { paid: 0, historicalFee: null };
                    paymentInfo.paid += rec.amount - (rec.discount || 0);
                    if (rec.monthlyFeeAtTimeOfPayment) {
                        paymentInfo.historicalFee = rec.monthlyFeeAtTimeOfPayment;
                    }
                    paymentsMap.set(key, paymentInfo);
                });
                let totalOutstanding = 0;
                let dueHistoryDetails = [];
                const currentDate = new Date();
                const admissionDate = new Date(student.admissionDate);
                for (let d = new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); d <= currentDate; d.setMonth(d.getMonth() + 1)) {
                    const month = d.getMonth() + 1;
                    const year = d.getFullYear();
                    const monthName = d.toLocaleString('en-US', { month: 'long' });
                    const paymentInfo = paymentsMap.get(`${month}-${year}`);
                    let expectedFee = paymentInfo?.historicalFee;
                    if (expectedFee === undefined || expectedFee === null) {
                        const feeStructureRate = structureMap.get(`${student.classId}-${student.feeCategory}`) ?? structureMap.get(`${student.classId}-General`);
                        expectedFee = feeStructureRate ?? student.monthlyFee ?? 0;
                    }
                    if (expectedFee === 0) {
                        continue;
                    }
                    const paidForMonth = paymentInfo?.paid || 0;
                    const dueForMonth = expectedFee - paidForMonth;
                    if (dueForMonth > 0.01) {
                        totalOutstanding += dueForMonth;
                        dueHistoryDetails.push(`- ${monthName} ${year}: ${formatCurrency(dueForMonth)}`);
                    }
                }
                const greetingName = student.guardian || student.fatherName || 'Parent';
                const schoolName = appSettings.schoolName || 'The School';
                let message = `Dear ${greetingName},\n\nThis is a friendly reminder regarding the fee dues for your child, ${student.name}.\n\n`;
                if (dueHistoryDetails.length > 0) {
                    message += `--- Dues Summary ---\n`;
                    message += dueHistoryDetails.join('\n');
                    message += `\n--------------------\nTotal Outstanding Amount: ${formatCurrency(totalOutstanding)}\n\n`;
                    message += `Kindly clear the dues at your earliest convenience.\n\n`;
                } else {
                    message += `Our records show no outstanding dues. If this is an error, please contact the office.\n\n`
                }
                message += `Thank you,\n${schoolName}`;
                const modal = document.getElementById('send-notice-modal');
                const studentInfoDiv = document.getElementById('notice-student-info');
                const messageTextarea = document.getElementById('notice-message-template');
                studentInfoDiv.innerHTML = `<strong>To:</strong> ${student.name} (${greetingName}) <br> <strong>Phone:</strong> ${student.contact}`;
                messageTextarea.value = message;
                document.getElementById('send-sms-btn').onclick = () => window.open(`sms:${student.contact}?body=${encodeURIComponent(message)}`);
                document.getElementById('send-whatsapp-btn').onclick = () => {
                    const whatsappWindow = window.open('', '_blank');
                    if (!whatsappWindow) { showNotification('Popup was blocked!', 'error'); return; }
                    whatsappWindow.document.write('Opening WhatsApp...');
                    navigator.clipboard.writeText(message).then(() => {
                        showNotification('Message copied!', 'info');
                        let whatsappPhone = student.contact.replace(/[^0-9]/g, '');
                        if (whatsappPhone.startsWith('0')) whatsappPhone = '92' + whatsappPhone.substring(1);
                        whatsappWindow.location.href = `https://wa.me/${whatsappPhone}?text=${encodeURIComponent(message)}`;
                    });
                };
                modal.style.display = 'block';
            } catch (error) {
                console.error("Error preparing notice:", error);
                showNotification('Could not prepare the reminder notice.', 'error');
            } finally {
                console.groupEnd();
                hideLoading();
            }
        }
        function updateBackupOptions() {
            const freqSelect = document.getElementById('auto-backup-frequency');
            const retentionSelect = document.getElementById('auto-backup-retention');
            const timeContainer = document.getElementById('auto-backup-time-container');
            const frequency = freqSelect.value;
            const currentRetentionValue = retentionSelect.value;
            retentionSelect.innerHTML = '';
            let options = {};
            if (frequency === 'daily') {
                options = { '7': '7 Days', '15': '15 Days', '30': '30 Days' };
                timeContainer.style.display = 'block';
            } else if (frequency === 'weekly') {
                options = { '4': '4 Weeks', '8': '8 Weeks', '12': '12 Weeks' };
                timeContainer.style.display = 'none';
            } else {
                options = { '3': '3 Months', '6': '6 Months', '12': '12 Months' };
                timeContainer.style.display = 'none';
            }
            for (const [value, text] of Object.entries(options)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                retentionSelect.appendChild(option);
            }
            if (retentionSelect.querySelector(`option[value="${currentRetentionValue}"]`)) {
                retentionSelect.value = currentRetentionValue;
            }
        }
        async function loadBackupViewSettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                document.getElementById('auto-backup-enable').checked = settings.autoBackupEnabled || false;
                document.getElementById('auto-backup-frequency').value = settings.autoBackupFrequency || 'monthly';
                document.getElementById('auto-backup-time').value = settings.autoBackupTime || '02:00';
                document.getElementById('auto-backup-options').style.display = settings.autoBackupEnabled ? 'block' : 'none';
                updateBackupOptions();
                document.getElementById('auto-backup-retention').value = String(settings.autoBackupRetention || 3);
            } catch (e) {
                console.error("Failed to load backup settings into view:", e);
            }
        }
        async function loadSampleData() {
            try {
                showLoading();
                const classesData = [
                    { name: '1st Grade', level: 'Elementary', inChargeId: null, roomNumber: '101', monthlyFee: 500, admissionFee: 1000 },
                    { name: '2nd Grade', level: 'Elementary', inChargeId: null, roomNumber: '102', monthlyFee: 500, admissionFee: 1000 },
                    { name: '3rd Grade', level: 'Elementary', inChargeId: null, roomNumber: '103', monthlyFee: 600, admissionFee: 1000 },
                    { name: '4th Grade', level: 'Elementary', inChargeId: null, roomNumber: '104', monthlyFee: 600, admissionFee: 1000 },
                    { name: '5th Grade', level: 'Elementary', inChargeId: null, roomNumber: '105', monthlyFee: 700, admissionFee: 1000 },
                    { name: '6th Grade', level: 'Secondary', inChargeId: null, roomNumber: '201', monthlyFee: 800, admissionFee: 1500 },
                    { name: '7th Grade', level: 'Secondary', inChargeId: null, roomNumber: '202', monthlyFee: 800, admissionFee: 1500 },
                    { name: '8th Grade', level: 'Secondary', inChargeId: null, roomNumber: '203', monthlyFee: 900, admissionFee: 1500 },
                    { name: '9th Grade', level: 'Senior', inChargeId: null, roomNumber: '301', monthlyFee: 1000, admissionFee: 2000 },
                    { name: '10th Grade', level: 'Senior', inChargeId: null, roomNumber: '302', monthlyFee: 1000, admissionFee: 2000 },
                    { name: 'Hifz-ul-Quran', level: 'Special', inChargeId: null, roomNumber: '401', monthlyFee: 1200, admissionFee: 2500 },
                    { name: 'Nazra Quran', level: 'Special', inChargeId: null, roomNumber: '402', monthlyFee: 800, admissionFee: 1500 },
                ];
                const classIds = [];
                for (const classData of classesData) {
                    const id = await addToStore(STORES.CLASSES, classData);
                    classIds.push(id);
                }
                const sectionNames = ['A', 'B', 'C'];
                for (const classId of classIds) {
                    for (const sectionName of sectionNames) {
                        await addToStore(STORES.SECTIONS, {
                            classId: classId,
                            name: sectionName,
                            inChargeId: null,
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                const subjectsData = [
                    { name: 'Holy Quran', code: 'QUR', type: 'Quran', periods: 5, details: 'Teaching of Holy Quran' },
                    { name: 'Nazra Quran', code: 'NAZ', type: 'Quran', periods: 5, details: 'Recitation of Holy Quran' },
                    { name: 'Hifz-ul-Quran', code: 'HIF', type: 'Quran', periods: 10, details: 'Memorization of Holy Quran' },
                    { name: 'Tajweed', code: 'TAJ', type: 'Quran', periods: 3, details: 'Correct recitation of Holy Quran' },
                    { name: 'Tafseer-ul-Quran', code: 'TAF', type: 'Quran', periods: 3, details: 'Exegesis of Holy Quran' },
                    { name: 'Hadith', code: 'HAD', type: 'Hadith', periods: 4, details: 'Teaching of Prophetic Traditions' },
                    { name: 'Fiqh', code: 'FIQ', type: 'Fiqh', periods: 3, details: 'Teaching of Islamic Jurisprudence' },
                    { name: 'Aqeedah', code: 'AQA', type: 'Aqeedah', periods: 2, details: 'Teaching of Islamic Beliefs' },
                    { name: 'Seerat-un-Nabi', code: 'SIR', type: 'Seerah', periods: 2, details: 'Teaching of Prophet Muhammad\'s biography' },
                    { name: 'Ethics', code: 'AKH', type: 'Akhlaq', periods: 2, details: 'Teaching of Islamic Ethics' },
                    { name: 'Arabic', code: 'ARB', type: 'Arabic', periods: 4, details: 'Teaching of Arabic language' },
                    { name: 'Urdu', code: 'URD', type: 'Urdu', periods: 4, details: 'Teaching of Urdu language' },
                    { name: 'English', code: 'ENG', type: 'English', periods: 4, details: 'Teaching of English language' },
                    { name: 'Mathematics', code: 'MAT', type: 'Math', periods: 5, details: 'Teaching of Mathematics' },
                    { name: 'Science', code: 'SCI', type: 'Science', periods: 4, details: 'Teaching of Science' },
                    { name: 'Social Studies', code: 'SOC', type: 'Social Studies', periods: 3, details: 'Teaching of Social Studies' },
                    { name: 'Pakistan Studies', code: 'PAK', type: 'Social Studies', periods: 2, details: 'History and Geography of Pakistan' },
                    { name: 'Islamiyat', code: 'ISL', type: 'Islamiyat', periods: 3, details: 'Teaching of Islamic Studies' },
                    { name: 'Computer', code: 'COM', type: 'Computer', periods: 2, details: 'Teaching of Computer Science' },
                    { name: 'Health & Physical Education', code: 'PHY', type: 'Health', periods: 2, details: 'Health and Physical Education' },
                ];
                const subjectIds = [];
                for (const subjectData of subjectsData) {
                    const id = await addToStore(STORES.SUBJECTS, subjectData);
                    subjectIds.push(id);
                }
                const teachersData = [
                    {
                        employeeId: 'T001',
                        name: 'Qari Muhammad Ahmad',
                        fatherName: 'Muhammad Yusuf',
                        gender: 'Male',
                        dob: '1980-05-15',
                        qualification: 'Alim Fazil, Qari',
                        specialization: 'Quran & Hadith',
                        subjects: [String(subjectIds[0]), String(subjectIds[5]), String(subjectIds[6])],
                        contact: '0300-1234567',
                        email: 'ahmad@example.com',
                        address: 'Hafizabad, Lahore',
                        cnic: '35201-1234567-1',
                        joiningDate: '2015-03-01',
                        basicSalary: 25000,
                        allowances: 5000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T002',
                        name: 'Maulana Abdul Rahman',
                        fatherName: 'Abdul Ghafoor',
                        gender: 'Male',
                        dob: '1975-09-20',
                        qualification: 'Shaykh-ul-Hadith, Mufti',
                        specialization: 'Fiqh & Usool',
                        subjects: [String(subjectIds[0]), String(subjectIds[5]), String(subjectIds[6])],
                        contact: '0300-2345678',
                        email: 'abdulrehman@example.com',
                        address: 'Johar Town, Lahore',
                        cnic: '35201-2345678-1',
                        joiningDate: '2010-01-15',
                        basicSalary: 30000,
                        allowances: 7000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T003',
                        name: 'Hafiz Muhammad Umar',
                        fatherName: 'Muhammad Aslam',
                        gender: 'Male',
                        dob: '1985-03-10',
                        qualification: 'Hafiz, Alim',
                        specialization: 'Quran & Tajweed',
                        subjects: [String(subjectIds[0]), String(subjectIds[1]), String(subjectIds[2]), String(subjectIds[3])],
                        contact: '0300-3456789',
                        email: 'umar@example.com',
                        address: 'Township, Lahore',
                        cnic: '35201-3456789-1',
                        joiningDate: '2018-08-01',
                        basicSalary: 22000,
                        allowances: 3000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T004',
                        name: 'Ustad Muhammad Ali',
                        fatherName: 'Muhammad Akram',
                        gender: 'Male',
                        dob: '1982-12-05',
                        qualification: 'M.A Arabic, B.Ed',
                        specialization: 'Arabic & Urdu',
                        subjects: [String(subjectIds[10]), String(subjectIds[11])],
                        contact: '0300-4567890',
                        email: 'ali@example.com',
                        address: 'Faisal Town, Lahore',
                        cnic: '35201-4567890-1',
                        joiningDate: '2016-04-15',
                        basicSalary: 20000,
                        allowances: 4000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T005',
                        name: 'Ustad Muhammad Imran',
                        fatherName: 'Muhammad Afzal',
                        gender: 'Male',
                        dob: '1988-07-25',
                        qualification: 'M.Sc Math, B.Ed',
                        specialization: 'Mathematics & Science',
                        subjects: [String(subjectIds[13]), String(subjectIds[14])],
                        contact: '0300-5678901',
                        email: 'imran@example.com',
                        address: 'Model Town, Lahore',
                        cnic: '35201-5678901-1',
                        joiningDate: '2017-09-01',
                        basicSalary: 23000,
                        allowances: 5000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'T006',
                        name: 'Muallimah Ayesha',
                        fatherName: 'Abdul Sattar',
                        gender: 'Female',
                        dob: '1990-11-12',
                        qualification: 'Alimah Fazilah, B.Ed',
                        specialization: 'Islamiyat & Urdu',
                        subjects: [String(subjectIds[11]), String(subjectIds[17])],
                        contact: '0300-6789012',
                        email: 'ayesha@example.com',
                        address: 'Gulshan-e-Ravi, Lahore',
                        cnic: '35201-6789012-2',
                        joiningDate: '2019-03-15',
                        basicSalary: 20000,
                        allowances: 3000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                const teacherIds = [];
                for (const teacherData of teachersData) {
                    const id = await addToStore(STORES.TEACHERS, teacherData);
                    teacherIds.push(id);
                }
                for (let i = 0; i < Math.min(classIds.length, teacherIds.length); i++) {
                    await updateInStore(STORES.CLASSES, classIds[i], { inChargeId: teacherIds[i % teacherIds.length] });
                }
                const staffData = [
                    {
                        employeeId: 'S001',
                        name: 'Muhammad Arif',
                        fatherName: 'Muhammad Aslam',
                        gender: 'Male',
                        dob: '1985-06-20',
                        designation: 'Office Clerk',
                        department: 'Administration',
                        qualification: 'B.A',
                        responsibilities: 'Office work, admission, registration',
                        contact: '0300-7890123',
                        email: 'arif@example.com',
                        address: 'Faisal Town, Lahore',
                        cnic: '35201-7890123-1',
                        joiningDate: '2018-01-15',
                        basicSalary: 18000,
                        allowances: 2000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'S002',
                        name: 'Muhammad Siddique',
                        fatherName: 'Muhammad Yusuf',
                        gender: 'Male',
                        dob: '1970-04-10',
                        designation: 'Librarian',
                        department: 'Library',
                        qualification: 'M.A Library Science',
                        responsibilities: 'Library management, book issue/return',
                        contact: '0300-8901234',
                        email: 'siddique@example.com',
                        address: 'Township, Lahore',
                        cnic: '35201-8901234-1',
                        joiningDate: '2015-05-01',
                        basicSalary: 20000,
                        allowances: 3000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        employeeId: 'S003',
                        name: 'Abdul Ghafoor',
                        fatherName: 'Abdul Razzaq',
                        gender: 'Male',
                        dob: '1975-08-15',
                        designation: 'Security Guard',
                        department: 'Security',
                        qualification: 'Matric',
                        responsibilities: 'School security, gate checking',
                        contact: '0300-9012345',
                        email: null,
                        address: 'Begum Pura, Lahore',
                        cnic: '35201-9012345-1',
                        joiningDate: '2017-03-01',
                        basicSalary: 15000,
                        allowances: 2000,
                        deductions: 0,
                        photo: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const staffMember of staffData) {
                    await addToStore(STORES.STAFF, staffMember);
                }
                const usersData = [
                    {
                        username: 'superadmin',
                        password: 'superadmin123',
                        name: 'Super Admin',
                        email: 'superadmin@schoolmadrasa.com',
                        role: 'super_admin',
                        status: 'active',
                        mobile: '0300-0000000',
                        address: 'Secret Location',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'admin',
                        password: 'admin123',
                        name: 'System Admin',
                        email: 'admin@schoolmadrasa.com',
                        role: 'admin',
                        status: 'active',
                        mobile: '0300-1234567',
                        address: 'Lahore',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'teacher1',
                        password: 'teacher123',
                        name: 'Qari Muhammad Ahmad',
                        email: 'ahmad@example.com',
                        role: 'teacher',
                        status: 'active',
                        mobile: '0300-1234567',
                        address: 'Hafizabad, Lahore',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'librarian',
                        password: 'librarian123',
                        name: 'Muhammad Siddique',
                        email: 'siddique@example.com',
                        role: 'librarian',
                        status: 'active',
                        mobile: '0300-8901234',
                        address: 'Township, Lahore',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        username: 'accountant',
                        password: 'accountant123',
                        name: 'Muhammad Arif',
                        email: 'arif@example.com',
                        role: 'accountant',
                        status: 'active',
                        mobile: '0300-7890123',
                        address: 'Faisal Town, Lahore',
                        photo: null,
                        lastLogin: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const userData of usersData) {
                    await addToStore(STORES.USERS, userData);
                }
                const rolesData = [
                    {
                        name: 'super_admin',
                        description: 'Full System Administrator Access',
                        permissions: {
                            dashboard: true, students: true, teachers: true, staff: true, classes: true, subjects: true,
                            attendance: true, exams: true, fees: true, salaries: true, library: true, users: true,
                            reports: true, settings: true, backup: true, 'id-cards': true
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'admin',
                        description: 'Standard Administrator Access',
                        permissions: {
                            dashboard: true, students: true, teachers: true, staff: true, classes: true, subjects: true,
                            attendance: true, exams: true, fees: true, salaries: true, library: true,
                            users: false,
                            reports: true,
                            settings: false,
                            backup: true, 'id-cards': true
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'teacher',
                        description: 'Teacher',
                        permissions: {
                            dashboard: true, students: true, teachers: false, staff: false, classes: true, subjects: true,
                            attendance: true, exams: true, fees: false, salaries: false, library: true, users: false,
                            reports: true, settings: false, backup: false, 'id-cards': false
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'librarian',
                        description: 'Librarian',
                        permissions: {
                            dashboard: true, students: true, teachers: true, staff: false, classes: false, subjects: false,
                            attendance: false, exams: false, fees: false, salaries: false, library: true, users: false,
                            reports: true, settings: false, backup: false, 'id-cards': false
                        },
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'accountant',
                        description: 'Accountant',
                        permissions: {
                            dashboard: true, students: true, teachers: true, staff: true, classes: false, subjects: false,
                            attendance: false, exams: false, fees: true, salaries: true, library: false, users: false,
                            reports: true, settings: false, backup: false, 'id-cards': false
                        },
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const roleData of rolesData) {
                    await addToStore(STORES.ROLES, roleData);
                }
                const booksData = [
                    {
                        name: 'Holy Quran with English Translation',
                        author: 'Maulana Fateh Muhammad Jalandhari',
                        category: 'Quran',
                        publisher: 'Al-Quran Academy',
                        publicationYear: 2015,
                        isbn: '978-0123456789',
                        copies: 10,
                        availableCopies: 10,
                        shelf: 'A1',
                        description: 'Holy Quran with English Translation',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Sahih Bukhari',
                        author: 'Imam Muhammad ibn Ismail al-Bukhari',
                        category: 'Hadith',
                        publisher: 'Darussalam Publishers',
                        publicationYear: 2010,
                        isbn: '978-0123456790',
                        copies: 5,
                        availableCopies: 5,
                        shelf: 'B1',
                        description: 'Famous book of Hadith',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Sahih Muslim',
                        author: 'Imam Muslim ibn al-Hajjaj',
                        category: 'Hadith',
                        publisher: 'Darussalam Publishers',
                        publicationYear: 2012,
                        isbn: '978-0123456791',
                        copies: 5,
                        availableCopies: 5,
                        shelf: 'B2',
                        description: 'Famous book of Hadith',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Riyad as-Salihin',
                        author: 'Imam Nawawi',
                        category: 'Hadith',
                        publisher: 'Dar Ibn Kathir',
                        publicationYear: 2014,
                        isbn: '978-0123456792',
                        copies: 8,
                        availableCopies: 8,
                        shelf: 'B3',
                        description: 'Famous collection of Hadith',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Tafseer Ibn Kathir',
                        author: 'Imam Ibn Kathir',
                        category: 'Tafseer',
                        publisher: 'Dar Tayyibah',
                        publicationYear: 2000,
                        isbn: '978-0123456793',
                        copies: 3,
                        availableCopies: 3,
                        shelf: 'C1',
                        description: 'Well-known commentary of the Holy Quran',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Seerat un-Nabi',
                        author: 'Shibli Nomani, Syed Sulaiman Nadwi',
                        category: 'Seerah',
                        publisher: 'Maktaba Rahmaniya',
                        publicationYear: 2005,
                        isbn: '978-0123456794',
                        copies: 7,
                        availableCopies: 7,
                        shelf: 'D1',
                        description: 'Biography of Prophet Muhammad (PBUH)',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Bahishti Zewar',
                        author: 'Maulana Ashraf Ali Thanwi',
                        category: 'Fiqh',
                        publisher: 'Dar-ul-Ishaat',
                        publicationYear: 2008,
                        isbn: '978-0123456795',
                        copies: 10,
                        availableCopies: 10,
                        shelf: 'E1',
                        description: 'Religious guidance for women',
                        image: null,
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Taleem ul-Islam',
                        author: 'Maulana Muhammad Zafaruddin',
                        category: 'Islamiyat',
                        publisher: 'Maktaba Islamia',
                        publicationYear: 2018,
                        isbn: '978-0123456796',
                        copies: 15,
                        availableCopies: 15,
                        shelf: 'F1',
                        description: 'Islamic teachings for children',
                        image: null,
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const bookData of booksData) {
                    await addToStore(STORES.BOOKS, bookData);
                }
                const feeStructureData = [];
                for (const classId of classIds) {
                    const classData = await getFromStore(STORES.CLASSES, classId);
                    feeStructureData.push({
                        classId: classId,
                        category: 'General',
                        monthlyFee: classData.monthlyFee,
                        admissionFee: classData.admissionFee,
                        examFee: classData.monthlyFee * 0.5,
                        computerFee: 100,
                        transportFee: 500,
                        otherFee: 0,
                        createdAt: new Date().toISOString()
                    });
                    feeStructureData.push({
                        classId: classId,
                        category: 'Deserving',
                        monthlyFee: classData.monthlyFee * 0.5,
                        admissionFee: classData.admissionFee * 0.5,
                        examFee: classData.monthlyFee * 0.25,
                        computerFee: 50,
                        transportFee: 250,
                        otherFee: 0,
                        createdAt: new Date().toISOString()
                    });
                    feeStructureData.push({
                        classId: classId,
                        category: 'Scholarship',
                        monthlyFee: 0,
                        admissionFee: 0,
                        examFee: 0,
                        computerFee: 0,
                        transportFee: 0,
                        otherFee: 0,
                        createdAt: new Date().toISOString()
                    });
                }
                for (const feeStructure of feeStructureData) {
                    await addToStore(STORES.FEE_STRUCTURE, feeStructure);
                }
                const sections = await getAllFromStore(STORES.SECTIONS);
                const maleFirstNames = ['Muhammad', 'Ahmad', 'Ali', 'Umar', 'Usman', 'Hassan', 'Hussein', 'Ibrahim', 'Ismail', 'Abdullah', 'Abdul Rahman', 'Faisal', 'Imran', 'Tariq', 'Aslam', 'Akram', 'Bilal', 'Adil', 'Arif', 'Waseem'];
                const femaleFirstNames = ['Aisha', 'Fatima', 'Maryam', 'Zainab', 'Khadijah', 'Hafsa', 'Sumayya', 'Rabia', 'Aminah', 'Safia', 'Halimah', 'Nasreen', 'Shahnaz', 'Rizwana', 'Shabnam', 'Saba', 'Afia', 'Salma', 'Rukhsana', 'Nashwa'];
                const lastNames = ['Ahmad', 'Mahmood', 'Khan', 'Malik', 'Chaudhry', 'Sheikh', 'Syed', 'Hashmi', 'Qureshi', 'Abbasi', 'Bukhari', 'Gilani', 'Naqvi', 'Razvi', 'Alam', 'Ejaz', 'Siddiqui', 'Farooqi', 'Usmani', 'Ansari'];
                const fatherNames = ['Muhammad Ahmad', 'Muhammad Ali', 'Abdul Rahman', 'Abdul Ghafoor', 'Muhammad Aslam', 'Muhammad Akram', 'Muhammad Yusuf', 'Abdullah', 'Muhammad Umar', 'Muhammad Tariq', 'Muhammad Siddique', 'Muhammad Saleem', 'Muhammad Rafiq', 'Muhammad Afzal', 'Muhammad Ashraf', 'Muhammad Anwar', 'Abdul Aziz', 'Abdul Qadir', 'Muhammad Riyaz', 'Muhammad Shafiq'];
                const addresses = [
                    'Hafizabad, Lahore',
                    'Johar Town, Lahore',
                    'Township, Lahore',
                    'Faisal Town, Lahore',
                    'Model Town, Lahore',
                    'Gulshan-e-Ravi, Lahore',
                    'Iqbal Town, Lahore',
                    'Allama Iqbal Town, Lahore',
                    'Wahdat Road, Lahore',
                    'Gulberg, Lahore'
                ];
                const studentsData = [];
                const currentYear = new Date().getFullYear();
                let rollNumber = 1;
                for (const section of sections) {
                    const classData = await getFromStore(STORES.CLASSES, section.classId);
                    for (let i = 0; i < 10; i++) {
                        const gender = Math.random() > 0.5 ? 'Male' : 'Female';
                        const firstName = gender === 'Male'
                            ? maleFirstNames[Math.floor(Math.random() * maleFirstNames.length)]
                            : femaleFirstNames[Math.floor(Math.random() * femaleFirstNames.length)];
                        const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                        const name = firstName + ' ' + lastName;
                        const fatherName = fatherNames[Math.floor(Math.random() * fatherNames.length)];
                        const age = 7 + Math.floor(Math.random() * 9);
                        const dob = new Date(currentYear - age, Math.floor(Math.random() * 12), 1 + Math.floor(Math.random() * 28)).toISOString().split('T')[0];
                        const yearsAgo = Math.floor(Math.random() * 3);
                        const admissionDate = new Date(currentYear - yearsAgo, Math.floor(Math.random() * 12), 1 + Math.floor(Math.random() * 28)).toISOString().split('T')[0];
                        const address = addresses[Math.floor(Math.random() * addresses.length)];
                        const mobilePrefix = ['0300', '0301', '0302', '0303', '0304', '0305', '0310', '0311', '0312', '0313'][Math.floor(Math.random() * 10)];
                        const mobileNumber = mobilePrefix + '-' + Math.floor(1000000 + Math.random() * 9000000);
                        const feeCategories = ['General', 'General', 'General', 'General', 'Deserving', 'Deserving', 'Scholarship'];
                        const feeCategory = feeCategories[Math.floor(Math.random() * feeCategories.length)];
                        studentsData.push({
                            rollNumber: String(rollNumber++).padStart(4, '0'),
                            name: name,
                            fatherName: fatherName,
                            gender: gender,
                            dob: dob,
                            classId: section.classId,
                            className: classData.name,
                            sectionId: section.id,
                            sectionName: section.name,
                            contact: mobileNumber,
                            email: `${firstName.toLowerCase()}${rollNumber}@example.com`,
                            guardian: fatherName,
                            guardianContact: mobileNumber,
                            address: address,
                            photo: null,
                            admissionDate: admissionDate,
                            feeCategory: feeCategory,
                            monthlyFee: classData.monthlyFee,
                            notes: '',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                for (const studentData of studentsData) {
                    await addToStore(STORES.STUDENTS, studentData);
                }
                const today = new Date().toISOString().split('T')[0];
                for (const student of studentsData) {
                    const random = Math.random();
                    let status = 'present';
                    let isLate = false;
                    let isLeave = false;
                    if (random > 0.9) {
                        status = 'absent';
                    } else if (random > 0.85) {
                        status = 'present';
                        isLeave = true;
                    } else if (random > 0.8) {
                        isLate = true;
                    }
                    const studentInDb = await getStudentByRollNumber(student.rollNumber);
                    if (studentInDb) {
                        await addToStore(STORES.ATTENDANCE, {
                            date: today,
                            classId: studentInDb.classId,
                            sectionId: studentInDb.sectionId,
                            studentId: studentInDb.id,
                            status: status,
                            isLate: isLate,
                            isLeave: isLeave,
                            notes: '',
                            createdAt: new Date().toISOString()
                        });
                    }
                }
                const examsData = [
                    {
                        name: 'First Monthly Exam',
                        type: 'Monthly',
                        startDate: new Date(currentYear, 3, 25).toISOString().split('T')[0],
                        endDate: new Date(currentYear, 3, 30).toISOString().split('T')[0],
                        classes: classIds,
                        passingPercent: 33,
                        details: 'First monthly exam to be held in April',
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Second Monthly Exam',
                        type: 'Monthly',
                        startDate: new Date(currentYear, 4, 25).toISOString().split('T')[0],
                        endDate: new Date(currentYear, 4, 30).toISOString().split('T')[0],
                        classes: classIds,
                        passingPercent: 33,
                        details: 'Second monthly exam to be held in May',
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Quarterly Exam',
                        type: 'Quarterly',
                        startDate: new Date(currentYear, 5, 15).toISOString().split('T')[0],
                        endDate: new Date(currentYear, 5, 25).toISOString().split('T')[0],
                        classes: classIds,
                        passingPercent: 33,
                        details: 'Quarterly exam to be held in June',
                        status: 'completed',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Half-Yearly Exam',
                        type: 'Half-Yearly',
                        startDate: new Date(currentYear, 8, 15).toISOString().split('T')[0],
                        endDate: new Date(currentYear, 8, 30).toISOString().split('T')[0],
                        classes: classIds,
                        passingPercent: 33,
                        details: 'Half-yearly exam to be held in September',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    },
                    {
                        name: 'Annual Exam',
                        type: 'Annual',
                        startDate: new Date(currentYear + 1, 2, 15).toISOString().split('T')[0],
                        endDate: new Date(currentYear + 1, 2, 31).toISOString().split('T')[0],
                        classes: classIds,
                        passingPercent: 33,
                        details: 'Annual exam to be held in March',
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    }
                ];
                const examIds = [];
                for (const examData of examsData) {
                    const id = await addToStore(STORES.EXAMS, examData);
                    examIds.push(id);
                }
                const eventsData = [
                    {
                        title: 'Prize Distribution Ceremony',
                        date: new Date(currentYear, new Date().getMonth() + 1, 15).toISOString().split('T')[0],
                        location: 'School Hall',
                        type: 'Ceremony',
                        description: 'Annual prize distribution ceremony',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'Parent-Teacher Meeting',
                        date: new Date(currentYear, new Date().getMonth() + 1, 20).toISOString().split('T')[0],
                        location: 'Classrooms',
                        type: 'Meeting',
                        description: 'Parent-Teacher meeting day',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'Seerat-un-Nabi Conference',
                        date: new Date(currentYear, 10, 12).toISOString().split('T')[0],
                        location: 'School Ground',
                        type: 'Conference',
                        description: 'Special conference on Seerat-un-Nabi (PBUH)',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'Quran Recitation Competition',
                        date: new Date(currentYear, 8, 5).toISOString().split('T')[0],
                        location: 'Mosque Hall',
                        type: 'Competition',
                        description: 'Quran recitation competition among students',
                        createdAt: new Date().toISOString()
                    },
                    {
                        title: 'Annual Jalsa',
                        date: new Date(currentYear, 2, 23).toISOString().split('T')[0],
                        location: 'School Ground',
                        type: 'Jalsa',
                        description: 'Annual gathering of the school',
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const eventData of eventsData) {
                    await addToStore(STORES.EVENTS, eventData);
                }
                const activitiesData = [
                    {
                        description: 'New student admission',
                        date: new Date(new Date().setDate(new Date().getDate() - 1)).toISOString(),
                        type: 'Admission',
                        user: currentUser ? currentUser.name : 'Unknown User',
                        userId: currentUser ? currentUser.id : null,
                        details: 'Muhammad Ali admitted to 1st Grade',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Fee collected',
                        date: new Date(new Date().setDate(new Date().getDate() - 2)).toISOString(),
                        type: 'Fee',
                        user: currentUser ? currentUser.name : 'Unknown User',
                        userId: currentUser ? currentUser.id : null,
                        details: 'Ahmad Khan paid monthly fee for May',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Book issued',
                        date: new Date(new Date().setDate(new Date().getDate() - 3)).toISOString(),
                        type: 'Library',
                        user: 'Muhammad Siddique',
                        userId: 3,
                        details: 'Student Umar issued book "Riyad as-Salihin"',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Salary paid',
                        date: new Date(new Date().setDate(new Date().getDate() - 5)).toISOString(),
                        type: 'Salary',
                        user: 'Muhammad Arif',
                        userId: 4,
                        details: 'Teachers salaries paid for May',
                        createdAt: new Date().toISOString()
                    },
                    {
                        description: 'Exam results announced',
                        date: new Date(new Date().setDate(new Date().getDate() - 7)).toISOString(),
                        type: 'Exam',
                        user: currentUser ? currentUser.name : 'Unknown User',
                        userId: currentUser ? currentUser.id : null,
                        details: 'Monthly exam results announced',
                        createdAt: new Date().toISOString()
                    }
                ];
                for (const activityData of activitiesData) {
                    await addToStore(STORES.ACTIVITIES, activityData);
                }
                await loadDropdownData();
                console.log('Sample data loaded successfully');
                showNotification('Sample data loaded successfully.', 'success');
            } catch (error) {
                console.error('Error loading sample data:', error);
                showNotification('Error loading sample data.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadSettings() {
            try {
                const settings = await getFromStore(STORES.SETTINGS, 'general');
                if (!settings) {
                    const defaultSettings = {
                        id: 'general',
                        schoolName: 'Deeni Madrasa',
                        principalName: 'Principal Name',
                        schoolAddress: 'Madrasa Road, City',
                        schoolPhone: '0300-1234567',
                        schoolEmail: 'info@deenimadrasa.com',
                        schoolWebsite: 'www.deenimadrasa.com',
                        currentSession: new Date().getFullYear() + '-' + (new Date().getFullYear() + 1),
                        sessionStart: new Date(new Date().getFullYear(), 8, 1).toISOString().split('T')[0],
                        sessionEnd: new Date(new Date().getFullYear() + 1, 4, 31).toISOString().split('T')[0],
                        schoolTimeStart: '08:00',
                        schoolTimeEnd: '14:00',
                        periodDuration: 45,
                        weeklyHoliday: ['Sunday'],
                        feeDueDay: 10,
                        feeLateFine: 50,
                        libraryReturnDays: 14,
                        libraryLateFine: 5,
                        primaryColor: '#3498db',
                        secondaryColor: '#2c3e50',
                        fontSize: 'medium',
                        fontFamily: 'Arial, sans-serif',
                        sidebarPosition: 'left',
                        sidebarTheme: 'dark',
                        language: 'en',
                        autoBackupEnabled: false,
                        autoBackupFrequency: 'monthly',
                        autoBackupRetention: 3,
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.SETTINGS, defaultSettings);
                    console.log('Default settings created');
                } else {
                    console.log('Settings loaded successfully');
                }
                applySettings();
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('Error loading settings.', 'error');
            }
        }
        async function populateAttendanceSections(classDropdownId, sectionDropdownId) {
            const classSelect = document.getElementById(classDropdownId);
            const sectionSelect = document.getElementById(sectionDropdownId);
            if (!classSelect || !sectionSelect) return;
            const classId = parseInt(classSelect.value);
            sectionSelect.innerHTML = '';
            if (classSelect.querySelector('option[value="all"]')) {
                sectionSelect.innerHTML = '<option value="all">All Sections</option>';
            } else {
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
            }
            if (isNaN(classId)) {
                return;
            }
            try {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                if (sections.length === 0) {
                    sectionSelect.innerHTML = '<option value="">No Sections Found</option>';
                } else {
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section.id;
                        option.textContent = section.name;
                        sectionSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error(`Error populating sections for dropdown ${sectionDropdownId}:`, error);
            }
        }
        async function showSalarySlip(salaryData) {
            const modal = document.getElementById('salary-slip-modal');
            const contentArea = document.getElementById('slip-content-area');
            const schoolName = appSettings.schoolName || 'Deeni Madrasa';
            const employeeStore = salaryData.employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
            const employee = await getFromStore(employeeStore, salaryData.employeeId);
            if (!employee) {
                showNotification('Could not find employee details for this slip.', 'error');
                return;
            }
            const allPaidRecordsForMonth = await getAllFromIndex(STORES.SALARY, 'employeeMonthYear', [salaryData.employeeId, salaryData.month, salaryData.year]);
            const baseSalary = employee.basicSalary || 0;
            const allowances = employee.allowances || 0;
            const grossMonthlySalary = baseSalary + allowances;
            const totalBonusPaid = allPaidRecordsForMonth.reduce((sum, rec) => sum + (rec.bonus || 0), 0);
            const totalDeductionsPaid = allPaidRecordsForMonth.reduce((sum, rec) => sum + (rec.deductions || 0), 0);
            const totalAmountPaid = allPaidRecordsForMonth.reduce((sum, rec) => sum + (rec.amountPaid || 0), 0);
            const totalPaidNet = totalAmountPaid + totalBonusPaid - totalDeductionsPaid;
            const finalRemainingBalance = grossMonthlySalary - totalPaidNet;
            contentArea.innerHTML = `
                <div class="receipt-paper" id="printable-slip" style="width: 420px; font-size: 14px;">
                    <h3>${schoolName}</h3>
                    <p style="text-align:center; font-size: 12px; margin-bottom: 10px;">Salary Slip</p>
                    <hr>
                    <div style="display: flex; justify-content: space-between;">
                        <p><strong>Voucher #:</strong> ${salaryData.voucherNumber}</p>
                        <p><strong>Date:</strong> ${formatDate(salaryData.date)}</p>
                    </div>
                    <p><strong>For Month:</strong> ${salaryData.month}, ${salaryData.year}</p>
                    <hr>
                    <p><strong>Name:</strong> ${employee.name}</p>
                    <p><strong>ID:</strong> ${employee.employeeId}</p>
                    <p><strong>Designation:</strong> ${employee.designation || employee.specialization}</p>
                    <hr>
                    <div class="receipt-item"><strong>Base Salary:</strong><span>${formatCurrency(baseSalary)}</span></div>
                    <div class="receipt-item"><strong>Allowances:</strong><span>${formatCurrency(allowances)}</span></div>
                    <div class="receipt-item receipt-total"><strong>Gross Monthly Salary:</strong><span>${formatCurrency(grossMonthlySalary)}</span></div>
                    <hr style="border-style: dotted;">
                    <p style="text-align:center; font-weight:bold; margin: 8px 0;">This Transaction</p>
                    <div class="receipt-item"><span>Amount Paid:</span><span>${formatCurrency(salaryData.amountPaid)}</span></div>
                    <div class="receipt-item"><span>Bonus:</span><span>${formatCurrency(salaryData.bonus)}</span></div>
                    <div class="receipt-item"><span>Deductions:</span><span>-${formatCurrency(salaryData.deductions)}</span></div>
                    <div class="receipt-item receipt-total"><strong>Total Paid (This Slip):</strong><span>${formatCurrency(salaryData.total)}</span></div>
                    <hr style="border-style: dotted;">
                    <p style="text-align:center; font-weight:bold; margin: 8px 0;">Month's Summary</p>
                    <div class="receipt-item"><strong>Total Paid This Month:</strong><span>${formatCurrency(totalPaidNet)}</span></div>
                    <div class="receipt-item receipt-total" style="color: #c0392b;"><strong>Remaining Balance:</strong><span>${formatCurrency(finalRemainingBalance)}</span></div>
                </div>
            `;
            document.getElementById('print-slip-btn-final').onclick = function () {
                exportElementAsPNG('printable-slip', `SalarySlip-${employee.employeeId}-${salaryData.month}.png`);
            };
            modal.style.display = 'block';
        }
        async function viewSalarySlip(salaryId) {
            const salaryRecord = await getFromStore(STORES.SALARY, salaryId);
            if (salaryRecord) {
                await showSalarySlip(salaryRecord);
            } else {
                showNotification('Could not find salary record.', 'error');
            }
        }
        async function checkLoginStatus() {
            showLoading();
            try {
                const storedUser = localStorage.getItem('loggedInUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    const loginModal = document.getElementById('login-modal');
                    if (loginModal) loginModal.remove();
                    hideLoading();
                    await initializeMainAppContent();
                    return;
                }
                createLoginModal();
                hideLoading();
                await new Promise(resolve => {
                    const loginBtn = document.getElementById('login-btn');
                    const loginPasswordInput = document.getElementById('login-password');
                    const handleLoginAttempt = async () => {
                        const username = document.getElementById('login-username').value;
                        const password = document.getElementById('login-password').value;
                        const errorDisplay = document.getElementById('login-error');
                        showLoading();
                        try {
                            const users = await getAllFromStore(STORES.USERS);
                            const user = users.find(u => u.username === username && u.password === password);
                            if (user) {
                                currentUser = user;
                                localStorage.setItem('loggedInUser', JSON.stringify(user));
                                errorDisplay.textContent = '';
                                document.getElementById('login-modal').remove();
                                showNotification('Login successful!', 'success');
                                hideLoading();
                                await initializeMainAppContent();
                                resolve();
                            } else {
                                errorDisplay.textContent = 'Invalid username or password.';
                            }
                        } catch (error) {
                            console.error('Login error:', error);
                            errorDisplay.textContent = 'An error occurred during login.';
                        } finally {
                            hideLoading();
                        }
                    };
                    if (loginBtn) loginBtn.addEventListener('click', handleLoginAttempt);
                    if (loginPasswordInput) loginPasswordInput.addEventListener('keypress', function (event) {
                        if (event.key === 'Enter') {
                            handleLoginAttempt();
                        }
                    });
                });
            } catch (e) {
                console.error('Error during login status check:', e);
                showNotification('An error occurred during startup.', 'error');
                hideLoading();
            }
        }
        function logout() {
            currentUser = null;
            localStorage.removeItem('loggedInUser');
            showNotification('Logged out successfully.', 'info');
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('menuToggle').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            checkLoginStatus();
        }
        async function applyRolePermissions() {
            if (!currentUser) {
                console.warn('No current user to apply permissions for.');
                return;
            }
            const roles = await getAllFromIndex(STORES.ROLES, 'name', currentUser.role);
            const role = roles.length > 0 ? roles[0] : null;
            if (!role || !role.permissions) {
                console.warn(`Role '${currentUser.role}' or its permissions not found. Defaulting to no permissions.`);
                document.querySelectorAll('.sidebar-menu li').forEach(item => {
                    if (!(item.onclick && item.onclick.toString().includes('logout'))) {
                        item.style.display = 'none';
                    }
                });
                return;
            }
            const menuItems = document.querySelectorAll('.sidebar-menu li');
            menuItems.forEach(item => {
                const viewName = item.getAttribute('data-view');
                const isLogout = item.onclick && item.onclick.toString().includes('logout');
                if (isLogout) {
                    item.style.display = 'block';
                    return;
                }
                if (viewName === 'users') {
                    item.style.display = 'none';
                    return;
                }
                if (viewName) {
                    if (role.permissions[viewName]) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                } else {
                    item.style.display = 'block';
                }
            });
        }
        let currentUser = null;
        async function initializeMainAppContent() {
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('menuToggle').style.display = 'flex';
            document.querySelector('.header').style.display = 'block';
            await loadDashboardData();
            await loadDropdownData();
            await checkAndLoadSampleData();
            document.getElementById("menuToggle").click()
            setupEventListeners();
            setupStudentFeeDisplay();
            try {
                document.getElementById('attendance-class').addEventListener('change', () => populateAttendanceSections('attendance-class', 'attendance-section'));
                document.getElementById('view-attendance-class').addEventListener('change', () => populateAttendanceSections('view-attendance-class', 'view-attendance-section'));
                document.getElementById('report-attendance-class').addEventListener('change', () => populateAttendanceSections('report-attendance-class', 'report-attendance-section'));
            } catch (e) {
                console.error('FAILED TO ATTACH ATTENDANCE LISTENERS:', e);
            }
            await applyRolePermissions();
            showView('dashboard');
        }
        async function initializeApp() {
            console.log('Initializing application...');
            await loadAndCacheAppSettings();
            await loadSettings();
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('menuToggle').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            await checkAndLoadSampleData();
            await checkLoginStatus();
            console.log('Application initialized successfully');
            await loadDashboardData();
            await loadDropdownData();
            setupEventListeners();
            try {
                document.getElementById('attendance-class').addEventListener('change', () => populateAttendanceSections('attendance-class', 'attendance-section'));
                document.getElementById('view-attendance-class').addEventListener('change', () => populateAttendanceSections('view-attendance-class', 'view-attendance-section'));
                document.getElementById('report-attendance-class').addEventListener('change', () => populateAttendanceSections('report-attendance-class', 'report-attendance-section'));
                console.log('Attendance dropdown listeners attached successfully.');
            } catch (e) {
                console.error('FAILED TO ATTACH ATTENDANCE LISTENERS:', e);
            }
            setupStudentFeeDisplay();
            showView('dashboard');
            await runAutomaticBackupCheck();
            console.log('Application initialized successfully');
        }
        function renderBarChart(canvasId, chartTitle, labels, dataValues) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn("Canvas not found for chart:", canvasId);
                return;
            }
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js library is not loaded. Skipping chart rendering.");
                const placeholder = document.getElementById(canvasId);
                if (placeholder) placeholder.innerHTML = '<p style="text-align:center; color: #777;"><em>Chart.js library not loaded.</em></p>';
                return;
            }
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: dataValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        function renderPieChart(canvasId, chartTitle, labels, dataValues) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn("Canvas not found for chart:", canvasId);
                return;
            }
            if (typeof Chart === 'undefined') {
                console.warn("Chart.js library is not loaded. Skipping chart rendering.");
                const placeholder = document.getElementById(canvasId);
                if (placeholder) placeholder.innerHTML = '<p style="text-align:center; color: #777;"><em>Chart.js library not loaded.</em></p>';
                return;
            }
            const backgroundColors = dataValues.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`);
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartTitle,
                        data: dataValues,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: chartTitle
                        }
                    }
                }
            });
        }
        async function populateSectionsForResults() {
            const classSelect = document.getElementById('result-class');
            const sectionSelect = document.getElementById('result-section');
            if (!sectionSelect) return;
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            const classId = parseInt(classSelect.value);
            if (isNaN(classId)) return;
            try {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                sections.forEach(section => {
                    sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                });
            } catch (error) {
                console.error('Error populating sections for results tab:', error);
            }
        }
        async function showView(viewName) {
            document.querySelectorAll('.section-view').forEach(view => {
                view.style.display = 'none';
            });
            const selectedView = document.getElementById(viewName + '-view');
            if (selectedView) {
                selectedView.style.display = 'block';
            } else {
                console.error(`View not found for: ${viewName}`);
                return;
            }
            const filterContainerIds = [
                'js-student-filters-container',
                'js-teacher-filters-container',
                'js-staff-filters-container'
            ];
            filterContainerIds.forEach(id => {
                const container = document.getElementById(id);
                let parentListOfContainer = null;
                if (container && container.parentElement) {
                    parentListOfContainer = container.parentElement.id;
                }
                if (container) {
                    let shouldRemove = true;
                    if (viewName === 'students' && parentListOfContainer === 'students-list' && id === 'js-student-filters-container') {
                        shouldRemove = false;
                    } else if (viewName === 'teachers' && parentListOfContainer === 'teachers-list' && id === 'js-teacher-filters-container') {
                        shouldRemove = false;
                    } else if (viewName === 'staff' && parentListOfContainer === 'staff-list' && id === 'js-staff-filters-container') {
                        shouldRemove = false;
                    }
                    if (shouldRemove) {
                        container.remove();
                    }
                }
            });
            if (viewName !== 'reports') {
                const reportOutputArea = document.getElementById('js-report-output-area');
                if (reportOutputArea) reportOutputArea.innerHTML = '';
                if (currentReportChart) {
                    currentReportChart.destroy();
                    currentReportChart = null;
                }
            }
            try {
                switch (viewName) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'students':
                        loadStudentsTable();
                        document.getElementById('student-class').value = document.getElementById('student-class').querySelector('option:not([value=""])')?.value || '';
                        await populateSectionsForStudentForm();
                        createCollapsibleFilterUI(
                            'students-list',
                            'js-student-filters-container',
                            'Student Filters',
                            createStudentFilterRows,
                            populateStudentFilterDropdownsJS,
                            applyStudentFiltersJS,
                            resetStudentFiltersJS,
                            [{ dropdownId: 'js-filter-student-class', handlerFn: populateStudentFilterSectionsJS }]
                        );
                        break;
                    case 'teachers':
                        loadTeachersTable();
                        createCollapsibleFilterUI(
                            'teachers-list',
                            'js-teacher-filters-container',
                            'Teacher Filters',
                            createTeacherFilterRows,
                            populateTeacherFilterDropdownsJS,
                            applyTeacherFiltersJS,
                            resetTeacherFiltersJS
                        );
                        break;
                    case 'id-cards':
                        initializeIdCardsView();
                        break;
                    case 'staff':
                        loadStaffTable();
                        createCollapsibleFilterUI(
                            'staff-list',
                            'js-staff-filters-container',
                            'Staff Filters',
                            createStaffFilterRows,
                            null,
                            applyStaffFiltersJS,
                            resetStaffFiltersJS
                        );
                        break;
                    case 'classes':
                        loadClassesTable();
                        break;
                    case 'subjects':
                        loadSubjectsTable();
                        break;
                    case 'attendance':
                        loadClassDropdowns();
                        populateAttendanceSections('attendance-class', 'attendance-section');
                        break;
                    case 'exams':
                        loadExamsTable();
                        loadClassDropdowns();
                        loadSubjectDropdowns();
                        loadExamDropdowns();
                        document.getElementById('marks-class').addEventListener('change', populateSectionsForMarksEntry);
                        document.getElementById('result-class').addEventListener('change', populateSectionsForResults);
                        break;
                    case 'fees':
                        loadFeeStructureTable();
                        loadClassDropdowns();
                        break;
                    case 'salaries':
                        loadSalaryStructureTable();
                        loadEmployeesForSalaryStructure();
                        break;
                    case 'library':
                        loadBooksTable();
                        populateLibraryDropdowns();
                        break;
                    case 'users':
                        loadUsersTable();
                        loadRolesTable();
                        break;
                    case 'reports':
                        initializeReportsViewJS();
                        break;
                    case 'settings':
                        loadSchoolSettings();
                        break;
                    case 'backup':
                        loadBackupViewSettings();
                        loadBackupHistoryTable();
                        break;
                    default:
                        console.warn(`No specific load actions defined for view: ${viewName}`);
                }
            } catch (e) {
                console.error(`Error in showView during content loading for '${viewName}':`, e);
                showNotification(`Failed to load '${viewName}' view.`, 'error');
            }
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar && sidebar.classList.contains('active')) {
                    toggleSidebar();
                }
            }
        }
        async function loadExamDropdowns() {
            try {
                const exams = await getAllFromStore(STORES.EXAMS);
                const examDropdowns = document.querySelectorAll('select[id$="-exam"], select[id^="marks-exam"], select[id^="result-exam"]');
                examDropdowns.forEach(dropdown => {
                    const currentVal = dropdown.value;
                    const fixedOptions = Array.from(dropdown.options).filter(opt => opt.value === "" || opt.dataset.fixed);
                    dropdown.innerHTML = '';
                    fixedOptions.forEach(opt => dropdown.appendChild(opt.cloneNode(true)));
                    exams.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
                    exams.forEach(exam => {
                        const option = document.createElement('option');
                        option.value = exam.id;
                        option.textContent = `${exam.name} (${formatDate(exam.startDate)})`;
                        dropdown.appendChild(option);
                    });
                    if (Array.from(dropdown.options).some(opt => opt.value === currentVal)) {
                        dropdown.value = currentVal;
                    }
                });
            } catch (error) {
                console.error('Error loading exam dropdowns:', error);
            }
        }
        async function addStudent() {
            showLoading();
            const form = document.getElementById('student-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            const statusContainer = document.getElementById('student-status-container');
            try {
                const classId = parseInt(document.getElementById('student-class').value);
                const sectionId = parseInt(document.getElementById('student-section').value);
                if (isNaN(classId) || isNaN(sectionId)) {
                    showNotification('Please select a valid Class and Section.', 'error');
                    hideLoading();
                    return;
                }
                const feeCategory = document.getElementById('student-fee-category').value;
                const feeStructure = await getFeeStructureForStudent(null, classId, feeCategory);
                const selectedClass = await getFromStore(STORES.CLASSES, classId);
                const selectedSection = await getFromStore(STORES.SECTIONS, sectionId);
                const studentData = {
                    name: document.getElementById('student-name').value,
                    fatherName: document.getElementById('student-father').value,
                    dob: document.getElementById('student-dob').value,
                    gender: document.getElementById('student-gender').value,
                    classId: classId,
                    className: selectedClass ? selectedClass.name : 'N/A',
                    sectionId: sectionId,
                    sectionName: selectedSection ? selectedSection.name : 'N/A',
                    contact: document.getElementById('student-contact').value,
                    email: document.getElementById('student-email').value,
                    guardian: document.getElementById('student-guardian').value,
                    guardianContact: document.getElementById('student-guardian-contact').value,
                    address: document.getElementById('student-address').value,
                    admissionDate: document.getElementById('student-admission-date').value,
                    feeCategory: feeCategory,
                    monthlyFee: feeStructure.monthlyFee,
                    notes: document.getElementById('student-notes').value,
                    status: editId ? document.getElementById('student-status').value : 'active'
                };
                let photo = null;
                const photoInput = document.getElementById('student-photo');
                if (photoInput.files && photoInput.files[0]) {
                    photo = await fileToBase64(photoInput.files[0]);
                    studentData.photo = photo;
                } else if (editId) {
                    const existingStudent = await getFromStore(STORES.STUDENTS, editId);
                    if (existingStudent && existingStudent.photo) {
                        studentData.photo = existingStudent.photo;
                    }
                }
                if (editId) {
                    studentData.updatedAt = new Date().toISOString();
                    await updateInStore(STORES.STUDENTS, editId, studentData);
                    showNotification('Student record updated successfully.', 'success');
                } else {
                    const studentsCount = await getCount(STORES.STUDENTS);
                    studentData.rollNumber = String(studentsCount + 1).padStart(4, '0');
                    studentData.createdAt = new Date().toISOString();
                    await addToStore(STORES.STUDENTS, studentData);
                    showNotification('Student added successfully.', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                statusContainer.style.display = 'none';
                form.querySelector('button[type="submit"]').textContent = 'Add/Update Student';
                document.querySelector('.tab[data-tab="students-list"]').click();
                await loadStudentsTable();
            } catch (error) {
                console.error('Error saving student:', error);
                showNotification('Failed to save student.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function setupStudentFeeDisplay() {
            const studentClassSelect = document.getElementById('student-class');
            const studentFeeCategorySelect = document.getElementById('student-fee-category');
            const studentMonthlyFeeInput = document.getElementById('student-monthly-fee');
            if (studentMonthlyFeeInput) {
                studentMonthlyFeeInput.readOnly = true;
            }
            async function updateStudentMonthlyFeeDisplay() {
                const classId = parseInt(studentClassSelect.value);
                const feeCategory = studentFeeCategorySelect.value;
                if (!isNaN(classId) && feeCategory) {
                    const feeStructure = await getFeeStructureForStudent(null, classId, feeCategory);
                    studentMonthlyFeeInput.value = feeStructure.monthlyFee;
                } else {
                    studentMonthlyFeeInput.value = '';
                }
            }
            if (studentClassSelect) studentClassSelect.addEventListener('change', updateStudentMonthlyFeeDisplay);
            if (studentFeeCategorySelect) studentFeeCategorySelect.addEventListener('change', updateStudentMonthlyFeeDisplay);
            if (studentMonthlyFeeInput && (studentClassSelect.value || studentFeeCategorySelect.value)) {
                updateStudentMonthlyFeeDisplay();
            }
        }
        async function editStudent(id) {
            showLoading();
            try {
                const student = await getFromStore(STORES.STUDENTS, id);
                if (!student) return;
                const form = document.getElementById('student-form');
                form.dataset.editId = id;
                document.getElementById('student-status-container').style.display = 'block';
                document.getElementById('student-status').value = student.status || 'active';
                document.getElementById('student-name').value = student.name;
                document.getElementById('student-father').value = student.fatherName;
                document.getElementById('student-dob').value = student.dob;
                document.getElementById('student-gender').value = student.gender;
                document.getElementById('student-class').value = student.classId;
                await populateSectionsForStudentForm();
                document.getElementById('student-section').value = student.sectionId;
                document.getElementById('student-contact').value = student.contact;
                document.getElementById('student-email').value = student.email;
                document.getElementById('student-guardian').value = student.guardian;
                document.getElementById('student-guardian-contact').value = student.guardianContact;
                document.getElementById('student-address').value = student.address;
                document.getElementById('student-admission-date').value = student.admissionDate;
                document.getElementById('student-fee-category').value = student.feeCategory;
                document.getElementById('student-notes').value = student.notes;
                document.querySelector('.tab[data-tab="add-student"]').click();
                form.querySelector('button[type="submit"]').textContent = 'Update Student';
            } catch (e) {
                console.error(e);
            } finally {
                hideLoading();
            }
        }
        async function handlePhotoUpload(inputId) {
            const photoInput = document.getElementById(inputId);
            if (photoInput && photoInput.files && photoInput.files[0]) {
                return await fileToBase64(photoInput.files[0]);
            }
            return null;
        }
        async function calculateLateFee() {
            const fineInput = document.getElementById('fee-fine');
            const paymentDateStr = document.getElementById('fee-payment-date').value;
            const month = parseInt(document.getElementById('fee-month').value);
            const year = parseInt(document.getElementById('fee-year').value);
            if (!fineInput || !paymentDateStr || isNaN(month) || isNaN(year)) {
                return;
            }
            const remainingBalanceForMonth = parseFloat(document.getElementById('fee-balance').value);
            if (!isNaN(remainingBalanceForMonth) && remainingBalanceForMonth <= 0) {
                fineInput.value = 0;
                calculateFeeTotal();
                return;
            }
            const dueDay = appSettings.feeDueDay || 10;
            const dueDate = new Date(year, month - 1, dueDay);
            const paymentDate = new Date(paymentDateStr);
            if (paymentDate > dueDate) {
                fineInput.value = appSettings.feeLateFine ?? 50;
            } else {
                fineInput.value = 0;
            }
            calculateFeeTotal();
        }
        async function calculateAndDisplayDueFee(student) {
            const dueFeeInput = document.getElementById('fee-due');
            dueFeeInput.value = "Calculating...";
            try {
                let totalDue = 0;
                const allPaidRecords = await getAllFromIndex(STORES.FEES, 'studentId', student.id);
                const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
                const structureMap = new Map();
                feeStructures.forEach(fs => {
                    structureMap.set(`${fs.classId}-${fs.category}`, fs.monthlyFee);
                });
                const paymentsMap = new Map();
                allPaidRecords.forEach(rec => {
                    const key = `${rec.studentId}-${rec.month}-${rec.year}`;
                    const existing = paymentsMap.get(key) || { paid: 0, historicalFee: null };
                    existing.paid += rec.amount - (rec.discount || 0);
                    if (rec.monthlyFeeAtTimeOfPayment) {
                        existing.historicalFee = rec.monthlyFeeAtTimeOfPayment;
                    }
                    paymentsMap.set(key, existing);
                });
                if (!student.admissionDate) {
                    dueFeeInput.value = "N/A (No admission date)";
                    return;
                }
                const admissionDate = new Date(student.admissionDate);
                const currentDate = new Date();
                for (let d = new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); d <= currentDate; d.setMonth(d.getMonth() + 1)) {
                    const month = d.getMonth() + 1;
                    const year = d.getFullYear();
                    const paymentKey = `${student.id}-${month}-${year}`;
                    const paymentInfo = paymentsMap.get(paymentKey);
                    let expectedFee = 0;
                    if (paymentInfo && paymentInfo.historicalFee) {
                        expectedFee = paymentInfo.historicalFee;
                    } else {
                        const feeStructureRate = structureMap.get(`${student.classId}-${student.feeCategory}`) ?? structureMap.get(`${student.classId}-General`);
                        expectedFee = feeStructureRate ?? student.monthlyFee ?? 0;
                    }
                    if (expectedFee === 0) continue;
                    const totalPaidForMonth = paymentInfo ? paymentInfo.paid : 0;
                    if (totalPaidForMonth < expectedFee) {
                        totalDue += (expectedFee - totalPaidForMonth);
                    }
                }
                dueFeeInput.value = totalDue > 0 ? formatCurrency(totalDue) : "No Dues";
            } catch (error) {
                console.error("Error calculating due fee:", error);
                dueFeeInput.value = "Error";
            }
        }
        function setupEventListeners() {
            document.getElementById('salary-slip-modal-close').addEventListener('click', () => {
                document.getElementById('salary-slip-modal').style.display = 'none';
            });
            document.getElementById('salary-month').addEventListener('change', searchEmployeeForSalary);
            document.getElementById('salary-year').addEventListener('input', searchEmployeeForSalary);
            document.getElementById('salary-employee-search').addEventListener('input', searchEmployeeForSalary);
            document.getElementById('send-reminders').addEventListener('click', async () => {
                const defaulterRows = Array.from(document.querySelectorAll('#defaulters-table tbody tr'));
                if (defaulterRows.length === 0) {
                    showNotification('No defaulters to generate reminders for.', 'info');
                    return;
                }
                const MAX_REMINDERS = 60;
                if (defaulterRows.length > MAX_REMINDERS) {
                    showNotification(`Too many reminders (${defaulterRows.length}). Please filter by class to export.`, 'error');
                    return;
                }
                showLoading();
                const printArea = document.getElementById('print-area');
                const schoolName = appSettings.schoolName || 'Deeni Madrasa';
                let combinedWhatsappMessage = `*Fee Reminder from ${schoolName}*\n\nDear Parents,\nThis is a friendly reminder that the fee for the current month is due for the following students:\n\n`;
                const generateNoticeImage = async (row) => {
                    const studentId = parseInt(row.dataset.studentId);
                    if (isNaN(studentId)) return null;
                    const student = await getFromStore(STORES.STUDENTS, studentId);
                    if (!student) return null;
                    combinedWhatsappMessage += `- ${student.name} (Roll No: ${student.rollNumber})\n`;
                    const dueAmountText = row.cells[5].textContent;
                    const dueMonthText = row.cells[4].textContent;
                    const greetingName = student.guardian || student.fatherName || 'Parent';
                    const noticeHTML = `
            <div class="receipt-paper" style="width: 400px; padding: 20px; border: 1px solid #000; background-color: white;">
                <h3 style="text-align: center; margin-bottom: 15px;">${schoolName}</h3>
                <p style="text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 20px;">Fee Reminder</p>
                <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                <p><strong>To:</strong> ${greetingName}</p>
                <p><strong>Student:</strong> ${student.name} (Roll No: ${student.rollNumber})</p>
                <hr>
                <p>This is a reminder regarding the outstanding fee for <strong>${dueMonthText}</strong>.</p>
                <p style="font-size: 1.3em; text-align: center; margin: 20px 0;">Amount Due: <strong>${dueAmountText}</strong></p>
                <hr>
                <p>Kindly clear the dues at your earliest convenience. Thank you.</p>
            </div>
        `;
                    printArea.innerHTML = noticeHTML;
                    const elementToCapture = printArea.querySelector('.receipt-paper');
                    try {
                        const canvas = await html2canvas(elementToCapture, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#ffffff'
                        });
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                        const filename = `Reminder_${student.rollNumber}_${student.name}.png`;
                        return { filename, blob };
                    } finally {
                        printArea.innerHTML = '';
                    }
                };
                try {
                    const zip = new JSZip();
                    for (const row of defaulterRows) {
                        const result = await generateNoticeImage(row);
                        if (result) {
                            zip.file(result.filename, result.blob);
                        }
                    }
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = `Fee_Reminders_${new Date().toISOString().slice(0, 10)}.zip`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    combinedWhatsappMessage += `\nThank you for your cooperation.`;
                    const modal = document.getElementById('combined-message-modal');
                    const textarea = document.getElementById('combined-message-textarea');
                    const copyBtn = document.getElementById('copy-combined-message-btn');
                    const closeBtn = document.getElementById('combined-message-modal-close');
                    textarea.value = combinedWhatsappMessage;
                    modal.style.display = 'block';
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(textarea.value).then(() => {
                            showNotification('Message copied to clipboard!', 'success');
                        });
                    };
                    closeBtn.onclick = () => {
                        modal.style.display = 'none';
                    };
                    showNotification(`${defaulterRows.length} reminders exported to ZIP.`, 'success');
                } catch (error) {
                    console.error("Error generating reminders:", error);
                    showNotification('Failed to export reminders. See console for details.', 'error');
                } finally {
                    hideLoading();
                }
            });
            document.getElementById('marks-table-container').addEventListener('input', function (e) {
                if (e.target && e.target.matches('input[name^="marks_"]')) {
                    calculateMarksRow(e.target);
                }
            });
            document.addEventListener('click', function (e) {
                const searchInput = document.getElementById('fee-student-search');
                const resultsContainer = document.getElementById('fee-search-results');
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.style.display = 'none';
                }
            });
            document.getElementById('fee-student-search').addEventListener('input', searchStudentForFee);
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                document.getElementById('student-details-modal').style.display = 'none';
            });
            document.getElementById('fee-payment-form').addEventListener('change', (e) => {
                if (['fee-month', 'fee-year', 'fee-payment-date'].includes(e.target.id)) {
                    calculateLateFee();
                }
            });
            document.getElementById('send-notice-modal-close').addEventListener('click', () => {
                document.getElementById('send-notice-modal').style.display = 'none';
            });
            document.getElementById('fee-receipt-modal-close').addEventListener('click', () => {
                document.getElementById('fee-receipt-modal').style.display = 'none';
            });
            document.getElementById('fee-month').addEventListener('change', () => {
                const studentId = document.getElementById('fee-roll-number').dataset.studentId;
                if (studentId) loadStudentForFeeCollection(parseInt(studentId));
            });
            document.getElementById('fee-year').addEventListener('input', () => {
                const studentId = document.getElementById('fee-roll-number').dataset.studentId;
                if (studentId) loadStudentForFeeCollection(parseInt(studentId));
            });
            document.querySelector('[data-tab="students-list"]').addEventListener('click', () => loadStudentsTable());
            document.querySelector('[data-tab="teachers-list"]').addEventListener('click', () => loadTeachersTable());
            document.querySelector('[data-tab="staff-list"]').addEventListener('click', () => loadStaffTable());
            document.querySelector('[data-tab="classes-list"]').addEventListener('click', () => loadClassesTable());
            document.querySelector('[data-tab="sections"]').addEventListener('click', () => loadSectionsTable());
            document.querySelector('[data-tab="subjects-list"]').addEventListener('click', () => loadSubjectsTable());
            document.querySelector('[data-tab="class-subjects"]').addEventListener('click', () => loadClassSubjectsTable());
            document.querySelector('[data-tab="exams-list"]').addEventListener('click', () => loadExamsTable());
            document.querySelector('[data-tab="user-roles"]').addEventListener('click', () => loadRolesTable());
            document.querySelector('[data-tab="fee-structure"]').addEventListener('click', () => loadFeeStructureTable());
            document.querySelector('[data-tab="salary-structure"]').addEventListener('click', () => loadSalaryStructureTable());
            document.querySelector('[data-view="library"]').addEventListener('click', () => loadBooksTable());
            document.querySelector('[data-view="users"]').addEventListener('click', () => loadUsersTable());
            document.querySelector('[data-view="backup"]').addEventListener('click', () => loadBackupHistoryTable());
            document.getElementById('search-student-btn').addEventListener('click', searchStudents);
            document.getElementById('search-teacher-btn').addEventListener('click', searchTeachers);
            document.getElementById('search-staff-btn').addEventListener('click', searchStaff);
            document.getElementById('load-attendance').addEventListener('click', loadStudentsForAttendance);
            document.getElementById('view-attendance-btn').addEventListener('click', viewAttendance);
            document.getElementById('generate-attendance-report').addEventListener('click', generateAttendanceReport);
            document.getElementById('load-students-marks').addEventListener('click', loadStudentsForMarks);
            document.getElementById('generate-result-cards').addEventListener('click', generateResultCards);
            document.getElementById('generate-fee-report').addEventListener('click', generateFeeReport);
            document.getElementById('generate-defaulters').addEventListener('click', generateDefaultersReport);
            document.getElementById('generate-salary-report').addEventListener('click', generateSalaryReport);
            document.getElementById('create-backup').addEventListener('click', createBackup);
            document.getElementById('restore-backup').addEventListener('click', restoreBackup);
            document.getElementById('save-auto-backup').addEventListener('click', saveAutoBackupSettings);
            document.getElementById('auto-backup-enable').addEventListener('change', function () {
                document.getElementById('auto-backup-options').style.display = this.checked ? 'block' : 'none';
            });
            document.getElementById('student-class').addEventListener('change', populateSectionsForStudentForm);
            document.getElementById('attendance-class').addEventListener('change', () => populateAttendanceSections('attendance-class', 'attendance-section'));
            document.getElementById('view-attendance-class').addEventListener('change', () => populateAttendanceSections('view-attendance-class', 'view-attendance-section'));
            document.getElementById('report-attendance-class').addEventListener('change', () => populateAttendanceSections('report-attendance-class', 'report-attendance-section'));
            document.getElementById('fee-report-type').addEventListener('change', toggleFeeReportFields);
            document.getElementById('salary-report-type').addEventListener('change', toggleSalaryReportFields);
            document.getElementById('structure-employee-type').addEventListener('change', loadEmployeesForSalaryStructure);
            document.getElementById('auto-backup-frequency').addEventListener('change', updateBackupOptions);
        }
        async function loadStaffTable() {
            try {
                const staffList = await getAllFromStore(STORES.STAFF);
                const tbody = document.querySelector('#staff-table tbody');
                tbody.innerHTML = '';
                if (!staffList || staffList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No staff available.</td></tr>';
                    return;
                }
                staffList.forEach(staff => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${staff.employeeId}</td>
                <td>${staff.name}</td>
                <td>${staff.designation}</td>
                <td>${staff.department}</td>
                <td>${staff.contact}</td>
                <td>${formatDate(staff.joiningDate)}</td>
                <td>${staff.basicSalary ? formatCurrency(staff.basicSalary) : 'N/A'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editStaff(${staff.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.STAFF}', ${staff.id})">Delete</button>
                </td>
            `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading staff table:', error);
            }
        }
        async function editStaff(id) {
            showLoading();
            try {
                const staff = await getFromStore(STORES.STAFF, id);
                if (!staff) { return; }
                const form = document.getElementById('staff-form');
                form.dataset.editId = id;
                document.getElementById('staff-name').value = staff.name;
                document.getElementById('staff-father').value = staff.fatherName;
                document.getElementById('staff-dob').value = staff.dob;
                document.getElementById('staff-gender').value = staff.gender;
                document.getElementById('staff-designation').value = staff.designation;
                document.getElementById('staff-department').value = staff.department;
                document.getElementById('staff-qualification').value = staff.qualification;
                document.getElementById('staff-responsibilities').value = staff.responsibilities;
                document.getElementById('staff-contact').value = staff.contact;
                document.getElementById('staff-email').value = staff.email;
                document.getElementById('staff-address').value = staff.address;
                document.getElementById('staff-cnic').value = staff.cnic;
                document.getElementById('staff-joining-date').value = staff.joiningDate;
                document.getElementById('staff-basic-salary').value = staff.basicSalary;
                document.getElementById('staff-allowances').value = staff.allowances;
                document.getElementById('staff-deductions').value = staff.deductions;
                document.getElementById('staff-notes').value = staff.notes;
                document.querySelector('.tab[data-tab="add-staff"]').click();
                form.querySelector('button[type="submit"]').textContent = 'Update Record';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadClassesTable() {
            try {
                const classes = await getAllFromStore(STORES.CLASSES);
                const tbody = document.querySelector('#classes-table tbody');
                tbody.innerHTML = '';
                if (!classes || classes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No class available.</td></tr>';
                    return;
                }
                for (const cls of classes) {
                    const row = document.createElement('tr');
                    const teacher = cls.inChargeId ? await getFromStore(STORES.TEACHERS, cls.inChargeId) : null;
                    const studentsCount = (await getAllFromIndex(STORES.STUDENTS, 'classId', cls.id)).length;
                    const sections = (await getAllFromIndex(STORES.SECTIONS, 'classId', cls.id)).map(s => s.name).join(', ');
                    row.innerHTML = `
                <td>${cls.id}</td>
                <td>${cls.name}</td>
                <td>${teacher ? teacher.name : 'N/A'}</td>
                <td>${sections || '-'}</td>
                <td>${studentsCount}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editClass(${cls.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.CLASSES}', ${cls.id})">Delete</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) { console.error('Error loading classes table:', error); }
        }
        async function editClass(id) {
            showLoading();
            try {
                const cls = await getFromStore(STORES.CLASSES, id);
                if (!cls) { return; }
                const form = document.getElementById('class-form');
                form.dataset.editId = id;
                document.getElementById('class-name').value = cls.name;
                document.getElementById('class-incharge').value = cls.inChargeId;
                document.getElementById('class-level').value = cls.level;
                document.getElementById('class-room').value = cls.roomNumber;
                document.getElementById('class-fee-category').value = cls.feeCategory;
                document.getElementById('class-monthly-fee').value = cls.monthlyFee;
                document.getElementById('class-admission-fee').value = cls.admissionFee;
                document.getElementById('class-notes').value = cls.notes;
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', id);
                const sectionNames = sections.map(s => s.name);
                Array.from(document.getElementById('class-sections').options).forEach(opt => {
                    opt.selected = sectionNames.includes(opt.value);
                });
                document.querySelector('.tab[data-tab="add-class"]').click();
                form.querySelector('button[type="submit"]').textContent = 'Update Record';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadSectionsTable() {
            try {
                const sections = await getAllFromStore(STORES.SECTIONS);
                const tbody = document.querySelector('#sections-table tbody');
                tbody.innerHTML = '';
                if (!sections || sections.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No section available.</td></tr>';
                    return;
                }
                for (const section of sections) {
                    const row = document.createElement('tr');
                    const classData = await getFromStore(STORES.CLASSES, section.classId);
                    const teacher = section.inChargeId ? await getFromStore(STORES.TEACHERS, section.inChargeId) : null;
                    const studentsCount = (await getAllFromIndex(STORES.STUDENTS, 'sectionId', section.id)).length;
                    row.innerHTML = `
                        <td>${section.id}</td>
                        <td>${classData ? classData.name : 'N/A'}</td>
                        <td>${section.name}</td>
                        <td>${teacher ? teacher.name : 'N/A'}</td>
                        <td>${studentsCount}</td>
                        <td class="no-print">
                            <button class="btn btn-primary btn-sm" onclick="editSection(${section.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.SECTIONS}', ${section.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading sections table:', error);
            }
        }
        async function loadSubjectsTable() {
            try {
                const subjects = await getAllFromStore(STORES.SUBJECTS);
                const tbody = document.querySelector('#subjects-table tbody');
                tbody.innerHTML = '';
                if (!subjects || subjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No subject available.</td></tr>';
                    return;
                }
                subjects.forEach(subject => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${subject.id}</td>
                <td>${subject.name}</td>
                <td>${subject.code}</td>
                <td>${subject.type}</td>
                <td>${subject.details || '-'}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" onclick="editSubject(${subject.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.SUBJECTS}', ${subject.id})">Delete</button>
                </td>
            `;
                    tbody.appendChild(row);
                });
            } catch (error) { console.error('Error loading subjects table:', error); }
        }
        async function editSubject(id) {
            showLoading();
            try {
                const subject = await getFromStore(STORES.SUBJECTS, id);
                if (!subject) { return; }
                const form = document.getElementById('subject-form');
                form.dataset.editId = id;
                document.getElementById('subject-name').value = subject.name;
                document.getElementById('subject-code').value = subject.code;
                document.getElementById('subject-type').value = subject.type;
                document.getElementById('subject-periods').value = subject.periods;
                document.getElementById('subject-details').value = subject.details;
                document.querySelector('.tab[data-tab="add-subject"]').click();
                form.querySelector('button[type="submit"]').textContent = 'Update Record';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadClassSubjectsTable() {
            const tbody = document.querySelector('#class-subjects-table tbody');
            tbody.innerHTML = '';
            showLoading();
            try {
                const classSubjects = await getAllFromStore(STORES.CLASS_SUBJECTS);
                if (classSubjects.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No class subject assigned.</td></tr>';
                    return;
                }
                for (const cs of classSubjects) {
                    const classData = await getFromStore(STORES.CLASSES, cs.classId);
                    const subjectData = await getFromStore(STORES.SUBJECTS, cs.subjectId);
                    const teacherData = await getFromStore(STORES.TEACHERS, cs.teacherId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${cs.id}</td>
                <td>${classData ? classData.name : 'N/A'}</td>
                <td>${subjectData ? subjectData.name : 'N/A'}</td>
                <td>${teacherData ? teacherData.name : 'N/A'}</td>
                <td><button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.CLASS_SUBJECTS}', ${cs.id})">Delete</button></td>
            `;
                    tbody.appendChild(row);
                }
            } catch (e) {
                console.error("Error loading class subjects:", e);
            } finally {
                hideLoading();
            }
        }
        async function loadExamsTable() {
            try {
                const exams = await getAllFromStore(STORES.EXAMS);
                const tbody = document.querySelector('#exams-table tbody');
                tbody.innerHTML = '';
                if (!exams || exams.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No exam available.</td></tr>';
                    return;
                }
                for (const exam of exams) {
                    const row = document.createElement('tr');
                    const classNames = exam.classes ? (await Promise.all(exam.classes.map(id => getFromStore(STORES.CLASSES, id)))).map(c => c ? c.name : '').join(', ') : 'N/A';
                    row.innerHTML = `
                <td>${exam.id}</td>
                <td>${exam.name}</td>
                <td>${formatDate(exam.startDate)}</td>
                <td>${formatDate(exam.endDate)}</td>
                <td>${classNames}</td>
                <td>${exam.status}</td>
                <td class="no-print">
                    <button class="btn btn-primary btn-sm" disabled>Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.EXAMS}', ${exam.id})">Delete</button>
                </td>
            `;
                    tbody.appendChild(row);
                }
            } catch (error) {
                console.error('Error loading exams table:', error);
            }
        }
        async function deleteItem(storeName, id) {
            if (storeName === STORES.CLASSES) {
                const studentsInClass = await getAllFromIndex(STORES.STUDENTS, 'classId', id);
                if (studentsInClass.length > 0) {
                    showNotification(`Cannot delete class. It has ${studentsInClass.length} student(s) assigned.`, 'error');
                    return;
                }
            }
            const refreshFunctions = {
                [STORES.STUDENTS]: loadStudentsTable,
                [STORES.TEACHERS]: loadTeachersTable,
                [STORES.STAFF]: loadStaffTable,
                [STORES.CLASSES]: loadClassesTable,
                [STORES.SUBJECTS]: loadSubjectsTable,
                [STORES.EXAMS]: loadExamsTable,
                [STORES.CLASS_SUBJECTS]: loadClassSubjectsTable,
                [STORES.FEE_STRUCTURE]: loadFeeStructureTable,
                [STORES.SALARY_STRUCTURE]: loadSalaryStructureTable,
                [STORES.BOOKS]: loadBooksTable,
                [STORES.BOOK_ISSUES]: loadIssuedBooksTable,
                [STORES.USERS]: loadUsersTable,
                [STORES.ROLES]: loadRolesTable,
                [STORES.BACKUP]: loadBackupHistoryTable,
            };
            if (confirm('Are you sure you want to delete this record? This action cannot be undone.')) {
                showLoading();
                try {
                    if (storeName === STORES.TEACHERS) {
                        const classes = await getAllFromStore(STORES.CLASSES);
                        for (const cls of classes) {
                            if (cls.inChargeId === id) {
                                await updateInStore(STORES.CLASSES, cls.id, { inChargeId: null });
                            }
                        }
                    }
                    await deleteFromStore(storeName, id);
                    showNotification('Record deleted successfully.', 'success');
                    if (refreshFunctions[storeName]) {
                        refreshFunctions[storeName]();
                    } else {
                        console.warn(`No refresh function is defined for the store: ${storeName}`);
                    }
                } catch (error) {
                    console.error(`Error deleting item from ${storeName}:`, error);
                    showNotification('Failed to delete record.', 'error');
                } finally {
                    hideLoading();
                }
            }
        }
        async function editBook(id) {
            showLoading();
            try {
                const book = await getFromStore(STORES.BOOKS, id);
                if (!book) return;
                const form = document.getElementById('book-form');
                form.dataset.editId = id;
                document.getElementById('book-name').value = book.name;
                document.getElementById('book-author').value = book.author;
                document.getElementById('book-category').value = book.category;
                document.getElementById('book-isbn').value = book.isbn;
                document.getElementById('book-copies').value = book.copies;
                document.getElementById('book-shelf').value = book.shelf;
                document.querySelector('.tab[data-tab="add-book"]').click();
                form.querySelector('button[type="submit"]').textContent = 'Update Record';
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }
        async function loadFeeStructureTable() {
            const tbody = document.querySelector('#fee-structure-table tbody');
            tbody.innerHTML = '';
            const structures = await getAllFromStore(STORES.FEE_STRUCTURE);
            if (!structures || structures.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No fee structure available.</td></tr>';
                return;
            }
            for (const structure of structures) {
                const classData = await getFromStore(STORES.CLASSES, structure.classId);
                const total = (structure.monthlyFee || 0) + (structure.admissionFee || 0) + (structure.examFee || 0) + (structure.computerFee || 0) + (structure.transportFee || 0) + (structure.otherFee || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${structure.id}</td>
            <td>${classData ? classData.name : 'N/A'}</td>
            <td>${structure.category}</td>
            <td>${formatCurrency(structure.monthlyFee || 0)}</td>
            <td>${formatCurrency(structure.admissionFee || 0)}</td>
            <td>${formatCurrency(structure.examFee || 0)}</td>
            <td>${formatCurrency(total)}</td>
            <td class="no-print">
                <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.FEE_STRUCTURE}', ${structure.id})">Delete</button>
            </td>
        `;
                tbody.appendChild(row);
            }
        }
        async function loadSalaryStructureTable() {
            const tbody = document.querySelector('#salary-structure-table tbody');
            tbody.innerHTML = '';
            const structures = await getAllFromStore(STORES.SALARY_STRUCTURE);
            if (!structures || structures.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No salary structure available.</td></tr>';
                return;
            }
            for (const structure of structures) {
                const employeeStore = structure.employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                const employee = await getFromStore(employeeStore, structure.employeeId);
                const total = (structure.basicSalary || 0) + (structure.houseRent || 0) + (structure.transport || 0) + (structure.medical || 0) + (structure.otherAllowances || 0) - (structure.deductions || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${structure.id}</td>
            <td>${employee ? employee.name : 'N/A'}</td>
            <td>${employee ? (employee.designation || 'Teacher') : 'N/A'}</td>
            <td>${formatCurrency(structure.basicSalary || 0)}</td>
            <td>${formatCurrency((structure.houseRent || 0) + (structure.transport || 0) + (structure.medical || 0) + (structure.otherAllowances || 0))}</td>
            <td>${formatCurrency(structure.deductions || 0)}</td>
            <td>${formatCurrency(total)}</td>
            <td class="no-print">
                 <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.SALARY_STRUCTURE}', ${structure.id})">Delete</button>
            </td>
        `;
                tbody.appendChild(row);
            }
        }
        async function loadBackupHistoryTable() {
            const tbody = document.querySelector('#backup-history-table tbody');
            tbody.innerHTML = '';
            const history = (await getAllFromStore(STORES.BACKUP)).filter(b => !b.isAutomatic);
            if (!history || history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No manual backup history available.</td></tr>';
                return;
            }
            history.sort((a, b) => new Date(b.date) - new Date(a.date));
            history.forEach((backup, index) => {
                const row = document.createElement('tr');
                const backupDate = new Date(backup.date);
                row.innerHTML = `
            <td>${index + 1}</td>
            <td>${backupDate.toLocaleDateString('en-US')}</td>
            <td>${backupDate.toLocaleTimeString('en-US')}</td>
            <td>${backup.type}</td>
            <td>${(backup.size / 1024).toFixed(2)} KB</td>
            <td class="no-print">
                <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.BACKUP}', ${backup.id})">Delete</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }
        async function downloadAutomaticBackup(backupId) {
            showLoading();
            try {
                const backupRecord = await getFromStore(STORES.BACKUP, backupId);
                if (!backupRecord || !backupRecord.blob) {
                    showNotification('Backup data not found in the database.', 'error');
                    return;
                }
                const url = URL.createObjectURL(backupRecord.blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = backupRecord.filename || `automatic-backup.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showNotification('Backup download started.', 'success');
            } catch (error) {
                console.error('Error downloading automatic backup:', error);
                showNotification('Failed to download backup.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchStudents() {
            showLoading();
            try {
                const searchTerm = document.getElementById('student-search').value.toLowerCase();
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const filteredStudents = allStudents.filter(student => {
                    return student.name.toLowerCase().includes(searchTerm) ||
                        String(student.rollNumber).includes(searchTerm) ||
                        (student.className && student.className.toLowerCase().includes(searchTerm));
                });
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = '';
                if (filteredStudents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No student found.</td></tr>';
                    return;
                }
                filteredStudents.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.rollNumber}</td>
                        <td>${student.name}</td>
                        <td>${student.fatherName}</td>
                        <td>${student.className}</td>
                        <td>${student.sectionName}</td>
                        <td>${student.contact}</td>
                        <td>${formatDate(student.admissionDate)}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="editStudent(${student.id})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteStudent(${student.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error("Error searching students:", error);
                showNotification('Failed to search students.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchStudentForFee() {
            const searchTerm = document.getElementById('fee-student-search').value.toLowerCase();
            const resultsContainer = document.getElementById('fee-search-results');
            resultsContainer.innerHTML = '';
            resultsContainer.style.display = 'none';
            if (searchTerm.length < 2) return;
            const allStudents = await getAllFromStore(STORES.STUDENTS);
            const activeStudents = allStudents.filter(s => !s.status || s.status === 'active');
            const filteredStudents = activeStudents.filter(s =>
                String(s.rollNumber).includes(searchTerm) ||
                s.name.toLowerCase().includes(searchTerm)
            ).slice(0, 10);
            if (filteredStudents.length > 0) {
                filteredStudents.forEach(student => {
                    const resultItem = document.createElement('div');
                    resultItem.textContent = `${student.name} (${student.rollNumber})`;
                    resultItem.style.cssText = "padding: 8px 12px; cursor: pointer;";
                    resultItem.onmouseover = () => resultItem.style.backgroundColor = '#f1f1f1';
                    resultItem.onmouseout = () => resultItem.style.backgroundColor = 'white';
                    resultItem.onclick = () => loadStudentForFeeCollection(student.id);
                    resultsContainer.appendChild(resultItem);
                });
                resultsContainer.style.display = 'block';
            }
        }
        async function searchTeachers() {
            showLoading();
            try {
                const searchTerm = document.getElementById('teacher-search').value.toLowerCase();
                const allTeachers = await getAllFromStore(STORES.TEACHERS);
                const filteredTeachers = allTeachers.filter(teacher => {
                    return teacher.name.toLowerCase().includes(searchTerm) ||
                        (teacher.specialization && teacher.specialization.toLowerCase().includes(searchTerm)) ||
                        (teacher.qualification && teacher.qualification.toLowerCase().includes(searchTerm));
                });
                loadTeachersTable(filteredTeachers);
            } catch (error) {
                console.error("Error searching teachers:", error);
                showNotification('Failed to search teachers.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchStaff() {
            showLoading();
            try {
                const searchTerm = document.getElementById('staff-search').value.toLowerCase();
                const allStaff = await getAllFromStore(STORES.STAFF);
                const filteredStaff = allStaff.filter(staff => {
                    return staff.name.toLowerCase().includes(searchTerm) ||
                        staff.designation.toLowerCase().includes(searchTerm) ||
                        staff.department.toLowerCase().includes(searchTerm);
                });
                loadStaffTable(filteredStaff);
            } catch (error) {
                console.error("Error searching staff:", error);
                showNotification('Failed to search staff.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function populateSectionsForMarksEntry() {
            const classSelect = document.getElementById('marks-class');
            const sectionSelect = document.getElementById('marks-section');
            const subjectSelect = document.getElementById('marks-subject');
            sectionSelect.innerHTML = '<option value="">Select Section</option>';
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            document.getElementById('marks-table-container').style.display = 'none';
            const classId = parseInt(classSelect.value);
            if (isNaN(classId)) return;
            try {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                if (sections.length > 0) {
                    sections.forEach(section => {
                        sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                    });
                } else {
                    sectionSelect.innerHTML = '<option value="">No Sections</option>';
                }
                const classSubjects = await getAllFromIndex(STORES.CLASS_SUBJECTS, 'classId', classId);
                if (classSubjects.length > 0) {
                    for (const cs of classSubjects) {
                        const subject = await getFromStore(STORES.SUBJECTS, cs.subjectId);
                        if (subject) {
                            subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
                        }
                    }
                } else {
                    subjectSelect.innerHTML = '<option value="">No Subjects Assigned</option>';
                }
            } catch (error) {
                console.error('Error populating sections/subjects for marks entry:', error);
            }
        }
        function calculateMarksRow(inputElement) {
            const row = inputElement.closest('tr');
            if (!row) return;
            const totalMarks = parseFloat(document.getElementById('marks-total').value) || 100;
            const obtainedMarks = parseFloat(inputElement.value);
            const percentageCell = row.children[3];
            const gradeCell = row.children[4];
            if (isNaN(obtainedMarks)) {
                percentageCell.textContent = '-';
                gradeCell.textContent = '-';
                return;
            }
            const percentage = (obtainedMarks / totalMarks) * 100;
            percentageCell.textContent = percentage.toFixed(2) + '%';
            let grade = 'F';
            const passingPercent = parseFloat(document.getElementById('exam-passing-percent').value) || 33;
            if (percentage >= 90) grade = 'A+';
            else if (percentage >= 80) grade = 'A';
            else if (percentage >= 70) grade = 'B';
            else if (percentage >= 60) grade = 'C';
            else if (percentage >= 50) grade = 'D';
            else if (percentage >= passingPercent) grade = 'E';
            gradeCell.textContent = grade;
        }
        async function populateSectionsForStudentForm() {
            const classId = parseInt(document.getElementById('student-class').value);
            const sectionSelect = document.getElementById('student-section');
            sectionSelect.innerHTML = '';
            if (isNaN(classId)) {
                sectionSelect.innerHTML = '<option value="">Select Section</option>';
                return;
            }
            try {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                if (sections.length === 0) {
                    sectionSelect.innerHTML = '<option value="">No sections found for this class</option>';
                } else {
                    sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section.id;
                        option.textContent = section.name;
                        sectionSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error populating sections for student form:', error);
                showNotification('Error loading sections.', 'error');
            }
        }
        async function viewAttendance() {
            const date = document.getElementById('view-attendance-date').value;
            const classId = parseInt(document.getElementById('view-attendance-class').value);
            const sectionId = parseInt(document.getElementById('view-attendance-section').value);
            const tbody = document.querySelector('#view-attendance-table tbody');
            const container = document.getElementById('view-attendance-table-container');
            if (!date || isNaN(classId) || isNaN(sectionId)) {
                showNotification('Please select date, class and section.', 'error');
                return;
            }
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            try {
                const records = await getAllFromIndex(STORES.ATTENDANCE, 'dateClassSection', [date, classId, sectionId]);
                if (records.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No attendance record found for this date.</td></tr>`;
                } else {
                    for (const record of records) {
                        const student = await getFromStore(STORES.STUDENTS, record.studentId);
                        if (student) {
                            const row = document.createElement('tr');
                            let statusText = '-';
                            if (record.status === 'present') statusText = 'Present';
                            else if (record.status === 'absent') statusText = 'Absent';
                            row.innerHTML = `
                        <td>${student.rollNumber}</td>
                        <td>${student.name}</td>
                        <td>${statusText}</td>
                        <td>${record.isLate ? 'Yes' : 'No'}</td>
                        <td>${record.isLeave ? 'Yes' : 'No'}</td>
                        <td>${record.notes || '-'}</td>
                    `;
                            tbody.appendChild(row);
                        }
                    }
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error viewing attendance:", error);
                showNotification('Failed to view attendance.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateAttendanceReport() {
            const classId = parseInt(document.getElementById('report-attendance-class').value);
            const sectionId = document.getElementById('report-attendance-section').value;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            const tbody = document.querySelector('#report-attendance-table tbody');
            const container = document.getElementById('report-attendance-table-container');
            if (isNaN(classId) || !sectionId || !startDate || !endDate) {
                showNotification('Please select all filters.', 'error');
                return;
            }
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            try {
                let students = await getAllFromIndex(STORES.STUDENTS, 'classId', classId);
                if (sectionId !== 'all') {
                    students = students.filter(s => s.sectionId === parseInt(sectionId));
                }
                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No student in this class/section.</td></tr>';
                    container.style.display = 'block';
                    return;
                }
                const allAttendance = await getAllFromStore(STORES.ATTENDANCE);
                const dateFilteredAttendance = allAttendance.filter(rec => {
                    const recDate = new Date(rec.date);
                    return recDate >= new Date(startDate) && recDate <= new Date(endDate);
                });
                for (const student of students) {
                    const studentAttendance = dateFilteredAttendance.filter(rec => rec.studentId === student.id);
                    const totalDays = studentAttendance.length;
                    const present = studentAttendance.filter(r => r.status === 'present').length;
                    const absent = studentAttendance.filter(r => r.status === 'absent').length;
                    const leave = studentAttendance.filter(r => r.isLeave).length;
                    const late = studentAttendance.filter(r => r.isLate).length;
                    const percentage = totalDays > 0 ? ((present / totalDays) * 100).toFixed(2) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${student.rollNumber}</td>
                <td>${student.name}</td>
                <td>${totalDays}</td>
                <td>${present}</td>
                <td>${absent}</td>
                <td>${late}</td>
                <td>${leave}</td>
                <td>${percentage}%</td>
            `;
                    tbody.appendChild(row);
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating attendance report:", error);
                showNotification('Failed to generate attendance report.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadStudentsForMarks() {
            const classId = parseInt(document.getElementById('marks-class').value);
            const sectionId = parseInt(document.getElementById('marks-section').value);
            if (!classId || !sectionId) {
                showNotification('Please select Class and Section.', 'error');
                return;
            }
            showLoading();
            try {
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const classStudents = allStudents.filter(s => s.classId === classId && s.sectionId === sectionId);
                const marksTbody = document.querySelector('#marks-table tbody');
                marksTbody.innerHTML = '';
                if (classStudents.length === 0) {
                    marksTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No student in this class.</td></tr>';
                }
                classStudents.forEach(student => {
                    const row = document.createElement('tr');
                    row.dataset.studentId = student.id;
                    row.innerHTML = `
                        <td>${student.rollNumber}</td>
                        <td>${student.name}</td>
                        <td><input type="number" class="form-control" name="marks_${student.id}" min="0" max="100"></td>
                        <td>-</td>
                        <td>-</td>
                        <td><input type="text" class="form-control" name="notes_${student.id}"></td>
                    `;
                    marksTbody.appendChild(row);
                });
                document.getElementById('marks-table-container').style.display = 'block';
            } catch (error) {
                console.error("Error loading students for marks entry:", error);
            } finally {
                hideLoading();
            }
        }
        async function generateResultCards() {
            const examId = parseInt(document.getElementById('result-exam').value);
            const classId = parseInt(document.getElementById('result-class').value);
            const sectionId = parseInt(document.getElementById('result-section').value);
            const container = document.getElementById('result-cards-container');
            if (isNaN(examId) || isNaN(classId) || isNaN(sectionId)) {
                showNotification('Please select Exam, Class and Section.', 'error');
                return;
            }
            showLoading();
            container.innerHTML = '';
            container.style.display = 'none';
            try {
                const students = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.classId === classId && s.sectionId === sectionId);
                const allMarks = (await getAllFromStore(STORES.MARKS)).filter(m => m.examId === examId);
                const exam = await getFromStore(STORES.EXAMS, examId);
                if (students.length === 0) {
                    container.innerHTML = `<div class="form-container"><p>No student found in this class/section.</p></div>`;
                    container.style.display = 'block';
                    hideLoading();
                    return;
                }
                for (const student of students) {
                    const studentMarks = allMarks.filter(m => m.studentId === student.id);
                    let totalObtained = 0;
                    let totalMarks = 0;
                    let resultStatus = 'Passed';
                    let marksTable = `
                <table class="table" style="font-size: 14px; margin-top: 10px;">
                    <thead><tr><th>Subject</th><th>Total Marks</th><th>Obtained</th><th>Result</th></tr></thead>
                    <tbody>
            `;
                    for (const mark of studentMarks) {
                        const subject = await getFromStore(STORES.SUBJECTS, mark.subjectId);
                        totalObtained += mark.obtainedMarks;
                        totalMarks += mark.totalMarks;
                        const passingPercent = exam.passingPercent || 33;
                        const isPassed = ((mark.obtainedMarks / mark.totalMarks) * 100) >= passingPercent;
                        if (!isPassed) resultStatus = 'Failed';
                        marksTable += `
                    <tr>
                        <td>${subject ? subject.name : 'N/A'}</td>
                        <td>${mark.totalMarks}</td>
                        <td>${mark.obtainedMarks}</td>
                        <td>${isPassed ? 'Passed' : 'Failed'}</td>
                    </tr>
                `;
                    }
                    marksTable += `</tbody></table>`;
                    const percentage = totalMarks > 0 ? ((totalObtained / totalMarks) * 100).toFixed(2) : 0;
                    const cardId = `result-card-${student.id}`;
                    const selectedvaua = document.querySelector("#result-exam").selectedOptions[0].text;
                    const cardHTML = `
                <div class="result-card-wrapper" style="position: relative; margin-bottom: 20px; page-break-inside: avoid;">
                    <button class="btn btn-info btn-sm no-print" 
                            style="position: absolute; top: 10px; right: 10px; z-index: 10;" 
                            title="Download as PNG"
                            onclick="exportElementAsPNG('${cardId}', 'ResultCard-${student.rollNumber}.png')">
                        PNG ↓
                    </button>
                    <div class="card" id="${cardId}">
                        <h4 class="card-title" style="text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px;">${selectedvaua} - Result Card</h4>
                        <div style="display: flex; justify-content: space-between;">
                            <p><strong>Name:</strong> ${student.name}</p>
                            <p><strong>Roll No.:</strong> ${student.rollNumber}</p>
                        </div>
                         <div style="display: flex; justify-content: space-between;">
                            <p><strong>Father's Name:</strong> ${student.fatherName}</p>
                            <p><strong>Class:</strong> ${student.className} (${student.sectionName})</p>
                        </div>
                        ${marksTable}
                        <div style="display: flex; justify-content: space-around; background-color: #f9f9f9; padding: 10px; border-radius: 4px; margin-top: 15px;">
                            <p><strong>Total Obtained:</strong> ${totalObtained} / ${totalMarks}</p>
                            <p><strong>Percentage:</strong> ${percentage}%</p>
                            <p><strong>Result:</strong> ${resultStatus}</p>
                        </div>
                    </div>
                </div>
            `;
                    container.innerHTML += cardHTML;
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating result cards:", error);
                showNotification('Failed to generate result cards.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadStudentForFeeCollection(studentId) {
            document.getElementById('fee-search-results').style.display = 'none';
            document.getElementById('fee-student-search').value = '';
            showLoading();
            try {
                const student = await getFromStore(STORES.STUDENTS, studentId);
                if (!student) return;
                document.getElementById('fee-roll-number').value = student.rollNumber;
                document.getElementById('fee-roll-number').dataset.studentId = student.id;
                document.getElementById('fee-student-name').value = student.name;
                document.getElementById('fee-class').value = student.className;
                document.getElementById('fee-category').value = student.feeCategory;
                const selectedMonth = parseInt(document.getElementById('fee-month').value);
                const selectedYear = parseInt(document.getElementById('fee-year').value);
                const feeStructure = await getFeeStructureForStudent(student.id, student.classId, student.feeCategory);
                const fullMonthlyFee = feeStructure?.monthlyFee || student.monthlyFee || 0;
                document.getElementById('fee-monthly').value = fullMonthlyFee;
                const allPaidRecords = await getAllFromIndex(STORES.FEES, 'studentId', student.id);
                const paymentsForMonth = allPaidRecords
                    .filter(rec => rec.month === selectedMonth && rec.year === selectedYear)
                    .reduce((sum, rec) => sum + (rec.amount - (rec.discount || 0)), 0);
                const remainingBalance = fullMonthlyFee - paymentsForMonth;
                document.getElementById('fee-balance').value = remainingBalance.toFixed(2);
                document.getElementById('fee-paying-now').value = remainingBalance > 0 ? remainingBalance.toFixed(2) : 0;
                document.getElementById('fee-student-details').style.display = 'block';
                document.getElementById('fee-payment-form').style.display = 'block';
                document.getElementById('fee-history-container').style.display = 'block';
                await calculateAndDisplayDueFee(student);
                await calculateLateFee();
                calculateFeeTotal();
                loadFeeHistory(student.id);
            } catch (error) {
                console.error("Error loading student for fee:", error);
            } finally {
                hideLoading();
            }
        }
        async function loadFeeHistory(studentId) {
            const allFees = await getAllFromIndex(STORES.FEES, 'studentId', studentId);
            const historyTbody = document.querySelector('#fee-history-table tbody');
            historyTbody.innerHTML = '';
            if (allFees.length === 0) {
                historyTbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No fee history available.</td></tr>';
                return;
            }
            allFees.sort((a, b) => new Date(b.date) - new Date(a.date));
            allFees.forEach(fee => {
                const row = document.createElement('tr');
                const monthName = new Date(fee.year, fee.month - 1, 1).toLocaleString('en-US', { month: 'long' });
                row.innerHTML = `
            <td>${fee.receiptNumber}</td>
            <td>${monthName} ${fee.year}</td>
            <td>${formatDate(fee.date)}</td>
            <td>${formatCurrency(fee.amount)}</td>
            <td>${formatCurrency(fee.fine)}</td>
            <td>${formatCurrency(fee.discount)}</td>
            <td>${formatCurrency(fee.total)}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewFeeReceipt(${fee.id})">Receipt</button>
            </td>
        `;
                historyTbody.appendChild(row);
            });
        }
        async function generateFeeReport() {
            const reportType = document.getElementById('fee-report-type').value;
            const tbody = document.querySelector('#fee-report-table tbody');
            const container = document.getElementById('fee-report-table-container');
            const summaryContainer = document.getElementById('fee-report-summary');
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            summaryContainer.style.display = 'none';
            try {
                let allFees = await getAllFromStore(STORES.FEES);
                let allStudents = await getAllFromStore(STORES.STUDENTS);
                let filteredFees = [];
                let studentsInScope = allStudents.filter(s => s.status === 'active' || !s.status);
                const month = parseInt(document.getElementById('fee-report-month').value);
                const year = parseInt(document.getElementById('fee-report-year').value);
                const date = document.getElementById('fee-report-date').value;
                const classId = parseInt(document.getElementById('fee-report-class').value);
                switch (reportType) {
                    case 'daily':
                        if (!date) { showNotification('Please select a date.', 'error'); return; }
                        filteredFees = allFees.filter(fee => fee.date === date);
                        break;
                    case 'monthly':
                        if (!month || !year) { showNotification('Please select month and year.', 'error'); return; }
                        filteredFees = allFees.filter(fee => fee.month === month && fee.year === year);
                        break;
                    case 'yearly':
                        if (!year) { showNotification('Please select a year.', 'error'); return; }
                        filteredFees = allFees.filter(fee => fee.year === year);
                        break;
                    case 'class':
                        if (!classId || !month || !year) { showNotification('Please select class, month, and year.', 'error'); return; }
                        studentsInScope = allStudents.filter(s => s.classId === classId);
                        const studentIdsInClass = studentsInScope.map(s => s.id);
                        filteredFees = allFees.filter(fee =>
                            studentIdsInClass.includes(fee.studentId) &&
                            fee.month === month &&
                            fee.year === year
                        );
                        break;
                    default:
                        showNotification('Please select a valid report type.', 'error');
                        return;
                }
                let totalCollected = 0;
                let paidStudentIds = new Set();
                for (const fee of filteredFees) {
                    const student = allStudents.find(s => s.id === fee.studentId);
                    totalCollected += fee.total;
                    paidStudentIds.add(fee.studentId);
                    const row = document.createElement('tr');
                    const monthName = new Date(fee.year, fee.month - 1, 1).toLocaleString('en-US', { month: 'long' });
                    row.innerHTML = `
                        <td>${fee.receiptNumber}</td>
                        <td>${student ? student.name : 'N/A'}</td>
                        <td>${student ? student.className : 'N/A'}</td>
                        <td>${monthName}</td>
                        <td>${formatDate(fee.date)}</td>
                        <td>${formatCurrency(fee.amount)}</td>
                        <td>${formatCurrency(fee.fine)}</td>
                        <td>${formatCurrency(fee.discount)}</td>
                        <td>${formatCurrency(fee.total)}</td>
                    `;
                    tbody.appendChild(row);
                }
                if (filteredFees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No fee records found for this criteria.</td></tr>';
                }
                document.getElementById('fee-report-total-collected').value = formatCurrency(totalCollected);
                document.getElementById('fee-report-total-students').value = studentsInScope.length;
                document.getElementById('fee-report-paid-students').value = paidStudentIds.size;
                summaryContainer.style.display = 'block';
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating fee report:", error);
                showNotification('Failed to generate fee report.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function generateDefaultersReport() {
            const classId = document.getElementById('defaulter-class').value;
            const month = parseInt(document.getElementById('defaulter-month').value);
            const year = parseInt(document.getElementById('defaulter-year').value);
            const tbody = document.querySelector('#defaulters-table tbody');
            const container = document.getElementById('defaulters-table-container');
            if (isNaN(month) || isNaN(year)) {
                showNotification('Please select a valid month and year.', 'error');
                return;
            }
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            try {
                let students = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.status === 'active' || !s.status);
                const feeRecordsForMonth = (await getAllFromStore(STORES.FEES)).filter(fr => fr.month === month && fr.year === year);
                const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
                const classes = await getAllFromStore(STORES.CLASSES);
                const classMap = new Map(classes.map(c => [c.id, c.name]));
                const structureMap = new Map();
                feeStructures.forEach(fs => {
                    structureMap.set(`${fs.classId}-${fs.category}`, fs.monthlyFee);
                });
                const paymentsMap = new Map();
                feeRecordsForMonth.forEach(rec => {
                    const currentPaid = paymentsMap.get(rec.studentId) || 0;
                    paymentsMap.set(rec.studentId, currentPaid + (rec.amount - (rec.discount || 0)));
                });
                if (classId !== 'all') {
                    students = students.filter(s => s.classId === parseInt(classId));
                }
                let hasDefaulters = false;
                const monthName = new Date(year, month - 1, 1).toLocaleString('en-US', { month: 'long' });
                const reportMonthStart = new Date(year, month - 1, 1);
                for (const student of students) {
                    if (!student.admissionDate || new Date(student.admissionDate) > reportMonthStart) {
                        continue;
                    }
                    const feeStructureRate = structureMap.get(`${student.classId}-${student.feeCategory}`) ?? structureMap.get(`${student.classId}-General`);
                    const expectedFee = feeStructureRate ?? student.monthlyFee ?? 0;
                    if (expectedFee === 0) continue;
                    const totalPaidForMonth = paymentsMap.get(student.id) || 0;
                    const dueAmount = expectedFee - totalPaidForMonth;
                    if (dueAmount > 0) {
                        hasDefaulters = true;
                        const row = document.createElement('tr');
                        row.dataset.studentId = student.id;
                        const studentClassName = classMap.get(student.classId) || 'N/A';
                        row.innerHTML = `
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>${studentClassName}</td>
                    <td>${formatCurrency(expectedFee)}</td>
                    <td>${monthName}, ${year}</td>
                    <td>${formatCurrency(dueAmount)}</td>
                    <td>${student.contact}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showSendNoticePopup(${student.id})">Single Notice</button>
                    </td>
                `;
                        tbody.appendChild(row);
                    }
                }
                if (!hasDefaulters) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No defaulters for this month.</td></tr>';
                }
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating defaulters report:", error);
                showNotification('Failed to generate defaulters report.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function searchEmployeeForSalary() {
            const searchTerm = document.getElementById('salary-employee-search').value;
            const employeeType = document.getElementById('salary-employee-type').value;
            if (!searchTerm) return;
            showLoading();
            try {
                const storeName = employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                const allEmployees = await getAllFromStore(storeName);
                const employee = allEmployees.find(e => String(e.employeeId).includes(searchTerm) || e.name.toLowerCase().includes(searchTerm.toLowerCase()));
                if (!employee) {
                    showNotification('Employee not found.', 'error');
                    document.getElementById('salary-employee-details').style.display = 'none';
                    document.getElementById('salary-payment-form').style.display = 'none';
                    document.getElementById('salary-history-container').style.display = 'none';
                    hideLoading();
                    return;
                }
                document.getElementById('salary-employee-id').value = employee.employeeId;
                document.getElementById('salary-employee-id').dataset.employeeId = employee.id;
                document.getElementById('salary-employee-name').value = employee.name;
                document.getElementById('salary-employee-designation').value = employee.designation || employee.qualification;
                const fullSalary = (employee.basicSalary || 0) + (employee.allowances || 0);
                document.getElementById('salary-basic').value = employee.basicSalary;
                document.getElementById('salary-allowances').value = employee.allowances || 0;
                document.getElementById('salary-total').value = fullSalary;
                const selectedMonth = document.getElementById('salary-month').value;
                const selectedYear = parseInt(document.getElementById('salary-year').value);
                const allPaidRecords = await getAllFromIndex(STORES.SALARY, 'employeeId', employee.id);
                const paymentsForMonth = allPaidRecords
                    .filter(rec => rec.month === selectedMonth && rec.year === selectedYear)
                    .reduce((sum, rec) => sum + rec.total, 0);
                const remainingBalance = fullSalary - paymentsForMonth;
                document.getElementById('salary-balance').value = remainingBalance.toFixed(2);
                document.getElementById('salary-paying-now').value = remainingBalance > 0 ? remainingBalance.toFixed(2) : 0;
                document.getElementById('salary-employee-details').style.display = 'block';
                document.getElementById('salary-payment-form').style.display = 'block';
                calculateSalaryTotal();
                loadSalaryHistory(employee.id, employeeType);
            } catch (error) {
                console.error("Error searching employee:", error);
                showNotification('Failed to search employee.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadSalaryHistory(employeeId, employeeType) {
            const allSalaries = await getAllFromIndex(STORES.SALARY, 'employeeId', employeeId);
            const historyTbody = document.getElementById('salary-history-table');
            if (!historyTbody) return;
            const tbody = historyTbody.querySelector('tbody');
            tbody.innerHTML = '';
            const thead = historyTbody.querySelector('thead tr');
            if (thead) {
                thead.innerHTML = `
                    <th>Voucher No.</th>
                    <th>Month</th>
                    <th>Date</th>
                    <th>Amount Paid</th>
                    <th>Bonus</th>
                    <th>Deductions</th>
                    <th>Total Paid</th>
                    <th>Action</th>
                `;
            }
            if (allSalaries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No salary history available.</td></tr>';
                return;
            }
            allSalaries.forEach(salary => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${salary.voucherNumber || '-'}</td>
                    <td>${salary.month} ${salary.year}</td>
                    <td>${formatDate(salary.date)}</td>
                    <td>${formatCurrency(salary.amountPaid)}</td>
                    <td>${formatCurrency(salary.bonus)}</td>
                    <td>${formatCurrency(salary.deductions)}</td>
                    <td>${formatCurrency(salary.total)}</td>
                    <td><button class="btn btn-sm btn-primary" onclick="viewSalarySlip(${salary.id})">Slip</button></td>
                `;
                tbody.appendChild(row);
            });
            document.getElementById('salary-history-container').style.display = 'block';
        }
        async function generateSalaryReport() {
            const reportType = document.getElementById('salary-report-type').value;
            const employeeTypeFilter = document.getElementById('salary-report-employee-type').value;
            const tbody = document.querySelector('#salary-report-table tbody');
            const container = document.getElementById('salary-report-table-container');
            const summaryContainer = document.getElementById('salary-report-summary');
            showLoading();
            tbody.innerHTML = '';
            container.style.display = 'none';
            summaryContainer.style.display = 'none';
            try {
                let allSalaries = await getAllFromStore(STORES.SALARY);
                let filteredSalaries = allSalaries;
                if (reportType === 'monthly') {
                    const month = document.getElementById('salary-report-month').value;
                    const year = parseInt(document.getElementById('salary-report-year').value);
                    if (!month || isNaN(year)) {
                        showNotification('Please select a valid month and year.', 'error');
                        hideLoading();
                        return;
                    }
                    filteredSalaries = filteredSalaries.filter(s => s.month === month && s.year === year);
                } else if (reportType === 'yearly') {
                    const year = parseInt(document.getElementById('salary-report-year').value);
                    if (isNaN(year)) {
                        showNotification('Please select a year.', 'error');
                        hideLoading();
                        return;
                    }
                    filteredSalaries = filteredSalaries.filter(s => s.year === year);
                } else if (reportType === 'employee') {
                    const employeeIdVal = document.getElementById('salary-report-employee').value;
                    if (!employeeIdVal) {
                        showNotification('Please select a specific employee.', 'error');
                        hideLoading();
                        return;
                    }
                    const [type, id] = employeeIdVal.split('_');
                    filteredSalaries = filteredSalaries.filter(s => s.employeeId === parseInt(id) && s.employeeType === type);
                }
                if (employeeTypeFilter !== 'all' && reportType !== 'employee') {
                    filteredSalaries = filteredSalaries.filter(s => s.employeeType === employeeTypeFilter);
                }
                const thead = document.querySelector('#salary-report-table thead tr');
                if (thead) {
                    thead.innerHTML = `
                        <th>Voucher No.</th>
                        <th>Employee Name</th>
                        <th>Designation</th>
                        <th>Month</th>
                        <th>Date</th>
                        <th>Amount Paid</th>
                        <th>Bonus</th>
                        <th>Deductions</th>
                        <th>Total Paid</th>
                    `;
                }
                let totalPaid = 0;
                let paidEmployees = new Set();
                for (const salary of filteredSalaries) {
                    const employeeStore = salary.employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                    const employee = await getFromStore(employeeStore, salary.employeeId);
                    totalPaid += (salary.total || 0);
                    paidEmployees.add(salary.employeeId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${salary.voucherNumber || '-'}</td>
                        <td>${salary.employeeName || 'N/A'}</td>
                        <td>${employee ? (employee.designation || employee.specialization) : 'N/A'}</td>
                        <td>${salary.month}, ${salary.year}</td>
                        <td>${formatDate(salary.date)}</td>
                        <td>${formatCurrency(salary.amountPaid)}</td>
                        <td>${formatCurrency(salary.bonus)}</td>
                        <td>${formatCurrency(salary.deductions)}</td>
                        <td>${formatCurrency(salary.total)}</td>
                    `;
                    tbody.appendChild(row);
                }
                if (filteredSalaries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No salary record found for this criteria.</td></tr>';
                }
                const allTeachersCount = await getCount(STORES.TEACHERS);
                const allStaffCount = await getCount(STORES.STAFF);
                let totalEmployeesInScope = allTeachersCount + allStaffCount;
                if (employeeTypeFilter === 'teacher') totalEmployeesInScope = allTeachersCount;
                if (employeeTypeFilter === 'staff') totalEmployeesInScope = allStaffCount;
                document.getElementById('salary-report-total-paid').value = formatCurrency(totalPaid);
                document.getElementById('salary-report-total-employees').value = totalEmployeesInScope;
                document.getElementById('salary-report-paid-employees').value = paidEmployees.size;
                summaryContainer.style.display = 'block';
                container.style.display = 'block';
            } catch (error) {
                console.error("Error generating salary report:", error);
                showNotification('Failed to generate salary report.', 'error');
            } finally {
                hideLoading();
            }
        }
        function toggleFeeReportFields() {
            const reportType = document.getElementById('fee-report-type').value;
            document.getElementById('fee-report-date-row').style.display = 'none';
            document.getElementById('fee-report-month-row').style.display = 'none';
            document.getElementById('fee-report-class-row').style.display = 'none';
            switch (reportType) {
                case 'daily':
                    document.getElementById('fee-report-date-row').style.display = 'flex';
                    break;
                case 'monthly':
                case 'yearly':
                    document.getElementById('fee-report-month-row').style.display = 'flex';
                    if (reportType === 'yearly') {
                        document.getElementById('fee-report-month').value = '';
                    }
                    break;
                case 'class':
                    document.getElementById('fee-report-class-row').style.display = 'flex';
                    document.getElementById('fee-report-month-row').style.display = 'flex';
                    break;
            }
        }
        function toggleSalaryReportFields() {
            const reportType = document.getElementById('salary-report-type').value;
            const employeeTypeSelect = document.getElementById('salary-report-employee-type');
            document.getElementById('salary-report-month-row').style.display = 'none';
            document.getElementById('salary-report-employee-row').style.display = 'none';
            employeeTypeSelect.style.display = 'block';
            switch (reportType) {
                case 'monthly':
                case 'yearly':
                    document.getElementById('salary-report-month-row').style.display = 'flex';
                    if (reportType === 'yearly') {
                        document.getElementById('salary-report-month').value = '';
                    }
                    break;
                case 'employee':
                    document.getElementById('salary-report-employee-row').style.display = 'flex';
                    loadEmployeesForSalaryReport();
                    break;
            }
        }
        async function loadEmployeesForSalaryReport() {
            try {
                const employeeType = document.getElementById('salary-report-employee-type').value;
                const dropdown = document.getElementById('salary-report-employee');
                dropdown.innerHTML = '<option value="">-- Select Employee --</option>';
                let employees = [];
                if (employeeType === 'all') {
                    const teachers = await getAllFromStore(STORES.TEACHERS);
                    const staff = await getAllFromStore(STORES.STAFF);
                    employees = [...teachers.map(t => ({ ...t, type: 'teacher' })), ...staff.map(s => ({ ...s, type: 'staff' }))];
                } else if (employeeType === 'teacher') {
                    employees = (await getAllFromStore(STORES.TEACHERS)).map(t => ({ ...t, type: 'teacher' }));
                } else {
                    employees = (await getAllFromStore(STORES.STAFF)).map(s => ({ ...s, type: 'staff' }));
                }
                employees.sort((a, b) => a.name.localeCompare(b.name));
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = `${employee.type}_${employee.id}`;
                    option.textContent = `${employee.name} (${employee.employeeType || employee.type})`;
                    dropdown.appendChild(option);
                });
                console.log('Employees loaded for salary report');
            } catch (error) {
                console.error('Error loading employees for salary report:', error);
                showNotification('Error loading employees for salary report.', 'error');
            }
        }
        async function loadEmployeesForSalaryStructure() {
            try {
                const employeeType = document.getElementById('structure-employee-type').value;
                const dropdown = document.getElementById('structure-employee');
                dropdown.innerHTML = '';
                let employees;
                if (employeeType === 'teacher') {
                    employees = await getAllFromStore(STORES.TEACHERS);
                } else {
                    employees = await getAllFromStore(STORES.STAFF);
                }
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = employee.name;
                    dropdown.appendChild(option);
                });
                console.log(`Loaded ${employees.length} employees for salary structure`);
            } catch (error) {
                console.error('Error loading employees for salary structure:', error);
                showNotification('Error loading employees for salary structure.', 'error');
            }
        }
        async function addStaff() {
            showLoading();
            const form = document.getElementById('staff-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                let photo = null;
                const photoInput = document.getElementById('staff-photo');
                if (photoInput.files && photoInput.files[0]) {
                    photo = await fileToBase64(photoInput.files[0]);
                }
                const staffData = {
                    name: document.getElementById('staff-name').value,
                    fatherName: document.getElementById('staff-father').value,
                    dob: document.getElementById('staff-dob').value,
                    gender: document.getElementById('staff-gender').value,
                    designation: document.getElementById('staff-designation').value,
                    department: document.getElementById('staff-department').value,
                    qualification: document.getElementById('staff-qualification').value,
                    responsibilities: document.getElementById('staff-responsibilities').value,
                    contact: document.getElementById('staff-contact').value,
                    email: document.getElementById('staff-email').value,
                    address: document.getElementById('staff-address').value,
                    cnic: document.getElementById('staff-cnic').value,
                    joiningDate: document.getElementById('staff-joining-date').value,
                    basicSalary: parseFloat(document.getElementById('staff-basic-salary').value),
                    allowances: parseFloat(document.getElementById('staff-allowances').value) || 0,
                    deductions: parseFloat(document.getElementById('staff-deductions').value) || 0,
                    notes: document.getElementById('staff-notes').value,
                };
                if (editId) {
                    const existingStaff = await getFromStore(STORES.STAFF, editId);
                    if (existingStaff) {
                        if (photo) {
                            staffData.photo = photo;
                        } else if (existingStaff.photo) {
                            staffData.photo = existingStaff.photo;
                        }
                        staffData.updatedAt = new Date().toISOString();
                        await updateInStore(STORES.STAFF, editId, staffData);
                        showNotification('Staff record updated successfully.', 'success');
                    } else {
                        showNotification('Staff record not found for update.', 'error');
                    }
                } else {
                    const staffCount = await getCount(STORES.STAFF);
                    staffData.employeeId = 'S' + String(staffCount + 1).padStart(3, '0');
                    staffData.photo = photo;
                    staffData.createdAt = new Date().toISOString();
                    await addToStore(STORES.STAFF, staffData);
                    showNotification('Staff added successfully.', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'Add Staff';
                document.querySelector('.tab[data-tab="staff-list"]').click();
                await loadStaffTable();
            } catch (error) {
                console.error('Error saving staff:', error);
                showNotification('Failed to save staff.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addTeacher() {
            showLoading();
            const form = document.getElementById('teacher-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                let photo = null;
                const photoInput = document.getElementById('teacher-photo');
                if (photoInput.files && photoInput.files[0]) {
                    photo = await fileToBase64(photoInput.files[0]);
                }
                const teacherData = {
                    name: document.getElementById('teacher-name').value,
                    fatherName: document.getElementById('teacher-father').value,
                    gender: document.getElementById('teacher-gender').value,
                    dob: document.getElementById('teacher-dob').value,
                    qualification: document.getElementById('teacher-qualification').value,
                    specialization: document.getElementById('teacher-specialization').value,
                    subjects: Array.from(document.getElementById('teacher-subject').selectedOptions).map(option => option.value),
                    classes: Array.from(document.getElementById('teacher-class').selectedOptions).map(option => option.value),
                    contact: document.getElementById('teacher-contact').value,
                    email: document.getElementById('teacher-email').value,
                    address: document.getElementById('teacher-address').value,
                    cnic: document.getElementById('teacher-cnic').value,
                    joiningDate: document.getElementById('teacher-joining-date').value,
                    basicSalary: parseFloat(document.getElementById('teacher-basic-salary').value),
                    allowances: parseFloat(document.getElementById('teacher-allowances').value) || 0,
                    deductions: parseFloat(document.getElementById('teacher-deductions').value) || 0,
                    notes: document.getElementById('teacher-notes').value,
                };
                if (photo) {
                    teacherData.photo = photo;
                }
                if (editId) {
                    teacherData.updatedAt = new Date().toISOString();
                    await updateInStore(STORES.TEACHERS, editId, teacherData);
                    showNotification('Teacher record updated successfully.', 'success');
                } else {
                    const teachersCount = await getCount(STORES.TEACHERS);
                    teacherData.employeeId = 'T' + String(teachersCount + 1).padStart(3, '0');
                    teacherData.createdAt = new Date().toISOString();
                    await addToStore(STORES.TEACHERS, teacherData);
                    showNotification('Teacher added successfully.', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'Add/Update Teacher';
                document.querySelector('.tab[data-tab="teachers-list"]').click();
                await loadTeachersTable();
                await loadTeacherDropdowns();
            } catch (error) {
                console.error('Error saving teacher:', error);
                showNotification('Failed to save teacher.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addClass() {
            showLoading();
            const form = document.getElementById('class-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const classData = {
                    name: document.getElementById('class-name').value,
                    inChargeId: parseInt(document.getElementById('class-incharge').value),
                    level: document.getElementById('class-level').value,
                    roomNumber: document.getElementById('class-room').value,
                    feeCategory: document.getElementById('class-fee-category').value,
                    monthlyFee: parseFloat(document.getElementById('class-monthly-fee').value),
                    admissionFee: parseFloat(document.getElementById('class-admission-fee').value),
                    notes: document.getElementById('class-notes').value,
                };
                if (editId) {
                    await updateInStore(STORES.CLASSES, editId, classData);
                    showNotification('Class record updated successfully.', 'success');
                } else {
                    const newClassId = await addToStore(STORES.CLASSES, classData);
                    const sections = Array.from(document.getElementById('class-sections').selectedOptions).map(opt => opt.value);
                    for (const sectionName of sections) {
                        await addToStore(STORES.SECTIONS, { classId: newClassId, name: sectionName, inChargeId: null });
                    }
                    showNotification('Class created successfully.', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'Add Class';
                document.querySelector('.tab[data-tab="classes-list"]').click();
                loadDropdownData();
            } catch (error) { console.error('Error saving class:', error); showNotification('Failed to save class.', 'error'); } finally { hideLoading(); }
        }
        async function addSubject() {
            showLoading();
            const form = document.getElementById('subject-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const subjectData = {
                    name: document.getElementById('subject-name').value,
                    code: document.getElementById('subject-code').value,
                    type: document.getElementById('subject-type').value,
                    periods: parseInt(document.getElementById('subject-periods').value),
                    details: document.getElementById('subject-details').value,
                };
                if (editId) {
                    await updateInStore(STORES.SUBJECTS, editId, subjectData);
                    showNotification('Subject record updated successfully.', 'success');
                } else {
                    await addToStore(STORES.SUBJECTS, subjectData);
                    showNotification('Subject created successfully.', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'Add Subject';
                document.querySelector('.tab[data-tab="subjects-list"]').click();
                loadDropdownData();
            } catch (error) { console.error('Error saving subject:', error); showNotification('Failed to save subject.', 'error'); } finally { hideLoading(); }
        }
        async function saveClassSubject() {
            try {
                showLoading();
                const classId = document.getElementById('class-subject-class').value;
                const subjectId = document.getElementById('class-subject-subject').value;
                const teacherId = document.getElementById('class-subject-teacher').value;
                if (!classId || !subjectId || !teacherId) {
                    showNotification('Please fill in all fields.', 'error');
                    return;
                }
                const classData = await getFromStore(STORES.CLASSES, parseInt(classId));
                const subjectData = await getFromStore(STORES.SUBJECTS, parseInt(subjectId));
                const teacherData = await getFromStore(STORES.TEACHERS, parseInt(teacherId));
                const existingClassSubjects = await getAllFromStore(STORES.CLASS_SUBJECTS);
                const existingRecord = existingClassSubjects.find(record =>
                    record.classId === parseInt(classId) && record.subjectId === parseInt(subjectId)
                );
                if (existingRecord) {
                    await updateInStore(STORES.CLASS_SUBJECTS, existingRecord.id, {
                        teacherId: parseInt(teacherId),
                        teacherName: teacherData ? teacherData.name : '',
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('Class Subject updated successfully.', 'success');
                } else {
                    const classSubjectData = {
                        classId: parseInt(classId),
                        className: classData ? classData.name : '',
                        subjectId: parseInt(subjectId),
                        subjectName: subjectData ? subjectData.name : '',
                        teacherId: parseInt(teacherId),
                        teacherName: teacherData ? teacherData.name : '',
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.CLASS_SUBJECTS, classSubjectData);
                    showNotification('Class Subject saved successfully.', 'success');
                }
                loadClassSubjectsTable();
            } catch (error) {
                console.error('Error saving class subject:', error);
                showNotification('Failed to save class subject.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveSection() {
            try {
                showLoading();
                const saveButton = document.getElementById('save-section');
                const editId = saveButton.dataset.editId ? parseInt(saveButton.dataset.editId) : null;

                const classId = document.getElementById('section-class').value;
                const sectionName = document.getElementById('section-name').value;
                const inChargeId = document.getElementById('section-incharge').value;

                if (!classId || !sectionName || !inChargeId) {
                    showNotification('Please fill in all fields.', 'error');
                    hideLoading();
                    return;
                }

                const sectionData = {
                    classId: parseInt(classId),
                    name: sectionName,
                    inChargeId: parseInt(inChargeId),
                };

                if (editId) {
                    // This is an UPDATE
                    await updateInStore(STORES.SECTIONS, editId, sectionData);
                    showNotification('Section updated successfully.', 'success');
                } else {
                    // This is a NEW entry
                    await addToStore(STORES.SECTIONS, sectionData);
                    showNotification('Section saved successfully.', 'success');
                }

                // Clear the ID and reset the form
                delete saveButton.dataset.editId;
                document.getElementById('section-class').value = '';
                document.getElementById('section-name').value = 'A';
                document.getElementById('section-incharge').value = '';

                loadSectionsTable();
            } catch (error) {
                console.error('Error saving section:', error);
                showNotification('Failed to save section.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function exportAllCardsAsZIP() {
            if (!window.html2canvas || !window.JSZip) {
                showNotification('Export libraries not loaded.', 'error');
                return;
            }
            showLoading();
            try {
                const resultCardsContainer = document.getElementById('result-cards-container');
                const cardWrappers = resultCardsContainer.querySelectorAll('.result-card-wrapper');
                if (cardWrappers.length === 0) {
                    showNotification('No result cards to export.', 'info');
                    hideLoading();
                    return;
                }
                const zip = new JSZip();
                const promises = [];
                for (const wrapper of cardWrappers) {
                    const cardElement = wrapper.querySelector('.card');
                    const studentId = parseInt(cardElement.id.replace('result-card-', ''));
                    const student = await getFromStore(STORES.STUDENTS, studentId);
                    const fileName = `ResultCard_${student ? student.rollNumber + '_' + student.name.replace(/\s/g, '_') : studentId}.png`;
                    promises.push(
                        html2canvas(cardElement, { scale: 3, useCORS: true, backgroundColor: '#ffffff' })
                            .then(canvas => new Promise(resolve => canvas.toBlob(resolve, 'image/png')))
                            .then(blob => zip.file(fileName, blob))
                    );
                }
                await Promise.all(promises);
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `All_Result_Cards_${new Date().toISOString().slice(0, 10)}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                showNotification('All result cards exported to ZIP successfully.', 'success');
            } catch (error) {
                console.error("Error exporting all result cards to ZIP:", error);
                showNotification('Failed to export all result cards to ZIP.', 'error');
            } finally {
                hideLoading();
            }
        }
        document.getElementById('export-all-result-cards').addEventListener('click', exportAllCardsAsZIP);
        async function saveAttendance() {
            try {
                showLoading();
                const date = document.getElementById('attendance-date').value;
                const classId = parseInt(document.getElementById('attendance-class').value);
                const sectionId = parseInt(document.getElementById('attendance-section').value);
                const table = document.getElementById('attendance-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                const attendanceData = [];
                for (const row of rows) {
                    const studentId = parseInt(row.getAttribute('data-student-id'));
                    const statusRadios = row.querySelectorAll('input[name="status_' + studentId + '"]');
                    let status = '';
                    for (const radio of statusRadios) {
                        if (radio.checked) {
                            status = radio.value;
                            break;
                        }
                    }
                    const isLate = row.querySelector('input[name="late_' + studentId + '"]').checked;
                    const isLeave = row.querySelector('input[name="leave_' + studentId + '"]').checked;
                    const notes = row.querySelector('input[name="notes_' + studentId + '"]').value;
                    attendanceData.push({
                        date: date,
                        classId: classId,
                        sectionId: sectionId,
                        studentId: studentId,
                        status: status,
                        isLate: isLate,
                        isLeave: isLeave,
                        notes: notes,
                        createdAt: new Date().toISOString()
                    });
                }
                const existingAttendance = await getAllFromIndex(STORES.ATTENDANCE, 'dateClassSection', [date, classId, sectionId]);
                if (existingAttendance && existingAttendance.length > 0) {
                    for (const record of existingAttendance) {
                        await deleteFromStore(STORES.ATTENDANCE, record.id);
                    }
                }
                for (const record of attendanceData) {
                    await addToStore(STORES.ATTENDANCE, record);
                }
                await addToStore(STORES.ACTIVITIES, {
                    description: 'Attendance saved',
                    date: new Date().toISOString(),
                    type: 'Attendance',
                    user: currentUser ? currentUser.name : 'Unknown User',
                    userId: currentUser ? currentUser.id : null,
                    details: `Attendance for Class and Section on ${date} saved`,
                    createdAt: new Date().toISOString()
                });
                showNotification('Attendance saved successfully.', 'success');
                document.getElementById('attendance-table-container').style.display = 'none';
                document.querySelector('.tab[data-tab="view-attendance"]').click();
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('Failed to save attendance.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addExam() {
            try {
                showLoading();
                const name = document.getElementById('exam-name').value;
                const type = document.getElementById('exam-type').value;
                const startDate = document.getElementById('exam-start-date').value;
                const endDate = document.getElementById('exam-end-date').value;
                const classes = Array.from(document.getElementById('exam-classes').selectedOptions).map(option => parseInt(option.value));
                const passingPercent = document.getElementById('exam-passing-percent').value;
                const details = document.getElementById('exam-details').value;
                const examData = {
                    name: name,
                    type: type,
                    startDate: startDate,
                    endDate: endDate,
                    classes: classes,
                    passingPercent: parseInt(passingPercent),
                    details: details,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                const examId = await addToStore(STORES.EXAMS, examData);
                await addToStore(STORES.ACTIVITIES, {
                    description: 'New exam created',
                    date: new Date().toISOString(),
                    type: 'Exam',
                    user: currentUser ? currentUser.name : 'Unknown User',
                    userId: currentUser ? currentUser.id : null,
                    details: `${name} exam created, will be held from ${startDate} to ${endDate}`,
                    createdAt: new Date().toISOString()
                });
                await addToStore(STORES.EVENTS, {
                    title: `${name} - ${type}`,
                    date: startDate,
                    location: 'School',
                    type: 'Exam',
                    description: `${name} exam will start`,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('exam-form').reset();
                loadExamsTable();
                showNotification('Exam created successfully.', 'success');
                document.querySelector('.tab[data-tab="exams-list"]').click();
            } catch (error) {
                console.error('Error adding exam:', error);
                showNotification('Failed to create exam.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveMarks() {
            try {
                showLoading();
                const examId = parseInt(document.getElementById('marks-exam').value);
                const classId = parseInt(document.getElementById('marks-class').value);
                const sectionId = parseInt(document.getElementById('marks-section').value);
                const subjectId = parseInt(document.getElementById('marks-subject').value);
                const totalMarks = parseInt(document.getElementById('marks-total').value);
                const table = document.getElementById('marks-table');
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                const marksData = [];
                for (const row of rows) {
                    const studentId = parseInt(row.getAttribute('data-student-id'));
                    const obtainedMarks = parseFloat(row.querySelector('input[name="marks_' + studentId + '"]').value);
                    const percentage = (obtainedMarks / totalMarks) * 100;
                    let grade = '';
                    if (percentage >= 90) grade = 'A+';
                    else if (percentage >= 80) grade = 'A';
                    else if (percentage >= 70) grade = 'B';
                    else if (percentage >= 60) grade = 'C';
                    else if (percentage >= 50) grade = 'D';
                    else if (percentage >= 33) grade = 'E';
                    else grade = 'F';
                    const notes = row.querySelector('input[name="notes_' + studentId + '"]').value;
                    marksData.push({
                        examId: examId,
                        classId: classId,
                        sectionId: sectionId,
                        subjectId: subjectId,
                        studentId: studentId,
                        totalMarks: totalMarks,
                        obtainedMarks: obtainedMarks,
                        percentage: percentage,
                        grade: grade,
                        isPassed: percentage >= 33,
                        notes: notes,
                        createdAt: new Date().toISOString()
                    });
                }
                for (const markRecord of marksData) {
                    const existingMarks = await getAllFromIndex(STORES.MARKS, 'examStudentSubject', [markRecord.examId, markRecord.studentId, markRecord.subjectId]);
                    if (existingMarks && existingMarks.length > 0) {
                        markRecord.id = existingMarks[0].id;
                        await updateInStore(STORES.MARKS, markRecord.id, markRecord);
                    } else {
                        await addToStore(STORES.MARKS, markRecord);
                    }
                }
                await addToStore(STORES.ACTIVITIES, {
                    description: 'Marks saved',
                    date: new Date().toISOString(),
                    type: 'Exam',
                    user: currentUser ? currentUser.name : 'Unknown User',
                    userId: currentUser ? currentUser.id : null,
                    details: `Exam marks saved`,
                    createdAt: new Date().toISOString()
                });
                showNotification('Marks saved successfully.', 'success');
                document.getElementById('marks-table-container').style.display = 'none';
                document.querySelector('.tab[data-tab="result-cards"]').click();
            } catch (error) {
                console.error('Error saving marks:', error);
                showNotification('Failed to save marks.', 'error');
            } finally {
                hideLoading();
            }
        }
        // Find and completely REPLACE this function
        async function collectFee() {
            try {
                showLoading();
                const studentId = parseInt(document.getElementById('fee-roll-number').getAttribute('data-student-id'));
                const student = await getFromStore(STORES.STUDENTS, studentId);
                const feeStructure = await getFeeStructureForStudent(student.id, student.classId, student.feeCategory);
                const monthlyFeeNow = feeStructure?.monthlyFee || student.monthlyFee || 0;
                const monthNumber = parseInt(document.getElementById('fee-month').value);
                const year = parseInt(document.getElementById('fee-year').value);

                // This is the total money the user is giving you.
                const amountReceived = parseFloat(document.getElementById('fee-paying-now').value);

                const fine = parseFloat(document.getElementById('fee-fine').value) || 0;
                const discount = parseFloat(document.getElementById('fee-discount').value) || 0;

                // ** THIS IS THE FIX **
                // We create the data object for saving.
                const feeData = {
                    receiptNumber: 'FEE' + Date.now().toString().slice(-6),
                    studentId: studentId,
                    studentName: student.name,
                    month: monthNumber,
                    year: year,
                    // 'amount' is the portion that covers the actual fee.
                    // It's calculated by taking the total received and removing the fine/adding back the discount.
                    amount: amountReceived - fine + discount,
                    fine: fine,
                    discount: discount,
                    // 'total' is the actual cash transaction amount.
                    total: amountReceived,
                    monthlyFeeAtTimeOfPayment: monthlyFeeNow,
                    date: document.getElementById('fee-payment-date').value,
                    paymentMethod: document.getElementById('fee-payment-method').value,
                    notes: document.getElementById('fee-notes').value,
                };

                if (feeData.total <= 0) {
                    showNotification('Total collected amount must be greater than zero.', 'error');
                    hideLoading();
                    return;
                }

                await addToStore(STORES.FEES, feeData);
                showNotification('Fee collected successfully.', 'success');
                await showFeeReceipt(feeData, student);
                loadStudentForFeeCollection(studentId);
            } catch (error) {
                console.error('Error collecting fee:', error);
                showNotification('Failed to collect fee.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveFeeStructure() {
            try {
                showLoading();
                const classId = parseInt(document.getElementById('fee-structure-class').value);
                const category = document.getElementById('fee-structure-category').value;
                const monthlyFee = parseFloat(document.getElementById('fee-structure-monthly').value);
                const admissionFee = parseFloat(document.getElementById('fee-structure-admission').value);
                const examFee = parseFloat(document.getElementById('fee-structure-exam').value);
                const computerFee = parseFloat(document.getElementById('fee-structure-computer').value) || 0;
                const transportFee = parseFloat(document.getElementById('fee-structure-transport').value) || 0;
                const otherFee = parseFloat(document.getElementById('fee-structure-other').value) || 0;
                const details = document.getElementById('fee-structure-details').value;
                const existingStructure = await getAllFromIndex(STORES.FEE_STRUCTURE, 'classCategory', [classId, category]);
                if (existingStructure && existingStructure.length > 0) {
                    await updateInStore(STORES.FEE_STRUCTURE, existingStructure[0].id, {
                        monthlyFee: monthlyFee,
                        admissionFee: admissionFee,
                        examFee: examFee,
                        computerFee: computerFee,
                        transportFee: transportFee,
                        otherFee: otherFee,
                        details: details,
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('Fee structure updated successfully.', 'success');
                } else {
                    const feeStructureData = {
                        classId: classId,
                        category: category,
                        monthlyFee: monthlyFee,
                        admissionFee: admissionFee,
                        examFee: examFee,
                        computerFee: computerFee,
                        transportFee: transportFee,
                        otherFee: otherFee,
                        details: details,
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.FEE_STRUCTURE, feeStructureData);
                    showNotification('Fee structure saved successfully.', 'success');
                }
                loadFeeStructureTable();
            } catch (error) {
                console.error('Error saving fee structure:', error);
                showNotification('Failed to save fee structure.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function paySalary() {
            try {
                showLoading();
                const employeeType = document.getElementById('salary-employee-type').value;
                const employeeId = parseInt(document.getElementById('salary-employee-id').getAttribute('data-employee-id'));
                const employeeName = document.getElementById('salary-employee-name').value;
                const month = document.getElementById('salary-month').value;
                const year = parseInt(document.getElementById('salary-year').value);
                // Add these two lines just before the `salaryData` object
                const storeName = employeeType === 'teacher' ? STORES.TEACHERS : STORES.STAFF;
                const employee = await getFromStore(storeName, employeeId);
                const grossSalaryNow = (employee.basicSalary || 0) + (employee.allowances || 0);

                const salaryData = {
                    voucherNumber: 'SAL' + Date.now().toString().slice(-6),
                    employeeId: employeeId,
                    employeeType: employeeType,
                    employeeName: employeeName,
                    month: month,
                    year: year,
                    amountPaid: parseFloat(document.getElementById('salary-paying-now').value),
                    bonus: parseFloat(document.getElementById('salary-payment-bonus').value) || 0,
                    deductions: parseFloat(document.getElementById('salary-payment-deductions').value) || 0,
                    total: parseFloat(document.getElementById('salary-payment-total').value),
                    grossSalaryAtTimeOfPayment: grossSalaryNow, // <-- ADD THIS LINE
                    date: document.getElementById('salary-payment-date').value,
                    paymentMethod: document.getElementById('salary-payment-method').value,
                    transactionId: document.getElementById('salary-payment-transaction').value,
                    notes: document.getElementById('salary-payment-notes').value,
                };
                if (salaryData.amountPaid <= 0 && salaryData.bonus <= 0 && salaryData.deductions <= 0) {
                    showNotification('Total paid amount must be greater than zero.', 'error');
                    hideLoading();
                    return;
                }
                await addToStore(STORES.SALARY, salaryData);
                showNotification('Salary paid successfully.', 'success');
                await showSalarySlip(salaryData);
                searchEmployeeForSalary();
            } catch (error) {
                console.error('Error paying salary:', error);
                showNotification('Failed to pay salary.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveSalaryStructure() {
            try {
                showLoading();
                const employeeType = document.getElementById('structure-employee-type').value;
                const employeeId = parseInt(document.getElementById('structure-employee').value);
                const basicSalary = parseFloat(document.getElementById('structure-basic-salary').value);
                const houseRent = parseFloat(document.getElementById('structure-house-rent').value) || 0;
                const transport = parseFloat(document.getElementById('structure-transport').value) || 0;
                const medical = parseFloat(document.getElementById('structure-medical').value) || 0;
                const otherAllowances = parseFloat(document.getElementById('structure-other-allowances').value) || 0;
                const deductions = parseFloat(document.getElementById('structure-deductions').value) || 0;
                const totalSalary = basicSalary + houseRent + transport + medical + otherAllowances - deductions;
                const details = document.getElementById('structure-details').value;
                const existingStructure = await getAllFromIndex(STORES.SALARY_STRUCTURE, 'employeeTypeId', [employeeType, employeeId]);
                if (existingStructure && existingStructure.length > 0) {
                    await updateInStore(STORES.SALARY_STRUCTURE, existingStructure[0].id, {
                        basicSalary: basicSalary,
                        houseRent: houseRent,
                        transport: transport,
                        medical: medical,
                        otherAllowances: otherAllowances,
                        deductions: deductions,
                        totalSalary: totalSalary,
                        details: details,
                        updatedAt: new Date().toISOString()
                    });
                    showNotification('Salary structure updated successfully.', 'success');
                } else {
                    const salaryStructureData = {
                        employeeId: employeeId,
                        employeeType: employeeType,
                        basicSalary: basicSalary,
                        houseRent: houseRent,
                        transport: transport,
                        medical: medical,
                        otherAllowances: otherAllowances,
                        deductions: deductions,
                        totalSalary: totalSalary,
                        details: details,
                        createdAt: new Date().toISOString()
                    };
                    await addToStore(STORES.SALARY_STRUCTURE, salaryStructureData);
                    showNotification('Salary structure saved successfully.', 'success');
                }
                loadSalaryStructureTable();
            } catch (error) {
                console.error('Error saving salary structure:', error);
                showNotification('Failed to save salary structure.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addBook() {
            showLoading();
            const form = document.getElementById('book-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const bookData = {
                    name: document.getElementById('book-name').value,
                    author: document.getElementById('book-author').value,
                    category: document.getElementById('book-category').value,
                    isbn: document.getElementById('book-isbn').value,
                    copies: parseInt(document.getElementById('book-copies').value),
                    shelf: document.getElementById('book-shelf').value,
                };
                if (editId) {
                    const existingBook = await getFromStore(STORES.BOOKS, editId);
                    const diff = bookData.copies - existingBook.copies;
                    bookData.availableCopies = existingBook.availableCopies + diff;
                    await updateInStore(STORES.BOOKS, editId, bookData);
                    showNotification('Book record updated successfully.', 'success');
                } else {
                    bookData.availableCopies = bookData.copies;
                    await addToStore(STORES.BOOKS, bookData);
                    showNotification('Book added successfully.', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'Add Book';
                document.querySelector('.tab[data-tab="books-list"]').click();
            } catch (e) { console.error(e); showNotification('Failed to save book.', 'error'); } finally { hideLoading(); }
        }
        async function issueBook() {
            try {
                showLoading();
                const bookId = parseInt(document.getElementById('issue-book-select').value);
                const studentId = parseInt(document.getElementById('issue-student-select').value);
                const issueDate = document.getElementById('issue-date').value;
                const returnDueDate = document.getElementById('return-due-date').value;
                if (!bookId || !studentId || !issueDate) {
                    showNotification('Please select a book, student, and issue date.', 'error');
                    hideLoading();
                    return;
                }
                const bookData = await getFromStore(STORES.BOOKS, bookId);
                if (bookData.availableCopies <= 0) {
                    showNotification('No copies of this book are available.', 'error');
                    hideLoading();
                    return;
                }
                const studentData = await getFromStore(STORES.STUDENTS, studentId);
                const issueData = {
                    bookId: bookId,
                    bookName: bookData.name,
                    memberId: studentId,
                    memberName: studentData.name,
                    memberType: 'student',
                    issueDate: issueDate,
                    returnDueDate: returnDueDate,
                    status: 'issued',
                };
                await addToStore(STORES.BOOK_ISSUES, issueData);
                await updateInStore(STORES.BOOKS, bookId, {
                    availableCopies: bookData.availableCopies - 1
                });
                document.getElementById('issue-form').reset();
                showNotification('Book issued successfully.', 'success');
                loadIssuedBooksTable();
                loadBooksTable();
                populateLibraryDropdowns();
            } catch (error) {
                console.error('Error issuing book:', error);
                showNotification('Failed to issue book.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function returnBook() {
            try {
                showLoading();
                const issueId = parseInt(document.getElementById('return-book-select').value);
                const actualReturnDate = document.getElementById('actual-return-date').value;
                const fine = parseFloat(document.getElementById('return-fine').value) || 0;
                const condition = document.getElementById('return-condition').value;
                const damageFine = parseFloat(document.getElementById('return-damage-fine').value) || 0;
                const notes = document.getElementById('return-notes').value;
                const issue = await getFromStore(STORES.BOOK_ISSUES, issueId);
                if (!issue) {
                    showNotification('Issued record not found.', 'error');
                    return;
                }
                await updateInStore(STORES.BOOK_ISSUES, issue.id, {
                    status: 'returned',
                    actualReturnDate: actualReturnDate,
                    fine: fine + damageFine,
                    condition: condition,
                    notes: notes,
                    updatedAt: new Date().toISOString()
                });
                const book = await getFromStore(STORES.BOOKS, issue.bookId);
                if (book) {
                    await updateInStore(STORES.BOOKS, book.id, {
                        availableCopies: book.availableCopies + 1
                    });
                }
                await addToStore(STORES.ACTIVITIES, {
                    description: 'Book returned',
                    date: new Date().toISOString(),
                    type: 'Library',
                    user: currentUser ? currentUser.name : 'Unknown User',
                    userId: currentUser ? currentUser.id : null,
                    details: `${issue.bookName} returned by ${issue.memberName}`,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('return-form').reset();
                showNotification('Book returned successfully.', 'success');
                loadIssuedBooksTable();
                loadBooksTable();
                populateLibraryDropdowns();
            } catch (error) {
                console.error('Error returning book:', error);
                showNotification('Failed to return book.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addUser() {
            try {
                showLoading();
                const username = document.getElementById('user-username').value;
                const password = document.getElementById('user-password').value;
                const confirmPassword = document.getElementById('user-confirm-password').value;
                const name = document.getElementById('user-name').value;
                const email = document.getElementById('user-email').value;
                const role = document.getElementById('user-role').value;
                const photoInput = document.getElementById('user-photo');
                const mobile = document.getElementById('user-mobile').value;
                const status = document.getElementById('user-status').value;
                const address = document.getElementById('user-address').value;
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match.', 'error');
                    return;
                }
                const existingUsers = await getAllFromStore(STORES.USERS);
                const userExists = existingUsers.some(user => user.username === username || user.email === email);
                if (userExists) {
                    showNotification('Username or Email already exists.', 'error');
                    return;
                }
                let photo = null;
                if (photoInput.files && photoInput.files[0]) {
                    photo = await fileToBase64(photoInput.files[0]);
                }
                const userData = {
                    username: username,
                    password: password,
                    name: name,
                    email: email,
                    role: role,
                    photo: photo,
                    mobile: mobile,
                    status: status,
                    address: address,
                    lastLogin: null,
                    createdAt: new Date().toISOString()
                };
                const userId = await addToStore(STORES.USERS, userData);
                document.getElementById('user-form').reset();
                loadUsersTable();
                showNotification('User created successfully.', 'success');
                document.querySelector('.tab[data-tab="users-list"]').click();
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Failed to add user.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function addRole() {
            try {
                showLoading();
                const name = document.getElementById('role-name').value;
                const description = document.getElementById('role-description').value;
                const permissions = {};
                document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(cb => {
                    permissions[cb.value] = cb.checked;
                });
                const existingRoles = await getAllFromStore(STORES.ROLES);
                const roleExists = existingRoles.some(role => role.name === name);
                if (roleExists) {
                    showNotification('Role already exists.', 'error');
                    return;
                }
                const roleData = {
                    name: name,
                    description: description,
                    permissions: permissions,
                    createdAt: new Date().toISOString()
                };
                const roleId = await addToStore(STORES.ROLES, roleData);
                document.getElementById('role-form').reset();
                loadRolesTable();
                showNotification('Role created successfully.', 'success');
            } catch (error) {
                console.error('Error adding role:', error);
                showNotification('Failed to add role.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveGeneralSettings() {
            try {
                showLoading();
                const schoolName = document.getElementById('school-name').value;
                const principalName = document.getElementById('principal-name').value;
                const schoolAddress = document.getElementById('school-address').value;
                const schoolPhone = document.getElementById('school-contact').value;
                const schoolEmail = document.getElementById('school-email').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    schoolName: schoolName,
                    principalName: principalName,
                    schoolAddress: schoolAddress,
                    schoolPhone: schoolPhone,
                    schoolEmail: schoolEmail,
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                showNotification('General settings saved successfully.', 'success');
            } catch (error) {
                console.error('Error saving general settings:', error);
                showNotification('Failed to save settings.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveAcademicSettings(e) {
            e.preventDefault();
            try {
                showLoading();
                const currentSession = document.getElementById('setting-current-session').value;
                const sessionStart = document.getElementById('setting-session-start').value;
                const sessionEnd = document.getElementById('setting-session-end').value;
                const schoolTimeStart = document.getElementById('setting-school-time-start').value;
                const schoolTimeEnd = document.getElementById('setting-school-time-end').value;
                const periodDuration = document.getElementById('setting-period-duration').value;
                const weeklyHoliday = Array.from(document.getElementById('setting-weekly-holiday').selectedOptions).map(option => option.value);
                const feeDueDay = document.getElementById('setting-fee-due-day').value;
                const feeLateFine = document.getElementById('setting-fee-late-fine').value;
                const libraryReturnDays = document.getElementById('setting-library-return-days').value;
                const libraryLateFine = document.getElementById('setting-library-late-fine').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    currentSession: currentSession,
                    sessionStart: sessionStart,
                    sessionEnd: sessionEnd,
                    schoolTimeStart: schoolTimeStart,
                    schoolTimeEnd: schoolTimeEnd,
                    periodDuration: parseInt(periodDuration),
                    weeklyHoliday: weeklyHoliday,
                    feeDueDay: parseInt(feeDueDay),
                    feeLateFine: parseFloat(feeLateFine),
                    libraryReturnDays: parseInt(libraryReturnDays),
                    libraryLateFine: parseFloat(libraryLateFine),
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                showNotification('Academic settings saved successfully.', 'success');
            } catch (error) {
                console.error('Error saving academic settings:', error);
                showNotification('Failed to save settings.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function saveThemeSettings(e) {
            e.preventDefault();
            try {
                showLoading();
                const primaryColor = document.getElementById('setting-primary-color').value;
                const secondaryColor = document.getElementById('setting-secondary-color').value;
                const fontSize = document.getElementById('setting-font-size').value;
                const fontFamily = document.getElementById('setting-font-family').value;
                const sidebarPosition = document.getElementById('setting-sidebar-position').value;
                const sidebarTheme = document.getElementById('setting-sidebar-theme').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    primaryColor: primaryColor,
                    secondaryColor: secondaryColor,
                    fontSize: fontSize,
                    fontFamily: fontFamily,
                    sidebarPosition: sidebarPosition,
                    sidebarTheme: sidebarTheme,
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                applySettings();
                showNotification('Theme settings saved successfully.', 'success');
            } catch (error) {
                console.error('Error saving theme settings:', error);
                showNotification('Failed to save settings.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function resetThemeSettings() {
            try {
                showLoading();
                const defaultThemeSettings = {
                    primaryColor: '#3498db',
                    secondaryColor: '#2c3e50',
                    fontSize: 'medium',
                    fontFamily: 'Arial, sans-serif',
                    sidebarPosition: 'left',
                    sidebarTheme: 'dark'
                };
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    ...defaultThemeSettings,
                    id: 'general',
                    updatedAt: new Date().toISOString()
                };
                await updateInStore(STORES.SETTINGS, 'general', updatedSettings);
                document.getElementById('setting-primary-color').value = defaultThemeSettings.primaryColor;
                document.getElementById('setting-secondary-color').value = defaultThemeSettings.secondaryColor;
                document.getElementById('setting-font-size').value = defaultThemeSettings.fontSize;
                document.getElementById('setting-font-family').value = defaultThemeSettings.fontFamily;
                document.getElementById('setting-sidebar-position').value = defaultThemeSettings.sidebarPosition;
                document.getElementById('setting-sidebar-theme').value = defaultThemeSettings.sidebarTheme;
                applySettings();
                showNotification('Theme settings reset to default.', 'success');
            } catch (error) {
                console.error('Error resetting theme settings:', error);
                showNotification('Failed to reset settings.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function createBackup() {
            try {
                showLoading();
                const backupType = document.getElementById('backup-type').value;
                const backupFormat = document.getElementById('backup-format').value;
                let data = {};
                if (backupType === 'full') {
                    for (const store in STORES) {
                        data[STORES[store]] = await getAllFromStore(STORES[store]);
                    }
                } else {
                    data[backupType] = await getAllFromStore(backupType);
                }
                const backupData = {
                    type: backupType,
                    format: backupFormat,
                    date: new Date().toISOString(),
                    data: data
                };
                const backupBlob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const backupName = `school_madrasa_backup_${backupType}_${new Date().toISOString().slice(0, 10)}.json`;
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(backupBlob);
                downloadLink.download = backupName;
                downloadLink.click();
                await addToStore(STORES.BACKUP, {
                    type: backupType,
                    format: backupFormat,
                    date: new Date().toISOString(),
                    size: backupBlob.size,
                    filename: backupName,
                    createdAt: new Date().toISOString()
                });
                loadBackupHistoryTable();
                showNotification('Backup created successfully.', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showNotification('Failed to create backup.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function loadTeacherDropdowns() {
            try {
                const teachers = await getAllFromStore(STORES.TEACHERS);
                const teacherDropdowns = document.querySelectorAll('select[id$="-teacher"], select[id$="-incharge"], select[id$="Teacher"]');
                teacherDropdowns.forEach(dropdown => {
                    const currentVal = dropdown.value;
                    const fixedOptions = Array.from(dropdown.options).filter(opt => opt.value === "" || opt.value === "all" || opt.dataset.fixed);
                    dropdown.innerHTML = '';
                    fixedOptions.forEach(opt => dropdown.appendChild(opt.cloneNode(true)));
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = teacher.name;
                        dropdown.appendChild(option);
                    });
                    if (Array.from(dropdown.options).some(opt => opt.value === currentVal)) {
                        dropdown.value = currentVal;
                    }
                });
            } catch (error) {
                console.error('Error loading teacher dropdowns:', error);
            }
        }
        async function loadStudentsForAttendance() {
            const dateElement = document.getElementById('attendance-date');
            const classIdElement = document.getElementById('attendance-class');
            const sectionIdElement = document.getElementById('attendance-section');
            const selectedDate = new Date(dateElement.value + 'T00:00:00');
            const dayName = selectedDate.toLocaleDateString('en-US', { weekday: 'long' });
            if (appSettings.weeklyHoliday && appSettings.weeklyHoliday.includes(dayName)) {
                showNotification(`${dayName} is a holiday. Attendance cannot be marked.`, 'info');
                document.getElementById('attendance-table-container').style.display = 'none';
                return;
            }
            if (!classIdElement || !sectionIdElement || !dateElement) {
                console.error("Attendance filter elements not found.");
                showNotification('Required attendance elements not found.', 'error');
                return;
            }
            const classId = parseInt(classIdElement.value);
            const sectionId = parseInt(sectionIdElement.value);
            const date = dateElement.value;
            if (isNaN(classId) || isNaN(sectionId) || !date) {
                showNotification('Please select date, class and section.', 'error');
                return;
            }
            showLoading();
            try {
                const allStudents = await getAllFromStore(STORES.STUDENTS);
                const activeStudents = allStudents.filter(s => !s.status || s.status === 'active');
                const classStudents = activeStudents.filter(s => s.classId === classId && s.sectionId === sectionId);
                const attendanceTableBody = document.querySelector('#attendance-table tbody');
                const attendanceTableContainer = document.getElementById('attendance-table-container');
                if (!attendanceTableBody || !attendanceTableContainer) {
                    console.error("Attendance table elements not found.");
                    hideLoading();
                    return;
                }
                attendanceTableBody.innerHTML = '';
                if (classStudents.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" style="text-align:center;">No active students found for this class and section.</td>';
                    attendanceTableBody.appendChild(row);
                } else {
                    const existingAttendanceRecords = await getAllFromIndex(STORES.ATTENDANCE, 'dateClassSection', [date, classId, sectionId]);
                    const existingAttendanceMap = new Map(existingAttendanceRecords.map(rec => [rec.studentId, rec]));
                    classStudents.forEach(student => {
                        const existingRecord = existingAttendanceMap.get(student.id);
                        const isPresent = existingRecord ? existingRecord.status === 'present' : true;
                        const isAbsent = existingRecord ? existingRecord.status === 'absent' : false;
                        const isLate = existingRecord ? existingRecord.isLate : false;
                        const onLeave = existingRecord ? existingRecord.isLeave : false;
                        const notes = existingRecord ? existingRecord.notes : '';
                        const row = document.createElement('tr');
                        row.dataset.studentId = student.id;
                        row.innerHTML = `
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>
                        <label style="margin-right: 5px;"><input type="radio" name="status_${student.id}" value="present" ${isPresent && !onLeave ? 'checked' : ''}> Present</label>
                        <label style="margin-right: 5px;"><input type="radio" name="status_${student.id}" value="absent" ${isAbsent && !onLeave ? 'checked' : ''}> Absent</label>
                    </td>
                    <td><input type="checkbox" name="late_${student.id}" ${isLate ? 'checked' : ''}></td>
                    <td><input type="checkbox" name="leave_${student.id}" ${onLeave ? 'checked' : ''}></td>
                    <td><input type="text" class="form-control" name="notes_${student.id}" value="${notes}"></td>
                `;
                        attendanceTableBody.appendChild(row);
                        const leaveCheckbox = row.querySelector(`input[name="leave_${student.id}"]`);
                        const presentRadio = row.querySelector(`input[name="status_${student.id}"][value="present"]`);
                        const absentRadio = row.querySelector(`input[name="status_${student.id}"][value="absent"]`);
                        if (leaveCheckbox) {
                            leaveCheckbox.addEventListener('change', (e) => {
                                if (e.target.checked) {
                                    presentRadio.checked = false;
                                    absentRadio.checked = false;
                                    presentRadio.disabled = true;
                                    absentRadio.disabled = true;
                                } else {
                                    presentRadio.disabled = false;
                                    absentRadio.disabled = false;
                                    presentRadio.checked = true;
                                }
                            });
                            if (onLeave) {
                                presentRadio.disabled = true;
                                absentRadio.disabled = true;
                            }
                        }
                    });
                }
                attendanceTableContainer.style.display = 'block';
            } catch (error) {
                console.error("Error loading students for attendance:", error);
                showNotification('Failed to load students for attendance.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function restoreBackup() {
            try {
                showLoading();
                const fileInput = document.getElementById('restore-file');
                if (!fileInput.files || fileInput.files.length === 0) {
                    showNotification('Please select a backup file.', 'error');
                    return;
                }
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        if (!backupData || !backupData.data) {
                            showNotification('Invalid backup file format.', 'error');
                            return;
                        }
                        const confirmation = confirm('Restoring the database will erase existing data. Are you sure you want to proceed?');
                        if (!confirmation) {
                            hideLoading();
                            return;
                        }
                        for (const storeName in backupData.data) {
                            const storeData = backupData.data[storeName];
                            if (!storeData || !Array.isArray(storeData)) continue;
                            const transaction = db.transaction(storeName, 'readwrite');
                            const store = transaction.objectStore(storeName);
                            await new Promise((resolve, reject) => {
                                const clearRequest = store.clear();
                                clearRequest.onsuccess = resolve;
                                clearRequest.onerror = reject;
                            });
                            for (const item of storeData) {
                                await new Promise((resolve, reject) => {
                                    const addRequest = store.add(item);
                                    addRequest.onsuccess = resolve;
                                    addRequest.onerror = reject;
                                });
                            }
                        }
                        showNotification('Data restored successfully.', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } catch (error) {
                        console.error('Error parsing or restoring backup:', error);
                        showNotification('Failed to restore backup.', 'error');
                        hideLoading();
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error restoring backup:', error);
                showNotification('Failed to restore backup.', 'error');
                hideLoading();
            }
        }
        async function saveAutoBackupSettings() {
            try {
                showLoading();
                const isEnabled = document.getElementById('auto-backup-enable').checked;
                const frequency = document.getElementById('auto-backup-frequency').value;
                const retention = document.getElementById('auto-backup-retention').value;
                const backupTime = document.getElementById('auto-backup-time').value;
                const settings = await getFromStore(STORES.SETTINGS, 'general') || {};
                const updatedSettings = {
                    ...settings,
                    id: 'general',
                    autoBackupEnabled: isEnabled,
                    autoBackupFrequency: frequency,
                    autoBackupRetention: parseInt(retention),
                    autoBackupTime: backupTime,
                    updatedAt: new Date().toISOString()
                };
                await addToStore(STORES.SETTINGS, updatedSettings, true);
                if (isEnabled && !localStorage.getItem('lastAutoBackupTimestamp')) {
                    localStorage.setItem('lastAutoBackupTimestamp', new Date().toISOString());
                    console.log('Priming automatic backup. First backup will run on the next scheduled interval.');
                }
                showNotification('Automatic backup settings saved successfully.', 'success');
            } catch (error) {
                console.error('Error saving auto backup settings:', error);
                showNotification('Failed to save settings.', 'error');
            } finally {
                hideLoading();
            }
        }
        async function fileToBase64(file) {
            if (!file || !(file instanceof Blob)) {
                return null;
            }
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            const menuToggle = document.getElementById('menuToggle');
            if (!sidebar || !mainContainer || !menuToggle) {
                console.error("Error: Required elements (sidebar, mainContainer, or menuToggle) not found.");
                return;
            }
            const isRtl = document.body.classList.contains('rtl-mode');
            const isSidebarVisible = !sidebar.style.transform || sidebar.style.transform === 'translateX(0px)';
            const icon = menuToggle.querySelector('i');
            const hideTransform = isRtl ? 'translateX(100%)' : 'translateX(-100%)';
            const showTransform = 'translateX(0)';
            if (window.innerWidth <= 768) {
                if (isSidebarVisible) {
                    sidebar.style.transform = hideTransform;
                    if (icon) icon.innerHTML = '☰';
                } else {
                    sidebar.style.transform = showTransform;
                    if (icon) icon.innerHTML = '×';
                }
            } else {
                if (isSidebarVisible) {
                    sidebar.style.transform = hideTransform;
                    mainContainer.style.marginLeft = '0';
                    mainContainer.style.marginRight = '0';
                    mainContainer.style.width = '100%';
                    if (icon) icon.innerHTML = '☰';
                } else {
                    sidebar.style.transform = showTransform;
                    if (isRtl) {
                        mainContainer.style.marginRight = '250px';
                        mainContainer.style.marginLeft = '0';
                    } else {
                        mainContainer.style.marginLeft = '250px';
                        mainContainer.style.marginRight = '0';
                    }
                    mainContainer.style.width = 'calc(100% - 250px)';
                    if (icon) icon.innerHTML = '×';
                }
            }
        }
        function initializeDynamicViews() {
            initializeLibraryView();
            initializeReportsView();
            initializeSettingsView();
            initializeUserRolesForm();
        }
        function attachDynamicEventListeners() {
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.addEventListener('click', function (e) {
                const target = e.target;
                if (target.matches('#issue-book-search-btn')) searchBookForIssue();
                if (target.matches('#issue-member-search-btn')) searchMemberForIssue();
                if (target.matches('#issue-book-btn')) issueBook();
                if (target.matches('#return-search-btn')) searchIssueForReturn();
                if (target.matches('#return-book-btn')) {
                    const issueId = parseInt(target.dataset.issueId);
                    const bookId = parseInt(target.dataset.bookId);
                    returnBook(issueId, bookId);
                }
                if (target.matches('#generate-report-btn')) generateReport();
                if (target.matches('#reset-theme-btn')) resetThemeSettings();
            });
            mainContainer.addEventListener('submit', function (e) {
                if (e.target.matches('form')) {
                    e.preventDefault();
                }
                const formId = e.target.id;
                switch (formId) {
                    case 'add-book-form':
                        addBook();
                        break;
                    case 'general-settings-form':
                        saveGeneralSettings();
                        break;
                    case 'academic-settings-form':
                        saveAcademicSettings();
                        break;
                    case 'theme-settings-form':
                        saveThemeSettings();
                        break;
                }
            });
            mainContainer.addEventListener('change', function (e) {
                if (e.target.matches('#report-type')) {
                    toggleReportFilters();
                }
            });
            console.log("Delegated event listeners attached to main container.");
        }
        function calculateDueDate() {
            const issueDateStr = document.getElementById('issue-date').value;
            if (!issueDateStr) return;
            const issueDate = new Date(issueDateStr);
            issueDate.setDate(issueDate.getDate() + parseInt(appSettings.libraryReturnDays));
            document.getElementById('return-due-date').value = issueDate.toISOString().split('T')[0];
        }
        async function initializeLibraryView() {
            const container = document.getElementById('library-view');
            if (container.querySelector('.tabs')) {
                loadIssuedBooksTable();
                return;
            }
            container.innerHTML = `
        <h2>Library</h2>
        <div class="tabs">
            <div class="tab active" data-tab="books-list">Book List</div>
            <div class="tab" data-tab="add-book">Add New Book</div>
            <div class="tab" data-tab="issue-book">Issue Book</div>
            <div class="tab" data-tab="return-book">Return Book</div>
        </div>
        <div class="tab-content active" id="books-list">
            <div class="table-container"><table class="table" id="books-table"><thead><tr><th>Book ID</th><th>Book Name</th><th>Author</th><th>Category</th><th>Available</th><th>Action</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div class="tab-content" id="add-book">
            <div class="form-container">
                <form id="book-form" onsubmit="event.preventDefault(); addBook();">
                    <div class="form-title">New Book Details</div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Book Name</label><input type="text" id="book-name" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Author</label><input type="text" id="book-author" class="form-control" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Category</label><input type="text" id="book-category" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">ISBN</label><input type="text" class="form-control" id="book-isbn"></div>
                    </div>
                     <div class="form-row">
                        <div class="form-group"><label class="form-label">Copies</label><input type="number" class="form-control" id="book-copies" required min="1"></div>
                        <div class="form-group"><label class="form-label">Shelf Location</label><input type="text" class="form-control" id="book-shelf"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Book</button>
                </form>
            </div>
        </div>
        <div class="tab-content" id="issue-book">
            <div class="form-container">
                <div class="form-title">Issue Book</div>
                <form id="issue-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Book</label>
                            <select class="form-control" id="issue-book-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Student</label>
                            <select class="form-control" id="issue-student-select" required></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Issue Date</label>
                            <input type="date" class="form-control" id="issue-date" required onchange="calculateDueDate()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Return Due Date</label>
                            <input type="date" class="form-control" id="return-due-date" required readonly>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="submit" class="btn btn-primary">Issue Book</button>
                    </div>
                </form>
            </div>
            <div class="table-container">
                <div class="form-title">Issued Books</div>
                <table class="table" id="issued-books-table">
                    <thead>
                        <tr>
                            <th>Issue ID</th>
                            <th>Book</th>
                            <th>Member</th>
                            <th>Issue Date</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="tab-content" id="return-book">
            <div class="form-container">
                <div class="form-title">Return Book</div>
                <form id="return-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Issued Books</label>
                            <select class="form-control" id="return-book-select" required></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Actual Return Date</label>
                            <input type="date" class="form-control" id="actual-return-date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Fine (if any)</label>
                            <input type="number" class="form-control" id="return-fine" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Condition</label>
                            <select class="form-control" id="return-condition">
                                <option value="Good">Good</option>
                                <option value="Damaged">Damaged</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Damage Fine (if any)</label>
                            <input type="number" class="form-control" id="return-damage-fine" value="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" id="return-notes" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <button type="submit" class="btn btn-primary">Return Book</button>
                    </div>
                </form>
            </div>
        </div>
    `;
            container.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    tab.parentElement.querySelector('.active').classList.remove('active');
                    tab.classList.add('active');
                    tab.closest('.section-view').querySelector('.tab-content.active').classList.remove('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    if (tab.dataset.tab === 'books-list') loadBooksTable();
                    if (tab.dataset.tab === 'issue-book' || tab.dataset.tab === 'return-book') populateLibraryDropdowns();
                    if (tab.dataset.tab === 'issue-book') loadIssuedBooksTable();
                });
            });
            loadBooksTable();
            loadIssuedBooksTable();
        }
        async function loadBooksTable() {
            const tbody = document.querySelector('#books-table tbody');
            tbody.innerHTML = '';
            const books = await getAllFromStore(STORES.BOOKS);
            if (!books || books.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No book available.</td></tr>';
                return;
            }
            books.forEach(book => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.name}</td>
                    <td>${book.author}</td>
                    <td>${book.category}</td>
                    <td>${book.availableCopies}</td> 
                    <td class="no-print"><button class="btn btn-primary btn-sm" onclick="editBook(${book.id})">Edit</button> <button class="btn btn-danger btn-sm" onclick="deleteBook(${book.id})">Delete</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        async function loadIssuedBooksTable() {
            const tbody = document.querySelector('#issued-books-table tbody');
            tbody.innerHTML = '';
            const issuedBooks = await getAllFromStore(STORES.BOOK_ISSUES);
            const activeIssuedBooks = issuedBooks.filter(issue => issue.status === 'issued');
            if (!activeIssuedBooks || activeIssuedBooks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No books currently issued.</td></tr>';
                return;
            }
            for (const issue of activeIssuedBooks) {
                const book = await getFromStore(STORES.BOOKS, issue.bookId);
                const member = await getFromStore(STORES.STUDENTS, issue.memberId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${issue.id}</td>
                    <td>${book ? book.name : 'N/A'}</td>
                    <td>${member ? member.name : 'N/A'} (${issue.memberType})</td>
                    <td>${formatDate(issue.issueDate)}</td>
                    <td>${formatDate(issue.returnDueDate)}</td>
                    <td>${issue.status}</td>
                    <td class="no-print">
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${STORES.BOOK_ISSUES}', ${issue.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }
        async function addBook() {
            const form = document.getElementById('book-form');
            const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
            try {
                const bookData = {
                    name: document.getElementById('book-name').value,
                    author: document.getElementById('book-author').value,
                    category: document.getElementById('book-category').value,
                    isbn: document.getElementById('book-isbn').value,
                    copies: parseInt(document.getElementById('book-copies').value),
                    shelf: document.getElementById('book-shelf').value,
                };
                if (editId) {
                    const existingBook = await getFromStore(STORES.BOOKS, editId);
                    const diff = bookData.copies - existingBook.copies;
                    bookData.availableCopies = existingBook.availableCopies + diff;
                    await updateInStore(STORES.BOOKS, editId, bookData);
                    showNotification('Book record updated successfully', 'success');
                } else {
                    bookData.availableCopies = bookData.copies;
                    await addToStore(STORES.BOOKS, bookData);
                    showNotification('Book added successfully', 'success');
                }
                form.reset();
                delete form.dataset.editId;
                form.querySelector('button[type="submit"]').textContent = 'Add Book';
                loadBooksTable();
                populateLibraryDropdowns();
                document.querySelector('[data-tab="books-list"]').click();
            } catch (e) { console.error(e); showNotification('Failed to save book.', 'error'); }
        }
        async function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book?')) {
                await deleteFromStore(STORES.BOOKS, id);
                showNotification('Book deleted', 'success');
                loadBooksTable();
                populateLibraryDropdowns();
            }
        }
        async function initializeUserRolesForm() {
            const roleForm = document.getElementById('role-form');
            if (!roleForm) return;
            const permissions = ['dashboard', 'students', 'teachers', 'staff', 'classes', 'subjects', 'attendance', 'exams', 'fees', 'salaries', 'library', 'users', 'reports', 'settings', 'backup'];
            const permsContainer = document.getElementById('permissions-container');
            if (permsContainer && permsContainer.children.length === 0) {
                permissions.forEach(p => {
                    permsContainer.innerHTML += `
                        <label><input type="checkbox" id="perm-${p}" value="${p}"> ${p.charAt(0).toUpperCase() + p.slice(1)}</label>
                    `;
                });
            }
        }
        async function loadUsersTable() {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            const users = await getAllFromStore(STORES.USERS);
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No user available.</td></tr>';
                return;
            }
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td><span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-danger'}">${user.status}</span></td>
            <td class="no-print"><button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button></td>
        `;
                tbody.appendChild(row);
            });
        }
        async function deleteUser(id) {
            if (confirm('Are you sure you want to delete this user?')) {
                await deleteFromStore(STORES.USERS, id);
                showNotification('User deleted', 'success');
                loadUsersTable();
            }
        }
        async function loadRolesTable() {
            const tbody = document.querySelector('#roles-table tbody');
            tbody.innerHTML = '';
            const roles = await getAllFromStore(STORES.ROLES);
            if (!roles || roles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">No role available.</td></tr>';
                return;
            }
            roles.forEach(role => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${role.name}</td>
            <td>${role.description}</td>
            <td class="no-print"><button class="btn btn-danger btn-sm" onclick="deleteRole(${role.id})">Delete</button></td>
        `;
                tbody.appendChild(row);
            });
        }
        async function deleteRole(id) {
            if (confirm('Are you sure you want to delete this role?')) {
                await deleteFromStore(STORES.ROLES, id);
                showNotification('Role deleted', 'success');
                loadRolesTable();
            }
        }
        function handleReportTypeChangeJS() {
            const selectedValue = document.getElementById('js-report-type-select').value;
            const filtersArea = document.getElementById('js-report-filters-area');
            filtersArea.innerHTML = '';
            filtersArea.style.display = 'none';
            if (!selectedValue) return;
            const [category, reportId] = selectedValue.split(':');
            const reportConfig = REPORT_CONFIG[category]?.find(r => r.id === reportId);
            if (!reportConfig || !reportConfig.filters || reportConfig.filters.length === 0) return;
            filtersArea.style.display = 'flex';
            renderFiltersForReport(reportConfig.filters, filtersArea);
        }
        async function renderFiltersForReport(filters, container) {
            for (const filterType of filters) {
                const filterGroup = createElementJS('div', { class: 'form-group' });
                let requiresRepopulate = false;
                switch (filterType) {
                    case 'date':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-date' }, 'Date'));
                        filterGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-date', value: new Date().toISOString().split('T')[0] }));
                        break;
                    case 'date_range':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-date-from' }, 'Date (From)'));
                        filterGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-date-from' }));
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-date-to', style: { marginTop: '5px' } }, 'Date (To)'));
                        filterGroup.appendChild(createElementJS('input', { type: 'date', class: 'form-control', id: 'js-filter-date-to' }));
                        break;
                    case 'month_year':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-month' }, 'Month'));
                        const monthSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-month' });
                        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                        months.forEach((m, i) => monthSelect.appendChild(createElementJS('option', { value: i + 1 }, m)));
                        monthSelect.value = new Date().getMonth() + 1;
                        filterGroup.appendChild(monthSelect);
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-year', style: { marginTop: '5px' } }, 'Year'));
                        filterGroup.appendChild(createElementJS('input', { type: 'number', class: 'form-control', id: 'js-filter-year', value: new Date().getFullYear() }));
                        break;
                    case 'year_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-year-optional' }, 'Year (Optional)'));
                        const yearOptionalInput = createElementJS('input', { type: 'number', class: 'form-control', id: 'js-filter-year-optional', placeholder: 'Leave empty for current year' });
                        filterGroup.appendChild(yearOptionalInput);
                        break;
                    case 'class':
                    case 'class_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-class' }, 'Class'));
                        const classSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-class' });
                        if (filterType === 'class_optional') {
                            classSelect.appendChild(createElementJS('option', { value: '' }, 'All Classes'));
                        }
                        const classes = await getAllFromStore(STORES.CLASSES);
                        classes.forEach(c => classSelect.appendChild(createElementJS('option', { value: c.id }, c.name)));
                        filterGroup.appendChild(classSelect);
                        classSelect.addEventListener('change', async () => {
                            if (filters.includes('section') || filters.includes('section_optional')) {
                                await populateReportFilterSectionsJS(filters.includes('section_optional'));
                            }
                            if (filters.includes('student_optional')) {
                                await populateReportFilterStudentsJS();
                            }
                        });
                        break;
                    case 'section':
                    case 'section_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-section' }, 'Section'));
                        const sectionSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-section' });
                        filterGroup.appendChild(sectionSelect);
                        if (filters.includes('student_optional')) {
                            sectionSelect.addEventListener('change', populateReportFilterStudentsJS);
                        }
                        requiresRepopulate = true;
                        break;
                    case 'gender_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-gender' }, 'Gender'));
                        const genderSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-gender' });
                        genderSelect.appendChild(createElementJS('option', { value: '' }, 'All'));
                        genderSelect.appendChild(createElementJS('option', { value: 'Male' }, 'Male'));
                        genderSelect.appendChild(createElementJS('option', { value: 'Female' }, 'Female'));
                        filterGroup.appendChild(genderSelect);
                        break;
                    case 'student_optional':
                        filterGroup.appendChild(createElementJS('label', { class: 'form-label', for: 'js-filter-student' }, 'Student'));
                        const studentSelect = createElementJS('select', { class: 'form-control', id: 'js-filter-student' });
                        filterGroup.appendChild(studentSelect);
                        requiresRepopulate = true;
                        break;
                }
                container.appendChild(filterGroup);
                if (requiresRepopulate) {
                    if (filterType.includes('section')) await populateReportFilterSectionsJS(filterType === 'section_optional');
                    if (filterType.includes('student')) await populateReportFilterStudentsJS();
                }
            }
        }
        async function populateReportFilterSectionsJS(isOptional = false) {
            const classSelect = document.getElementById('js-filter-class');
            const sectionSelect = document.getElementById('js-filter-section');
            if (!sectionSelect) return;
            sectionSelect.innerHTML = '';
            if (isOptional) {
                sectionSelect.appendChild(createElementJS('option', { value: '' }, 'All Sections'));
            }
            const classId = classSelect ? parseInt(classSelect.value) : null;
            if (classId && !isNaN(classId)) {
                const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                sections.forEach(s => sectionSelect.appendChild(createElementJS('option', { value: s.id }, s.name)));
            } else if (!classId && isOptional) {
                const allSections = await getAllFromStore(STORES.SECTIONS);
                for (const s of allSections) {
                    const c = await getFromStore(STORES.CLASSES, s.classId);
                    sectionSelect.appendChild(createElementJS('option', { value: s.id }, `${s.name} (${c?.name || ''})`));
                }
            } else if (!classId && !isOptional) {
                sectionSelect.appendChild(createElementJS('option', { value: '' }, 'Select Class First'));
            }
        }
        async function populateReportFilterStudentsJS() {
            const studentSelect = document.getElementById('js-filter-student');
            if (!studentSelect) return;
            studentSelect.innerHTML = '';
            studentSelect.appendChild(createElementJS('option', { value: '' }, 'All Students'));
            const classIdVal = document.getElementById('js-filter-class')?.value;
            const sectionIdVal = document.getElementById('js-filter-section')?.value;
            const classId = classIdVal ? parseInt(classIdVal) : null;
            const sectionId = sectionIdVal ? parseInt(sectionIdVal) : null;
            let students = await getAllFromStore(STORES.STUDENTS);
            if (classId && !isNaN(classId)) {
                students = students.filter(s => s.classId === classId);
            }
            if (sectionId && !isNaN(sectionId)) {
                students = students.filter(s => s.sectionId === sectionId);
            }
            students.sort((a, b) => (a.name || "").localeCompare(b.name || "", 'en'));
            students.forEach(s => studentSelect.appendChild(createElementJS('option', { value: s.id }, `${s.name || 'Unnamed'} (${s.rollNumber || 'N/A'})`)));
        }
        async function generateSelectedReportJS() {
            const selectedValue = document.getElementById('js-report-type-select').value;
            const outputDiv = document.getElementById('js-report-output-area');
            outputDiv.innerHTML = '';
            if (currentReportChart) {
                currentReportChart.destroy();
                currentReportChart = null;
            }
            if (!selectedValue) {
                showNotification('Please select a report type.', 'error');
                return;
            }
            showLoading();
            const [category, reportId] = selectedValue.split(':');
            const reportConfig = REPORT_CONFIG[category]?.find(r => r.id === reportId);
            if (!reportConfig || !reportConfig.generator) {
                outputDiv.innerHTML = '<p>Report generator function not found.</p>';
                hideLoading();
                return;
            }
            try {
                const filterValues = {};
                if (reportConfig.filters) {
                    reportConfig.filters.forEach(filterKey => {
                        if (filterKey === 'date') filterValues.date = document.getElementById('js-filter-date')?.value;
                        if (filterKey === 'date_range') {
                            filterValues.dateFrom = document.getElementById('js-filter-date-from')?.value;
                            filterValues.dateTo = document.getElementById('js-filter-date-to')?.value;
                        }
                        if (filterKey === 'month_year') {
                            filterValues.month = parseInt(document.getElementById('js-filter-month')?.value);
                            filterValues.year = parseInt(document.getElementById('js-filter-year')?.value);
                        }
                        if (filterKey === 'year_optional') {
                            const yearVal = document.getElementById('js-filter-year-optional')?.value;
                            filterValues.year = yearVal ? parseInt(yearVal) : new Date().getFullYear();
                        }
                        if (filterKey === 'class' || filterKey === 'class_optional') {
                            const val = document.getElementById('js-filter-class')?.value;
                            filterValues.classId = val ? parseInt(val) : null;
                        }
                        if (filterKey === 'section' || filterKey === 'section_optional') {
                            const val = document.getElementById('js-filter-section')?.value;
                            filterValues.sectionId = val ? parseInt(val) : null;
                        }
                        if (filterKey === 'gender_optional') {
                            filterValues.gender = document.getElementById('js-filter-gender')?.value || null;
                        }
                        if (filterKey === 'student_optional') {
                            const val = document.getElementById('js-filter-student')?.value;
                            filterValues.studentId = val ? parseInt(val) : null;
                        }
                    });
                }
                const { html, chartData } = await reportConfig.generator(filterValues);
                outputDiv.innerHTML = html;
                if (chartData && reportConfig.chartType) {
                    if (typeof Chart === 'undefined') {
                        console.warn("Chart.js library is not loaded. Skipping chart rendering.");
                        const placeholder = document.getElementById(chartData.canvasId);
                        if (placeholder) placeholder.innerHTML = '<p style="text-align:center; color: #777;"><em>Chart.js library not loaded.</em></p>';
                    } else {
                        if (reportConfig.chartType === 'pie_multi' && Array.isArray(chartData)) {
                            chartData.forEach(singleChartData => {
                                renderChart(singleChartData.type || 'pie', singleChartData.canvasId, singleChartData.title, singleChartData.labels, singleChartData.datasets, singleChartData.options);
                            });
                        } else if (reportConfig.chartType === 'multi' && Array.isArray(chartData)) {
                            chartData.forEach(singleChartData => {
                                renderChart(singleChartData.type, singleChartData.canvasId, singleChartData.title, singleChartData.labels, singleChartData.datasets, singleChartData.options);
                            });
                        }
                        else if (chartData.canvasId) {
                            renderChart(reportConfig.chartType, chartData.canvasId, chartData.title, chartData.labels, chartData.datasets, chartData.options);
                        }
                    }
                }
            } catch (error) {
                console.error(`Error generating report '${reportConfig.name}':`, error);
                outputDiv.innerHTML = `<p style="color:red;">Failed to generate report: ${error.message}</p>`;
                showNotification('Failed to generate report.', 'error');
            } finally {
                hideLoading();
            }
        }
        function renderChart(type, canvasId, chartTitle, labels, datasets, chartOptions = {}) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn("Canvas not found for chart:", canvasId);
                return;
            }
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: chartTitle, font: { size: 16, family: "Arial, sans-serif" } },
                    legend: { labels: { font: { family: "Arial, sans-serif" } } }
                },
            };
            if (type === 'bar' || type === 'line' || type === 'bar_grouped') {
                defaultOptions.scales = { y: { beginAtZero: true, ticks: { font: { family: "Arial, sans-serif" } } }, x: { ticks: { font: { family: "Arial, sans-serif" } } } };
            }
            ctx.chart = new Chart(ctx, {
                type: type === 'bar_grouped' ? 'bar' : type,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: { ...defaultOptions, ...chartOptions }
            });
        }
        async function generateStudentDetailsHTML() {
            const students = (await getAllFromStore(STORES.STUDENTS)).filter(s => !s.status || s.status === 'active');
            let html = `<div class="table-container"><table class="table"><thead><tr><th>Roll No</th><th>Name</th><th>Class</th><th>Contact</th></tr></thead><tbody>`;
            for (const student of students) {
                const className = student.classId ? (await getFromStore(STORES.CLASSES, student.classId))?.name : 'N/A';
                html += `<tr><td>${student.rollNumber}</td><td>${student.name}</td><td>${className}</td><td>${student.contact}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            return html;
        }
        async function generateTeacherDetailsHTML() {
            const teachers = await getAllFromStore(STORES.TEACHERS);
            let html = `<div class="table-container"><table class="table"><thead><tr><th>ID</th><th>Name</th><th>Specialization</th><th>Contact</th></tr></thead><tbody>`;
            for (const teacher of teachers) {
                html += `<tr><td>${teacher.employeeId}</td><td>${teacher.name}</td><td>${teacher.specialization}</td><td>${teacher.contact}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            return html;
        }
        async function generateMonthlyCollectionDetailsHTML(month, year) {
            const records = (await getAllFromStore(STORES.FEES)).filter(f => f.month === month && f.year === year);
            let html = `<div class="table-container"><table class="table"><thead><tr><th>Receipt #</th><th>Student</th><th>Date</th><th>Amount</th></tr></thead><tbody>`;
            for (const record of records) {
                html += `<tr><td>${record.receiptNumber}</td><td>${record.studentName}</td><td>${formatDate(record.date)}</td><td>${formatCurrency(record.total)}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            return html;
        }
        async function generatePendingFeeDetailsHTML() {
            let html = `<div class="table-container"><table class="table"><thead><tr><th>Roll No.</th><th>Name</th><th>Class</th><th>Total Due</th><th>Due Months</th></tr></thead><tbody>`;
            const students = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.status === 'active' || !s.status);
            const allFeeRecords = await getAllFromStore(STORES.FEES);
            const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
            const structureMap = new Map();
            feeStructures.forEach(fs => {
                structureMap.set(`${fs.classId}-${fs.category}`, fs.monthlyFee);
            });
            const paymentsMap = new Map();
            allFeeRecords.forEach(rec => {
                const key = `${rec.studentId}-${rec.month}-${rec.year}`;
                const existing = paymentsMap.get(key) || { paid: 0, historicalFee: null };
                existing.paid += rec.amount - (rec.discount || 0);
                if (rec.monthlyFeeAtTimeOfPayment) {
                    existing.historicalFee = rec.monthlyFeeAtTimeOfPayment;
                }
                paymentsMap.set(key, existing);
            });
            const classMap = new Map((await getAllFromStore(STORES.CLASSES)).map(c => [c.id, c.name]));
            const currentDate = new Date();
            for (const student of students) {
                let studentDue = 0;
                let dueMonthsList = [];
                if (!student.admissionDate) continue;
                const feeStructureRate = structureMap.get(`${student.classId}-${student.feeCategory}`) ?? structureMap.get(`${student.classId}-General`);
                const currentMonthlyFee = feeStructureRate ?? student.monthlyFee ?? 0;
                if (currentMonthlyFee === 0 && !paymentsMap.has(`${student.id}-${currentDate.getMonth() + 1}-${currentDate.getFullYear()}`)) continue;
                const admissionDate = new Date(student.admissionDate);
                for (let d = new Date(admissionDate.getFullYear(), admissionDate.getMonth(), 1); d <= currentDate; d.setMonth(d.getMonth() + 1)) {
                    const month = d.getMonth() + 1;
                    const year = d.getFullYear();
                    const paymentKey = `${student.id}-${month}-${year}`;
                    const paymentInfo = paymentsMap.get(paymentKey);
                    let expectedFee = paymentInfo?.historicalFee ?? feeStructureRate ?? student.monthlyFee ?? 0;
                    if (expectedFee === 0) continue;
                    const paidForMonth = paymentInfo?.paid || 0;
                    if (paidForMonth < expectedFee) {
                        studentDue += (expectedFee - paidForMonth);
                        dueMonthsList.push(`${d.toLocaleString('en-US', { month: 'short' })} '${String(year).slice(2)}`);
                    }
                }
                if (studentDue > 0) {
                    const className = classMap.get(student.classId) || 'N/A';
                    html += `<tr>
                <td>${student.rollNumber}</td>
                <td>${student.name}</td>
                <td>${className}</td>
                <td>${formatCurrency(studentDue)}</td>
                <td style="font-size: 0.8em;">${dueMonthsList.join(', ')}</td>
            </tr>`;
                }
            }
            html += `</tbody></table></div>`;
            return html;
        }
        async function generateStudentStrengthByClassReportJS(filters) {
            const classes = await getAllFromStore(STORES.CLASSES);
            const students = await getAllFromStore(STORES.STUDENTS);
            let totalStudentsOverall = 0;
            const reportDataItems = classes.map(cls => {
                const classStudents = students.filter(s => s.classId === cls.id);
                totalStudentsOverall += classStudents.length;
                return { className: cls.name, studentCount: classStudents.length };
            });
            let tableHTML = `<h3>Student Strength by Class</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>Class Name</th><th>Number of Students</th></tr></thead><tbody>`;
            reportDataItems.forEach(data => {
                tableHTML += `<tr><td>${data.className}</td><td>${data.studentCount}</td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr><td><strong>Total Students</strong></td><td><strong>${totalStudentsOverall}</strong></td></tr></tfoot></table></div>`;
            const chartCanvasId = `chart-std-strength-${Date.now()}`;
            tableHTML += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: 'Student Strength by Class',
                labels: reportDataItems.map(d => d.className),
                datasets: [{
                    label: 'Number of Students',
                    data: reportDataItems.map(d => d.studentCount),
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            };
            return { html: tableHTML, chartData: chartData };
        }
        async function generateStudentGenderRatioByClassReportJS(filters) {
            let classesToReportOn = [];
            if (filters.classId && !isNaN(filters.classId)) {
                const cls = await getFromStore(STORES.CLASSES, filters.classId);
                if (cls) classesToReportOn.push(cls);
            } else {
                classesToReportOn = await getAllFromStore(STORES.CLASSES);
            }
            const students = await getAllFromStore(STORES.STUDENTS);
            let overallMale = 0;
            let overallFemale = 0;
            let html = `<h3>Student Gender Ratio by Class</h3>`;
            const chartDataSets = [];
            for (const cls of classesToReportOn) {
                const classStudents = students.filter(s => s.classId === cls.id);
                const maleCount = classStudents.filter(s => s.gender === 'Male').length;
                const femaleCount = classStudents.filter(s => s.gender === 'Female').length;
                overallMale += maleCount;
                overallFemale += femaleCount;
                html += `<div class="form-container" style="margin-bottom:15px;">
                    <h4>Class: ${cls.name} (Total: ${classStudents.length})</h4>
                    <p>Male: ${maleCount} (${classStudents.length > 0 ? ((maleCount / classStudents.length) * 100).toFixed(1) : 0}%)</p>
                    <p>Female: ${femaleCount} (${classStudents.length > 0 ? ((femaleCount / classStudents.length) * 100).toFixed(1) : 0}%)</p>
                    <div style="height: 250px; position: relative;"><canvas id="chart-gender-${cls.id}-${Date.now()}"></canvas></div>
                 </div>`;
                chartDataSets.push({
                    canvasId: `chart-gender-${cls.id}-${Date.now()}`,
                    title: `Gender Ratio - ${cls.name}`,
                    labels: ['Male', 'Female'],
                    datasets: [{
                        data: [maleCount, femaleCount],
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'],
                    }]
                });
            }
            html += `<div class="form-container"><h4>Overall Gender Ratio</h4>
                <p>Total Male: ${overallMale}</p>
                <p>Total Female: ${overallFemale}</p>
                <div style="height: 300px; position: relative;"><canvas id="chart-gender-overall-${Date.now()}"></canvas></div>
              </div>`;
            chartDataSets.push({
                canvasId: `chart-gender-overall-${Date.now()}`,
                title: `Overall Gender Ratio`,
                labels: ['Male', 'Female'],
                datasets: [{
                    data: [overallMale, overallFemale],
                    backgroundColor: ['rgba(75, 192, 192, 0.7)', 'rgba(255, 159, 64, 0.7)'],
                }]
            });
            return { html: html, chartData: chartDataSets, chartType: 'pie_multi' };
        }
        async function generateStudentAdmissionTrendReportJS(filters) {
            const year = filters.year || new Date().getFullYear();
            const students = await getAllFromStore(STORES.STUDENTS);
            const monthlyAdmissions = Array(12).fill(0);
            students.forEach(s => {
                if (s.admissionDate) {
                    const admissionDate = new Date(s.admissionDate);
                    if (admissionDate.getFullYear() === year) {
                        monthlyAdmissions[admissionDate.getMonth()]++;
                    }
                }
            });
            const monthsEnglish = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            let tableHTML = `<h3>Monthly Admission Trend in ${year}</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>Month</th><th>New Admissions</th></tr></thead><tbody>`;
            monthlyAdmissions.forEach((count, index) => {
                tableHTML += `<tr><td>${monthsEnglish[index]}</td><td>${count}</td></tr>`;
            });
            tableHTML += `</tbody></table></div>`;
            const chartCanvasId = `chart-admission-trend-${Date.now()}`;
            tableHTML += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: `Monthly Admission Trend in ${year}`,
                labels: monthsEnglish,
                datasets: [{
                    label: 'New Admissions',
                    data: monthlyAdmissions,
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            };
            return { html: tableHTML, chartData: chartData };
        }
        async function generateFilteredStudentListReportJS(filters) {
            let students = await getAllFromStore(STORES.STUDENTS);
            if (filters.classId) {
                students = students.filter(s => s.classId === filters.classId);
            }
            if (filters.sectionId) {
                students = students.filter(s => s.sectionId === filters.sectionId);
            }
            if (filters.gender) {
                students = students.filter(s => s.gender === filters.gender);
            }
            let title = "Student List";
            if (filters.classId || filters.sectionId || filters.gender) title += " (Filtered)";
            let tableHTML = `<h3>${title} (Total: ${students.length})</h3>
                     <div class="table-container">
                       <table class="table">
                         <thead><tr><th>Roll No.</th><th>Name</th><th>Father's Name</th><th>Class</th><th>Section</th><th>Gender</th><th>Contact</th><th>Admission Date</th></tr></thead><tbody>`;
            for (const student of students) {
                const classData = student.classId ? await getFromStore(STORES.CLASSES, student.classId) : null;
                const sectionData = student.sectionId ? await getFromStore(STORES.SECTIONS, student.sectionId) : null;
                tableHTML += `<tr>
                        <td>${student.rollNumber || 'N/A'}</td>
                        <td>${student.name || 'N/A'}</td>
                        <td>${student.fatherName || 'N/A'}</td>
                        <td>${classData ? classData.name : 'N/A'}</td>
                        <td>${sectionData ? sectionData.name : 'N/A'}</td>
                        <td>${student.gender || 'N/A'}</td>
                        <td>${student.contact || 'N/A'}</td>
                        <td>${student.admissionDate ? formatDate(student.admissionDate) : 'N/A'}</td>
                      </tr>`;
            }
            tableHTML += `</tbody></table></div>`;
            return { html: tableHTML, chartData: null };
        }
        async function generateDailyAttendanceSummaryReportJS(filters) {
            const { date, classId, sectionId } = filters;
            if (!date) return { html: "<p>Please select a date.</p>", chartData: null };
            let attendanceRecords = await getAllFromIndex(STORES.ATTENDANCE, 'date', date);
            let allStudentsInScope = await getAllFromStore(STORES.STUDENTS);
            let reportTitle = `Daily Attendance Summary for ${formatDate(date)}`;
            if (classId && !isNaN(classId)) {
                const classInfo = await getFromStore(STORES.CLASSES, classId);
                reportTitle += ` - Class: ${classInfo?.name || 'N/A'}`;
                allStudentsInScope = allStudentsInScope.filter(s => s.classId === classId);
                attendanceRecords = attendanceRecords.filter(r => r.classId === classId);
                if (sectionId && !isNaN(sectionId)) {
                    const sectionInfo = await getFromStore(STORES.SECTIONS, sectionId);
                    reportTitle += ` - Section: ${sectionInfo?.name || 'N/A'}`;
                    allStudentsInScope = allStudentsInScope.filter(s => s.sectionId === sectionId);
                    attendanceRecords = attendanceRecords.filter(r => r.sectionId === sectionId);
                }
            }
            const totalStudents = allStudentsInScope.length;
            let presentCount = 0;
            let absentCount = 0;
            let leaveCount = 0;
            let lateCount = 0;
            const studentAttendanceMap = new Map();
            attendanceRecords.forEach(rec => studentAttendanceMap.set(rec.studentId, rec));
            allStudentsInScope.forEach(student => {
                const record = studentAttendanceMap.get(student.id);
                if (record) {
                    if (record.isLeave) leaveCount++;
                    else if (record.status === 'present') presentCount++;
                    else if (record.status === 'absent') absentCount++;
                    if (record.isLate) lateCount++;
                } else {
                    absentCount++;
                }
            });
            absentCount = totalStudents - presentCount - leaveCount;
            const attendancePercentage = totalStudents > 0 ? ((presentCount / totalStudents) * 100).toFixed(1) : 0;
            let html = `<h3>${reportTitle}</h3>`;
            html += `<div class="dashboard-cards" style="justify-content: space-around; flex-wrap:wrap;">
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">Total Students</div><div class="card-value">${totalStudents}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">Present</div><div class="card-value" style="color: #2ecc71;">${presentCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">Absent</div><div class="card-value" style="color: #e74c3c;">${absentCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">On Leave</div><div class="card-value" style="color: #f39c12;">${leaveCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">Late</div><div class="card-value" style="color: #e67e22;">${lateCount}</div></div>
                <div class="card" style="min-width:150px; margin:5px;"><div class="card-title">Attendance %</div><div class="card-value" style="color: #3498db;">${attendancePercentage}%</div></div>
             </div>`;
            const chartCanvasId = `chart-daily-attendance-${Date.now()}`;
            html += `<div style="height: 300px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: 'Daily Attendance Distribution',
                labels: ['Present', 'Absent', 'On Leave'],
                datasets: [{
                    data: [presentCount, absentCount, leaveCount],
                    backgroundColor: ['rgba(46, 204, 113, 0.7)', 'rgba(231, 76, 60, 0.7)', 'rgba(243, 156, 18, 0.7)'],
                }]
            };
            return { html: html, chartData: chartData };
        }
        async function generateMonthlyAttendanceByStudentReportJS(filters) {
            const { month, year, classId, sectionId, studentId } = filters;
            if (!month || !year || !classId) {
                return { html: "<p>Please select Month, Year, and Class. Section is optional.</p>", chartData: null };
            }
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('en-US', { month: 'long' });
            let html = `<h3>Monthly Attendance Report for ${monthName}, ${year}</h3>`;
            const sClass = await getFromStore(STORES.CLASSES, classId);
            html += `<p><strong>Class:</strong> ${sClass?.name || '-'}`;
            if (sectionId) {
                const sSection = await getFromStore(STORES.SECTIONS, sectionId);
                html += ` - <strong>Section:</strong> ${sSection?.name || '-'}`;
            }
            html += `</p>`;
            let studentsToReport = [];
            if (studentId && !isNaN(studentId)) {
                const student = await getFromStore(STORES.STUDENTS, studentId);
                if (student && student.classId === classId && (!sectionId || student.sectionId === sectionId)) studentsToReport.push(student);
            } else {
                studentsToReport = (await getAllFromStore(STORES.STUDENTS)).filter(s => s.classId === classId && (!sectionId || s.sectionId === sectionId));
            }
            if (studentsToReport.length === 0) return { html: html + "<p>No students found for this criteria.</p>", chartData: null };
            const allAttendance = await getAllFromStore(STORES.ATTENDANCE);
            html += `<div class="table-container"><table class="table">
                <thead><tr><th>Roll No.</th><th>Name</th><th>Total Days (Recorded)</th><th>Present</th><th>Absent</th><th>On Leave</th><th>Late</th><th>Attendance %</th></tr></thead>
                <tbody>`;
            const chartLabels = [];
            const presentDataset = [];
            const absentDataset = [];
            const leaveDataset = [];
            for (const student of studentsToReport) {
                const studentMonthlyAttendance = allAttendance.filter(r =>
                    r.studentId === student.id &&
                    new Date(r.date).getFullYear() === year &&
                    new Date(r.date).getMonth() + 1 === month
                );
                const totalRecordedDays = studentMonthlyAttendance.length;
                const present = studentMonthlyAttendance.filter(r => r.status === 'present' && !r.isLeave).length;
                const absent = studentMonthlyAttendance.filter(r => r.status === 'absent' && !r.isLeave).length;
                const onLeave = studentMonthlyAttendance.filter(r => r.isLeave).length;
                const late = studentMonthlyAttendance.filter(r => r.isLate).length;
                const effectiveDaysForPercentage = present + absent;
                const percentage = effectiveDaysForPercentage > 0 ? ((present / effectiveDaysForPercentage) * 100).toFixed(1) : (onLeave > 0 ? 'On Leave' : '0.0');
                html += `<tr>
                    <td>${student.rollNumber}</td>
                    <td>${student.name}</td>
                    <td>${totalRecordedDays}</td>
                    <td>${present}</td>
                    <td>${absent}</td>
                    <td>${onLeave}</td>
                    <td>${late}</td>
                    <td>${percentage}${percentage !== 'On Leave' ? '%' : ''}</td>
                 </tr>`;
                if (studentsToReport.length <= 15) {
                    chartLabels.push(student.name.split(" ")[0]);
                    presentDataset.push(present);
                    absentDataset.push(absent);
                    leaveDataset.push(onLeave);
                }
            }
            html += `</tbody></table></div>`;
            let chartData = null;
            if (studentsToReport.length > 0 && studentsToReport.length <= 15) {
                const chartCanvasId = `chart-monthly-stud-att-${Date.now()}`;
                html += `<div style="height: 400px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
                chartData = {
                    canvasId: chartCanvasId,
                    title: `${sClass?.name || ''} ${sectionId ? '- ' + (await getFromStore(STORES.SECTIONS, sectionId))?.name : ''} - Monthly Attendance`,
                    labels: chartLabels,
                    datasets: [
                        { label: 'Present', data: presentDataset, backgroundColor: 'rgba(46, 204, 113, 0.7)' },
                        { label: 'Absent', data: absentDataset, backgroundColor: 'rgba(231, 76, 60, 0.7)' },
                        { label: 'On Leave', data: leaveDataset, backgroundColor: 'rgba(243, 156, 18, 0.7)' }
                    ]
                };
            }
            return { html: html, chartData: chartData };
        }
        async function generateClassAttendancePercentageRangeReportJS(filters) {
            const { dateFrom, dateTo, classId } = filters;
            if (!dateFrom || !dateTo) {
                return { html: "<p>Please select a date range.</p>", chartData: null };
            }
            let classesToReport = [];
            if (classId && !isNaN(classId)) {
                const cls = await getFromStore(STORES.CLASSES, classId);
                if (cls) classesToReport.push(cls);
            } else {
                classesToReport = await getAllFromStore(STORES.CLASSES);
            }
            if (classesToReport.length === 0) return { html: "<p>No classes selected or available.</p>", chartData: null };
            const allAttendance = await getAllFromStore(STORES.ATTENDANCE);
            const allStudents = await getAllFromStore(STORES.STUDENTS);
            let html = `<h3>Class-wise Attendance Percentage (${formatDate(dateFrom)} - ${formatDate(dateTo)})</h3>`;
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>Class</th><th>Total Students</th><th>Total Recorded Attendance</th><th>Total Possible Attendance</th><th>Attendance %</th></tr></thead>
               <tbody>`;
            const chartLabels = [];
            const chartPercentages = [];
            for (const cls of classesToReport) {
                const studentsInClass = allStudents.filter(s => s.classId === cls.id);
                let totalPresentInClass = 0;
                let totalPossibleAttendancesInClass = 0;
                for (const student of studentsInClass) {
                    const studentAttendanceInRange = allAttendance.filter(r => {
                        const recordDate = new Date(r.date);
                        return r.studentId === student.id &&
                            recordDate >= new Date(dateFrom) &&
                            recordDate <= new Date(dateTo);
                    });
                    const nonLeaveRecords = studentAttendanceInRange.filter(r => !r.isLeave);
                    totalPossibleAttendancesInClass += nonLeaveRecords.length;
                    totalPresentInClass += nonLeaveRecords.filter(r => r.status === 'present').length;
                }
                const classPercentage = totalPossibleAttendancesInClass > 0 ?
                    ((totalPresentInClass / totalPossibleAttendancesInClass) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${cls.name}</td>
                    <td>${studentsInClass.length}</td>
                    <td>${totalPresentInClass}</td>
                    <td>${totalPossibleAttendancesInClass}</td>
                    <td>${classPercentage}%</td>
                 </tr>`;
                chartLabels.push(cls.name);
                chartPercentages.push(parseFloat(classPercentage));
            }
            html += `</tbody></table></div>`;
            const chartCanvasId = `chart-class-att-perc-${Date.now()}`;
            html += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: `Class-wise Attendance Percentage (${formatDate(dateFrom)} - ${formatDate(dateTo)})`,
                labels: chartLabels,
                datasets: [{
                    label: 'Attendance %',
                    data: chartPercentages,
                    backgroundColor: chartLabels.map(() => `rgba(${Math.floor(Math.random() * 155) + 100}, ${Math.floor(Math.random() * 155) + 100}, ${Math.floor(Math.random() * 155) + 100}, 0.7)`),
                    borderColor: chartLabels.map(() => `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`),
                    borderWidth: 1
                }]
            };
            return { html: html, chartData: chartData };
        }
        async function generateFeeCollectionDailySummaryReportJS(filters) {
            const { date } = filters;
            if (!date) return { html: "<p>Please select a date.</p>", chartData: null };
            const feeRecords = (await getAllFromStore(STORES.FEES)).filter(fr => fr.date === date);
            let totalCollected = 0;
            let byMethod = {};
            let byClass = {};
            const students = await getAllFromStore(STORES.STUDENTS);
            const studentMap = new Map(students.map(s => [s.id, s]));
            const classes = await getAllFromStore(STORES.CLASSES);
            const classMap = new Map(classes.map(c => [c.id, c]));
            feeRecords.forEach(rec => {
                totalCollected += rec.total || 0;
                byMethod[rec.paymentMethod] = (byMethod[rec.paymentMethod] || 0) + (rec.total || 0);
                const student = studentMap.get(rec.studentId);
                if (student && student.classId) {
                    const className = classMap.get(student.classId)?.name || 'Other';
                    byClass[className] = (byClass[className] || 0) + (rec.total || 0);
                }
            });
            let html = `<h3>Daily Fee Collection Summary for ${formatDate(date)}</h3>`;
            html += `<div class="dashboard-cards" style="justify-content: space-around; flex-wrap:wrap;">
               <div class="card" style="min-width:200px; margin:5px;">
                 <div class="card-title">Total Collection</div>
                 <div class="card-value">${formatCurrency(totalCollected)}</div>
               </div>
               <div class="card" style="min-width:200px; margin:5px;">
                 <div class="card-title">Number of Transactions</div>
                 <div class="card-value">${feeRecords.length}</div>
               </div>
            </div>`;
            html += `<h4>Collection by Payment Method</h4><div class="table-container"><table class="table">
               <thead><tr><th>Method</th><th>Amount</th></tr></thead><tbody>`;
            for (const method in byMethod) {
                html += `<tr><td>${method}</td><td>${formatCurrency(byMethod[method])}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            const chartCanvasIdMethods = `chart-fee-methods-${Date.now()}`;
            html += `<div style="height: 300px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasIdMethods}"></canvas></div>`;
            const charts = [];
            charts.push({
                type: 'pie',
                canvasId: chartCanvasIdMethods,
                title: 'Collection by Payment Method',
                labels: Object.keys(byMethod),
                datasets: [{ data: Object.values(byMethod), backgroundColor: Object.keys(byMethod).map(() => `rgba(${Math.floor(Math.random() * 200) + 55}, ${Math.floor(Math.random() * 200) + 55}, ${Math.floor(Math.random() * 200) + 55}, 0.7)`) }]
            });
            html += `<h4 style="margin-top:20px;">Collection by Class</h4><div class="table-container"><table class="table">
               <thead><tr><th>Class</th><th>Amount</th></tr></thead><tbody>`;
            for (const className in byClass) {
                html += `<tr><td>${className}</td><td>${formatCurrency(byClass[className])}</td></tr>`;
            }
            html += `</tbody></table></div>`;
            const chartCanvasIdClasses = `chart-fee-classes-${Date.now()}`;
            html += `<div style="height: 300px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasIdClasses}"></canvas></div>`;
            charts.push({
                type: 'bar',
                canvasId: chartCanvasIdClasses,
                title: 'Collection by Class',
                labels: Object.keys(byClass),
                datasets: [{ label: 'Amount Collected', data: Object.values(byClass), backgroundColor: 'rgba(153, 102, 255, 0.6)' }]
            });
            return { html: html, chartData: charts, chartType: 'multi' };
        }
        async function generateFeeCollectionMonthlyByClassReportJS(filters) {
            const { month, year, classId } = filters;
            if (!month || !year) return { html: "<p>Please select Month and Year.</p>", chartData: null };
            let classesToReport = [];
            if (classId && !isNaN(classId)) {
                const cls = await getFromStore(STORES.CLASSES, classId);
                if (cls) classesToReport.push(cls);
            } else {
                classesToReport = await getAllFromStore(STORES.CLASSES);
            }
            if (classesToReport.length === 0) return { html: "<p>No classes selected or available.</p>", chartData: null };
            const feeRecords = (await getAllFromStore(STORES.FEES)).filter(fr => parseInt(fr.month) === month && parseInt(fr.year) === year);
            const students = await getAllFromStore(STORES.STUDENTS);
            const monthName = new Date(year, month - 1, 1).toLocaleDateString('en-US', { month: 'long' });
            let html = `<h3>Monthly Fee Collection (Class-wise) for ${monthName}, ${year}</h3>`;
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>Class</th><th>Total Students</th><th>Students Paid</th><th>Total Expected Fee</th><th>Total Collected</th><th>Collection %</th></tr></thead>
               <tbody>`;
            const chartLabels = [];
            const chartCollected = [];
            const chartExpected = [];
            let grandTotalExpected = 0;
            let grandTotalCollected = 0;
            for (const cls of classesToReport) {
                const studentsInClass = students.filter(s => s.classId === cls.id);
                let classTotalCollected = 0;
                let classPaidCount = 0;
                let classTotalExpected = 0;
                for (const student of studentsInClass) {
                    const feeStructure = await getFeeStructureForStudent(student.id, cls.id, student.feeCategory);
                    classTotalExpected += feeStructure?.monthlyFee || student.monthlyFee || 0;
                    const studentFeeRecord = feeRecords.find(fr => fr.studentId === student.id);
                    if (studentFeeRecord) {
                        classTotalCollected += studentFeeRecord.total || 0;
                        classPaidCount++;
                    }
                }
                grandTotalExpected += classTotalExpected;
                grandTotalCollected += classTotalCollected;
                const collectionPercentage = classTotalExpected > 0 ? ((classTotalCollected / classTotalExpected) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${cls.name}</td>
                    <td>${studentsInClass.length}</td>
                    <td>${classPaidCount}</td>
                    <td>${formatCurrency(classTotalExpected)}</td>
                    <td>${formatCurrency(classTotalCollected)}</td>
                    <td>${collectionPercentage}%</td>
                 </tr>`;
                chartLabels.push(cls.name);
                chartCollected.push(classTotalCollected);
                chartExpected.push(classTotalExpected);
            }
            html += `</tbody><tfoot>
                <tr>
                    <td colspan="3"><strong>Overall</strong></td>
                    <td><strong>${formatCurrency(grandTotalExpected)}</strong></td>
                    <td><strong>${formatCurrency(grandTotalCollected)}</strong></td>
                    <td><strong>${grandTotalExpected > 0 ? ((grandTotalCollected / grandTotalExpected) * 100).toFixed(1) : 0}%</strong></td>
                </tr>
             </tfoot></table></div>`;
            const chartCanvasId = `chart-monthly-fee-class-${Date.now()}`;
            html += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: `${monthName}, ${year} - Fee Collection (Expected vs. Collected)`,
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Expected Fee',
                        data: chartExpected,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Collected Fee',
                        data: chartCollected,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            };
            return { html: html, chartData: chartData };
        }
        async function getFeeStructureForStudent(studentId, classId, feeCategory) {
            const feeStructures = await getAllFromStore(STORES.FEE_STRUCTURE);
            let structure = feeStructures.find(fs => fs.classId === classId && fs.category === feeCategory);
            if (!structure) {
                structure = feeStructures.find(fs => fs.classId === classId && fs.category === 'General');
            }
            return structure || { monthlyFee: 0, admissionFee: 0, examFee: 0, computerFee: 0, transportFee: 0, otherFee: 0 };
        }
        async function generateFeeDefaultersListReportJS(filters) {
            const { month, year, classId, sectionId } = filters;
            if (!month || !year) return { html: "<p>Please select Month and Year.</p>", chartData: null };
            let studentsToList = await getAllFromStore(STORES.STUDENTS);
            const feeRecordsForMonth = (await getAllFromStore(STORES.FEES)).filter(fr => parseInt(fr.month) === month && parseInt(fr.year) === year);
            const paidStudentIds = new Set(feeRecordsForMonth.map(fr => fr.studentId));
            let reportTitle = `Fee Defaulters for ${new Date(year, month - 1, 1).toLocaleDateString('en-US', { month: 'long' })}, ${year}`;
            if (classId && !isNaN(classId)) {
                studentsToList = studentsToList.filter(s => s.classId === classId);
                const clsInfo = await getFromStore(STORES.CLASSES, classId);
                reportTitle += ` - Class: ${clsInfo?.name || 'N/A'}`;
                if (sectionId && !isNaN(sectionId)) {
                    studentsToList = studentsToList.filter(s => s.sectionId === sectionId);
                    const secInfo = await getFromStore(STORES.SECTIONS, sectionId);
                    reportTitle += ` - Section: ${secInfo?.name || 'N/A'}`;
                }
            }
            const defaulters = studentsToList.filter(s => !paidStudentIds.has(s.id));
            let html = `<h3>${reportTitle} (Total Defaulters: ${defaulters.length})</h3>`;
            if (defaulters.length === 0) {
                html += "<p>No defaulters for this month. Great job!</p>";
                return { html: html, chartData: null };
            }
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>Roll No.</th><th>Name</th><th>Father's Name</th><th>Class</th><th>Section</th><th>Expected Fee</th><th>Contact No.</th></tr></thead>
               <tbody>`;
            let totalDefaultAmount = 0;
            for (const student of defaulters) {
                const classData = student.classId ? await getFromStore(STORES.CLASSES, student.classId) : null;
                const sectionData = student.sectionId ? await getFromStore(STORES.SECTIONS, student.sectionId) : null;
                const feeStructure = await getFeeStructureForStudent(student.id, student.classId, student.feeCategory);
                const expectedFee = feeStructure?.monthlyFee || student.monthlyFee || 0;
                totalDefaultAmount += expectedFee;
                html += `<tr>
                    <td>${student.rollNumber || 'N/A'}</td>
                    <td>${student.name || 'N/A'}</td>
                    <td>${student.fatherName || 'N/A'}</td>
                    <td>${classData?.name || 'N/A'}</td>
                    <td>${sectionData?.name || 'N/A'}</td>
                    <td>${formatCurrency(expectedFee)}</td>
                    <td>${student.contact || 'N/A'}</td>
                 </tr>`;
            }
            html += `</tbody><tfoot><tr><td colspan="5"><strong>Total Due Amount</strong></td><td colspan="2"><strong>${formatCurrency(totalDefaultAmount)}</strong></td></tr></tfoot></table></div>`;
            return { html: html, chartData: null };
        }
        async function generateFeeCategoryWiseCollectionReportJS(filters) {
            const { dateFrom, dateTo } = filters;
            if (!dateFrom || !dateTo) {
                return { html: "<p>Please select a date range.</p>", chartData: null };
            }
            const feeRecords = (await getAllFromStore(STORES.FEES)).filter(fr => {
                const recDate = new Date(fr.date);
                return recDate >= new Date(dateFrom) && recDate <= new Date(dateTo);
            });
            const students = await getAllFromStore(STORES.STUDENTS);
            const studentMap = new Map(students.map(s => [s.id, s]));
            const collectionByCategory = {};
            let totalCollected = 0;
            feeRecords.forEach(rec => {
                const student = studentMap.get(rec.studentId);
                const category = student?.feeCategory || 'Unknown';
                collectionByCategory[category] = (collectionByCategory[category] || 0) + (rec.total || 0);
                totalCollected += (rec.total || 0);
            });
            let html = `<h3>Fee Category-wise Collection (${formatDate(dateFrom)} - ${formatDate(dateTo)})</h3>`;
            html += `<p><strong>Total Collected: ${formatCurrency(totalCollected)}</strong></p>`;
            html += `<div class="table-container"><table class="table">
               <thead><tr><th>Fee Category</th><th>Collected Amount</th><th>Share %</th></tr></thead><tbody>`;
            for (const category in collectionByCategory) {
                const percentage = totalCollected > 0 ? ((collectionByCategory[category] / totalCollected) * 100).toFixed(1) : 0;
                html += `<tr>
                    <td>${category}</td>
                    <td>${formatCurrency(collectionByCategory[category])}</td>
                    <td>${percentage}%</td>
                 </tr>`;
            }
            html += `</tbody></table></div>`;
            const chartCanvasId = `chart-fee-cat-coll-${Date.now()}`;
            html += `<div style="height: 350px; margin-top: 20px; position: relative;"><canvas id="${chartCanvasId}"></canvas></div>`;
            const chartData = {
                canvasId: chartCanvasId,
                title: 'Fee Category-wise Collection',
                labels: Object.keys(collectionByCategory),
                datasets: [{
                    data: Object.values(collectionByCategory),
                    backgroundColor: Object.keys(collectionByCategory).map((_, i) => `hsl(${(i * 360 / Object.keys(collectionByCategory).length) % 360}, 70%, 60%)`),
                }]
            };
            return { html: html, chartData: chartData };
        }
        async function initializeIdCardsView() {
            const classDropdown = document.getElementById('id-card-class-filter');
            const studentDropdown = document.getElementById('certificate-student-filter');
            classDropdown.innerHTML = '<option value="">All Classes</option>';
            studentDropdown.innerHTML = '<option value="">Select Student</option>';
            const classes = await getAllFromStore(STORES.CLASSES);
            const students = await getAllFromStore(STORES.STUDENTS);
            classes.forEach(c => classDropdown.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            students.sort((a, b) => a.name.localeCompare(b.name, 'en')).forEach(s => studentDropdown.innerHTML += `<option value="${s.id}">${s.name} (${s.rollNumber})</option>`);
            document.getElementById('id-card-class-filter').addEventListener('change', async () => {
                const classId = parseInt(document.getElementById('id-card-class-filter').value);
                const sectionDropdown = document.getElementById('id-card-section-filter');
                sectionDropdown.innerHTML = '<option value="">All Sections</option>';
                if (classId) {
                    const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                    sections.forEach(s => sectionDropdown.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                }
            });
            document.getElementById('certificate-type').addEventListener('change', (e) => {
                document.getElementById('achievement-details-row').style.display = (e.target.value === 'achievement') ? 'flex' : 'none';
            });
            document.getElementById('generate-id-cards-btn').addEventListener('click', generateIdCards);
            document.getElementById('generate-certificate-btn').addEventListener('click', generateCertificate);
            document.getElementById('bulk-export-zip-btn').addEventListener('click', exportAllCardsAsZip);
        }
        // Add this NEW function before generateCertificate
        function setupCertificateInteraction(studentId) {
            const certificateFrames = ['bgc.png', 'bgc2.png', 'bgc3.png', 'bgc4.png', 'bgc5.png'];
            let currentFrameIndex = 0;
            const certContainer = document.getElementById(`cert-container-${studentId}`);

            // Load saved frame from localStorage
            const savedFrameIndex = localStorage.getItem(`certFrame_${studentId}`);
            if (savedFrameIndex !== null) {
                currentFrameIndex = parseInt(savedFrameIndex, 10);
            }
            certContainer.style.backgroundImage = `url(${certificateFrames[currentFrameIndex]})`;

            // Add event listeners for frame switching
            document.getElementById('cert-prev-frame').addEventListener('click', () => {
                currentFrameIndex = (currentFrameIndex - 1 + certificateFrames.length) % certificateFrames.length;
                certContainer.style.backgroundImage = `url(${certificateFrames[currentFrameIndex]})`;
                localStorage.setItem(`certFrame_${studentId}`, currentFrameIndex);
            });

            document.getElementById('cert-next-frame').addEventListener('click', () => {
                currentFrameIndex = (currentFrameIndex + 1) % certificateFrames.length;
                certContainer.style.backgroundImage = `url(${certificateFrames[currentFrameIndex]})`;
                localStorage.setItem(`certFrame_${studentId}`, currentFrameIndex);
            });

            // Make elements editable and handle saving
            const editableElements = certContainer.querySelectorAll('[data-editable-id]');
            editableElements.forEach(el => {
                const editableId = el.dataset.editableId;

                // Load saved text from localStorage
                const savedText = localStorage.getItem(`certText_${studentId}_${editableId}`);
                if (savedText) {
                    el.innerHTML = savedText;
                }

                // Save text on edit
                el.addEventListener('blur', () => {
                    localStorage.setItem(`certText_${studentId}_${editableId}`, el.innerHTML);
                    showNotification('Certificate text saved!', 'info');
                });
            });
        }
        // Find and completely REPLACE this function
        async function generateCertificate() {
            showLoading();
            const certType = document.getElementById('certificate-type').value;
            const studentId = parseInt(document.getElementById('certificate-student-filter').value);
            const outputDiv = document.getElementById('certificate-output');
            outputDiv.innerHTML = '';

            if (!studentId) {
                showNotification('Please select a student.', 'error');
                hideLoading();
                return;
            }

            const student = await getFromStore(STORES.STUDENTS, studentId);
            const settings = await getFromStore(STORES.SETTINGS, 'general');
            const schoolName = settings?.schoolName || "Deeni Madrasa";
            const principalName = settings?.principalName || "Principal";
            const className = student.classId ? (await getFromStore(STORES.CLASSES, student.classId))?.name : '';
            const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            let title = "";
            let body = "";

            switch (certType) {
                case 'promotion':
                    title = "Promotion Certificate";
                    body = `<p data-editable-id="cert_body" contenteditable="true">This certifies that student <b>${student.name}</b> son/daughter of <b>${student.fatherName}</b> has successfully completed Class <b>${className}</b> and is promoted to the next class. We wish them all the best for their future endeavors.</p>`;
                    break;
                case 'leaving':
                    title = "Leaving Certificate";
                    body = `<p data-editable-id="cert_body" contenteditable="true">This certifies that student <b>${student.name}</b> son/daughter of <b>${student.fatherName}</b>, Roll No. <b>${student.rollNumber}</b>, has been studying in our institution. This certificate is issued to them. We wish them a bright future.</p>`;
                    break;
                case 'character':
                    title = "Character Certificate";
                    body = `<p data-editable-id="cert_body" contenteditable="true">This certifies that student <b>${student.name}</b> son/daughter of <b>${student.fatherName}</b> is known to our institution as a student of good character and excellent morals. Their conduct with teachers and fellow students has always been positive.</p>`;
                    break;
                case 'achievement':
                    title = "Achievement Certificate";
                    const achievement = document.getElementById('achievement-description').value || 'Outstanding Performance';
                    body = `<p data-editable-id="cert_body" contenteditable="true">This certificate is presented to student <b>${student.name}</b> son/daughter of <b>${student.fatherName}</b> for their <b>${achievement}</b>. The institution is proud of their remarkable achievement.</p>`;
                    break;
            }

            // Notice the new data-editable-id attributes and the new controls section
            const certificateHTML = `
    <div class="certificate-wrapper" id="cert-wrapper-${student.id}">
        <div class="certificate-controls no-print">
            <button id="cert-prev-frame" class="cert-frame-btn" title="Previous Frame">❮</button>
            <span style="font-style: italic;">Click any text to edit. Changes are saved automatically.</span>
            <button id="cert-next-frame" class="cert-frame-btn" title="Next Frame">❯</button>
        </div>
        <button title="Download PNG" class="card-export-btn no-print" onclick="exportElementAsPNG('cert-container-${student.id}', 'Certificate-${student.rollNumber}.png')">↓</button>
        <div class="certificate-container" id="cert-container-${student.id}">
            <h2 data-editable-id="school_name" contenteditable="true">${schoolName}</h2>
            <h3 data-editable-id="cert_title" contenteditable="true">${title}</h3>
            <hr>
            <div style="text-align: left; margin-top: 40px;">
                ${body}
            </div>
            <div class="certificate-signature">
                <div data-editable-id="cert_date" contenteditable="true">Date: ${today}</div>
                <div data-editable-id="cert_signature_title" contenteditable="true">
                    <img src="sign.png" alt="Signature" style="height: 56px;display: block;margin: -41px auto 5px;position: absolute;">
                    Principal's Signature
                </div>
            </div>
        </div>
    </div>`;

            outputDiv.innerHTML = certificateHTML;

            // Call the new function to activate the features
            setupCertificateInteraction(studentId);

            hideLoading();
        }
        async function exportElementAsPNG(elementId, filename) {
            const element = document.getElementById(elementId);
            if (!element) return;
            showLoading();
            const buttonsToHide = document.querySelectorAll('.card-export-btn, .card-export-btn-back');
            const noPrintElements = document.querySelectorAll('.no-print');
            buttonsToHide.forEach(btn => btn.style.display = 'none');
            noPrintElements.forEach(el => el.style.display = 'none');
            try {
                const canvas = await html2canvas(element, { scale: 3, useCORS: true, backgroundColor: null });
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error("PNG Export failed:", err);
                showNotification("PNG export failed.", "error");
            } finally {
                buttonsToHide.forEach(btn => btn.style.display = '');
                noPrintElements.forEach(el => el.style.display = '');
                hideLoading();
            }
        }
        function generateQrCode(elementId, text) {
            const el = document.getElementById(elementId);
            if (el) {
                new QRCode(el, {
                    text: text,
                    width: 80,
                    height: 80,
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
        async function handleImageUpload(event, memberId, memberType) {
            const file = event.target.files[0];
            if (!file) return;
            showLoading();
            const reader = new FileReader();
            reader.onload = async (e) => {
                const b64 = e.target.result;
                const imgElement = document.getElementById(`photo-${memberType}-${memberId}`);
                const qrContainer = document.getElementById(`qr-container-${memberId}`);
                if (imgElement) {
                    imgElement.src = b64;
                    imgElement.style.display = 'block';
                }
                if (qrContainer) qrContainer.style.display = 'none';
                const storeName = memberType === 'students' ? STORES.STUDENTS : STORES.TEACHERS;
                await updateInStore(storeName, memberId, { photo: b64 });
                hideLoading();
                showNotification("Photo updated successfully.", "success");
            };
            reader.readAsDataURL(file);
        }
        async function initializeIdCardsView() {
            const classDropdown = document.getElementById('id-card-class-filter');
            const studentDropdown = document.getElementById('certificate-student-filter');
            classDropdown.innerHTML = '<option value="">All Classes</option>';
            studentDropdown.innerHTML = '<option value="">Select Student</option>';
            const classes = await getAllFromStore(STORES.CLASSES);
            const students = await getAllFromStore(STORES.STUDENTS);
            classes.forEach(c => classDropdown.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            students.sort((a, b) => a.name.localeCompare(b.name, 'en')).forEach(s => studentDropdown.innerHTML += `<option value="${s.id}">${s.name} (${s.rollNumber})</option>`);
            document.getElementById('id-card-class-filter').addEventListener('change', async () => {
                const classId = parseInt(document.getElementById('id-card-class-filter').value);
                const sectionDropdown = document.getElementById('id-card-section-filter');
                sectionDropdown.innerHTML = '<option value="">All Sections</option>';
                if (classId) {
                    const sections = await getAllFromIndex(STORES.SECTIONS, 'classId', classId);
                    sections.forEach(s => sectionDropdown.innerHTML += `<option value="${s.id}">${s.name}</option>`);
                }
            });
            document.getElementById('certificate-type').addEventListener('change', (e) => {
                document.getElementById('achievement-details-row').style.display = (e.target.value === 'achievement') ? 'flex' : 'none';
            });
            document.getElementById('generate-id-cards-btn').addEventListener('click', generateIdCards);
            document.getElementById('generate-certificate-btn').addEventListener('click', generateCertificate);
            document.getElementById('bulk-export-zip-btn').addEventListener('click', exportAllCardsAsZip);
        }
        async function generateIdCards() {
            showLoading();
            const memberType = document.getElementById('id-card-member-type').value;
            const classId = parseInt(document.getElementById('id-card-class-filter').value);
            const sectionId = parseInt(document.getElementById('id-card-section-filter').value);
            const outputDiv = document.getElementById('id-card-output');
            outputDiv.innerHTML = '';
            const storeName = memberType === 'students' ? STORES.STUDENTS : STORES.TEACHERS;
            let members = await getAllFromStore(storeName);
            if (memberType === 'students') {
                if (classId) members = members.filter(s => s.classId === classId);
                if (sectionId) members = members.filter(s => s.sectionId === sectionId);
            }
            if (members.length === 0) {
                outputDiv.innerHTML = '<p>No records found.</p>';
                hideLoading();
                return;
            }
            const settings = await getFromStore(STORES.SETTINGS, 'general');
            if (settings && settings.language === 'ur') {
                document.querySelectorAll('.id-card-details').forEach(el => el.style.textAlign = 'right');
                document.querySelectorAll('.id-card-back').forEach(el => el.style.textAlign = 'right');
                document.querySelectorAll('.id-card-photo').forEach(el => {
                    el.style.marginRight = '0';
                    el.style.marginLeft = '10px';
                });
                document.querySelectorAll('.card-export-btn').forEach(el => {
                    el.style.left = 'auto';
                    el.style.right = '36px';
                });
                document.querySelectorAll('.card-export-btn-back').forEach(el => {
                    el.style.left = 'auto';
                    el.style.right = '70px';
                });
            } else {
                document.querySelectorAll('.id-card-details').forEach(el => el.style.textAlign = 'left');
                document.querySelectorAll('.id-card-back').forEach(el => el.style.textAlign = 'left');
                document.querySelectorAll('.id-card-photo').forEach(el => {
                    el.style.marginRight = '10px';
                    el.style.marginLeft = '0';
                });
                document.querySelectorAll('.card-export-btn').forEach(el => {
                    el.style.left = '36px';
                    el.style.right = 'auto';
                });
                document.querySelectorAll('.card-export-btn-back').forEach(el => {
                    el.style.left = '70px';
                    el.style.right = 'auto';
                });
            }
            const schoolName = settings?.schoolName || "Deeni Madrasa";
            const schoolAddress = settings?.schoolAddress || "Address not set";
            const schoolPhone = settings?.schoolPhone || "Phone not set";
            const schoolWebsite = settings?.schoolWebsite || "Website not set";
            const backSideQRs = [];
            for (const member of members) {
                const memberId = member.id;
                const memberIdentifier = member.rollNumber || member.employeeId;
                const className = member.classId ? (await getFromStore(STORES.CLASSES, member.classId))?.name : '';
                const dbPhoto = member.photo;
                const photoSrc = dbPhoto;
                const qrText = `ID: ${memberIdentifier}\nName: ${member.name}`;
                const cardHTML = `
        <div class="card-wrapper" id="wrapper-${memberType}-${memberId}">
            <button title="Download Front" class="card-export-btn no-print" onclick="exportElementAsPNG('front-${memberType}-${memberId}', 'ID-Card-${memberIdentifier}-Front.png')">F↓</button>
            <button title="Download Back" class="card-export-btn-back no-print" onclick="exportElementAsPNG('back-${memberType}-${memberId}', 'ID-Card-${memberIdentifier}-Back.png')">B↓</button>
            <div class="id-card-front" id="front-${memberType}-${memberId}">
                <div class="id-card-header">${schoolName}</div>
                <div class="id-card-content">
                    <div class="id-card-photo-container" onclick="document.getElementById('upload-${memberType}-${memberId}').click()">
                       <img id="photo-${memberType}-${memberId}" src="${photoSrc}" alt="Photo" class="id-card-photo" 
                            onerror="showQrCode('qr-container-${memberId}', '${qrText}', this.id)" ${photoSrc ? '' : 'style="display:none;"'}>
                       <div id="qr-container-${memberId}" class="id-card-qr-code" ${photoSrc ? 'style="display:none;"' : ''}></div>
                    </div>
                    <input type="file" id="upload-${memberType}-${memberId}" style="display:none;" accept="image/*" onchange="handleImageUpload(event, ${memberId}, '${memberType}')">
                    <div class="id-card-details">
                        <b>Name:</b> ${member.name}<br>
                        ${memberType === 'students' ? `<b>Father:</b> ${member.fatherName || '-'}<br>` : ''}
                        <b>ID:</b> ${memberIdentifier}<br>
                        ${memberType === 'students' ? `<b>Class:</b> ${className}<br>` : `<b>Designation:</b> Teacher<br>`}
                        <b>Issued:</b> ${new Date().toLocaleDateString('en-US')}
                    </div>
                </div>
            </div>
            <div class="id-card-back" id="back-${memberType}-${memberId}">
                <h4>${schoolName}</h4>
                <p style="font-size: 11px;">This card is property of the institution. In case of loss, please return or notify at the address below.</p>
                <p><b>Address:</b> ${schoolAddress}</p>
                <p><b>Phone:</b> ${schoolPhone}</p>
                <div id="qr-back-${memberId}" class="id-card-qr-code"></div>
            </div>
        </div>`;
                outputDiv.innerHTML += cardHTML;
                /* for printing website QR code
                backSideQRs.push({ id: `qr-back-${memberId}`, text: schoolWebsite });
                 */
                backSideQRs.push({ id: `qr-back-${memberId}`, text: qrText });
                if (!dbPhoto) {
                    showQrCode(`qr-container-${memberId}`, qrText, `photo-${memberType}-${memberId}`);
                }
            }
            backSideQRs.forEach(item => {
                generateQrCode(item.id, item.text);
            });
            hideLoading();
        }
        async function exportAllCardsAsZip() {
            showLoading();
            const zip = new JSZip();
            const cardWrappers = document.querySelectorAll('#id-card-output .card-wrapper');
            if (cardWrappers.length === 0) {
                showNotification("No cards to export.", "info");
                hideLoading();
                return;
            }
            try {
                const promises = Array.from(cardWrappers).map(async (wrapper) => {
                    const frontEl = wrapper.querySelector('.id-card-front');
                    const backEl = wrapper.querySelector('.id-card-back');
                    const [_, memberType, memberId] = frontEl.id.split('-');
                    const member = await getFromStore(memberType === 'students' ? STORES.STUDENTS : STORES.TEACHERS, parseInt(memberId));
                    const fileNameBase = `${member.rollNumber || member.employeeId}_${member.name.replace(/\s/g, '_')}`;
                    const frontCanvas = await html2canvas(frontEl, { scale: 3, useCORS: true, backgroundColor: null });
                    const backCanvas = await html2canvas(backEl, { scale: 3, useCORS: true, backgroundColor: null });
                    zip.file(`${fileNameBase}_Front.png`, await new Promise(r => frontCanvas.toBlob(r, 'image/png')));
                    zip.file(`${fileNameBase}_Back.png`, await new Promise(r => backCanvas.toBlob(r, 'image/png')));
                });
                await Promise.all(promises);
                const zipBlob = await zip.generateAsync({ type: "blob" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(zipBlob);
                link.download = `ID_Cards_${new Date().toISOString().slice(0, 10)}.zip`;
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (err) {
                console.error("ZIP Export failed:", err);
                showNotification("ZIP export failed.", "error");
            } finally {
                hideLoading();
            }
        }
        function createLoginModal() {
            const loginModalHTML = `
        <div id="login-modal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; font-family: Arial, sans-serif;">
            <div style="background: white; padding: 40px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 400px; max-width: 90%;">
                <h2 style="margin-top: 0; color: #333;">Login</h2>
                <p style="color: #666;">Please enter your credentials to access the application.</p>
                <input type="text" id="login-username" placeholder="Username" style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                <input type="password" id="login-password" placeholder="Password" style="width: 100%; padding: 12px; font-size: 16px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
                <button id="login-btn" style="width: 100%; padding: 12px; font-size: 16px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Login</button>
                <p id="login-error" style="color: red; margin-top: 15px; height: 20px;"></p>
            </div>
        </div>
    `;
            document.body.insertAdjacentHTML('beforeend', loginModalHTML);
        }
        async function editTeacher(id) {
            showLoading();
            try {
                const teacher = await getFromStore(STORES.TEACHERS, id);
                if (!teacher) {
                    showNotification('Teacher not found.', 'error');
                    return;
                }
                const form = document.getElementById('teacher-form');
                form.dataset.editId = id;
                document.getElementById('teacher-name').value = teacher.name;
                document.getElementById('teacher-father').value = teacher.fatherName;
                document.getElementById('teacher-dob').value = teacher.dob;
                document.getElementById('teacher-gender').value = teacher.gender;
                document.getElementById('teacher-qualification').value = teacher.qualification;
                document.getElementById('teacher-specialization').value = teacher.specialization;
                document.getElementById('teacher-contact').value = teacher.contact;
                document.getElementById('teacher-email').value = teacher.email;
                document.getElementById('teacher-address').value = teacher.address;
                document.getElementById('teacher-cnic').value = teacher.cnic;
                document.getElementById('teacher-joining-date').value = teacher.joiningDate;
                document.getElementById('teacher-basic-salary').value = teacher.basicSalary;
                document.getElementById('teacher-allowances').value = teacher.allowances;
                document.getElementById('teacher-deductions').value = teacher.deductions;
                document.getElementById('teacher-notes').value = teacher.notes;
                Array.from(document.getElementById('teacher-subject').options).forEach(opt => {
                    opt.selected = teacher.subjects && teacher.subjects.includes(opt.value);
                });
                Array.from(document.getElementById('teacher-class').options).forEach(opt => {
                    opt.selected = teacher.classes && teacher.classes.includes(opt.value);
                });
                document.querySelector('.tab[data-tab="add-teacher"]').click();
                form.querySelector('button[type="submit"]').textContent = 'Update Teacher';
            } catch (e) {
                console.error('Error preparing teacher for edit:', e);
                showNotification('Could not load teacher data.', 'error');
            } finally {
                hideLoading();
            }
        }
        function showQrCode(qrContainerId, text, imgIdToHide) {
            const imgEl = document.getElementById(imgIdToHide);
            const qrContainer = document.getElementById(qrContainerId);
            if (imgEl) {
                imgEl.style.display = 'none';
                imgEl.src = '';
            }
            if (qrContainer) {
                qrContainer.style.display = 'flex';
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: text,
                    width: 80,
                    height: 80,
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
        (function () {
            const translations = {
                'search': { selector: '.btn-primary', en: 'Search', ur: 'تلاش کریں', isGeneric: true, matchingText: 'Search' },
                'reset_form': { selector: '.btn-danger', en: 'Reset Form', ur: 'فارم ری سیٹ کریں', isGeneric: true, matchingText: 'Reset Form' },
                'save_settings': { selector: '.btn-primary', en: 'Save Settings', ur: 'ترتیبات محفوظ کریں', isGeneric: true, matchingText: 'Save Settings' },
                'print': { selector: '.btn-success', en: 'Print', ur: 'پرنٹ کریں', isGeneric: true, matchingText: 'Print' },
                'action': { selector: '.table th', en: 'Action', ur: 'عمل', isGeneric: true, matchingText: 'Action' },
                'edit': { selector: '.btn-primary.btn-sm', en: 'Edit', ur: 'ترمیم', isGeneric: true, matchingText: 'Edit' },
                'delete': { selector: '.btn-danger.btn-sm', en: 'Delete', ur: 'حذف کریں', isGeneric: true, matchingText: 'Delete' },
                'class': { selector: '.table th, .form-label', en: 'Class', ur: 'کلاس', isGeneric: true, matchingText: 'Class' },
                'section': { selector: '.table th, .form-label', en: 'Section', ur: 'سیکشن', isGeneric: true, matchingText: 'Section' },
                'contact_no': { selector: '.table th, .form-label', en: 'Contact No.', ur: 'رابطہ نمبر', isGeneric: true, matchingText: 'Contact No.' },
                'email': { selector: 'label.form-label', en: 'Email', ur: 'ای میل', isGeneric: true, matchingText: 'Email' },
                'dob': { selector: '.form-label', en: 'Date of Birth', ur: 'تاریخِ پیدائش', isGeneric: true, matchingText: '^Date of Birth$' },
                'admission_date': { selector: '.form-label', en: 'Admission Date', ur: 'داخلے کی تاریخ', isGeneric: true, matchingText: '^Admission Date$' },
                'joining_date': { selector: 'label[for$="-joining-date"]', en: 'Joining Date', ur: 'شمولیت کی تاریخ', isGeneric: true, matchingText: 'Joining Date' },
                'notes': { selector: 'label.form-label', en: 'Note', ur: 'نوٹ', isGeneric: true, matchingText: 'Note' },
                'details': { selector: '.table th, label.form-label', en: 'Details', ur: 'تفصیلات', isGeneric: true, matchingText: 'Details' },
                'additional_info': { selector: 'label.form-label', en: 'Additional Info', ur: 'اضافی معلومات', isGeneric: true, matchingText: 'Additional Info' },
                'student_name': { selector: '.form-label', en: 'Student Name', ur: 'طالب علم کا نام', isGeneric: true, matchingText: '^Student Name$' },
                'father_name': { selector: '.form-label', en: "Father's Name", ur: 'والد کا نام', isGeneric: true, matchingText: "^Father's Name$" },
                'guardian_name': { selector: '.form-label', en: 'Guardian Name', ur: 'سرپرست کا نام', isGeneric: true, matchingText: '^Guardian Name$' },
                'dob': { selector: '.form-label', en: 'Date of Birth', ur: 'تاریخِ پیدائش', isGeneric: true, matchingText: 'Date of Birth' },
                'gender': { selector: '.form-label', en: 'Gender', ur: 'جنس', isGeneric: true, matchingText: 'Gender' },
                'address': { selector: '.form-label', en: 'Full Address', ur: 'مکمل پتہ', isGeneric: true, matchingText: 'Full Address' },
                'photo': { selector: '.form-label', en: 'Photo', ur: 'تصویر', isGeneric: true, matchingText: 'Student Photo|Teacher Photo|Staff Photo|User Photo' },
                'header_title': { selector: '.header h1', en: 'School & Madrasa Management App', ur: 'اسکول و مدرسہ مینجمنٹ ایپ' },
                'sidebar_dashboard': { selector: 'li[data-view="dashboard"]', en: 'Dashboard', ur: 'ڈیش بورڈ' },
                'sidebar_students': { selector: 'li[data-view="students"]', en: 'Students', ur: 'طلباء' },
                'sidebar_teachers': { selector: 'li[data-view="teachers"]', en: 'Teachers', ur: 'اساتذہ' },
                'sidebar_staff': { selector: 'li[data-view="staff"]', en: 'Staff', ur: 'عملہ' },
                'sidebar_classes': { selector: 'li[data-view="classes"]', en: 'Classes', ur: 'کلاسیں' },
                'sidebar_subjects': { selector: 'li[data-view="subjects"]', en: 'Subjects', ur: 'مضامین' },
                'sidebar_attendance': { selector: 'li[data-view="attendance"]', en: 'Attendance', ur: 'حاضری' },
                'sidebar_exams': { selector: 'li[data-view="exams"]', en: 'Exams', ur: 'امتحانات' },
                'sidebar_fees': { selector: 'li[data-view="fees"]', en: 'Fees', ur: 'فیس' },
                'sidebar_salaries': { selector: 'li[data-view="salaries"]', en: 'Salaries', ur: 'تنخواہیں' },
                'sidebar_library': { selector: 'li[data-view="library"]', en: 'Library', ur: 'لائبریری' },
                'sidebar_users': { selector: 'li[data-view="users"]', en: 'Users', ur: 'صارفین' },
                'sidebar_reports': { selector: 'li[data-view="reports"]', en: 'Reports', ur: 'رپورٹس' },
                'sidebar_settings': { selector: 'li[data-view="settings"]', en: 'Settings', ur: 'ترتیبات' },
                'sidebar_backup': { selector: 'li[data-view="backup"]', en: 'Backup', ur: 'بیک اپ' },
                'sidebar_idcards': { selector: 'li[data-view="id-cards"]', en: 'ID Cards & Certificates', ur: 'شناختی کارڈ اور سرٹیفکیٹ' },
                'dashboard_title': { selector: '#dashboard-view > h2', en: 'Dashboard', ur: 'ڈیش بورڈ' },
                'dash_total_students': { selector: '.card:has(#total-students) .card-title', en: 'Total Students', ur: 'کل طلباء' },
                'dash_total_teachers': { selector: '.card:has(#total-teachers) .card-title', en: 'Total Teachers', ur: 'کل اساتذہ' },
                'dash_total_classes': { selector: '.card:has(#total-classes) .card-title', en: 'Total Classes', ur: 'کل کلاسیں' },
                'dash_today_attendance': { selector: '.card:has(#today-attendance) .card-title', en: "Today's Attendance", ur: 'آج کی حاضری' },
                'dash_monthly_fee': { selector: '.card:has(#monthly-fee) .card-title', en: 'Monthly Fee Collection', ur: 'ماہانہ فیس وصولی' },
                'dash_pending_fee': { selector: '.card:has(#pending-fee) .card-title', en: 'Outstanding Fees', ur: 'بقایا فیس' },
                'dash_events': { selector: '#dashboard-view .form-container:nth-of-type(1) .form-title', en: 'Upcoming Events', ur: 'آنے والے واقعات' },
                'dash_activities': { selector: '#dashboard-view .form-container:nth-of-type(2) .form-title', en: 'Recent Activities', ur: 'حالیہ سرگرمیاں' },
                'students_title': { selector: '#students-view > h2', en: 'Students', ur: 'طلباء' },
                'students_tab_list': { selector: '#students-view .tab[data-tab="students-list"]', en: 'Student List', ur: 'طلباء کی فہرست' },
                'students_tab_add': { selector: '#students-view .tab[data-tab="add-student"]', en: 'Add New Student', ur: 'نیا طالب علم شامل کریں' },
                'students_search_placeholder': { selector: '#student-search', prop: 'placeholder', en: 'Search by student name, roll number or class', ur: 'نام، رول نمبر یا کلاس سے تلاش کریں' },
                'students_form_title': { selector: '#add-student .form-title', en: 'Add New Student', ur: 'نیا طالب علم شامل کریں' },
                'students_form_add_btn': { selector: '#student-form .btn-primary', en: 'Add/Update Student', ur: 'طالب علم شامل کریں' },
                'teachers_title': { selector: '#teachers-view > h2', en: 'Teachers', ur: 'اساتذہ' },
                'teachers_tab_list': { selector: '#teachers-view .tab[data-tab="teachers-list"]', en: 'Teacher List', ur: 'اساتذہ کی فہرست' },
                'teachers_tab_add': { selector: '#teachers-view .tab[data-tab="add-teacher"]', en: 'Add New Teacher', ur: 'نیا استاد شامل کریں' },
                'teachers_search_placeholder': { selector: '#teacher-search', prop: 'placeholder', en: 'Search by teacher name, subject or class', ur: 'نام، مضمون یا کلاس سے تلاش کریں' },
                'teachers_form_title': { selector: '#add-teacher .form-title', en: 'Add New Teacher', ur: 'نیا استاد شامل کریں' },
                'teachers_form_qualification': { selector: 'label[for="teacher-qualification"]', en: 'Qualification', ur: 'قابلیت' },
                'teachers_form_specialization': { selector: 'label[for="teacher-specialization"]', en: 'Specialization', ur: 'مہارت' },
                'teachers_form_subjects': { selector: 'label[for="teacher-subject"]', en: 'Teacher Subjects', ur: 'مضامین' },
                'teachers_form_classes': { selector: 'label[for="teacher-class"]', en: 'Classes', ur: 'کلاسیں' },
                'teachers_form_cnic': { selector: 'label[for="teacher-cnic"]', en: 'CNIC No.', ur: 'شناختی کارڈ نمبر' },
                'teachers_form_joining': { selector: 'label[for="teacher-joining-date"]', en: 'Joining Date', ur: 'شمولیت کی تاریخ' },
                'teachers_form_salary': { selector: 'label[for="teacher-basic-salary"]', en: 'Basic Salary', ur: 'بنیادی تنخواہ' },
                'teachers_form_add_btn': { selector: '#teacher-form .btn-primary', en: 'Add/Update Teacher', ur: 'استاد شامل کریں' },
                'staff_title': { selector: '#staff-view > h2', en: 'Staff', ur: 'عملہ' },
                'staff_tab_list': { selector: '#staff-view .tab[data-tab="staff-list"]', en: 'Staff List', ur: 'عملے کی فہرست' },
                'staff_tab_add': { selector: '#staff-view .tab[data-tab="add-staff"]', en: 'Add New Staff', ur: 'نیا عملہ شامل کریں' },
                'staff_search_placeholder': { selector: '#staff-search', prop: 'placeholder', en: 'Search by staff name, designation or department', ur: 'نام، عہدہ یا محکمہ سے تلاش کریں' },
                'staff_form_title': { selector: '#add-staff .form-title', en: 'Add New Staff', ur: 'نیا عملہ شامل کریں' },
                'staff_form_designation': { selector: 'label[for="staff-designation"]', en: 'Designation', ur: 'عہدہ' },
                'staff_form_department': { selector: 'label[for="staff-department"]', en: 'Department', ur: 'محکمہ' },
                'staff_form_responsibilities': { selector: 'label[for="staff-responsibilities"]', en: 'Responsibilities', ur: 'ذمہ داریاں' },
                'staff_form_add_btn': { selector: '#staff-form .btn-primary', en: 'Add Staff', ur: 'عملہ شامل کریں' },
                'classes_title': { selector: '#classes-view > h2', en: 'Classes', ur: 'کلاسیں' },
                'classes_tab_list': { selector: '#classes-view .tab[data-tab="classes-list"]', en: 'Class List', ur: 'کلاسوں کی فہرست' },
                'classes_tab_add': { selector: '#classes-view .tab[data-tab="add-class"]', en: 'Add New Class', ur: 'نئی کلاس شامل کریں' },
                'classes_tab_sections': { selector: '#classes-view .tab[data-tab="sections"]', en: 'Sections', ur: 'سیکشنز' },
                'classes_form_title': { selector: '#add-class .form-title', en: 'Add New Class', ur: 'نئی کلاس شامل کریں' },
                'classes_form_incharge': { selector: 'label[for="class-incharge"]', en: 'Class Incharge', ur: 'کلاس انچارج' },
                'classes_form_level': { selector: 'label[for="class-level"]', en: 'Class Level', ur: 'کلاس کا درجہ' },
                'classes_form_room': { selector: 'label[for="class-room"]', en: 'Room No.', ur: 'کمرہ نمبر' },
                'classes_form_fee_cat': { selector: 'label[for="class-fee-category"]', en: 'Fee Category', ur: 'فیس کیٹیگری' },
                'classes_form_add_btn': { selector: '#class-form .btn-primary', en: 'Add Class', ur: 'کلاس شامل کریں' },
                'classes_section_title': { selector: '#sections .form-title', en: 'Section Management', ur: 'سیکشن مینجمنٹ' },
                'classes_section_incharge': { selector: 'label[for="section-incharge"]', en: 'Section Incharge', ur: 'سیکشن انچارج' },
                'classes_section_save_btn': { selector: '#save-section', en: 'Save Section', ur: 'سیکشن محفوظ کریں' },
                'subjects_title': { selector: '#subjects-view > h2', en: 'Subjects', ur: 'مضامین' },
                'subjects_tab_list': { selector: '#subjects-view .tab[data-tab="subjects-list"]', en: 'Subject List', ur: 'مضامین کی فہرست' },
                'subjects_tab_add': { selector: '#subjects-view .tab[data-tab="add-subject"]', en: 'Add New Subject', ur: 'نیا مضمون شامل کریں' },
                'subjects_tab_class': { selector: '#subjects-view .tab[data-tab="class-subjects"]', en: 'Class Subjects', ur: 'کلاس کے مضامین' },
                'subjects_form_title': { selector: '#add-subject .form-title', en: 'Add New Subject', ur: 'نیا مضمون شامل کریں' },
                'subjects_form_code': { selector: 'label[for="subject-code"]', en: 'Subject Code', ur: 'مضمون کا کوڈ' },
                'subjects_form_type': { selector: 'label[for="subject-type"]', en: 'Subject Type', ur: 'مضمون کی قسم' },
                'subjects_form_periods': { selector: 'label[for="subject-periods"]', en: 'Weekly Periods', ur: 'ہفتہ وار پیریڈز' },
                'subjects_form_add_btn': { selector: '#subject-form .btn-primary', en: 'Add Subject', ur: 'مضمون شامل کریں' },
                'subjects_class_title': { selector: '#class-subjects .form-title', en: 'Class Subjects', ur: 'کلاس کے مضامین' },
                'subjects_class_teacher': { selector: 'label[for="class-subject-teacher"]', en: 'Teacher', ur: 'استاد' },
                'subjects_class_save_btn': { selector: '#save-class-subject', en: 'Save Subject', ur: 'مضمون محفوظ کریں' },
                'attendance_title': { selector: '#attendance-view > h2', en: 'Attendance', ur: 'حاضری' },
                'attendance_tab_mark': { selector: '#attendance-view .tab[data-tab="mark-attendance"]', en: 'Mark Attendance', ur: 'حاضری لگائیں' },
                'attendance_tab_view': { selector: '#attendance-view .tab[data-tab="view-attendance"]', en: 'View Attendance', ur: 'حاضری دیکھیں' },
                'attendance_tab_report': { selector: '#attendance-view .tab[data-tab="attendance-report"]', en: 'Attendance Report', ur: 'حاضری رپورٹ' },
                'attendance_load_btn': { selector: '#load-attendance', en: 'Load Students', ur: 'طلباء لوڈ کریں' },
                'attendance_save_btn': { selector: '#attendance-form .btn-primary', en: 'Save Attendance', ur: 'حاضری محفوظ کریں' },
                'attendance_view_btn': { selector: '#view-attendance-btn', en: 'View Attendance', ur: 'حاضری دیکھیں' },
                'attendance_generate_report_btn': { selector: '#generate-attendance-report', en: 'Generate Report', ur: 'رپورٹ بنائیں' },
                'fees_title': { selector: '#fees-view > h2', en: 'Fees', ur: 'فیس' },
                'fees_tab_collect': { selector: '#fees-view .tab[data-tab="fee-collection"]', en: 'Collect Fee', ur: 'فیس وصول کریں' },
                'fees_tab_structure': { selector: '#fees-view .tab[data-tab="fee-structure"]', en: 'Fee Structure', ur: 'فیس کا ڈھانچہ' },
                'fees_tab_reports': { selector: '#fees-view .tab[data-tab="fee-reports"]', en: 'Fee Reports', ur: 'فیس رپورٹس' },
                'fees_tab_defaulters': { selector: '#fees-view .tab[data-tab="fee-defaulters"]', en: 'Fee Defaulters', ur: 'فیس نادہندگان' },
                'fees_search_student_label': { selector: 'label[for="fee-student-search"]', en: 'Search Student', ur: 'طالب علم تلاش کریں' },
                'fees_form_collect_title': { selector: '#fee-payment-form .form-title', en: 'Collect Fee', ur: 'فیس وصول کریں' },
                'fees_form_month': { selector: 'label[for="fee-month"]', en: 'Month', ur: 'مہینہ' },
                'fees_form_year': { selector: 'label[for="fee-year"]', en: 'Year', ur: 'سال' },
                'fees_form_fine': { selector: 'label[for="fee-fine"]', en: 'Fine', ur: 'جرمانہ' },
                'fees_form_discount': { selector: 'label[for="fee-discount"]', en: 'Discount', ur: 'رعایت' },
                'fees_form_total': { selector: 'label[for="fee-total"]', en: 'Total Amount', ur: 'کل رقم' },
                'fees_form_payment_date': { selector: 'label[for="fee-payment-date"]', en: 'Payment Date', ur: 'ادائیگی کی تاریخ' },
                'fees_form_payment_method': { selector: 'label[for="fee-payment-method"]', en: 'Payment Method', ur: 'ادائیگی کا طریقہ' },
                'fees_form_collect_btn': { selector: '#fee-form .btn-primary', en: 'Collect Fee', ur: 'فیس وصول کریں' },
                'fees_form_receipt_btn': { selector: '#print-receipt', en: 'Print Receipt', ur: 'رسید پرنٹ کریں' },
                'fees_history_title': { selector: '#fee-history-container .form-title', en: 'Fee Collection History', ur: 'فیس وصولی کی تاریخ' },
                'idcards_title': { selector: '#id-cards-view > h2', en: 'ID Cards & Certificates', ur: 'شناختی کارڈ اور سرٹیفکیٹ' },
                'idcards_tab_generator': { selector: '#id-cards-view .tab[data-tab="id-card-generator"]', en: 'ID Card Generator', ur: 'شناختی کارڈ جنریٹر' },
                'idcards_tab_cert_generator': { selector: '#id-cards-view .tab[data-tab="certificate-generator"]', en: 'Certificate Generator', ur: 'سرٹیفکیٹ جنریٹر' },
                'idcards_form_title': { selector: '#id-card-generator .form-title', en: 'Generate ID Cards', ur: 'شناختی کارڈ بنائیں' },
                'idcards_member_type': { selector: 'label[for="id-card-member-type"]', en: 'Member Type', ur: 'رکن کی قسم' },
                'idcards_generate_btn': { selector: '#generate-id-cards-btn', en: 'Generate Cards', ur: 'کارڈ بنائیں' },
                'idcards_export_zip_btn': { selector: '#bulk-export-zip-btn', en: 'Export All to ZIP', ur: 'تمام زپ میں ایکسپورٹ کریں' },
                'cert_form_title': { selector: '#certificate-generator .form-title', en: 'Generate Certificate', ur: 'سرٹیفکیٹ بنائیں' },
                'cert_type': { selector: 'label[for="certificate-type"]', en: 'Certificate Type', ur: 'سرٹیفکیٹ کی قسم' },
                'cert_select_student': { selector: 'label[for="certificate-student-filter"]', en: 'Select Student', ur: 'طالب علم منتخب کریں' },
                'cert_achievement': { selector: 'label[for="achievement-description"]', en: 'Achievement Details', ur: 'کامیابی کی تفصیلات' },
                'cert_generate_btn': { selector: '#generate-certificate-btn', en: 'Generate Certificate', ur: 'سرٹیفکیٹ بنائیں' },
                'id_card_name_label': { selector: '.id-card-details b', en: 'Name:', ur: 'نام:', isGeneric: true, matchingText: 'Name:' },
                'id_card_father_label': { selector: '.id-card-details b', en: 'Father:', ur: 'والد:', isGeneric: true, matchingText: 'Father:' },
                'id_card_id_label': { selector: '.id-card-details b', en: 'ID:', ur: 'شناختی نمبر:', isGeneric: true, matchingText: 'ID:' },
                'id_card_class_label': { selector: '.id-card-details b', en: 'Class:', ur: 'کلاس:', isGeneric: true, matchingText: 'Class:' },
                'id_card_designation_label': { selector: '.id-card-details b', en: 'Designation:', ur: 'عہدہ:', isGeneric: true, matchingText: 'Designation:' },
                'id_card_issued_label': { selector: '.id-card-details b', en: 'Issued:', ur: 'تاریخ اجراء:', isGeneric: true, matchingText: 'Issued:' },
                'id_card_back_note': { selector: '.id-card-back p:first-of-type', en: 'This card is property of the institution. In case of loss, please return or notify at the address below.', ur: 'یہ کارڈ ادارے کی ملکیت ہے۔ گم ہونے کی صورت میں، براہ کرم نیچے دیے گئے پتے پر واپس کریں یا مطلع کریں۔' },
                'id_card_back_address': { selector: '.id-card-back p b', en: 'Address:', ur: 'پتہ:', isGeneric: true, matchingText: 'Address:' },
                'id_card_back_phone': { selector: '.id-card-back p b', en: 'Phone:', ur: 'فون:', isGeneric: true, matchingText: 'Phone:' },
                'settings_title': { selector: '#settings-view > h2', en: 'Settings', ur: 'ترتیبات' },
                'settings_tab_general': { selector: '#settings-view .tab[data-tab="general-settings"]', en: 'General Settings', ur: 'عمومی ترتیبات' },
                'settings_tab_academic': { selector: '#settings-view .tab[data-tab="academic-settings"]', en: 'Academic Settings', ur: 'تعلیمی ترتیبات' },
                'settings_tab_theme': { selector: '#settings-view .tab[data-tab="theme-settings"]', en: 'Theme Settings', ur: 'تھیم کی ترتیبات' },
                'settings_tab_system': { selector: '#settings-view .tab[data-tab="system-settings"]', en: 'System Settings', ur: 'سسٹم کی ترتیبات' },
                'settings_general_title': { selector: '#general-settings .form-title', en: 'School Information', ur: 'اسکول کی معلومات' },
                'settings_school_name': { selector: 'label[for="school-name"]', en: 'School Name', ur: 'اسکول کا نام' },
                'settings_principal_name': { selector: 'label[for="principal-name"]', en: 'Principal Name', ur: 'پرنسپل کا نام' },
                'settings_academic_title': { selector: '#academic-settings .form-title', en: 'Academic Settings', ur: 'تعلیمی ترتیبات' },
                'settings_session': { selector: 'label[for="setting-current-session"]', en: 'Current Session', ur: 'موجودہ سیشن' },
                'settings_session_start': { selector: 'label[for="setting-session-start"]', en: 'Session Start Date', ur: 'سیشن کے آغاز کی تاریخ' },
                'settings_session_end': { selector: 'label[for="setting-session-end"]', en: 'Session End Date', ur: 'سیشن کے اختتام کی تاریخ' },
                'settings_theme_title': { selector: '#theme-settings .form-title', en: 'Theme Settings', ur: 'تھیم کی ترتیبات' },
                'settings_primary_color': { selector: 'label[for="setting-primary-color"]', en: 'Primary Color', ur: 'بنیادی رنگ' },
                'settings_secondary_color': { selector: 'label[for="setting-secondary-color"]', en: 'Secondary Color', ur: 'ثانوی رنگ' },
                'settings_reset_theme': { selector: '#reset-theme-btn', en: 'Reset Theme', ur: 'تھیم ری سیٹ کریں' },
                'settings_system_title': { selector: '#system-settings .form-title', en: 'System Settings', ur: 'سسٹم کی ترتیبات' },
                'settings_language': { selector: 'label[for="system-language"]', en: 'Language', ur: 'زبان' },
            };
            const rtlCss = `
    body.rtl-mode { 
        direction: rtl; 
    }
    body.rtl-mode,
    body.rtl-mode *,
    body.rtl-mode input, 
    body.rtl-mode select, 
    body.rtl-mode textarea, 
    body.rtl-mode button,
    body.rtl-mode .form-control {
        font-family: Calibri, 'Noto Nastaliq Urdu', sans-serif !important;
    }
    body:not(.rtl-mode),
    body:not(.rtl-mode) * {
        font-family: Arial, sans-serif;
    }
    body.rtl-mode .form-control,
    body.rtl-mode input,
    body.rtl-mode select,
    body.rtl-mode textarea {
        direction: rtl !important;
    }
    body.rtl-mode .sidebar { left: auto; right: 0; }
    body.rtl-mode .sidebar-menu li { padding: 10px 20px; text-align: right;}
    body.rtl-mode .sidebar-menu i { margin-right: 0; margin-left: 10px; }
    body.rtl-mode .main-container { margin-left: 0; margin-right: 250px; }
    body.rtl-mode .header h1, body.rtl-mode h2, body.rtl-mode .form-title, body.rtl-mode .card-title, body.rtl-mode .profile-details { text-align: right; }
    body.rtl-mode .table th, body.rtl-mode .table td { text-align: right; }
    body.rtl-mode .form-label { text-align: right; display: block; }
    body.rtl-mode select { background-position: left .75rem center; }
    body.rtl-mode .btn-danger[style*="margin-left"] { margin-left: 0 !important; margin-right: 10px; }
    body.rtl-mode .menu-toggle { left: auto; right: 15px; }
    body.rtl-mode .close { float: left; }
    body.rtl-mode .notification { right: auto; left: 20px; }
    body.rtl-mode .profile-image { margin-right: 0; margin-left: 20px; }
    body.rtl-mode .id-card-details, body.rtl-mode .id-card-back p { text-align: right; }
    body.rtl-mode .id-card-photo-container { margin-right: 0; margin-left: 10px; }
    body.rtl-mode .id-card-details { padding-left:0; padding-right: 10px;}
    body.rtl-mode .card-export-btn { left: auto !important; right: 36px !important; }
    body.rtl-mode .card-export-btn-back { left: auto !important; right: 70px !important; }
    @media (max-width: 768px) {
        body.rtl-mode .main-container { margin-right: 0; }
        body.rtl-mode .main-container.sidebar-active { margin-left: 0; margin-right: 250px; }
        body.rtl-mode .sidebar { transform: translateX(100%); }
        body.rtl-mode .sidebar.active { transform: translateX(0); }
    }
`;
            function injectFonts() {
                const fontLink = document.createElement('link');
                fontLink.href = 'https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap';
                fontLink.rel = 'stylesheet';
                document.head.appendChild(fontLink);
            }
            function applyTranslations(lang) {
                for (const key in translations) {
                    const item = translations[key];
                    const elements = document.querySelectorAll(item.selector);
                    elements.forEach(element => {
                        const prop = item.prop || 'textContent';
                        let contentToMatch = (prop === 'placeholder') ? element.placeholder : (prop === 'innerHTML' ? element.innerHTML : element.textContent);
                        if (item.selector.startsWith('li[data-view=')) {
                            const icon = element.querySelector('i');
                            if (icon) {
                                element.innerHTML = icon.outerHTML + ' ' + item[lang];
                            } else {
                                element.textContent = item[lang];
                            }
                            return;
                        }
                        if (item.isGeneric) {
                            const regex = new RegExp(item.matchingText, 'i');
                            if (!regex.test(contentToMatch)) {
                                return;
                            }
                        }
                        if (element && item[lang]) {
                            if (prop === 'placeholder') {
                                element.placeholder = item[lang];
                            } else {
                                element.textContent = item[lang];
                            }
                        }
                    });
                }
            }
            function setLanguage(lang) {
                document.documentElement.lang = lang;
                if (lang === 'ur') {
                    document.body.classList.add('rtl-mode');
                } else {
                    document.body.classList.remove('rtl-mode');
                }
                localStorage.setItem('schoolAppLanguage', lang);
                applyTranslations(lang);
                const headerSwitcher = document.getElementById('language-switcher');
                const settingsSwitcher = document.getElementById('system-language');
                if (headerSwitcher) headerSwitcher.value = lang;
                if (settingsSwitcher) settingsSwitcher.value = lang;
            }
            function createLanguageSwitcher() {
                const header = document.querySelector('.header');
                if (header) {
                    const switcher = document.createElement('select');
                    switcher.id = 'language-switcher';
                    switcher.className = 'form-control no-print';
                    switcher.style.cssText = 'position: absolute; top: 2px; right: 68px; width: 120px; background-color: #fff; z-index: 1001;';
                    switcher.innerHTML = `
                <option value="en">English</option>
                <option value="ur">اردو</option>
            `;
                    header.appendChild(switcher);
                    switcher.value = localStorage.getItem('schoolAppLanguage') || 'en';
                    switcher.addEventListener('change', (e) => setLanguage(e.target.value));
                }
            }
            function injectRtlCss(css) {
                const style = document.createElement('style');
                style.id = 'rtl-styles';
                style.textContent = css;
                document.head.appendChild(style);
            }
            const originalShowView = window.showView;
            window.showView = async function (viewName) {
                if (typeof originalShowView === 'function') {
                    await originalShowView.apply(this, arguments);
                }
                const currentLang = localStorage.getItem('schoolAppLanguage') || 'en';
                setLanguage(currentLang);
            };
            const originalFormatDate = window.formatDate;
            window.formatDate = function (dateString) {
                if (!dateString) return '-';
                const currentLang = localStorage.getItem('schoolAppLanguage') || 'en';
                const date = new Date(dateString);
                if (currentLang === 'ur') {
                    const options = { year: 'numeric', month: 'long', day: 'numeric', numberingSystem: 'arab' };
                    return date.toLocaleDateString('ur-PK', options);
                }
                return originalFormatDate(dateString);
            }
            document.addEventListener('DOMContentLoaded', () => {
                injectFonts();
                injectRtlCss(rtlCss);
                createLanguageSwitcher();
                const savedLang = localStorage.getItem('schoolAppLanguage') || 'en';
                setLanguage(savedLang);
                document.getElementById('system-language').addEventListener('change', (e) => setLanguage(e.target.value));
                const observer = new MutationObserver((mutations) => {
                    observer.disconnect();
                    const currentLang = localStorage.getItem('schoolAppLanguage') || 'en';
                    applyTranslations(currentLang);
                    const mainContainer = document.getElementById('mainContainer');
                    if (mainContainer) {
                        observer.observe(mainContainer, {
                            childList: true,
                            subtree: true
                        });
                    }
                });
                const mainContainer = document.getElementById('mainContainer');
                if (mainContainer) {
                    observer.observe(mainContainer, {
                        childList: true,
                        subtree: true
                    });
                }
            });
        })(); 
    </script>
<script type="module">
  import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

  const swUrl = './sw.js';
  const wb = new Workbox(swUrl);

  wb.addEventListener('waiting', () => {
    console.log('A new service worker is waiting to activate.');
    wb.messageSW({ type: 'SKIP_WAITING' });
  });

  wb.addEventListener('controlling', () => {
    console.log('The new service worker is now in control. Reloading page for updates...');
    window.location.reload();
  });

  wb.register();
</script></body>
</html>
<script>
    function loadScriptsAndInitialize() {
        document.body.classList.add('pdf-loading');
        const jspdfSrc = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        const autotableSrc = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
        const fontUrl = 'https://raw.githubusercontent.com/google/fonts/main/ofl/amiri/Amiri-Regular.ttf';
        const loadScript = (src) => new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
        const loadFont = () => new Promise((resolve, reject) => {
            fetch(fontUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.blob();
                })
                .then(blob => {
                    const reader = new FileReader();
                    reader.onloadend = function () {
                        window.amiriFontBase64 = reader.result.split(',')[1];
                        console.log('Amiri font loaded.');
                        resolve();
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.error("Failed to load Amiri font:", error);
                    resolve();
                });
        });
        loadScript(jspdfSrc)
            .then(() => loadScript(autotableSrc))
            .then(() => loadFont())
            .then(() => {
                console.log('All PDF dependencies loaded.');
                document.body.classList.remove('pdf-loading');
                document.body.classList.add('pdf-ready');
                initializeTableEnhancements();
                observeForNewTables();
            })
            .catch(error => {
                console.error("A script or font failed to load:", error);
                document.body.classList.remove('pdf-loading');
                document.body.classList.add('pdf-error');
                showNotification('PDF export functionality failed to load.', 'error');
            });
    }
    function initializeTableEnhancements() {
        const tableContainers = document.querySelectorAll('.table-container');
        tableContainers.forEach(container => {
            const table = container.querySelector('table.table');
            if (table && !container.dataset.enhanced) {
                const uniqueId = `table-enhancer-${Math.random().toString(36).substring(2, 9)}`;
                container.dataset.enhanced = 'true';
                container.dataset.tableId = uniqueId;
                createControls(container, uniqueId);
                attachEventListeners(container, table, uniqueId);
                applySavedState(table, uniqueId);
            }
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
        loadScriptsAndInitialize();
    });
    function createControls(container, uniqueId) {
        if (container.querySelector('.table-controls')) return;
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'table-controls';
        controlsDiv.style.display = 'flex';
        controlsDiv.style.justifyContent = 'space-between';
        controlsDiv.style.alignItems = 'center';
        controlsDiv.style.padding = '10px 0';
        controlsDiv.style.flexWrap = 'wrap';
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.id = `${uniqueId}-search`;
        searchInput.placeholder = 'Search this table...';
        searchInput.className = 'form-control';
        searchInput.style.width = '250px';
        searchInput.style.maxWidth = '100%';
        searchInput.style.marginBottom = '5px';
        const pdfButton = document.createElement('button');
        pdfButton.id = `${uniqueId}-pdf-export`;
        pdfButton.className = 'btn btn-danger';
        pdfButton.innerHTML = '🖨️ PDF';
        pdfButton.title = 'Export to PDF';
        pdfButton.style.height = 'fit-content';
        controlsDiv.appendChild(pdfButton);
        controlsDiv.appendChild(searchInput);
        container.prepend(controlsDiv);
    }
    function attachEventListeners(container, table, uniqueId) {
        const searchInput = document.getElementById(`${uniqueId}-search`);
        searchInput.addEventListener('keyup', () => {
            saveState(uniqueId, { search: searchInput.value });
            runFiltersAndSort(table, uniqueId);
        });
        const pdfButton = document.getElementById(`${uniqueId}-pdf-export`);
        pdfButton.addEventListener('click', () => exportTableToPDF(table));
        const headers = table.querySelectorAll('thead th');
        headers.forEach((header, colIndex) => {
            if (header.querySelector('.header-content-wrapper')) return;
            if (!header.innerText.toLowerCase().includes('action')) {
                const originalText = header.textContent.trim();
                header.innerHTML = '';
                header.style.cursor = 'pointer';
                header.style.position = 'relative';
                const headerContent = document.createElement('div');
                headerContent.className = 'header-content-wrapper';
                headerContent.style.display = 'flex';
                headerContent.style.alignItems = 'center';
                headerContent.style.justifyContent = 'space-between';
                const titleSpan = document.createElement('span');
                titleSpan.textContent = originalText;
                const iconsWrapper = document.createElement('div');
                iconsWrapper.style.display = 'flex';
                iconsWrapper.style.alignItems = 'center';
                iconsWrapper.style.marginLeft = '5px';
                const sortIcon = document.createElement('span');
                sortIcon.innerHTML = '&#x2195;';
                sortIcon.style.opacity = '0.5';
                sortIcon.title = "Sort column";
                sortIcon.style.padding = "0 3px";
                sortIcon.onclick = (e) => {
                    e.stopPropagation();
                    const currentState = JSON.parse(localStorage.getItem('tableStates'))?.[uniqueId] || {};
                    const oldDir = (currentState.sortCol === colIndex) ? currentState.sortDir : 'none';
                    const newDir = oldDir === 'asc' ? 'desc' : 'asc';
                    saveState(uniqueId, { sortCol: colIndex, sortDir: newDir });
                    runFiltersAndSort(table, uniqueId);
                };
                const filterIcon = document.createElement('span');
                filterIcon.innerHTML = '&#x1F4D9;';
                filterIcon.style.opacity = '0.5';
                filterIcon.title = "Filter column";
                filterIcon.className = 'filter-icon';
                filterIcon.style.padding = "0 3px";
                filterIcon.onclick = (e) => {
                    e.stopPropagation();
                    showColumnFilterMenu(e.target, table, colIndex, uniqueId);
                };
                iconsWrapper.appendChild(sortIcon);
                iconsWrapper.appendChild(filterIcon);
                headerContent.appendChild(titleSpan);
                headerContent.appendChild(iconsWrapper);
                header.appendChild(headerContent);
            }
        });
    }
    function showColumnFilterMenu(iconElement, table, colIndex, uniqueId) {
        document.getElementById('column-filter-menu')?.remove();
        const menu = document.createElement('div');
        menu.id = 'column-filter-menu';
        menu.style.cssText = `position: absolute; background-color: white; border: 1px solid #ccc; border-radius: 4px; padding: 10px; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-height: 300px; overflow-y: auto;`;
        const values = new Set();
        table.querySelectorAll('tbody tr').forEach(row => {
            const cell = row.querySelectorAll('td')[colIndex];
            if (cell) values.add(cell.innerText.trim());
        });
        const savedState = JSON.parse(localStorage.getItem('tableStates'))?.[uniqueId] || {};
        const activeFilters = savedState.columnFilters?.[colIndex] || [];
        Array.from(values).sort().forEach(value => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = value;
            checkbox.id = `filter-val-${value.replace(/\s/g, '-')}`;
            checkbox.checked = activeFilters.includes(value);
            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.style.display = 'block';
            label.style.whiteSpace = 'nowrap';
            label.appendChild(checkbox);
            label.appendChild(document.createTextNode(` ${value}`));
            menu.appendChild(label);
        });
        const applyButton = document.createElement('button');
        applyButton.textContent = 'Apply';
        applyButton.className = 'btn btn-primary btn-sm';
        applyButton.style.marginTop = '10px';
        applyButton.onclick = () => {
            const selectedValues = Array.from(menu.querySelectorAll('input:checked')).map(cb => cb.value);
            const currentState = JSON.parse(localStorage.getItem('tableStates'))?.[uniqueId] || {};
            if (!currentState.columnFilters) currentState.columnFilters = {};
            if (selectedValues.length > 0 && selectedValues.length < values.size) {
                currentState.columnFilters[colIndex] = selectedValues;
            } else {
                delete currentState.columnFilters[colIndex];
            }
            saveState(uniqueId, { columnFilters: currentState.columnFilters });
            runFiltersAndSort(table, uniqueId);
            menu.remove();
        };
        menu.appendChild(applyButton);
        document.body.appendChild(menu);
        const rect = iconElement.getBoundingClientRect();
        menu.style.top = `${rect.bottom + window.scrollY}px`;
        menu.style.left = `${rect.left + window.scrollX}px`;
        const closeMenu = (e) => {
            if (!menu.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenu, true);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu, true), 0);
    }
    function runFiltersAndSort(table, uniqueId) {
        const state = JSON.parse(localStorage.getItem('tableStates'))?.[uniqueId] || {};
        const searchTerm = state.search || '';
        const columnFilters = state.columnFilters || {};
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.forEach(row => {
            let isVisible = true;
            if (searchTerm) {
                isVisible = row.innerText.toLowerCase().includes(searchTerm.toLowerCase());
            }
            if (isVisible && Object.keys(columnFilters).length > 0) {
                isVisible = Object.entries(columnFilters).every(([colIndex, filterValues]) => {
                    if (filterValues.length === 0) return true;
                    const cellValue = row.querySelectorAll('td')[colIndex]?.innerText.trim();
                    return filterValues.includes(cellValue);
                });
            }
            row.style.display = isVisible ? '' : 'none';
        });
        if (state.sortCol !== undefined && state.sortDir) {
            sortTable(table, state.sortCol, state.sortDir);
        }
    }
    function sortTable(table, colIndex, direction) {
        table.querySelectorAll('thead th').forEach((th, index) => {
            const sortIcon = th.querySelector('span[title="Sort column"]');
            if (sortIcon) {
                if (index === colIndex) {
                    sortIcon.innerHTML = direction === 'asc' ? ' &#x2191;' : ' &#x2193;';
                } else {
                    sortIcon.innerHTML = ' &#x2195;';
                }
            }
        });
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const dirModifier = direction === 'asc' ? 1 : -1;
        const sortedRows = rows.sort((rowA, rowB) => {
            const cellA = rowA.querySelectorAll('td')[colIndex]?.innerText.trim() || '';
            const cellB = rowB.querySelectorAll('td')[colIndex]?.innerText.trim() || '';
            const isNumeric = !isNaN(parseFloat(cellA)) && isFinite(cellA) && !isNaN(parseFloat(cellB)) && isFinite(cellB);
            if (isNumeric) {
                return (parseFloat(cellA) - parseFloat(cellB)) * dirModifier;
            } else {
                return cellA.localeCompare(cellB, ['en', 'ur'], { sensitivity: 'base' }) * dirModifier;
            }
        });
        const fragment = document.createDocumentFragment();
        sortedRows.forEach(row => fragment.appendChild(row));
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
    }
    async function exportTableToPDF(table) {
        if (!document.body.classList.contains('pdf-ready')) {
            const status = document.body.classList.contains('pdf-loading') ? 'loading' : 'in an error state';
            showNotification(`PDF library is currently ${status}. Please wait.`, 'info');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        if (window.amiriFontBase64) {
            doc.addFileToVFS('Amiri-Regular.ttf', window.amiriFontBase64);
            doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');
        } else {
            doc.setFont('Helvetica');
        }
        const head = [[]];
        const body = [];
        const visibleColumnIndices = [];
        const urduRegex = /[\u0600-\u06FF]/;
        table.querySelectorAll('thead th').forEach((th, index) => {
            if (th.offsetParent !== null && !th.classList.contains('no-print')) {
                visibleColumnIndices.push(index);
                const titleSpan = th.querySelector('div > span:first-child');
                let text = titleSpan ? titleSpan.textContent.trim() : th.textContent.trim();
                head[0].push(text);
            }
        });
        table.querySelectorAll('tbody tr').forEach(tr => {
            if (tr.style.display !== 'none') {
                const rowData = [];
                const cells = tr.querySelectorAll('td');
                visibleColumnIndices.forEach(colIndex => {
                    if (cells[colIndex]) {
                        rowData.push(cells[colIndex].innerText);
                    }
                });
                if (rowData.length > 0) body.push(rowData);
            }
        });
        doc.autoTable({
            head: head,
            body: body,
            styles: { font: window.amiriFontBase64 ? 'Amiri' : 'Helvetica', fontSize: 8 },
            headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold' },
            didDrawCell: (data) => {
                if (urduRegex.test(data.cell.text)) {
                    doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height);
                    doc.text(data.cell.text, data.cell.x + data.cell.width - data.cell.padding('right'), data.cell.y + data.cell.height / 2, {
                        halign: 'right',
                        valign: 'middle'
                    });
                    return false;
                }
            }
        });
        doc.save(`${table.id || 'table'}-export.pdf`);
    }
    function saveState(tableId, state) {
        try {
            const existingState = JSON.parse(localStorage.getItem('tableStates')) || {};
            existingState[tableId] = { ...existingState[tableId], ...state };
            localStorage.setItem('tableStates', JSON.stringify(existingState));
        } catch (e) {
            console.error('Could not save table state:', e);
        }
    }
    function applySavedState(table, uniqueId) {
        try {
            const savedStates = JSON.parse(localStorage.getItem('tableStates'));
            if (!savedStates || !savedStates[uniqueId]) return;
            const state = savedStates[uniqueId];
            if (state.search) {
                const searchInput = document.getElementById(`${uniqueId}-search`);
                if (searchInput) searchInput.value = state.search;
            }
            if (state.columnFilters) {
                Object.entries(state.columnFilters).forEach(([colIndex, values]) => {
                    if (values && values.length > 0) {
                        const header = table.querySelectorAll('thead th')[colIndex];
                        const filterIcon = header?.querySelector('.filter-icon');
                        if (filterIcon) {
                            filterIcon.style.opacity = '1';
                            filterIcon.style.color = '#e74c3c';
                        }
                    }
                });
            }
            runFiltersAndSort(table, uniqueId);
        } catch (e) {
            console.error('Could not apply saved table state:', e);
        }
    }
    function observeForNewTables() {
        const observer = new MutationObserver((mutations) => {
            let needsInit = false;
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            if (node.matches('.table-container') || node.querySelector('.table-container')) {
                                needsInit = true;
                            }
                        }
                    });
                }
            });
            if (needsInit) {
                initializeTableEnhancements();
            }
        });
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    async function viewTeacherDetails(teacherId) {
        showLoading();
        const modal = document.getElementById('student-details-modal');
        const contentArea = document.getElementById('modal-content-area');
        contentArea.innerHTML = '';
        try {
            const teacher = await getFromStore(STORES.TEACHERS, teacherId);
            if (!teacher) {
                showNotification('Teacher not found.', 'error');
                return;
            }
            const profileHTML = await generateTeacherProfileSectionHTML(teacher);
            const scheduleHTML = await generateTeacherScheduleSectionHTML(teacher.id);
            const salaryHTML = await generateTeacherSalarySectionHTML(teacher.id);
            contentArea.innerHTML = profileHTML + scheduleHTML + salaryHTML;
            modal.style.display = 'block';
        } catch (error) {
            console.error('Error viewing teacher details:', error);
            showNotification('Could not load teacher details.', 'error');
        } finally {
            hideLoading();
        }
    }
    async function generateTeacherProfileSectionHTML(teacher) {
        return `
    <div class="profile-card">
        <div class="profile-image">
            <img src="${teacher.photo || 'logo2.png'}" alt="Teacher Photo">
        </div>
        <div class="profile-details">
            <div class="profile-name">${teacher.name}</div>
            <div class="profile-info"><span>Employee ID:</span> ${teacher.employeeId}</div>
            <div class="profile-info"><span>Qualification:</span> ${teacher.qualification}</div>
            <div class="profile-info"><span>Specialization:</span> ${teacher.specialization}</div>
            <div class="profile-info"><span>Contact:</span> ${teacher.contact}</div>
            <div class="profile-info"><span>Joined:</span> ${formatDate(teacher.joiningDate)}</div>
        </div>
    </div>
    `;
    }
    async function generateTeacherScheduleSectionHTML(teacherId) {
        let html = `<div class="form-container" style="margin-top:20px;">
                    <div class="form-title">Assigned Classes & Subjects</div>`;
        const assignedSubjects = await getAllFromIndex(STORES.CLASS_SUBJECTS, 'teacherId', teacherId);
        if (assignedSubjects.length > 0) {
            html += `<div class="table-container" style="max-height: 250px; overflow-y: auto;">
                   <table class="table" id="teacher-schedule-table">
                     <thead><tr><th>Class</th><th>Subject</th></tr></thead><tbody>`;
            for (const assignment of assignedSubjects) {
                const classData = await getFromStore(STORES.CLASSES, assignment.classId);
                const subjectData = await getFromStore(STORES.SUBJECTS, assignment.subjectId);
                html += `<tr>
                        <td>${classData ? classData.name : 'N/A'}</td>
                        <td>${subjectData ? subjectData.name : 'N/A'}</td>
                     </tr>`;
            }
            html += `</tbody></table></div>`;
        } else {
            html += `<p>No classes or subjects assigned.</p>`;
        }
        html += `</div>`;
        return html;
    }
    async function generateTeacherSalarySectionHTML(teacherId) {
        let html = `<div class="form-container" style="margin-top:20px;">
                    <div class="form-title">Salary Information</div>`;
        const salaryStructure = (await getAllFromIndex(STORES.SALARY_STRUCTURE, 'employeeId', teacherId)).find(s => s.employeeType === 'teacher');
        let totalPaid = 0;
        if (salaryStructure) {
            html += `<h4>Salary Structure</h4>
                 <div class="form-row">
                    <div class="form-group"><label>Basic:</label> <input class="form-control" value="${formatCurrency(salaryStructure.basicSalary)}" readonly></div>
                    <div class="form-group"><label>Allowances:</label> <input class="form-control" value="${formatCurrency((salaryStructure.houseRent || 0) + (salaryStructure.transport || 0) + (salaryStructure.medical || 0) + (salaryStructure.otherAllowances || 0))}" readonly></div>
                    <div class="form-group"><label>Net Salary:</label> <input class="form-control" value="${formatCurrency(salaryStructure.totalSalary)}" readonly></div>
                 </div>`;
        } else {
            const teacher = await getFromStore(STORES.TEACHERS, teacherId);
            html += `<h4>Salary Structure (From Profile)</h4>
                 <div class="form-row">
                    <div class="form-group"><label>Basic:</label> <input class="form-control" value="${formatCurrency(teacher.basicSalary)}" readonly></div>
                    <div class="form-group"><label>Allowances:</label> <input class="form-control" value="${formatCurrency(teacher.allowances)}" readonly></div>
                    <div class="form-group"><label>Net Salary:</label> <input class="form-control" value="${formatCurrency((teacher.basicSalary || 0) + (teacher.allowances || 0))}" readonly></div>
                 </div>`;
        }
        const paidRecords = (await getAllFromIndex(STORES.SALARY, 'employeeId', teacherId)).filter(s => s.employeeType === 'teacher');
        html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                <h4>Paid Salary History</h4>
                <button class="btn btn-success btn-sm no-print" onclick="exportTableToCSV('teacher-paid-salary-table', 'SalaryHistory_${teacherId}.csv')">Export Paid</button>
             </div>
             <div class="table-container" style=" overflow-y: auto;">
               <table class="table" id="teacher-paid-salary-table">
                 <thead><tr><th>Voucher</th><th>Month/Year</th><th>Date</th><th>Amount Paid</th><th>Bonus</th><th>Deductions</th><th>Total</th></tr></thead><tbody>`;
        if (paidRecords.length > 0) {
            paidRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rec => {
                totalPaid += rec.total;
                html += `<tr>
                <td>${rec.voucherNumber}</td>
                <td>${rec.month} ${rec.year}</td>
                <td>${formatDate(rec.date)}</td>
                <td>${formatCurrency(rec.amountPaid)}</td>
                <td>${formatCurrency(rec.bonus)}</td>
                <td>${formatCurrency(rec.deductions)}</td>
                <td>${formatCurrency(rec.total)}</td>
            </tr>`;
            });
        } else {
            html += `<tr><td colspan="7" style="text-align:center;">No paid salary records found.</td></tr>`;
        }
        html += `</tbody><tfoot><tr><td colspan="6" style="text-align:right; font-weight:bold;">Total Paid (All Time):</td><td>${formatCurrency(totalPaid)}</td></tr></tfoot></table></div></div>`;
        return html;
    }
</script>
<script>
    function applyMobileFix() {
        const MOBILE_BREAKPOINT = 768;
        function injectMobileCSS() {
            if (document.getElementById('mobile-fix-styles')) return;
            const css = `
                body.mobile-mode .main-container {
                    margin-left: 0 !important;
                    margin-right: 0 !important;
                    width: 100% !important;
                }
                body.mobile-mode .sidebar {
    transition: transform 0.3s ease-in-out;
    z-index: 1100;
}
                body.mobile-mode .sidebar.active {
                    transform: translateX(0);
                }
                body.rtl-mode.mobile-mode .sidebar {
                    transform: translateX(100%);
                }
                body.rtl-mode.mobile-mode .sidebar.active {
                    transform: translateX(0);
                }
                body.mobile-mode .dashboard-cards,
                body.mobile-mode .form-row {
                    flex-direction: column;
                }
                body.mobile-mode .card,
                body.mobile-mode .form-group {
                    min-width: 100%;
                }
                #mobile-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 1099;
    display: none;
}
            `;
            const style = document.createElement('style');
            style.id = 'mobile-fix-styles';
            style.textContent = css;
            document.head.appendChild(style);
            let backdrop = document.createElement('div');
            backdrop.id = 'mobile-backdrop';
            document.body.appendChild(backdrop);
        }
        function unifiedSidebarToggle() {
            const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            const backdrop = document.getElementById('mobile-backdrop');
            const isRtl = document.body.classList.contains('rtl-mode');
            sidebar.classList.toggle('active');
            const isActive = sidebar.classList.contains('active');
            if (isMobile) {
                backdrop.style.display = isActive ? 'block' : 'none';
            } else {
                const marginValue = isActive ? '250px' : '0';
                if (isRtl) {
                    mainContainer.style.marginRight = marginValue;
                    mainContainer.style.marginLeft = '0';
                } else {
                    mainContainer.style.marginLeft = marginValue;
                    mainContainer.style.marginRight = '0';
                }
            }
        }
        function masterToggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContainer = document.getElementById('mainContainer');
            const backdrop = document.getElementById('mobile-backdrop');
            const isMobile = window.innerWidth <= 768;
            const isRtl = document.body.classList.contains('rtl-mode');
            const isActive = sidebar.classList.toggle('active');
            const hideTransform = isRtl ? 'translateX(100%)' : 'translateX(-100%)';
            const showTransform = 'translateX(0)';
            sidebar.style.transform = isActive ? showTransform : hideTransform;
            if (isMobile) {
                backdrop.style.display = isActive ? 'block' : 'none';
                mainContainer.style.marginLeft = '0';
                mainContainer.style.marginRight = '0';
            } else {
                backdrop.style.display = 'none';
                const marginValue = isActive ? '250px' : '0';
                if (isRtl) {
                    mainContainer.style.marginRight = marginValue;
                    mainContainer.style.marginLeft = '0';
                } else {
                    mainContainer.style.marginLeft = marginValue;
                    mainContainer.style.marginRight = '0';
                }
            }
        }
        function attachSidebarListeners() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebarLinks = document.querySelectorAll('.sidebar-menu li');
            const backdrop = document.getElementById('mobile-backdrop');
            const newMenuToggle = menuToggle.cloneNode(true);
            menuToggle.parentNode.replaceChild(newMenuToggle, menuToggle);
            newMenuToggle.addEventListener('click', masterToggleSidebar);
            backdrop.addEventListener('click', masterToggleSidebar);
            sidebarLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('active')) {
                        masterToggleSidebar();
                    }
                });
            });
        }
        function manageLayout() {
            document.body.classList.toggle('mobile-mode', window.innerWidth <= MOBILE_BREAKPOINT);
        }
        injectMobileCSS();
        manageLayout();
        attachSidebarListeners();
        window.addEventListener('resize', manageLayout);
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applyMobileFix);
    } else {
        applyMobileFix();
    }
    async function runAutomaticBackupCheck() {
        try {
            const settings = await getFromStore(STORES.SETTINGS, 'general');
            if (!settings || !settings.autoBackupEnabled) {
                console.log('Automatic backup is disabled.');
                return;
            }
            const lastBackupTimestamp = localStorage.getItem('lastAutoBackupTimestamp');
            if (!lastBackupTimestamp) {
                console.log('Automatic backup is enabled. Waiting for the first scheduled interval.');
                return;
            }
            const now = new Date();
            const lastBackupDate = new Date(lastBackupTimestamp);
            let isDue = false;
            if (settings.autoBackupFrequency === 'daily') {
                const backupTime = settings.autoBackupTime || '02:00';
                const [hours, minutes] = backupTime.split(':').map(Number);
                const todaySchedule = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
                if (now < todaySchedule) {
                    isDue = false;
                } else {
                    if (lastBackupDate < todaySchedule) {
                        isDue = true;
                    }
                }
            } else {
                let daysToWait = 30;
                if (settings.autoBackupFrequency === 'weekly') {
                    daysToWait = 7;
                }
                const nextDueDate = new Date(lastBackupDate.getTime() + daysToWait * 24 * 60 * 60 * 1000);
                if (now >= nextDueDate) {
                    isDue = true;
                }
            }
            if (isDue) {
                console.log(`Automatic backup is due. Triggering download.`);
                showNotification('Automatic backup is due. Download will start...', 'info');
                await triggerAutomaticBackupDownload();
            } else {
                console.log('Automatic backup is not due yet.');
            }
        } catch (error) {
            console.error('Error during automatic backup check:', error);
        }
    }
    async function triggerAutomaticBackupDownload() {
        showLoading();
        try {
            let backupData = {};
            for (const storeName in STORES) {
                if (STORES[storeName] !== 'backup') {
                    backupData[STORES[storeName]] = await getAllFromStore(STORES[storeName]);
                }
            }
            const fileContent = JSON.stringify(backupData, null, 2);
            const backupBlob = new Blob([fileContent], { type: 'application/json' });
            const filename = `auto_backup_${new Date().toISOString().replace(/:/g, '-')}.json`;
            const url = URL.createObjectURL(backupBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            localStorage.setItem('lastAutoBackupTimestamp', new Date().toISOString());
            showNotification('Automatic backup downloaded successfully!', 'success');
        } catch (error) {
            console.error('Failed to create automatic backup file:', error);
            showNotification('Automatic backup failed.', 'error');
        } finally {
            hideLoading();
        }
    }
    async function generateTodaysAttendanceDetailsHTML() {
        const todayISO = new Date().toISOString().split('T')[0];
        const attendanceRecords = await getAllFromIndex(STORES.ATTENDANCE, 'date', todayISO);

        if (attendanceRecords.length === 0) {
            return '<div class="card"><p style="text-align:center;">No attendance was marked today.</p></div>';
        }

        const [allStudents, allClasses] = await Promise.all([
            getAllFromStore(STORES.STUDENTS),
            getAllFromStore(STORES.CLASSES)
        ]);

        const studentMap = new Map(allStudents.map(s => [s.id, s]));
        const classMap = new Map(allClasses.map(c => [c.id, c.name]));

        let tableHTML = `<div class="table-container" style="max-height: 70vh; overflow-y: auto;">
                       <table class="table">
                         <thead>
                           <tr>
                             <th>Roll No.</th>
                             <th>Student Name</th>
                             <th>Class</th>
                             <th>Status</th>
                             <th>Late</th>
                           </tr>
                         </thead>
                         <tbody>`;

        for (const record of attendanceRecords) {
            const student = studentMap.get(record.studentId);
            if (student) {
                const statusText = record.isLeave ? 'On Leave' : (record.status.charAt(0).toUpperCase() + record.status.slice(1));
                const statusColor = record.status === 'present' ? '#2ecc71' : (record.isLeave ? '#f39c12' : '#e74c3c');
                tableHTML += `<tr>
                            <td>${student.rollNumber || 'N/A'}</td>
                            <td>${student.name || 'N/A'}</td>
                            <td>${classMap.get(student.classId) || 'N/A'}</td>
                            <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
                            <td>${record.isLate ? 'Yes' : 'No'}</td>
                          </tr>`;
            }
        }

        tableHTML += `</tbody></table></div>`;
        return tableHTML;
    }
    async function performAutomaticBackup(settings) {
        console.log('Performing automatic backup...');
        let data = {};
        for (const storeName in STORES) {
            if (storeName !== 'BACKUP') {
                data[STORES[storeName]] = await getAllFromStore(STORES[storeName]);
            }
        }
        const filename = `auto_backup_${new Date().toISOString().replace(/:/g, '-')}.json`;
        const backupBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const backupRecord = {
            type: 'full-automatic',
            format: 'json',
            date: new Date().toISOString(),
            size: backupBlob.size,
            isAutomatic: true,
            filename: filename,
            blob: backupBlob
        };
        await addToStore(STORES.BACKUP, backupRecord);
        showNotification('Automatic backup created successfully.', 'info');
        await cleanupOldBackups(settings);
    }
    async function cleanupOldBackups(settings) {
        const retentionMonths = settings.autoBackupRetention || 3;
        const cutoffDate = new Date();
        cutoffDate.setMonth(cutoffDate.getMonth() - retentionMonths);
        const allAutoBackups = (await getAllFromStore(STORES.BACKUP)).filter(b => b.isAutomatic);
        let deletedCount = 0;
        for (const backup of allAutoBackups) {
            if (new Date(backup.date) < cutoffDate) {
                await deleteFromStore(STORES.BACKUP, backup.id);
                deletedCount++;
            }
        }
        if (deletedCount > 0) {
            console.log(`Cleaned up ${deletedCount} old automatic backup(s).`);
        }
    }


    async function editSection(id) {
        showLoading();
        try {
            const section = await getFromStore(STORES.SECTIONS, id);
            if (!section) {
                showNotification('Section not found.', 'error');
                return;
            }

            // Put the section's data into the form
            document.getElementById('section-class').value = section.classId;
            document.getElementById('section-name').value = section.name;
            document.getElementById('section-incharge').value = section.inChargeId;

            // Store the ID on the save button so it knows to update instead of create
            document.getElementById('save-section').dataset.editId = id;

        } catch (e) {
            console.error('Error loading section for edit:', e);
        } finally {
            hideLoading();
        }
    }
    function initializeShortcuts() {
        const shortcutConfig = {
            'alt+d': { func: () => showView('dashboard'), selector: '[data-view="dashboard"]', title: 'Dashboard' },
            'alt+s': { func: () => showView('students'), selector: '[data-view="students"]', title: 'Students' },
            'alt+t': { func: () => showView('teachers'), selector: '[data-view="teachers"]', title: 'Teachers' },
            'alt+f': { func: () => showView('fees'), selector: '[data-view="fees"]', title: 'Fees' },
            'alt+e': { func: () => showView('exams'), selector: '[data-view="exams"]', title: 'Exams' },
            'alt+c': { func: () => showView('classes'), selector: '[data-view="classes"]', title: 'Classes' },
            'alt+b': { func: () => showView('backup'), selector: '[data-view="backup"]', title: 'Backup' },
            /* 'alt+i': { func: () => showView('id-cards'), selector: '[data-view="id-cards"]', title: 'ID Cards' }, */
            'alt+p': { func: () => showView('salaries'), selector: '[data-view="salaries"]', title: 'Salaries (Pay)' },
            'alt+l': { func: () => showView('library'), selector: '[data-view="library"]', title: 'Library' },
            'alt+r': { func: () => showView('reports'), selector: '[data-view="reports"]', title: 'Reports' },
            /* 'alt+o': { func: () => showView('settings'), selector: '[data-view="settings"]', title: 'Settings (Options)' }, */
        };

        function addShortcutTooltips() {
            for (const key in shortcutConfig) {
                const config = shortcutConfig[key];
                const element = document.querySelector(config.selector);
                if (element) {
                    const shortcutHint = `(${key.replace('alt+', 'Alt+')})`;
                    element.title = `${config.title} ${shortcutHint}`;
                }
            }
        }

        function findVisibleElement(selector) {
            const elements = Array.from(document.querySelectorAll(selector));
            return elements.find(el => el.offsetParent !== null);
        }

        function handleKeydown(e) {
            if (!e.key) return;
            if (e.target.matches('input, textarea, select')) {
                if (e.key === 'Escape') {
                    e.target.blur();
                } else if (e.key.toLowerCase() === 's' && e.ctrlKey) {
                    e.preventDefault();
                    const submitButton = findVisibleElement('.tab-content.active form .btn-primary[type="submit"]');
                    if (submitButton) submitButton.click();
                }
                return;
            }

            const key = `${e.altKey ? 'alt+' : ''}${e.ctrlKey ? 'ctrl+' : ''}${e.shiftKey ? 'shift+' : ''}${e.key.toLowerCase()}`;

            if (shortcutConfig[key]) {
                e.preventDefault();
                shortcutConfig[key].func();
                return;
            }

            switch (e.key) {
                case 'Escape':
                    const visibleModal = findVisibleElement('.modal[style*="display: block"]');
                    if (visibleModal) {
                        e.preventDefault();
                        const closeButton = visibleModal.querySelector('.close');
                        if (closeButton) closeButton.click();
                    }
                    break;
                case '1':
                case '2':
                case '3':
                case '4':
                    if (e.altKey) {
                        e.preventDefault();
                        const activeView = findVisibleElement('.section-view');
                        if (activeView) {
                            const tabIndex = parseInt(e.key) - 1;
                            const tab = activeView.querySelectorAll('.tabs .tab')[tabIndex];
                            if (tab) tab.click();
                        }
                    }
                    break;
            }
        }

        addShortcutTooltips();
        document.addEventListener('keydown', handleKeydown);
    }

    // Activate the shortcut system
    initializeShortcuts();
</script>
<script>
    let protectionEnabled = true;

    function blockKeys(e) {
        if (!protectionEnabled) return;

        const isCtrl = e.ctrlKey;
        const isAlt = e.altKey;
        const isShift = e.shiftKey;

        // Allow Ctrl+C / Ctrl+V / Alt+F4 / Tab
        const allowed =
            (isCtrl && ['c', 'v'].includes(e.key.toLowerCase())) ||
            (isAlt && e.key === 'F4') ||
            e.key === 'Tab';

        // Secret unlock: Ctrl+Alt+Shift+Y
        if (isCtrl && isAlt && isShift && e.key.toLowerCase() === 'y') {
            protectionEnabled = false;
            alert("Protection disabled.");
            return;
        }

        // Block common dev shortcuts
        const blocked =
            e.key === 'F12' ||
            (isCtrl && ['u', 's', 'p', 'i', 'j', 'k'].includes(e.key.toLowerCase())) ||
            (isCtrl && isShift) ||
            (isCtrl && isAlt && e.key.toLowerCase() === 'i');

        if (blocked && !allowed) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    }

    document.addEventListener('keydown', blockKeys);

    document.addEventListener('contextmenu', function (e) {
        if (protectionEnabled) e.preventDefault();
    });

    document.addEventListener('dragstart', function (e) {
        if (protectionEnabled) e.preventDefault();
    });

    // Optional: Clear page if DevTools is open
    setInterval(() => {
        if (!protectionEnabled) return;
        const open = window.outerWidth - window.innerWidth > 160 || window.outerHeight - window.innerHeight > 160;
        if (open) {
            document.body.innerHTML = "<h1 style='color:red; text-align:center;'>DevTools are blocked</h1>";
        }
    }, 1000);
</script>
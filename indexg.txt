<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯Ø±Ø³Û Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ Ø³Ø³Ù¹Ù…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- Ø¨Ù†ÛŒØ§Ø¯ÛŒ Ø§Ø³Ù¹Ø§Ø¦Ù„ --- */
        :root {
            --primary-color: #006400; /* Dark Green */
            --secondary-color: #f4f4f4; /* Light Gray */
            --text-color: #333;
            --border-color: #ccc;
            --input-bg: transparent; /* Transparent background for inputs */
            --input-text-color: #000; /* Black text for inputs */
            --register-line-color: #e0e0e0; /* Light gray lines for register look */
            --button-bg: var(--primary-color);
            --button-text: #fff;
            --button-hover-bg: #004d00; /* Darker Green */
        }

        body {
            font-family: 'Noto Nastaliq Urdu', 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.8; /* Improved readability for Urdu */
            font-size: 16px; /* Base font size */
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        h1, h2, h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        /* --- Ù†ÛŒÙˆÛŒÚ¯ÛŒØ´Ù† --- */
        nav {
            background-color: var(--primary-color);
            padding: 10px 0;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: center;
        }

        nav ul li {
            display: inline-block;
            margin: 0 10px;
        }

        nav ul li button {
            background: none;
            border: none;
            color: var(--button-text);
            padding: 10px 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1em;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        nav ul li button:hover, nav ul li button.active {
            background-color: var(--button-hover-bg);
        }

        /* --- Ù…Ø§ÚˆÛŒÙˆÙ„ Ø³ÛŒÚ©Ø´Ù†Ø² --- */
        .module-section {
            display: none; /* Initially hide all sections */
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-top: 20px;
            background-color: #fff;
        }

        .module-section.active {
            display: block; /* Show active section */
        }

        /* --- ÙØ§Ø±Ù… Ø§ÙˆØ± Ø§Ù† Ù¾Ù¹ Ø§Ø³Ù¹Ø§Ø¦Ù„ (Ø±Ø¬Ø³Ù¹Ø± Ù„ÙÚ©) --- */
        form {
            display: grid;
            gap: 15px; /* Spacing between form elements */
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
            color: var(--primary-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="tel"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 8px 5px; /* Padding for text */
            font-family: 'Noto Nastaliq Urdu', 'Courier New', monospace; /* Monospace/Nastaliq for printed look */
            font-size: 1em;
            color: var(--input-text-color);
            background-color: var(--input-bg);
            border: none; /* No border */
            border-bottom: 1px solid var(--register-line-color); /* Underline like a register */
            box-sizing: border-box;
            transition: border-color 0.3s ease;
            border-radius: 0; /* Sharp corners */
            direction: rtl; /* Ensure input direction is RTL */
            text-align: right; /* Align text to the right */
        }
         input[type="file"] {
            width: 100%;
            padding: 8px 5px;
            font-family: inherit;
            font-size: 1em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
         }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-bottom-color: var(--primary-color); /* Highlight bottom border on focus */
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button[type="submit"], .btn {
            padding: 12px 25px;
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1.1em;
            transition: background-color 0.3s ease;
            text-align: center;
        }

        button[type="submit"]:hover, .btn:hover {
            background-color: var(--button-hover-bg);
        }

        .btn-secondary {
            background-color: #6c757d; /* Gray */
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-danger {
             background-color: #dc3545; /* Red */
        }
        .btn-danger:hover {
             background-color: #c82333;
        }

        /* --- Ù¹ÛŒØ¨Ù„ Ø§Ø³Ù¹Ø§Ø¦Ù„ --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 10px;
            text-align: right;
            vertical-align: middle;
        }

        th {
            background-color: var(--primary-color);
            color: var(--button-text);
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: var(--secondary-color);
        }

        /* --- Ù¾Ø±Ù†Ù¹ Ø§Ø³Ù¹Ø§Ø¦Ù„ --- */
        @media print {
            body {
                font-family: 'Noto Nastaliq Urdu', 'Times New Roman', serif; /* Serif font for print */
                background-color: #fff;
                color: #000;
                font-size: 12pt; /* Standard print size */
            }

            nav, .no-print, button, .btn {
                display: none !important; /* Hide navigation and buttons */
            }

            .container, .module-section {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                max-width: 100%;
            }

            h1, h2, h3 {
                 color: #000;
                 text-align: center;
                 margin-bottom: 15px;
                 font-size: 16pt;
            }
             h1 { font-size: 18pt; }

            table {
                width: 100%;
                border: 1px solid #000; /* Solid black border for table */
                font-size: 11pt;
            }

            th, td {
                border: 1px solid #000; /* Solid black border for cells */
                padding: 5px;
                color: #000;
                background-color: #fff !important; /* Ensure no background color */
            }
            th {
                font-weight: bold;
            }

            input[type="text"],
            input[type="number"],
            input[type="date"],
            input[type="tel"],
            input[type="email"],
            textarea,
            select {
                border: none !important;
                border-bottom: 1px dotted #000 !important; /* Dotted line for print */
                padding: 2px 0 !important;
                background-color: transparent !important;
                color: #000 !important;
                font-family: inherit !important;
                font-size: 11pt !important;
                box-shadow: none !important;
                -webkit-print-color-adjust: exact; /* Ensure styles are printed */
                 color-adjust: exact;
            }
             /* Style specific printable sections like receipts, ID cards etc. here */
             .printable-receipt, .printable-id-card, .printable-register {
                 border: 1px solid #000;
                 padding: 15px;
                 margin-bottom: 20px;
             }
             .printable-header {
                 text-align: center;
                 margin-bottom: 20px;
                 border-bottom: 1px solid #000;
                 padding-bottom: 10px;
             }
             .printable-header img {
                 max-width: 80px;
                 max-height: 80px;
                 display: block;
                 margin: 0 auto 10px;
             }
             .printable-footer {
                 margin-top: 30px;
                 text-align: center;
                 font-size: 10pt;
             }
        }
    </style>
</head>
<body>

    <div class="container">
        <header style="text-align: center; margin-bottom: 20px;">
            <img id="madrasaLogoPreview" src="https://placehold.co/100x100/eee/ccc?text=Ù„ÙˆÚ¯Ùˆ" alt="Ù…Ø¯Ø±Ø³Û Ù„ÙˆÚ¯Ùˆ" style="max-width: 100px; max-height: 100px; border-radius: 50%; margin-bottom: 10px;">
            <h1 id="madrasaNamePreview">Ù…Ø¯Ø±Ø³Û Ú©Ø§ Ù†Ø§Ù…</h1>
            <p id="madrasaAddressPreview" style="margin: 5px 0;">Ù¾ØªÛ</p>
            <p id="madrasaPhonePreview" style="margin: 5px 0;">ÙÙˆÙ† Ù†Ù…Ø¨Ø±</p>
        </header>

        <nav>
            <ul>
                <li><button onclick="showModule('settings')">ØªØ±ØªÛŒØ¨Ø§Øª</button></li>
                <li><button onclick="showModule('students')">Ø·Ù„Ø¨Ø§Ø¡</button></li>
                <li><button onclick="showModule('teachers')">Ø§Ø³Ø§ØªØ°Û</button></li>
                <li><button onclick="showModule('classes')">Ú©Ù„Ø§Ø³ÛŒÚº/Ù…Ø¶Ø§Ù…ÛŒÙ†</button></li>
                <li><button onclick="showModule('attendance')">Ø­Ø§Ø¶Ø±ÛŒ</button></li>
                <li><button onclick="showModule('exams')">Ø§Ù…ØªØ­Ø§Ù†Ø§Øª/Ù†ØªØ§Ø¦Ø¬</button></li>
                <li><button onclick="showModule('fees')">ÙÛŒØ³</button></li>
                <li><button onclick="showModule('salary')">ØªÙ†Ø®ÙˆØ§Û</button></li>
                <li><button onclick="showModule('ledger')">Ú©Ú¾Ø§ØªÛ</button></li>
                <li><button onclick="showModule('reports')">Ø±Ù¾ÙˆØ±Ù¹Ø³</button></li>
            </ul>
        </nav>

        <main id="mainContent">
            <section id="settings" class="module-section">
                <h2><span class="icon">âš™ï¸</span> ØªØ±ØªÛŒØ¨Ø§Øª</h2>
                <form id="settingsForm">
                    <h3>Ù…Ø¯Ø±Ø³Û Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h3>
                    <div>
                        <label for="madrasaName">Ù…Ø¯Ø±Ø³Û Ú©Ø§ Ù†Ø§Ù…:</label>
                        <input type="text" id="madrasaName" required>
                    </div>
                    <div>
                        <label for="madrasaAddress">Ù¾ØªÛ:</label>
                        <textarea id="madrasaAddress" rows="2"></textarea>
                    </div>
                    <div>
                        <label for="madrasaPhone">ÙÙˆÙ† Ù†Ù…Ø¨Ø±:</label>
                        <input type="tel" id="madrasaPhone">
                    </div>
                    <div>
                        <label for="madrasaLogo">Ù„ÙˆÚ¯Ùˆ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label>
                        <input type="file" id="madrasaLogo" accept="image/*">
                        <small>Ù…ÙˆØ¬ÙˆØ¯Û Ù„ÙˆÚ¯Ùˆ Ú©Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ù†Ø¦ÛŒ ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚºÛ”</small>
                    </div>

                    <h3>ØªØ¹Ù„ÛŒÙ…ÛŒ Ø³Ø§Ù„</h3>
                    <div>
                        <label for="academicYearStart">Ø¢ØºØ§Ø²:</label>
                        <input type="date" id="academicYearStart">
                    </div>
                     <div>
                        <label for="academicYearEnd">Ø§Ø®ØªØªØ§Ù…:</label>
                        <input type="date" id="academicYearEnd">
                    </div>

                    <h3>ÚˆÛŒÙØ§Ù„Ù¹ ÙÛŒØ³ Ø§ÙˆØ± ØªÙ†Ø®ÙˆØ§Û</h3>
                     <div>
                        <label for="defaultFee">ÚˆÛŒÙØ§Ù„Ù¹ Ù…Ø§ÛØ§Ù†Û ÙÛŒØ³ (Ù…Ø«Ø§Ù„):</label>
                        <input type="number" id="defaultFee" placeholder="Ù…Ø«Ø§Ù„: 1000">
                    </div>
                     <div>
                        <label for="defaultSalary">ÚˆÛŒÙØ§Ù„Ù¹ Ù…Ø§ÛØ§Ù†Û ØªÙ†Ø®ÙˆØ§Û (Ù…Ø«Ø§Ù„):</label>
                        <input type="number" id="defaultSalary" placeholder="Ù…Ø«Ø§Ù„: 15000">
                    </div>

                     <h3>Ø±Ø³ÛŒØ¯/Ø±Ù¾ÙˆØ±Ù¹ Ù¾Ø±Ù†Ù¹Ù†Ú¯</h3>
                     <div>
                        <label for="printSignature">Ù…ÛØ±/Ø¯Ø³ØªØ®Ø· (ØªØµÙˆÛŒØ± Ø§Ù¾Ù„ÙˆÚˆ):</label>
                        <input type="file" id="printSignature" accept="image/*">
                         <img id="signaturePreview" src="https://placehold.co/150x50/eee/ccc?text=Ø¯Ø³ØªØ®Ø·" alt="Ø¯Ø³ØªØ®Ø· Ù¾ÛŒØ´ Ù…Ù†Ø¸Ø±" style="max-width: 150px; max-height: 50px; margin-top: 5px;">
                    </div>


                    <button type="submit" class="btn">Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
                </form>

                <hr style="margin: 30px 0;">

                <h3><span class="icon">ğŸ’¾</span> ÚˆÛŒÙ¹Ø§ Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹</h3>
                 <div style="display: flex; justify-content: space-around; gap: 15px;" class="no-print">
                    <button onclick="exportData()" class="btn btn-secondary"><span class="icon">ğŸ“¤</span> Ù…Ú©Ù…Ù„ ÚˆÛŒÙ¹Ø§ Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹</button>
                    <div>
                        <label for="importFile" class="btn btn-secondary" style="cursor: pointer;"><span class="icon">ğŸ“¥</span> Ù…Ú©Ù…Ù„ ÚˆÛŒÙ¹Ø§ Ø§Ù…Ù¾ÙˆØ±Ù¹</label>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                        <small style="display: block; text-align: center; margin-top: 5px;">ØµØ±Ù .json ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚºÛ”</small>
                    </div>
                     <button onclick="backupData()" class="btn btn-secondary"><span class="icon">ğŸ”„</span> Ø¨ÛŒÚ© Ø§Ù¾ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                </div>
                 <p id="importExportStatus" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
            </section>

            <section id="students" class="module-section">
                <h2><span class="icon">ğŸ‘¨â€ğŸ“</span> Ø·Ù„Ø¨Ø§Ø¡ Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹</h2>

                <form id="studentForm">
                    <input type="hidden" id="studentId"> <div>
                        <label for="studentName">Ù†Ø§Ù…:</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div>
                        <label for="fatherName">ÙˆØ§Ù„Ø¯ Ú©Ø§ Ù†Ø§Ù…:</label>
                        <input type="text" id="fatherName" required>
                    </div>
                    <div>
                        <label for="dob">ØªØ§Ø±ÛŒØ® Ù¾ÛŒØ¯Ø§Ø¦Ø´:</label>
                        <input type="date" id="dob">
                    </div>
                    <div>
                        <label for="admissionNumber">Ø¯Ø§Ø®Ù„Û Ù†Ù…Ø¨Ø±:</label>
                        <input type="text" id="admissionNumber" required>
                    </div>
                    <div>
                        <label for="studentClass">Ú©Ù„Ø§Ø³:</label>
                        <select id="studentClass" required>
                            <option value="">Ú©Ù„Ø§Ø³ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>
                        </select>
                    </div>
                    <div>
                        <label for="contactNumber">Ø±Ø§Ø¨Ø·Û Ù†Ù…Ø¨Ø±:</label>
                        <input type="tel" id="contactNumber">
                    </div>
                     <div>
                        <label for="studentAddress">Ù¾ØªÛ:</label>
                        <textarea id="studentAddress" rows="2"></textarea>
                    </div>
                     <div>
                        <label for="studentStatus">Ø§Ø³Ù¹ÛŒÙ¹Ø³:</label>
                        <select id="studentStatus" required>
                            <option value="active" selected>ÙØ¹Ø§Ù„</option>
                            <option value="transferred">Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯Û</option>
                            <option value="dropout">ÙØ§Ø±Øº Ø§Ù„ØªØ­ØµÛŒÙ„/Ø®Ø§Ø±Ø¬ Ø´Ø¯Û</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ø´Ø§Ù…Ù„/Ø§Ù¾ ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº</button>
                    <button type="button" onclick="resetStudentForm()" class="btn btn-secondary">ÙØ§Ø±Ù… Ø±ÛŒ Ø³ÛŒÙ¹</button>
                </form>

                <hr>

                <h3>Ø·Ù„Ø¨Ø§Ø¡ Ú©ÛŒ ÙÛØ±Ø³Øª</h3>
                 <div style="margin-bottom: 15px; display: flex; gap: 10px;" class="no-print">
                    <label for="filterStudentClass">Ú©Ù„Ø§Ø³ Ú©Û’ Ù„Ø­Ø§Ø¸ Ø³Û’ ÙÙ„Ù¹Ø±:</label>
                    <select id="filterStudentClass" onchange="renderStudentList()">
                        <option value="">ØªÙ…Ø§Ù… Ú©Ù„Ø§Ø³ÛŒÚº</option>
                        </select>
                    <label for="filterStudentStatus">Ø§Ø³Ù¹ÛŒÙ¹Ø³ Ú©Û’ Ù„Ø­Ø§Ø¸ Ø³Û’ ÙÙ„Ù¹Ø±:</label>
                    <select id="filterStudentStatus" onchange="renderStudentList()">
                        <option value="">ØªÙ…Ø§Ù… Ø§Ø³Ù¹ÛŒÙ¹Ø³</option>
                        <option value="active">ÙØ¹Ø§Ù„</option>
                        <option value="transferred">Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯Û</option>
                        <option value="dropout">ÙØ§Ø±Øº Ø§Ù„ØªØ­ØµÛŒÙ„/Ø®Ø§Ø±Ø¬ Ø´Ø¯Û</option>
                    </select>
                 </div>

                <table id="studentTable">
                    <thead>
                        <tr>
                            <th>Ù†Ø§Ù…</th>
                            <th>ÙˆØ§Ù„Ø¯ Ú©Ø§ Ù†Ø§Ù…</th>
                            <th>Ø¯Ø§Ø®Ù„Û Ù†Ù…Ø¨Ø±</th>
                            <th>Ú©Ù„Ø§Ø³</th>
                            <th>Ø§Ø³Ù¹ÛŒÙ¹Ø³</th>
                            <th>Ú©Ø§Ø±ÙˆØ§Ø¦ÛŒØ§Úº</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        </tbody>
                </table>
                 <button onclick="printStudentList()" class="btn no-print" style="margin-top: 15px;">ÙÛØ±Ø³Øª Ù¾Ø±Ù†Ù¹ Ú©Ø±ÛŒÚº</button>

                 <div id="printableIdCardArea" style="display: none;">
                     </div>

            </section>

            <section id="teachers" class="module-section"><h2><span class="icon">ğŸ‘¨â€ğŸ«</span> Ø§Ø³Ø§ØªØ°Û Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="classes" class="module-section"><h2><span class="icon">ğŸ“š</span> Ú©Ù„Ø§Ø³ÛŒÚº/Ù…Ø¶Ø§Ù…ÛŒÙ† (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="attendance" class="module-section"><h2><span class="icon"> P </span> Ø­Ø§Ø¶Ø±ÛŒ (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="exams" class="module-section"><h2><span class="icon">ğŸ“Š</span> Ø§Ù…ØªØ­Ø§Ù†Ø§Øª/Ù†ØªØ§Ø¦Ø¬ (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="fees" class="module-section"><h2><span class="icon">ğŸ’°</span> ÙÛŒØ³ Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="salary" class="module-section"><h2><span class="icon">ğŸ’µ</span> ØªÙ†Ø®ÙˆØ§Û Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="ledger" class="module-section"><h2><span class="icon">ğŸ“’</span> Ú©Ú¾Ø§ØªÛ Ø³Ø³Ù¹Ù… (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>
            <section id="reports" class="module-section"><h2><span class="icon">ğŸ“„</span> Ø±Ù¾ÙˆØ±Ù¹Ø³ (Ø¬Ù„Ø¯ Ø¢Ø±ÛØ§ ÛÛ’)</h2></section>

        </main>

        <footer style="text-align: center; margin-top: 30px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 0.9em;" class="no-print">
            <p>&copy; <span id="currentYear"></span> Ù…Ø¯Ø±Ø³Û Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹ Ø³Ø³Ù¹Ù…Û” ØªÙ…Ø§Ù… Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ ÛÛŒÚºÛ”</p>
        </footer>
    </div>

    <script>
// --- IndexedDB Setup ---
const DB_NAME = 'MadrasaDB';
const DB_VERSION = 2; // <<<<<<< INCREASED DB VERSION FOR UPGRADE
let db;

const STORE_NAMES = {
    SETTINGS: 'settings',
    STUDENTS: 'students',
    TEACHERS: 'teachers',
    CLASSES: 'classes',
    SUBJECTS: 'subjects', // Added, though might be part of CLASSES or separate
    ATTENDANCE: 'attendance',
    EXAMS: 'exams',
    RESULTS: 'results',
    FEES: 'fees',
    SALARIES: 'salaries',
    LEDGER: 'ledger'
};

function openDB() {
    return new Promise((resolve, reject) => {
        console.log(`Opening DB ${DB_NAME} with version ${DB_VERSION}`);
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = (event) => {
            console.error("Database error:", event.target.error); // More specific error
            reject("Database error: " + event.target.error);
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log("Database opened successfully");
            // Check for potential version change issues if db was already open
            db.onversionchange = (event) => {
                console.log("Database version change detected, closing connection.");
                db.close();
                alert("ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ú©Ø§ Ù†ÛŒØ§ ÙˆØ±Ú˜Ù† Ø¯Ø³ØªÛŒØ§Ø¨ ÛÛ’Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… ØµÙØ­Û Ø±ÛŒÙØ±ÛŒØ´ Ú©Ø±ÛŒÚºÛ”");
                // Optionally force reload: window.location.reload();
            };
            resolve(db);
        };

        // This event only executes if the DB version changes.
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            const transaction = event.target.transaction; // Get transaction from event
            console.log(`Database upgrade needed from version ${event.oldVersion} to ${event.newVersion}`);

            // Create object stores if they don't exist
            if (!db.objectStoreNames.contains(STORE_NAMES.SETTINGS)) {
                db.createObjectStore(STORE_NAMES.SETTINGS);
                console.log(`Object store ${STORE_NAMES.SETTINGS} created`);
            }
            if (!db.objectStoreNames.contains(STORE_NAMES.STUDENTS)) {
                const studentStore = db.createObjectStore(STORE_NAMES.STUDENTS, { keyPath: 'id', autoIncrement: true });
                studentStore.createIndex('admissionNumber', 'admissionNumber', { unique: true });
                studentStore.createIndex('name', 'name', { unique: false });
                studentStore.createIndex('class', 'class', { unique: false });
                studentStore.createIndex('status', 'status', { unique: false });
                console.log(`Object store ${STORE_NAMES.STUDENTS} created`);
            }
            if (!db.objectStoreNames.contains(STORE_NAMES.CLASSES)) {
                 const classStore = db.createObjectStore(STORE_NAMES.CLASSES, { keyPath: 'id', autoIncrement: true });
                 // Index on class name for uniqueness checks and lookups
                 classStore.createIndex('name', 'name', { unique: true });
                 console.log(`Object store ${STORE_NAMES.CLASSES} created`);
            }
             // Create Teachers store if it doesn't exist (during upgrade)
            if (!db.objectStoreNames.contains(STORE_NAMES.TEACHERS)) {
                const teacherStore = db.createObjectStore(STORE_NAMES.TEACHERS, { keyPath: 'id', autoIncrement: true });
                teacherStore.createIndex('name', 'name', { unique: false });
                teacherStore.createIndex('phone', 'phone', { unique: false }); // Example index
                 // Add other indexes as needed (subjects, salaryType etc.)
                console.log(`Object store ${STORE_NAMES.TEACHERS} created`);
            }
            // Create Subjects store (optional, could be part of classes)
            // if (!db.objectStoreNames.contains(STORE_NAMES.SUBJECTS)) {
            //     const subjectStore = db.createObjectStore(STORE_NAMES.SUBJECTS, { keyPath: 'id', autoIncrement: true });
            //     subjectStore.createIndex('name', 'name', { unique: true });
            //     console.log(`Object store ${STORE_NAMES.SUBJECTS} created`);
            // }

            // Add placeholders for other stores if needed during upgrade
            // Example:
            // if (!db.objectStoreNames.contains(STORE_NAMES.ATTENDANCE)) {
            //     db.createObjectStore(STORE_NAMES.ATTENDANCE, { keyPath: 'id', autoIncrement: true });
            //     console.log(`Object store ${STORE_NAMES.ATTENDANCE} created`);
            // }


            console.log("Database upgrade complete");
            // Note: Transaction commits automatically on success
        };
    });
}

// --- Utility Functions for DB Operations (No changes needed here) ---

// Add or Update data in a store
function dbAddOrUpdate(storeName, data, key = undefined) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Database not open");
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = key ? store.put(data, key) : store.put(data); // put handles both add and update

        request.onsuccess = (event) => resolve(event.target.result); // result is the key
        request.onerror = (event) => {
            console.error(`Error adding/updating data to ${storeName}:`, event.target.error);
            reject(event.target.error); // Pass the specific error object
        };
        transaction.onabort = (event) => {
             console.error(`Add/Update transaction aborted for ${storeName}:`, event.target.error);
             reject(event.target.error || new Error('Transaction aborted'));
        }
    });
}

// Get data from a store by key
function dbGet(storeName, key) {
    return new Promise((resolve, reject) => {
        if (!db) return reject("Database not open");
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.get(key);

        request.onsuccess = (event) => resolve(event.target.result); // result is the object or undefined
        request.onerror = (event) => {
            console.error(`Error getting data from ${storeName} with key ${key}:`, event.target.error);
            reject(event.target.error);
        };
    });
}

// Get all data from a store
function dbGetAll(storeName) {
    return new Promise((resolve, reject) => {
         if (!db) return reject("Database not open");
        const transaction = db.transaction([storeName], 'readonly');
        const store = transaction.objectStore(storeName);
        const request = store.getAll();

        request.onsuccess = (event) => resolve(event.target.result); // result is an array of objects
        request.onerror = (event) => {
            console.error(`Error getting all data from ${storeName}:`, event.target.error);
            reject(event.target.error);
        };
    });
}

// Delete data from a store by key
function dbDelete(storeName, key) {
    return new Promise((resolve, reject) => {
         if (!db) return reject("Database not open");
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.delete(key);

        request.onsuccess = () => resolve(); // No result on success
        request.onerror = (event) => {
            console.error(`Error deleting data from ${storeName} with key ${key}:`, event.target.error);
            reject(event.target.error);
        };
         transaction.onabort = (event) => {
             console.error(`Delete transaction aborted for ${storeName}:`, event.target.error);
             reject(event.target.error || new Error('Transaction aborted'));
        }
    });
}

// Clear all data from a store
function dbClearStore(storeName) {
     return new Promise((resolve, reject) => {
         if (!db) return reject("Database not open");
        const transaction = db.transaction([storeName], 'readwrite');
        const store = transaction.objectStore(storeName);
        const request = store.clear();

        request.onsuccess = () => resolve();
        request.onerror = (event) => {
            console.error(`Error clearing store ${storeName}:`, event.target.error);
            reject(event.target.error);
        };
         transaction.onabort = (event) => {
             console.error(`Clear store transaction aborted for ${storeName}:`, event.target.error);
             reject(event.target.error || new Error('Transaction aborted'));
        }
    });
}

// --- Layout Adjustment Function ---
function applyFormLayout(formElement) {
    if (!formElement) return;

    // Simple two-column layout attempt using CSS grid applied via JS
    formElement.style.display = 'grid';
    // Adjust based on number of direct children (label+input pairs usually)
    // This is a basic heuristic and might need refinement based on actual form structure
    const directChildren = Array.from(formElement.children).filter(el => el.tagName === 'DIV'); // Assuming label/input are wrapped in DIVs
    if (directChildren.length > 3) { // Apply grid only if there are enough elements
        formElement.style.gridTemplateColumns = 'repeat(auto-fit, minmax(300px, 1fr))'; // Responsive columns
        formElement.style.gap = '15px 25px'; // Row gap and column gap
    } else {
        formElement.style.gridTemplateColumns = '1fr'; // Single column for fewer items
    }

    // Ensure buttons span full width if needed, or handle separately
    const buttons = formElement.querySelectorAll('button');
    buttons.forEach(btn => {
        // Optional: Make buttons span full grid width if they are direct children
        if (btn.parentElement === formElement) {
           // btn.style.gridColumn = '1 / -1'; // Span all columns
        }
    });
}


// --- Module Switching Logic ---
function showModule(moduleId) {
    // Hide all sections
    document.querySelectorAll('.module-section').forEach(section => {
        section.style.display = 'none';
        section.classList.remove('active');
    });

    // Deactivate all nav buttons
    document.querySelectorAll('nav ul li button').forEach(button => {
        button.classList.remove('active');
    });

    // Show the selected section
    const activeSection = document.getElementById(moduleId);
    if (activeSection) {
        activeSection.style.display = 'block';
        activeSection.classList.add('active');

         // Activate the corresponding nav button
         const activeButton = document.querySelector(`nav ul li button[onclick="showModule('${moduleId}')"]`);
         if(activeButton) {
             activeButton.classList.add('active');
         }

        // Apply layout adjustments to forms in specific modules
        const formElement = activeSection.querySelector('form');
        if (formElement && ['settings', 'students', 'classes', 'teachers'].includes(moduleId)) {
             applyFormLayout(formElement);
        }


        // Load data specific to the module if needed
        if (moduleId === 'students') {
            loadClassesIntoStudentForm(); // Ensure classes are loaded in student form dropdown
            renderStudentList();
        } else if (moduleId === 'settings') {
            loadSettings(); // Load settings when module is shown
        } else if (moduleId === 'classes') {
             renderClassList(); // Load classes when module is shown
        } else if (moduleId === 'teachers') {
             loadClassesIntoTeacherForm(); // Load classes into teacher form dropdown
             // renderTeacherList(); // Add this when teacher list is implemented
        }
        // Add similar conditions for other modules to load their data
    } else {
        console.warn(`Module section with id "${moduleId}" not found.`);
        // Optionally show a default or error section
         const defaultSection = document.getElementById('settings'); // Show settings by default if module not found
         if (defaultSection) {
            defaultSection.style.display = 'block';
            defaultSection.classList.add('active');
            const defaultButton = document.querySelector(`nav ul li button[onclick="showModule('settings')"]`);
            if(defaultButton) defaultButton.classList.add('active');
            loadSettings();
            const formElement = defaultSection.querySelector('form');
             if (formElement) applyFormLayout(formElement);
         }
    }
}

// --- Settings Module Logic (Mostly unchanged) ---
const settingsForm = document.getElementById('settingsForm');
const madrasaNameInput = document.getElementById('madrasaName');
const madrasaAddressInput = document.getElementById('madrasaAddress');
const madrasaPhoneInput = document.getElementById('madrasaPhone');
const madrasaLogoInput = document.getElementById('madrasaLogo');
const madrasaLogoPreview = document.getElementById('madrasaLogoPreview');
const madrasaNamePreview = document.getElementById('madrasaNamePreview');
const madrasaAddressPreview = document.getElementById('madrasaAddressPreview');
const madrasaPhonePreview = document.getElementById('madrasaPhonePreview');
const academicYearStartInput = document.getElementById('academicYearStart');
const academicYearEndInput = document.getElementById('academicYearEnd');
const defaultFeeInput = document.getElementById('defaultFee');
const defaultSalaryInput = document.getElementById('defaultSalary');
const printSignatureInput = document.getElementById('printSignature');
const signaturePreview = document.getElementById('signaturePreview');

// Function to read file as Data URL (Helper)
const readFileAsDataURL = (file) => {
    return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
};

async function saveSettings() {
    const logoFile = madrasaLogoInput.files[0];
    const signatureFile = printSignatureInput.files[0];

    try {
        // Get current settings to preserve existing images if no new file is uploaded
        const currentSettings = await dbGet(STORE_NAMES.SETTINGS, 'madrasaConfig') || {};

        const logoDataUrl = logoFile ? await readFileAsDataURL(logoFile) : currentSettings.logoDataUrl;
        const signatureDataUrl = signatureFile ? await readFileAsDataURL(signatureFile) : currentSettings.signatureDataUrl;

        const settingsData = {
            madrasaName: madrasaNameInput.value.trim(),
            madrasaAddress: madrasaAddressInput.value.trim(),
            madrasaPhone: madrasaPhoneInput.value.trim(),
            academicYearStart: academicYearStartInput.value,
            academicYearEnd: academicYearEndInput.value,
            defaultFee: defaultFeeInput.value,
            defaultSalary: defaultSalaryInput.value,
            logoDataUrl: logoDataUrl,
            signatureDataUrl: signatureDataUrl
        };

        await dbAddOrUpdate(STORE_NAMES.SETTINGS, settingsData, 'madrasaConfig');
        alert('ØªØ±ØªÛŒØ¨Ø§Øª Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ù…Ø­ÙÙˆØ¸ ÛÙˆÚ¯Ø¦ÛŒÚºÛ”');
        loadSettings(); // Reload settings to update UI and previews
    } catch (error) {
        console.error("Error saving settings:", error);
        alert('ØªØ±ØªÛŒØ¨Ø§Øª Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”');
    }
}

async function loadSettings() {
    try {
        const settings = await dbGet(STORE_NAMES.SETTINGS, 'madrasaConfig');
        if (settings) {
            madrasaNameInput.value = settings.madrasaName || '';
            madrasaAddressInput.value = settings.madrasaAddress || '';
            madrasaPhoneInput.value = settings.madrasaPhone || '';
            academicYearStartInput.value = settings.academicYearStart || '';
            academicYearEndInput.value = settings.academicYearEnd || '';
            defaultFeeInput.value = settings.defaultFee || '';
            defaultSalaryInput.value = settings.defaultSalary || '';

            // Update header previews
            madrasaNamePreview.textContent = settings.madrasaName || 'Ù…Ø¯Ø±Ø³Û Ú©Ø§ Ù†Ø§Ù…';
            madrasaAddressPreview.textContent = settings.madrasaAddress || 'Ù¾ØªÛ';
            madrasaPhonePreview.textContent = settings.madrasaPhone || 'ÙÙˆÙ† Ù†Ù…Ø¨Ø±';

            // Update logo preview
            madrasaLogoPreview.src = settings.logoDataUrl || 'https://placehold.co/100x100/eee/ccc?text=Ù„ÙˆÚ¯Ùˆ';
             // Update signature preview
            signaturePreview.src = settings.signatureDataUrl || 'https://placehold.co/150x50/eee/ccc?text=Ø¯Ø³ØªØ®Ø·';

        } else {
             // Set default previews if no settings found
             madrasaNamePreview.textContent = 'Ù…Ø¯Ø±Ø³Û Ú©Ø§ Ù†Ø§Ù…';
             madrasaAddressPreview.textContent = 'Ù¾ØªÛ';
             madrasaPhonePreview.textContent = 'ÙÙˆÙ† Ù†Ù…Ø¨Ø±';
             madrasaLogoPreview.src = 'https://placehold.co/100x100/eee/ccc?text=Ù„ÙˆÚ¯Ùˆ';
             signaturePreview.src = 'https://placehold.co/150x50/eee/ccc?text=Ø¯Ø³ØªØ®Ø·';
        }
    } catch (error) {
        console.error("Error loading settings:", error);
        // Handle error (e.g., show a message to the user)
    }
}

// Event listener for settings form submission
settingsForm.addEventListener('submit', (e) => {
    e.preventDefault();
    saveSettings();
});

 // Preview logo instantly on selection
madrasaLogoInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        readFileAsDataURL(file).then(dataUrl => {
             if(dataUrl) madrasaLogoPreview.src = dataUrl;
        }).catch(err => console.error("Error reading logo file:", err));
    }
});
// Preview signature instantly on selection
printSignatureInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
         readFileAsDataURL(file).then(dataUrl => {
             if(dataUrl) signaturePreview.src = dataUrl;
        }).catch(err => console.error("Error reading signature file:", err));
    }
});


// --- Class & Subject Management Logic ---
const classForm = document.getElementById('classForm');
const classIdInput = document.getElementById('classId');
const classNameInput = document.getElementById('className');
const classSubjectsInput = document.getElementById('classSubjects'); // Assuming a textarea for subjects
const classFeeInput = document.getElementById('classFee'); // Optional class-specific fee
const classTableBody = document.getElementById('classTableBody');

// Render the list of classes
async function renderClassList() {
    try {
        const classes = await dbGetAll(STORE_NAMES.CLASSES);
        classTableBody.innerHTML = ''; // Clear existing rows

        if (classes.length === 0) {
            classTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ú©ÙˆØ¦ÛŒ Ú©Ù„Ø§Ø³ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚºÛ”</td></tr>';
            return;
        }

        classes.forEach(cls => {
            const row = classTableBody.insertRow();
            // Ensure subjects are displayed reasonably (e.g., join array or handle string)
            const subjectsDisplay = Array.isArray(cls.subjects) ? cls.subjects.join(', ') : (cls.subjects || 'Ú©ÙˆØ¦ÛŒ Ù…Ø¶Ù…ÙˆÙ† Ù†ÛÛŒÚº');
            row.innerHTML = `
                <td>${cls.name}</td>
                <td>${subjectsDisplay}</td>
                <td>${cls.fee || 'ÚˆÛŒÙØ§Ù„Ù¹'}</td>
                <td class="no-print">
                    <button onclick="editClass(${cls.id})" class="btn btn-secondary btn-sm">ØªØ±Ù…ÛŒÙ…</button>
                    <button onclick="deleteClass(${cls.id})" class="btn btn-danger btn-sm">Ø­Ø°Ù</button>
                </td>
            `;
        });
    } catch (error) {
        console.error("Error rendering class list:", error);
        classTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ú©Ù„Ø§Ø³ÙˆÚº Ú©ÛŒ ÙÛØ±Ø³Øª Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”</td></tr>';
    }
}

// Handle class form submission (Add or Update)
classForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const classId = parseInt(classIdInput.value);
    const className = classNameInput.value.trim();
    // Split subjects by comma or newline, trim whitespace, remove empty entries
    const subjects = classSubjectsInput.value.split(/[\n,]+/)
                                        .map(s => s.trim())
                                        .filter(s => s);

    if (!className) {
        alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… Ú©Ù„Ø§Ø³ Ú©Ø§ Ù†Ø§Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
        return;
    }

    const classData = {
        name: className,
        subjects: subjects, // Store as an array
        fee: classFeeInput.value.trim() || null // Store fee or null
    };

    try {
        if (classId) {
            // Update existing class
            classData.id = classId;
            await dbAddOrUpdate(STORE_NAMES.CLASSES, classData);
            alert('Ú©Ù„Ø§Ø³ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§Ù¾ ÚˆÛŒÙ¹ ÛÙˆÚ¯Ø¦ÛŒÛ”');
        } else {
            // Add new class - Check for duplicate name first
            const existingClass = await getClassByName(className);
            if (existingClass) {
                alert(`Ú©Ù„Ø§Ø³ "${className}" Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’Û”`);
                return;
            }
            await dbAddOrUpdate(STORE_NAMES.CLASSES, classData);
            alert('Ù†Ø¦ÛŒ Ú©Ù„Ø§Ø³ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆÚ¯Ø¦ÛŒÛ”');
        }
        resetClassForm();
        renderClassList();
        // Refresh class dropdowns in other modules
        loadClassesIntoStudentForm();
        loadClassesIntoTeacherForm(); // Add this if teacher form exists
    } catch (error) {
        console.error("Error saving class:", error);
        if (error.name === 'ConstraintError') {
             alert(`Ø®Ø±Ø§Ø¨ÛŒ: Ú©Ù„Ø§Ø³ Ú©Ø§ Ù†Ø§Ù… "${className}" Ù…Ù†ÙØ±Ø¯ ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’Û” ÛŒÛ Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÙˆØ³Ú©ØªØ§ ÛÛ’Û”`);
         } else {
            alert('Ú©Ù„Ø§Ø³ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”');
         }
    }
});

// Helper to get class by name (for duplicate check)
function getClassByName(name) {
     return new Promise((resolve, reject) => {
         if (!db) return reject("Database not open");
         const transaction = db.transaction([STORE_NAMES.CLASSES], 'readonly');
         const store = transaction.objectStore(STORE_NAMES.CLASSES);
         const index = store.index('name'); // Assumes 'name' index exists
         const request = index.get(name);

         request.onsuccess = (event) => resolve(event.target.result); // Returns class object or undefined
         request.onerror = (event) => {
             console.error("Error checking class name:", event.target.error);
             reject(event.target.error);
         };
     });
 }

// Populate form for editing a class
async function editClass(id) {
    try {
        const cls = await dbGet(STORE_NAMES.CLASSES, id);
        if (cls) {
            classIdInput.value = cls.id;
            classNameInput.value = cls.name;
            // Join subjects array back into the textarea format
            classSubjectsInput.value = Array.isArray(cls.subjects) ? cls.subjects.join('\n') : (cls.subjects || '');
            classFeeInput.value = cls.fee || '';
            classForm.scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        console.error("Error fetching class for edit:", error);
        alert('ØªØ±Ù…ÛŒÙ… Ú©Û’ Ù„ÛŒÛ’ Ú©Ù„Ø§Ø³ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”');
    }
}

// Delete a class
async function deleteClass(id) {
    // Add checks: Is this class assigned to any students/teachers?
    // For simplicity now, just confirm deletion.
    if (confirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ú©Ù„Ø§Ø³ Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ')) {
        try {
            await dbDelete(STORE_NAMES.CLASSES, id);
            alert('Ú©Ù„Ø§Ø³ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù ÛÙˆÚ¯Ø¦ÛŒÛ”');
            renderClassList();
            // Refresh class dropdowns in other modules
            loadClassesIntoStudentForm();
            loadClassesIntoTeacherForm();
        } catch (error) {
            console.error("Error deleting class:", error);
            alert('Ú©Ù„Ø§Ø³ Ø­Ø°Ù Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”');
        }
    }
}

// Reset the class form
function resetClassForm() {
    classForm.reset();
    classIdInput.value = '';
}


// --- Student Management Logic (Updates for Class Loading) ---
const studentForm = document.getElementById('studentForm');
const studentIdInput = document.getElementById('studentId');
const studentNameInput = document.getElementById('studentName');
const fatherNameInput = document.getElementById('fatherName');
const dobInput = document.getElementById('dob');
const admissionNumberInput = document.getElementById('admissionNumber');
const studentClassSelect = document.getElementById('studentClass');
const contactNumberInput = document.getElementById('contactNumber');
const studentAddressInput = document.getElementById('studentAddress');
const studentStatusSelect = document.getElementById('studentStatus');
const studentTableBody = document.getElementById('studentTableBody');
const filterStudentClassSelect = document.getElementById('filterStudentClass');
const filterStudentStatusSelect = document.getElementById('filterStudentStatus');

// Load classes into dropdowns (Student form and filter) - NOW USES DB
async function loadClassesIntoStudentForm() {
     try {
         const classes = await dbGetAll(STORE_NAMES.CLASSES);
         // Store current selections to reapply if possible
         const currentStudentClass = studentClassSelect.value;
         const currentFilterClass = filterStudentClassSelect.value;

         studentClassSelect.innerHTML = '<option value="">Ú©Ù„Ø§Ø³ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº</option>'; // Clear existing options
         filterStudentClassSelect.innerHTML = '<option value="">ØªÙ…Ø§Ù… Ú©Ù„Ø§Ø³ÛŒÚº</option>'; // Clear filter options

         classes.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort classes alphabetically (Urdu)

         classes.forEach(cls => {
             const option = document.createElement('option');
             option.value = cls.name; // Use class name as value
             option.textContent = cls.name;
             studentClassSelect.appendChild(option.cloneNode(true));
             filterStudentClassSelect.appendChild(option);
         });

         // Reapply previous selections if they still exist
         if (studentClassSelect.querySelector(`option[value="${currentStudentClass}"]`)) {
             studentClassSelect.value = currentStudentClass;
         }
          if (filterStudentClassSelect.querySelector(`option[value="${currentFilterClass}"]`)) {
             filterStudentClassSelect.value = currentFilterClass;
         }

     } catch (error) {
         console.error("Error loading classes into student form:", error);
         // Provide fallback or message
         studentClassSelect.innerHTML = '<option value="">Ú©Ù„Ø§Ø³ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ</option>';
         filterStudentClassSelect.innerHTML = '<option value="">Ú©Ù„Ø§Ø³ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ</option>';
     }
}

// Render the list of students in the table (Unchanged from previous version)
async function renderStudentList() {
    try {
        let students = await dbGetAll(STORE_NAMES.STUDENTS);

        // Apply filters
        const classFilter = filterStudentClassSelect.value;
        const statusFilter = filterStudentStatusSelect.value;

        if (classFilter) {
            students = students.filter(s => s.class === classFilter);
        }
        if (statusFilter) {
            students = students.filter(s => s.status === statusFilter);
        }

        // Optional: Sort students (e.g., by name or admission number)
        students.sort((a, b) => a.name.localeCompare(b.name, 'ur'));


        studentTableBody.innerHTML = ''; // Clear existing rows
        if (students.length === 0) {
             studentTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ÙÙ„Ù¹Ø± Ú©Û’ Ù…Ø·Ø§Ø¨Ù‚ Ú©ÙˆØ¦ÛŒ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚºÛ”</td></tr>';
             return;
        }

        students.forEach(student => {
            const row = studentTableBody.insertRow();
            row.innerHTML = `
                <td>${student.name}</td>
                <td>${student.fatherName}</td>
                <td>${student.admissionNumber}</td>
                <td>${student.class}</td>
                <td>${translateStatus(student.status)}</td>
                <td class="no-print">
                    <button onclick="editStudent(${student.id})" class="btn btn-secondary btn-sm">ØªØ±Ù…ÛŒÙ…</button>
                    <button onclick="deleteStudent(${student.id})" class="btn btn-danger btn-sm">Ø­Ø°Ù</button>
                    <button onclick="printStudentIdCard(${student.id})" class="btn btn-sm" style="background-color: #17a2b8;">Ú©Ø§Ø±Úˆ Ù¾Ø±Ù†Ù¹</button>
                </td>
            `;
        });
    } catch (error) {
        console.error("Error rendering student list:", error);
        studentTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ø·Ù„Ø¨Ø§Ø¡ Ú©ÛŒ ÙÛØ±Ø³Øª Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”</td></tr>';
    }
}

// Translate status codes to Urdu (Unchanged)
function translateStatus(status) {
    switch (status) {
        case 'active': return 'ÙØ¹Ø§Ù„';
        case 'transferred': return 'Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯Û';
        case 'dropout': return 'ÙØ§Ø±Øº Ø§Ù„ØªØ­ØµÛŒÙ„/Ø®Ø§Ø±Ø¬ Ø´Ø¯Û';
        default: return status;
    }
}

// Handle student form submission (Add or Update) (Unchanged logic, but uses updated DB functions)
studentForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const studentId = parseInt(studentIdInput.value); // Get ID for update check

    const studentData = {
        name: studentNameInput.value.trim(),
        fatherName: fatherNameInput.value.trim(),
        dob: dobInput.value,
        admissionNumber: admissionNumberInput.value.trim(),
        class: studentClassSelect.value,
        contactNumber: contactNumberInput.value.trim(),
        address: studentAddressInput.value.trim(),
        status: studentStatusSelect.value
    };

     // Basic validation
    if (!studentData.name || !studentData.fatherName || !studentData.admissionNumber || !studentData.class) {
        alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… ØªÙ…Ø§Ù… Ø¶Ø±ÙˆØ±ÛŒ ÙÛŒÙ„ÚˆØ² (*) Ù¾ÙØ± Ú©Ø±ÛŒÚºÛ”");
        return;
    }

    try {
        if (studentId) {
            // Update existing student
            studentData.id = studentId; // Include ID for put() to update
            await dbAddOrUpdate(STORE_NAMES.STUDENTS, studentData);
            alert('Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§Ù¾ ÚˆÛŒÙ¹ ÛÙˆÚ¯Ø¦ÛŒÚºÛ”');
        } else {
            // Add new student - Check for duplicate admission number before adding
             const existingStudent = await getStudentByAdmissionNumber(studentData.admissionNumber);
             if (existingStudent) {
                 alert(`Ø¯Ø§Ø®Ù„Û Ù†Ù…Ø¨Ø± ${studentData.admissionNumber} Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÛ’Û”`);
                 return;
             }
            await dbAddOrUpdate(STORE_NAMES.STUDENTS, studentData);
            alert('Ù†ÛŒØ§ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆÚ¯ÛŒØ§Û”');
        }
        resetStudentForm();
        renderStudentList(); // Refresh the list
    } catch (error) {
        console.error("Error saving student:", error);
         if (error.name === 'ConstraintError') {
             alert(`Ø®Ø±Ø§Ø¨ÛŒ: Ø¯Ø§Ø®Ù„Û Ù†Ù…Ø¨Ø± ${studentData.admissionNumber} Ù…Ù†ÙØ±Ø¯ ÛÙˆÙ†Ø§ Ú†Ø§ÛÛŒÛ’Û” ÛŒÛ Ù¾ÛÙ„Û’ Ø³Û’ Ù…ÙˆØ¬ÙˆØ¯ ÛÙˆØ³Ú©ØªØ§ ÛÛ’Û”`);
         } else {
            alert('Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ùˆ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”');
         }
    }
});

 // Helper to check for existing admission number (Unchanged)
 function getStudentByAdmissionNumber(admissionNumber) {
     return new Promise((resolve, reject) => {
         if (!db) return reject("Database not open");
         const transaction = db.transaction([STORE_NAMES.STUDENTS], 'readonly');
         const store = transaction.objectStore(STORE_NAMES.STUDENTS);
         const index = store.index('admissionNumber');
         const request = index.get(admissionNumber);

         request.onsuccess = (event) => resolve(event.target.result); // Returns student object or undefined
         request.onerror = (event) => {
             console.error("Error checking admission number:", event.target.error);
             reject(event.target.error);
         };
     });
 }


// Populate form for editing a student (Unchanged)
async function editStudent(id) {
    try {
        const student = await dbGet(STORE_NAMES.STUDENTS, id);
        if (student) {
            studentIdInput.value = student.id;
            studentNameInput.value = student.name;
            fatherNameInput.value = student.fatherName;
            dobInput.value = student.dob;
            admissionNumberInput.value = student.admissionNumber;
            studentClassSelect.value = student.class; // This should work now with loaded classes
            contactNumberInput.value = student.contactNumber;
            studentAddressInput.value = student.address;
            studentStatusSelect.value = student.status;

            // Scroll to the form for better UX
            studentForm.scrollIntoView({ behavior: 'smooth' });
        }
    } catch (error) {
        console.error("Error fetching student for edit:", error);
        alert('ØªØ±Ù…ÛŒÙ… Ú©Û’ Ù„ÛŒÛ’ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”');
    }
}

// Delete a student (Unchanged)
async function deleteStudent(id) {
    if (confirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø³ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ ÛŒÛ Ø¹Ù…Ù„ ÙˆØ§Ù¾Ø³ Ù†ÛÛŒÚº Ú©ÛŒØ§ Ø¬Ø§ Ø³Ú©ØªØ§Û”')) {
        try {
            await dbDelete(STORE_NAMES.STUDENTS, id);
            alert('Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø­Ø°Ù ÛÙˆÚ¯ÛŒØ§Û”');
            renderStudentList(); // Refresh the list
        } catch (error) {
            console.error("Error deleting student:", error);
            alert('Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ú©Ùˆ Ø­Ø°Ù Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”');
        }
    }
}

// Reset the student form (Unchanged)
function resetStudentForm() {
    studentForm.reset();
    studentIdInput.value = ''; // Clear hidden ID field
    studentStatusSelect.value = 'active'; // Reset status to default
}

// Print Student List (Unchanged)
function printStudentList() {
    // Consider enhancing print view via CSS or JS if needed
    window.print();
}

// Print Student ID Card (Unchanged)
async function printStudentIdCard(id) {
     try {
         const student = await dbGet(STORE_NAMES.STUDENTS, id);
         const settings = await dbGet(STORE_NAMES.SETTINGS, 'madrasaConfig') || {}; // Get settings for logo etc.

         if (!student) {
             alert("Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù… Ù†ÛÛŒÚº Ù…Ù„Ø§Û”");
             return;
         }

         const idCardArea = document.getElementById('printableIdCardArea');
         // Using template literals for cleaner HTML generation
         idCardArea.innerHTML = `
             <div class="printable-id-card" style="border: 1px solid black; padding: 15px; margin: 20px auto; max-width: 320px; text-align: center; font-family: 'Noto Nastaliq Urdu', sans-serif; direction: rtl;">
                 <div class="printable-header" style="border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px;">
                     <img src="${settings.logoDataUrl || 'https://placehold.co/80x80/eee/ccc?text=Ù„ÙˆÚ¯Ùˆ'}" alt="Ù„ÙˆÚ¯Ùˆ" style="max-width: 60px; max-height: 60px; display: block; margin: 0 auto 5px; border-radius: 50%;">
                     <h4 style="margin: 5px 0; font-size: 1.1em;">${settings.madrasaName || 'Ù…Ø¯Ø±Ø³Û Ú©Ø§ Ù†Ø§Ù…'}</h4>
                     <p style="margin: 0; font-size: 0.9em;">Ø´Ù†Ø§Ø®ØªÛŒ Ú©Ø§Ø±Úˆ Ø¨Ø±Ø§Ø¦Û’ Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù…</p>
                 </div>
                 <div style="text-align: right; line-height: 1.7; padding-right: 10px;">
                     <p style="margin: 3px 0;"><strong>Ù†Ø§Ù…:</strong> ${student.name || ''}</p>
                     <p style="margin: 3px 0;"><strong>ÙˆÙ„Ø¯ÛŒØª:</strong> ${student.fatherName || ''}</p>
                     <p style="margin: 3px 0;"><strong>Ø¯Ø§Ø®Ù„Û Ù†Ù…Ø¨Ø±:</strong> ${student.admissionNumber || ''}</p>
                     <p style="margin: 3px 0;"><strong>Ú©Ù„Ø§Ø³:</strong> ${student.class || ''}</p>
                     <p style="margin: 3px 0;"><strong>ØªØ§Ø±ÛŒØ® Ø§Ø¬Ø±Ø§Ø¡:</strong> ${new Date().toLocaleDateString('ur-PK', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                 </div>
                 <div class="printable-footer" style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ccc;">
                     <img src="${settings.signatureDataUrl || 'https://placehold.co/100x30/eee/ccc?text=Ø¯Ø³ØªØ®Ø·'}" alt="Ø¯Ø³ØªØ®Ø·" style="max-height: 30px; max-width: 100px; display: block; margin: 5px auto;">
                     <p style="font-size: 0.8em; margin: 0;">${settings.madrasaAddress || ''}<br>${settings.madrasaPhone || ''}</p>
                 </div>
             </div>
         `;
         idCardArea.style.display = 'block'; // Show the area
         window.print(); // Trigger print dialog
         // Delay hiding slightly to allow print preview to render fully
         setTimeout(() => {
             idCardArea.style.display = 'none'; // Hide after printing attempt
             idCardArea.innerHTML = ''; // Clear content
         }, 500);


     } catch (error) {
         console.error("Error generating ID card:", error);
         alert("Ø´Ù†Ø§Ø®ØªÛŒ Ú©Ø§Ø±Úˆ Ø¨Ù†Ø§Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”");
     }
}

// --- Teacher Management Logic (Basic Structure) ---
const teacherForm = document.getElementById('teacherForm');
const teacherIdInput = document.getElementById('teacherId');
const teacherNameInput = document.getElementById('teacherName');
const teacherSubjectsInput = document.getElementById('teacherSubjects'); // Could be multi-select or text
const teacherPhoneInput = document.getElementById('teacherPhone');
const teacherSalaryTypeSelect = document.getElementById('teacherSalaryType');
const teacherSalaryAmountInput = document.getElementById('teacherSalaryAmount');
const teacherJoiningDateInput = document.getElementById('teacherJoiningDate');
const teacherClassesSelect = document.getElementById('teacherClasses'); // Multi-select for classes
const teacherTableBody = document.getElementById('teacherTableBody'); // Added for teacher list

// Load classes into teacher form dropdown
async function loadClassesIntoTeacherForm() {
     try {
         const classes = await dbGetAll(STORE_NAMES.CLASSES);
         teacherClassesSelect.innerHTML = ''; // Clear existing options

         classes.sort((a, b) => a.name.localeCompare(b.name, 'ur')); // Sort

         classes.forEach(cls => {
             const option = document.createElement('option');
             option.value = cls.name;
             option.textContent = cls.name;
             teacherClassesSelect.appendChild(option);
         });
     } catch (error) {
         console.error("Error loading classes into teacher form:", error);
         teacherClassesSelect.innerHTML = '<option value="">Ú©Ù„Ø§Ø³ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ</option>';
     }
}

// Placeholder for rendering teacher list
async function renderTeacherList() {
     teacherTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ø§Ø³Ø§ØªØ°Û Ú©ÛŒ ÙÛØ±Ø³Øª Ø¬Ù„Ø¯ Ø¢Ø±ÛÛŒ ÛÛ’Û”</td></tr>';
     // TODO: Implement fetching teachers from DB and rendering the table
     console.log("renderTeacherList function needs implementation.");
}


// Handle teacher form submission (Placeholder)
teacherForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const teacherId = parseInt(teacherIdInput.value);

    // Collect data from form fields
    const teacherData = {
        name: teacherNameInput.value.trim(),
        subjects: teacherSubjectsInput.value.trim(), // Adjust based on input type (text, multi-select)
        phone: teacherPhoneInput.value.trim(),
        salaryType: teacherSalaryTypeSelect.value,
        salaryAmount: teacherSalaryAmountInput.value,
        joiningDate: teacherJoiningDateInput.value,
        // Get selected classes from multi-select
        classes: Array.from(teacherClassesSelect.selectedOptions).map(option => option.value)
    };

     if (!teacherData.name || !teacherData.phone) {
        alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§Ø³ØªØ§Ø¯ Ú©Ø§ Ù†Ø§Ù… Ø§ÙˆØ± ÙÙˆÙ† Ù†Ù…Ø¨Ø± Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚºÛ”");
        return;
    }

    console.log("Teacher Data to save:", teacherData); // Log data for now

    try {
        if (teacherId) {
             teacherData.id = teacherId;
             await dbAddOrUpdate(STORE_NAMES.TEACHERS, teacherData);
             alert('Ø§Ø³ØªØ§Ø¯ Ú©ÛŒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§Ù¾ ÚˆÛŒÙ¹ ÛÙˆÚ¯Ø¦ÛŒÚºÛ” (ÙØ¹Ø§Ù„ÛŒØª Ù†Ø§Ù…Ú©Ù…Ù„)');
        } else {
             // Add check for duplicate teacher? (e.g., by phone number)
             await dbAddOrUpdate(STORE_NAMES.TEACHERS, teacherData);
             alert('Ù†ÛŒØ§ Ø§Ø³ØªØ§Ø¯ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø´Ø§Ù…Ù„ ÛÙˆÚ¯ÛŒØ§Û” (ÙØ¹Ø§Ù„ÛŒØª Ù†Ø§Ù…Ú©Ù…Ù„)');
        }
         resetTeacherForm();
         // renderTeacherList(); // Uncomment when list rendering is implemented
    } catch(error) {
         console.error("Error saving teacher:", error);
         alert("Ø§Ø³ØªØ§Ø¯ Ú©Ùˆ Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ Ù¾ÛŒØ´ Ø¢Ø¦ÛŒÛ”");
    }


    // TODO: Implement actual saving logic (add/update) to IndexedDB STORE_NAMES.TEACHERS
    // alert('Ø§Ø³ØªØ§Ø¯ Ø´Ø§Ù…Ù„/Ø§Ù¾ ÚˆÛŒÙ¹ Ú©Ø±Ù†Û’ Ú©ÛŒ ÙØ¹Ø§Ù„ÛŒØª Ø¬Ù„Ø¯ Ø¢Ø±ÛÛŒ ÛÛ’Û”');
    // resetTeacherForm();
    // renderTeacherList(); // Call this after implementing list rendering
});

// Reset the teacher form
function resetTeacherForm() {
    teacherForm.reset();
    teacherIdInput.value = '';
    // Reset multi-select if needed
    Array.from(teacherClassesSelect.options).forEach(option => option.selected = false);

}

// --- Data Export/Import Logic (Unchanged) ---
const importExportStatus = document.getElementById('importExportStatus');

async function exportData() {
    importExportStatus.textContent = 'ÚˆÛŒÙ¹Ø§ Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹ Ú©ÛŒØ§ Ø¬Ø§ Ø±ÛØ§ ÛÛ’...';
    importExportStatus.style.color = 'orange';
    try {
        const exportObj = {};
        const storeNames = Object.values(STORE_NAMES); // Get all store names from constant

        // Ensure DB is open and ready
        if (!db) {
            alert("ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ú©Ú¾Ù„Ø§ Ù†ÛÛŒÚº ÛÛ’Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¯ÙˆØ¨Ø§Ø±Û Ú©ÙˆØ´Ø´ Ú©Ø±ÛŒÚºÛ”");
            importExportStatus.textContent = 'Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù…: ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ø¨Ù†Ø¯ ÛÛ’Û”';
            importExportStatus.style.color = 'red';
            return;
        }

        const transaction = db.transaction(db.objectStoreNames, 'readonly'); // Transaction on existing stores
        const promises = [];

        for (const storeName of db.objectStoreNames) {
            if (STORE_NAMES[storeName.toUpperCase()]) { // Check if it's one of our defined stores
                 promises.push(
                     new Promise((resolve, reject) => {
                         const request = transaction.objectStore(storeName).getAll();
                         request.onsuccess = (event) => resolve({ storeName, data: event.target.result });
                         request.onerror = (event) => reject(event.target.error);
                     })
                 );
            }
        }

        const results = await Promise.all(promises);
        results.forEach(result => {
            exportObj[result.storeName] = result.data;
        });


        const dataStr = JSON.stringify(exportObj, null, 2); // Pretty print JSON
        const dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' }); // Ensure UTF-8
        const url = URL.createObjectURL(dataBlob);

        const downloadLink = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        downloadLink.href = url;
        downloadLink.download = `madrasa_backup_${timestamp}.json`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        URL.revokeObjectURL(url);

        importExportStatus.textContent = 'ÚˆÛŒÙ¹Ø§ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹ ÛÙˆÚ¯ÛŒØ§Û”';
        importExportStatus.style.color = 'green';
        alert('ÚˆÛŒÙ¹Ø§ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹ ÛÙˆÚ¯ÛŒØ§Û” ÙØ§Ø¦Ù„ Ø¢Ù¾ Ú©Û’ ÚˆØ§Ø¤Ù†Ù„ÙˆÚˆ ÙÙˆÙ„ÚˆØ± Ù…ÛŒÚº Ù…Ø­ÙÙˆØ¸ ÛÙˆÚ¯Ø¦ÛŒ ÛÛ’Û”');

    } catch (error) {
        console.error("Export failed:", error);
        importExportStatus.textContent = 'ÚˆÛŒÙ¹Ø§ Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù… ÛÙˆÚ¯ÛŒØ§Û” Ú©Ù†Ø³ÙˆÙ„ Ú†ÛŒÚ© Ú©Ø±ÛŒÚºÛ”';
        importExportStatus.style.color = 'red';
        alert('ÚˆÛŒÙ¹Ø§ Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù… ÛÙˆÚ¯ÛŒØ§Û”');
    }
}

function importData(event) {
    const file = event.target.files[0];
    const fileInput = event.target; // Reference to the input element

    if (!file) {
        importExportStatus.textContent = 'Ú©ÙˆØ¦ÛŒ ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ù†ÛÛŒÚº Ú©ÛŒ Ú¯Ø¦ÛŒÛ”';
         importExportStatus.style.color = 'orange';
        return;
    }
    if (!file.name.endsWith('.json')) {
         importExportStatus.textContent = 'ØºÙ„Ø· ÙØ§Ø¦Ù„ Ú©ÛŒ Ù‚Ø³Ù…Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… .json ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚºÛ”';
         importExportStatus.style.color = 'red';
         alert('ØºÙ„Ø· ÙØ§Ø¦Ù„ Ú©ÛŒ Ù‚Ø³Ù…Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… .json ÙØ§Ø¦Ù„ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚºÛ”');
         fileInput.value = null; // Reset file input
         return;
    }

    if (!confirm('Ú©ÛŒØ§ Ø¢Ù¾ ÙˆØ§Ù‚Ø¹ÛŒ ÚˆÛŒÙ¹Ø§ Ø§Ù…Ù¾ÙˆØ±Ù¹ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ Ù…ÙˆØ¬ÙˆØ¯Û ØªÙ…Ø§Ù… ÚˆÛŒÙ¹Ø§ Ú©Ùˆ Ù…Ù†ØªØ®Ø¨ ÙØ§Ø¦Ù„ Ú©Û’ ÚˆÛŒÙ¹Ø§ Ø³Û’ Ø¨Ø¯Ù„ Ø¯ÛŒØ§ Ø¬Ø§Ø¦Û’ Ú¯Ø§Û” ÛŒÛ Ø¹Ù…Ù„ ÙˆØ§Ù¾Ø³ Ù†ÛÛŒÚº Ú©ÛŒØ§ Ø¬Ø§ Ø³Ú©ØªØ§Û”')) {
         fileInput.value = null; // Reset file input
         importExportStatus.textContent = 'Ø§Ù…Ù¾ÙˆØ±Ù¹ Ù…Ù†Ø³ÙˆØ® Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§Û”';
         importExportStatus.style.color = 'grey';
        return;
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
        importExportStatus.textContent = 'ÚˆÛŒÙ¹Ø§ Ø§Ù…Ù¾ÙˆØ±Ù¹ Ú©ÛŒØ§ Ø¬Ø§ Ø±ÛØ§ ÛÛ’...';
        importExportStatus.style.color = 'orange';
        try {
            const importObj = JSON.parse(e.target.result);
            const storeNamesToImport = Object.keys(importObj);

            // Ensure DB is open
            if (!db) {
                 throw new Error("Database not open for import.");
            }

            // Filter store names to only those present in the current DB version
            const validStoreNames = storeNamesToImport.filter(name => db.objectStoreNames.contains(name));
            const invalidStoreNames = storeNamesToImport.filter(name => !db.objectStoreNames.contains(name));
            if (invalidStoreNames.length > 0) {
                console.warn(`Import file contains data for unknown stores, skipping: ${invalidStoreNames.join(', ')}`);
            }
            if (validStoreNames.length === 0) {
                 throw new Error("Import file contains no data for known stores.");
            }


            // Start a transaction covering all valid stores to import
            const transaction = db.transaction(validStoreNames, 'readwrite');
            const promises = [];

            // Clear existing data and add new data for each valid store
            for (const storeName of validStoreNames) {
                 promises.push(new Promise((resolve, reject) => {
                     const store = transaction.objectStore(storeName);
                     const clearRequest = store.clear(); // Clear existing data

                     clearRequest.onsuccess = () => {
                         let itemsAdded = 0;
                         const itemsToImport = importObj[storeName] || [];
                         if (itemsToImport.length === 0) {
                             resolve(); // Nothing to add for this store
                             return;
                         }

                         itemsToImport.forEach((item, index) => {
                             if (item) { // Ensure item is not null/undefined
                                 let addRequest;
                                 // Handle settings store specifically with its fixed key
                                 if (storeName === STORE_NAMES.SETTINGS) {
                                     addRequest = store.put(item, 'madrasaConfig');
                                 } else {
                                     // For other stores, use add. If import data contains IDs,
                                     // and the store uses autoIncrement, this might cause issues
                                     // if IDs clash. Using put() might be safer if imported data
                                     // is trusted to have correct keys relative to the store setup.
                                     // Let's stick to put() for robustness if IDs are present in JSON.
                                     addRequest = store.put(item);
                                 }
                                 addRequest.onsuccess = () => {
                                     itemsAdded++;
                                     if (itemsAdded === itemsToImport.length) {
                                         resolve(); // All items for this store added
                                     }
                                 };
                                  addRequest.onerror = (event) => {
                                     console.error(`Error adding item to ${storeName}:`, item, event.target.error);
                                     // Continue importing other items/stores? Or reject?
                                     // For now, log error and continue. Consider rejecting the whole promise.
                                      itemsAdded++; // Count as processed even on error to finish the loop
                                      if (itemsAdded === itemsToImport.length) {
                                         resolve(); // Resolve even if some items failed
                                     }
                                 };
                             } else {
                                 itemsAdded++; // Count null/undefined items as processed
                                  if (itemsAdded === itemsToImport.length) {
                                     resolve();
                                 }
                             }
                         });
                     };
                     clearRequest.onerror = (event) => {
                         console.error(`Error clearing store ${storeName}:`, event.target.error);
                         reject(event.target.error);
                     };
                 }));
            }

             // Wait for all store operations within the transaction to complete
             await Promise.all(promises);


            // Transaction completes automatically if all promises resolve without transaction errors

            transaction.oncomplete = () => {
                console.log("All data imported successfully!");
                importExportStatus.textContent = 'ÚˆÛŒÙ¹Ø§ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§Ù…Ù¾ÙˆØ±Ù¹ ÛÙˆÚ¯ÛŒØ§Û” ØµÙØ­Û Ø±ÛŒÙØ±ÛŒØ´ Ú©Ø±ÛŒÚºÛ”';
                importExportStatus.style.color = 'green';
                alert('ÚˆÛŒÙ¹Ø§ Ú©Ø§Ù…ÛŒØ§Ø¨ÛŒ Ø³Û’ Ø§Ù…Ù¾ÙˆØ±Ù¹ ÛÙˆÚ¯ÛŒØ§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§ÛŒÙ¾Ù„ÛŒÚ©ÛŒØ´Ù† Ú©Ùˆ ØµØ­ÛŒØ­ Ø·Ø±ÛŒÙ‚Û’ Ø³Û’ Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ ØµÙØ­Û Ø±ÛŒÙØ±ÛŒØ´ Ú©Ø±ÛŒÚºÛ”');
                // Reload necessary data or prompt user to refresh
                loadSettings();
                loadClassesIntoStudentForm(); // Reload classes everywhere
                loadClassesIntoTeacherForm();
                renderStudentList(); // Refresh visible data
                // renderTeacherList(); // Refresh if implemented
                fileInput.value = null; // Reset file input
            };

            transaction.onabort = (event) => { // Catch transaction-level errors (e.g., quota exceeded)
                console.error("Import transaction aborted:", event.target.error);
                importExportStatus.textContent = `Ø§Ù…Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù… (Ù¹Ø±Ø§Ù†Ø²ÛŒÚ©Ø´Ù†): ${event.target.error}`;
                importExportStatus.style.color = 'red';
                 alert(`Ø§Ù…Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù…: ${event.target.error}`);
                 fileInput.value = null; // Reset file input
            };


        } catch (error) {
            console.error("Import failed:", error);
            importExportStatus.textContent = 'ÚˆÛŒÙ¹Ø§ Ø§Ù…Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù… ÛÙˆÚ¯ÛŒØ§Û” ÙØ§Ø¦Ù„ Ø®Ø±Ø§Ø¨ ÛÙˆØ³Ú©ØªÛŒ ÛÛ’ ÛŒØ§ ÚˆÛŒÙ¹Ø§ ÙØ§Ø±Ù…ÛŒÙ¹ ØºÙ„Ø· ÛÛ’Û”';
            importExportStatus.style.color = 'red';
            alert('ÚˆÛŒÙ¹Ø§ Ø§Ù…Ù¾ÙˆØ±Ù¹ Ù†Ø§Ú©Ø§Ù… ÛÙˆÚ¯ÛŒØ§Û” ÙØ§Ø¦Ù„ Ø®Ø±Ø§Ø¨ ÛÙˆØ³Ú©ØªÛŒ ÛÛ’ ÛŒØ§ ÚˆÛŒÙ¹Ø§ ÙØ§Ø±Ù…ÛŒÙ¹ ØºÙ„Ø· ÛÛ’Û”\n' + error.message);
            fileInput.value = null; // Reset file input
        }
    };

    reader.onerror = () => {
         importExportStatus.textContent = 'ÙØ§Ø¦Ù„ Ù¾Ú‘Ú¾Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”';
         importExportStatus.style.color = 'red';
         alert('ÙØ§Ø¦Ù„ Ù¾Ú‘Ú¾Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ”');
         fileInput.value = null; // Reset file input
    }

    reader.readAsText(file);
}

// Backup function (essentially same as export)
function backupData() {
     exportData(); // Reuse the export function for backup
}


// --- Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await openDB();
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // Load initial data (ensure dependent data is loaded first)
        await loadSettings(); // Load settings first for header etc.
        await loadClassesIntoStudentForm(); // Load classes for students module
        await loadClassesIntoTeacherForm(); // Load classes for teachers module

        // Show the default module (e.g., settings)
        showModule('settings'); // Start with settings page

    } catch (error) {
        console.error("Initialization failed:", error);
        alert("Ø§ÛŒÙ¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø´Ø±ÙˆØ¹ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ù†Ø§Ú©Ø§Ù…ÛŒ: " + error);
        // Display a user-friendly error message on the page
        document.getElementById('mainContent').innerHTML = `<p style="color: red; text-align: center; font-weight: bold;">Ø§ÛŒÙ¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù„ÙˆÚˆ Ú©Ø±Ù†Û’ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒÛ” ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ù†ÛÛŒÚº Ú©Ú¾Ù„ Ø³Ú©Ø§Û” ÙˆØ±Ú˜Ù† ${DB_VERSION} Ù…ÛŒÚº Ø§Ù¾ Ú¯Ø±ÛŒÚˆ Ú©Ø±Ù†Û’ Ú©ÛŒ Ú©ÙˆØ´Ø´ Ú©ÛŒ Ú¯Ø¦ÛŒÛ” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ú©Ù†Ø³ÙˆÙ„ Ú†ÛŒÚ© Ú©Ø±ÛŒÚº ÛŒØ§ ØµÙØ­Û Ø±ÛŒÙØ±ÛŒØ´ Ú©Ø±ÛŒÚºÛ”</p>`;
    }
});


    </script>

</body>
</html>

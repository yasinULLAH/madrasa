<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>School &amp; Madrasa Management System</title>
    <meta name="description"
        content="Comprehensive School and Madrasa Management System for managing students, teachers, staff, academics, finances, library, and madrasa modules." />
    <meta name="keywords"
        content="school management, madrasa management, student information system, SIS, education, Pakistan, Yasin Ullah, school software, fee management, attendance system, examination system, library management, hifz tracking" />
    <meta name="author" content="Yasin Ullah, Pakistan">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --sidebar-width: 250px;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }

        header {
            background-color: var(--dark-color);
            color: white;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            height: 40px;
            width: 40px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark-color);
            color: white;
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 90;
        }

        .sidebar-menu {
            list-style: none;
            padding: 15px 0;
        }

        .sidebar-menu li {
            position: relative;
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-menu li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu li a i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .sidebar-menu li.active a {
            background-color: var(--primary-color);
        }

        .submenu {
            list-style: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .submenu li a {
            padding-left: 50px;
        }

        .sidebar-menu li.has-submenu>a::after {
            content: '\f078';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: auto;
            transition: transform 0.3s;
        }

        .sidebar-menu li.has-submenu.open>a::after {
            transform: rotate(180deg);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 20px;
            transition: margin-left 0.3s ease;
            min-height: calc(100vh - var(--header-height));
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .page-header h2 {
            color: var(--dark-color);
        }

        .breadcrumb {
            display: flex;
            list-style: none;
            gap: 5px;
        }

        .breadcrumb li {
            font-size: 0.9rem;
        }

        .breadcrumb li:not(:last-child)::after {
            content: '/';
            margin-left: 5px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .stat-card.students::before {
            background-color: var(--primary-color);
        }

        .stat-card.teachers::before {
            background-color: var(--secondary-color);
        }

        .stat-card.fees::before {
            background-color: var(--warning-color);
        }

        .stat-card.attendance::before {
            background-color: var(--danger-color);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-title {
            font-size: 0.9rem;
            color: #777;
            font-weight: 500;
        }

        .stat-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-card.students .stat-card-icon {
            background-color: var(--primary-color);
        }

        .stat-card.teachers .stat-card-icon {
            background-color: var(--secondary-color);
        }

        .stat-card.fees .stat-card-icon {
            background-color: var(--warning-color);
        }

        .stat-card.attendance .stat-card-icon {
            background-color: var(--danger-color);
        }

        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-card-change {
            font-size: 0.8rem;
            color: #777;
        }

        .stat-card-change.positive {
            color: var(--secondary-color);
        }

        .stat-card-change.negative {
            color: var(--danger-color);
        }

        .dashboard-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dashboard-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .dashboard-card-actions {
            display: flex;
            gap: 10px;
        }

        .recent-activities {
            list-style: none;
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(52, 152, 219, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #777;
        }

        .upcoming-events {
            list-style: none;
        }

        .event-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-date {
            width: 50px;
            height: 50px;
            background-color: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--secondary-color);
        }

        .event-day {
            font-size: 1.2rem;
            font-weight: 600;
            line-height: 1;
        }

        .event-month {
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .event-content {
            flex-grow: 1;
        }

        .event-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .event-time {
            font-size: 0.8rem;
            color: #777;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background-color: white;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .table-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 15px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px;
        }

        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
        }

        .status-inactive {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .status-pending {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }

        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 5px;
        }

        .page-item {
            list-style: none;
        }

        .page-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 4px;
            background-color: white;
            border: 1px solid #ddd;
            color: #555;
            text-decoration: none;
            transition: all 0.3s;
        }

        .page-link:hover {
            background-color: #f8f9fa;
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-item.disabled .page-link {
            color: #ddd;
            pointer-events: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-dialog {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-50px);
            transition: transform 0.3s;
        }

        .modal.show .modal-dialog {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #777;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .card-body {
            padding: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
            border-left: 4px solid var(--secondary-color);
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .alert-warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-info {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
        }

        .badge-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .dashboard-row {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .mb-0 {
            margin-bottom: 0 !important;
        }

        .mt-0 {
            margin-top: 0 !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-muted {
            color: #777 !important;
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .w-100 {
            width: 100%;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        @media print {

            header,
            .sidebar,
            .page-header {
                display: none !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
            }

            .no-print {
                display: none !important;
            }
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-info h3 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .profile-info p {
            color: #777;
            margin-bottom: 10px;
        }

        .profile-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .profile-tabs {
            margin-bottom: 20px;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .attendance-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .attendance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .attendance-card.present {
            border-top: 3px solid var(--secondary-color);
        }

        .attendance-card.absent {
            border-top: 3px solid var(--danger-color);
        }

        .attendance-card.late {
            border-top: 3px solid var(--warning-color);
        }

        .attendance-card.leave {
            border-top: 3px solid var(--primary-color);
        }

        .attendance-card h4 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .attendance-card p {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .fee-structure {
            margin-bottom: 30px;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .fee-item:last-child {
            border-bottom: none;
        }

        .fee-item.total {
            font-weight: 600;
            color: var(--dark-color);
        }

        .qr-code {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-size: 0.8rem;
            border: 1px dashed #ddd;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .sidebar-menu li.has-submenu.open>.submenu {
            max-height: 500px;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />
</head>

<body>
    <header>
        <div class="logo">
            <img alt="Logo"
                src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZmZmIiBkPSJNNDk0LjEgMjI1LjZjLTcuMS04LTE2LjktMTIuNy0yNy4xLTEyLjdoLTQwLjVjLTguNSAwLTE2LjYtMy40LTIyLjYtOS40bC0zMC4xLTMwLjFjLTIuMy0yLjMtNS4zLTMuNS04LjUtMy41cy02LjIgMS4yLTguNSAzLjVsLTU5LjUgNTkuNWMtMTIuNSAxMi41LTEyLjUgMzIuOCAwIDQ1LjNsMjYuNCAyNi40YzEyLjUgMTIuNSAzMi44IDEyLjUgNDUuMyAwbDEyMC41LTEyMC41YzIuMy0yLjMgMy41LTUuMyAzLjUtOC41cy0xLjItNi4yLTMuNS04LjVsLTMwLjEtMzAuMWMtMi4zLTIuMy01LjMtMy41LTguNS0zLjVzLTYuMiAxLjItOC41IDMuNWwtNjEuMSA2MS4xYy0yLjMgMi4zLTMuNSA1LjMtMy41IDguNXMxLjIgNi4yIDMuNSA4LjVsMzAuMSAzMC4xYzYuMSA2LjEgMTQuMS05LjQgMjIuNiA5LjRoNDAuNWMxMC4yIDAgMjAgNC43IDI3LjEgMTIuN2w2MS4xIDY4LjljNS40IDYgOC4xIDEzLjcgOC4xIDIxLjR2MzQuN2MwIDguNS0zLjQgMTYuNi05LjQgMjIuNmwtNTUuNSA1NS41Yy02IDYtMTQuMS05LjQtMjIuNi05LjRIMTQxLjNjLTguNSAwLTE2LjYtMy40LTIyLjYtOS40TDYzLjIgNDQ4LjNjLTYuMS02LTkuNC0xNC4xLTkuNC0yMi42VjE0MS4zYzAtOC41IDMuNC0xNi42IDkuNC0yMi42bDU1LjUtNTUuNWM2LTYgMTQuMS05LjQgMjIuNi05LjQzNCIvPjwvc3ZnPg==" />
            <h1>School &amp; Madrasa Management</h1>
        </div>
        <div class="header-actions">
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <span>Admin</span>
            </div>
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>
    <aside class="sidebar">
        <ul class="sidebar-menu">
            <li class="active">
                <a href="#dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="has-submenu">
                <a href="#">
                    <i class="fas fa-users"></i>
                    <span>People Management</span>
                </a>
                <ul class="submenu">
                    <li><a href="#students"><i class="fas fa-user-graduate"></i> Students</a></li>
                    <li><a href="#teachers"><i class="fas fa-chalkboard-teacher"></i> Teachers</a></li>
                    <li><a href="#staff"><i class="fas fa-user-tie"></i> Staff</a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#">
                    <i class="fas fa-book-open"></i>
                    <span>Academic Management</span>
                </a>
                <ul class="submenu">
                    <li><a href="#classes"><i class="fas fa-school"></i> Classes &amp; Subjects</a></li>
                    <li><a href="#attendance"><i class="fas fa-clipboard-check"></i> Attendance</a></li>
                    <li><a href="#examinations"><i class="fas fa-file-alt"></i> Examinations</a></li>
                </ul>
            </li>
            <li class="has-submenu">
                <a href="#">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Financial Management</span>
                </a>
                <ul class="submenu">
                    <li><a href="#fees"><i class="fas fa-hand-holding-usd"></i> Fee Management</a></li>
                    <li><a href="#salaries"><i class="fas fa-money-check-alt"></i> Salary Management</a></li>
                    <li><a href="#expenses-income"><i class="fas fa-receipt"></i> Expenses &amp; Income</a></li>
                </ul>
            </li>
            <li>
                <a href="#library">
                    <i class="fas fa-book"></i>
                    <span>Library</span>
                </a>
            </li>
            <li>
                <a href="#madrasa">
                    <i class="fas fa-mosque"></i>
                    <span>Madrasa Module</span>
                </a>
            </li>
            <li class="has-submenu">
                <a href="#">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                <ul class="submenu">
                    <li><a href="#reports-students"><i class="fas fa-user-graduate"></i> Student Reports</a></li>
                    <li><a href="#reports-attendance"><i class="fas fa-clipboard-list"></i> Attendance Reports</a></li>
                    <li><a href="#reports-financial"><i class="fas fa-file-invoice-dollar"></i> Financial Reports</a>
                    </li>
                    <li><a href="#reports-library"><i class="fas fa-book"></i> Library Reports</a></li>
                    <li><a href="#reports-madrasa"><i class="fas fa-mosque"></i> Madrasa Reports</a></li>
                </ul>
            </li>
            <li>
                <a href="#utilities">
                    <i class="fas fa-id-card"></i>
                    <span>ID Cards &amp; Certificates</span>
                </a>
            </li>
            <li>
                <a href="#settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
            </li>
        </ul>
    </aside>
    <main class="main-content">
        <section class="content-section active" id="dashboard-section">
            <div class="page-header">
                <h2>Dashboard</h2>
                <ul class="breadcrumb">
                    <li>Home</li>
                    <li>Dashboard</li>
                </ul>
            </div>
            <div class="stats-cards">
                <div class="stat-card students">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Total Students</span>
                        <div class="stat-card-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="total-students">0</div>
                    <div class="stat-card-change positive">
                        <i class="fas fa-arrow-up"></i> 5.2% from last month
                    </div>
                </div>
                <div class="stat-card teachers">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Total Teachers</span>
                        <div class="stat-card-icon">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="total-teachers">0</div>
                    <div class="stat-card-change positive">
                        <i class="fas fa-arrow-up"></i> 2.1% from last month
                    </div>
                </div>
                <div class="stat-card fees">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Fee Collection</span>
                        <div class="stat-card-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="fee-collection">0</div>
                    <div class="stat-card-change negative">
                        <i class="fas fa-arrow-down"></i> 3.5% from last month
                    </div>
                </div>
                <div class="stat-card attendance">
                    <div class="stat-card-header">
                        <span class="stat-card-title">Today's Attendance</span>
                        <div class="stat-card-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="today-attendance">0%</div>
                    <div class="stat-card-change positive">
                        <i class="fas fa-arrow-up"></i> 1.8% from yesterday
                    </div>
                </div>
            </div>
            <div class="dashboard-row">
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <h3 class="dashboard-card-title">Recent Activities</h3>
                        <div class="dashboard-card-actions">
                            <button class="btn btn-sm btn-outline-primary" data-section="reports-financial"
                                data-tab="fee-collection">View All</button>
                        </div>
                    </div>
                    <ul class="recent-activities" id="recent-activities">
                    </ul>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-card-header">
                        <h3 class="dashboard-card-title">Upcoming Events</h3>
                        <div class="dashboard-card-actions">
                            <button class="btn btn-sm btn-outline-primary" data-section="settings"
                                data-tab="academic">View All</button>
                        </div>
                    </div>
                    <ul class="upcoming-events" id="upcoming-events">
                    </ul>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-card-header">
                    <h3 class="dashboard-card-title">Quick Actions</h3>
                </div>
                <div class="dashboard-card-body quick-actions">
                    <button class="btn btn-primary" data-section="students" id="quick-add-student">
                        <i class="fas fa-user-plus"></i> Add New Student
                    </button>
                    <button class="btn btn-success" data-section="attendance" id="quick-mark-attendance">
                        <i class="fas fa-clipboard-check"></i> Mark Attendance
                    </button>
                    <button class="btn btn-warning" data-section="fees" id="quick-collect-fee">
                        <i class="fas fa-hand-holding-usd"></i> Collect Fee
                    </button>
                    <button class="btn btn-danger" data-section="library" id="quick-issue-book">
                        <i class="fas fa-book"></i> Issue Book
                    </button>
                </div>
            </div>
        </section>
        <section class="content-section" id="students-section">
            <div class="page-header">
                <h2>Student Management</h2>
                <ul class="breadcrumb">
                    <li>People Management</li>
                    <li>Students</li>
                </ul>
            </div>
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input id="student-search" placeholder="Search students..." type="text" />
                </div>
                <button class="btn btn-primary" id="add-student-btn">
                    <i class="fas fa-plus"></i> Add Student
                </button>
            </div>
            <div class="table-container">
                <table id="students-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Section</th>
                            <th>Father Name</th>
                            <th>Contact</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body">
                    </tbody>
                </table>
                <div class="pagination">
                    <ul id="students-pagination">
                    </ul>
                </div>
            </div>
        </section>
        <div class="modal" id="student-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Student</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="student-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="student-first-name">First Name</label>
                                <input class="form-control" id="student-first-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="student-last-name">Last Name</label>
                                <input class="form-control" id="student-last-name" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="student-gender">Gender</label>
                                <select class="form-select" id="student-gender" required="">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="student-dob">Date of Birth</label>
                                <input class="form-control" id="student-dob" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="student-class">Class</label>
                                <select class="form-select" id="student-class" required="">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="student-section">Section</label>
                                <select class="form-select" id="student-section" required="">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="student-admission-date">Admission Date</label>
                                <input class="form-control" id="student-admission-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="student-admission-number">Admission Number</label>
                                <input class="form-control" id="student-admission-number" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="student-address">Address</label>
                            <textarea class="form-control form-textarea" id="student-address"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="student-father-name">Father's Name</label>
                                <input class="form-control" id="student-father-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="student-father-phone">Father's Phone</label>
                                <input class="form-control" id="student-father-phone" required="" type="tel" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="student-mother-name">Mother's Name</label>
                                <input class="form-control" id="student-mother-name" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="student-mother-phone">Mother's Phone</label>
                                <input class="form-control" id="student-mother-phone" type="tel" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="student-photo">Photo</label>
                            <input accept="image/*" class="form-control" id="student-photo" type="file" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Student</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="teachers-section">
            <div class="page-header">
                <h2>Teacher Management</h2>
                <ul class="breadcrumb">
                    <li>People Management</li>
                    <li>Teachers</li>
                </ul>
            </div>
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input id="teacher-search" placeholder="Search teachers..." type="text" />
                </div>
                <button class="btn btn-primary" id="add-teacher-btn">
                    <i class="fas fa-plus"></i> Add Teacher
                </button>
            </div>
            <div class="table-container">
                <table id="teachers-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Subjects</th>
                            <th>Qualification</th>
                            <th>Contact</th>
                            <th>Joining Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="teachers-table-body">
                    </tbody>
                </table>
                <div class="pagination">
                    <ul id="teachers-pagination">
                    </ul>
                </div>
            </div>
        </section>
        <div class="modal" id="teacher-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Teacher</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="teacher-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="teacher-first-name">First Name</label>
                                <input class="form-control" id="teacher-first-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="teacher-last-name">Last Name</label>
                                <input class="form-control" id="teacher-last-name" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="teacher-gender">Gender</label>
                                <select class="form-select" id="teacher-gender" required="">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="teacher-dob">Date of Birth</label>
                                <input class="form-control" id="teacher-dob" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="teacher-email">Email</label>
                                <input class="form-control" id="teacher-email" required="" type="email" />
                            </div>
                            <div class="form-group">
                                <label for="teacher-phone">Phone</label>
                                <input class="form-control" id="teacher-phone" required="" type="tel" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="teacher-qualification">Qualification</label>
                                <input class="form-control" id="teacher-qualification" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="teacher-subjects">Subjects</label>
                                <select class="form-select" id="teacher-subjects" multiple="">
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="teacher-joining-date">Joining Date</label>
                                <input class="form-control" id="teacher-joining-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="teacher-salary">Salary</label>
                                <input class="form-control" id="teacher-salary" required="" type="number" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="teacher-address">Address</label>
                            <textarea class="form-control form-textarea" id="teacher-address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="teacher-photo">Photo</label>
                            <input accept="image/*" class="form-control" id="teacher-photo" type="file" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Teacher</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="staff-section">
            <div class="page-header">
                <h2>Staff Management</h2>
                <ul class="breadcrumb">
                    <li>People Management</li>
                    <li>Staff</li>
                </ul>
            </div>
            <div class="table-header">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input id="staff-search" placeholder="Search staff..." type="text" />
                </div>
                <button class="btn btn-primary" id="add-staff-btn">
                    <i class="fas fa-plus"></i> Add Staff
                </button>
            </div>
            <div class="table-container">
                <table id="staff-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Photo</th>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Contact</th>
                            <th>Joining Date</th>
                            <th>Salary</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staff-table-body">
                    </tbody>
                </table>
                <div class="pagination">
                    <ul id="staff-pagination">
                    </ul>
                </div>
            </div>
        </section>
        <div class="modal" id="staff-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Staff</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="staff-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staff-first-name">First Name</label>
                                <input class="form-control" id="staff-first-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="staff-last-name">Last Name</label>
                                <input class="form-control" id="staff-last-name" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staff-gender">Gender</label>
                                <select class="form-select" id="staff-gender" required="">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staff-dob">Date of Birth</label>
                                <input class="form-control" id="staff-dob" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staff-email">Email</label>
                                <input class="form-control" id="staff-email" type="email" />
                            </div>
                            <div class="form-group">
                                <label for="staff-phone">Phone</label>
                                <input class="form-control" id="staff-phone" required="" type="tel" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staff-role">Role</label>
                                <select class="form-select" id="staff-role" required="">
                                    <option value="">Select Role</option>
                                    <option value="Accountant">Accountant</option>
                                    <option value="Librarian">Librarian</option>
                                    <option value="Receptionist">Receptionist</option>
                                    <option value="Cleaner">Cleaner</option>
                                    <option value="Security">Security</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="staff-joining-date">Joining Date</label>
                                <input class="form-control" id="staff-joining-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="staff-salary">Salary</label>
                                <input class="form-control" id="staff-salary" required="" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="staff-status">Status</label>
                                <select class="form-select" id="staff-status" required="">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="staff-address">Address</label>
                            <textarea class="form-control form-textarea" id="staff-address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="staff-photo">Photo</label>
                            <input accept="image/*" class="form-control" id="staff-photo" type="file" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Staff</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="classes-section">
            <div class="page-header">
                <h2>Classes &amp; Subjects</h2>
                <ul class="breadcrumb">
                    <li>Academic Management</li>
                    <li>Classes &amp; Subjects</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="classes">Classes</div>
                <div class="tab" data-tab="subjects">Subjects</div>
                <div class="tab" data-tab="assign-subjects">Assign Subjects</div>
            </div>
            <div class="tab-content active" id="classes-tab">
                <div class="table-actions">
                    <button class="btn btn-primary" id="add-class-btn">
                        <i class="fas fa-plus"></i> Add Class
                    </button>
                </div>
                <div class="table-container">
                    <table id="classes-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Class Name</th>
                                <th>Sections</th>
                                <th>Class Teacher</th>
                                <th>Students</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="classes-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="subjects-tab">
                <div class="table-actions">
                    <button class="btn btn-primary" id="add-subject-btn">
                        <i class="fas fa-plus"></i> Add Subject
                    </button>
                </div>
                <div class="table-container">
                    <table id="subjects-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Subject Name</th>
                                <th>Subject Code</th>
                                <th>Type</th>
                                <th>Teachers</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subjects-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="assign-subjects-tab">
                <div class="form-container">
                    <form id="assign-subjects-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="assign-class">Class</label>
                                <select class="form-select" id="assign-class" required="">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="assign-section">Section</label>
                                <select class="form-select" id="assign-section" required="">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Subjects</label>
                            <div id="subject-assignments">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Save Assignments</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
        <div class="modal" id="class-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Class</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="class-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="class-name">Class Name</label>
                                <input class="form-control" id="class-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="class-numeric-value">Numeric Value</label>
                                <input class="form-control" id="class-numeric-value" required="" type="number" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="class-sections">Sections (comma separated)</label>
                            <input class="form-control" id="class-sections" placeholder="A,B,C,D" type="text" />
                        </div>
                        <div class="form-group">
                            <label for="class-teacher">Class Teacher</label>
                            <select class="form-select" id="class-teacher">
                                <option value="">Select Teacher</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Class</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal" id="subject-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Subject</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="subject-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subject-name">Subject Name</label>
                                <input class="form-control" id="subject-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="subject-code">Subject Code</label>
                                <input class="form-control" id="subject-code" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subject-type">Subject Type</label>
                                <select class="form-select" id="subject-type" required="">
                                    <option value="Core">Core</option>
                                    <option value="Elective">Elective</option>
                                    <option value="Optional">Optional</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="subject-teacher">Subject Teacher</label>
                                <select class="form-select" id="subject-teacher">
                                    <option value="">Select Teacher</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="subject-description">Description</label>
                            <textarea class="form-control form-textarea" id="subject-description"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Subject</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="attendance-section">
            <div class="page-header">
                <h2>Attendance Management</h2>
                <ul class="breadcrumb">
                    <li>Academic Management</li>
                    <li>Attendance</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="mark-attendance">Mark Attendance</div>
                <div class="tab" data-tab="attendance-reports-academic">Reports</div>
            </div>
            <div class="tab-content active" id="mark-attendance-tab">
                <div class="form-container">
                    <form id="attendance-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="attendance-date">Date</label>
                                <input class="form-control" id="attendance-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="attendance-class">Class</label>
                                <select class="form-select" id="attendance-class" required="">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="attendance-section">Section</label>
                                <select class="form-select" id="attendance-section" required="">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Load Students</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="attendance-table-container" style="display: none;">
                    <table id="attendance-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Status</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-table-body">
                        </tbody>
                    </table>
                    <div class="form-actions">
                        <button class="btn btn-success" id="save-attendance-btn" type="button">Save Attendance</button>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="attendance-reports-academic-tab">
                <div class="form-container">
                    <form id="attendance-report-form-academic">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-class-academic">Class</label>
                                <select class="form-select" id="report-class-academic">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report-section-academic">Section</label>
                                <select class="form-select" id="report-section-academic">
                                    <option value="">All Sections</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report-student-academic">Student</label>
                                <select class="form-select" id="report-student-academic">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="report-month-academic">Month</label>
                                <select class="form-select" id="report-month-academic">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report-year-academic">Year</label>
                                <select class="form-select" id="report-year-academic">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="report-type-academic">Report Type</label>
                                <select class="form-select" id="report-type-academic">
                                    <option value="summary">Summary Report</option>
                                    <option value="detailed">Detailed Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report</button>
                            <button class="btn btn-secondary" id="print-attendance-report-academic-btn"
                                type="button">Print Report</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="attendance-report-container-academic" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Attendance Report</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" id="export-attendance-report-academic-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div id="attendance-report-content-academic">
                    </div>
                </div>
            </div>
        </section>
        <section class="content-section" id="examinations-section">
            <div class="page-header">
                <h2>Examinations Management</h2>
                <ul class="breadcrumb">
                    <li>Academic Management</li>
                    <li>Examinations</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="exam-schedule">Exam Schedule</div>
                <div class="tab" data-tab="marks-entry">Marks Entry</div>
                <div class="tab" data-tab="report-cards">Report Cards</div>
            </div>
            <div class="tab-content active" id="exam-schedule-tab">
                <div class="table-actions">
                    <button class="btn btn-primary" id="add-exam-btn">
                        <i class="fas fa-plus"></i> Add Exam
                    </button>
                </div>
                <div class="table-container">
                    <table id="exams-table">
                        <thead>
                            <tr>
                                <th>Exam ID</th>
                                <th>Exam Name</th>
                                <th>Exam Type</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Classes</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="marks-entry-tab">
                <div class="form-container">
                    <form id="marks-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="marks-exam">Exam</label>
                                <select class="form-select" id="marks-exam" required="">
                                    <option value="">Select Exam</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="marks-class">Class</label>
                                <select class="form-select" id="marks-class" required="">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="marks-section">Section</label>
                                <select class="form-select" id="marks-section" required="">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="marks-subject">Subject</label>
                                <select class="form-select" id="marks-subject" required="">
                                    <option value="">Select Subject</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Load Students</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="marks-table-container" style="display: none;">
                    <table id="marks-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Marks</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="marks-table-body">
                        </tbody>
                    </table>
                    <div class="form-actions">
                        <button class="btn btn-success" id="save-marks-btn" type="button">Save Marks</button>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="report-cards-tab">
                <div class="form-container">
                    <form id="report-card-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rc-exam">Exam</label>
                                <select class="form-select" id="rc-exam" required="">
                                    <option value="">Select Exam</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rc-class">Class</label>
                                <select class="form-select" id="rc-class" required="">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rc-section">Section</label>
                                <select class="form-select" id="rc-section" required="">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="rc-student">Student</label>
                                <select class="form-select" id="rc-student">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report Cards</button>
                            <button class="btn btn-secondary" id="print-report-cards-btn" type="button">Print Report
                                Cards</button>
                        </div>
                    </form>
                </div>
                <div id="report-cards-container" style="display: none;">
                </div>
            </div>
        </section>
        <div class="modal" id="exam-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Exam</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="exam-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exam-name">Exam Name</label>
                                <input class="form-control" id="exam-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="exam-type">Exam Type</label>
                                <select class="form-select" id="exam-type" required="">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Term">Term</option>
                                    <option value="Final">Final</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exam-start-date">Start Date</label>
                                <input class="form-control" id="exam-start-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="exam-end-date">End Date</label>
                                <input class="form-control" id="exam-end-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="exam-classes">Classes</label>
                            <select class="form-select" id="exam-classes" multiple="">
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exam-description">Description</label>
                            <textarea class="form-control form-textarea" id="exam-description"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Exam</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="fees-section">
            <div class="page-header">
                <h2>Fee Management</h2>
                <ul class="breadcrumb">
                    <li>Financial Management</li>
                    <li>Fee Management</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="fee-structure">Fee Structure</div>
                <div class="tab" data-tab="collect-fee">Collect Fee</div>
                <div class="tab" data-tab="fee-reports-finance">Reports</div>
                <div class="tab" data-tab="fee-defaulters">Defaulters</div>
            </div>
            <div class="tab-content active" id="fee-structure-tab">
                <div class="table-actions">
                    <button class="btn btn-primary" id="add-fee-type-btn">
                        <i class="fas fa-plus"></i> Add Fee Type
                    </button>
                    <button class="btn btn-success" id="assign-fee-btn">
                        <i class="fas fa-tasks"></i> Assign Fee to Classes
                    </button>
                </div>
                <div class="table-container">
                    <table id="fee-types-table">
                        <thead>
                            <tr>
                                <th>Fee ID</th>
                                <th>Fee Name</th>
                                <th>Amount</th>
                                <th>Frequency</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fee-types-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="table-container mt-20">
                    <h3>Class-wise Fee Structure</h3>
                    <table id="class-fee-structure-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Fee Name</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="class-fee-structure-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="collect-fee-tab">
                <div class="form-container">
                    <form id="fee-collection-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-student">Student</label>
                                <select class="form-select" id="fee-student" required="">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fee-class">Class</label>
                                <select class="form-select" id="fee-class" required="">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fee-section">Section</label>
                                <select class="form-select" id="fee-section" required="">
                                    <option value="">Select Section</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Fee Details</label>
                            <div id="fee-details-container">
                                <p class="text-muted">Select a student and class to see fee details.</p>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-total-amount">Total Payable</label>
                                <input class="form-control" id="fee-total-amount" readonly="" type="number" value="0" />
                            </div>
                            <div class="form-group">
                                <label for="fee-discount">Discount</label>
                                <input class="form-control" id="fee-discount" min="0" type="number" value="0" />
                            </div>
                            <div class="form-group">
                                <label for="fee-fine">Fine</label>
                                <input class="form-control" id="fee-fine" min="0" type="number" value="0" />
                            </div>
                            <div class="form-group">
                                <label for="fee-paid-amount">Paid Amount</label>
                                <input class="form-control" id="fee-paid-amount" required="" type="number" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-payment-method">Payment Method</label>
                                <select class="form-select" id="fee-payment-method" required="">
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Online Payment">Online Payment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fee-payment-date">Payment Date</label>
                                <input class="form-control" id="fee-payment-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fee-remarks">Remarks</label>
                            <textarea class="form-control form-textarea" id="fee-remarks"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Collect Fee</button>
                            <button class="btn btn-secondary" id="print-receipt-btn" type="button" disabled>Print
                                Receipt</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="fee-reports-finance-tab">
                <div class="form-container">
                    <form id="fee-report-filter-form-finance">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fr-class-finance">Class</label>
                                <select class="form-select" id="fr-class-finance">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fr-section-finance">Section</label>
                                <select class="form-select" id="fr-section-finance">
                                    <option value="">All Sections</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fr-fee-type-finance">Fee Type</label>
                                <select class="form-select" id="fr-fee-type-finance">
                                    <option value="">All Fee Types</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fr-month-finance">Month</label>
                                <select class="form-select" id="fr-month-finance">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fr-year-finance">Year</label>
                                <select class="form-select" id="fr-year-finance">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fr-report-type-finance">Report Type</label>
                                <select class="form-select" id="fr-report-type-finance">
                                    <option value="summary">Summary Report</option>
                                    <option value="detailed">Detailed Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report</button>
                            <button class="btn btn-secondary" id="print-fee-report-finance-btn" type="button">Print
                                Report</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="fee-report-container-finance" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Fee Collection Report</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" id="export-fee-report-finance-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div id="fee-report-content-finance">
                    </div>
                </div>
            </div>
            <div class="tab-content" id="fee-defaulters-tab">
                <div class="form-container">
                    <form id="defaulters-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="df-class">Class</label>
                                <select class="form-select" id="df-class">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="df-section">Section</label>
                                <select class="form-select" id="df-section">
                                    <option value="">All Sections</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="df-fee-type">Fee Type</label>
                                <select class="form-select" id="df-fee-type">
                                    <option value="">All Fee Types</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="df-month">Month</label>
                                <select class="form-select" id="df-month">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Find Defaulters</button>
                            <button class="btn btn-success" id="send-reminders-btn" type="button">Send
                                Reminders</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="defaulters-container" style="display: none;">
                    <table id="defaulters-table">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Section</th>
                                <th>Fee Type</th>
                                <th>Due Amount</th>
                                <th>Due Since</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="defaulters-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <div class="modal" id="fee-type-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Fee Type</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="fee-type-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-type-name">Fee Name</label>
                                <input class="form-control" id="fee-type-name" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="fee-type-code">Fee Code</label>
                                <input class="form-control" id="fee-type-code" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-type-amount">Amount</label>
                                <input class="form-control" id="fee-type-amount" required="" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="fee-type-frequency">Frequency</label>
                                <select class="form-select" id="fee-type-frequency" required="">
                                    <option value="One Time">One Time</option>
                                    <option value="Monthly">Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Half Yearly">Half Yearly</option>
                                    <option value="Yearly">Yearly</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="fee-type-description">Description</label>
                            <textarea class="form-control form-textarea" id="fee-type-description"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Fee Type</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal" id="assign-fee-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Assign Fee to Classes</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="assign-fee-form">
                        <div class="form-group">
                            <label for="assign-fee-type">Fee Type</label>
                            <select class="form-select" id="assign-fee-type" required="">
                                <option value="">Select Fee Type</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Classes</label>
                            <div id="class-fee-assignments">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Assignments</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="salaries-section">
            <div class="page-header">
                <h2>Salary Management</h2>
                <ul class="breadcrumb">
                    <li>Financial Management</li>
                    <li>Salary Management</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="salary-structure">Salary Structure</div>
                <div class="tab" data-tab="process-salary">Process Salary</div>
                <div class="tab" data-tab="salary-reports">Reports</div>
            </div>
            <div class="tab-content active" id="salary-structure-tab">
                <div class="table-container">
                    <table id="salary-structure-table">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Employee Name</th>
                                <th>Designation</th>
                                <th>Basic Salary</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salary-structure-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="process-salary-tab">
                <div class="form-container">
                    <form id="salary-process-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="salary-month">Month</label>
                                <select class="form-select" id="salary-month" required="">
                                    <option value="">Select Month</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="salary-year">Year</label>
                                <select class="form-select" id="salary-year" required="">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="salary-employee-type">Employee Type</label>
                                <select class="form-select" id="salary-employee-type">
                                    <option value="">All Employees</option>
                                    <option value="Teacher">Teachers</option>
                                    <option value="Staff">Staff</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Load Employees</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="salary-process-container" style="display: none;">
                    <table id="salary-process-table">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Employee Name</th>
                                <th>Designation</th>
                                <th>Basic Salary</th>
                                <th>Allowances</th>
                                <th>Deductions</th>
                                <th>Net Salary</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salary-process-table-body">
                        </tbody>
                    </table>
                    <div class="form-actions">
                        <button class="btn btn-success" id="process-salary-btn" type="button">Process Salary</button>
                        <button class="btn btn-primary" id="print-payslips-btn" type="button">Print Payslips</button>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="salary-reports-tab">
                <div class="form-container">
                    <form id="salary-report-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sr-employee">Employee</label>
                                <select class="form-select" id="sr-employee">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sr-employee-type">Employee Type</label>
                                <select class="form-select" id="sr-employee-type">
                                    <option value="">All Types</option>
                                    <option value="Teacher">Teachers</option>
                                    <option value="Staff">Staff</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sr-month">Month</label>
                                <select class="form-select" id="sr-month">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sr-year">Year</label>
                                <select class="form-select" id="sr-year">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sr-report-type">Report Type</label>
                                <select class="form-select" id="sr-report-type">
                                    <option value="summary">Summary Report</option>
                                    <option value="detailed">Detailed Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report</button>
                            <button class="btn btn-secondary" id="print-salary-report-btn" type="button">Print
                                Report</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="salary-report-container" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Salary Report</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" id="export-salary-report-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div id="salary-report-content">
                    </div>
                </div>
            </div>
        </section>
        <section class="content-section" id="expenses-income-section">
            <div class="page-header">
                <h2>Expenses &amp; Income</h2>
                <ul class="breadcrumb">
                    <li>Financial Management</li>
                    <li>Expenses &amp; Income</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="expenses">Expenses</div>
                <div class="tab" data-tab="income">Income</div>
                <div class="tab" data-tab="financial-reports-finance">Reports</div>
            </div>
            <div class="tab-content active" id="expenses-tab">
                <div class="table-header">
                    <button class="btn btn-primary" id="add-expense-btn">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                </div>
                <div class="table-container">
                    <table id="expenses-table">
                        <thead>
                            <tr>
                                <th>Expense ID</th>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="income-tab">
                <div class="table-header">
                    <button class="btn btn-primary" id="add-income-btn">
                        <i class="fas fa-plus"></i> Add Income
                    </button>
                </div>
                <div class="table-container">
                    <table id="income-table">
                        <thead>
                            <tr>
                                <th>Income ID</th>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="income-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="financial-reports-finance-tab">
                <div class="form-container">
                    <form id="financial-report-filter-form-finance">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fr-type-finance">Type</label>
                                <select class="form-select" id="fr-type-finance">
                                    <option value="all">All Transactions</option>
                                    <option value="expense">Expenses Only</option>
                                    <option value="income">Income Only</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="fr-category-finance">Category</label>
                                <select class="form-select" id="fr-category-finance">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fr-start-date-finance">Start Date</label>
                                <input class="form-control" id="fr-start-date-finance" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="fr-end-date-finance">End Date</label>
                                <input class="form-control" id="fr-end-date-finance" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="fr-report-type-finance">Report Type</label>
                                <select class="form-select" id="fr-report-type-finance">
                                    <option value="summary">Summary Report</option>
                                    <option value="detailed">Detailed Report</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report</button>
                            <button class="btn btn-secondary" id="print-financial-report-finance-btn"
                                type="button">Print Report</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="financial-report-container-finance" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Financial Report</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" id="export-financial-report-finance-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div id="financial-report-content-finance">
                    </div>
                </div>
            </div>
        </section>
        <div class="modal" id="expense-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Expense</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="expense-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expense-date">Date</label>
                                <input class="form-control" id="expense-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="expense-category">Category</label>
                                <select class="form-select" id="expense-category" required="">
                                    <option value="">Select Category</option>
                                    <option value="Salaries">Salaries</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Stationery">Stationery</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="expense-amount">Amount</label>
                                <input class="form-control" id="expense-amount" required="" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="expense-payment-method">Payment Method</label>
                                <select class="form-select" id="expense-payment-method" required="">
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Online Payment">Online Payment</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="expense-description">Description</label>
                            <textarea class="form-control form-textarea" id="expense-description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="expense-attachment">Attachment</label>
                            <input class="form-control" id="expense-attachment" type="file" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Expense</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal" id="income-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Income</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="income-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="income-date">Date</label>
                                <input class="form-control" id="income-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="income-category">Category</label>
                                <select class="form-select" id="income-category" required="">
                                    <option value="">Select Category</option>
                                    <option value="Fees">Fees</option>
                                    <option value="Donation">Donation</option>
                                    <option value="Grant">Grant</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="income-amount">Amount</label>
                                <input class="form-control" id="income-amount" required="" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="income-payment-method">Payment Method</label>
                                <select class="form-select" id="income-payment-method" required="">
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Online Payment">Online Payment</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="income-description">Description</label>
                            <textarea class="form-control form-textarea" id="income-description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="income-attachment">Attachment</label>
                            <input class="form-control" id="income-attachment" type="file" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Income</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="library-section">
            <div class="page-header">
                <h2>Library Management</h2>
                <ul class="breadcrumb">
                    <li>Library</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="books">Books</div>
                <div class="tab" data-tab="book-issue">Book Issue</div>
                <div class="tab" data-tab="book-return">Book Return</div>
                <div class="tab" data-tab="library-reports">Reports</div>
            </div>
            <div class="tab-content active" id="books-tab">
                <div class="table-header">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input id="book-search" placeholder="Search books..." type="text" />
                    </div>
                    <button class="btn btn-primary" id="add-book-btn">
                        <i class="fas fa-plus"></i> Add Book
                    </button>
                </div>
                <div class="table-container">
                    <table id="books-table">
                        <thead>
                            <tr>
                                <th>Book ID</th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Subject</th>
                                <th>Publisher</th>
                                <th>Available</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="books-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="book-issue-tab">
                <div class="form-container">
                    <form id="book-issue-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="issue-book">Book</label>
                                <select class="form-select" id="issue-book" required="">
                                    <option value="">Select Book</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="issue-student">Student</label>
                                <select class="form-select" id="issue-student" required="">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="issue-date">Issue Date</label>
                                <input class="form-control" id="issue-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="due-date">Due Date</label>
                                <input class="form-control" id="due-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="issue-remarks">Remarks</label>
                            <textarea class="form-control form-textarea" id="issue-remarks"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Issue Book</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <h3>Currently Issued Books</h3>
                    <table id="issued-books-table">
                        <thead>
                            <tr>
                                <th>Issue ID</th>
                                <th>Book Title</th>
                                <th>Student Name</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="issued-books-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="book-return-tab">
                <div class="form-container">
                    <form id="book-return-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="return-issue-id">Issue ID</label>
                                <input class="form-control" id="return-issue-id"
                                    placeholder="Enter Issue ID or scan barcode" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="return-book">Book</label>
                                <select class="form-select" id="return-book">
                                    <option value="">Select Issued Book</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="return-student">Student</label>
                                <select class="form-select" id="return-student">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="return-date">Return Date</label>
                                <input class="form-control" id="return-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="fine-amount">Fine Amount</label>
                                <input class="form-control" id="fine-amount" min="0" type="number" value="0" readonly />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="return-remarks">Remarks</label>
                            <textarea class="form-control form-textarea" id="return-remarks"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit" id="submit-return-book">Return Book</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="library-reports-tab">
                <div class="form-container">
                    <form id="library-report-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lr-report-type">Report Type</label>
                                <select class="form-select" id="lr-report-type" required="">
                                    <option value="inventory">Book Inventory</option>
                                    <option value="issue-return">Issue &amp; Return</option>
                                    <option value="overdue">Overdue Books</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lr-start-date">Start Date</label>
                                <input class="form-control" id="lr-start-date" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="lr-end-date">End Date</label>
                                <input class="form-control" id="lr-end-date" type="date" />
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report</button>
                            <button class="btn btn-secondary" id="print-library-report-btn" type="button">Print
                                Report</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="library-report-container" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Library Report</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" id="export-library-report-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div id="library-report-content">
                    </div>
                </div>
            </div>
        </section>
        <div class="modal" id="book-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add New Book</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="book-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="book-title">Title</label>
                                <input class="form-control" id="book-title" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="book-author">Author</label>
                                <input class="form-control" id="book-author" required="" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="book-subject">Subject</label>
                                <input class="form-control" id="book-subject" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="book-publisher">Publisher</label>
                                <input class="form-control" id="book-publisher" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="book-isbn">ISBN</label>
                                <input class="form-control" id="book-isbn" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="book-edition">Edition</label>
                                <input class="form-control" id="book-edition" type="text" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="book-copies">Number of Copies</label>
                                <input class="form-control" id="book-copies" min="1" required="" type="number"
                                    value="1" />
                            </div>
                            <div class="form-group">
                                <label for="book-price">Price</label>
                                <input class="form-control" id="book-price" min="0" step="0.01" type="number" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="book-description">Description</label>
                            <textarea class="form-control form-textarea" id="book-description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="book-cover">Book Cover</label>
                            <input accept="image/*" class="form-control" id="book-cover" type="file" />
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Book</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="madrasa-section">
            <div class="page-header">
                <h2>Madrasa Module</h2>
                <ul class="breadcrumb">
                    <li>Madrasa Module</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="hifz-tracking">Hifz Tracking</div>
                <div class="tab" data-tab="sabaq-sabaqi">Sabaq &amp; Sabaqi</div>
                <div class="tab" data-tab="madrasa-reports">Reports</div>
            </div>
            <div class="tab-content active" id="hifz-tracking-tab">
                <div class="form-container">
                    <form id="hifz-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hifz-student">Student</label>
                                <select class="form-select" id="hifz-student">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hifz-class">Class</label>
                                <select class="form-select" id="hifz-class">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hifz-teacher">Teacher</label>
                                <select class="form-select" id="hifz-teacher">
                                    <option value="">All Teachers</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Load Records</button>
                            <button class="btn btn-success" id="add-hifz-record-btn">
                                <i class="fas fa-plus"></i> Add Hifz Record
                            </button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table id="hifz-records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Surah</th>
                                <th>From Ayah</th>
                                <th>To Ayah</th>
                                <th>Status</th>
                                <th>Teacher</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hifz-records-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="sabaq-sabaqi-tab">
                <div class="form-container">
                    <form id="sabaq-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sabaq-student">Student</label>
                                <select class="form-select" id="sabaq-student">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sabaq-class">Class</label>
                                <select class="form-select" id="sabaq-class">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sabaq-teacher">Teacher</label>
                                <select class="form-select" id="sabaq-teacher">
                                    <option value="">All Teachers</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Load Records</button>
                            <button class="btn btn-success" id="add-sabaq-record-btn">
                                <i class="fas fa-plus"></i> Add Sabaq Record
                            </button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table id="sabaq-records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Sabaq (New)</th>
                                <th>Sabaqi (Recent)</th>
                                <th>Manzil (Old)</th>
                                <th>Teacher</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sabaq-records-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="madrasa-reports-tab">
                <div class="form-container">
                    <form id="madrasa-report-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mr-report-type">Report Type</label>
                                <select class="form-select" id="mr-report-type" required="">
                                    <option value="hifz-progress">Hifz Progress</option>
                                    <option value="sabaq-progress">Sabaq Progress</option>
                                    <option value="student-performance">Student Performance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mr-student">Student</label>
                                <select class="form-select" id="mr-student">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mr-class">Class</label>
                                <select class="form-select" id="mr-class">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="mr-start-date">Start Date</label>
                                <input class="form-control" id="mr-start-date" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="mr-end-date">End Date</label>
                                <input class="form-control" id="mr-end-date" type="date" />
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Report</button>
                            <button class="btn btn-secondary" id="print-madrasa-report-btn" type="button">Print
                                Report</button>
                        </div>
                    </form>
                </div>
                <div class="table-container" id="madrasa-report-container" style="display: none;">
                    <div class="table-header">
                        <h3 class="table-title">Madrasa Report</h3>
                        <div class="table-actions">
                            <button class="btn btn-sm btn-outline-primary" id="export-madrasa-report-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div id="madrasa-report-content">
                    </div>
                </div>
            </div>
        </section>
        <div class="modal" id="hifz-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add Hifz Record</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="hifz-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hifz-record-student">Student</label>
                                <select class="form-select" id="hifz-record-student" required="">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hifz-record-date">Date</label>
                                <input class="form-control" id="hifz-record-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hifz-surah">Surah</label>
                                <select class="form-select" id="hifz-surah" required="">
                                    <option value="">Select Surah</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="hifz-teacher-record">Teacher</label>
                                <select class="form-select" id="hifz-teacher-record" required="">
                                    <option value="">Select Teacher</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hifz-from-ayah">From Ayah</label>
                                <input class="form-control" id="hifz-from-ayah" min="1" required="" type="number" />
                            </div>
                            <div class="form-group">
                                <label for="hifz-to-ayah">To Ayah</label>
                                <input class="form-control" id="hifz-to-ayah" min="1" required="" type="number" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="hifz-status">Status</label>
                            <select class="form-select" id="hifz-status" required="">
                                <option value="Memorized">Memorized</option>
                                <option value="Revised">Revised</option>
                                <option value="In Progress">In Progress</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="hifz-remarks">Remarks</label>
                            <textarea class="form-control form-textarea" id="hifz-remarks"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Record</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="modal" id="sabaq-modal">
            <div class="modal-dialog">
                <div class="modal-header">
                    <h3 class="modal-title">Add Sabaq Record</h3>
                    <button class="modal-close">×</button>
                </div>
                <div class="modal-body">
                    <form id="sabaq-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sabaq-record-student">Student</label>
                                <select class="form-select" id="sabaq-record-student" required="">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sabaq-record-date">Date</label>
                                <input class="form-control" id="sabaq-record-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sabaq-teacher-record">Teacher</label>
                                <select class="form-select" id="sabaq-teacher-record" required="">
                                    <option value="">Select Teacher</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sabaq-status">Status</label>
                                <select class="form-select" id="sabaq-status" required="">
                                    <option value="Completed">Completed</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Pending">Pending</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="sabaq-new">Sabaq (New Lesson)</label>
                            <textarea class="form-control form-textarea" id="sabaq-new" required=""></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sabaq-recent">Sabaqi (Recent Revision)</label>
                            <textarea class="form-control form-textarea" id="sabaq-recent" required=""></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sabaq-old">Manzil (Old Revision)</label>
                            <textarea class="form-control form-textarea" id="sabaq-old"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sabaq-remarks">Remarks</label>
                            <textarea class="form-control form-textarea" id="sabaq-remarks"></textarea>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary modal-close" type="button">Cancel</button>
                            <button class="btn btn-primary" type="submit">Save Record</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <section class="content-section" id="reports-students-section">
            <div class="page-header">
                <h2>Student Reports</h2>
                <ul class="breadcrumb">
                    <li>Reports</li>
                    <li>Student Reports</li>
                </ul>
            </div>
            <div class="form-container">
                <form id="student-report-filter-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sr-report-type">Report Type</label>
                            <select class="form-select" id="sr-report-type" required="">
                                <option value="admission">Admission Report</option>
                                <option value="class-wise">Class-wise Report</option>
                                <option value="gender-wise">Gender-wise Report</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sr-class">Class</label>
                            <select class="form-select" id="sr-class">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sr-section">Section</label>
                            <select class="form-select" id="sr-section">
                                <option value="">All Sections</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sr-start-date">Start Date</label>
                            <input class="form-control" id="sr-start-date" type="date" />
                        </div>
                        <div class="form-group">
                            <label for="sr-end-date">End Date</label>
                            <input class="form-control" id="sr-end-date" type="date" />
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">Generate Report</button>
                        <button class="btn btn-secondary" id="print-student-report-btn" type="button">Print
                            Report</button>
                    </div>
                </form>
            </div>
            <div class="table-container" id="student-report-container" style="display: none;">
                <div class="table-header">
                    <h3 class="table-title" id="student-report-title">Student Report</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" id="export-student-report-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div id="student-report-content">
                </div>
            </div>
        </section>
        <section class="content-section" id="reports-attendance-section">
            <div class="page-header">
                <h2>Attendance Reports</h2>
                <ul class="breadcrumb">
                    <li>Reports</li>
                    <li>Attendance Reports</li>
                </ul>
            </div>
            <div class="form-container">
                <form id="reports-attendance-filter-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ar-report-type-reports">Report Type</label>
                            <select class="form-select" id="ar-report-type-reports" required="">
                                <option value="daily">Daily Attendance</option>
                                <option value="monthly">Monthly Summary</option>
                                <option value="student-wise">Student-wise</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ar-class-reports">Class</label>
                            <select class="form-select" id="ar-class-reports">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ar-section-reports">Section</label>
                            <select class="form-select" id="ar-section-reports">
                                <option value="">All Sections</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ar-date-reports">Date</label>
                            <input class="form-control" id="ar-date-reports" type="date" />
                        </div>
                        <div class="form-group">
                            <label for="ar-month-reports">Month</label>
                            <select class="form-select" id="ar-month-reports">
                                <option value="">Select Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ar-year-reports">Year</label>
                            <select class="form-select" id="ar-year-reports">
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">Generate Report</button>
                        <button class="btn btn-secondary" id="print-attendance-report-reports-btn" type="button">Print
                            Report</button>
                    </div>
                </form>
            </div>
            <div class="table-container" id="attendance-report-container-reports" style="display: none;">
                <div class="table-header">
                    <h3 class="table-title" id="attendance-report-title-reports">Attendance Report</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" id="export-attendance-report-reports-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div id="attendance-report-content-reports">
                </div>
            </div>
        </section>
        <section class="content-section" id="reports-financial-section">
            <div class="page-header">
                <h2>Financial Reports</h2>
                <ul class="breadcrumb">
                    <li>Reports</li>
                    <li>Financial Reports</li>
                </ul>
            </div>
            <div class="form-container">
                <form id="financial-report-filter-form-reports">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fr-report-type-reports">Report Type</label>
                            <select class="form-select" id="fr-report-type-reports" required="">
                                <option value="fee-collection">Fee Collection</option>
                                <option value="expenses">Expenses</option>
                                <option value="income">Income</option>
                                <option value="balance-sheet">Balance Sheet</option>
                                <option value="salary-expense">Salary Expense</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fr-class-reports">Class</label>
                            <select class="form-select" id="fr-class-reports">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fr-start-date-reports">Start Date</label>
                            <input class="form-control" id="fr-start-date-reports" type="date" />
                        </div>
                        <div class="form-group">
                            <label for="fr-end-date-reports">End Date</label>
                            <input class="form-control" id="fr-end-date-reports" type="date" />
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">Generate Report</button>
                        <button class="btn btn-secondary" id="print-financial-report-reports-btn" type="button">Print
                            Report</button>
                    </div>
                </form>
            </div>
            <div class="table-container" id="financial-report-container-reports" style="display: none;">
                <div class="table-header">
                    <h3 class="table-title" id="financial-report-title-reports">Financial Report</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" id="export-financial-report-reports-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div id="financial-report-content-reports">
                </div>
            </div>
        </section>
        <section class="content-section" id="reports-library-section">
            <div class="page-header">
                <h2>Library Reports</h2>
                <ul class="breadcrumb">
                    <li>Reports</li>
                    <li>Library Reports</li>
                </ul>
            </div>
            <div class="form-container">
                <form id="library-report-filter-form-reports">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="lr-report-type-reports">Report Type</label>
                            <select class="form-select" id="lr-report-type-reports" required="">
                                <option value="inventory">Book Inventory</option>
                                <option value="issue-return">Issue &amp; Return</option>
                                <option value="overdue">Overdue Books</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lr-start-date-reports">Start Date</label>
                            <input class="form-control" id="lr-start-date-reports" type="date" />
                        </div>
                        <div class="form-group">
                            <label for="lr-end-date-reports">End Date</label>
                            <input class="form-control" id="lr-end-date-reports" type="date" />
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">Generate Report</button>
                        <button class="btn btn-secondary" id="print-library-report-reports-btn" type="button">Print
                            Report</button>
                    </div>
                </form>
            </div>
            <div class="table-container" id="library-report-container-reports" style="display: none;">
                <div class="table-header">
                    <h3 class="table-title" id="library-report-title-reports">Library Report</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" id="export-library-report-reports-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div id="library-report-content-reports">
                </div>
            </div>
        </section>
        <section class="content-section" id="reports-madrasa-section">
            <div class="page-header">
                <h2>Madrasa Reports</h2>
                <ul class="breadcrumb">
                    <li>Reports</li>
                    <li>Madrasa Reports</li>
                </ul>
            </div>
            <div class="form-container">
                <form id="madrasa-report-filter-form-reports">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mr-report-type-reports">Report Type</label>
                            <select class="form-select" id="mr-report-type-reports" required="">
                                <option value="hifz-progress">Hifz Progress</option>
                                <option value="sabaq-progress">Sabaq Progress</option>
                                <option value="student-performance">Student Performance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mr-student-reports">Student</label>
                            <select class="form-select" id="mr-student-reports">
                                <option value="">All Students</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mr-class-reports">Class</label>
                            <select class="form-select" id="mr-class-reports">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mr-start-date-reports">Start Date</label>
                            <input class="form-control" id="mr-start-date-reports" type="date" />
                        </div>
                        <div class="form-group">
                            <label for="mr-end-date-reports">End Date</label>
                            <input class="form-control" id="mr-end-date-reports" type="date" />
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">Generate Report</button>
                        <button class="btn btn-secondary" id="print-madrasa-report-reports-btn" type="button">Print
                            Report</button>
                    </div>
                </form>
            </div>
            <div class="table-container" id="madrasa-report-container-reports" style="display: none;">
                <div class="table-header">
                    <h3 class="table-title" id="madrasa-report-title-reports">Madrasa Report</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm btn-outline-primary" id="export-madrasa-report-reports-btn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                <div id="madrasa-report-content-reports">
                </div>
            </div>
        </section>
        <section class="content-section" id="utilities-section">
            <div class="page-header">
                <h2>ID Cards &amp; Certificates</h2>
                <ul class="breadcrumb">
                    <li>Utilities</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="id-cards">ID Cards</div>
                <div class="tab" data-tab="certificates">Certificates</div>
            </div>
            <div class="tab-content active" id="id-cards-tab">
                <div class="form-container">
                    <form id="id-card-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="id-card-type">ID Card Type</label>
                                <select class="form-select" id="id-card-type" required="">
                                    <option value="student">Student ID Card</option>
                                    <option value="teacher">Teacher ID Card</option>
                                    <option value="staff">Staff ID Card</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="id-card-person">Person</label>
                                <select class="form-select" id="id-card-person" required="">
                                    <option value="">Select Person</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate ID Card</button>
                            <button class="btn btn-secondary" id="print-id-card-btn" type="button" disabled>Print ID
                                Card</button>
                        </div>
                    </form>
                </div>
                <div class="card" id="id-card-preview" style="display: none;">
                    <div class="card-body">
                        <div id="id-card-content">
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-content" id="certificates-tab">
                <div class="form-container">
                    <form id="certificate-filter-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="certificate-type">Certificate Type</label>
                                <select class="form-select" id="certificate-type" required="">
                                    <option value="bonafide">Bonafide Certificate</option>
                                    <option value="transfer">Transfer Certificate</option>
                                    <option value="character">Character Certificate</option>
                                    <option value="hifz-completion">Hifz Completion Certificate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="certificate-student">Student</label>
                                <select class="form-select" id="certificate-student" required="">
                                    <option value="">Select Student</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Generate Certificate</button>
                            <button class="btn btn-secondary" id="print-certificate-btn" type="button" disabled>Print
                                Certificate</button>
                        </div>
                    </form>
                </div>
                <div class="card" id="certificate-preview" style="display: none;">
                    <div class="card-body">
                        <div id="certificate-content">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="content-section" id="settings-section">
            <div class="page-header">
                <h2>Settings</h2>
                <ul class="breadcrumb">
                    <li>Settings</li>
                </ul>
            </div>
            <div class="tabs">
                <div class="tab active" data-tab="institution">Institution</div>
                <div class="tab" data-tab="academic">Academic</div>
                <div class="tab" data-tab="fee">Fee</div>
                <div class="tab" data-tab="system">System</div>
                <div class="tab" data-tab="backup">Backup &amp; Restore</div>
            </div>
            <div class="tab-content active" id="institution-tab">
                <div class="form-container">
                    <form id="institution-settings-form">
                        <div class="form-group">
                            <label for="institution-name">Institution Name</label>
                            <input class="form-control" id="institution-name" required="" type="text" />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="institution-phone">Phone</label>
                                <input class="form-control" id="institution-phone" required="" type="tel" />
                            </div>
                            <div class="form-group">
                                <label for="institution-email">Email</label>
                                <input class="form-control" id="institution-email" required="" type="email" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="institution-address">Address</label>
                            <textarea class="form-control form-textarea" id="institution-address"
                                required=""></textarea>
                        </div>
                        <div class="form-group">
                            <label for="institution-logo">Logo</label>
                            <input accept="image/*" class="form-control" id="institution-logo" type="file" />
                            <div id="logo-preview" style="margin-top: 10px;"></div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="academic-tab">
                <div class="form-container">
                    <form id="academic-settings-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="academic-year">Academic Year</label>
                                <input class="form-control" id="academic-year" required="" type="text" />
                            </div>
                            <div class="form-group">
                                <label for="academic-session">Session</label>
                                <select class="form-select" id="academic-session" required="">
                                    <option value="Morning">Morning</option>
                                    <option value="Evening">Evening</option>
                                    <option value="Both">Both</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="academic-start-date">Academic Start Date</label>
                                <input class="form-control" id="academic-start-date" required="" type="date" />
                            </div>
                            <div class="form-group">
                                <label for="academic-end-date">Academic End Date</label>
                                <input class="form-control" id="academic-end-date" required="" type="date" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="weekends">Weekends</label>
                            <select class="form-select" id="weekends" multiple="">
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="fee-tab">
                <div class="form-container">
                    <form id="fee-settings-form">
                        <div class="form-group">
                            <label for="fee-currency">Currency</label>
                            <select class="form-select" id="fee-currency" required="">
                                <option value="$">Dollar ($)</option>
                                <option value="€">Euro (€)</option>
                                <option value="£">Pound (£)</option>
                                <option value="¥">Yen (¥)</option>
                                <option value="₹">Rupee (₹)</option>
                                <option value="₨">Rupee (₨)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fee-fine-rate">Late Fee Fine Rate (per day)</label>
                            <input class="form-control" id="fee-fine-rate" min="0" required="" step="0.01"
                                type="number" />
                        </div>
                        <div class="form-group">
                            <label for="fee-payment-methods">Payment Methods</label>
                            <select class="form-select" id="fee-payment-methods" multiple="">
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Online Payment">Online Payment</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="system-tab">
                <div class="form-container">
                    <form id="system-settings-form">
                        <div class="form-group">
                            <label for="system-language">Language</label>
                            <select class="form-select" id="system-language" required="">
                                <option value="en">English</option>
                                <option value="ur">Urdu</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="system-theme">Theme</label>
                            <select class="form-select" id="system-theme" required="">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="system-timezone">Timezone</label>
                            <select class="form-select" id="system-timezone" required="">
                                <option value="UTC">UTC</option>
                                <option value="GMT+5">GMT+5 (Pakistan Standard Time)</option>
                                <option value="GMT-5">GMT-5 (Eastern Time)</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" type="submit">Save Settings</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="tab-content" id="backup-tab">
                <div class="form-container">
                    <div class="form-group">
                        <label>Backup Data</label>
                        <p>Create a backup of all system data. This will download a JSON file containing all your data.
                        </p>
                        <button class="btn btn-primary" id="backup-data-btn">
                            <i class="fas fa-download"></i> Backup Data
                        </button>
                    </div>
                    <div class="form-group">
                        <label for="restore-data">Restore Data</label>
                        <p>Restore system data from a previously created backup file.</p>
                        <input accept=".json" class="form-control" id="restore-data" type="file" />
                        <button class="btn btn-warning mt-10" disabled="" id="restore-data-btn">
                            <i class="fas fa-upload"></i> Restore Data
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Reset Data</label>
                        <p>Warning: This will delete all data and reset the system to its initial state.</p>
                        <button class="btn btn-danger" id="reset-data-btn">
                            <i class="fas fa-trash"></i> Reset Data
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script>
        const dbName = "SchoolMadrasaManagementDB";
        const dbVersion = 1;
        let db;
        const surahs = [
            "Al-Fatihah", "Al-Baqarah", "Al 'Imran", "An-Nisa'", "Al-Ma'idah",
            "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf",
            "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam",
            "Ta-Ha", "Al-Anbiya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan",
            "Ash-Shu'ara'", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum", "Luqman",
            "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Ya-Sin", "As-Saffat", "Sad",
            "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan",
            "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
            "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah",
            "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah", "As-Saff",
            "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim",
            "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn",
            "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat",
            "An-Naba'", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin",
            "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr",
            "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin",
            "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat", "Al-Qari'ah",
            "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un",
            "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq",
            "An-Nas"
        ];
        const request = indexedDB.open(dbName, dbVersion);
        request.onupgradeneeded = function (event) {
            const db = event.target.result;
            if (!db.objectStoreNames.contains('students')) {
                const studentsStore = db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
                studentsStore.createIndex('classId', 'classId', { unique: false });
                studentsStore.createIndex('section', 'section', { unique: false });
                studentsStore.createIndex('admissionNumber', 'admissionNumber', { unique: true });
            }
            if (!db.objectStoreNames.contains('teachers')) {
                const teachersStore = db.createObjectStore('teachers', { keyPath: 'id', autoIncrement: true });
                teachersStore.createIndex('subjects', 'subjects', { unique: false, multiEntry: true });
            }
            if (!db.objectStoreNames.contains('staff')) {
                db.createObjectStore('staff', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('classes')) {
                const classesStore = db.createObjectStore('classes', { keyPath: 'id', autoIncrement: true });
                classesStore.createIndex('name', 'name', { unique: true });
            }
            if (!db.objectStoreNames.contains('subjects')) {
                const subjectsStore = db.createObjectStore('subjects', { keyPath: 'id', autoIncrement: true });
                subjectsStore.createIndex('name', 'name', { unique: true });
                subjectsStore.createIndex('code', 'code', { unique: true });
            }
            if (!db.objectStoreNames.contains('classSubjects')) {
                db.createObjectStore('classSubjects', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('attendance')) {
                const attendanceStore = db.createObjectStore('attendance', { keyPath: 'id', autoIncrement: true });
                attendanceStore.createIndex('date', 'date', { unique: false });
                attendanceStore.createIndex('studentId', 'studentId', { unique: false });
                attendanceStore.createIndex('classId', 'classId', { unique: false });
                attendanceStore.createIndex('section', 'section', { unique: false });
            }
            if (!db.objectStoreNames.contains('exams')) {
                const examsStore = db.createObjectStore('exams', { keyPath: 'id', autoIncrement: true });
                examsStore.createIndex('name', 'name', { unique: true });
            }
            if (!db.objectStoreNames.contains('examMarks')) {
                const examMarksStore = db.createObjectStore('examMarks', { keyPath: 'id', autoIncrement: true });
                examMarksStore.createIndex('examId', 'examId', { unique: false });
                examMarksStore.createIndex('studentId', 'studentId', { unique: false });
                examMarksStore.createIndex('subjectId', 'subjectId', { unique: false });
            }
            if (!db.objectStoreNames.contains('feeTypes')) {
                const feeTypesStore = db.createObjectStore('feeTypes', { keyPath: 'id', autoIncrement: true });
                feeTypesStore.createIndex('name', 'name', { unique: true });
                feeTypesStore.createIndex('code', 'code', { unique: true });
            }
            if (!db.objectStoreNames.contains('classFees')) {
                const classFeesStore = db.createObjectStore('classFees', { keyPath: 'id', autoIncrement: true });
                classFeesStore.createIndex('classId', 'classId', { unique: false });
                classFeesStore.createIndex('feeTypeId', 'feeTypeId', { unique: false });
            }
            if (!db.objectStoreNames.contains('feePayments')) {
                const feePaymentsStore = db.createObjectStore('feePayments', { keyPath: 'id', autoIncrement: true });
                feePaymentsStore.createIndex('studentId', 'studentId', { unique: false });
                feePaymentsStore.createIndex('feeTypeId', 'feeTypeId', { unique: false });
                feePaymentsStore.createIndex('paymentDate', 'paymentDate', { unique: false });
            }
            if (!db.objectStoreNames.contains('salaries')) {
                const salariesStore = db.createObjectStore('salaries', { keyPath: 'id', autoIncrement: true });
                salariesStore.createIndex('employeeId', 'employeeId', { unique: false });
                salariesStore.createIndex('employeeType', 'employeeType', { unique: false });
                salariesStore.createIndex('month', 'month', { unique: false });
                salariesStore.createIndex('year', 'year', { unique: false });
            }
            if (!db.objectStoreNames.contains('expenses')) {
                const expensesStore = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                expensesStore.createIndex('date', 'date', { unique: false });
                expensesStore.createIndex('category', 'category', { unique: false });
            }
            if (!db.objectStoreNames.contains('income')) {
                const incomeStore = db.createObjectStore('income', { keyPath: 'id', autoIncrement: true });
                incomeStore.createIndex('date', 'date', { unique: false });
                incomeStore.createIndex('category', 'category', { unique: false });
            }
            if (!db.objectStoreNames.contains('books')) {
                const booksStore = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                booksStore.createIndex('title', 'title', { unique: false });
                booksStore.createIndex('author', 'author', { unique: false });
                booksStore.createIndex('subject', 'subject', { unique: false });
            }
            if (!db.objectStoreNames.contains('bookIssues')) {
                const bookIssuesStore = db.createObjectStore('bookIssues', { keyPath: 'id', autoIncrement: true });
                bookIssuesStore.createIndex('bookId', 'bookId', { unique: false });
                bookIssuesStore.createIndex('studentId', 'studentId', { unique: false });
                bookIssuesStore.createIndex('issueDate', 'issueDate', { unique: false });
                bookIssuesStore.createIndex('dueDate', 'dueDate', { unique: false });
                bookIssuesStore.createIndex('status', 'status', { unique: false });
            }
            if (!db.objectStoreNames.contains('hifzRecords')) {
                const hifzRecordsStore = db.createObjectStore('hifzRecords', { keyPath: 'id', autoIncrement: true });
                hifzRecordsStore.createIndex('studentId', 'studentId', { unique: false });
                hifzRecordsStore.createIndex('teacherId', 'teacherId', { unique: false });
                hifzRecordsStore.createIndex('date', 'date', { unique: false });
                hifzRecordsStore.createIndex('surah', 'surah', { unique: false });
            }
            if (!db.objectStoreNames.contains('sabaqRecords')) {
                const sabaqRecordsStore = db.createObjectStore('sabaqRecords', { keyPath: 'id', autoIncrement: true });
                sabaqRecordsStore.createIndex('studentId', 'studentId', { unique: false });
                sabaqRecordsStore.createIndex('teacherId', 'teacherId', { unique: false });
                sabaqRecordsStore.createIndex('date', 'date', { unique: false });
            }
            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }
            if (!db.objectStoreNames.contains('activities')) {
                const activitiesStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
                activitiesStore.createIndex('date', 'date', { unique: false });
            }
            if (!db.objectStoreNames.contains('events')) {
                const eventsStore = db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
                eventsStore.createIndex('date', 'date', { unique: false });
            }
        };
        request.onsuccess = function (event) {
            db = event.target.result;
            console.log("Database opened successfully");
            initApp();
            addSampleData();
        };
        request.onerror = function (event) {
            console.error("Database error:", event.target.error);
        };
        function getAllRecords(store) {
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = function () {
                    resolve(request.result);
                };
                request.onerror = function (event) {
                    reject(event.target.error);
                };
            });
        }
        function getRecord(store, id) {
            return new Promise((resolve, reject) => {
                const request = store.get(id);
                request.onsuccess = function () {
                    resolve(request.result);
                };
                request.onerror = function (event) {
                    reject(event.target.error);
                };
            });
        }
        async function addSampleData() {
            const transaction = db.transaction(db.objectStoreNames, 'readwrite');
            const stores = Array.from(db.objectStoreNames).map(name => transaction.objectStore(name));
            try {
                const studentCount = await new Promise(resolve => transaction.objectStore('students').count().onsuccess = (e) => resolve(e.target.result));
                if (studentCount > 0) {
                    console.log("Sample data already exists. Skipping insertion.");
                    return;
                }
                console.log("Adding sample data...");
                const sampleClasses = [
                    { name: "1st Grade", numericValue: 1, sections: ["A", "B"], classTeacher: "" },
                    { name: "2nd Grade", numericValue: 2, sections: ["A", "B"], classTeacher: "" },
                    { name: "3rd Grade", numericValue: 3, sections: ["A", "C"], classTeacher: "" }
                ];
                for (let i = 0; i < sampleClasses.length; i++) {
                    const req = transaction.objectStore('classes').add(sampleClasses[i]);
                    await new Promise(resolve => req.onsuccess = (e) => { sampleClasses[i].id = e.target.result; resolve(); });
                }
                const sampleTeachers = [
                    { firstName: "Aisha", lastName: "Khan", gender: "Female", dob: "1985-03-15", email: "aisha.k@school.pk", phone: "03001234567", qualification: "M.A. Education", subjects: ["English", "Urdu"], joiningDate: "2010-09-01", salary: 50000, address: "Lahore, Pakistan" },
                    { firstName: "Ahmed", lastName: "Siddiqui", gender: "Male", dob: "1978-07-22", email: "ahmed.s@school.pk", phone: "03217654321", qualification: "M.Sc. Physics", subjects: ["Math", "Science"], joiningDate: "2008-08-20", salary: 60000, address: "Karachi, Pakistan" },
                    { firstName: "Fatima", lastName: "Zahra", gender: "Female", dob: "1990-11-01", email: "fatima.z@school.pk", phone: "03339876543", qualification: "B.A. Islamic Studies", subjects: ["Quran", "Islamiyat"], joiningDate: "2015-01-10", salary: 45000, address: "Islamabad, Pakistan" }
                ];
                for (let i = 0; i < sampleTeachers.length; i++) {
                    const req = transaction.objectStore('teachers').add(sampleTeachers[i]);
                    await new Promise(resolve => req.onsuccess = (e) => { sampleTeachers[i].id = e.target.result; resolve(); });
                }
                const classesStore = transaction.objectStore('classes');
                let cls1 = await getRecord(classesStore, sampleClasses[0].id);
                if (cls1) {
                    cls1.classTeacher = sampleTeachers[0].firstName + " " + sampleTeachers[0].lastName;
                    await classesStore.put(cls1);
                }
                let cls2 = await getRecord(classesStore, sampleClasses[1].id);
                if (cls2) {
                    cls2.classTeacher = sampleTeachers[1].firstName + " " + sampleTeachers[1].lastName;
                    await classesStore.put(cls2);
                }
                const sampleStudents = [
                    { firstName: "Ali", lastName: "Rehman", gender: "Male", dob: "2016-01-20", classId: sampleClasses[0].id, section: "A", admissionDate: "2022-09-01", admissionNumber: "ADM001", address: "Rawalpindi", fatherName: "Usman Rehman", fatherPhone: "03451122334", motherName: "Sana Usman", motherPhone: "03019988776" },
                    { firstName: "Zainab", lastName: "Shah", gender: "Female", dob: "2015-05-10", classId: sampleClasses[0].id, section: "A", admissionDate: "2022-09-01", admissionNumber: "ADM002", address: "Faisalabad", fatherName: "Imran Shah", fatherPhone: "03332211445", motherName: "Hira Imran", motherPhone: "03206655443" },
                    { firstName: "Bilal", lastName: "Tariq", gender: "Male", dob: "2014-09-05", classId: sampleClasses[1].id, section: "B", admissionDate: "2021-09-01", admissionNumber: "ADM003", address: "Peshawar", fatherName: "Javed Tariq", fatherPhone: "03005544332", motherName: "Nazia Javed", motherPhone: "03118877665" },
                    { firstName: "Mehvish", lastName: "Ayub", gender: "Female", dob: "2013-11-25", classId: sampleClasses[2].id, section: "A", admissionDate: "2020-09-01", admissionNumber: "ADM004", address: "Quetta", fatherName: "Ayub Khan", fatherPhone: "03409988776", motherName: "Shabana Ayub", motherPhone: "03021122334" }
                ];
                for (let i = 0; i < sampleStudents.length; i++) {
                    const req = transaction.objectStore('students').add(sampleStudents[i]);
                    await new Promise(resolve => req.onsuccess = (e) => { sampleStudents[i].id = e.target.result; resolve(); });
                }
                const sampleStaff = [
                    { firstName: "Kamran", lastName: "Ahmed", gender: "Male", dob: "1975-02-01", email: "kamran.a@school.pk", phone: "03101122334", role: "Accountant", joiningDate: "2012-04-01", salary: 40000, status: "Active", address: "Sialkot" }
                ];
                for (const staff of sampleStaff) {
                    await transaction.objectStore('staff').add(staff);
                }
                const sampleSubjects = [
                    { name: "English", code: "ENG101", type: "Core", teacher: sampleTeachers[0].firstName + " " + sampleTeachers[0].lastName, description: "Basic English Language" },
                    { name: "Mathematics", code: "MAT101", type: "Core", teacher: sampleTeachers[1].firstName + " " + sampleTeachers[1].lastName, description: "Basic Mathematics" },
                    { name: "Science", code: "SCI101", type: "Core", teacher: sampleTeachers[1].firstName + " " + sampleTeachers[1].lastName, description: "Basic Science" },
                    { name: "Urdu", code: "URD101", type: "Core", teacher: sampleTeachers[0].firstName + " " + sampleTeachers[0].lastName, description: "National Language" },
                    { name: "Quranic Studies", code: "QRS101", type: "Core", teacher: sampleTeachers[2].firstName + " " + sampleTeachers[2].lastName, description: "Quran recitation and basic Tajweed" }
                ];
                for (let i = 0; i < sampleSubjects.length; i++) {
                    const req = transaction.objectStore('subjects').add(sampleSubjects[i]);
                    await new Promise(resolve => req.onsuccess = (e) => { sampleSubjects[i].id = e.target.result; resolve(); });
                }
                const assignSubjectsStore = transaction.objectStore('classSubjects');
                await assignSubjectsStore.add({ classId: sampleClasses[0].id, section: "A", subjectId: sampleSubjects[0].id, teacherId: sampleTeachers[0].id });
                await assignSubjectsStore.add({ classId: sampleClasses[0].id, section: "A", subjectId: sampleSubjects[1].id, teacherId: sampleTeachers[1].id });
                await assignSubjectsStore.add({ classId: sampleClasses[0].id, section: "A", subjectId: sampleSubjects[4].id, teacherId: sampleTeachers[2].id });
                const sampleFeeTypes = [
                    { name: "Admission Fee", code: "ADMFEE", amount: 5000, frequency: "One Time", description: "Fee at the time of admission" },
                    { name: "Tuition Fee", code: "TUTFEE", amount: 2000, frequency: "Monthly", description: "Monthly tuition fee" },
                    { name: "Annual Charges", code: "ANNCHR", amount: 3000, frequency: "Yearly", description: "Annual school charges" }
                ];
                for (let i = 0; i < sampleFeeTypes.length; i++) {
                    const req = transaction.objectStore('feeTypes').add(sampleFeeTypes[i]);
                    await new Promise(resolve => req.onsuccess = (e) => { sampleFeeTypes[i].id = e.target.result; resolve(); });
                }
                const assignFeeStore = transaction.objectStore('classFees');
                await assignFeeStore.add({ classId: sampleClasses[0].id, feeTypeId: sampleFeeTypes[0].id, amount: 5000, dueDate: "" });
                await assignFeeStore.add({ classId: sampleClasses[0].id, feeTypeId: sampleFeeTypes[1].id, amount: 2000, dueDate: "2024-10-05" });
                await assignFeeStore.add({ classId: sampleClasses[1].id, feeTypeId: sampleFeeTypes[1].id, amount: 2500, dueDate: "2024-10-05" });
                const feePaymentsStore = transaction.objectStore('feePayments');
                await feePaymentsStore.add({ studentId: sampleStudents[0].id, feeTypeId: sampleFeeTypes[1].id, amount: 2000, paymentDate: "2024-09-28", method: "Cash", remarks: "September tuition" });
                await feePaymentsStore.add({ studentId: sampleStudents[1].id, feeTypeId: sampleFeeTypes[1].id, amount: 2000, paymentDate: "2024-09-29", method: "Bank Transfer", remarks: "September tuition" });
                await feePaymentsStore.add({ studentId: sampleStudents[2].id, feeTypeId: sampleFeeTypes[1].id, amount: 2500, paymentDate: "2024-09-30", method: "Cheque", remarks: "September tuition" });
                const sampleExams = [
                    { name: "Mid-Term Exams 2024", type: "Term", startDate: "2024-11-10", endDate: "2024-11-20", classes: [sampleClasses[0].id.toString(), sampleClasses[1].id.toString()], description: "Mid-term examinations for all core subjects." }
                ];
                for (const exam of sampleExams) {
                    await transaction.objectStore('exams').add(exam);
                }
                const sampleBooks = [
                    { title: "English Grammar Basics", author: "John Smith", subject: "English", publisher: "Oxford", isbn: "978-0194320281", edition: "3rd", copies: 5, availableCopies: 5, price: 500, description: "A comprehensive guide to English grammar." },
                    { title: "Algebra for Beginners", author: "Alice Johnson", subject: "Mathematics", publisher: "Pearson", isbn: "978-1292095946", edition: "2nd", copies: 3, availableCopies: 3, price: 750, description: "Introduction to algebraic concepts." }
                ];
                for (let i = 0; i < sampleBooks.length; i++) {
                    const req = transaction.objectStore('books').add(sampleBooks[i]);
                    await new Promise(resolve => req.onsuccess = (e) => { sampleBooks[i].id = e.target.result; resolve(); });
                }
                const bookIssuesStore = transaction.objectStore('bookIssues');
                await bookIssuesStore.add({ bookId: sampleBooks[0].id, studentId: sampleStudents[0].id, issueDate: "2024-09-20", dueDate: "2024-10-20", status: "Issued", remarks: "" });
                const updatedBook = await getRecord(transaction.objectStore('books'), sampleBooks[0].id);
                if (updatedBook) {
                    updatedBook.availableCopies -= 1;
                    await transaction.objectStore('books').put(updatedBook);
                }
                const hifzRecordsStore = transaction.objectStore('hifzRecords');
                await hifzRecordsStore.add({ studentId: sampleStudents[0].id, studentName: `${sampleStudents[0].firstName} ${sampleStudents[0].lastName}`, date: "2024-09-25", surah: "Al-Fatihah", fromAyah: 1, toAyah: 7, status: "Memorized", teacherId: sampleTeachers[2].id, teacherName: `${sampleTeachers[2].firstName} ${sampleTeachers[2].lastName}`, remarks: "Excellent" });
                await hifzRecordsStore.add({ studentId: sampleStudents[1].id, studentName: `${sampleStudents[1].firstName} ${sampleStudents[1].lastName}`, date: "2024-09-26", surah: "Al-Baqarah", fromAyah: 1, toAyah: 5, status: "In Progress", teacherId: sampleTeachers[2].id, teacherName: `${sampleTeachers[2].firstName} ${sampleTeachers[2].lastName}`, remarks: "Needs more practice" });
                const sabaqRecordsStore = transaction.objectStore('sabaqRecords');
                await sabaqRecordsStore.add({ studentId: sampleStudents[0].id, studentName: `${sampleStudents[0].firstName} ${sampleStudents[0].lastName}`, date: "2024-09-27", teacherId: sampleTeachers[2].id, teacherName: `${sampleTeachers[2].firstName} ${sampleTeachers[2].lastName}`, status: "Completed", sabaqNew: "Al-Kahf (1-10)", sabaqRecent: "Al-Isra (1-10)", sabaqOld: "Yunus (Full)", remarks: "Good progress" });
                await sabaqRecordsStore.add({ studentId: sampleStudents[2].id, studentName: `${sampleStudents[2].firstName} ${sampleStudents[2].lastName}`, date: "2024-09-28", teacherId: sampleTeachers[2].id, teacherName: `${sampleTeachers[2].firstName} ${sampleTeachers[2].lastName}`, status: "In Progress", sabaqNew: "Surah Ta-Ha (1-5)", sabaqRecent: "Surah Maryam (1-10)", sabaqOld: "", remarks: "Focus on Tajweed" });
                const attendanceStore = transaction.objectStore('attendance');
                const today = new Date().toISOString().split('T')[0];
                await attendanceStore.add({ studentId: sampleStudents[0].id, studentName: `${sampleStudents[0].firstName} ${sampleStudents[0].lastName}`, classId: sampleStudents[0].classId, section: sampleStudents[0].section, date: today, status: "Present", remarks: "" });
                await attendanceStore.add({ studentId: sampleStudents[1].id, studentName: `${sampleStudents[1].firstName} ${sampleStudents[1].lastName}`, classId: sampleStudents[1].classId, section: sampleStudents[1].section, date: today, status: "Present", remarks: "" });
                await attendanceStore.add({ studentId: sampleStudents[2].id, studentName: `${sampleStudents[2].firstName} ${sampleStudents[2].lastName}`, classId: sampleStudents[2].classId, section: sampleStudents[2].section, date: today, status: "Absent", remarks: "Sick" });
                await attendanceStore.add({ studentId: sampleStudents[3].id, studentName: `${sampleStudents[3].firstName} ${sampleStudents[3].lastName}`, classId: sampleStudents[3].classId, section: sampleStudents[3].section, date: today, status: "Present", remarks: "" });
                const eventsStore = transaction.objectStore('events');
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                await eventsStore.add({ title: "Parent-Teacher Meeting", date: tomorrow.toISOString(), description: "Discuss student progress." });
                await eventsStore.add({ title: "Annual Sports Day", date: nextWeek.toISOString(), description: "Annual sports competition." });
                const activitiesStore = transaction.objectStore('activities');
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                await activitiesStore.add({ type: "student", title: "New Student Admitted", description: `Student ${sampleStudents[0].firstName} ${sampleStudents[0].lastName} joined 1st Grade.`, date: new Date().toISOString() });
                await activitiesStore.add({ type: "fee", title: "Fee Collected", description: `PKR ${sampleFeeTypes[1].amount} collected from ${sampleStudents[1].firstName}.`, date: yesterday.toISOString() });
                await activitiesStore.add({ type: "library", title: "Book Issued", description: `"${sampleBooks[0].title}" issued to ${sampleStudents[0].firstName}.`, date: new Date().toISOString() });
                await activitiesStore.add({ type: "teacher", title: "Teacher Profile Updated", description: `Teacher ${sampleTeachers[0].firstName} ${sampleTeachers[0].lastName}'s profile updated.`, date: yesterday.toISOString() });
                transaction.oncomplete = function () {
                    console.log("Sample data added successfully.");
                    initApp();
                };
                transaction.onerror = function (event) {
                    console.error("Error adding sample data:", event.target.error);
                };
            } catch (error) {
                console.error("Error in sample data transaction:", error);
            }
        }
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
        function showSection(sectionHash) {
            const sectionId = sectionHash.startsWith('#') ? sectionHash.substring(1) : sectionHash;
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active', 'open'));
                let currentLink = document.querySelector(`.sidebar-menu a[href="#${sectionId}"]`);
                if (currentLink) {
                    currentLink.parentElement.classList.add('active');
                    let parentUl = currentLink.parentElement.closest('.submenu');
                    while (parentUl) {
                        parentUl.parentElement.classList.add('open');
                        parentUl = parentUl.parentElement.closest('.submenu');
                    }
                }
                const breadcrumb = document.querySelector('.main-content .breadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = '<li>Home</li>';
                    const crumbs = [];
                    let tempLink = currentLink;
                    while (tempLink && tempLink.textContent.trim() !== 'Home') {
                        crumbs.unshift(tempLink.textContent.trim());
                        tempLink = tempLink.parentElement.closest('.submenu')?.previousElementSibling;
                    }
                    crumbs.forEach(crumbText => {
                        const li = document.createElement('li');
                        li.textContent = crumbText;
                        breadcrumb.appendChild(li);
                    });
                }
                const firstTab = targetSection.querySelector('.tabs .tab');
                if (firstTab) {
                    firstTab.click();
                } else {
                    const formsToReset = targetSection.querySelectorAll('form');
                    formsToReset.forEach(form => form.reset());
                    if (sectionId === 'expenses-income' && sectionHash === '#expenses-income') {
                        targetSection.querySelector('.tabs .tab[data-tab="expenses"]').click();
                    }
                    if (sectionId === 'reports-financial' && sectionHash === '#reports-financial') {
                        targetSection.querySelector('.tabs .tab[data-tab="fee-collection"]').click();
                    }
                }
            }
        }
        function setupTabs() {
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabContainer = this.parentElement;
                    const parentSection = tabContainer.closest('.content-section');
                    const tabId = this.getAttribute('data-tab');
                    tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    if (parentSection) {
                        parentSection.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                            content.style.display = 'none';
                        });
                    }
                    const targetContent = document.getElementById(`${tabId}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                        loadTabContent(tabId);
                    }
                });
            });
        }
        async function loadTabContent(tabId) {
            switch (tabId) {
                case 'classes': loadClasses(); break;
                case 'subjects': loadSubjects(); break;
                case 'assign-subjects': loadClassSubjectAssignments(); break;
                case 'mark-attendance':
                    populateClassDropdowns(['attendance-class']);
                    document.getElementById('attendance-table-container').style.display = 'none';
                    document.getElementById('attendance-filter-form').reset();
                    break;
                case 'attendance-reports-academic':
                    populateClassDropdowns(['report-class-academic']);
                    populateStudentDropdowns(['report-student-academic']);
                    populateYearDropdowns(['report-year-academic']);
                    document.getElementById('attendance-report-container-academic').style.display = 'none';
                    document.getElementById('attendance-report-form-academic').reset();
                    break;
                case 'exam-schedule': loadExams(); break;
                case 'marks-entry':
                    populateExamDropdowns(['marks-exam']);
                    populateClassDropdowns(['marks-class']);
                    populateSubjectDropdowns(['marks-subject']);
                    document.getElementById('marks-table-container').style.display = 'none';
                    document.getElementById('marks-filter-form').reset();
                    break;
                case 'report-cards':
                    populateExamDropdowns(['rc-exam']);
                    populateClassDropdowns(['rc-class']);
                    populateStudentDropdowns(['rc-student']);
                    document.getElementById('report-cards-container').style.display = 'none';
                    document.getElementById('report-card-filter-form').reset();
                    break;
                case 'fee-structure': loadFeeTypes(); loadClassFeeStructure(); break;
                case 'collect-fee':
                    populateStudentDropdowns(['fee-student']);
                    populateClassDropdowns(['fee-class']);
                    document.getElementById('fee-details-container').innerHTML = '<p class="text-muted">Select a student and class to see fee details.</p>';
                    document.getElementById('fee-collection-form').reset();
                    document.getElementById('fee-total-amount').value = 0;
                    document.getElementById('print-receipt-btn').disabled = true;
                    break;
                case 'fee-reports-finance':
                    populateClassDropdowns(['fr-class-finance']);
                    populateFeeTypeDropdowns(['fr-fee-type-finance']);
                    populateYearDropdowns(['fr-year-finance']);
                    document.getElementById('fee-report-container-finance').style.display = 'none';
                    document.getElementById('fee-report-filter-form-finance').reset();
                    break;
                case 'fee-defaulters':
                    populateClassDropdowns(['df-class']);
                    populateFeeTypeDropdowns(['df-fee-type']);
                    document.getElementById('defaulters-container').style.display = 'none';
                    document.getElementById('defaulters-filter-form').reset();
                    break;
                case 'salary-structure': loadSalaryStructure(); break;
                case 'process-salary':
                    populateEmployeeDropdowns(['sr-employee']);
                    populateYearDropdowns(['salary-year']);
                    document.getElementById('salary-process-container').style.display = 'none';
                    document.getElementById('salary-process-form').reset();
                    break;
                case 'salary-reports':
                    populateEmployeeDropdowns(['sr-employee']);
                    populateYearDropdowns(['sr-year']);
                    document.getElementById('salary-report-container').style.display = 'none';
                    document.getElementById('salary-report-filter-form').reset();
                    break;
                case 'expenses': loadExpenses(); break;
                case 'income': loadIncome(); break;
                case 'financial-reports-finance':
                    populateStaticDropdowns(['expense-category', 'income-category']);
                    document.getElementById('financial-report-container-finance').style.display = 'none';
                    document.getElementById('financial-report-filter-form-finance').reset();
                    break;
                case 'books': loadBooks(); break;
                case 'book-issue':
                    populateBookDropdowns(['issue-book']);
                    populateStudentDropdowns(['issue-student']);
                    loadIssuedBooks();
                    document.getElementById('book-issue-form').reset();
                    break;
                case 'book-return':
                    populateIssuedBookDropdowns();
                    populateStudentDropdowns(['return-student']);
                    document.getElementById('book-return-form').reset();
                    document.getElementById('fine-amount').value = 0;
                    break;
                case 'library-reports':
                    document.getElementById('library-report-container').style.display = 'none';
                    document.getElementById('library-report-filter-form').reset();
                    break;
                case 'hifz-tracking':
                    populateStudentDropdowns(['hifz-student', 'hifz-record-student']);
                    populateClassDropdowns(['hifz-class']);
                    populateTeacherDropdowns(['hifz-teacher', 'hifz-teacher-record']);
                    populateSurahDropdowns(['hifz-surah']);
                    loadHifzRecords();
                    document.getElementById('hifz-filter-form').reset();
                    break;
                case 'sabaq-sabaqi':
                    populateStudentDropdowns(['sabaq-student', 'sabaq-record-student']);
                    populateClassDropdowns(['sabaq-class']);
                    populateTeacherDropdowns(['sabaq-teacher', 'sabaq-teacher-record']);
                    loadSabaqRecords();
                    document.getElementById('sabaq-filter-form').reset();
                    break;
                case 'madrasa-reports':
                    populateStudentDropdowns(['mr-student']);
                    populateClassDropdowns(['mr-class']);
                    document.getElementById('madrasa-report-container').style.display = 'none';
                    document.getElementById('madrasa-report-filter-form').reset();
                    break;
                case 'id-cards': setupIDCardGenerationDropdown(); break;
                case 'certificates':
                    populateStudentDropdowns(['certificate-student']);
                    document.getElementById('certificate-preview').style.display = 'none';
                    document.getElementById('certificate-content').innerHTML = '';
                    document.getElementById('print-certificate-btn').disabled = true;
                    document.getElementById('certificate-filter-form').reset();
                    break;
                case 'institution':
                case 'academic':
                case 'fee':
                case 'system':
                case 'backup':
                    loadSettings();
                    break;
                case 'reports-students':
                    populateClassDropdowns(['sr-class']);
                    populateYearDropdowns(['sr-start-date', 'sr-end-date']);
                    document.getElementById('student-report-container').style.display = 'none';
                    document.getElementById('student-report-filter-form').reset();
                    break;
                case 'reports-attendance':
                    populateClassDropdowns(['ar-class-reports']);
                    populateYearDropdowns(['ar-year-reports']);
                    populateStudentDropdowns(['report-student-academic']);
                    document.getElementById('attendance-report-container-reports').style.display = 'none';
                    document.getElementById('reports-attendance-filter-form').reset();
                    break;
                case 'reports-financial':
                    populateClassDropdowns(['fr-class-reports']);
                    populateStaticDropdowns(['fr-category-reports']);
                    populateYearDropdowns(['fr-start-date-reports', 'fr-end-date-reports']);
                    document.getElementById('financial-report-container-reports').style.display = 'none';
                    document.getElementById('financial-report-filter-form-reports').reset();
                    break;
                case 'reports-library':
                    document.getElementById('library-report-container-reports').style.display = 'none';
                    document.getElementById('library-report-filter-form-reports').reset();
                    break;
                case 'reports-madrasa':
                    populateStudentDropdowns(['mr-student-reports']);
                    populateClassDropdowns(['mr-class-reports']);
                    document.getElementById('madrasa-report-container-reports').style.display = 'none';
                    document.getElementById('madrasa-report-filter-form-reports').reset();
                    break;
                default:
                    console.warn('No specific loading logic for tab:', tabId);
                    break;
            }
        }
        function setupPagination(tableId, data, itemsPerPage, currentPage, renderFunction, paginationElementId) {
            const paginationEl = document.getElementById(paginationElementId);
            paginationEl.innerHTML = '';
            const totalPages = Math.ceil(data.length / itemsPerPage);
            const createPageLink = (page, text, isDisabled = false, isActive = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
                const a = document.createElement('a');
                a.className = 'page-link';
                a.href = '#';
                a.textContent = text;
                if (!isDisabled) {
                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        renderFunction(data, itemsPerPage, page);
                    });
                }
                li.appendChild(a);
                return li;
            };
            paginationEl.appendChild(createPageLink(Math.max(1, currentPage - 1), 'Previous', currentPage === 1));
            const maxPageLinks = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageLinks / 2));
            let endPage = Math.min(totalPages, startPage + maxPageLinks - 1);
            if (endPage - startPage + 1 < maxPageLinks) {
                startPage = Math.max(1, endPage - maxPageLinks + 1);
            }
            for (let i = startPage; i <= endPage; i++) {
                paginationEl.appendChild(createPageLink(i, i, false, i === currentPage));
            }
            paginationEl.appendChild(createPageLink(Math.min(totalPages, currentPage + 1), 'Next', currentPage === totalPages));
            renderFunction(data, itemsPerPage, currentPage);
        }
        function renderStudentsTable(students, itemsPerPage, currentPage) {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStudents = students.slice(startIndex, endIndex);
            paginatedStudents.forEach(student => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.id}</td>
                    <td><img src="${student.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzM0OThEQiIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDE5LjY3VjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg=='}" alt="Student Photo" class="avatar"></td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.class || 'N/A'}</td>
                    <td>${student.section || 'N/A'}</td>
                    <td>${student.fatherName || 'N/A'}</td>
                    <td>${student.fatherPhone || 'N/A'}</td>
                    <td><span class="status-badge status-active">Active</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-student" data-id="${student.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-student" data-id="${student.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-student').forEach(button => {
                button.addEventListener('click', function () {
                    editStudent(parseInt(this.getAttribute('data-id')));
                });
            });
            document.querySelectorAll('.delete-student').forEach(button => {
                button.addEventListener('click', function () {
                    deleteStudent(parseInt(this.getAttribute('data-id')));
                });
            });
        }
        function renderTeachersTable(teachers, itemsPerPage, currentPage) {
            const tbody = document.getElementById('teachers-table-body');
            tbody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTeachers = teachers.slice(startIndex, endIndex);
            paginatedTeachers.forEach(teacher => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${teacher.id}</td>
                    <td><img src="${teacher.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzJFRjFGNyIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDE5LjY3VjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg=='}" alt="Teacher Photo" class="avatar"></td>
                    <td>${teacher.firstName} ${teacher.lastName}</td>
                    <td>${teacher.subjects ? teacher.subjects.join(', ') : 'N/A'}</td>
                    <td>${teacher.qualification || 'N/A'}</td>
                    <td>${teacher.phone || 'N/A'}</td>
                    <td>${teacher.joiningDate || 'N/A'}</td>
                    <td><span class="status-badge status-active">Active</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-teacher" data-id="${teacher.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-teacher" data-id="${teacher.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-teacher').forEach(button => {
                button.addEventListener('click', function () {
                    editTeacher(parseInt(this.getAttribute('data-id')));
                });
            });
            document.querySelectorAll('.delete-teacher').forEach(button => {
                button.addEventListener('click', function () {
                    deleteTeacher(parseInt(this.getAttribute('data-id')));
                });
            });
        }
        function renderStaffTable(staffMembers, itemsPerPage, currentPage) {
            const tbody = document.getElementById('staff-table-body');
            tbody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStaff = staffMembers.slice(startIndex, endIndex);
            paginatedStaff.forEach(staffMember => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${staffMember.id}</td>
                    <td><img src="${staffMember.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0YzOUMyMSIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDE5LjY3VjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg=='}" alt="Staff Photo" class="avatar"></td>
                    <td>${staffMember.firstName} ${staffMember.lastName}</td>
                    <td>${staffMember.role || 'N/A'}</td>
                    <td>${staffMember.phone || 'N/A'}</td>
                    <td>${staffMember.joiningDate || 'N/A'}</td>
                    <td>${staffMember.salary ? '$' + staffMember.salary.toFixed(2) : 'N/A'}</td>
                    <td><span class="status-badge ${staffMember.status === 'Active' ? 'status-active' : 'status-inactive'}">${staffMember.status || 'Inactive'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-staff" data-id="${staffMember.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-staff" data-id="${staffMember.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-staff').forEach(button => {
                button.addEventListener('click', function () {
                    editStaff(parseInt(this.getAttribute('data-id')));
                });
            });
            document.querySelectorAll('.delete-staff').forEach(button => {
                button.addEventListener('click', function () {
                    deleteStaff(parseInt(this.getAttribute('data-id')));
                });
            });
        }
        async function loadDashboardData() {
            try {
                const studentsCount = await countRecords('students');
                document.getElementById('total-students').textContent = studentsCount;
                const teachersCount = await countRecords('teachers');
                document.getElementById('total-teachers').textContent = teachersCount;
                const feeCollected = await calculateFeeCollection();
                document.getElementById('fee-collection').textContent = `PKR ${feeCollected.toLocaleString()}`;
                const attendancePercentage = await calculateTodaysAttendance();
                document.getElementById('today-attendance').textContent = `${attendancePercentage}%`;
                loadRecentActivities();
                loadUpcomingEvents();
            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }
        function countRecords(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.count();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }
        async function calculateFeeCollection() {
            const payments = await getAllRecords(db.transaction(['feePayments'], 'readonly').objectStore('feePayments'));
            return payments.reduce((sum, p) => sum + (p.amountPaid || 0), 0);
        }
        async function calculateTodaysAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const attendanceRecords = await new Promise((resolve, reject) => {
                const transaction = db.transaction(['attendance'], 'readonly');
                const store = transaction.objectStore('attendance');
                const index = store.index('date');
                const request = index.getAll(today);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
            if (attendanceRecords.length === 0) return 0;
            const presentCount = attendanceRecords.filter(r => r.status === 'Present').length;
            return Math.round((presentCount / attendanceRecords.length) * 100);
        }
        async function loadRecentActivities() {
            const activities = await getAllRecords(db.transaction(['activities'], 'readonly').objectStore('activities'));
            const recentActivities = activities.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const activitiesList = document.getElementById('recent-activities');
            activitiesList.innerHTML = '';
            recentActivities.forEach(activity => {
                activitiesList.innerHTML += `
                    <li class="activity-item">
                        <div class="activity-icon">
                            <i class="fas ${getActivityIcon(activity.type)}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${formatTime(activity.date)}</div>
                        </div>
                    </li>
                `;
            });
        }
        function getActivityIcon(type) {
            const icons = {
                'student': 'fa-user-graduate',
                'teacher': 'fa-chalkboard-teacher',
                'fee': 'fa-money-bill-wave',
                'attendance': 'fa-clipboard-check',
                'exam': 'fa-file-alt',
                'library': 'fa-book',
                'system': 'fa-cog',
                'financial': 'fa-receipt',
                'madrasa': 'fa-mosque'
            };
            return icons[type] || 'fa-bell';
        }
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }
        async function loadUpcomingEvents() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const nextMonth = new Date();
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            nextMonth.setHours(23, 59, 59, 999);
            const events = await new Promise((resolve, reject) => {
                const transaction = db.transaction(['events'], 'readonly');
                const store = transaction.objectStore('events');
                const index = store.index('date');
                const range = IDBKeyRange.bound(today.toISOString(), nextMonth.toISOString());
                const request = index.getAll(range);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
            const upcomingEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
            const eventsList = document.getElementById('upcoming-events');
            eventsList.innerHTML = '';
            upcomingEvents.forEach(event => {
                const eventDate = new Date(event.date);
                eventsList.innerHTML += `
                    <li class="event-item">
                        <div class="event-date">
                            <div class="event-day">${eventDate.getDate()}</div>
                            <div class="event-month">${eventDate.toLocaleString('default', { month: 'short' })}</div>
                        </div>
                        <div class="event-content">
                            <div class="event-title">${event.title}</div>
                            <div class="event-time">
                                <i class="far fa-clock"></i>
                                ${eventDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    </li>
                `;
            });
        }
        async function loadStudents() {
            const students = await getAllRecords(db.transaction(['students'], 'readonly').objectStore('students'));
            setupPagination('students-table', students, 10, 1, renderStudentsTable, 'students-pagination');
        }
        async function loadTeachers() {
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            setupPagination('teachers-table', teachers, 10, 1, renderTeachersTable, 'teachers-pagination');
        }
        async function loadStaff() {
            const staff = await getAllRecords(db.transaction(['staff'], 'readonly').objectStore('staff'));
            setupPagination('staff-table', staff, 10, 1, renderStaffTable, 'staff-pagination');
        }
        async function loadClasses() {
            const classes = await getAllRecords(db.transaction(['classes'], 'readonly').objectStore('classes'));
            const tbody = document.getElementById('classes-table-body');
            tbody.innerHTML = '';
            for (const cls of classes) {
                const studentCount = await new Promise(resolve => {
                    const studentStore = db.transaction('students', 'readonly').objectStore('students');
                    const index = studentStore.index('classId');
                    const request = index.count(cls.id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(0);
                });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cls.id}</td>
                    <td>${cls.name || 'N/A'}</td>
                    <td>${cls.sections ? cls.sections.join(', ') : 'N/A'}</td>
                    <td>${cls.classTeacher || 'N/A'}</td>
                    <td>${studentCount}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-class" data-id="${cls.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-class" data-id="${cls.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            document.querySelectorAll('.edit-class').forEach(btn => btn.onclick = () => editClass(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-class').forEach(btn => btn.onclick = () => deleteClass(parseInt(btn.dataset.id)));
            populateClassDropdowns();
        }
        async function loadSubjects() {
            const subjects = await getAllRecords(db.transaction(['subjects'], 'readonly').objectStore('subjects'));
            const tbody = document.getElementById('subjects-table-body');
            tbody.innerHTML = '';
            subjects.forEach(subject => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${subject.id}</td>
                    <td>${subject.name || 'N/A'}</td>
                    <td>${subject.code || 'N/A'}</td>
                    <td>${subject.type || 'N/A'}</td>
                    <td>${subject.teacher || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-subject" data-id="${subject.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-subject" data-id="${subject.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-subject').forEach(btn => btn.onclick = () => editSubject(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-subject').forEach(btn => btn.onclick = () => deleteSubject(parseInt(btn.dataset.id)));
            populateSubjectDropdowns();
        }
        async function loadFeeTypes() {
            const feeTypes = await getAllRecords(db.transaction(['feeTypes'], 'readonly').objectStore('feeTypes'));
            const tbody = document.getElementById('fee-types-table-body');
            tbody.innerHTML = '';
            feeTypes.forEach(feeType => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${feeType.id}</td>
                    <td>${feeType.name || 'N/A'}</td>
                    <td>$${(feeType.amount || 0).toFixed(2)}</td>
                    <td>${feeType.frequency || 'N/A'}</td>
                    <td>${feeType.description || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-fee-type" data-id="${feeType.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-fee-type" data-id="${feeType.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-fee-type').forEach(btn => btn.onclick = () => editFeeType(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-fee-type').forEach(btn => btn.onclick = () => deleteFeeType(parseInt(btn.dataset.id)));
            populateFeeTypeDropdowns();
        }
        async function loadExams() {
            const exams = await getAllRecords(db.transaction(['exams'], 'readonly').objectStore('exams'));
            const tbody = document.getElementById('exams-table-body');
            tbody.innerHTML = '';
            for (const exam of exams) {
                const classes = await getAllRecords(db.transaction(['classes'], 'readonly').objectStore('classes'));
                const classNames = exam.classes ? exam.classes.map(id => classes.find(c => c.id == id)?.name || 'N/A').join(', ') : 'N/A';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${exam.id}</td>
                    <td>${exam.name || 'N/A'}</td>
                    <td>${exam.type || 'N/A'}</td>
                    <td>${exam.startDate || 'N/A'}</td>
                    <td>${exam.endDate || 'N/A'}</td>
                    <td>${classNames}</td>
                    <td><span class="status-badge ${exam.status === 'Active' ? 'status-active' : 'status-inactive'}">${exam.status || 'Inactive'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-exam" data-id="${exam.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-exam" data-id="${exam.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
            document.querySelectorAll('.edit-exam').forEach(btn => btn.onclick = () => editExam(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-exam').forEach(btn => btn.onclick = () => deleteExam(parseInt(btn.dataset.id)));
            populateExamDropdowns();
        }
        async function loadBooks() {
            const books = await getAllRecords(db.transaction(['books'], 'readonly').objectStore('books'));
            const tbody = document.getElementById('books-table-body');
            tbody.innerHTML = '';
            books.forEach(book => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.title || 'N/A'}</td>
                    <td>${book.author || 'N/A'}</td>
                    <td>${book.subject || 'N/A'}</td>
                    <td>${book.publisher || 'N/A'}</td>
                    <td>${book.availableCopies || 0}</td>
                    <td>${book.copies || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-book" data-id="${book.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-book" data-id="${book.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-book').forEach(btn => btn.onclick = () => editBook(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-book').forEach(btn => btn.onclick = () => deleteBook(parseInt(btn.dataset.id)));
            populateBookDropdowns();
        }
        async function loadIssuedBooks() {
            const issues = await getAllRecords(db.transaction(['bookIssues'], 'readonly').objectStore('bookIssues'));
            const books = await getAllRecords(db.transaction(['books'], 'readonly').objectStore('books'));
            const students = await getAllRecords(db.transaction(['students'], 'readonly').objectStore('students'));
            const tbody = document.getElementById('issued-books-table-body');
            tbody.innerHTML = '';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            issues.forEach(issue => {
                const book = books.find(b => b.id === issue.bookId);
                const student = students.find(s => s.id === issue.studentId);
                const dueDate = new Date(issue.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                let status = issue.status || 'Issued';
                if (status === 'Issued' && dueDate < today) {
                    status = 'Overdue';
                }
                const statusClass = status === 'Returned' ? 'status-success' : (status === 'Overdue' ? 'status-danger' : 'status-warning');
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${issue.id}</td>
                    <td>${book ? book.title : 'Unknown Book'}</td>
                    <td>${student ? `${student.firstName} ${student.lastName}` : 'Unknown Student'}</td>
                    <td>${issue.issueDate || 'N/A'}</td>
                    <td>${issue.dueDate || 'N/A'}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${status !== 'Returned' ? `<button class="btn btn-sm btn-success mark-returned" data-id="${issue.id}">
                                <i class="fas fa-undo"></i> Return
                            </button>` : ''}
                            <button class="btn btn-sm btn-danger delete-issue" data-id="${issue.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.mark-returned').forEach(btn => btn.onclick = () => markBookReturned(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-issue').forEach(btn => btn.onclick = () => deleteBookIssue(parseInt(btn.dataset.id)));
            populateIssuedBookDropdowns();
        }
        async function loadHifzRecords() {
            const records = await getAllRecords(db.transaction(['hifzRecords'], 'readonly').objectStore('hifzRecords'));
            const students = await getAllRecords(db.transaction(['students'], 'readonly').objectStore('students'));
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            const tbody = document.getElementById('hifz-records-table-body');
            tbody.innerHTML = '';
            records.forEach(record => {
                const student = students.find(s => s.id == record.studentId);
                const teacher = teachers.find(t => t.id == record.teacherId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.date || 'N/A'}</td>
                    <td>${student ? `${student.firstName} ${student.lastName}` : 'N/A'}</td>
                    <td>${record.surah || 'N/A'}</td>
                    <td>${record.fromAyah || 'N/A'}</td>
                    <td>${record.toAyah || 'N/A'}</td>
                    <td><span class="badge badge-primary">${record.status || 'N/A'}</span></td>
                    <td>${teacher ? `${teacher.firstName} ${teacher.lastName}` : 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-hifz" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-hifz" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-hifz').forEach(btn => btn.onclick = () => editHifzRecord(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-hifz').forEach(btn => btn.onclick = () => deleteHifzRecord(parseInt(btn.dataset.id)));
        }
        async function loadSabaqRecords() {
            const records = await getAllRecords(db.transaction(['sabaqRecords'], 'readonly').objectStore('sabaqRecords'));
            const students = await getAllRecords(db.transaction(['students'], 'readonly').objectStore('students'));
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            const tbody = document.getElementById('sabaq-records-table-body');
            tbody.innerHTML = '';
            records.forEach(record => {
                const student = students.find(s => s.id == record.studentId);
                const teacher = teachers.find(t => t.id == record.teacherId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.date || 'N/A'}</td>
                    <td>${student ? `${student.firstName} ${student.lastName}` : 'N/A'}</td>
                    <td>${record.sabaqNew || 'N/A'}</td>
                    <td>${record.sabaqRecent || 'N/A'}</td>
                    <td>${record.sabaqOld || 'N/A'}</td>
                    <td>${teacher ? `${teacher.firstName} ${teacher.lastName}` : 'N/A'}</td>
                    <td>
                         <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-sabaq" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger delete-sabaq" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-sabaq').forEach(btn => btn.onclick = () => editSabaqRecord(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-sabaq').forEach(btn => btn.onclick = () => deleteSabaqRecord(parseInt(btn.dataset.id)));
        }
        async function loadExpenses() {
            const expenses = await getAllRecords(db.transaction(['expenses'], 'readonly').objectStore('expenses'));
            const tbody = document.getElementById('expenses-table-body');
            tbody.innerHTML = '';
            expenses.forEach(expense => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${expense.id}</td>
                    <td>${expense.date || 'N/A'}</td>
                    <td>${expense.category || 'N/A'}</td>
                    <td>$${(expense.amount || 0).toFixed(2)}</td>
                    <td>${expense.paymentMethod || 'N/A'}</td>
                    <td>${expense.description || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-expense" data-id="${expense.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-expense" data-id="${expense.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-expense').forEach(btn => btn.onclick = () => editExpense(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-expense').forEach(btn => btn.onclick = () => deleteExpense(parseInt(btn.dataset.id)));
        }
        async function loadIncome() {
            const incomes = await getAllRecords(db.transaction(['income'], 'readonly').objectStore('income'));
            const tbody = document.getElementById('income-table-body');
            tbody.innerHTML = '';
            incomes.forEach(income => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${income.id}</td>
                    <td>${income.date || 'N/A'}</td>
                    <td>${income.category || 'N/A'}</td>
                    <td>$${(income.amount || 0).toFixed(2)}</td>
                    <td>${income.paymentMethod || 'N/A'}</td>
                    <td>${income.description || 'N/A'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary edit-income" data-id="${income.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-income" data-id="${income.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.edit-income').forEach(btn => btn.onclick = () => editIncome(parseInt(btn.dataset.id)));
            document.querySelectorAll('.delete-income').forEach(btn => btn.onclick = () => deleteIncome(parseInt(btn.dataset.id)));
        }
        async function loadSalaryStructure() {
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            const staff = await getAllRecords(db.transaction(['staff'], 'readonly').objectStore('staff'));
            const employees = [
                ...teachers.map(t => ({ id: t.id, firstName: t.firstName, lastName: t.lastName, type: 'Teacher', designation: 'Teacher', salary: t.salary })),
                ...staff.map(s => ({ id: s.id, firstName: s.firstName, lastName: s.lastName, type: 'Staff', designation: s.role, salary: s.salary }))
            ];
            const tbody = document.getElementById('salary-structure-table-body');
            tbody.innerHTML = '';
            if (employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No employees found.</td></tr>';
                return;
            }
            employees.forEach(emp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.firstName} ${emp.lastName}</td>
                    <td>${emp.designation || 'N/A'}</td>
                    <td>$${(emp.salary || 0).toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary edit-employee-salary" data-id="${emp.id}" data-type="${emp.type}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        async function loadSettings() {
            const settingsStore = db.transaction(['settings'], 'readonly').objectStore('settings');
            const allSettings = await getAllRecords(settingsStore);
            const getSetting = (key) => allSettings.find(s => s.key === key)?.value;
            const institutionSettings = getSetting('institution') || {};
            document.getElementById('institution-name').value = institutionSettings.name || '';
            document.getElementById('institution-phone').value = institutionSettings.phone || '';
            document.getElementById('institution-email').value = institutionSettings.email || '';
            document.getElementById('institution-address').value = institutionSettings.address || '';
            const logoPreview = document.getElementById('logo-preview');
            if (institutionSettings.logo) {
                logoPreview.innerHTML = `<img src="${institutionSettings.logo}" alt="Logo Preview" style="max-width: 150px; border: 1px solid #ddd; padding: 5px;">`;
            } else {
                logoPreview.innerHTML = '';
            }
            const academicSettings = getSetting('academic') || {};
            document.getElementById('academic-year').value = academicSettings.year || new Date().getFullYear().toString();
            document.getElementById('academic-session').value = academicSettings.session || 'Morning';
            document.getElementById('academic-start-date').value = academicSettings.startDate || '';
            document.getElementById('academic-end-date').value = academicSettings.endDate || '';
            const weekendsSelect = document.getElementById('weekends');
            Array.from(weekendsSelect.options).forEach(option => option.selected = false);
            if (academicSettings.weekends) {
                academicSettings.weekends.forEach(day => {
                    const option = Array.from(weekendsSelect.options).find(opt => opt.value === day);
                    if (option) option.selected = true;
                });
            }
            const feeSettings = getSetting('fee') || {};
            document.getElementById('fee-currency').value = feeSettings.currency || '₨';
            document.getElementById('fee-fine-rate').value = feeSettings.fineRate || 0;
            const paymentMethodsSelect = document.getElementById('fee-payment-methods');
            Array.from(paymentMethodsSelect.options).forEach(option => option.selected = false);
            if (feeSettings.paymentMethods) {
                feeSettings.paymentMethods.forEach(method => {
                    const option = Array.from(paymentMethodsSelect.options).find(opt => opt.value === method);
                    if (option) option.selected = true;
                });
            }
            const systemSettings = getSetting('system') || {};
            document.getElementById('system-language').value = systemSettings.language || 'en';
            document.getElementById('system-theme').value = systemSettings.theme || 'light';
            document.getElementById('system-timezone').value = systemSettings.timezone || 'GMT+5';
        }
        async function populateDropdown(dropdownIds, storeName, displayKey, valueKey = 'id', multiEntry = false, includeAllOption = true) {
            const records = await getAllRecords(db.transaction([storeName], 'readonly').objectStore(storeName));
            dropdownIds.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const currentValues = multiEntry ? Array.from(dropdown.selectedOptions).map(opt => opt.value) : dropdown.value;
                    dropdown.innerHTML = '';
                    if (includeAllOption && !multiEntry) {
                        const allOption = document.createElement('option');
                        allOption.value = "";
                        allOption.textContent = "Select " + displayKey.split(/([A-Z])/).join(' ').trim().replace(/^./, str => str.toUpperCase());
                        if (dropdownId.includes('report-') || dropdownId.includes('filter-')) {
                            allOption.textContent = "All " + displayKey.split(/([A-Z])/).join(' ').trim().replace(/^./, str => str.toUpperCase()) + "s";
                        }
                        dropdown.appendChild(allOption);
                    }
                    records.forEach(record => {
                        const option = document.createElement('option');
                        option.value = record[valueKey];
                        option.textContent = record[displayKey];
                        if (displayKey === 'firstName' && record.lastName) {
                            option.textContent = `${record.firstName} ${record.lastName}`;
                        }
                        if (displayKey === 'title' && record.author) {
                            option.textContent = `${record.title} by ${record.author}`;
                        }
                        dropdown.appendChild(option);
                    });
                    if (multiEntry) {
                        Array.from(dropdown.options).forEach(option => {
                            if (currentValues.includes(option.value)) {
                                option.selected = true;
                            }
                        });
                    } else if (currentValues && Array.from(dropdown.options).some(opt => opt.value == currentValues)) {
                        dropdown.value = currentValues;
                    }
                }
            });
        }
        async function populateClassDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = [
                    'student-class', 'attendance-class', 'report-class-academic',
                    'marks-class', 'rc-class', 'fee-class', 'fr-class-finance',
                    'df-class', 'assign-class', 'hifz-class', 'sabaq-class',
                    'sr-class', 'ar-class-reports', 'mr-class', 'fr-class-reports', 'mr-class-reports',
                    'exam-classes'
                ];
            }
            await populateDropdown(ids, 'classes', 'name', 'id', ids.includes('exam-classes'));
        }
        async function populateSubjectDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = ['teacher-subjects', 'marks-subject', 'subject-teacher'];
            }
            await populateDropdown(ids, 'subjects', 'name', 'id', ids.includes('teacher-subjects'), !ids.includes('teacher-subjects'));
        }
        async function populateTeacherDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = ['class-teacher', 'subject-teacher', 'hifz-teacher', 'sabaq-teacher', 'hifz-teacher-record', 'sabaq-teacher-record'];
            }
            await populateDropdown(ids, 'teachers', 'firstName', 'id');
        }
        async function populateStudentDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = ['fee-student', 'hifz-student', 'sabaq-student', 'rc-student', 'certificate-student', 'issue-student', 'return-student', 'report-student-academic', 'mr-student', 'mr-student-reports'];
            }
            await populateDropdown(ids, 'students', 'firstName', 'id');
        }
        async function populateFeeTypeDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = ['assign-fee-type', 'fr-fee-type-finance', 'df-fee-type'];
            }
            await populateDropdown(ids, 'feeTypes', 'name', 'id');
        }
        async function populateExamDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = ['marks-exam', 'rc-exam'];
            }
            await populateDropdown(ids, 'exams', 'name', 'id');
        }
        async function populateBookDropdowns(ids = []) {
            if (ids.length === 0) {
                ids = ['issue-book'];
            }
            await populateDropdown(ids, 'books', 'title', 'id');
        }
        async function populateIssuedBookDropdowns(ids = ['return-book']) {
            const issuedBooks = await getAllRecords(db.transaction(['bookIssues'], 'readonly').objectStore('bookIssues'));
            const allBooks = await getAllRecords(db.transaction(['books'], 'readonly').objectStore('books'));
            const validIssuedBooks = issuedBooks.filter(issue => issue.status === 'Issued');
            ids.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    dropdown.innerHTML = '<option value="">Select Issued Book</option>';
                    validIssuedBooks.forEach(issue => {
                        const book = allBooks.find(b => b.id === issue.bookId);
                        if (book) {
                            const option = document.createElement('option');
                            option.value = issue.id;
                            option.textContent = `${book.title} (Issue ID: ${issue.id})`;
                            dropdown.appendChild(option);
                        }
                    });
                }
            });
        }
        async function populateEmployeeDropdowns(ids = []) {
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            const staff = await getAllRecords(db.transaction(['staff'], 'readonly').objectStore('staff'));
            const employees = [
                ...teachers.map(t => ({ id: `T-${t.id}`, name: `${t.firstName} ${t.lastName} (Teacher)` })),
                ...staff.map(s => ({ id: `S-${s.id}`, name: `${s.firstName} ${s.lastName} (${s.role})` }))
            ];
            ids.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">All Employees</option>';
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.name;
                        dropdown.appendChild(option);
                    });
                    if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }
        function populateYearDropdowns(ids = []) {
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 10;
            const endYear = currentYear + 5;
            if (ids.length === 0) {
                ids = ['report-year-academic', 'fr-year-finance', 'sr-year', 'ar-year-reports', 'salary-year', 'fr-start-date-reports', 'fr-end-date-reports', 'lr-start-date', 'lr-end-date', 'lr-start-date-reports', 'lr-end-date-reports', 'mr-start-date', 'mr-end-date', 'mr-start-date-reports', 'mr-end-date-reports'];
            }
            ids.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    const isDateInput = dropdown.type === 'date';
                    if (!isDateInput) {
                        dropdown.innerHTML = '<option value="">All Years</option>';
                        for (let year = startYear; year <= endYear; year++) {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            if (year === currentYear && !currentValue) {
                                option.selected = true;
                            }
                            dropdown.appendChild(option);
                        }
                        if (currentValue && Array.from(dropdown.options).some(opt => opt.value == currentValue)) {
                            dropdown.value = currentValue;
                        }
                    }
                }
            });
        }
        async function populateSectionDropdown(classDropdown) {
            const selectedClassId = classDropdown.value;
            const targetSectionSelect = classDropdown.closest('form').querySelector('[id$="-section"]');
            if (!targetSectionSelect) {
                console.warn("Target section dropdown not found for class dropdown:", classDropdown.id);
                return;
            }
            targetSectionSelect.innerHTML = '<option value="">Select Section</option>';
            if (!selectedClassId) {
                return;
            }
            try {
                const cls = await getRecord(db.transaction(['classes'], 'readonly').objectStore('classes'), parseInt(selectedClassId));
                if (cls && cls.sections && Array.isArray(cls.sections)) {
                    cls.sections.forEach(section => {
                        const option = document.createElement('option');
                        option.value = section;
                        option.textContent = section;
                        targetSectionSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error fetching class sections:", error);
            }
        }
        function populateSurahDropdowns(ids = []) {
            ids.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select Surah</option>';
                    surahs.forEach((surah, index) => {
                        const option = document.createElement('option');
                        option.value = surah;
                        option.textContent = `${index + 1}. ${surah}`;
                        dropdown.appendChild(option);
                    });
                    if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }
        function populateStaticDropdowns(ids = []) {
            ids.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">All Categories</option>';
                    let categories = [];
                    if (id.includes('expense-category') || id.includes('fr-category-finance') || id.includes('fr-category-reports')) {
                        categories = ["Salaries", "Utilities", "Maintenance", "Stationery", "Rent", "Other"];
                    } else if (id.includes('income-category')) {
                        categories = ["Fees", "Donation", "Grant", "Fundraising", "Other"];
                    }
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        dropdown.appendChild(option);
                    });
                    if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }
        async function saveRecord(storeName, data, id = null, callback) {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            let request;
            let action = id ? 'updated' : 'added';
            if (id) {
                data.id = id;
                request = store.put(data);
            } else {
                request = store.add(data);
            }
            request.onsuccess = function () {
                console.log(`${storeName} record ${action} successfully`);
                const activityTitle = `${storeName.slice(0, -1).charAt(0).toUpperCase() + storeName.slice(0, -1).slice(1)} ${action}`;
                const activityDesc = id ?
                    `${storeName.slice(0, -1)} with ID ${id} was updated` :
                    `New ${storeName.slice(0, -1)} was added`;
                addActivity(storeName.slice(0, -1), activityTitle, activityDesc);
                if (callback) callback();
            };
            request.onerror = function (event) {
                console.error(`Error ${action} ${storeName.slice(0, -1)}:`, event.target.error);
                alert(`Error ${action} ${storeName.slice(0, -1)}. Please try again. ${event.target.error.message}`);
            };
        }
        async function deleteRecord(storeName, id, callback) {
            if (confirm(`Are you sure you want to delete this ${storeName.slice(0, -1)}?`)) {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                request.onsuccess = function () {
                    console.log(`${storeName} record deleted successfully`);
                    addActivity(storeName.slice(0, -1), `${storeName.slice(0, -1)} Deleted`, `${storeName.slice(0, -1)} with ID ${id} was deleted`);
                    if (callback) callback();
                };
                request.onerror = function (event) {
                    console.error(`Error deleting ${storeName.slice(0, -1)}:`, event.target.error);
                    alert(`Error deleting ${storeName.slice(0, -1)}. Please try again.`);
                };
            }
        }
        async function editStudent(id) {
            const student = await getRecord(db.transaction('students', 'readonly').objectStore('students'), id);
            if (student) {
                document.getElementById('student-form').setAttribute('data-id', id);
                document.getElementById('student-first-name').value = student.firstName;
                document.getElementById('student-last-name').value = student.lastName;
                document.getElementById('student-gender').value = student.gender;
                document.getElementById('student-dob').value = student.dob;
                document.getElementById('student-class').value = student.classId;
                await populateSectionDropdown(document.getElementById('student-class'));
                document.getElementById('student-section').value = student.section;
                document.getElementById('student-admission-date').value = student.admissionDate;
                document.getElementById('student-admission-number').value = student.admissionNumber;
                document.getElementById('student-address').value = student.address;
                document.getElementById('student-father-name').value = student.fatherName;
                document.getElementById('student-father-phone').value = student.fatherPhone;
                document.getElementById('student-mother-name').value = student.motherName;
                document.getElementById('student-mother-phone').value = student.motherPhone;
                document.querySelector('#student-modal .modal-title').textContent = 'Edit Student';
                showModal('student-modal');
            }
        }
        async function editTeacher(id) {
            const teacher = await getRecord(db.transaction('teachers', 'readonly').objectStore('teachers'), id);
            if (teacher) {
                document.getElementById('teacher-form').setAttribute('data-id', id);
                document.getElementById('teacher-first-name').value = teacher.firstName;
                document.getElementById('teacher-last-name').value = teacher.lastName;
                document.getElementById('teacher-gender').value = teacher.gender;
                document.getElementById('teacher-dob').value = teacher.dob;
                document.getElementById('teacher-email').value = teacher.email;
                document.getElementById('teacher-phone').value = teacher.phone;
                document.getElementById('teacher-qualification').value = teacher.qualification;
                const subjectSelect = document.getElementById('teacher-subjects');
                Array.from(subjectSelect.options).forEach(opt => opt.selected = false);
                if (teacher.subjects) {
                    teacher.subjects.forEach(subId => {
                        const opt = Array.from(subjectSelect.options).find(o => o.value == subId);
                        if (opt) opt.selected = true;
                    });
                }
                document.getElementById('teacher-joining-date').value = teacher.joiningDate;
                document.getElementById('teacher-salary').value = teacher.salary;
                document.getElementById('teacher-address').value = teacher.address;
                document.querySelector('#teacher-modal .modal-title').textContent = 'Edit Teacher';
                showModal('teacher-modal');
            }
        }
        async function editStaff(id) {
            const staff = await getRecord(db.transaction('staff', 'readonly').objectStore('staff'), id);
            if (staff) {
                document.getElementById('staff-form').setAttribute('data-id', id);
                document.getElementById('staff-first-name').value = staff.firstName;
                document.getElementById('staff-last-name').value = staff.lastName;
                document.getElementById('staff-gender').value = staff.gender;
                document.getElementById('staff-dob').value = staff.dob;
                document.getElementById('staff-email').value = staff.email;
                document.getElementById('staff-phone').value = staff.phone;
                document.getElementById('staff-role').value = staff.role;
                document.getElementById('staff-joining-date').value = staff.joiningDate;
                document.getElementById('staff-salary').value = staff.salary;
                document.getElementById('staff-status').value = staff.status;
                document.getElementById('staff-address').value = staff.address;
                document.querySelector('#staff-modal .modal-title').textContent = 'Edit Staff';
                showModal('staff-modal');
            }
        }
        async function editClass(id) {
            const cls = await getRecord(db.transaction('classes', 'readonly').objectStore('classes'), id);
            if (cls) {
                document.getElementById('class-form').setAttribute('data-id', id);
                document.getElementById('class-name').value = cls.name;
                document.getElementById('class-numeric-value').value = cls.numericValue;
                document.getElementById('class-sections').value = cls.sections ? cls.sections.join(',') : '';
                document.getElementById('class-teacher').value = cls.classTeacher;
                document.querySelector('#class-modal .modal-title').textContent = 'Edit Class';
                showModal('class-modal');
            }
        }
        async function editSubject(id) {
            const subject = await getRecord(db.transaction('subjects', 'readonly').objectStore('subjects'), id);
            if (subject) {
                document.getElementById('subject-form').setAttribute('data-id', id);
                document.getElementById('subject-name').value = subject.name;
                document.getElementById('subject-code').value = subject.code;
                document.getElementById('subject-type').value = subject.type;
                document.getElementById('subject-teacher').value = subject.teacher;
                document.getElementById('subject-description').value = subject.description;
                document.querySelector('#subject-modal .modal-title').textContent = 'Edit Subject';
                showModal('subject-modal');
            }
        }
        async function editFeeType(id) {
            const feeType = await getRecord(db.transaction('feeTypes', 'readonly').objectStore('feeTypes'), id);
            if (feeType) {
                document.getElementById('fee-type-form').setAttribute('data-id', id);
                document.getElementById('fee-type-name').value = feeType.name;
                document.getElementById('fee-type-code').value = feeType.code;
                document.getElementById('fee-type-amount').value = feeType.amount;
                document.getElementById('fee-type-frequency').value = feeType.frequency;
                document.getElementById('fee-type-description').value = feeType.description;
                document.querySelector('#fee-type-modal .modal-title').textContent = 'Edit Fee Type';
                showModal('fee-type-modal');
            }
        }
        async function editExam(id) {
            const exam = await getRecord(db.transaction('exams', 'readonly').objectStore('exams'), id);
            if (exam) {
                document.getElementById('exam-form').setAttribute('data-id', id);
                document.getElementById('exam-name').value = exam.name;
                document.getElementById('exam-type').value = exam.type;
                document.getElementById('exam-start-date').value = exam.startDate;
                document.getElementById('exam-end-date').value = exam.endDate;
                const classSelect = document.getElementById('exam-classes');
                Array.from(classSelect.options).forEach(opt => opt.selected = false);
                if (exam.classes) {
                    exam.classes.forEach(classId => {
                        const opt = Array.from(classSelect.options).find(o => o.value == classId);
                        if (opt) opt.selected = true;
                    });
                }
                document.getElementById('exam-description').value = exam.description;
                document.querySelector('#exam-modal .modal-title').textContent = 'Edit Exam';
                showModal('exam-modal');
            }
        }
        async function deleteExam(id) {
            if (confirm('Are you sure you want to delete this exam? This will also delete all associated exam marks.')) {
                const transaction = db.transaction(['exams', 'examMarks'], 'readwrite');
                const examStore = transaction.objectStore('exams');
                const marksStore = transaction.objectStore('examMarks');
                try {
                    await new Promise((resolve, reject) => {
                        const req = examStore.delete(id);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                    const marksForExam = await new Promise((resolve, reject) => {
                        const index = marksStore.index('examId');
                        const req = index.getAll(id);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = reject;
                    });
                    for (const mark of marksForExam) {
                        await new Promise((resolve, reject) => {
                            const req = marksStore.delete(mark.id);
                            req.onsuccess = resolve;
                            req.onerror = reject;
                        });
                    }
                    transaction.oncomplete = function () {
                        console.log("Exam and associated marks deleted successfully");
                        loadExams();
                        addActivity('exam', 'Exam Deleted', `Exam with ID ${id} was deleted`);
                    };
                    transaction.onerror = function (event) {
                        console.error("Error deleting exam:", event.target.error);
                        alert(`Error deleting exam. Please try again. ${event.target.error.message}`);
                    };
                } catch (error) {
                    console.error("Error during exam deletion transaction:", error);
                    alert("Error deleting exam and associated marks.");
                }
            }
        }
        async function editBook(id) {
            const book = await getRecord(db.transaction('books', 'readonly').objectStore('books'), id);
            if (book) {
                document.getElementById('book-form').setAttribute('data-id', id);
                document.getElementById('book-title').value = book.title;
                document.getElementById('book-author').value = book.author;
                document.getElementById('book-subject').value = book.subject;
                document.getElementById('book-publisher').value = book.publisher;
                document.getElementById('book-isbn').value = book.isbn;
                document.getElementById('book-edition').value = book.edition;
                document.getElementById('book-copies').value = book.copies;
                document.getElementById('book-price').value = book.price;
                document.getElementById('book-description').value = book.description;
                document.querySelector('#book-modal .modal-title').textContent = 'Edit Book';
                showModal('book-modal');
            }
        }
        async function deleteBook(id) {
            if (confirm('Are you sure you want to delete this book? This will also delete all associated issue records.')) {
                const transaction = db.transaction(['books', 'bookIssues'], 'readwrite');
                const bookStore = transaction.objectStore('books');
                const bookIssuesStore = transaction.objectStore('bookIssues');
                try {
                    await new Promise((resolve, reject) => {
                        const req = bookStore.delete(id);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                    const issuesForBook = await new Promise((resolve, reject) => {
                        const index = bookIssuesStore.index('bookId');
                        const req = index.getAll(id);
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = reject;
                    });
                    for (const issue of issuesForBook) {
                        await new Promise((resolve, reject) => {
                            const req = bookIssuesStore.delete(issue.id);
                            req.onsuccess = resolve;
                            req.onerror = reject;
                        });
                    }
                    transaction.oncomplete = function () {
                        console.log("Book and associated issues deleted successfully");
                        loadBooks();
                        addActivity('library', 'Book Deleted', `Book with ID ${id} was deleted`);
                    };
                    transaction.onerror = function (event) {
                        console.error("Error deleting book:", event.target.error);
                        alert(`Error deleting book. Please try again. ${event.target.error.message}`);
                    };
                } catch (error) {
                    console.error("Error during book deletion transaction:", error);
                    alert("Error deleting book and associated issues.");
                }
            }
        }
        async function editHifzRecord(id) {
            const record = await getRecord(db.transaction('hifzRecords', 'readonly').objectStore('hifzRecords'), id);
            if (record) {
                document.getElementById('hifz-form').setAttribute('data-id', id);
                document.getElementById('hifz-record-student').value = record.studentId;
                document.getElementById('hifz-record-date').value = record.date;
                document.getElementById('hifz-surah').value = record.surah;
                document.getElementById('hifz-teacher-record').value = record.teacherId;
                document.getElementById('hifz-from-ayah').value = record.fromAyah;
                document.getElementById('hifz-to-ayah').value = record.toAyah;
                document.getElementById('hifz-status').value = record.status;
                document.getElementById('hifz-remarks').value = record.remarks;
                document.querySelector('#hifz-modal .modal-title').textContent = 'Edit Hifz Record';
                showModal('hifz-modal');
            }
        }
        async function deleteHifzRecord(id) {
            await deleteRecord('hifzRecords', id, loadHifzRecords);
        }
        async function editSabaqRecord(id) {
            const record = await getRecord(db.transaction('sabaqRecords', 'readonly').objectStore('sabaqRecords'), id);
            if (record) {
                document.getElementById('sabaq-form').setAttribute('data-id', id);
                document.getElementById('sabaq-record-student').value = record.studentId;
                document.getElementById('sabaq-record-date').value = record.date;
                document.getElementById('sabaq-teacher-record').value = record.teacherId;
                document.getElementById('sabaq-status').value = record.status;
                document.getElementById('sabaq-new').value = record.sabaqNew;
                document.getElementById('sabaq-recent').value = record.sabaqRecent;
                document.getElementById('sabaq-old').value = record.sabaqOld;
                document.getElementById('sabaq-remarks').value = record.remarks;
                document.querySelector('#sabaq-modal .modal-title').textContent = 'Edit Sabaq Record';
                showModal('sabaq-modal');
            }
        }
        async function deleteSabaqRecord(id) {
            await deleteRecord('sabaqRecords', id, loadSabaqRecords);
        }
        async function editExpense(id) {
            const expense = await getRecord(db.transaction('expenses', 'readonly').objectStore('expenses'), id);
            if (expense) {
                document.getElementById('expense-form').setAttribute('data-id', id);
                document.getElementById('expense-date').value = expense.date;
                document.getElementById('expense-category').value = expense.category;
                document.getElementById('expense-amount').value = expense.amount;
                document.getElementById('expense-payment-method').value = expense.paymentMethod;
                document.getElementById('expense-description').value = expense.description;
                document.getElementById('expense-attachment').value = '';
                document.querySelector('#expense-modal .modal-title').textContent = 'Edit Expense';
                showModal('expense-modal');
            }
        }
        async function deleteExpense(id) {
            await deleteRecord('expenses', id, loadExpenses);
        }
        async function editIncome(id) {
            const income = await getRecord(db.transaction('income', 'readonly').objectStore('income'), id);
            if (income) {
                document.getElementById('income-form').setAttribute('data-id', id);
                document.getElementById('income-date').value = income.date;
                document.getElementById('income-category').value = income.category;
                document.getElementById('income-amount').value = income.amount;
                document.getElementById('income-payment-method').value = income.paymentMethod;
                document.getElementById('income-description').value = income.description;
                document.getElementById('income-attachment').value = '';
                document.querySelector('#income-modal .modal-title').textContent = 'Edit Income';
                showModal('income-modal');
            }
        }
        async function deleteIncome(id) {
            await deleteRecord('income', id, loadIncome);
        }
        async function markBookReturned(issueId) {
            if (confirm('Mark this book as returned?')) {
                const transaction = db.transaction(['bookIssues', 'books'], 'readwrite');
                const issuesStore = transaction.objectStore('bookIssues');
                const booksStore = transaction.objectStore('books');
                try {
                    const issue = await getRecord(issuesStore, issueId);
                    if (!issue || issue.status === 'Returned') {
                        alert('Issue record not found or already returned.');
                        return;
                    }
                    issue.status = 'Returned';
                    issue.returnDate = new Date().toISOString().split('T')[0];
                    const dueDate = new Date(issue.dueDate);
                    const returnDate = new Date(issue.returnDate);
                    let fine = 0;
                    if (returnDate > dueDate) {
                        const diffTime = Math.abs(returnDate - dueDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const feeSettings = (await getRecord(db.transaction('settings', 'readonly').objectStore('settings'), 'fee'))?.value || {};
                        const fineRate = feeSettings.fineRate || 0.1;
                        fine = diffDays * fineRate;
                        alert(`Book returned late! Fine calculated: $${fine.toFixed(2)}`);
                    }
                    issue.fine = fine;
                    await issuesStore.put(issue);
                    const book = await getRecord(booksStore, issue.bookId);
                    if (book) {
                        book.availableCopies = (book.availableCopies || 0) + 1;
                        await booksStore.put(book);
                    }
                    transaction.oncomplete = function () {
                        console.log("Book return transaction complete");
                        loadIssuedBooks();
                        loadBooks();
                        addActivity('library', 'Book Returned', `Book with ID ${issue.bookId} returned by student ${issue.studentId}`);
                        alert('Book returned successfully!');
                    };
                    transaction.onerror = function (event) {
                        console.error("Error during book return transaction:", event.target.error);
                        alert("Error marking book as returned. Please try again.");
                    };
                } catch (error) {
                    console.error("Error marking book as returned:", error);
                    alert("Error marking book as returned. Please try again.");
                }
            }
        }
        async function deleteBookIssue(id) {
            if (confirm('Are you sure you want to delete this book issue record? This will NOT affect book inventory.')) {
                await deleteRecord('bookIssues', id, loadIssuedBooks);
            }
        }
        document.getElementById('attendance-filter-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const date = document.getElementById('attendance-date').value;
            const classId = parseInt(document.getElementById('attendance-class').value);
            const section = document.getElementById('attendance-section').value;
            if (!date || !classId || !section) {
                alert('Please select Date, Class, and Section.');
                return;
            }
            const studentStore = db.transaction(['students'], 'readonly').objectStore('students');
            const attendanceStore = db.transaction(['attendance'], 'readonly').objectStore('attendance');
            const studentsInClass = (await getAllRecords(studentStore))
                .filter(s => s.classId === classId && s.section === section);
            const existingAttendance = (await getAllRecords(attendanceStore))
                .filter(a => a.date === date && a.classId === classId && a.section === section);
            const tbody = document.getElementById('attendance-table-body');
            tbody.innerHTML = '';
            if (studentsInClass.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No students found in this class/section.</td></tr>';
                document.getElementById('attendance-table-container').style.display = 'none';
                return;
            }
            studentsInClass.forEach(student => {
                const existingRecord = existingAttendance.find(a => a.studentId === student.id);
                const status = existingRecord ? existingRecord.status : 'Present';
                const remarks = existingRecord ? existingRecord.remarks : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>
                        <select class="form-control attendance-status" data-student-id="${student.id}">
                            <option value="Present" ${status === 'Present' ? 'selected' : ''}>Present</option>
                            <option value="Absent" ${status === 'Absent' ? 'selected' : ''}>Absent</option>
                            <option value="Late" ${status === 'Late' ? 'selected' : ''}>Late</option>
                            <option value="Leave" ${status === 'Leave' ? 'selected' : ''}>Leave</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control attendance-remarks" data-student-id="${student.id}" value="${remarks}"></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('attendance-table-container').style.display = 'block';
        });
        document.getElementById('save-attendance-btn').addEventListener('click', async function () {
            const date = document.getElementById('attendance-date').value;
            const classId = parseInt(document.getElementById('attendance-class').value);
            const section = document.getElementById('attendance-section').value;
            const statusElements = document.querySelectorAll('.attendance-status');
            const remarksElements = document.querySelectorAll('.attendance-remarks');
            if (statusElements.length === 0) {
                alert('No students loaded to save attendance for.');
                return;
            }
            const transaction = db.transaction(['attendance', 'students'], 'readwrite');
            const attendanceStore = transaction.objectStore('attendance');
            const studentStore = transaction.objectStore('students');
            try {
                const existingAttendance = await new Promise((resolve, reject) => {
                    const req = attendanceStore.index('date').getAll(date);
                    req.onsuccess = () => resolve(req.result.filter(a => a.classId === classId && a.section === section));
                    req.onerror = reject;
                });
                for (const record of existingAttendance) {
                    await new Promise((resolve, reject) => {
                        const req = attendanceStore.delete(record.id);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }
                for (let i = 0; i < statusElements.length; i++) {
                    const studentId = parseInt(statusElements[i].dataset.studentId);
                    const status = statusElements[i].value;
                    const remarks = remarksElements[i].value;
                    const student = await getRecord(studentStore, studentId);
                    const attendanceRecord = {
                        studentId: studentId,
                        studentName: student ? `${student.firstName} ${student.lastName}` : 'N/A',
                        classId: classId,
                        section: section,
                        date: date,
                        status: status,
                        remarks: remarks
                    };
                    await attendanceStore.add(attendanceRecord);
                }
                transaction.oncomplete = function () {
                    alert('Attendance saved successfully!');
                    addActivity('attendance', 'Attendance Marked', `Attendance for ${date}, Class ${classId}, Section ${section} saved.`);
                };
                transaction.onerror = function (event) {
                    console.error("Error saving attendance:", event.target.error);
                    alert('Error saving attendance. Please try again.');
                };
            } catch (error) {
                console.error("Error during attendance save transaction:", error);
                alert('Error saving attendance. Please try again.');
            }
        });
        document.getElementById('marks-filter-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const examId = parseInt(document.getElementById('marks-exam').value);
            const classId = parseInt(document.getElementById('marks-class').value);
            const section = document.getElementById('marks-section').value;
            const subjectId = parseInt(document.getElementById('marks-subject').value);
            if (!examId || !classId || !section || !subjectId) {
                alert('Please select Exam, Class, Section, and Subject.');
                return;
            }
            const studentStore = db.transaction(['students'], 'readonly').objectStore('students');
            const examMarksStore = db.transaction(['examMarks'], 'readonly').objectStore('examMarks');
            const studentsInClass = (await getAllRecords(studentStore))
                .filter(s => s.classId === classId && s.section === section);
            const existingMarks = (await getAllRecords(examMarksStore))
                .filter(m => m.examId === examId && m.subjectId === subjectId);
            const tbody = document.getElementById('marks-table-body');
            tbody.innerHTML = '';
            if (studentsInClass.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No students found in this class/section.</td></tr>';
                document.getElementById('marks-table-container').style.display = 'none';
                return;
            }
            studentsInClass.forEach(student => {
                const existingRecord = existingMarks.find(m => m.studentId === student.id);
                const marks = existingRecord ? existingRecord.marks : '';
                const grade = existingRecord ? existingRecord.grade : '';
                const remarks = existingRecord ? existingRecord.remarks : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td><input type="number" class="form-control marks-input" data-student-id="${student.id}" value="${marks}" min="0" max="100"></td>
                    <td><input type="text" class="form-control grade-input" data-student-id="${student.id}" value="${grade}"></td>
                    <td><input type="text" class="form-control marks-remarks" data-student-id="${student.id}" value="${remarks}"></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('marks-table-container').style.display = 'block';
        });
        document.getElementById('save-marks-btn').addEventListener('click', async function () {
            const examId = parseInt(document.getElementById('marks-exam').value);
            const classId = parseInt(document.getElementById('marks-class').value);
            const subjectId = parseInt(document.getElementById('marks-subject').value);
            const marksInputs = document.querySelectorAll('.marks-input');
            const gradeInputs = document.querySelectorAll('.grade-input');
            const remarksInputs = document.querySelectorAll('.marks-remarks');
            if (marksInputs.length === 0) {
                alert('No marks to save.');
                return;
            }
            const transaction = db.transaction(['examMarks', 'students', 'subjects', 'exams'], 'readwrite');
            const examMarksStore = transaction.objectStore('examMarks');
            const studentStore = transaction.objectStore('students');
            const subjectStore = transaction.objectStore('subjects');
            const examStore = transaction.objectStore('exams');
            try {
                const subject = await getRecord(subjectStore, subjectId);
                const exam = await getRecord(examStore, examId);
                const existingMarks = await new Promise((resolve, reject) => {
                    const req = examMarksStore.index('examId').getAll(examId);
                    req.onsuccess = () => resolve(req.result.filter(m => m.subjectId === subjectId && m.classId === classId));
                    req.onerror = reject;
                });
                for (const record of existingMarks) {
                    await new Promise((resolve, reject) => {
                        const req = examMarksStore.delete(record.id);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }
                for (let i = 0; i < marksInputs.length; i++) {
                    const studentId = parseInt(marksInputs[i].dataset.studentId);
                    const marks = parseFloat(marksInputs[i].value);
                    const grade = gradeInputs[i].value;
                    const remarks = remarksInputs[i].value;
                    const student = await getRecord(studentStore, studentId);
                    const markRecord = {
                        examId: examId,
                        examName: exam ? exam.name : 'N/A',
                        studentId: studentId,
                        studentName: student ? `${student.firstName} ${student.lastName}` : 'N/A',
                        classId: classId,
                        subjectId: subjectId,
                        subjectName: subject ? subject.name : 'N/A',
                        marks: marks,
                        grade: grade,
                        remarks: remarks
                    };
                    await examMarksStore.add(markRecord);
                }
                transaction.oncomplete = function () {
                    alert('Marks saved successfully!');
                    addActivity('exam', 'Marks Entered', `Marks for ${exam ? exam.name : 'N/A'}, ${subject ? subject.name : 'N/A'} saved.`);
                };
                transaction.onerror = function (event) {
                    console.error("Error saving marks:", event.target.error);
                    alert('Error saving marks. Please try again.');
                };
            } catch (error) {
                console.error("Error during marks save transaction:", error);
                alert('Error saving marks. Please try again.');
            }
        });
        document.getElementById('report-card-filter-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const examId = parseInt(document.getElementById('rc-exam').value);
            const classId = parseInt(document.getElementById('rc-class').value);
            const section = document.getElementById('rc-section').value;
            const studentId = document.getElementById('rc-student').value ? parseInt(document.getElementById('rc-student').value) : null;
            if (!examId || !classId || !section) {
                alert('Please select Exam, Class, and Section.');
                return;
            }
            const container = document.getElementById('report-cards-container');
            container.innerHTML = '<p class="text-center">Generating report cards...</p>';
            container.style.display = 'block';
            document.getElementById('print-report-cards-btn').disabled = true;
            const studentsStore = db.transaction(['students'], 'readonly').objectStore('students');
            const examMarksStore = db.transaction(['examMarks'], 'readonly').objectStore('examMarks');
            const subjectsStore = db.transaction(['subjects'], 'readonly').objectStore('subjects');
            const examStore = db.transaction(['exams'], 'readonly').objectStore('exams');
            const classStore = db.transaction(['classes'], 'readonly').objectStore('classes');
            try {
                const exam = await getRecord(examStore, examId);
                const selectedClass = await getRecord(classStore, classId);
                const allSubjects = await getAllRecords(subjectsStore);
                const allMarks = await getAllRecords(examMarksStore);
                let studentsToReport = (await getAllRecords(studentsStore))
                    .filter(s => s.classId === classId && s.section === section);
                if (studentId) {
                    studentsToReport = studentsToReport.filter(s => s.id === studentId);
                }
                if (studentsToReport.length === 0) {
                    container.innerHTML = '<p class="text-center">No students found for these criteria.</p>';
                    return;
                }
                let reportCardsHtml = '';
                for (const student of studentsToReport) {
                    const studentMarks = allMarks.filter(m => m.studentId === student.id && m.examId === examId);
                    let totalMarksObtained = 0;
                    let totalMaxMarks = 0;
                    let subjectMarksHtml = '';
                    allSubjects.forEach(subject => {
                        const marks = studentMarks.find(m => m.subjectId === subject.id);
                        const obtained = marks ? marks.marks : 'N/A';
                        const grade = marks ? marks.grade : 'N/A';
                        const remarks = marks ? marks.remarks : '';
                        if (typeof obtained === 'number') {
                            totalMarksObtained += obtained;
                            totalMaxMarks += 100;
                        }
                        subjectMarksHtml += `
                            <tr>
                                <td>${subject.name}</td>
                                <td>100</td>
                                <td>${obtained}</td>
                                <td>${grade}</td>
                                <td>${remarks}</td>
                            </tr>
                        `;
                    });
                    const percentage = totalMaxMarks > 0 ? ((totalMarksObtained / totalMaxMarks) * 100).toFixed(2) : '0.00';
                    const overallGrade = getOverallGrade(parseFloat(percentage));
                    reportCardsHtml += `
                        <div class="card mb-20" style="page-break-after: always; width: 700px; margin: 20px auto; border: 1px solid #ccc; box-shadow: none;">
                            <div class="card-header text-center" style="background-color: var(--primary-color); color: white;">
                                <h4 class="card-title">${exam ? exam.name : 'Exam'} Report Card</h4>
                            </div>
                            <div class="card-body">
                                <p><strong>Student Name:</strong> ${student.firstName} ${student.lastName}</p>
                                <p><strong>Admission No.:</strong> ${student.admissionNumber}</p>
                                <p><strong>Class & Section:</strong> ${selectedClass ? selectedClass.name : 'N/A'} - ${student.section}</p>
                                <p><strong>Father's Name:</strong> ${student.fatherName}</p>
                                <hr>
                                <h4>Subject-wise Performance</h4>
                                <table class="w-100" style="margin-bottom: 15px;">
                                    <thead>
                                        <tr>
                                            <th>Subject</th>
                                            <th>Max Marks</th>
                                            <th>Marks Obtained</th>
                                            <th>Grade</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${subjectMarksHtml}
                                    </tbody>
                                </table>
                                <hr>
                                <p><strong>Total Marks Obtained:</strong> ${totalMarksObtained} / ${totalMaxMarks}</p>
                                <p><strong>Percentage:</strong> ${percentage}%</p>
                                <p><strong>Overall Grade:</strong> ${overallGrade}</p>
                                <hr>
                                <p class="text-right"><strong>Principal's Signature:</strong> ________________________</p>
                                <p class="text-right"><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = reportCardsHtml;
                document.getElementById('print-report-cards-btn').disabled = false;
            } catch (error) {
                console.error("Error generating report cards:", error);
                container.innerHTML = '<p class="text-danger text-center">Error generating report cards.</p>';
            }
        });
        document.getElementById('print-report-cards-btn').addEventListener('click', function () {
            const printContent = document.getElementById('report-cards-container').innerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent;
            window.location.reload();
        });
        function getOverallGrade(percentage) {
            if (percentage >= 90) return 'A+';
            if (percentage >= 80) return 'A';
            if (percentage >= 70) return 'B';
            if (percentage >= 60) return 'C';
            if (percentage >= 50) return 'D';
            return 'F';
        }
        document.getElementById('fee-student').addEventListener('change', async function () {
            const studentId = parseInt(this.value);
            const feeClassSelect = document.getElementById('fee-class');
            const feeSectionSelect = document.getElementById('fee-section');
            const feeDetailsContainer = document.getElementById('fee-details-container');
            feeDetailsContainer.innerHTML = '';
            document.getElementById('fee-total-amount').value = 0;
            if (!studentId) {
                feeClassSelect.value = '';
                feeSectionSelect.innerHTML = '<option value="">Select Section</option>';
                feeDetailsContainer.innerHTML = '<p class="text-muted">Select a student and class to see fee details.</p>';
                return;
            }
            try {
                const student = await getRecord(db.transaction('students', 'readonly').objectStore('students'), studentId);
                if (student) {
                    feeClassSelect.value = student.classId;
                    await populateSectionDropdown(feeClassSelect);
                    feeSectionSelect.value = student.section;
                    document.getElementById('fee-class').dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error("Error fetching student for fee collection:", error);
            }
        });
        document.getElementById('fee-class').addEventListener('change', async function () {
            const studentId = parseInt(document.getElementById('fee-student').value);
            const classId = parseInt(this.value);
            const section = document.getElementById('fee-section').value;
            const feeDetailsContainer = document.getElementById('fee-details-container');
            feeDetailsContainer.innerHTML = '<p class="text-muted">Loading fee details...</p>';
            document.getElementById('fee-total-amount').value = 0;
            if (!studentId || !classId || !section) {
                feeDetailsContainer.innerHTML = '<p class="text-muted">Select a student and class to see fee details.</p>';
                return;
            }
            try {
                const allClassFees = await getAllRecords(db.transaction('classFees', 'readonly').objectStore('classFees'));
                const allFeeTypes = await getAllRecords(db.transaction('feeTypes', 'readonly').objectStore('feeTypes'));
                const allFeePayments = await getAllRecords(db.transaction('feePayments', 'readonly').objectStore('feePayments'));
                const relevantClassFees = allClassFees.filter(cf => cf.classId === classId);
                let totalPayable = 0;
                let detailsHtml = '<div class="fee-structure">';
                for (const classFee of relevantClassFees) {
                    const feeType = allFeeTypes.find(ft => ft.id === classFee.feeTypeId);
                    if (feeType) {
                        const amount = classFee.amount || feeType.amount;
                        const dueDate = classFee.dueDate || 'N/A';
                        const hasPaid = allFeePayments.some(p =>
                            p.studentId === studentId &&
                            p.feeTypeId === feeType.id &&
                            p.status === 'Paid' &&
                            p.paymentDate.startsWith(new Date().getFullYear().toString() + '-' + (new Date().getMonth() + 1).toString().padStart(2, '0'))
                        );
                        if (!hasPaid) {
                            detailsHtml += `
                                <div class="fee-item">
                                    <span>${feeType.name}</span>
                                    <span>$${amount.toFixed(2)} (Due: ${dueDate})</span>
                                </div>
                            `;
                            totalPayable += amount;
                        }
                    }
                }
                detailsHtml += `
                    <div class="fee-item total">
                        <span>Total Payable</span>
                        <span>$${totalPayable.toFixed(2)}</span>
                    </div>
                </div>`;
                feeDetailsContainer.innerHTML = detailsHtml;
                document.getElementById('fee-total-amount').value = totalPayable;
                document.getElementById('fee-paid-amount').value = totalPayable;
                document.getElementById('print-receipt-btn').disabled = false;
            } catch (error) {
                console.error("Error loading fee details:", error);
                feeDetailsContainer.innerHTML = '<p class="text-danger">Error loading fee details.</p>';
            }
        });
        document.getElementById('fee-collection-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const studentId = parseInt(document.getElementById('fee-student').value);
            const classId = parseInt(document.getElementById('fee-class').value);
            const feeSection = document.getElementById('fee-section').value;
            const paidAmount = parseFloat(document.getElementById('fee-paid-amount').value);
            const discount = parseFloat(document.getElementById('fee-discount').value);
            const fine = parseFloat(document.getElementById('fee-fine').value);
            const paymentMethod = document.getElementById('fee-payment-method').value;
            const paymentDate = document.getElementById('fee-payment-date').value;
            const remarks = document.getElementById('fee-remarks').value;
            if (!studentId || !classId || !feeSection || !paymentDate || isNaN(paidAmount)) {
                alert('Please fill all required fields for fee collection.');
                return;
            }
            const transaction = db.transaction(['feePayments', 'students', 'classes', 'feeTypes'], 'readwrite');
            const feePaymentsStore = transaction.objectStore('feePayments');
            const studentStore = transaction.objectStore('students');
            const classStore = transaction.objectStore('classes');
            const feeTypesStore = transaction.objectStore('feeTypes');
            try {
                const student = await getRecord(studentStore, studentId);
                const cls = await getRecord(classStore, classId);
                const allFeeTypes = await getAllRecords(feeTypesStore);
                const allClassFees = await getAllRecords(db.transaction('classFees', 'readonly').objectStore('classFees'));
                const feePaymentRecord = {
                    studentId: studentId,
                    studentName: student ? `${student.firstName} ${student.lastName}` : 'N/A',
                    classId: classId,
                    className: cls ? cls.name : 'N/A',
                    section: feeSection,
                    feeDetails: [],
                    totalAmountPayable: parseFloat(document.getElementById('fee-total-amount').value),
                    discount: discount,
                    fine: fine,
                    amountPaid: paidAmount,
                    paymentMethod: paymentMethod,
                    paymentDate: paymentDate,
                    remarks: remarks,
                    status: 'Paid',
                    balance: (parseFloat(document.getElementById('fee-total-amount').value) - discount + fine) - paidAmount
                };
                const relevantClassFees = allClassFees.filter(cf => cf.classId === classId);
                const paymentsMadeThisPeriod = (await getAllRecords(feePaymentsStore)).filter(p =>
                    p.studentId === studentId && p.paymentDate.startsWith(paymentDate.substring(0, 7))
                );
                for (const classFee of relevantClassFees) {
                    const feeType = allFeeTypes.find(ft => ft.id === classFee.feeTypeId);
                    if (feeType && !paymentsMadeThisPeriod.some(p => p.feeDetails.some(fd => fd.feeTypeId === feeType.id))) {
                        feePaymentRecord.feeDetails.push({
                            feeTypeId: feeType.id,
                            feeName: feeType.name,
                            amount: classFee.amount || feeType.amount,
                            frequency: feeType.frequency
                        });
                    }
                }
                await feePaymentsStore.add(feePaymentRecord);
                transaction.oncomplete = function () {
                    alert('Fee collected successfully!');
                    addActivity('fee', 'Fee Collected', `PKR ${paidAmount} collected from ${student.firstName} ${student.lastName}`);
                    document.getElementById('fee-collection-form').reset();
                    document.getElementById('fee-total-amount').value = 0;
                    document.getElementById('fee-details-container').innerHTML = '<p class="text-muted">Select a student and class to see fee details.</p>';
                    document.getElementById('print-receipt-btn').disabled = false;
                    loadDashboardData();
                };
                transaction.onerror = function (event) {
                    console.error("Error collecting fee:", event.target.error);
                    alert('Error collecting fee. Please try again.');
                };
            } catch (error) {
                console.error("Error during fee collection transaction:", error);
                alert('Error collecting fee. Please try again.');
            }
        });
        document.getElementById('print-receipt-btn').addEventListener('click', async function () {
            const studentId = parseInt(document.getElementById('fee-student').value);
            const paidAmount = parseFloat(document.getElementById('fee-paid-amount').value);
            const paymentDate = document.getElementById('fee-payment-date').value;
            const paymentMethod = document.getElementById('fee-payment-method').value;
            if (!studentId || isNaN(paidAmount)) {
                alert('Please collect fee first to print a receipt.');
                return;
            }
            try {
                const student = await getRecord(db.transaction('students', 'readonly').objectStore('students'), studentId);
                const institutionSettings = (await getRecord(db.transaction('settings', 'readonly').objectStore('settings'), 'institution'))?.value || {};
                const receiptHtml = `
                    <div style="width: 300px; margin: 20px auto; padding: 15px; border: 1px dashed #333; font-family: monospace; font-size: 0.8em;">
                        <h3 style="text-align: center; margin-bottom: 10px;">${institutionSettings.name || 'Your Institution'}</h3>
                        <p style="text-align: center; margin-bottom: 15px;">Fee Receipt</p>
                        <p>Date: ${paymentDate}</p>
                        <p>Student Name: ${student ? `${student.firstName} ${student.lastName}` : 'N/A'}</p>
                        <p>Class/Section: ${student ? `${student.class} / ${student.section}` : 'N/A'}</p>
                        <hr style="border-top: 1px dashed #ccc;">
                        <p>Amount Paid: <strong>PKR ${paidAmount.toFixed(2)}</strong></p>
                        <p>Payment Method: ${paymentMethod}</p>
                        <hr style="border-top: 1px dashed #ccc;">
                        <p style="text-align: center;">Thank You!</p>
                    </div>
                `;
                const printWindow = window.open('', '_blank');
                printWindow.document.write('<html><head><title>Fee Receipt</title>');
                printWindow.document.write('</head><body>');
                printWindow.document.write(receiptHtml);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            } catch (error) {
                console.error("Error generating receipt:", error);
                alert("Error generating receipt.");
            }
        });
        document.getElementById('defaulters-filter-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const classId = document.getElementById('df-class').value ? parseInt(document.getElementById('df-class').value) : null;
            const section = document.getElementById('df-section').value;
            const feeTypeId = document.getElementById('df-fee-type').value ? parseInt(document.getElementById('df-fee-type').value) : null;
            const month = document.getElementById('df-month').value;
            const currentYear = new Date().getFullYear();
            const container = document.getElementById('defaulters-container');
            const tbody = document.getElementById('defaulters-table-body');
            tbody.innerHTML = '';
            container.style.display = 'block';
            try {
                const students = await getAllRecords(db.transaction('students', 'readonly').objectStore('students'));
                const classFees = await getAllRecords(db.transaction('classFees', 'readonly').objectStore('classFees'));
                const feeTypes = await getAllRecords(db.transaction('feeTypes', 'readonly').objectStore('feeTypes'));
                const feePayments = await getAllRecords(db.transaction('feePayments', 'readonly').objectStore('feePayments'));
                let defaulters = [];
                for (const student of students) {
                    if (classId && student.classId !== classId) continue;
                    if (section && student.section !== section) continue;
                    const studentClassFees = classFees.filter(cf => cf.classId === student.classId);
                    for (const sCF of studentClassFees) {
                        const feeType = feeTypes.find(ft => ft.id === sCF.feeTypeId);
                        if (!feeType) continue;
                        if (feeTypeId && feeType.id !== feeTypeId) continue;
                        const expectedAmount = sCF.amount || feeType.amount;
                        let isDue = false;
                        let dueDate = sCF.dueDate;
                        if (feeType.frequency === 'Monthly' && month) {
                            dueDate = `${currentYear}-${month.padStart(2, '0')}-05`;
                            isDue = true;
                        } else if (feeType.frequency === 'Yearly' && new Date().getMonth() + 1 >= 9) {
                            dueDate = `${currentYear}-09-01`;
                            isDue = true;
                        }
                        if (isDue && new Date() > new Date(dueDate)) {
                            const paidForThisPeriod = feePayments.some(p =>
                                p.studentId === student.id &&
                                p.feeDetails.some(fd => fd.feeTypeId === feeType.id) &&
                                p.paymentDate.startsWith(`${currentYear}-${month.padStart(2, '0')}`)
                            );
                            if (!paidForThisPeriod) {
                                defaulters.push({
                                    studentId: student.id,
                                    studentName: `${student.firstName} ${student.lastName}`,
                                    class: student.class,
                                    section: student.section,
                                    feeType: feeType.name,
                                    dueAmount: expectedAmount,
                                    dueDate: dueDate,
                                    dueSince: new Date(dueDate).toLocaleDateString()
                                });
                            }
                        }
                    }
                }
                if (defaulters.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No defaulters found for the selected criteria.</td></tr>';
                } else {
                    defaulters.forEach(defaulter => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${defaulter.studentId}</td>
                            <td>${defaulter.studentName}</td>
                            <td>${defaulter.class}</td>
                            <td>${defaulter.section}</td>
                            <td>${defaulter.feeType}</td>
                            <td>$${defaulter.dueAmount.toFixed(2)}</td>
                            <td>${defaulter.dueSince}</td>
                            <td>
                                <button class="btn btn-sm btn-primary send-reminder" data-student-id="${defaulter.studentId}">
                                    <i class="fas fa-bell"></i> Remind
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                document.querySelectorAll('.send-reminder').forEach(btn => btn.onclick = () => alert(`Sending reminder to Student ID: ${btn.dataset.studentId}`));
            } catch (error) {
                console.error("Error finding defaulters:", error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center">Error loading defaulters.</td></tr>';
            }
        });
        document.getElementById('send-reminders-btn').addEventListener('click', function () {
            alert('Sending reminders to all listed defaulters is not implemented.');
        });
        document.getElementById('salary-process-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const month = parseInt(document.getElementById('salary-month').value);
            const year = parseInt(document.getElementById('salary-year').value);
            const employeeType = document.getElementById('salary-employee-type').value;
            if (!month || !year) {
                alert('Please select Month and Year.');
                return;
            }
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            const staff = await getAllRecords(db.transaction(['staff'], 'readonly').objectStore('staff'));
            const salariesPaid = await getAllRecords(db.transaction(['salaries'], 'readonly').objectStore('salaries'));
            let employeesToProcess = [];
            if (employeeType === 'Teacher' || employeeType === '') {
                employeesToProcess.push(...teachers.map(t => ({ ...t, type: 'Teacher', designation: 'Teacher' })));
            }
            if (employeeType === 'Staff' || employeeType === '') {
                employeesToProcess.push(...staff.map(s => ({ ...s, type: 'Staff', designation: s.role })));
            }
            const tbody = document.getElementById('salary-process-table-body');
            tbody.innerHTML = '';
            document.getElementById('salary-process-container').style.display = 'block';
            if (employeesToProcess.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No employees found for the selected criteria.</td></tr>';
                return;
            }
            employeesToProcess.forEach(emp => {
                const alreadyPaid = salariesPaid.some(s =>
                    s.employeeId === emp.id && s.employeeType === emp.type && s.month === month && s.year === year
                );
                const basicSalary = emp.salary || 0;
                const allowances = 0;
                const deductions = 0;
                const netSalary = basicSalary + allowances - deductions;
                const status = alreadyPaid ? 'Paid' : 'Pending';
                const statusClass = status === 'Paid' ? 'status-success' : 'status-pending';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${emp.id}</td>
                    <td>${emp.firstName} ${emp.lastName}</td>
                    <td>${emp.designation}</td>
                    <td>$${basicSalary.toFixed(2)}</td>
                    <td>$${allowances.toFixed(2)}</td>
                    <td>$${deductions.toFixed(2)}</td>
                    <td>$${netSalary.toFixed(2)}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success process-single-salary" data-id="${emp.id}" data-type="${emp.type}" ${alreadyPaid ? 'disabled' : ''}>
                            <i class="fas fa-money-check-alt"></i> Process
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('.process-single-salary').forEach(btn => btn.onclick = async () => {
                const empId = parseInt(btn.dataset.id);
                const empType = btn.dataset.type;
                const employee = employeesToProcess.find(e => e.id === empId && e.type === empType);
                if (employee) {
                    await processSingleSalary(employee, month, year);
                    document.getElementById('salary-process-form').dispatchEvent(new Event('submit'));
                }
            });
        });
        async function processSingleSalary(employee, month, year) {
            const transaction = db.transaction(['salaries'], 'readwrite');
            const salaryStore = transaction.objectStore('salaries');
            const basicSalary = employee.salary || 0;
            const allowances = 0;
            const deductions = 0;
            const netSalary = basicSalary + allowances - deductions;
            const salaryRecord = {
                employeeId: employee.id,
                employeeName: `${employee.firstName} ${employee.lastName}`,
                employeeType: employee.type,
                designation: employee.designation,
                month: month,
                year: year,
                basicSalary: basicSalary,
                allowances: allowances,
                deductions: deductions,
                netSalary: netSalary,
                paymentDate: new Date().toISOString().split('T')[0],
                status: 'Paid'
            };
            try {
                await salaryStore.add(salaryRecord);
                alert(`Salary processed for ${employee.firstName} ${employee.lastName} for ${month}/${year}!`);
                addActivity('financial', 'Salary Processed', `Salary paid to ${employee.firstName} ${employee.lastName} for ${month}/${year}.`);
            } catch (error) {
                console.error("Error processing salary:", error);
                alert('Error processing salary. Please try again.');
            }
        }
        document.getElementById('process-salary-btn').addEventListener('click', async function () {
            const month = parseInt(document.getElementById('salary-month').value);
            const year = parseInt(document.getElementById('salary-year').value);
            const employeeType = document.getElementById('salary-employee-type').value;
            if (!confirm(`Are you sure you want to process salaries for all *pending* employees for ${month}/${year}?`)) {
                return;
            }
            const teachers = await getAllRecords(db.transaction(['teachers'], 'readonly').objectStore('teachers'));
            const staff = await getAllRecords(db.transaction(['staff'], 'readonly').objectStore('staff'));
            const salariesPaid = await getAllRecords(db.transaction(['salaries'], 'readonly').objectStore('salaries'));
            let employeesToProcess = [];
            if (employeeType === 'Teacher' || employeeType === '') {
                employeesToProcess.push(...teachers.map(t => ({ ...t, type: 'Teacher', designation: 'Teacher' })));
            }
            if (employeeType === 'Staff' || employeeType === '') {
                employeesToProcess.push(...staff.map(s => ({ ...s, type: 'Staff', designation: s.role })));
            }
            let processedCount = 0;
            for (const emp of employeesToProcess) {
                const alreadyPaid = salariesPaid.some(s =>
                    s.employeeId === emp.id && s.employeeType === emp.type && s.month === month && s.year === year
                );
                if (!alreadyPaid) {
                    await processSingleSalary(emp, month, year);
                    processedCount++;
                }
            }
            alert(`Processed salaries for ${processedCount} employees.`);
            document.getElementById('salary-process-form').dispatchEvent(new Event('submit'));
        });
        document.getElementById('print-payslips-btn').addEventListener('click', async function () {
            const month = parseInt(document.getElementById('salary-month').value);
            const year = parseInt(document.getElementById('salary-year').value);
            const employeeType = document.getElementById('salary-employee-type').value;
            const salaries = await getAllRecords(db.transaction('salaries', 'readonly').objectStore('salaries'));
            let payslipsToPrint = salaries.filter(s => s.month === month && s.year === year);
            if (employeeType) {
                payslipsToPrint = payslipsToPrint.filter(s => s.employeeType === employeeType);
            }
            if (payslipsToPrint.length === 0) {
                alert('No payslips found for the selected criteria.');
                return;
            }
            let printContent = '';
            const institutionSettings = (await getRecord(db.transaction('settings', 'readonly').objectStore('settings'), 'institution'))?.value || {};
            payslipsToPrint.forEach(salary => {
                printContent += `
                    <div style="width: 300px; margin: 20px auto; padding: 15px; border: 1px solid #333; font-family: monospace; font-size: 0.8em; page-break-after: always;">
                        <h3 style="text-align: center; margin-bottom: 10px;">${institutionSettings.name || 'Your Institution'}</h3>
                        <p style="text-align: center; margin-bottom: 15px;">Payslip for ${new Date(year, month - 1).toLocaleString('default', { month: 'long' })} ${year}</p>
                        <p>Employee: ${salary.employeeName}</p>
                        <p>Designation: ${salary.designation}</p>
                        <hr style="border-top: 1px dashed #ccc;">
                        <p>Basic Salary: $${salary.basicSalary.toFixed(2)}</p>
                        <p>Allowances: $${salary.allowances.toFixed(2)}</p>
                        <p>Deductions: $${salary.deductions.toFixed(2)}</p>
                        <hr style="border-top: 1px dashed #ccc;">
                        <p>Net Salary: <strong>$${salary.netSalary.toFixed(2)}</strong></p>
                        <p>Payment Date: ${salary.paymentDate}</p>
                        <hr style="border-top: 1px dashed #ccc;">
                        <p style="text-align: center;">Authorized Signature</p>
                    </div>
                `;
            });
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Payslips</title></head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        });
        async function generateReport(formId, reportContainerId, titleElementId) {
            const form = document.getElementById(formId);
            const container = document.getElementById(reportContainerId);
            const contentDiv = container.querySelector('div:last-child');
            const titleEl = document.getElementById(titleElementId);
            contentDiv.innerHTML = '<p class="text-center">Generating report...</p>';
            container.style.display = 'block';
            const filters = {};
            Array.from(form.elements).forEach(input => {
                if (input.id) {
                    filters[input.id] = input.value;
                }
            });
            let data = [];
            let columns = [];
            let reportTitle = titleEl.textContent;
            try {
                if (formId.includes('student-report-filter-form')) {
                    const students = await getAllRecords(db.transaction('students', 'readonly').objectStore('students'));
                    data = students.filter(s => {
                        let match = true;
                        if (filters['sr-class'] && s.classId != filters['sr-class']) match = false;
                        if (filters['sr-section'] && s.section !== filters['sr-section']) match = false;
                        if (filters['sr-start-date'] && s.admissionDate < filters['sr-start-date']) match = false;
                        if (filters['sr-end-date'] && s.admissionDate > filters['sr-end-date']) match = false;
                        return match;
                    });
                    if (filters['sr-report-type'] === 'admission') {
                        columns = ['id', 'firstName', 'lastName', 'gender', 'class', 'section', 'admissionNumber', 'admissionDate', 'fatherName', 'fatherPhone'];
                        reportTitle = 'Student Admission Report';
                    } else if (filters['sr-report-type'] === 'class-wise') {
                        columns = ['class', 'section', 'firstName', 'lastName', 'gender', 'admissionNumber'];
                        reportTitle = 'Class-wise Student Report';
                        data.sort((a, b) => {
                            if (a.class !== b.class) return a.class.localeCompare(b.class);
                            return a.section.localeCompare(b.section);
                        });
                    } else if (filters['sr-report-type'] === 'gender-wise') {
                        columns = ['gender', 'firstName', 'lastName', 'class', 'section', 'admissionNumber'];
                        reportTitle = 'Gender-wise Student Report';
                        data.sort((a, b) => a.gender.localeCompare(b.gender));
                    }
                } else if (formId.includes('attendance-report-form') || formId.includes('reports-attendance-filter-form')) {
                    const attendanceRecords = await getAllRecords(db.transaction('attendance', 'readonly').objectStore('attendance'));
                    const students = await getAllRecords(db.transaction('students', 'readonly').objectStore('students'));
                    data = attendanceRecords.filter(a => {
                        let match = true;
                        if (filters['report-class-academic'] && a.classId != filters['report-class-academic']) match = false;
                        if (filters['report-section-academic'] && a.section !== filters['report-section-academic']) match = false;
                        if (filters['report-student-academic'] && a.studentId != filters['report-student-academic']) match = false;
                        if (filters['report-month-academic'] && !a.date.startsWith(`${filters['report-year-academic']}-${filters['report-month-academic'].padStart(2, '0')}`)) match = false;
                        if (filters['report-year-academic'] && !a.date.startsWith(filters['report-year-academic'])) match = false;
                        if (filters['ar-date-reports'] && a.date !== filters['ar-date-reports']) match = false;
                        if (filters['ar-month-reports'] && !a.date.startsWith(`${filters['ar-year-reports'] || new Date().getFullYear()}-${filters['ar-month-reports'].padStart(2, '0')}`)) match = false;
                        if (filters['ar-year-reports'] && !a.date.startsWith(filters['ar-year-reports'])) match = false;
                        return match;
                    }).map(a => ({
                        ...a,
                        studentName: students.find(s => s.id === a.studentId)?.firstName + ' ' + students.find(s => s.id === a.studentId)?.lastName || 'N/A'
                    }));
                    if (filters['ar-report-type-reports'] === 'daily' || filters['report-type-academic'] === 'daily') {
                        columns = ['date', 'studentName', 'status', 'remarks'];
                        reportTitle = `Daily Attendance Report for ${filters['ar-date-reports'] || new Date().toLocaleDateString()}`;
                    } else if (filters['ar-report-type-reports'] === 'monthly' || filters['report-type-academic'] === 'monthly') {
                        columns = ['studentName', 'classId', 'section', 'presentDays', 'absentDays', 'lateDays'];
                        reportTitle = `Monthly Attendance Summary for ${filters['ar-month-reports']}/${filters['ar-year-reports']}`;
                        data = aggregateMonthlyAttendance(data);
                    } else if (filters['ar-report-type-reports'] === 'student-wise' || filters['report-type-academic'] === 'student-wise') {
                        columns = ['date', 'status', 'remarks'];
                        reportTitle = `Attendance for ${data[0]?.studentName || 'Selected Student'}`;
                    }
                } else if (formId.includes('financial-report-filter-form')) {
                    const incomeData = await getAllRecords(db.transaction('income', 'readonly').objectStore('income'));
                    const expenseData = await getAllRecords(db.transaction('expenses', 'readonly').objectStore('expenses'));
                    const salaries = await getAllRecords(db.transaction('salaries', 'readonly').objectStore('salaries'));
                    let transactions = [];
                    if (filters['fr-type-finance'] !== 'expense') transactions.push(...incomeData.map(d => ({ ...d, type: 'Income' })));
                    if (filters['fr-type-finance'] !== 'income') transactions.push(...expenseData.map(d => ({ ...d, type: 'Expense' })));
                    transactions = transactions.filter(t => {
                        let match = true;
                        if (filters['fr-category-finance'] && t.category !== filters['fr-category-finance']) match = false;
                        if (filters['fr-start-date-finance'] && t.date < filters['fr-start-date-finance']) match = false;
                        if (filters['fr-end-date-finance'] && t.date > filters['fr-end-date-finance']) match = false;
                        return match;
                    }).sort((a, b) => new Date(a.date) - new Date(b.date));
                    if (filters['fr-report-type-finance'] === 'fee-collection' || filters['fr-report-type-reports'] === 'fee-collection') {
                        const feePayments = await getAllRecords(db.transaction('feePayments', 'readonly').objectStore('feePayments'));
                        data = feePayments.filter(p => {
                            let match = true;
                            if (filters['fr-class-finance'] && p.classId != filters['fr-class-finance']) match = false;
                            if (filters['fr-start-date-finance'] && p.paymentDate < filters['fr-start-date-finance']) match = false;
                            if (filters['fr-end-date-finance'] && p.paymentDate > filters['fr-end-date-finance']) match = false;
                            return match;
                        });
                        columns = ['paymentDate', 'studentName', 'className', 'section', 'amountPaid', 'paymentMethod'];
                        reportTitle = 'Fee Collection Report';
                    } else if (filters['fr-report-type-finance'] === 'expenses' || filters['fr-report-type-reports'] === 'expenses') {
                        data = transactions.filter(t => t.type === 'Expense');
                        columns = ['date', 'category', 'amount', 'paymentMethod', 'description'];
                        reportTitle = 'Expenses Report';
                    } else if (filters['fr-report-type-finance'] === 'income' || filters['fr-report-type-reports'] === 'income') {
                        data = transactions.filter(t => t.type === 'Income');
                        columns = ['date', 'category', 'amount', 'paymentMethod', 'description'];
                        reportTitle = 'Income Report';
                    } else if (filters['fr-report-type-finance'] === 'balance-sheet' || filters['fr-report-type-reports'] === 'balance-sheet') {
                        const totalIncome = transactions.filter(t => t.type === 'Income').reduce((sum, t) => sum + t.amount, 0);
                        const totalExpense = transactions.filter(t => t.type === 'Expense').reduce((sum, t) => sum + t.amount, 0);
                        const balance = totalIncome - totalExpense;
                        contentDiv.innerHTML = `
                            <p><strong>Total Income:</strong> $${totalIncome.toFixed(2)}</p>
                            <p><strong>Total Expenses:</strong> $${totalExpense.toFixed(2)}</p>
                            <hr>
                            <h3><strong>Net Balance:</strong> $${balance.toFixed(2)}</h3>
                        `;
                        titleEl.textContent = 'Balance Sheet';
                        return;
                    } else if (filters['fr-report-type-reports'] === 'salary-expense') {
                        data = salaries.filter(s => {
                            let match = true;
                            const salaryDate = new Date(s.year, s.month - 1, 1);
                            if (filters['fr-start-date-reports']) {
                                if (salaryDate < new Date(filters['fr-start-date-reports'])) match = false;
                            }
                            if (filters['fr-end-date-reports']) {
                                if (salaryDate > new Date(filters['fr-end-date-reports'])) match = false;
                            }
                            return match;
                        });
                        columns = ['paymentDate', 'employeeName', 'designation', 'basicSalary', 'allowances', 'deductions', 'netSalary', 'month', 'year'];
                        reportTitle = 'Salary Expense Report';
                    }
                } else if (formId.includes('library-report-filter-form')) {
                    if (filters['lr-report-type-reports'] === 'inventory') {
                        data = await getAllRecords(db.transaction('books', 'readonly').objectStore('books'));
                        columns = ['title', 'author', 'subject', 'publisher', 'isbn', 'copies', 'availableCopies'];
                        reportTitle = 'Book Inventory Report';
                    } else if (filters['lr-report-type-reports'] === 'issue-return') {
                        const issues = await getAllRecords(db.transaction('bookIssues', 'readonly').objectStore('bookIssues'));
                        const books = await getAllRecords(db.transaction('books', 'readonly').objectStore('books'));
                        const students = await getAllRecords(db.transaction('students', 'readonly').objectStore('students'));
                        data = issues.filter(issue => {
                            let match = true;
                            if (filters['lr-start-date-reports'] && issue.issueDate < filters['lr-start-date-reports']) match = false;
                            if (filters['lr-end-date-reports'] && issue.issueDate > filters['lr-end-date-reports']) match = false;
                            return match;
                        }).map(issue => ({
                            ...issue,
                            bookTitle: books.find(b => b.id === issue.bookId)?.title || 'N/A',
                            studentName: students.find(s => s.id === issue.studentId)?.firstName + ' ' + students.find(s => s.id === issue.studentId)?.lastName || 'N/A'
                        }));
                        columns = ['issueDate', 'dueDate', 'returnDate', 'bookTitle', 'studentName', 'status', 'fine'];
                        reportTitle = 'Book Issue & Return Report';
                    } else if (filters['lr-report-type-reports'] === 'overdue') {
                        const issues = await getAllRecords(db.transaction('bookIssues', 'readonly').objectStore('bookIssues'));
                        const books = await getAllRecords(db.transaction('books', 'readonly').objectStore('books'));
                        const students = await getAllRecords(db.transaction('students', 'readonly').objectStore('students'));
                        const today = new Date().toISOString().split('T')[0];
                        data = issues.filter(issue => issue.status === 'Issued' && issue.dueDate < today)
                            .map(issue => ({
                                ...issue,
                                bookTitle: books.find(b => b.id === issue.bookId)?.title || 'N/A',
                                studentName: students.find(s => s.id === issue.studentId)?.firstName + ' ' + students.find(s => s.id === issue.studentId)?.lastName || 'N/A',
                                overdueDays: Math.floor((new Date(today) - new Date(issue.dueDate)) / (1000 * 60 * 60 * 24))
                            }));
                        columns = ['bookTitle', 'studentName', 'dueDate', 'overdueDays'];
                        reportTitle = 'Overdue Books Report';
                    }
                } else if (formId.includes('madrasa-report-filter-form')) {
                    const students = await getAllRecords(db.transaction('students', 'readonly').objectStore('students'));
                    const teachers = await getAllRecords(db.transaction('teachers', 'readonly').objectStore('teachers'));
                    if (filters['mr-report-type-reports'] === 'hifz-progress') {
                        const hifzRecords = await getAllRecords(db.transaction('hifzRecords', 'readonly').objectStore('hifzRecords'));
                        data = hifzRecords.filter(r => {
                            let match = true;
                            if (filters['mr-student-reports'] && r.studentId != filters['mr-student-reports']) match = false;
                            if (filters['mr-start-date-reports'] && r.date < filters['mr-start-date-reports']) match = false;
                            if (filters['mr-end-date-reports'] && r.date > filters['mr-end-date-reports']) match = false;
                            return match;
                        }).map(r => ({
                            ...r,
                            studentName: students.find(s => s.id === r.studentId)?.firstName + ' ' + students.find(s => s.id === r.studentId)?.lastName || 'N/A',
                            teacherName: teachers.find(t => t.id === r.teacherId)?.firstName + ' ' + teachers.find(t => t.id === r.teacherId)?.lastName || 'N/A'
                        }));
                        columns = ['date', 'studentName', 'surah', 'fromAyah', 'toAyah', 'status', 'teacherName', 'remarks'];
                        reportTitle = 'Hifz Progress Report';
                    } else if (filters['mr-report-type-reports'] === 'sabaq-progress') {
                        const sabaqRecords = await getAllRecords(db.transaction('sabaqRecords', 'readonly').objectStore('sabaqRecords'));
                        data = sabaqRecords.filter(r => {
                            let match = true;
                            if (filters['mr-student-reports'] && r.studentId != filters['mr-student-reports']) match = false;
                            if (filters['mr-start-date-reports'] && r.date < filters['mr-start-date-reports']) match = false;
                            if (filters['mr-end-date-reports'] && r.date > filters['mr-end-date-reports']) match = false;
                            return match;
                        }).map(r => ({
                            ...r,
                            studentName: students.find(s => s.id === r.studentId)?.firstName + ' ' + students.find(s => s.id === r.studentId)?.lastName || 'N/A',
                            teacherName: teachers.find(t => t.id === r.teacherId)?.firstName + ' ' + teachers.find(t => t.id === r.teacherId)?.lastName || 'N/A'
                        }));
                        columns = ['date', 'studentName', 'sabaqNew', 'sabaqRecent', 'sabaqOld', 'teacherName', 'remarks'];
                        reportTitle = 'Sabaq Progress Report';
                    } else if (filters['mr-report-type-reports'] === 'student-performance') {
                        data = [];
                        columns = [];
                        contentDiv.innerHTML = '<p class="text-center">Student Performance Report is complex and not fully implemented here.</p>';
                        return;
                    }
                }
                titleEl.textContent = reportTitle;
                if (data.length === 0) {
                    contentDiv.innerHTML = '<p class="text-center">No data found for the selected filters.</p>';
                } else {
                    let tableHtml = '<table><thead><tr>';
                    columns.forEach(col => {
                        const colName = col.replace(/([A-Z])/g, ' $1').trim().replace(/^./, str => str.toUpperCase());
                        tableHtml += `<th>${colName.replace('Id', ' ID')}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';
                    data.forEach(item => {
                        tableHtml += '<tr>';
                        columns.forEach(col => {
                            let value = item[col] !== undefined ? item[col] : 'N/A';
                            if (typeof value === 'number' && (col.includes('amount') || col.includes('salary'))) {
                                value = '$' + value.toFixed(2);
                            }
                            if (Array.isArray(value)) value = value.join(', ');
                            tableHtml += `<td>${value}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</tbody></table>';
                    contentDiv.innerHTML = tableHtml;
                }
            } catch (error) {
                console.error("Error generating report:", error);
                contentDiv.innerHTML = '<p class="text-danger text-center">Error generating report. Please check filters and try again.</p>';
            }
        }
        function printReport(reportContainerId) {
            const printContent = document.getElementById(reportContainerId).innerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = `
                <div style="font-family: sans-serif; padding: 20px;">
                    ${printContent}
                </div>
            `;
            window.print();
            document.body.innerHTML = originalContent;
            window.location.reload();
        }
        async function exportReport(formId, storeNames, columns, fileNamePrefix) {
            const form = document.getElementById(formId);
            const filters = {};
            Array.from(form.elements).forEach(input => {
                if (input.id) {
                    filters[input.id] = input.value;
                }
            });
            let allData = [];
            for (const storeName of storeNames) {
                const data = await getAllRecords(db.transaction(storeName, 'readonly').objectStore(storeName));
                allData = [...allData, ...data.map(item => ({ ...item, _sourceStore: storeName }))];
            }
            let filteredData = allData.filter(item => {
                return true;
            });
            if (filteredData.length === 0) {
                alert('No data to export based on current filters.');
                return;
            }
            let csvContent = columns.map(col => col.replace(/([A-Z])/g, ' $1').trim().replace(/^./, str => str.toUpperCase())).join(',') + '\n';
            filteredData.forEach(item => {
                let row = columns.map(col => {
                    let value = item[col] !== undefined ? item[col] : '';
                    if (typeof value === 'string') {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
                csvContent += row + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${fileNamePrefix}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Data exported successfully!');
            addActivity('system', 'Data Export', `${fileNamePrefix} report exported.`);
        }
        async function backupData() {
            try {
                const transaction = db.transaction(db.objectStoreNames, 'readonly');
                const backup = {};
                for (const storeName of db.objectStoreNames) {
                    const store = transaction.objectStore(storeName);
                    backup[storeName] = await getAllRecords(store);
                }
                transaction.oncomplete = function () {
                    const jsonString = JSON.stringify(backup, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sms_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    console.log("Backup created successfully");
                    addActivity('system', 'Data Backup', 'System data was backed up');
                    alert('Data backup created successfully!');
                };
                transaction.onerror = function (event) {
                    console.error("Error during backup transaction:", event.target.error);
                    alert('Error creating backup.');
                };
            } catch (error) {
                console.error("Error creating backup:", error);
                alert('Error creating backup.');
            }
        }
        function restoreData(file) {
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (confirm('WARNING: Restoring data will erase all current data and replace it with the backup. Are you sure? This operation is irreversible and will reset auto-incremented IDs.')) {
                        const transaction = db.transaction(db.objectStoreNames, 'readwrite');
                        for (const storeName of db.objectStoreNames) {
                            if (transaction.objectStoreNames.contains(storeName)) {
                                await new Promise((resolve, reject) => {
                                    const clearRequest = transaction.objectStore(storeName).clear();
                                    clearRequest.onsuccess = resolve;
                                    clearRequest.onerror = reject;
                                });
                            }
                        }
                        for (const storeName in backupData) {
                            if (db.objectStoreNames.contains(storeName) && Array.isArray(backupData[storeName])) {
                                const store = transaction.objectStore(storeName);
                                for (const item of backupData[storeName]) {
                                    const itemToStore = { ...item };
                                    if (store.autoIncrement && store.keyPath && itemToStore.hasOwnProperty(store.keyPath)) {
                                        delete itemToStore[store.keyPath];
                                    }
                                    await new Promise((resolve, reject) => {
                                        const addRequest = store.add(itemToStore);
                                        addRequest.onsuccess = resolve;
                                        addRequest.onerror = (event) => {
                                            console.warn(`Error adding item to ${storeName}: ${event.target.error.message}. Item:`, itemToStore);
                                            resolve();
                                        };
                                    });
                                }
                            }
                        }
                        transaction.oncomplete = function () {
                            console.log("Data restored successfully");
                            addActivity('system', 'Data Restore', 'System data was restored from backup');
                            alert('Data restored successfully! Please refresh the page for changes to take full effect.');
                            window.location.reload();
                        };
                        transaction.onerror = function (event) {
                            console.error("Error during restore transaction:", event.target.error);
                            alert('Error restoring data. Some data might be inconsistent. Please check console for details.');
                        };
                    }
                } catch (error) {
                    console.error("Error processing restore file:", error);
                    alert('Invalid backup file or data format.');
                }
            };
            reader.readAsText(file);
        }
        function resetData() {
            if (confirm('This action cannot be undone. Are you absolutely sure you want to delete ALL system data?')) {
                const transaction = db.transaction(db.objectStoreNames, 'readwrite');
                Promise.all(Array.from(db.objectStoreNames).map(storeName => {
                    return new Promise((resolve, reject) => {
                        if (transaction.objectStoreNames.contains(storeName)) {
                            const request = transaction.objectStore(storeName).clear();
                            request.onsuccess = resolve;
                            request.onerror = reject;
                        } else {
                            resolve();
                        }
                    });
                })).then(() => {
                    transaction.oncomplete = function () {
                        console.log("All data reset successfully");
                        addActivity('system', 'Data Reset', 'All system data was reset');
                        alert('All data has been deleted. The system is reset. Please reload the page.');
                        window.location.reload();
                    };
                    transaction.onerror = function (event) {
                        console.error("Error during reset transaction:", event.target.error);
                        alert('Error resetting data.');
                    };
                }).catch(error => {
                    console.error("Error clearing stores during reset:", error);
                    alert('Error resetting data.');
                });
            }
        }
        function setupQuickActions() {
            document.getElementById('quick-add-student').addEventListener('click', () => {
                showSection('students');
                document.getElementById('add-student-btn').click();
            });
            document.getElementById('quick-mark-attendance').addEventListener('click', () => {
                showSection('attendance');
                document.querySelector('#attendance-section .tab[data-tab="mark-attendance"]').click();
            });
            document.getElementById('quick-collect-fee').addEventListener('click', () => {
                showSection('fees');
                document.querySelector('#fees-section .tab[data-tab="collect-fee"]').click();
            });
            document.getElementById('quick-issue-book').addEventListener('click', () => {
                showSection('library');
                document.querySelector('#library-section .tab[data-tab="book-issue"]').click();
            });
        }
        function initApp() {
            loadDashboardData();
            loadStudents();
            loadTeachers();
            loadStaff();
            loadClasses();
            loadSubjects();
            loadFeeTypes();
            loadExams();
            loadBooks();
            loadHifzRecords();
            loadSabaqRecords();
            loadExpenses();
            loadIncome();
            loadSalaryStructure();
            loadSettings();
            setupEventListeners();
            setupTabs();
            setupQuickActions();
            showSection('dashboard');
            populateStudentDropdowns();
            populateTeacherDropdowns();
            populateClassDropdowns();
            populateSubjectDropdowns();
            populateFeeTypeDropdowns();
            populateExamDropdowns();
            populateBookDropdowns();
            populateIssuedBookDropdowns();
            populateYearDropdowns();
            populateSurahDropdowns();
            populateStaticDropdowns(['expense-category', 'income-category', 'fr-category-finance', 'fr-category-reports']);
            populateEmployeeDropdowns(['sr-employee']);
        }
        function setupEventListeners() {
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function (e) {
                    const parentLi = this.parentElement;
                    if (parentLi.classList.contains('has-submenu')) {
                        e.preventDefault();
                        parentLi.classList.toggle('open');
                    } else {
                        e.preventDefault();
                        const sectionHash = this.getAttribute('href');
                        showSection(sectionHash.substring(1));
                        document.querySelector('.sidebar').classList.remove('show');
                    }
                });
            });
            document.querySelector('.mobile-menu-btn').addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('show');
            });
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', () => hideModal(button.closest('.modal').id));
            });
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) hideModal(modal.id);
                });
            });
            document.querySelectorAll('select[id$="-class"]').forEach(classSelect => {
                classSelect.addEventListener('change', () => populateSectionDropdown(classSelect));
            });
            document.getElementById('student-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    firstName: document.getElementById('student-first-name').value,
                    lastName: document.getElementById('student-last-name').value,
                    gender: document.getElementById('student-gender').value,
                    dob: document.getElementById('student-dob').value,
                    classId: parseInt(document.getElementById('student-class').value),
                    section: document.getElementById('student-section').value,
                    admissionDate: document.getElementById('student-admission-date').value,
                    admissionNumber: document.getElementById('student-admission-number').value,
                    address: document.getElementById('student-address').value,
                    fatherName: document.getElementById('student-father-name').value,
                    fatherPhone: document.getElementById('student-father-phone').value,
                    motherName: document.getElementById('student-mother-name').value,
                    motherPhone: document.getElementById('student-mother-phone').value,
                    photo: await getFileBase64(document.getElementById('student-photo').files[0])
                };
                await saveRecord('students', data, id ? parseInt(id) : null, loadStudents);
                hideModal('student-modal');
            });
            document.getElementById('teacher-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    firstName: document.getElementById('teacher-first-name').value,
                    lastName: document.getElementById('teacher-last-name').value,
                    gender: document.getElementById('teacher-gender').value,
                    dob: document.getElementById('teacher-dob').value,
                    email: document.getElementById('teacher-email').value,
                    phone: document.getElementById('teacher-phone').value,
                    qualification: document.getElementById('teacher-qualification').value,
                    subjects: Array.from(document.getElementById('teacher-subjects').selectedOptions).map(opt => parseInt(opt.value)),
                    joiningDate: document.getElementById('teacher-joining-date').value,
                    salary: parseFloat(document.getElementById('teacher-salary').value),
                    address: document.getElementById('teacher-address').value,
                    photo: await getFileBase64(document.getElementById('teacher-photo').files[0])
                };
                await saveRecord('teachers', data, id ? parseInt(id) : null, loadTeachers);
                hideModal('teacher-modal');
            });
            document.getElementById('staff-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    firstName: document.getElementById('staff-first-name').value,
                    lastName: document.getElementById('staff-last-name').value,
                    gender: document.getElementById('staff-gender').value,
                    dob: document.getElementById('staff-dob').value,
                    email: document.getElementById('staff-email').value,
                    phone: document.getElementById('staff-phone').value,
                    role: document.getElementById('staff-role').value,
                    joiningDate: document.getElementById('staff-joining-date').value,
                    salary: parseFloat(document.getElementById('staff-salary').value),
                    status: document.getElementById('staff-status').value,
                    address: document.getElementById('staff-address').value,
                    photo: await getFileBase64(document.getElementById('staff-photo').files[0])
                };
                await saveRecord('staff', data, id ? parseInt(id) : null, loadStaff);
                hideModal('staff-modal');
            });
            document.getElementById('class-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    name: document.getElementById('class-name').value,
                    numericValue: parseInt(document.getElementById('class-numeric-value').value),
                    sections: document.getElementById('class-sections').value.split(',').map(s => s.trim()).filter(Boolean),
                    classTeacher: document.getElementById('class-teacher').value,
                };
                await saveRecord('classes', data, id ? parseInt(id) : null, loadClasses);
                hideModal('class-modal');
            });
            document.getElementById('subject-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    name: document.getElementById('subject-name').value,
                    code: document.getElementById('subject-code').value,
                    type: document.getElementById('subject-type').value,
                    teacher: document.getElementById('subject-teacher').value,
                    description: document.getElementById('subject-description').value,
                };
                await saveRecord('subjects', data, id ? parseInt(id) : null, loadSubjects);
                hideModal('subject-modal');
            });
            document.getElementById('fee-type-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    name: document.getElementById('fee-type-name').value,
                    code: document.getElementById('fee-type-code').value,
                    amount: parseFloat(document.getElementById('fee-type-amount').value),
                    frequency: document.getElementById('fee-type-frequency').value,
                    description: document.getElementById('fee-type-description').value,
                };
                await saveRecord('feeTypes', data, id ? parseInt(id) : null, loadFeeTypes);
                hideModal('fee-type-modal');
            });
            document.getElementById('exam-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    name: document.getElementById('exam-name').value,
                    type: document.getElementById('exam-type').value,
                    startDate: document.getElementById('exam-start-date').value,
                    endDate: document.getElementById('exam-end-date').value,
                    classes: Array.from(document.getElementById('exam-classes').selectedOptions).map(opt => parseInt(opt.value)),
                    description: document.getElementById('exam-description').value,
                    status: 'Active',
                };
                await saveRecord('exams', data, id ? parseInt(id) : null, loadExams);
                hideModal('exam-modal');
            });
            document.getElementById('book-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const copies = parseInt(document.getElementById('book-copies').value);
                const data = {
                    title: document.getElementById('book-title').value,
                    author: document.getElementById('book-author').value,
                    subject: document.getElementById('book-subject').value,
                    publisher: document.getElementById('book-publisher').value,
                    isbn: document.getElementById('book-isbn').value,
                    edition: document.getElementById('book-edition').value,
                    copies: copies,
                    availableCopies: id ? (await getRecord(db.transaction('books', 'readonly').objectStore('books'), parseInt(id))).availableCopies + (copies - (await getRecord(db.transaction('books', 'readonly').objectStore('books'), parseInt(id))).copies) : copies,
                    price: parseFloat(document.getElementById('book-price').value),
                    description: document.getElementById('book-description').value,
                    cover: await getFileBase64(document.getElementById('book-cover').files[0])
                };
                await saveRecord('books', data, id ? parseInt(id) : null, loadBooks);
                hideModal('book-modal');
            });
            document.getElementById('hifz-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    studentId: parseInt(document.getElementById('hifz-record-student').value),
                    date: document.getElementById('hifz-record-date').value,
                    surah: document.getElementById('hifz-surah').value,
                    teacherId: parseInt(document.getElementById('hifz-teacher-record').value),
                    fromAyah: parseInt(document.getElementById('hifz-from-ayah').value),
                    toAyah: parseInt(document.getElementById('hifz-to-ayah').value),
                    status: document.getElementById('hifz-status').value,
                    remarks: document.getElementById('hifz-remarks').value,
                };
                await saveRecord('hifzRecords', data, id ? parseInt(id) : null, loadHifzRecords);
                hideModal('hifz-modal');
            });
            document.getElementById('sabaq-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    studentId: parseInt(document.getElementById('sabaq-record-student').value),
                    date: document.getElementById('sabaq-record-date').value,
                    teacherId: parseInt(document.getElementById('sabaq-teacher-record').value),
                    status: document.getElementById('sabaq-status').value,
                    sabaqNew: document.getElementById('sabaq-new').value,
                    sabaqRecent: document.getElementById('sabaq-recent').value,
                    sabaqOld: document.getElementById('sabaq-old').value,
                    remarks: document.getElementById('sabaq-remarks').value,
                };
                await saveRecord('sabaqRecords', data, id ? parseInt(id) : null, loadSabaqRecords);
                hideModal('sabaq-modal');
            });
            document.getElementById('expense-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    date: document.getElementById('expense-date').value,
                    category: document.getElementById('expense-category').value,
                    amount: parseFloat(document.getElementById('expense-amount').value),
                    paymentMethod: document.getElementById('expense-payment-method').value,
                    description: document.getElementById('expense-description').value,
                    attachment: await getFileBase64(document.getElementById('expense-attachment').files[0])
                };
                await saveRecord('expenses', data, id ? parseInt(id) : null, loadExpenses);
                hideModal('expense-modal');
            });
            document.getElementById('income-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const id = this.getAttribute('data-id');
                const data = {
                    date: document.getElementById('income-date').value,
                    category: document.getElementById('income-category').value,
                    amount: parseFloat(document.getElementById('income-amount').value),
                    paymentMethod: document.getElementById('income-payment-method').value,
                    description: document.getElementById('income-description').value,
                    attachment: await getFileBase64(document.getElementById('income-attachment').files[0])
                };
                await saveRecord('income', data, id ? parseInt(id) : null, loadIncome);
                hideModal('income-modal');
            });
            document.getElementById('institution-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const data = {
                    name: document.getElementById('institution-name').value,
                    phone: document.getElementById('institution-phone').value,
                    email: document.getElementById('institution-email').value,
                    address: document.getElementById('institution-address').value,
                    logo: await getFileBase64(document.getElementById('institution-logo').files[0])
                };
                await saveRecord('settings', data, 'institution', loadSettings);
            });
            document.getElementById('academic-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const data = {
                    year: document.getElementById('academic-year').value,
                    session: document.getElementById('academic-session').value,
                    startDate: document.getElementById('academic-start-date').value,
                    endDate: document.getElementById('academic-end-date').value,
                    weekends: Array.from(document.getElementById('weekends').selectedOptions).map(opt => opt.value)
                };
                await saveRecord('settings', data, 'academic', loadSettings);
            });
            document.getElementById('fee-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const data = {
                    currency: document.getElementById('fee-currency').value,
                    fineRate: parseFloat(document.getElementById('fee-fine-rate').value),
                    paymentMethods: Array.from(document.getElementById('fee-payment-methods').selectedOptions).map(opt => opt.value)
                };
                await saveRecord('settings', data, 'fee', loadSettings);
            });
            document.getElementById('system-settings-form').addEventListener('submit', async function (e) {
                e.preventDefault();
                const data = {
                    language: document.getElementById('system-language').value,
                    theme: document.getElementById('system-theme').value,
                    timezone: document.getElementById('system-timezone').value,
                };
                await saveRecord('settings', data, 'system', loadSettings);
            });
            document.getElementById('add-student-btn').addEventListener('click', () => {
                document.getElementById('student-form').reset();
                document.getElementById('student-form').removeAttribute('data-id');
                document.querySelector('#student-modal .modal-title').textContent = 'Add New Student';
                populateClassDropdowns(['student-class']);
                populateSectionDropdown(document.getElementById('student-class'));
                showModal('student-modal');
            });
            document.getElementById('add-teacher-btn').addEventListener('click', () => {
                document.getElementById('teacher-form').reset();
                document.getElementById('teacher-form').removeAttribute('data-id');
                document.querySelector('#teacher-modal .modal-title').textContent = 'Add New Teacher';
                populateSubjectDropdowns(['teacher-subjects']);
                showModal('teacher-modal');
            });
            document.getElementById('add-staff-btn').addEventListener('click', () => {
                document.getElementById('staff-form').reset();
                document.getElementById('staff-form').removeAttribute('data-id');
                document.querySelector('#staff-modal .modal-title').textContent = 'Add New Staff';
                showModal('staff-modal');
            });
            document.getElementById('add-class-btn').addEventListener('click', () => {
                document.getElementById('class-form').reset();
                document.getElementById('class-form').removeAttribute('data-id');
                document.querySelector('#class-modal .modal-title').textContent = 'Add New Class';
                populateTeacherDropdowns(['class-teacher']);
                showModal('class-modal');
            });
            document.getElementById('add-subject-btn').addEventListener('click', () => {
                document.getElementById('subject-form').reset();
                document.getElementById('subject-form').removeAttribute('data-id');
                document.querySelector('#subject-modal .modal-title').textContent = 'Add New Subject';
                populateTeacherDropdowns(['subject-teacher']);
                showModal('subject-modal');
            });
            document.getElementById('add-fee-type-btn').addEventListener('click', () => {
                document.getElementById('fee-type-form').reset();
                document.getElementById('fee-type-form').removeAttribute('data-id');
                document.querySelector('#fee-type-modal .modal-title').textContent = 'Add New Fee Type';
                showModal('fee-type-modal');
            });
            document.getElementById('assign-fee-btn').addEventListener('click', () => {
                document.getElementById('assign-fee-form').reset();
                populateFeeTypeDropdowns(['assign-fee-type']);
                loadClassFeeAssignmentForm();
                showModal('assign-fee-modal');
            });
            document.getElementById('add-exam-btn').addEventListener('click', () => {
                document.getElementById('exam-form').reset();
                document.getElementById('exam-form').removeAttribute('data-id');
                document.querySelector('#exam-modal .modal-title').textContent = 'Add New Exam';
                populateClassDropdowns(['exam-classes']);
                showModal('exam-modal');
            });
            document.getElementById('add-book-btn').addEventListener('click', () => {
                document.getElementById('book-form').reset();
                document.getElementById('book-form').removeAttribute('data-id');
                document.querySelector('#book-modal .modal-title').textContent = 'Add New Book';
                showModal('book-modal');
            });
            document.getElementById('add-hifz-record-btn').addEventListener('click', () => {
                document.getElementById('hifz-form').reset();
                document.getElementById('hifz-form').removeAttribute('data-id');
                document.querySelector('#hifz-modal .modal-title').textContent = 'Add Hifz Record';
                populateStudentDropdowns(['hifz-record-student']);
                populateTeacherDropdowns(['hifz-teacher-record']);
                populateSurahDropdowns(['hifz-surah']);
                showModal('hifz-modal');
            });
            document.getElementById('add-sabaq-record-btn').addEventListener('click', () => {
                document.getElementById('sabaq-form').reset();
                document.getElementById('sabaq-form').removeAttribute('data-id');
                document.querySelector('#sabaq-modal .modal-title').textContent = 'Add Sabaq Record';
                populateStudentDropdowns(['sabaq-record-student']);
                populateTeacherDropdowns(['sabaq-teacher-record']);
                showModal('sabaq-modal');
            });
            document.getElementById('add-expense-btn').addEventListener('click', () => {
                document.getElementById('expense-form').reset();
                document.getElementById('expense-form').removeAttribute('data-id');
                document.querySelector('#expense-modal .modal-title').textContent = 'Add New Expense';
                document.getElementById('expense-modal').classList.add('show');
            });
            document.getElementById('add-income-btn').addEventListener('click', () => {
                document.getElementById('income-form').reset();
                document.getElementById('income-form').removeAttribute('data-id');
                document.querySelector('#income-modal .modal-title').textContent = 'Add New Income';
                document.getElementById('income-modal').classList.add('show');
            });
            document.getElementById('student-search').addEventListener('input', () => filterTable('students-table', document.getElementById('student-search').value));
            document.getElementById('teacher-search').addEventListener('input', () => filterTable('teachers-table', document.getElementById('teacher-search').value));
            document.getElementById('staff-search').addEventListener('input', () => filterTable('staff-table', document.getElementById('staff-search').value));
            document.getElementById('book-search').addEventListener('input', () => filterTable('books-table', document.getElementById('book-search').value));
            function filterTable(tableId, searchTerm) {
                const table = document.getElementById(tableId);
                const rows = table.querySelectorAll('tbody tr');
                const filter = searchTerm.toLowerCase();
                rows.forEach(row => {
                    let rowText = '';
                    Array.from(row.cells).slice(1, -1).forEach(cell => rowText += cell.textContent.toLowerCase() + ' ');
                    row.style.display = rowText.includes(filter) ? '' : 'none';
                });
            }
            document.getElementById('student-report-filter-form').addEventListener('submit', (e) => {
                e.preventDefault();
                generateReport('student-report-filter-form', 'student-report-container', 'student-report-title');
            });
            document.getElementById('print-student-report-btn').addEventListener('click', () => printReport('student-report-container'));
            document.getElementById('export-student-report-btn').addEventListener('click', () => exportReport('student-report-filter-form', ['students'], ['id', 'firstName', 'lastName', 'gender', 'class', 'section', 'admissionNumber', 'admissionDate', 'fatherName', 'fatherPhone'], 'Student_Report'));
            document.getElementById('reports-attendance-filter-form').addEventListener('submit', (e) => {
                e.preventDefault();
                generateReport('reports-attendance-filter-form', 'attendance-report-container-reports', 'attendance-report-title-reports');
            });
            document.getElementById('print-attendance-report-reports-btn').addEventListener('click', () => printReport('attendance-report-container-reports'));
            document.getElementById('export-attendance-report-reports-btn').addEventListener('click', () => exportReport('reports-attendance-filter-form', ['attendance'], ['date', 'studentName', 'status', 'remarks'], 'Attendance_Report'));
            document.getElementById('financial-report-filter-form-reports').addEventListener('submit', (e) => {
                e.preventDefault();
                generateReport('financial-report-filter-form-reports', 'financial-report-container-reports', 'financial-report-title-reports');
            });
            document.getElementById('print-financial-report-reports-btn').addEventListener('click', () => printReport('financial-report-container-reports'));
            document.getElementById('export-financial-report-reports-btn').addEventListener('click', () => exportReport('financial-report-filter-form-reports', ['income', 'expenses', 'salaries', 'feePayments'], ['date', 'type', 'category', 'amount', 'studentName', 'employeeName'], 'Financial_Report'));
            document.getElementById('library-report-filter-form').addEventListener('submit', (e) => {
                e.preventDefault();
                generateReport('library-report-filter-form', 'library-report-container', 'library-report-title');
            });
            document.getElementById('print-library-report-btn').addEventListener('click', () => printReport('library-report-container'));
            document.getElementById('export-library-report-btn').addEventListener('click', () => exportReport('library-report-filter-form', ['books', 'bookIssues'], ['title', 'author', 'copies', 'availableCopies', 'issueDate', 'dueDate', 'returnDate', 'studentName'], 'Library_Report'));
            document.getElementById('madrasa-report-filter-form').addEventListener('submit', (e) => {
                e.preventDefault();
                generateReport('madrasa-report-filter-form', 'madrasa-report-container', 'madrasa-report-title');
            });
            document.getElementById('print-madrasa-report-btn').addEventListener('click', () => printReport('madrasa-report-container'));
            document.getElementById('export-madrasa-report-btn').addEventListener('click', () => exportReport('madrasa-report-filter-form', ['hifzRecords', 'sabaqRecords'], ['date', 'studentName', 'surah', 'sabaqNew', 'sabaqRecent', 'sabaqOld', 'status'], 'Madrasa_Report'));
            document.getElementById('id-card-type').addEventListener('change', setupIDCardGenerationDropdown);
            document.getElementById('id-card-filter-form').addEventListener('submit', generateIDCard);
            document.getElementById('print-id-card-btn').addEventListener('click', () => printReport('id-card-content'));
            document.getElementById('certificate-filter-form').addEventListener('submit', generateCertificate);
            document.getElementById('print-certificate-btn').addEventListener('click', () => printReport('certificate-content'));
            document.getElementById('backup-data-btn').addEventListener('click', backupData);
            document.getElementById('restore-data').addEventListener('change', function () {
                document.getElementById('restore-data-btn').disabled = !this.files.length;
            });
            document.getElementById('restore-data-btn').addEventListener('click', function () {
                const fileInput = document.getElementById('restore-data');
                if (fileInput.files.length > 0) {
                    restoreData(fileInput.files[0]);
                } else {
                    alert('Please select a backup file first.');
                }
            });
            document.getElementById('reset-data-btn').addEventListener('click', resetData);
            document.querySelectorAll('button[data-section]').forEach(button => {
                button.addEventListener('click', function () {
                    const sectionId = this.dataset.section;
                    const tabId = this.dataset.tab;
                    if (sectionId) {
                        showSection(sectionId);
                        if (tabId) {
                            setTimeout(() => {
                                const tabButton = document.querySelector(`#${sectionId}-section .tab[data-tab='${tabId}']`);
                                if (tabButton) {
                                    tabButton.click();
                                }
                            }, 50);
                        }
                    }
                });
            });
        }
        function getFileBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        async function setupIDCardGenerationDropdown() {
            const type = document.getElementById('id-card-type').value;
            const personSelect = document.getElementById('id-card-person');
            personSelect.innerHTML = '<option value="">Select Person</option>';
            personSelect.disabled = true;
            document.getElementById('print-id-card-btn').disabled = true;
            document.getElementById('id-card-preview').style.display = 'none';
            let storeName = '';
            let displayKey = '';
            if (type === 'student') { storeName = 'students'; displayKey = 'firstName'; }
            else if (type === 'teacher') { storeName = 'teachers'; displayKey = 'firstName'; }
            else if (type === 'staff') { storeName = 'staff'; displayKey = 'firstName'; }
            if (storeName) {
                const records = await getAllRecords(db.transaction([storeName], 'readonly').objectStore(storeName));
                records.forEach(record => {
                    const option = document.createElement('option');
                    option.value = record.id;
                    option.textContent = `${record[displayKey]} ${record.lastName || ''} (ID: ${record.admissionNumber || record.id})`;
                    personSelect.appendChild(option);
                });
                personSelect.disabled = false;
            }
        }
        async function generateIDCard(e) {
            e.preventDefault();
            const type = document.getElementById('id-card-type').value;
            const personId = parseInt(document.getElementById('id-card-person').value);
            const previewDiv = document.getElementById('id-card-preview');
            const contentDiv = document.getElementById('id-card-content');
            const printBtn = document.getElementById('print-id-card-btn');
            if (!type || isNaN(personId)) {
                contentDiv.innerHTML = '<p class="text-danger text-center">Please select an ID card type and a person.</p>';
                previewDiv.style.display = 'block';
                printBtn.disabled = true;
                return;
            }
            let storeName = '';
            if (type === 'student') storeName = 'students';
            else if (type === 'teacher') storeName = 'teachers';
            else if (type === 'staff') storeName = 'staff';
            try {
                const person = await getRecord(db.transaction([storeName], 'readonly').objectStore(storeName), personId);
                const institutionSettings = (await getRecord(db.transaction('settings', 'readonly').objectStore('settings'), 'institution'))?.value || {};
                if (person) {
                    const photo = person.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzM0OThEQiIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDE5LjY3VjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg==';
                    const name = `${person.firstName} ${person.lastName}`;
                    const idLabel = type === 'student' ? 'Admission No.' : 'Employee ID';
                    const idValue = person.admissionNumber || person.id || 'N/A';
                    const roleLabel = type === 'student' ? 'Class/Section' : 'Role';
                    const roleValue = type === 'student' ? `${person.class || 'N/A'}/${person.section || 'N/A'}` : person.role || 'N/A';
                    const contactLabel = type === 'student' ? 'Father\'s Phone' : 'Phone';
                    const contactValue = type === 'student' ? person.fatherPhone || 'N/A' : person.phone || 'N/A';
                    contentDiv.innerHTML = `
                        <div style="width: 300px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; font-family: sans-serif; text-align: center; box-shadow: 2px 2px 10px rgba(0,0,0,0.1);">
                            <h4 style="margin: 0 0 10px 0; color: var(--dark-color);">${institutionSettings.name || 'Your Institution Name'}</h4>
                            <img src="${photo}" alt="Photo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--primary-color);">
                            <h3 style="margin: 5px 0; color: var(--primary-color);">${name}</h3>
                            <p style="margin: 3px 0; font-size: 0.9em; color: #555;">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                            <hr style="border: none; border-top: 1px dashed #eee; margin: 10px 0;">
                            <p style="margin: 5px 0; font-size: 0.8em; color: #333;"><strong class="text-muted">${idLabel}:</strong> ${idValue}</p>
                            <p style="margin: 5px 0; font-size: 0.8em; color: #333;"><strong class="text-muted">${roleLabel}:</strong> ${roleValue}</p>
                            <p style="margin: 5px 0; font-size: 0.8em; color: #333;"><strong class="text-muted">${contactLabel}:</strong> ${contactValue}</p>
                            <div class="qr-code" style="width: 80px; height: 80px; font-size: 0.7em; margin: 15px auto 0; border: 1px dashed #ccc;">QR Code</div>
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    printBtn.disabled = false;
                } else {
                    contentDiv.innerHTML = '<p class="text-danger text-center">Person not found.</p>';
                    previewDiv.style.display = 'block';
                    printBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error generating ID card:", error);
                contentDiv.innerHTML = '<p class="text-danger text-center">Error generating ID card.</p>';
                previewDiv.style.display = 'block';
                printBtn.disabled = true;
            }
        }
        async function generateCertificate(e) {
            e.preventDefault();
            const certificateType = document.getElementById('certificate-type').value;
            const studentId = parseInt(document.getElementById('certificate-student').value);
            const previewDiv = document.getElementById('certificate-preview');
            const contentDiv = document.getElementById('certificate-content');
            const printBtn = document.getElementById('print-certificate-btn');
            if (!certificateType || isNaN(studentId)) {
                contentDiv.innerHTML = '<p class="text-danger text-center">Please select a certificate type and a student.</p>';
                previewDiv.style.display = 'block';
                printBtn.disabled = true;
                return;
            }
            try {
                const student = await getRecord(db.transaction('students', 'readonly').objectStore('students'), studentId);
                const institutionSettings = (await getRecord(db.transaction('settings', 'readonly').objectStore('settings'), 'institution'))?.value || {};
                if (student) {
                    const certTitle = certificateType.replace(/-/g, ' ').toUpperCase() + ' CERTIFICATE';
                    const studentName = `${student.firstName} ${student.lastName}`;
                    const institutionName = institutionSettings.name || 'Your Institution Name';
                    const issueDate = new Date().toISOString().split('T')[0];
                    let certificateText = '';
                    switch (certificateType) {
                        case 'bonafide':
                            certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, is a bonafide student of this institution, currently enrolled in Class <strong>${student.class || 'N/A'}</strong>, Section <strong>${student.section || 'N/A'}</strong>. His/Her Admission Number is ${student.admissionNumber || 'N/A'}.`;
                            break;
                        case 'transfer':
                            certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, was a student of this institution from ${student.admissionDate || 'N/A'} to ${issueDate}. He/She was last enrolled in Class <strong>${student.class || 'N/A'}</strong>, Section <strong>${student.section || 'N/A'}</strong>. He/She bears a good moral character.`;
                            break;
                        case 'character':
                            certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, has been a student of this institution. During his/her stay, his/her character has been found to be <strong>satisfactory</strong>.`;
                            break;
                        case 'hifz-completion':
                            const hifzRecords = await getAllRecords(db.transaction('hifzRecords', 'readonly').objectStore('hifzRecords'));
                            const studentHifzRecords = hifzRecords.filter(r => r.studentId === student.id && r.status === 'Memorized');
                            const hasCompletedFullQuran = studentHifzRecords.length >= surahs.length;
                            if (hasCompletedFullQuran) {
                                certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, has successfully completed the memorization (Hifz) of the Holy Quran in this institution.`;
                            } else {
                                certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, is currently studying Hifz in this institution. Full Quran memorization is not yet completed.`;
                            }
                            break;
                        default:
                            certificateText = `Certificate for ${studentName}. Type: ${certTitle}.`;
                    }
                    contentDiv.innerHTML = `
                        <div style="width: 800px; margin: 20px auto; padding: 40px; border: 2px solid #000; font-family: serif; text-align: center; background: #fff; position: relative;">
                            <img src="${institutionSettings.logo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjMzg2Q0I3IiBkPSJNNDk0LjEgMjI1LjZjLTcuMS04LTE2LjktMTIuNy0yNy4xLTEyLjdoLTQwLjVjLTguNSAwLTE2LjYtMy40LTIyLjYtOS40bC0zMC4xLTMwLjFjLTIuMy0yLjMtNS4zLTMuNS04LjUtMy41cy02LjIgMS4yLTguNSAzLjVsLTU5LjUgNTkuNWMtMTIuNSAxMi41LTEyLjUgMzIuOCAwIDQ1LjNsMjYuNCAyNi40YzEyLjUgMTIuNSAzMi44IDEyLjUgNDUuMyAwbDEyMC41LTEyMC41YzIuMy0yLjMgMy41LTUuMyAzLjUtOC41cy0xLjItNi4yLTMuNS04LjVsLTMwLjEtMzAuMWMtMi4zLTIuMy01LjMtMy41LTguNS0zLjVzLTYuMiAxLjItOC41IDMuNWwtNjEuMSA2MS4xYy0yLjMgMi4zLTMuNSA1LjMtMy41IDguNXMxLjIgNi4yIDMuNSA4LjVsMzAuMSAzMC4xYzYuMSA2LjEgMTQuMS05LjQgMjIuNiA5LjRoNDAuNWMxMC4yIDAgMjAgNC43IDI3LjEgMTIuN2w2MS4xIDY4LjljNS40IDYgOC4xIDEzLjcgOC4xIDIxLjR2MzQuN2MwIDguNS0zLjQgMTYuNi05LjQgMjIuNmwtNTUuNSA1NS41Yy02LTYtMTQuMS05LjQtMjIuNi05LjRIMTQxLjNjLTguNSAwLTE2LjYtMy40LTIyLjYtOS40TDYzLjIgNDQ4LjNjLTYuMS02LTkuNC0xNC4xLTkuNC0yMi42VjE0MS4zYzAtOC41IDMuNC0xNi42IDkuNC0yMi42bDU1LjUtNTUuNWM2LTYgMTQuMS05LjQgMjIuNi05LjQzNCIvPjwvc3ZnPg=='}" alt="Logo" style="position: absolute; top: 30px; left: 30px; height: 80px;">
                            <h1 style="color: var(--dark-color); margin-bottom: 10px;">${institutionName}</h1>
                            <h2 style="color: var(--primary-color); margin-bottom: 30px; text-decoration: underline;">${certTitle}</h2>
                            <div style="font-size: 1.1em; line-height: 1.6; text-align: justify; margin: 0 50px 40px 50px;">
                                ${certificateText}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                                <div style="width: 200px; border-top: 1px solid #000; padding-top: 5px; text-align: center;">
                                    Student Signature
                                </div>
                                <div style="width: 200px; text-align: center;">
                                    <p style="margin-bottom: 5px;">Date: ${issueDate}</p>
                                    <div style="border-top: 1px solid #000; padding-top: 5px;">
                                        Principal Signature
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    previewDiv.style.display = 'block';
                    printBtn.disabled = false;
                } else {
                    contentDiv.innerHTML = '<p class="text-danger text-center">Student not found.</p>';
                    previewDiv.style.display = 'block';
                    printBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error generating certificate:", error);
                contentDiv.innerHTML = '<p class="text-danger text-center">Error generating certificate.</p>';
                previewDiv.style.display = 'block';
                printBtn.disabled = true;
            }
        }
        function aggregateMonthlyAttendance(records) {
            const aggregated = {};
            records.forEach(record => {
                const key = `${record.studentId}-${record.classId}-${record.section}`;
                if (!aggregated[key]) {
                    aggregated[key] = {
                        studentId: record.studentId,
                        studentName: record.studentName,
                        classId: record.classId,
                        section: record.section,
                        presentDays: 0,
                        absentDays: 0,
                        lateDays: 0,
                        leaveDays: 0
                    };
                }
                if (record.status === 'Present') aggregated[key].presentDays++;
                else if (record.status === 'Absent') aggregated[key].absentDays++;
                else if (record.status === 'Late') aggregated[key].lateDays++;
                else if (record.status === 'Leave') aggregated[key].leaveDays++;
            });
            return Object.values(aggregated);
        }
    </script>
</body>

</html>
<!DOCTYPE html>

<html dir="rtl" lang="ur">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>دینی مدرسہ مینجمنٹ</title>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400..700&amp;display=swap" rel="stylesheet"/>
<style>
        body { font-family: 'Noto Nastaliq Urdu', serif; direction: rtl; text-align: right; }
        .nav-link, .btn, .form-label, .form-control, .modal-title, .modal-body, .modal-footer, h1, h2, h3, h4, h5, h6, th, td, label { font-family: 'Noto Nastaliq Urdu', serif; }
        .table td, .table th { vertical-align: middle; }
        .form-label { margin-bottom: 0.2rem; }
        .btn { margin: 2px; }
        .custom-field-group { display: flex; align-items: center; margin-bottom: 5px; }
        .custom-field-group input { margin-left: 5px; }
        .custom-field-group button { margin-right: 5px; }
        @media print {
            body * { visibility: hidden; }
            #p_a, #p_a * { visibility: visible; }
            #p_a { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
        .form-control::placeholder { opacity: 0.6; }
    </style>
<link href="manifest.json" rel="manifest"/><link href="favicon.ico" rel="icon" type="image/x-icon"/></head>
<body>
<div class="container mt-4">
<h1 class="text-center mb-4">دینی مدرسہ مینجمنٹ</h1>
<ul class="nav nav-tabs no-print" id="m_t" role="tablist">
<li class="nav-item" role="presentation"><button class="nav-link active" data-bs-target="#s_p" data-bs-toggle="tab" id="s_tb" role="tab" type="button">طلبہ</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#t_p" data-bs-toggle="tab" id="t_tb" role="tab" type="button">اساتذہ</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#c_p" data-bs-toggle="tab" id="c_tb" role="tab" type="button">جماعتیں</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#a_p" data-bs-toggle="tab" id="a_tb" role="tab" type="button">حاضری</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#fs_p" data-bs-toggle="tab" id="fs_tb" role="tab" type="button">فیس/تنخواہ</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#ie_p" data-bs-toggle="tab" id="ie_tb" role="tab" type="button">انوینٹری/اخراجات</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#r_p" data-bs-toggle="tab" id="r_tb" role="tab" type="button">رپورٹس</button></li>
<li class="nav-item" role="presentation"><button class="nav-link" data-bs-target="#br_p" data-bs-toggle="tab" id="br_tb" role="tab" type="button">بیک اپ/بحالی</button></li>
</ul>
<div class="tab-content pt-3" id="m_tc">
<!-- Students Tab -->
<div class="tab-pane fade show active" id="s_p" role="tabpanel">
<h2>طلبہ کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" onclick="shSF()">نیا طالب علم شامل کریں</button>
<div class="card mb-3 no-print" id="s_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title" id="s_f_t">نیا طالب علم شامل کریں</h5>
<form id="s_f">
<input id="s_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="s_n">نام</label>
<input class="form-control" id="s_n" required="" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="s_fn">والد کا نام</label>
<input class="form-control" id="s_fn" required="" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="s_ag">عمر</label>
<input class="form-control" id="s_ag" required="" type="number"/>
</div>
<div class="mb-2">
<label class="form-label" for="s_cl">جماعت</label>
<select class="form-select" id="s_cl" required=""></select>
</div>
<div class="mb-2">
<label class="form-label" for="s_ad">داخلے کی تاریخ</label>
<input class="form-control" id="s_ad" required="" type="date"/>
</div>
<div class="mb-2">
<label class="form-label" for="s_cn">رابطہ نمبر</label>
<input class="form-control" id="s_cn" type="tel"/>
</div>
<div class="mb-2">
<label class="form-label" for="s_adr">پتہ</label>
<textarea class="form-control" id="s_adr" rows="2"></textarea>
</div>
<div class="mb-2" id="s_cf_c">
<label class="form-label">اضافی معلومات</label>
<!-- Custom fields will be added here -->
</div>
<button class="btn btn-sm btn-secondary" onclick="aCF('s_cf_c')" type="button">اضافی فیلڈ شامل کریں</button>
<button class="btn btn-success" id="s_sv_b" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clSF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>نام</th>
<th>والد کا نام</th>
<th>عمر</th>
<th>جماعت</th>
<th>داخلے کی تاریخ</th>
<th>رابطہ نمبر</th>
<th>پتہ</th>
<th id="s_cf_h">اضافی معلومات</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="s_tb">
<!-- Student rows will be added here -->
</tbody>
</table>
</div>
</div>
<!-- Teachers Tab -->
<div class="tab-pane fade" id="t_p" role="tabpanel">
<h2>اساتذہ کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" onclick="shTF()">نیا استاد شامل کریں</button>
<div class="card mb-3 no-print" id="t_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title" id="t_f_t">نیا استاد شامل کریں</h5>
<form id="t_f">
<input id="t_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="t_n">نام</label>
<input class="form-control" id="t_n" required="" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="t_ql">قابلیت</label>
<input class="form-control" id="t_ql" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="t_jd">شمولیت کی تاریخ</label>
<input class="form-control" id="t_jd" required="" type="date"/>
</div>
<div class="mb-2">
<label class="form-label" for="t_cn">رابطہ نمبر</label>
<input class="form-control" id="t_cn" type="tel"/>
</div>
<div class="mb-2">
<label class="form-label" for="t_adr">پتہ</label>
<textarea class="form-control" id="t_adr" rows="2"></textarea>
</div>
<div class="mb-2" id="t_cf_c">
<label class="form-label">اضافی معلومات</label>
<!-- Custom fields will be added here -->
</div>
<button class="btn btn-sm btn-secondary" onclick="aCF('t_cf_c')" type="button">اضافی فیلڈ شامل کریں</button>
<button class="btn btn-success" id="t_sv_b" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clTF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>نام</th>
<th>قابلیت</th>
<th>شمولیت کی تاریخ</th>
<th>رابطہ نمبر</th>
<th>پتہ</th>
<th id="t_cf_h">اضافی معلومات</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="t_tb">
<!-- Teacher rows will be added here -->
</tbody>
</table>
</div>
</div>
<!-- Classes Tab -->
<div class="tab-pane fade" id="c_p" role="tabpanel">
<h2>جماعتوں کا انتظام</h2>
<button class="btn btn-primary mb-3 no-print" onclick="shCF()">نئی جماعت بنائیں</button>
<div class="card mb-3 no-print" id="c_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title" id="c_f_t">نئی جماعت بنائیں</h5>
<form id="c_f">
<input id="c_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="c_n">جماعت/درس کا نام</label>
<input class="form-control" id="c_n" required="" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="c_tid">استاد منتخب کریں</label>
<select class="form-select" id="c_tid" required="">
<option value="">منتخب کریں...</option>
</select>
</div>
<div class="mb-2">
<label class="form-label" for="c_sids">طلبہ منتخب کریں</label>
<select class="form-select" id="c_sids" multiple="" required="" size="5">
<!-- Student options will be populated here -->
</select>
</div>
<button class="btn btn-success" id="c_sv_b" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clCF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>جماعت/درس</th>
<th>استاد</th>
<th>طلبہ</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="c_tb">
<!-- Class rows will be added here -->
</tbody>
</table>
</div>
</div>
<!-- Attendance Tab -->
<div class="tab-pane fade" id="a_p" role="tabpanel">
<h2>حاضری کا نظام</h2>
<div class="row mb-3 no-print">
<div class="col-md-4">
<label class="form-label" for="a_dt">تاریخ</label>
<input class="form-control" id="a_dt" type="date" value=""/>
</div>
<div class="col-md-4">
<label class="form-label" for="a_cl">جماعت</label>
<select class="form-select" id="a_cl">
<option value="">تمام جماعتیں</option>
</select>
</div>
<div class="col-md-4 align-self-end">
<button class="btn btn-info" onclick="lA()">حاضری لوڈ کریں</button>
<button class="btn btn-success" onclick="svA()">حاضری محفوظ کریں</button>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>طالب علم ID</th>
<th>نام</th>
<th>جماعت</th>
<th>حاضری</th>
</tr>
</thead>
<tbody id="a_tb">
<!-- Attendance rows will be added here -->
</tbody>
</table>
</div>
</div>
<!-- Fees/Salary Tab -->
<div class="tab-pane fade" id="fs_p" role="tabpanel">
<h2>فیس اور تنخواہ کا نظام</h2>
<div class="row">
<!-- Fee Management -->
<div class="col-md-6">
<h4>فیس کا انتظام</h4>
<button class="btn btn-primary mb-3 no-print" onclick="shFeeF()">فیس اندراج کریں</button>
<div class="card mb-3 no-print" id="fee_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title">فیس اندراج</h5>
<form id="fee_f">
<input id="fee_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="fee_sid">طالب علم</label>
<select class="form-select" id="fee_sid" required=""></select>
</div>
<div class="mb-2">
<label class="form-label" for="fee_amt">رقم</label>
<input class="form-control" id="fee_amt" required="" type="number"/>
</div>
<div class="mb-2">
<label class="form-label" for="fee_dt">تاریخ</label>
<input class="form-control" id="fee_dt" required="" type="date"/>
</div>
<div class="mb-2">
<label class="form-label" for="fee_st">حالت</label>
<select class="form-select" id="fee_st" required="">
<option value="واجب الادا">واجب الادا</option>
<option value="موصول">موصول</option>
</select>
</div>
<button class="btn btn-success" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clFeeF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>طالب علم</th>
<th>رقم</th>
<th>تاریخ</th>
<th>حالت</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="fee_tb"></tbody>
</table>
</div>
</div>
<!-- Salary Management -->
<div class="col-md-6">
<h4>تنخواہ کا انتظام</h4>
<button class="btn btn-primary mb-3 no-print" onclick="shSalF()">تنخواہ اندراج کریں</button>
<div class="card mb-3 no-print" id="sal_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title">تنخواہ اندراج</h5>
<form id="sal_f">
<input id="sal_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="sal_tid">استاد</label>
<select class="form-select" id="sal_tid" required=""></select>
</div>
<div class="mb-2">
<label class="form-label" for="sal_amt">رقم</label>
<input class="form-control" id="sal_amt" required="" type="number"/>
</div>
<div class="mb-2">
<label class="form-label" for="sal_dt">تاریخ</label>
<input class="form-control" id="sal_dt" required="" type="date"/>
</div>
<div class="mb-2">
<label class="form-label" for="sal_st">حالت</label>
<select class="form-select" id="sal_st" required="">
<option value="واجب الادا">واجب الادا</option>
<option value="ادا شدہ">ادا شدہ</option>
</select>
</div>
<button class="btn btn-success" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clSalF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>استاد</th>
<th>رقم</th>
<th>تاریخ</th>
<th>حالت</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="sal_tb"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Inventory/Expenses Tab -->
<div class="tab-pane fade" id="ie_p" role="tabpanel">
<h2>مدرسہ انوینٹری اور اخراجات</h2>
<div class="row">
<!-- Inventory Management -->
<div class="col-md-6">
<h4>انوینٹری</h4>
<button class="btn btn-primary mb-3 no-print" onclick="shInvF()">نیا آئٹم شامل کریں</button>
<div class="card mb-3 no-print" id="inv_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title">نیا انوینٹری آئٹم</h5>
<form id="inv_f">
<input id="inv_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="inv_n">آئٹم کا نام</label>
<input class="form-control" id="inv_n" required="" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="inv_q">مقدار</label>
<input class="form-control" id="inv_q" required="" type="number"/>
</div>
<div class="mb-2">
<label class="form-label" for="inv_dt">تاریخ</label>
<input class="form-control" id="inv_dt" required="" type="date"/>
</div>
<button class="btn btn-success" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clInvF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>آئٹم</th>
<th>مقدار</th>
<th>تاریخ</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="inv_tb"></tbody>
</table>
</div>
</div>
<!-- Expense Management -->
<div class="col-md-6">
<h4>آمدنی/اخراجات</h4>
<button class="btn btn-primary mb-3 no-print" onclick="shExpF()">نیا اندراج کریں</button>
<div class="card mb-3 no-print" id="exp_f_c" style="display: none;">
<div class="card-body">
<h5 class="card-title">نیا آمدنی/خرچ اندراج</h5>
<form id="exp_f">
<input id="exp_id" type="hidden"/>
<div class="mb-2">
<label class="form-label" for="exp_ty">قسم</label>
<select class="form-select" id="exp_ty" required="">
<option value="آمدنی">آمدنی</option>
<option value="خرچ">خرچ</option>
</select>
</div>
<div class="mb-2">
<label class="form-label" for="exp_ds">تفصیل</label>
<input class="form-control" id="exp_ds" required="" type="text"/>
</div>
<div class="mb-2">
<label class="form-label" for="exp_amt">رقم</label>
<input class="form-control" id="exp_amt" required="" type="number"/>
</div>
<div class="mb-2">
<label class="form-label" for="exp_dt">تاریخ</label>
<input class="form-control" id="exp_dt" required="" type="date"/>
</div>
<button class="btn btn-success" type="submit">محفوظ کریں</button>
<button class="btn btn-secondary" onclick="clExpF()" type="button">منسوخ کریں</button>
</form>
</div>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
<th>ID</th>
<th>قسم</th>
<th>تفصیل</th>
<th>رقم</th>
<th>تاریخ</th>
<th class="no-print">اعمال</th>
</tr>
</thead>
<tbody id="exp_tb"></tbody>
</table>
</div>
</div>
</div>
</div>
<!-- Reports Tab -->
<div class="tab-pane fade" id="r_p" role="tabpanel">
<h2>رپورٹس</h2>
<div class="mb-3 no-print">
<select class="form-select mb-2" id="r_ty" onchange="shROpts()">
<option value="">رپورٹ منتخب کریں...</option>
<option value="s">طلبہ کی فہرست</option>
<option value="a">حاضری رپورٹ</option>
<option value="f_p">واجب الادا فیس</option>
<option value="f_r">موصول شدہ فیس</option>
<option value="sal_p">واجب الادا تنخواہ</option>
<option value="sal_pd">ادا شدہ تنخواہ</option>
<option value="exp">اخراجات کا خلاصہ</option>
<option value="inc">آمدنی کا خلاصہ</option>
</select>
<div class="mb-2" id="r_opts" style="display: none;">
<div id="a_r_opts" style="display: none;">
<label class="form-label" for="r_a_dt_s">شروع کی تاریخ</label>
<input class="form-control mb-1" id="r_a_dt_s" type="date"/>
<label class="form-label" for="r_a_dt_e">اختتام کی تاریخ</label>
<input class="form-control mb-1" id="r_a_dt_e" type="date"/>
<label class="form-label" for="r_a_sid">طالب علم</label>
<select class="form-select mb-1" id="r_a_sid"><option value="">تمام طلبہ</option></select>
<label class="form-label" for="r_a_cid">جماعت</label>
<select class="form-select mb-1" id="r_a_cid"><option value="">تمام جماعتیں</option></select>
</div>
<div id="f_r_opts" style="display: none;">
<label class="form-label" for="r_f_dt_s">شروع کی تاریخ</label>
<input class="form-control mb-1" id="r_f_dt_s" type="date"/>
<label class="form-label" for="r_f_dt_e">اختتام کی تاریخ</label>
<input class="form-control mb-1" id="r_f_dt_e" type="date"/>
<label class="form-label" for="r_f_sid">طالب علم</label>
<select class="form-select mb-1" id="r_f_sid"><option value="">تمام طلبہ</option></select>
</div>
<div id="sal_r_opts" style="display: none;">
<label class="form-label" for="r_sal_dt_s">شروع کی تاریخ</label>
<input class="form-control mb-1" id="r_sal_dt_s" type="date"/>
<label class="form-label" for="r_sal_dt_e">اختتام کی تاریخ</label>
<input class="form-control mb-1" id="r_sal_dt_e" type="date"/>
<label class="form-label" for="r_sal_tid">استاد</label>
<select class="form-select mb-1" id="r_sal_tid"><option value="">تمام اساتذہ</option></select>
</div>
<div id="ie_r_opts" style="display: none;">
<label class="form-label" for="r_ie_dt_s">شروع کی تاریخ</label>
<input class="form-control mb-1" id="r_ie_dt_s" type="date"/>
<label class="form-label" for="r_ie_dt_e">اختتام کی تاریخ</label>
<input class="form-control mb-1" id="r_ie_dt_e" type="date"/>
</div>
</div>
<button class="btn btn-info" onclick="gR()">رپورٹ بنائیں</button>
<button class="btn btn-secondary" id="pr_b" onclick="prR()" style="display:none;">پرنٹ کریں</button>
<button class="btn btn-success" id="exp_b" onclick="expR()" style="display:none;">CSV ایکسپورٹ کریں</button>
</div>
<div id="p_a">
<h4 class="text-center" id="r_h"></h4>
<div class="table-responsive">
<table class="table table-bordered" id="r_t">
<thead id="r_th"></thead>
<tbody id="r_tb"></tbody>
</table>
</div>
</div>
</div>
<!-- Backup/Restore Tab -->
<div class="tab-pane fade" id="br_p" role="tabpanel">
<h2>بیک اپ اور بحالی</h2>
<div class="card no-print">
<div class="card-body">
<h5 class="card-title">ڈیٹا بیک اپ</h5>
<p>تمام مدرسہ ڈیٹا کا بیک اپ ایک فائل میں محفوظ کریں۔</p>
<button class="btn btn-success" onclick="bkD()">بیک اپ بنائیں</button>
<hr/>
<h5 class="card-title mt-3">ڈیٹا بحال کریں</h5>
<p>بیک اپ فائل سے ڈیٹا بحال کریں۔ خبردار: موجودہ تمام ڈیٹا حذف ہو جائے گا۔</p>
<div class="mb-3">
<label class="form-label" for="rs_f">بیک اپ فائل منتخب کریں (.json)</label>
<input accept=".json" class="form-control" id="rs_f" type="file"/>
</div>
<button class="btn btn-danger" onclick="rsD()">ڈیٹا بحال کریں</button>
</div>
</div>
</div>
</div>
</div>
<script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
        const dbn = 'dmm_db_v4';
        const dbv = 1;
        const os_s = 's'; // Students
        const os_t = 't'; // Teachers
        const os_c = 'c'; // Classes
        const os_a = 'a'; // Attendance
        const os_f = 'f'; // Fees
        const os_sl = 'sl'; // Salaries
        const os_i = 'i'; // Inventory
        const os_e = 'e'; // Expenses
        let db;

        const gid = (id) => document.getElementById(id);
        const qsa = (sel) => document.querySelectorAll(sel);
        const nEl = (tag) => document.createElement(tag);

        // --- IndexedDB Operations ---
        function oDb() {
            return new Promise((res, rej) => {
                const req = indexedDB.open(dbn, dbv);
                req.onerror = (e) => { console.error("Database error:", e.target.error); rej("Database error"); };
                req.onsuccess = (e) => { db = e.target.result; res(db); };
                req.onupgradeneeded = (e) => {
                    db = e.target.result;
                    if (!db.objectStoreNames.contains(os_s)) db.createObjectStore(os_s, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(os_t)) db.createObjectStore(os_t, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(os_c)) db.createObjectStore(os_c, { keyPath: 'id', autoIncrement: true });
                    const aOs = db.createObjectStore(os_a, { keyPath: ['sid', 'dt'] }); // Attendance: studentId + date
                    aOs.createIndex('dtIdx', 'dt', { unique: false });
                    aOs.createIndex('cidIdx', 'cid', { unique: false });
                    if (!db.objectStoreNames.contains(os_f)) db.createObjectStore(os_f, { keyPath: 'id', autoIncrement: true }).createIndex('sidIdx', 'sid', { unique: false });
                    if (!db.objectStoreNames.contains(os_sl)) db.createObjectStore(os_sl, { keyPath: 'id', autoIncrement: true }).createIndex('tidIdx', 'tid', { unique: false });
                    if (!db.objectStoreNames.contains(os_i)) db.createObjectStore(os_i, { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains(os_e)) db.createObjectStore(os_e, { keyPath: 'id', autoIncrement: true }).createIndex('typeIdx', 'ty', { unique: false });
                    console.log("DB Upgrade needed");
                };
            });
        }

        function gt(osn, mode = 'readonly') {
            if (!db) { console.error("DB not initialized"); return null; }
            return db.transaction(osn, mode).objectStore(osn);
        }

        function aR(osn, d) { // Add Record
            return new Promise((res, rej) => {
                const os = gt(osn, 'readwrite');
                if (!os) return rej("Object store not found");
                const req = os.add(d);
                req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => { console.error(`Error adding to ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

        function gaR(osn) { // Get All Records
            return new Promise((res, rej) => {
                const os = gt(osn);
                if (!os) return rej("Object store not found");
                const req = os.getAll();
                req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => { console.error(`Error getting all from ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

         function gR(osn, id) { // Get Record by ID
            return new Promise((res, rej) => {
                const os = gt(osn);
                if (!os) return rej("Object store not found");
                const req = os.get(id);
                req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => { console.error(`Error getting record ${id} from ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

        function uR(osn, d) { // Update Record
            return new Promise((res, rej) => {
                const os = gt(osn, 'readwrite');
                 if (!os) return rej("Object store not found");
                const req = os.put(d);
                req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => { console.error(`Error updating in ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

        function dR(osn, id) { // Delete Record
            return new Promise((res, rej) => {
                const os = gt(osn, 'readwrite');
                if (!os) return rej("Object store not found");
                const req = os.delete(id);
                req.onsuccess = (e) => res();
                req.onerror = (e) => { console.error(`Error deleting ${id} from ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

        function cOs(osn) { // Clear Object Store
             return new Promise((res, rej) => {
                const os = gt(osn, 'readwrite');
                if (!os) return rej("Object store not found");
                const req = os.clear();
                req.onsuccess = (e) => res();
                req.onerror = (e) => { console.error(`Error clearing ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

        function gIdx(osn, idx, ky) { // Get by Index
             return new Promise((res, rej) => {
                const os = gt(osn);
                if (!os) return rej("Object store not found");
                const index = os.index(idx);
                const req = index.getAll(ky);
                 req.onsuccess = (e) => res(e.target.result);
                req.onerror = (e) => { console.error(`Error getting by index ${idx} from ${osn}:`, e.target.error); rej(e.target.error); };
            });
        }

         // --- Custom Fields ---
        function aCF(cId) { // Add Custom Field UI
             const c = gid(cId);
            const fg = nEl('div');
            fg.className = 'custom-field-group input-group input-group-sm mb-1';
            fg.innerHTML = `
                <input type="text" class="form-control cfk" placeholder="فیلڈ کا نام">
                <input type="text" class="form-control cfv" placeholder="ویلیو">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">x</button>
            `;
            c.appendChild(fg);
        }

        function gCFV(cId) { // Get Custom Field Values
            const cfs = {};
            qsa(`#${cId} .custom-field-group`).forEach(fg => {
                const k = fg.querySelector('.cfk').value.trim();
                const v = fg.querySelector('.cfv').value.trim();
                 if (k) cfs[k] = v;
            });
            return cfs;
        }

        function sCFV(cId, cfs) { // Set Custom Field Values
             const c = gid(cId);
             // Clear existing custom fields first, keeping the label
             const lbl = c.querySelector('label');
             c.innerHTML = '';
             if (lbl) c.appendChild(lbl);

            if (cfs) {
                for (const k in cfs) {
                     const fg = nEl('div');
                    fg.className = 'custom-field-group input-group input-group-sm mb-1';
                    fg.innerHTML = `
                        <input type="text" class="form-control cfk" value="${k}" placeholder="فیلڈ کا نام">
                        <input type="text" class="form-control cfv" value="${cfs[k]}" placeholder="ویلیو">
                         <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">x</button>
                    `;
                    c.appendChild(fg);
                }
            }
        }

        function rCFH(cfData, thId, tbId) { // Render Custom Field Headers/Data
             const cfKeys = new Set();
             cfData.forEach(item => {
                if (item.cf) {
                    Object.keys(item.cf).forEach(key => cfKeys.add(key));
                 }
            });

            const th = gid(thId);
             const tb = gid(tbId);
            // Clear existing CF headers/columns except the placeholder
            qsa(`#${thId} .cfh`).forEach(el => el.remove());
            qsa(`#${tbId} .cfd`).forEach(el => el.remove());

             const sortedKeys = Array.from(cfKeys).sort();

             // Add new headers
            sortedKeys.forEach(key => {
                 const thEl = nEl('th');
                 thEl.className = 'cfh';
                 thEl.textContent = key;
                 th.parentNode.insertBefore(thEl, th.nextSibling); // Insert after the main CF header
             });

            // Add data cells for each row
            qsa(`#${tbId} tr`).forEach((tr, index) => {
                const item = cfData[index];
                const cf = item.cf || {};
                 const actionCell = tr.querySelector('td:last-child'); // Assuming last cell is actions
                sortedKeys.forEach(key => {
                    const tdEl = nEl('td');
                    tdEl.className = 'cfd';
                    tdEl.textContent = cf[key] || '-';
                    tr.insertBefore(tdEl, actionCell); // Insert before the action cell
                });
            });
        }

        // --- Student Management ---
        const sFC = gid('s_f_c');
        const sF = gid('s_f');
        const sFT = gid('s_f_t');
        const sId = gid('s_id');
        const sN = gid('s_n');
        const sFN = gid('s_fn');
        const sAg = gid('s_ag');
        const sCl = gid('s_cl');
        const sAd = gid('s_ad');
        const sCn = gid('s_cn');
        const sAdr = gid('s_adr');
        const sTb = gid('s_tb');

        function shSF(id = null) {
            clSF();
            sFT.textContent = id ? 'طالب علم میں ترمیم کریں' : 'نیا طالب علم شامل کریں';
            sFC.style.display = 'block';
            if (id) {
                gR(os_s, id).then(s => {
                    if (s) {
                        sId.value = s.id;
                        sN.value = s.n;
                        sFN.value = s.fn;
                        sAg.value = s.ag;
                        sCl.value = s.cid;
                        sAd.value = s.ad;
                        sCn.value = s.cn;
                        sAdr.value = s.adr;
                        sCFV('s_cf_c', s.cf);
                    }
                });
            }
        }

        function clSF() {
            sF.reset();
            sId.value = '';
            sFC.style.display = 'none';
            sCFV('s_cf_c', null); // Clear custom fields UI
        }

        sF.onsubmit = async (e) => {
            e.preventDefault();
            const sData = {
                n: sN.value,
                fn: sFN.value,
                ag: parseInt(sAg.value),
                cid: parseInt(sCl.value),
                ad: sAd.value,
                cn: sCn.value,
                adr: sAdr.value,
                cf: gCFV('s_cf_c')
            };
            try {
                 if (sId.value) {
                    sData.id = parseInt(sId.value);
                    await uR(os_s, sData);
                } else {
                    await aR(os_s, sData);
                }
                clSF();
                lS();
                pSls(); // Update student selectors elsewhere
            } catch (err) { console.error("Error saving student:", err); alert('طالب علم کو محفوظ کرنے میں خرابی: ' + err); }
        };

        async function lS() { // Load Students
            try {
                const studs = await gaR(os_s);
                const classes = await gaR(os_c);
                 const classMap = classes.reduce((map, c) => { map[c.id] = c.n; return map; }, {});

                sTb.innerHTML = '';
                studs.forEach(s => {
                    const tr = nEl('tr');
                    tr.innerHTML = `
                        <td>${s.id}</td>
                        <td>${s.n}</td>
                        <td>${s.fn}</td>
                        <td>${s.ag}</td>
                        <td>${classMap[s.cid] || 'N/A'}</td>
                        <td>${s.ad}</td>
                        <td>${s.cn || '-'}</td>
                        <td>${s.adr || '-'}</td>
                         <td data-cf-placeholder></td> <!-- Placeholder for custom fields -->
                        <td class="no-print">
                            <button class="btn btn-sm btn-warning" onclick="shSF(${s.id})">ترمیم</button>
                            <button class="btn btn-sm btn-danger" onclick="dS(${s.id})">حذف کریں</button>
                        </td>
                    `;
                    // Remove placeholder and insert action cell correctly
                    const cfPlaceholder = tr.querySelector('[data-cf-placeholder]');
                     const actionCell = tr.querySelector('td:last-child');
                     cfPlaceholder.remove(); // Remove placeholder
                     tr.insertBefore(actionCell, null); // Append action cell at the end
                    sTb.appendChild(tr);
                });
                 rCFH(studs, 's_cf_h', 's_tb'); // Render custom fields header and data
            } catch (err) { console.error("Error loading students:", err); }
        }

        async function dS(id) { // Delete Student
            if (confirm('کیا آپ واقعی اس طالب علم کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await dR(os_s, id);
                     // Also delete related attendance and fees? (Optional, maybe add later if needed)
                    lS();
                    pSls();
                } catch (err) { console.error("Error deleting student:", err); alert('طالب علم کو حذف کرنے میں خرابی: ' + err); }
            }
        }

         // --- Teacher Management ---
        const tFC = gid('t_f_c');
        const tF = gid('t_f');
        const tFT = gid('t_f_t');
        const tId = gid('t_id');
        const tN = gid('t_n');
        const tQl = gid('t_ql');
        const tJd = gid('t_jd');
        const tCn = gid('t_cn');
        const tAdr = gid('t_adr');
        const tTb = gid('t_tb');

        function shTF(id = null) {
            clTF();
            tFT.textContent = id ? 'استاد میں ترمیم کریں' : 'نیا استاد شامل کریں';
             tFC.style.display = 'block';
            if (id) {
                gR(os_t, id).then(t => {
                    if (t) {
                        tId.value = t.id;
                        tN.value = t.n;
                        tQl.value = t.ql;
                        tJd.value = t.jd;
                        tCn.value = t.cn;
                        tAdr.value = t.adr;
                        sCFV('t_cf_c', t.cf);
                    }
                });
            }
        }

        function clTF() {
            tF.reset();
            tId.value = '';
            tFC.style.display = 'none';
             sCFV('t_cf_c', null);
        }

        tF.onsubmit = async (e) => {
            e.preventDefault();
            const tData = {
                n: tN.value,
                ql: tQl.value,
                jd: tJd.value,
                cn: tCn.value,
                adr: tAdr.value,
                cf: gCFV('t_cf_c')
            };
            try {
                 if (tId.value) {
                    tData.id = parseInt(tId.value);
                    await uR(os_t, tData);
                } else {
                    await aR(os_t, tData);
                }
                clTF();
                lT();
                 pTls(); // Update teacher selectors elsewhere
            } catch (err) { console.error("Error saving teacher:", err); alert('استاد کو محفوظ کرنے میں خرابی: ' + err); }
        };

        async function lT() { // Load Teachers
            try {
                const teachs = await gaR(os_t);
                tTb.innerHTML = '';
                teachs.forEach(t => {
                    const tr = nEl('tr');
                    tr.innerHTML = `
                        <td>${t.id}</td>
                        <td>${t.n}</td>
                        <td>${t.ql || '-'}</td>
                        <td>${t.jd}</td>
                        <td>${t.cn || '-'}</td>
                        <td>${t.adr || '-'}</td>
                        <td data-cf-placeholder></td>
                        <td class="no-print">
                            <button class="btn btn-sm btn-warning" onclick="shTF(${t.id})">ترمیم</button>
                            <button class="btn btn-sm btn-danger" onclick="dT(${t.id})">حذف کریں</button>
                        </td>
                    `;
                    const cfPlaceholder = tr.querySelector('[data-cf-placeholder]');
                    const actionCell = tr.querySelector('td:last-child');
                    cfPlaceholder.remove();
                    tr.insertBefore(actionCell, null);
                    tTb.appendChild(tr);
                });
                rCFH(teachs, 't_cf_h', 't_tb');
            } catch (err) { console.error("Error loading teachers:", err); }
        }

        async function dT(id) { // Delete Teacher
            if (confirm('کیا آپ واقعی اس استاد کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await dR(os_t, id);
                     // Should we unassign this teacher from classes?
                    await uCfT(id); // Unassign from classes
                    lT();
                    pTls();
                    lC(); // Reload classes as teacher assignment changed
                } catch (err) { console.error("Error deleting teacher:", err); alert('استاد کو حذف کرنے میں خرابی: ' + err); }
            }
        }

        // Function to unassign deleted teacher from classes
        async function uCfT(tid) {
             try {
                 const classes = await gaR(os_c);
                for (const c of classes) {
                    if (c.tid === tid) {
                         c.tid = null; // Or set to a default 'unassigned' ID if applicable
                        await uR(os_c, c);
                    }
                }
            } catch (err) { console.error("Error unassigning teacher:", err); }
        }


         // --- Class Management ---
        const cFC = gid('c_f_c');
        const cF = gid('c_f');
        const cFT = gid('c_f_t');
        const cId = gid('c_id');
        const cN = gid('c_n');
        const cTid = gid('c_tid');
        const cSids = gid('c_sids');
        const cTb = gid('c_tb');

        function shCF(id = null) {
            clCF();
            cFT.textContent = id ? 'جماعت میں ترمیم کریں' : 'نئی جماعت بنائیں';
             cFC.style.display = 'block';
            if (id) {
                gR(os_c, id).then(c => {
                    if (c) {
                        cId.value = c.id;
                        cN.value = c.n;
                        cTid.value = c.tid || '';
                         // Set selected students
                        Array.from(cSids.options).forEach(opt => {
                             opt.selected = c.sids && c.sids.includes(parseInt(opt.value));
                        });
                    }
                });
            }
        }

        function clCF() {
            cF.reset();
            cId.value = '';
            Array.from(cSids.options).forEach(opt => opt.selected = false);
            cFC.style.display = 'none';
        }

        cF.onsubmit = async (e) => {
            e.preventDefault();
             const selSids = Array.from(cSids.selectedOptions).map(opt => parseInt(opt.value));
            const cData = {
                n: cN.value,
                tid: cTid.value ? parseInt(cTid.value) : null,
                 sids: selSids
            };
            try {
                 if (cId.value) {
                    cData.id = parseInt(cId.value);
                    await uR(os_c, cData);
                } else {
                    await aR(os_c, cData);
                }
                clCF();
                lC();
                pCls(); // Update class selectors elsewhere
            } catch (err) { console.error("Error saving class:", err); alert('جماعت کو محفوظ کرنے میں خرابی: ' + err); }
        };

        async function lC() { // Load Classes
            try {
                const classes = await gaR(os_c);
                const teachs = await gaR(os_t);
                const studs = await gaR(os_s);
                const tMap = teachs.reduce((map, t) => { map[t.id] = t.n; return map; }, {});
                const sMap = studs.reduce((map, s) => { map[s.id] = s.n; return map; }, {});

                cTb.innerHTML = '';
                classes.forEach(c => {
                    const tr = nEl('tr');
                     const sNames = (c.sids || []).map(sid => sMap[sid] || `ID: ${sid}`).join(', ');
                    tr.innerHTML = `
                        <td>${c.id}</td>
                        <td>${c.n}</td>
                        <td>${c.tid ? tMap[c.tid] : 'کوئی نہیں'}</td>
                        <td>${sNames || 'کوئی نہیں'}</td>
                        <td class="no-print">
                            <button class="btn btn-sm btn-warning" onclick="shCF(${c.id})">ترمیم</button>
                            <button class="btn btn-sm btn-danger" onclick="dC(${c.id})">حذف کریں</button>
                        </td>
                    `;
                    cTb.appendChild(tr);
                });
            } catch (err) { console.error("Error loading classes:", err); }
        }

        async function dC(id) { // Delete Class
            if (confirm('کیا آپ واقعی اس جماعت کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await dR(os_c, id);
                     // Optionally update student records to remove this class ID?
                    lC();
                    pCls();
                } catch (err) { console.error("Error deleting class:", err); alert('جماعت کو حذف کرنے میں خرابی: ' + err); }
            }
        }

        // --- Attendance Management ---
        const aDt = gid('a_dt');
        const aCl = gid('a_cl');
        const aTb = gid('a_tb');

        async function lA() { // Load Attendance form for selected date/class
             const dt = aDt.value;
            const cid = aCl.value ? parseInt(aCl.value) : null;
            if (!dt) { alert("براہ کرم تاریخ منتخب کریں۔"); return; }

            try {
                const studs = await gaR(os_s);
                 const classes = await gaR(os_c);
                const classMap = classes.reduce((map, c) => { map[c.id] = c.n; return map; }, {});

                 // Get existing attendance for this date
                 const existingAtt = (await gIdx(os_a, 'dtIdx', dt)) || [];
                 const attMap = existingAtt.reduce((map, att) => { map[att.sid] = att.st; return map; }, {});

                aTb.innerHTML = '';
                 const filteredStuds = studs.filter(s => !cid || s.cid === cid);

                filteredStuds.forEach(s => {
                    const tr = nEl('tr');
                    const currentStatus = attMap[s.id] || 'P'; // Default to Present (P) if no record exists
                    tr.innerHTML = `
                        <td>${s.id}</td>
                        <td>${s.n}</td>
                        <td>${classMap[s.cid] || 'N/A'}</td>
                        <td>
                            <select class="form-select form-select-sm a_st" data-sid="${s.id}" data-cid="${s.cid || ''}">
                                <option value="P" ${currentStatus === 'P' ? 'selected' : ''}>حاضر</option>
                                <option value="A" ${currentStatus === 'A' ? 'selected' : ''}>غیر حاضر</option>
                                <option value="L" ${currentStatus === 'L' ? 'selected' : ''}>رخصت</option>
                            </select>
                        </td>
                    `;
                    aTb.appendChild(tr);
                });
            } catch (err) { console.error("Error loading attendance:", err); alert('حاضری لوڈ کرنے میں خرابی: ' + err); }
        }

        async function svA() { // Save Attendance
            const dt = aDt.value;
            if (!dt) { alert("براہ کرم تاریخ منتخب کریں۔"); return; }

            const attRecords = [];
            qsa('#a_tb tr').forEach(tr => {
                 const sel = tr.querySelector('.a_st');
                 attRecords.push({
                    sid: parseInt(sel.getAttribute('data-sid')),
                    cid: sel.getAttribute('data-cid') ? parseInt(sel.getAttribute('data-cid')) : null,
                    dt: dt,
                    st: sel.value // Status (P/A/L)
                });
            });

            try {
                const tx = db.transaction(os_a, 'readwrite');
                const os = tx.objectStore(os_a);
                 // Use put to overwrite existing records for the same student/date
                 for (const rec of attRecords) {
                    os.put(rec);
                 }
                await tx.done; // Wait for transaction to complete
                alert('حاضری کامیابی سے محفوظ ہو گئی۔');
             } catch (err) { console.error("Error saving attendance:", err); alert('حاضری محفوظ کرنے میں خرابی: ' + err); }
        }

         // --- Fee/Salary Management ---
        const feeFC = gid('fee_f_c');
        const feeF = gid('fee_f');
        const feeId = gid('fee_id');
        const feeSid = gid('fee_sid');
        const feeAmt = gid('fee_amt');
        const feeDt = gid('fee_dt');
        const feeSt = gid('fee_st');
        const feeTb = gid('fee_tb');

        const salFC = gid('sal_f_c');
        const salF = gid('sal_f');
        const salId = gid('sal_id');
        const salTid = gid('sal_tid');
        const salAmt = gid('sal_amt');
        const salDt = gid('sal_dt');
        const salSt = gid('sal_st');
        const salTb = gid('sal_tb');

        function shFeeF(id = null) {
            clFeeF();
            feeFC.style.display = 'block';
            if (id) {
                gR(os_f, id).then(f => {
                    if (f) {
                        feeId.value = f.id;
                        feeSid.value = f.sid;
                        feeAmt.value = f.amt;
                        feeDt.value = f.dt;
                        feeSt.value = f.st;
                    }
                });
            } else {
                feeDt.valueAsDate = new Date(); // Default to today
            }
        }
        function clFeeF() { feeF.reset(); feeId.value = ''; feeFC.style.display = 'none'; }

        feeF.onsubmit = async (e) => {
             e.preventDefault();
            const data = { sid: parseInt(feeSid.value), amt: parseFloat(feeAmt.value), dt: feeDt.value, st: feeSt.value };
            try {
                 if (feeId.value) { data.id = parseInt(feeId.value); await uR(os_f, data); }
                 else { await aR(os_f, data); }
                clFeeF(); lFees();
            } catch (err) { console.error("Fee Save Error:", err); alert("فیس محفوظ کرنے میں خرابی: " + err); }
        };

        async function lFees() {
            try {
                const fees = await gaR(os_f);
                const studs = await gaR(os_s);
                const sMap = studs.reduce((map, s) => { map[s.id] = s.n; return map; }, {});
                feeTb.innerHTML = '';
                fees.sort((a,b) => b.id - a.id).forEach(f => { // Show newest first
                    const tr = nEl('tr');
                    tr.innerHTML = `<td>${f.id}</td><td>${sMap[f.sid] || 'نامعلوم'}</td><td>${f.amt}</td><td>${f.dt}</td><td>${f.st}</td>
                                    <td class="no-print"><button class="btn btn-sm btn-warning" onclick="shFeeF(${f.id})">ترمیم</button> <button class="btn btn-sm btn-danger" onclick="dFee(${f.id})">حذف</button></td>`;
                     feeTb.appendChild(tr);
                });
            } catch (err) { console.error("Fee Load Error:", err); }
        }
         async function dFee(id) { if (confirm('کیا آپ واقعی اس فیس اندراج کو حذف کرنا چاہتے ہیں؟')) { try { await dR(os_f, id); lFees(); } catch (err) { alert("فیس حذف کرنے میں خرابی: "+err); } } }


         function shSalF(id = null) {
            clSalF();
            salFC.style.display = 'block';
            if (id) {
                gR(os_sl, id).then(s => {
                    if (s) {
                        salId.value = s.id;
                        salTid.value = s.tid;
                        salAmt.value = s.amt;
                        salDt.value = s.dt;
                        salSt.value = s.st;
                    }
                });
            } else {
                 salDt.valueAsDate = new Date();
            }
        }
        function clSalF() { salF.reset(); salId.value = ''; salFC.style.display = 'none'; }

         salF.onsubmit = async (e) => {
            e.preventDefault();
             const data = { tid: parseInt(salTid.value), amt: parseFloat(salAmt.value), dt: salDt.value, st: salSt.value };
            try {
                if (salId.value) { data.id = parseInt(salId.value); await uR(os_sl, data); }
                else { await aR(os_sl, data); }
                 clSalF(); lSals();
            } catch (err) { console.error("Salary Save Error:", err); alert("تنخواہ محفوظ کرنے میں خرابی: " + err); }
        };

        async function lSals() {
            try {
                const sals = await gaR(os_sl);
                const teachs = await gaR(os_t);
                const tMap = teachs.reduce((map, t) => { map[t.id] = t.n; return map; }, {});
                salTb.innerHTML = '';
                 sals.sort((a,b) => b.id - a.id).forEach(s => {
                    const tr = nEl('tr');
                    tr.innerHTML = `<td>${s.id}</td><td>${tMap[s.tid] || 'نامعلوم'}</td><td>${s.amt}</td><td>${s.dt}</td><td>${s.st}</td>
                                    <td class="no-print"><button class="btn btn-sm btn-warning" onclick="shSalF(${s.id})">ترمیم</button> <button class="btn btn-sm btn-danger" onclick="dSal(${s.id})">حذف</button></td>`;
                    salTb.appendChild(tr);
                });
             } catch (err) { console.error("Salary Load Error:", err); }
        }
         async function dSal(id) { if (confirm('کیا آپ واقعی اس تنخواہ اندراج کو حذف کرنا چاہتے ہیں؟')) { try { await dR(os_sl, id); lSals(); } catch (err) { alert("تنخواہ حذف کرنے میں خرابی: "+err); } } }

         // --- Inventory/Expense Management ---
        const invFC = gid('inv_f_c');
        const invF = gid('inv_f');
        const invId = gid('inv_id');
        const invN = gid('inv_n');
        const invQ = gid('inv_q');
        const invDt = gid('inv_dt');
        const invTb = gid('inv_tb');

         const expFC = gid('exp_f_c');
        const expF = gid('exp_f');
        const expId = gid('exp_id');
        const expTy = gid('exp_ty');
        const expDs = gid('exp_ds');
        const expAmt = gid('exp_amt');
        const expDt = gid('exp_dt');
        const expTb = gid('exp_tb');

        function shInvF(id = null) {
             clInvF(); invFC.style.display = 'block';
             if(id) { gR(os_i, id).then(i => { if(i){ invId.value=i.id; invN.value=i.n; invQ.value=i.q; invDt.value=i.dt; } }); }
             else { invDt.valueAsDate = new Date(); }
        }
        function clInvF() { invF.reset(); invId.value=''; invFC.style.display='none'; }

        invF.onsubmit = async (e) => {
             e.preventDefault();
            const data = { n: invN.value, q: parseInt(invQ.value), dt: invDt.value };
             try {
                if(invId.value){ data.id = parseInt(invId.value); await uR(os_i, data); }
                else { await aR(os_i, data); }
                 clInvF(); lInv();
             } catch(err) { console.error("Inv Save Error:", err); alert("انوینٹری محفوظ کرنے میں خرابی: "+err); }
        };
        async function lInv() {
            try {
                 const items = await gaR(os_i); invTb.innerHTML = '';
                 items.sort((a,b) => b.id - a.id).forEach(i => {
                     const tr=nEl('tr'); tr.innerHTML = `<td>${i.id}</td><td>${i.n}</td><td>${i.q}</td><td>${i.dt}</td>
                     <td class="no-print"><button class="btn btn-sm btn-warning" onclick="shInvF(${i.id})">ترمیم</button> <button class="btn btn-sm btn-danger" onclick="dInv(${i.id})">حذف</button></td>`;
                     invTb.appendChild(tr);
                 });
             } catch (err) { console.error("Inv Load Error:", err); }
        }
        async function dInv(id) { if(confirm('کیا آپ واقعی اس آئٹم کو حذف کرنا چاہتے ہیں؟')) { try { await dR(os_i, id); lInv(); } catch(err) { alert("آئٹم حذف کرنے میں خرابی: "+err); } } }

        function shExpF(id = null) {
             clExpF(); expFC.style.display = 'block';
             if(id) { gR(os_e, id).then(e => { if(e){ expId.value=e.id; expTy.value=e.ty; expDs.value=e.ds; expAmt.value=e.amt; expDt.value=e.dt; } }); }
             else { expDt.valueAsDate = new Date(); }
        }
        function clExpF() { expF.reset(); expId.value=''; expFC.style.display='none'; }

        expF.onsubmit = async (e) => {
             e.preventDefault();
             const data = { ty: expTy.value, ds: expDs.value, amt: parseFloat(expAmt.value), dt: expDt.value };
             try {
                 if(expId.value){ data.id = parseInt(expId.value); await uR(os_e, data); }
                 else { await aR(os_e, data); }
                clExpF(); lExp();
            } catch(err) { console.error("Exp Save Error:", err); alert("اندراج محفوظ کرنے میں خرابی: "+err); }
        };
        async function lExp() {
            try {
                 const items = await gaR(os_e); expTb.innerHTML = '';
                 items.sort((a,b) => b.id - a.id).forEach(e => {
                    const tr=nEl('tr'); tr.innerHTML = `<td>${e.id}</td><td>${e.ty}</td><td>${e.ds}</td><td>${e.amt}</td><td>${e.dt}</td>
                    <td class="no-print"><button class="btn btn-sm btn-warning" onclick="shExpF(${e.id})">ترمیم</button> <button class="btn btn-sm btn-danger" onclick="dExp(${e.id})">حذف</button></td>`;
                     expTb.appendChild(tr);
                });
            } catch (err) { console.error("Exp Load Error:", err); }
        }
         async function dExp(id) { if(confirm('کیا آپ واقعی اس اندراج کو حذف کرنا چاہتے ہیں؟')) { try { await dR(os_e, id); lExp(); } catch(err) { alert("اندراج حذف کرنے میں خرابی: "+err); } } }

        // --- Reports ---
         const rT = gid('r_t'); // Report Table
         const rTh = gid('r_th'); // Report Table Head
         const rTb = gid('r_tb'); // Report Table Body
         const rH = gid('r_h'); // Report Heading
         const rTy = gid('r_ty'); // Report Type Select
         const rOpts = gid('r_opts'); // Report Options Div
         const prB = gid('pr_b'); // Print Button
         const expB = gid('exp_b'); // Export Button

         function shROpts() { // Show Report Options based on type
            const rt = rTy.value;
            qsa('#r_opts > div').forEach(d => d.style.display = 'none'); // Hide all options divs
             rOpts.style.display = 'none'; // Hide main options container initially

             if (['a', 'f_p', 'f_r', 'sal_p', 'sal_pd', 'exp', 'inc'].includes(rt)) {
                 rOpts.style.display = 'block'; // Show main options container
                if (rt === 'a') gid('a_r_opts').style.display = 'block';
                else if (rt === 'f_p' || rt === 'f_r') gid('f_r_opts').style.display = 'block';
                else if (rt === 'sal_p' || rt === 'sal_pd') gid('sal_r_opts').style.display = 'block';
                 else if (rt === 'exp' || rt === 'inc') gid('ie_r_opts').style.display = 'block';
             }
        }

         async function gR() { // Generate Report
            const rt = rTy.value;
            if (!rt) { alert('براہ کرم رپورٹ کی قسم منتخب کریں۔'); return; }

             rTh.innerHTML = '';
             rTb.innerHTML = '';
             rH.textContent = rTy.options[rTy.selectedIndex].text;
             prB.style.display = 'none';
             expB.style.display = 'none';

            try {
                 const sMap = (await gaR(os_s)).reduce((map, s) => { map[s.id] = s; return map; }, {});
                 const tMap = (await gaR(os_t)).reduce((map, t) => { map[t.id] = t.n; return map; }, {});
                 const cMap = (await gaR(os_c)).reduce((map, c) => { map[c.id] = c.n; return map; }, {});

                let data = [];
                let headers = [];

                 if (rt === 's') { // Student List
                     headers = ['ID', 'نام', 'والد کا نام', 'عمر', 'جماعت', 'داخلے کی تاریخ', 'رابطہ', 'پتہ'];
                    const studs = await gaR(os_s);
                    data = studs.map(s => [s.id, s.n, s.fn, s.ag, cMap[s.cid] || '-', s.ad, s.cn || '-', s.adr || '-']);
                } else if (rt === 'a') { // Attendance Report
                    headers = ['تاریخ', 'طالب علم ID', 'نام', 'جماعت', 'حالت'];
                    const dtS = gid('r_a_dt_s').value;
                    const dtE = gid('r_a_dt_e').value;
                    const sId = gid('r_a_sid').value ? parseInt(gid('r_a_sid').value) : null;
                    const cId = gid('r_a_cid').value ? parseInt(gid('r_a_cid').value) : null;

                    const attData = await gaR(os_a);
                     data = attData.filter(a =>
                        (!dtS || a.dt >= dtS) &&
                         (!dtE || a.dt <= dtE) &&
                         (!sId || a.sid === sId) &&
                         (!cId || a.cid === cId)
                     ).sort((a,b) => a.dt.localeCompare(b.dt) || a.sid - b.sid)
                     .map(a => [
                         a.dt, a.sid, sMap[a.sid]?.n || 'نامعلوم', cMap[a.cid] || '-',
                         a.st === 'P' ? 'حاضر' : (a.st === 'A' ? 'غیر حاضر' : 'رخصت')
                     ]);
                 } else if (rt === 'f_p' || rt === 'f_r') { // Fee Reports
                    const status = rt === 'f_p' ? 'واجب الادا' : 'موصول';
                    rH.textContent = `${status} فیس رپورٹ`;
                    headers = ['فیس ID', 'طالب علم ID', 'نام', 'رقم', 'تاریخ'];
                     const dtS = gid('r_f_dt_s').value;
                     const dtE = gid('r_f_dt_e').value;
                     const sId = gid('r_f_sid').value ? parseInt(gid('r_f_sid').value) : null;

                    const feeData = await gaR(os_f);
                    data = feeData.filter(f =>
                        f.st === status &&
                         (!dtS || f.dt >= dtS) &&
                         (!dtE || f.dt <= dtE) &&
                         (!sId || f.sid === sId)
                    ).map(f => [f.id, f.sid, sMap[f.sid]?.n || 'نامعلوم', f.amt, f.dt]);
                 } else if (rt === 'sal_p' || rt === 'sal_pd') { // Salary Reports
                    const status = rt === 'sal_p' ? 'واجب الادا' : 'ادا شدہ';
                    rH.textContent = `${status} تنخواہ رپورٹ`;
                     headers = ['تنخواہ ID', 'استاد ID', 'نام', 'رقم', 'تاریخ'];
                    const dtS = gid('r_sal_dt_s').value;
                     const dtE = gid('r_sal_dt_e').value;
                     const tId = gid('r_sal_tid').value ? parseInt(gid('r_sal_tid').value) : null;

                    const salData = await gaR(os_sl);
                    data = salData.filter(s =>
                         s.st === status &&
                         (!dtS || s.dt >= dtS) &&
                         (!dtE || s.dt <= dtE) &&
                         (!tId || s.tid === tId)
                    ).map(s => [s.id, s.tid, tMap[s.tid] || 'نامعلوم', s.amt, s.dt]);
                 } else if (rt === 'exp' || rt === 'inc') { // Expense/Income Report
                     const type = rt === 'exp' ? 'خرچ' : 'آمدنی';
                     rH.textContent = `${type} کا خلاصہ`;
                     headers = ['ID', 'تفصیل', 'رقم', 'تاریخ'];
                     const dtS = gid('r_ie_dt_s').value;
                     const dtE = gid('r_ie_dt_e').value;
                     const expData = await gaR(os_e);
                     let total = 0;
                    data = expData.filter(e =>
                         e.ty === type &&
                         (!dtS || e.dt >= dtS) &&
                         (!dtE || e.dt <= dtE)
                    ).map(e => {
                         total += e.amt;
                        return [e.id, e.ds, e.amt, e.dt];
                    });
                     // Add total row
                     const totalRow = Array(headers.length).fill('');
                     totalRow[headers.length - 3] = 'کل'; // Label in description column
                     totalRow[headers.length - 2] = total; // Amount in amount column
                     data.push(totalRow);
                 }

                 // Render table
                 const hr = nEl('tr');
                 headers.forEach(h => { const th = nEl('th'); th.textContent = h; hr.appendChild(th); });
                 rTh.appendChild(hr);

                data.forEach(row => {
                    const dr = nEl('tr');
                     row.forEach(cell => { const td = nEl('td'); td.textContent = cell; dr.appendChild(td); });
                    rTb.appendChild(dr);
                });

                 if (data.length > 0) {
                    prB.style.display = 'inline-block';
                    expB.style.display = 'inline-block';
                }

            } catch (err) { console.error("Report Gen Error:", err); alert('رپورٹ بنانے میں خرابی: ' + err); }
        }

         function prR() { // Print Report
            window.print();
        }

        function expR() { // Export Report to CSV
            const rt = rTy.value;
             const fn = `report_${rt}_${new Date().toISOString().slice(0, 10)}.csv`;
            let csv = '\uFEFF'; // BOM for Excel UTF-8

            // Headers
            const headers = Array.from(rTh.querySelectorAll('th')).map(th => `"${th.textContent.replace(/"/g, '""')}"`).join(',');
            csv += headers + '\r\n';

            // Rows
            rTb.querySelectorAll('tr').forEach(tr => {
                 const row = Array.from(tr.querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`).join(',');
                 csv += row + '\r\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = nEl('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                 link.setAttribute("href", url);
                 link.setAttribute("download", fn);
                 link.style.visibility = 'hidden';
                 document.body.appendChild(link);
                link.click();
                 document.body.removeChild(link);
            } else {
                 alert('CSV ایکسپورٹ آپ کے براؤزر میں معاون نہیں ہے۔');
            }
        }

        // --- Backup & Restore ---
        async function bkD() { // Backup Data
            const bkData = {};
            const stores = [os_s, os_t, os_c, os_a, os_f, os_sl, os_i, os_e];
            try {
                for (const osn of stores) {
                    bkData[osn] = await gaR(osn);
                }
                const json = JSON.stringify(bkData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                 const fn = `dmm_backup_${new Date().toISOString().slice(0, 10)}.json`;
                const link = nEl('a');
                link.href = URL.createObjectURL(blob);
                 link.download = fn;
                link.click();
                URL.revokeObjectURL(link.href);
                alert('بیک اپ کامیابی سے بنایا گیا۔');
            } catch (err) { console.error("Backup Error:", err); alert('بیک اپ بنانے میں خرابی: ' + err); }
        }

        async function rsD() { // Restore Data
             const fIn = gid('rs_f');
            if (!fIn.files || fIn.files.length === 0) {
                 alert('براہ کرم بحال کرنے کے لیے بیک اپ فائل منتخب کریں۔'); return;
            }
            const file = fIn.files[0];
            if (!file.name.endsWith('.json')) { alert('غلط فائل کی قسم۔ براہ کرم .json فائل منتخب کریں۔'); return; }

            if (!confirm('خبردار! موجودہ تمام ڈیٹا حذف ہو جائے گا۔ کیا آپ واقعی ڈیٹا بحال کرنا چاہتے ہیں؟')) {
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const bkData = JSON.parse(e.target.result);
                    const stores = [os_s, os_t, os_c, os_a, os_f, os_sl, os_i, os_e];

                     // Clear existing data
                     for (const osn of stores) {
                         await cOs(osn);
                     }

                     // Import data
                    for (const osn of stores) {
                        if (bkData[osn] && Array.isArray(bkData[osn])) {
                            const tx = db.transaction(osn, 'readwrite');
                            const os = tx.objectStore(osn);
                             for (const rec of bkData[osn]) {
                                 // Need to remove auto-increment key if present from backup? Usually okay to let DB assign new ones on restore.
                                 // However, relationships rely on IDs. Best to keep IDs from backup if possible.
                                 // IndexedDB 'add' might fail if key exists. 'put' is safer for restore.
                                os.put(rec); // Use put to preserve IDs or handle potential conflicts
                            }
                             await tx.done;
                        }
                    }
                    alert('ڈیٹا کامیابی سے بحال ہو گیا۔ براہ کرم صفحہ کو ریفریش کریں۔');
                    // Reload all data displays after restore
                    ldAll();
                 } catch (err) { console.error("Restore Error:", err); alert('ڈیٹا بحال کرنے میں خرابی: ' + err + '\nیقینی بنائیں کہ فائل درست بیک اپ فائل ہے۔'); }
            };
            reader.onerror = (e) => { console.error("File Read Error:", e); alert("فائل پڑھنے میں خرابی۔"); };
            reader.readAsText(file);
        }


        // --- Populate Selects ---
        async function pCls() { // Populate Class Selects
            try {
                const classes = await gaR(os_c);
                const sels = [gid('s_cl'), gid('a_cl'), gid('r_a_cid')];
                sels.forEach(sel => {
                    const currentVal = sel.value;
                    sel.innerHTML = sel.id === 's_cl' ? '' : '<option value="">تمام جماعتیں</option>'; // Student form requires a class
                    classes.forEach(c => {
                        const opt = nEl('option');
                         opt.value = c.id; opt.textContent = c.n;
                        sel.appendChild(opt);
                    });
                    sel.value = currentVal; // Restore selection if possible
                });
             } catch (err) { console.error("Error populating class selects:", err); }
        }

        async function pTls() { // Populate Teacher Selects
            try {
                const teachs = await gaR(os_t);
                const sels = [gid('c_tid'), gid('sal_tid'), gid('r_sal_tid')];
                 sels.forEach(sel => {
                    const currentVal = sel.value;
                    sel.innerHTML = '<option value="">منتخب کریں...</option>';
                     if (sel.id === 'r_sal_tid') sel.innerHTML = '<option value="">تمام اساتذہ</option>'; // Report filter default
                    teachs.forEach(t => {
                        const opt = nEl('option');
                        opt.value = t.id; opt.textContent = t.n;
                        sel.appendChild(opt);
                     });
                     sel.value = currentVal;
                });
            } catch (err) { console.error("Error populating teacher selects:", err); }
        }

        async function pSls() { // Populate Student Selects
             try {
                 const studs = await gaR(os_s);
                 const sels = [gid('c_sids'), gid('fee_sid'), gid('r_a_sid'), gid('r_f_sid')];
                sels.forEach(sel => {
                     const currentVal = sel.multiple ? Array.from(sel.selectedOptions).map(o => o.value) : sel.value;
                     sel.innerHTML = '';
                    if (!sel.multiple) {
                         sel.innerHTML = '<option value="">منتخب کریں...</option>';
                         if (sel.id.startsWith('r_')) sel.innerHTML = '<option value="">تمام طلبہ</option>'; // Report filter default
                     }
                    studs.forEach(s => {
                        const opt = nEl('option');
                         opt.value = s.id; opt.textContent = `${s.n} (ID: ${s.id})`;
                        sel.appendChild(opt);
                    });
                    if (sel.multiple) {
                         Array.from(sel.options).forEach(o => { if (currentVal.includes(o.value)) o.selected = true; });
                    } else {
                         sel.value = currentVal;
                    }
                 });
             } catch (err) { console.error("Error populating student selects:", err); }
        }


         // --- Initialization ---
        function ldAll() { // Load All Data
             lS(); lT(); lC();
            lFees(); lSals();
            lInv(); lExp();
            pCls(); pTls(); pSls();
             // Set default attendance date
             aDt.valueAsDate = new Date();
        }

        window.onload = async () => {
             try {
                await oDb();
                console.log("Database opened successfully");
                ldAll();
             } catch (err) {
                 console.error("Initialization failed:", err);
                 alert("ایپلیکیشن شروع کرنے میں ناکام: " + err);
            }
        };


const buttonTexts = {
  s_tb: "طلبہ",
  t_tb: "اساتذہ",
  c_tb: "جماعت"
};

// Wait for a specific time (e.g., 2 seconds) before updating the buttons
setTimeout(() => {
  document.querySelectorAll('button').forEach(button => {
    const buttonId = button.id; // Get the id of the button
    if (buttonId && buttonTexts[buttonId]) {
      button.innerHTML = buttonTexts[buttonId]; // Assign the corresponding text to the button
    }
  });
}, 1000); // 2000 milliseconds = 2 seconds
    </script>
<script type="module">
  import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

  const swUrl = './sw.js';
  const wb = new Workbox(swUrl);

  wb.addEventListener('waiting', () => {
    console.log('A new service worker is waiting to activate.');
    wb.messageSW({ type: 'SKIP_WAITING' });
  });

  wb.addEventListener('controlling', () => {
    console.log('The new service worker is now in control. Reloading page for updates...');
    window.location.reload();
  });

  wb.register();
</script></body>
</html>

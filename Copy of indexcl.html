<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام انتظام مدرسہ</title>
    <style>
        @font-face {
            font-family: 'Jameel Noori Nastaleeq';
            src: url('data:application/font-woff2;base64,d09GMgABAAAAAAPAAA0AAAAAJTwAAANoAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP0ZGVE0cGh4GYACCahEICnwFATYCJANICyYABCAFhDIHgRMbGikRxX6UJDVB9n9KIG+IIeq3e2BAjGY7DcJiJgWiSMG0sXlK7TrKuJdFSVMPvVcW/y//7v9ymTbOZzMNQYIhhJXq7bP7vZ/ZnLpMIkSbRCKR5EGNRomQxEJoibzs1v0tBr5k+YRoQdMQlVJ3xQ9DyhCSTUhDJCHVhVRVqZRY4v8cM92eQBPIA9xBECiRKIkSOeooWK91Qywa1RxNCkmipKQ02v//f865BcgL5JW85vsX3vsH+Ae4mNOfF6SAvygsRVmGNKstQ0T8v4NlOdK0CVPjFNI4MmRIhNEgB07P/ztYGhMYHgsYHoamTRCkrBAE0QSoCjR90gSxsGsIFAHFVqATIABkshQFBXKCQ6CQIVbZavXZlTFUfXpT2v3bi/tvr/a//+nu6wt9rFJwYYjy7HJRVWT14J0xVC54qsrwdB+qqsjwdO0dmOxDdUVGp/pQXZHR6T50dEGGxXlUJ/n0xChq6nz2xCg6WO1DdUXmpvrQoWq/1CrFtV5dBiYeqKvIwOQDdRUZmHqgj+w/MIqaRRmdGkXHpvvQoWo+eGcUHavmM3eOomMVfLr5wNSoLrjqwcTEqHrgyMPXxzNkSMrQJMkIaYgmjQuGjJAc/u8Y8vIWCRoSbW+VKFHcXSRCXFwiDGnfD0wmQSI0DkpKGhI9PT29vZAQExODk3ANGXJwZFy3o7NTrwSDxpD+3QkIUcIkOZsEQdOmSvX7F4Yaw74MjHh5GTGM0IiHh7+/v5eXp6enEcPwtGPYlxHTPAaGeXh4enj5+Xt5QWPYl2FfRnwZ8WXEl8HYIS+EpqbGjeFfRnyhvf6M+DLsy7C3t5eXl5e3t7e395eRLwOGDRgyoMgmBhqjMcIYMWz48O/DvgwbBo3RGI3QCP0/DIaQJg39fCuOIejnRx6KeEPhkHx6KAkpL8mPzEYdAvoHUABQk6t1oi2ABoDLi/aQAAD+3vEa6vFHgvotKCCQpwD4Xx89kGRjvKhh4I+u63hWLgL6/3m8Bd67H7p1xB9fDPoRAID+HwBnx5QdHY98Ov3/sO2/5c9bON4N5cW8XWX+r7Ljf6/7UQbAF78MBB3AHMw6AIiS6EkAIuKWQUQ8yoAgeUUC51MtUITcWoEi5NEndcFG3pPX0nEZrM27yVuAEHSj/QNEFKIZ6jdE1C/QgXI8SLQ97kUAHrxJhJrXCshTAT9rlXIWPo7m6W2SXNYfizzdxAz8JLt/STacH7JPr5/nsjTNsyQZc6cSYwxqXX9IhvLmx9r5YOPdSs5TjGlSuN+RN9HfQKutX86CgWBsxKtPIvG+3+qIFgUb6tWnuRxqCjGIXuZORdFwBrVufkiG8uaHRsS0sfFufbGcosWYJoX7XXULlV2WWq3+j3PBQLC+2qv3bUziPXdaW9FFQdvGdTU1LtSU+FDWN7DqI5XKvapR1vr2Sn5WMzU7wA==');
            font-weight: normal;
            font-style: normal;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif;
            background-color: #f9f7f1;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border: 1px solid #ddd;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px double #000;
            padding-bottom: 15px;
        }

        h1, h2, h3 {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-button {
            background-color: #f9f7f1;
            color: #333;
            border: 1px solid #333;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-button:hover {
            background-color: #ebe6d9;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f9f7f1;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 10px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: none;
            border-bottom: 1px dashed #999;
            background-color: transparent;
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-bottom: 1px solid #333;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .btn {
            background-color: #f9f7f1;
            color: #333;
            border: 1px solid #333;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif;
            font-size: 16px;
            transition: all 0.3s;
        }

        .btn:hover {
            background-color: #ebe6d9;
        }

        .btn-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #fff;
        }

        .register-style {
            font-family: 'Jameel Noori Nastaleeq', 'Noto Nastaliq Urdu', serif;
            background-color: #fff;
            border: none;
            border-bottom: 1px dashed #999;
            width: 100%;
        }

        .register-header {
            text-align: center;
            border-bottom: double 3px #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .register-table {
            width: 100%;
            border-collapse: collapse;
        }

        .register-table th {
            border-bottom: 2px solid #000;
            padding: 8px;
        }

        .register-table td {
            border-bottom: 1px solid #ccc;
            padding: 8px;
        }

        .print-only {
            display: none;
        }

        .logo-preview {
            max-width: 150px;
            max-height: 150px;
            margin: 10px auto;
            display: block;
        }

        .stamp-preview {
            max-width: 100px;
            max-height: 100px;
        }

        .search-box {
            margin-bottom: 15px;
            width: 100%;
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .attendance-cell {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        .receipt {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 20px;
            position: relative;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .receipt-body {
            margin-bottom: 15px;
        }

        .receipt-footer {
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #000;
            padding-top: 10px;
        }

        .signature-area {
            min-height: 60px;
            width: 150px;
            border-top: 1px dashed #000;
            margin-top: 10px;
        }

        .stamp-area {
            position: absolute;
            bottom: 40px;
            right: 40px;
            opacity: 0.7;
        }

        .id-card {
            width: 350px;
            height: 200px;
            border: 1px solid #000;
            padding: 15px;
            margin: 0 auto;
            position: relative;
            background-color: #fff;
        }

        .id-card-header {
            text-align: center;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .id-card-body {
            display: flex;
        }

        .id-card-photo {
            width: 80px;
            height: 80px;
            border: 1px solid #000;
            margin-left: 10px;
        }

        .id-card-info {
            flex: 1;
        }

        .id-card-footer {
            position: absolute;
            bottom: 10px;
            width: calc(100% - 30px);
            display: flex;
            justify-content: space-between;
        }

        @media print {
            body {
                background-color: #fff;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
                border: none;
            }

            .nav, .btn, .no-print {
                display: none !important;
            }

            .page {
                display: block !important;
            }

            .print-only {
                display: block;
            }

            .card {
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="madrasaNameHeader">نظام انتظام مدرسہ</h1>
            <p id="madrasaAddressHeader"></p>
        </header>
        
        <div class="nav">
            <button class="nav-button" data-page="dashboard-page">ڈیش بورڈ</button>
            <button class="nav-button" data-page="student-page">طلبہ</button>
            <button class="nav-button" data-page="teacher-page">اساتذہ</button>
            <button class="nav-button" data-page="class-page">کلاسز</button>
            <button class="nav-button" data-page="attendance-page">حاضری</button>
            <button class="nav-button" data-page="exam-page">امتحانات</button>
            <button class="nav-button" data-page="fee-page">فیس</button>
            <button class="nav-button" data-page="salary-page">تنخواہ</button>
            <button class="nav-button" data-page="ledger-page">کھاتہ</button>
            <button class="nav-button" data-page="report-page">رپورٹس</button>
            <button class="nav-button" data-page="settings-page">ترتیبات</button>
        </div>

        <!-- Dashboard Page -->
        <div class="page" id="dashboard-page">
            <h2>ڈیش بورڈ</h2>
            <div class="form-row">
                <div class="card" style="flex: 1">
                    <h3>طالب علم کی کل تعداد</h3>
                    <p id="totalStudents" style="text-align: center; font-size: 24px;">0</p>
                </div>
                <div class="card" style="flex: 1">
                    <h3>اساتذہ کی کل تعداد</h3>
                    <p id="totalTeachers" style="text-align: center; font-size: 24px;">0</p>
                </div>
                <div class="card" style="flex: 1">
                    <h3>کلاسز کی کل تعداد</h3>
                    <p id="totalClasses" style="text-align: center; font-size: 24px;">0</p>
                </div>
            </div>
            <div class="form-row">
                <div class="card" style="flex: 1">
                    <h3>آج کی فیس وصولی</h3>
                    <p id="todayFeeCollection" style="text-align: center; font-size: 24px;">0 روپے</p>
                </div>
                <div class="card" style="flex: 1">
                    <h3>ماہانہ فیس وصولی</h3>
                    <p id="monthlyFeeCollection" style="text-align: center; font-size: 24px;">0 روپے</p>
                </div>
                <div class="card" style="flex: 1">
                    <h3>سالانہ فیس وصولی</h3>
                    <p id="yearlyFeeCollection" style="text-align: center; font-size: 24px;">0 روپے</p>
                </div>
            </div>
            <div class="form-row">
                <div class="card" style="flex: 1">
                    <h3>آج کی حاضری</h3>
                    <p id="todayAttendance" style="text-align: center; font-size: 24px;">0%</p>
                </div>
                <div class="card" style="flex: 1">
                    <h3>فیس بقایا</h3>
                    <p id="pendingFees" style="text-align: center; font-size: 24px;">0 روپے</p>
                </div>
            </div>
        </div>

        <!-- Student Page -->
        <div class="page" id="student-page">
            <h2>طلبہ</h2>
            <div class="form-row">
                <button class="btn" id="addStudentBtn">نیا طالب علم داخل کریں</button>
                <div class="search-box">
                    <input type="text" class="form-control" id="studentSearchInput" placeholder="طالب علم کا نام یا رول نمبر">
                </div>
            </div>
            <div class="filters">
                <select class="form-control" id="studentClassFilter">
                    <option value="">تمام کلاسز</option>
                </select>
                <select class="form-control" id="studentStatusFilter">
                    <option value="active">فعال طلبہ</option>
                    <option value="inactive">غیر فعال طلبہ</option>
                    <option value="all">تمام طلبہ</option>
                </select>
            </div>
            <table class="register-table" id="studentTable">
                <thead>
                    <tr>
                        <th>داخلہ نمبر</th>
                        <th>نام</th>
                        <th>والد کا نام</th>
                        <th>کلاس</th>
                        <th>رابطہ</th>
                        <th>حیثیت</th>
                        <th>آپشنز</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody"></tbody>
            </table>
        </div>

        <!-- Student Form Dialog -->
        <div class="page" id="student-form-page">
            <h2 id="studentFormTitle">نیا طالب علم درج کریں</h2>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="studentName">طالب علم کا نام</label>
                        <input type="text" class="form-control" id="studentName" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="fatherName">والد کا نام</label>
                        <input type="text" class="form-control" id="fatherName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="dateOfBirth">تاریخ پیدائش</label>
                        <input type="date" class="form-control" id="dateOfBirth">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="admissionNumber">داخلہ نمبر</label>
                        <input type="text" class="form-control" id="admissionNumber" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="studentClass">کلاس</label>
                        <select class="form-control" id="studentClass" required></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="contactNumber">رابطہ نمبر</label>
                        <input type="text" class="form-control" id="contactNumber">
                    </div>
                </div>
                <div class="form-group">
                    <label for="studentAddress">پتہ</label>
                    <textarea class="form-control" id="studentAddress" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="studentStatus">حیثیت</label>
                    <select class="form-control" id="studentStatus">
                        <option value="active">فعال</option>
                        <option value="inactive">غیر فعال</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">محفوظ کریں</button>
                    <button type="button" class="btn" id="cancelStudentForm">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Student ID Card Page -->
        <div class="page" id="student-id-card-page">
            <h2>شناختی کارڈ</h2>
            <div class="id-card">
                <div class="id-card-header">
                    <h3 id="idCardMadrasaName">مدرسہ کا نام</h3>
                    <p id="idCardMadrasaAddress">مدرسہ کا پتہ</p>
                </div>
                <div class="id-card-body">
                    <div class="id-card-photo"></div>
                    <div class="id-card-info">
                        <p><strong>نام:</strong> <span id="idCardStudentName"></span></p>
                        <p><strong>والد کا نام:</strong> <span id="idCardFatherName"></span></p>
                        <p><strong>داخلہ نمبر:</strong> <span id="idCardAdmissionNumber"></span></p>
                        <p><strong>کلاس:</strong> <span id="idCardClass"></span></p>
                    </div>
                </div>
                <div class="id-card-footer">
                    <div>
                        <p><strong>تاریخ اجراء:</strong> <span id="idCardIssueDate"></span></p>
                    </div>
                    <div class="signature-area">
                        <p>دستخط پرنسپل</p>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" id="printIdCardBtn">پرنٹ کریں</button>
                <button class="btn" id="backFromIdCardBtn">واپس جائیں</button>
            </div>
        </div>

        <!-- Teacher Page -->
        <div class="page" id="teacher-page">
            <h2>اساتذہ</h2>
            <div class="form-row">
                <button class="btn" id="addTeacherBtn">نئے استاد کا اندراج کریں</button>
                <div class="search-box">
                    <input type="text" class="form-control" id="teacherSearchInput" placeholder="استاد کا نام یا آئی ڈی">
                </div>
            </div>
            <table class="register-table" id="teacherTable">
                <thead>
                    <tr>
                        <th>آئی ڈی</th>
                        <th>نام</th>
                        <th>مضامین</th>
                        <th>رابطہ</th>
                        <th>تنخواہ کی قسم</th>
                        <th>تاریخ بھرتی</th>
                        <th>آپشنز</th>
                    </tr>
                </thead>
                <tbody id="teacherTableBody"></tbody>
            </table>
        </div>

        <!-- Teacher Form Dialog -->
        <div class="page" id="teacher-form-page">
            <h2 id="teacherFormTitle">نئے استاد کا اندراج کریں</h2>
            <form id="teacherForm">
                <input type="hidden" id="teacherId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="teacherName">استاد کا نام</label>
                        <input type="text" class="form-control" id="teacherName" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="teacherSubjects">مضامین</label>
                        <input type="text" class="form-control" id="teacherSubjects">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="teacherPhone">رابطہ نمبر</label>
                        <input type="text" class="form-control" id="teacherPhone">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="teacherSalaryType">تنخواہ کی قسم</label>
                        <select class="form-control" id="teacherSalaryType">
                            <option value="fixed">مقررہ</option>
                            <option value="hourly">فی گھنٹہ</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="teacherSalaryAmount">تنخواہ کی رقم</label>
                        <input type="number" class="form-control" id="teacherSalaryAmount" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="joiningDate">تاریخ بھرتی</label>
                        <input type="date" class="form-control" id="joiningDate">
                    </div>
                </div>
                <div class="form-group">
                    <label for="teacherAddress">پتہ</label>
                    <textarea class="form-control" id="teacherAddress" rows="3"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">محفوظ کریں</button>
                    <button type="button" class="btn" id="cancelTeacherForm">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Class Page -->
        <div class="page" id="class-page">
            <h2>کلاسز اور مضامین</h2>
            <div class="form-row">
                <button class="btn" id="addClassBtn">نئی کلاس شامل کریں</button>
            </div>
            <table class="register-table" id="classTable">
                <thead>
                    <tr>
                        <th>کلاس کا نام</th>
                        <th>مضامین</th>
                        <th>ماہانہ فیس</th>
                        <th>آپشنز</th>
                    </tr>
                </thead>
                <tbody id="classTableBody"></tbody>
            </table>
        </div>

        <!-- Class Form Dialog -->
        <div class="page" id="class-form-page">
            <h2 id="classFormTitle">نئی کلاس شامل کریں</h2>
            <form id="classForm">
                <input type="hidden" id="classId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="className">کلاس کا نام</label>
                        <input type="text" class="form-control" id="className" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="classFee">ماہانہ فیس</label>
                        <input type="number" class="form-control" id="classFee" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>مضامین</label>
                    <div id="subjectsContainer">
                        <div class="form-row subject-row">
                            <div class="form-group" style="flex: 3;">
                                <input type="text" class="form-control subject-name" placeholder="مضمون کا نام" required>
                            </div>
                            <div class="form-group" style="flex: 3;">
                                <select class="form-control subject-teacher">
                                    <option value="">استاد منتخب کریں</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <button type="button" class="btn remove-subject">-</button>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn" id="addSubjectBtn">+ مضمون شامل کریں</button>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">محفوظ کریں</button>
                    <button type="button" class="btn" id="cancelClassForm">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Attendance Page -->
        <div class="page" id="attendance-page">
            <h2>حاضری سسٹم</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="attendanceType">حاضری کی قسم</label>
                    <select class="form-control" id="attendanceType">
                        <option value="student">طلبہ کی حاضری</option>
                        <option value="teacher">اساتذہ کی حاضری</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="attendanceClass">کلاس</label>
                    <select class="form-control" id="attendanceClass"></select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="attendanceDate">تاریخ</label>
                    <input type="date" class="form-control" id="attendanceDate">
                </div>
            </div>
            <div class="card">
                <h3 id="attendanceTitle">طلبہ کی حاضری</h3>
                <table class="register-table" id="attendanceTable">
                    <thead>
                        <tr>
                            <th>نام</th>
                            <th>حاضری</th>
                            <th>تبصرہ</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody"></tbody>
                </table>
                <div class="btn-group">
                    <button class="btn" id="saveAttendanceBtn">حاضری محفوظ کریں</button>
                    <button class="btn" id="printAttendanceBtn">حاضری پرنٹ کریں</button>
                </div>
            </div>
            <div class="card">
                <h3>حاضری کا خلاصہ</h3>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="summaryMonth">مہینہ</label>
                        <select class="form-control" id="summaryMonth"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="summaryYear">سال</label>
                        <select class="form-control" id="summaryYear"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="summaryClass">کلاس</label>
                        <select class="form-control" id="summaryClass"></select>
                    </div>
                </div>
                <div id="attendanceSummary" class="register-style"></div>
                <div class="btn-group">
                    <button class="btn" id="printSummaryBtn">خلاصہ پرنٹ کریں</button>
                </div>
            </div>
        </div>

        <!-- Exam Page -->
        <div class="page" id="exam-page">
            <h2>امتحانات اور نتائج</h2>
            <div class="form-row">
                <button class="btn" id="createExamBtn">نیا امتحان بنائیں</button>
            </div>
            <div class="card">
                <h3>امتحانات کی فہرست</h3>
                <table class="register-table" id="examTable">
                    <thead>
                        <tr>
                            <th>امتحان کا نام</th>
                            <th>کلاس</th>
                            <th>شروع ہونے کی تاریخ</th>
                            <th>اختتام کی تاریخ</th>
                            <th>آپشنز</th>
                        </tr>
                    </thead>
                    <tbody id="examTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Exam Form Dialog -->
        <div class="page" id="exam-form-page">
            <h2 id="examFormTitle">نیا امتحان بنائیں</h2>
            <form id="examForm">
                <input type="hidden" id="examId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="examName">امتحان کا نام</label>
                        <input type="text" class="form-control" id="examName" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="examClass">کلاس</label>
                        <select class="form-control" id="examClass" required></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="examStartDate">شروع ہونے کی تاریخ</label>
                        <input type="date" class="form-control" id="examStartDate" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="examEndDate">اختتام کی تاریخ</label>
                        <input type="date" class="form-control" id="examEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>امتحانی مضامین</label>
                    <div id="examSubjectsContainer"></div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">محفوظ کریں</button>
                    <button type="button" class="btn" id="cancelExamForm">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Marks Entry Page -->
        <div class="page" id="marks-entry-page">
            <h2>نمبرات داخل کریں</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="marksExamId">امتحان</label>
                    <select class="form-control" id="marksExamId" disabled></select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="marksSubjectId">مضمون</label>
                    <select class="form-control" id="marksSubjectId"></select>
                </div>
            </div>
            <table class="register-table" id="marksTable">
                <thead>
                    <tr>
                        <th>طالب علم کا نام</th>
                        <th>داخلہ نمبر</th>
                        <th>کل نمبر</th>
                        <th>حاصل کردہ نمبر</th>
                    </tr>
                </thead>
                <tbody id="marksTableBody"></tbody>
            </table>
            <div class="btn-group">
                <button class="btn" id="saveMarksBtn">نمبرات محفوظ کریں</button>
                <button class="btn" id="backFromMarksBtn">واپس جائیں</button>
            </div>
        </div>

        <!-- Result Card Page -->
        <div class="page" id="result-card-page">
            <h2>نتیجہ کارڈ</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="resultExamId">امتحان</label>
                    <select class="form-control" id="resultExamId"></select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="resultStudentId">طالب علم</label>
                    <select class="form-control" id="resultStudentId"></select>
                </div>
            </div>
            <div class="card" id="resultCard">
                <div class="register-header">
                    <h3 id="resultMadrasaName">مدرسہ کا نام</h3>
                    <p id="resultMadrasaAddress">مدرسہ کا پتہ</p>
                    <h3>نتیجہ کارڈ</h3>
                </div>
                <div class="form-row">
                    <div style="flex: 1;">
                        <p><strong>طالب علم کا نام:</strong> <span id="resultStudentName"></span></p>
                        <p><strong>والد کا نام:</strong> <span id="resultFatherName"></span></p>
                    </div>
                    <div style="flex: 1;">
                        <p><strong>کلاس:</strong> <span id="resultClassName"></span></p>
                        <p><strong>داخلہ نمبر:</strong> <span id="resultAdmissionNumber"></span></p>
                    </div>
                    <div style="flex: 1;">
                        <p><strong>امتحان:</strong> <span id="resultExamName"></span></p>
                        <p><strong>تاریخ:</strong> <span id="resultDate"></span></p>
                    </div>
                </div>
                <table class="register-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>مضمون</th>
                            <th>کل نمبر</th>
                            <th>حاصل کردہ نمبر</th>
                            <th>فیصد</th>
                            <th>گریڈ</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody"></tbody>
                    <tfoot>
                        <tr>
                            <th colspan="1">مجموعی نتیجہ</th>
                            <th id="resultTotalMarks"></th>
                            <th id="resultObtainedMarks"></th>
                            <th id="resultPercentage"></th>
                            <th id="resultGrade"></th>
                        </tr>
                    </tfoot>
                </table>
                <div class="form-row" style="margin-top: 30px;">
                    <div style="flex: 1; text-align: center;">
                        <div class="signature-area">
                            <p>کلاس ٹیچر</p>
                        </div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div class="stamp-area" id="resultStampArea"></div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div class="signature-area">
                            <p>پرنسپل</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" id="printResultBtn">نتیجہ پرنٹ کریں</button>
                <button class="btn" id="backFromResultBtn">واپس جائیں</button>
            </div>
        </div>

        <!-- Fee Page -->
        <div class="page" id="fee-page">
            <h2>فیس مینجمنٹ</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <button class="btn" id="generateFeesBtn">ماہانہ فیس بنائیں</button>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button class="btn" id="collectFeesBtn">فیس وصول کریں</button>
                </div>
            </div>
            <div class="card">
                <h3>فیس کے رجسٹر</h3>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="feeMonth">مہینہ</label>
                        <select class="form-control" id="feeMonth"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="feeYear">سال</label>
                        <select class="form-control" id="feeYear"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="feeClass">کلاس</label>
                        <select class="form-control" id="feeClass"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="feeStatus">حیثیت</label>
                        <select class="form-control" id="feeStatus">
                            <option value="all">تمام</option>
                            <option value="paid">ادا شدہ</option>
                            <option value="unpaid">غیر ادا شدہ</option>
                            <option value="partial">جزوی ادا شدہ</option>
                        </select>
                    </div>
                </div>
                <table class="register-table" id="feeTable">
                    <thead>
                        <tr>
                            <th>داخلہ نمبر</th>
                            <th>طالب علم کا نام</th>
                            <th>کلاس</th>
                            <th>مہینہ/سال</th>
                            <th>فیس</th>
                            <th>ادا شدہ</th>
                            <th>بقایا</th>
                            <th>حیثیت</th>
                            <th>آپشنز</th>
                        </tr>
                    </thead>
                    <tbody id="feeTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Fee Collection Form -->
        <div class="page" id="fee-collection-page">
            <h2>فیس وصولی</h2>
            <form id="feeCollectionForm">
                <input type="hidden" id="feeId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="feeStudentId">طالب علم</label>
                        <select class="form-control" id="feeStudentId" required></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="feeDueDate">تاریخ</label>
                        <input type="date" class="form-control" id="feeDueDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="feeAmount">فیس کی رقم</label>
                        <input type="number" class="form-control" id="feeAmount" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="feeDiscount">رعایت</label>
                        <input type="number" class="form-control" id="feeDiscount" value="0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="feePaid">ادا شدہ رقم</label>
                        <input type="number" class="form-control" id="feePaid" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="feeRemarks">تبصرہ</label>
                    <textarea class="form-control" id="feeRemarks" rows="2"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">فیس محفوظ کریں</button>
                    <button type="button" class="btn" id="printReceiptBtn">رسید پرنٹ کریں</button>
                    <button type="button" class="btn" id="cancelFeeForm">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Fee Receipt Page -->
        <div class="page" id="fee-receipt-page">
            <h2>فیس رسید</h2>
            <div class="receipt" id="feeReceipt">
                <div class="receipt-header">
                    <h3 id="receiptMadrasaName">مدرسہ کا نام</h3>
                    <p id="receiptMadrasaAddress">مدرسہ کا پتہ</p>
                    <h3>فیس رسید</h3>
                </div>
                <div class="receipt-body">
                    <div class="form-row">
                        <div style="flex: 1;">
                            <p><strong>رسید نمبر:</strong> <span id="receiptNumber"></span></p>
                            <p><strong>طالب علم کا نام:</strong> <span id="receiptStudentName"></span></p>
                            <p><strong>والد کا نام:</strong> <span id="receiptFatherName"></span></p>
                        </div>
                        <div style="flex: 1;">
                            <p><strong>کلاس:</strong> <span id="receiptClassName"></span></p>
                            <p><strong>داخلہ نمبر:</strong> <span id="receiptAdmissionNumber"></span></p>
                            <p><strong>تاریخ:</strong> <span id="receiptDate"></span></p>
                        </div>
                    </div>
                    <table class="register-table">
                        <tr>
                            <th>تفصیل</th>
                            <th>رقم</th>
                        </tr>
                        <tr>
                            <td id="receiptDescription">ماہانہ فیس</td>
                            <td id="receiptAmount">0</td>
                        </tr>
                        <tr>
                            <td>رعایت</td>
                            <td id="receiptDiscount">0</td>
                        </tr>
                        <tr>
                            <td><strong>کل رقم</strong></td>
                            <td><strong id="receiptTotal">0</strong></td>
                        </tr>
                        <tr>
                            <td><strong>ادا شدہ رقم</strong></td>
                            <td><strong id="receiptPaid">0</strong></td>
                        </tr>
                        <tr>
                            <td><strong>بقایا رقم</strong></td>
                            <td><strong id="receiptBalance">0</strong></td>
                        </tr>
                    </table>
                    <p><strong>تبصرہ:</strong> <span id="receiptRemarks"></span></p>
                </div>
                <div class="receipt-footer">
                    <div class="signature-area">
                        <p>طالب علم کے دستخط</p>
                    </div>
                    <div class="stamp-area" id="receiptStampArea"></div>
                    <div class="signature-area">
                        <p>کیشیئر کے دستخط</p>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" id="printFeeReceiptBtn">رسید پرنٹ کریں</button>
                <button class="btn" id="backFromReceiptBtn">واپس جائیں</button>
            </div>
        </div>

        <!-- Salary Page -->
        <div class="page" id="salary-page">
            <h2>تنخواہ مینجمنٹ</h2>
            <div class="form-row">
                <button class="btn" id="paySalaryBtn">تنخواہ ادا کریں</button>
            </div>
            <div class="card">
                <h3>تنخواہ رجسٹر</h3>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryMonth">مہینہ</label>
                        <select class="form-control" id="salaryMonth"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryYear">سال</label>
                        <select class="form-control" id="salaryYear"></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryStatus">حیثیت</label>
                        <select class="form-control" id="salaryStatus">
                            <option value="all">تمام</option>
                            <option value="paid">ادا شدہ</option>
                            <option value="unpaid">غیر ادا شدہ</option>
                        </select>
                    </div>
                </div>
                <table class="register-table" id="salaryTable">
                    <thead>
                        <tr>
                            <th>آئی ڈی</th>
                            <th>استاد کا نام</th>
                            <th>مہینہ/سال</th>
                            <th>بنیادی تنخواہ</th>
                            <th>بونس</th>
                            <th>کٹوتی</th>
                            <th>کل رقم</th>
                            <th>حیثیت</th>
                            <th>آپشنز</th>
                        </tr>
                    </thead>
                    <tbody id="salaryTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Salary Payment Form -->
        <div class="page" id="salary-payment-page">
            <h2>تنخواہ کی ادائیگی</h2>
            <form id="salaryPaymentForm">
                <input type="hidden" id="salaryId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryTeacherId">استاد</label>
                        <select class="form-control" id="salaryTeacherId" required></select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryDueDate">تاریخ</label>
                        <input type="date" class="form-control" id="salaryDueDate" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryBasic">بنیادی تنخواہ</label>
                        <input type="number" class="form-control" id="salaryBasic" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryBonus">بونس</label>
                        <input type="number" class="form-control" id="salaryBonus" value="0">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="salaryDeduction">کٹوتی</label>
                        <input type="number" class="form-control" id="salaryDeduction" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="salaryRemarks">تبصرہ</label>
                    <textarea class="form-control" id="salaryRemarks" rows="2"></textarea>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">تنخواہ محفوظ کریں</button>
                    <button type="button" class="btn" id="printSalarySlipBtn">سلپ پرنٹ کریں</button>
                    <button type="button" class="btn" id="cancelSalaryForm">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Salary Slip Page -->
        <div class="page" id="salary-slip-page">
            <h2>تنخواہ سلپ</h2>
            <div class="receipt" id="salarySlip">
                <div class="receipt-header">
                    <h3 id="slipMadrasaName">مدرسہ کا نام</h3>
                    <p id="slipMadrasaAddress">مدرسہ کا پتہ</p>
                    <h3>تنخواہ سلپ</h3>
                </div>
                <div class="receipt-body">
                    <div class="form-row">
                        <div style="flex: 1;">
                            <p><strong>سلپ نمبر:</strong> <span id="slipNumber"></span></p>
                            <p><strong>استاد کا نام:</strong> <span id="slipTeacherName"></span></p>
                        </div>
                        <div style="flex: 1;">
                            <p><strong>آئی ڈی:</strong> <span id="slipTeacherId"></span></p>
                            <p><strong>تاریخ:</strong> <span id="slipDate"></span></p>
                        </div>
                    </div>
                    <table class="register-table">
                        <tr>
                            <th>تفصیل</th>
                            <th>رقم</th>
                        </tr>
                        <tr>
                            <td>بنیادی تنخواہ</td>
                            <td id="slipBasic">0</td>
                        </tr>
                        <tr>
                            <td>بونس</td>
                            <td id="slipBonus">0</td>
                        </tr>
                        <tr>
                            <td>کٹوتی</td>
                            <td id="slipDeduction">0</td>
                        </tr>
                        <tr>
                            <td><strong>کل رقم</strong></td>
                            <td><strong id="slipTotal">0</strong></td>
                        </tr>
                    </table>
                    <p><strong>تبصرہ:</strong> <span id="slipRemarks"></span></p>
                </div>
                <div class="receipt-footer">
                    <div class="signature-area">
                        <p>استاد کے دستخط</p>
                    </div>
                    <div class="stamp-area" id="slipStampArea"></div>
                    <div class="signature-area">
                        <p>پرنسپل کے دستخط</p>
                    </div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" id="printSalarySlipBtn2">سلپ پرنٹ کریں</button>
                <button class="btn" id="backFromSlipBtn">واپس جائیں</button>
            </div>
        </div>

        <!-- Ledger Page -->
        <div class="page" id="ledger-page">
            <h2>کھاتہ سسٹم</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="ledgerType">کھاتہ کی قسم</label>
                    <select class="form-control" id="ledgerType">
                        <option value="student">طالب علم کا کھاتہ</option>
                        <option value="teacher">استاد کا کھاتہ</option>
                        <option value="madrasa">مدرسہ کا کھاتہ</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="ledgerId">منتخب کریں</label>
                    <select class="form-control" id="ledgerId"></select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button class="btn" id="addLedgerEntryBtn">نیا اندراج کریں</button>
                </div>
            </div>
            <div class="card">
                <h3 id="ledgerTitle">کھاتہ کی تفصیلات</h3>
                <table class="register-table" id="ledgerTable">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                            <th>تفصیل</th>
                            <th>جمع</th>
                            <th>نام</th>
                            <th>بیلنس</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerTableBody"></tbody>
                </table>
                <div class="btn-group">
                    <button class="btn" id="printLedgerBtn">کھاتہ پرنٹ کریں</button>
                </div>
            </div>
        </div>

        <!-- Ledger Entry Form -->
        <div class="page" id="ledger-entry-page">
            <h2>نیا کھاتہ اندراج</h2>
            <form id="ledgerEntryForm">
                <input type="hidden" id="ledgerEntryId">
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="ledgerEntryDate">تاریخ</label>
                        <input type="date" class="form-control" id="ledgerEntryDate" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="ledgerEntryType">قسم</label>
                        <select class="form-control" id="ledgerEntryType">
                            <option value="credit">جمع</option>
                            <option value="debit">نام</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="ledgerEntryAmount">رقم</label>
                        <input type="number" class="form-control" id="ledgerEntryAmount" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="ledgerEntryDescription">تفصیل</label>
                        <input type="text" class="form-control" id="ledgerEntryDescription" required>
                    </div>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn">محفوظ کریں</button>
                    <button type="button" class="btn" id="cancelLedgerEntryBtn">منسوخ کریں</button>
                </div>
            </form>
        </div>

        <!-- Report Page -->
        <div class="page" id="report-page">
            <h2>رپورٹس</h2>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="reportType">رپورٹ کی قسم</label>
                    <select class="form-control" id="reportType">
                        <option value="student">طلبہ کی رپورٹ</option>
                        <option value="teacher">اساتذہ کی رپورٹ</option>
                        <option value="fee">فیس کی رپورٹ</option>
                        <option value="attendance">حاضری کی رپورٹ</option>
                        <option value="exam">امتحانی نتائج کی رپورٹ</option>
                        <option value="finance">مالی رپورٹ</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button class="btn" id="generateReportBtn">رپورٹ تیار کریں</button>
                </div>
            </div>
            <div class="card" id="reportContainer">
                <h3 id="reportTitle">رپورٹ</h3>
                <div id="reportFilters" class="form-row"></div>
                <div id="reportContent"></div>
                <div class="btn-group">
                    <button class="btn" id="printReportBtn">رپورٹ پرنٹ کریں</button>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div class="page" id="settings-page">
            <h2>ترتیبات</h2>
            <div class="card">
                <h3>مدرسہ کی معلومات</h3>
                <form id="madrasaInfoForm">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="madrasaName">مدرسہ کا نام</label>
                            <input type="text" class="form-control" id="madrasaName" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="madrasaPhone">رابطہ نمبر</label>
                            <input type="text" class="form-control" id="madrasaPhone">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="madrasaAddress">پتہ</label>
                        <textarea class="form-control" id="madrasaAddress" rows="2"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="madrasaEmail">ای میل</label>
                            <input type="email" class="form-control" id="madrasaEmail">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="madrasaWebsite">ویب سائٹ</label>
                            <input type="url" class="form-control" id="madrasaWebsite">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="madrasaLogo">لوگو</label>
                            <input type="file" id="madrasaLogo" accept="image/*">
                            <img id="logoPreview" class="logo-preview" src="" alt="">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="madrasaStamp">مہر</label>
                            <input type="file" id="madrasaStamp" accept="image/*">
                            <img id="stampPreview" class="stamp-preview" src="" alt="">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn">معلومات محفوظ کریں</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h3>سسٹم ڈیٹا</h3>
                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <button class="btn" id="exportDataBtn">ڈیٹا ایکسپورٹ کریں</button>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <button class="btn" id="importDataBtn">ڈیٹا امپورٹ کریں</button>
                        <input type="file" id="importDataFile" style="display:none" accept=".json">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <button class="btn" id="backupDataBtn">بیک اپ بنائیں</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // JavaScript for Madrasa Management System
    
    // Database object to store all data
    let db = {
        students: [],
        teachers: [],
        classes: [],
        attendance: [],
        exams: [],
        marks: [],
        fees: [],
        salaries: [],
        ledger: [],
        settings: {
            madrasaName: "نظام انتظام مدرسہ",
            madrasaAddress: "",
            madrasaPhone: "",
            madrasaEmail: "",
            madrasaWebsite: "",
            madrasaLogo: "",
            madrasaStamp: ""
        }
    };
    
    // Current date in YYYY-MM-DD format
    const getCurrentDate = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    // Format date for display (DD/MM/YYYY)
    const formatDate = (dateString) => {
        if (!dateString) return "";
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    };
    
    // Generate unique ID
    const generateId = () => {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    };
    
    // Save data to local storage
    const saveData = () => {
        localStorage.setItem('madrasaDB', JSON.stringify(db));
    };
    
    // Load data from local storage
    const loadData = () => {
        const data = localStorage.getItem('madrasaDB');
        if (data) {
            db = JSON.parse(data);
            updateUI();
        }
    };
    
    // Navigation
    document.querySelectorAll('.nav-button').forEach(button => {
        button.addEventListener('click', () => {
            const pageId = button.getAttribute('data-page');
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        });
    });
    
    // Initialize the application
    const initApp = () => {
	
	
		window.db = window.db || {};
    
		// Initialize all db arrays and settings
		db.students = db.students || [];
		db.teachers = db.teachers || [];
		db.classes = db.classes || [];
		db.fees = db.fees || [];
		db.attendance = db.attendance || [];
		db.exams = db.exams || [];
		db.marks = db.marks || [];
		db.salaries = db.salaries || [];
		db.ledger = db.ledger || [];
		db.settings = db.settings || {
			madrasaName: '',
			madrasaAddress: '',
			madrasaPhone: '',
			madrasaEmail: '',
			madrasaWebsite: '',
			madrasaLogo: '',
			madrasaStamp: ''
		};
        loadData();
        document.getElementById('dashboard-page').classList.add('active');
        
        // Set current date for date inputs
        const dateInputs = document.querySelectorAll('input[type="date"]');
        dateInputs.forEach(input => {
            input.value = getCurrentDate();
        });
        
        // Initialize dropdowns
        populateMonthDropdowns();
        populateYearDropdowns();
        
        // Update UI with loaded data
		loadData();
		updateUI();
    };
    
    // Update UI elements
    const updateUI = () => {
        // Update header with madrasa name
        document.getElementById('madrasaNameHeader').textContent = db.settings.madrasaName;
        document.getElementById('madrasaAddressHeader').textContent = db.settings.madrasaAddress;
        
        // Update dashboard stats
        updateDashboard();
        
        // Update class dropdowns
        updateClassDropdowns();
        
        // Update student and teacher tables
        updateStudentTable();
        updateTeacherTable();
        updateClassTable();
        
        // Update settings form
        document.getElementById('madrasaName').value = db.settings.madrasaName;
        document.getElementById('madrasaAddress').value = db.settings.madrasaAddress;
        document.getElementById('madrasaPhone').value = db.settings.madrasaPhone;
        document.getElementById('madrasaEmail').value = db.settings.madrasaEmail;
        document.getElementById('madrasaWebsite').value = db.settings.madrasaWebsite;
        
        // Update logo and stamp previews
        if (db.settings.madrasaLogo) {
            document.getElementById('logoPreview').src = db.settings.madrasaLogo;
        }
        if (db.settings.madrasaStamp) {
            document.getElementById('stampPreview').src = db.settings.madrasaStamp;
        }
    };
    
    // Update dashboard statistics
   function updateDashboard() {
    // Safely access array lengths with fallback to 0
    document.getElementById('totalStudents').textContent = (db.students || []).length;
    document.getElementById('totalTeachers').textContent = (db.teachers || []).length;
    document.getElementById('totalClasses').textContent = (db.classes || []).length;

    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const todayStr = getCurrentDate();

    // Fee collection calculations with safeguards
    const todayFees = (db.fees || []).reduce((sum, fee) => {
        return fee.paymentDate === todayStr ? sum + (fee.paid || 0) : sum;
    }, 0);
    document.getElementById('todayFeeCollection').textContent = todayFees + ' روپے';

    const monthlyFees = (db.fees || []).reduce((sum, fee) => {
        const paymentDate = fee.paymentDate ? new Date(fee.paymentDate) : null;
        return paymentDate && paymentDate.getMonth() === currentMonth && 
               paymentDate.getFullYear() === currentYear ? sum + (fee.paid || 0) : sum;
    }, 0);
    document.getElementById('monthlyFeeCollection').textContent = monthlyFees + ' روپے';

    const yearlyFees = (db.fees || []).reduce((sum, fee) => {
        const paymentDate = fee.paymentDate ? new Date(fee.paymentDate) : null;
        return paymentDate && paymentDate.getFullYear() === currentYear ? sum + (fee.paid || 0) : sum;
    }, 0);
    document.getElementById('yearlyFeeCollection').textContent = yearlyFees + ' روپے';

    // Pending fees with safeguard
    const pendingFees = (db.fees || []).reduce((sum, fee) => {
        return fee.status !== 'paid' ? sum + (fee.amount - (fee.paid || 0)) : sum;
    }, 0);
    document.getElementById('pendingFees').textContent = pendingFees + ' روپے';

    // Attendance calculation with safeguard
    const todayAttendanceRecords = (db.attendance || []).filter(record => 
        record.date === todayStr && record.type === 'student'
    );
    const presentCount = todayAttendanceRecords.filter(record => record.status === 'present').length;
    const attendancePercentage = todayAttendanceRecords.length > 0 
        ? (presentCount / todayAttendanceRecords.length * 100).toFixed(2) 
        : 0;
    document.getElementById('todayAttendance').textContent = attendancePercentage + '%';
}
    
    // Populate month dropdowns
    const populateMonthDropdowns = () => {
        const months = [
            { value: '1', text: 'جنوری' },
            { value: '2', text: 'فروری' },
            { value: '3', text: 'مارچ' },
            { value: '4', text: 'اپریل' },
            { value: '5', text: 'مئی' },
            { value: '6', text: 'جون' },
            { value: '7', text: 'جولائی' },
            { value: '8', text: 'اگست' },
            { value: '9', text: 'ستمبر' },
            { value: '10', text: 'اکتوبر' },
            { value: '11', text: 'نومبر' },
            { value: '12', text: 'دسمبر' }
        ];
        
        const monthDropdowns = document.querySelectorAll('#summaryMonth, #feeMonth, #salaryMonth');
        monthDropdowns.forEach(dropdown => {
            dropdown.innerHTML = '';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month.value;
                option.textContent = month.text;
                dropdown.appendChild(option);
            });
            
            // Set current month
            const currentMonth = new Date().getMonth() + 1;
            dropdown.value = currentMonth.toString();
        });
    };
    
    // Populate year dropdowns
    const populateYearDropdowns = () => {
        const currentYear = new Date().getFullYear();
        const yearDropdowns = document.querySelectorAll('#summaryYear, #feeYear, #salaryYear');
        
        yearDropdowns.forEach(dropdown => {
            dropdown.innerHTML = '';
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year.toString();
                option.textContent = year.toString();
                dropdown.appendChild(option);
            }
            
            // Set current year
            dropdown.value = currentYear.toString();
        });
    };
    
    // Update class dropdowns
    const updateClassDropdowns = () => {
        const classDropdowns = document.querySelectorAll('#studentClass, #attendanceClass, #examClass, #summaryClass, #feeClass');
        
        classDropdowns.forEach(dropdown => {
            dropdown.innerHTML = '';
            
            if (dropdown.id === 'attendanceClass' || dropdown.id === 'summaryClass' || dropdown.id === 'feeClass') {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'تمام کلاسز';
                dropdown.appendChild(option);
            }
            
            db.classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                dropdown.appendChild(option);
            });
        });
        
        // Student class filter
        const studentClassFilter = document.getElementById('studentClassFilter');
        studentClassFilter.innerHTML = '<option value="">تمام کلاسز</option>';
        db.classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls.id;
            option.textContent = cls.name;
            studentClassFilter.appendChild(option);
        });
    };
    
    // STUDENT FUNCTIONS
    
    // Update student table
    const updateStudentTable = () => {
        const tableBody = document.getElementById('studentTableBody');
        const searchInput = document.getElementById('studentSearchInput').value.toLowerCase();
        const classFilter = document.getElementById('studentClassFilter').value;
        const statusFilter = document.getElementById('studentStatusFilter').value;
        
        tableBody.innerHTML = '';
        
        let filteredStudents = db.students;
        
        // Apply filters
        if (searchInput) {
            filteredStudents = filteredStudents.filter(student => 
                student.name.toLowerCase().includes(searchInput) || 
                student.admissionNumber.toLowerCase().includes(searchInput)
            );
        }
        
        if (classFilter) {
            filteredStudents = filteredStudents.filter(student => student.classId === classFilter);
        }
        
        if (statusFilter !== 'all') {
            filteredStudents = filteredStudents.filter(student => student.status === statusFilter);
        }
        
        filteredStudents.forEach(student => {
            const row = document.createElement('tr');
            
            // Find class name
            const studentClass = db.classes.find(cls => cls.id === student.classId);
            const className = studentClass ? studentClass.name : '';
            
            row.innerHTML = `
                <td>${student.admissionNumber}</td>
                <td>${student.name}</td>
                <td>${student.fatherName}</td>
                <td>${className}</td>
                <td>${student.contactNumber || ''}</td>
                <td>${student.status === 'active' ? 'فعال' : 'غیر فعال'}</td>
                <td>
                    <button class="btn edit-student" data-id="${student.id}">ترمیم</button>
                    <button class="btn id-card-student" data-id="${student.id}">شناختی کارڈ</button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-student').forEach(button => {
            button.addEventListener('click', () => {
                const studentId = button.getAttribute('data-id');
                editStudent(studentId);
            });
        });
        
        // Add event listeners for ID card buttons
        document.querySelectorAll('.id-card-student').forEach(button => {
            button.addEventListener('click', () => {
                const studentId = button.getAttribute('data-id');
                showStudentIdCard(studentId);
            });
        });
    };
    
    // Add new student
    document.getElementById('addStudentBtn').addEventListener('click', () => {
        // Reset form
        document.getElementById('studentFormTitle').textContent = 'نیا طالب علم درج کریں';
        document.getElementById('studentForm').reset();
        document.getElementById('studentId').value = '';
        document.getElementById('admissionNumber').value = generateAdmissionNumber();
        document.getElementById('dateOfBirth').value = '';
        
        // Show form page
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('student-form-page').classList.add('active');
    });
    
    // Generate admission number
    const generateAdmissionNumber = () => {
        const year = new Date().getFullYear().toString().substring(2);
        const lastStudent = db.students[db.students.length - 1];
        let number = 1;
        
        if (lastStudent) {
            const lastNumber = parseInt(lastStudent.admissionNumber.split('-')[1], 10);
            if (!isNaN(lastNumber)) {
                number = lastNumber + 1;
            }
        }
        
        return `${year}-${number.toString().padStart(3, '0')}`;
    };
    
    // Edit student
    const editStudent = (studentId) => {
        const student = db.students.find(s => s.id === studentId);
        if (student) {
            document.getElementById('studentFormTitle').textContent = 'طالب علم کی معلومات میں ترمیم کریں';
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('fatherName').value = student.fatherName;
            document.getElementById('dateOfBirth').value = student.dateOfBirth || '';
            document.getElementById('admissionNumber').value = student.admissionNumber;
            document.getElementById('studentClass').value = student.classId;
            document.getElementById('contactNumber').value = student.contactNumber || '';
            document.getElementById('studentAddress').value = student.address || '';
            document.getElementById('studentStatus').value = student.status;
            
            // Show form page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('student-form-page').classList.add('active');
        }
    };
    
    // Show student ID card
    const showStudentIdCard = (studentId) => {
        const student = db.students.find(s => s.id === studentId);
        if (student) {
            // Find class name
            const studentClass = db.classes.find(cls => cls.id === student.classId);
            const className = studentClass ? studentClass.name : '';
            
            // Set ID card details
            document.getElementById('idCardMadrasaName').textContent = db.settings.madrasaName;
            document.getElementById('idCardMadrasaAddress').textContent = db.settings.madrasaAddress;
            document.getElementById('idCardStudentName').textContent = student.name;
            document.getElementById('idCardFatherName').textContent = student.fatherName;
            document.getElementById('idCardAdmissionNumber').textContent = student.admissionNumber;
            document.getElementById('idCardClass').textContent = className;
            document.getElementById('idCardIssueDate').textContent = formatDate(getCurrentDate());
            
            // Show ID card page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('student-id-card-page').classList.add('active');
        }
    };
    
    // Save student form
    document.getElementById('studentForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const studentId = document.getElementById('studentId').value;
        const student = {
            name: document.getElementById('studentName').value,
            fatherName: document.getElementById('fatherName').value,
            dateOfBirth: document.getElementById('dateOfBirth').value,
            admissionNumber: document.getElementById('admissionNumber').value,
            classId: document.getElementById('studentClass').value,
            contactNumber: document.getElementById('contactNumber').value,
            address: document.getElementById('studentAddress').value,
            status: document.getElementById('studentStatus').value
        };
        
        if (studentId) {
            // Update existing student
            const index = db.students.findIndex(s => s.id === studentId);
            if (index !== -1) {
                student.id = studentId;
                db.students[index] = student;
            }
        } else {
            // Add new student
            student.id = generateId();
            student.registrationDate = getCurrentDate();
            db.students.push(student);
        }
        
        // Save data and update UI
        saveData();
        updateUI();
        
        // Go back to student page
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('student-page').classList.add('active');
    });
    
    // Cancel student form
    document.getElementById('cancelStudentForm').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('student-page').classList.add('active');
    });
    
    // Print ID card
    document.getElementById('printIdCardBtn').addEventListener('click', () => {
        window.print();
    });
    
    // Back from ID card
    document.getElementById('backFromIdCardBtn').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('student-page').classList.add('active');
    });
    
    // Search students
    document.getElementById('studentSearchInput').addEventListener('input', () => {
        updateStudentTable();
    });
    
    // Filter students by class
    document.getElementById('studentClassFilter').addEventListener('change', () => {
        updateStudentTable();
    });
    
    // Filter students by status
    document.getElementById('studentStatusFilter').addEventListener('change', () => {
        updateStudentTable();
    });
    
    // TEACHER FUNCTIONS
    
    // Update teacher table
    const updateTeacherTable = () => {
        const tableBody = document.getElementById('teacherTableBody');
        const searchInput = document.getElementById('teacherSearchInput').value.toLowerCase();
        
        tableBody.innerHTML = '';
        
        let filteredTeachers = db.teachers;
        
        // Apply search filter
        if (searchInput) {
            filteredTeachers = filteredTeachers.filter(teacher => 
                teacher.name.toLowerCase().includes(searchInput) || 
                teacher.id.toLowerCase().includes(searchInput)
            );
        }
        
        filteredTeachers.forEach(teacher => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${teacher.id}</td>
                <td>${teacher.name}</td>
                <td>${teacher.subjects || ''}</td>
                <td>${teacher.phone || ''}</td>
                <td>${teacher.salaryType === 'fixed' ? 'مقررہ' : 'فی گھنٹہ'}</td>
                <td>${formatDate(teacher.joiningDate)}</td>
                <td>
                    <button class="btn edit-teacher" data-id="${teacher.id}">ترمیم</button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Add event listeners for edit buttons
        document.querySelectorAll('.edit-teacher').forEach(button => {
            button.addEventListener('click', () => {
                const teacherId = button.getAttribute('data-id');
                editTeacher(teacherId);
            });
        });
    };
    
    // Add new teacher
    document.getElementById('addTeacherBtn').addEventListener('click', () => {
        // Reset form
        document.getElementById('teacherFormTitle').textContent = 'نئے استاد کا اندراج کریں';
        document.getElementById('teacherForm').reset();
        document.getElementById('teacherId').value = '';
        document.getElementById('joiningDate').value = getCurrentDate();
        
        // Show form page
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('teacher-form-page').classList.add('active');
    });
    
    // Edit teacher
    const editTeacher = (teacherId) => {
        const teacher = db.teachers.find(t => t.id === teacherId);
        if (teacher) {
            document.getElementById('teacherFormTitle').textContent = 'استاد کی معلومات میں ترمیم کریں';
            document.getElementById('teacherId').value = teacher.id;
            document.getElementById('teacherName').value = teacher.name;
            document.getElementById('teacherSubjects').value = teacher.subjects || '';
            document.getElementById('teacherPhone').value = teacher.phone || '';
            document.getElementById('teacherSalaryType').value = teacher.salaryType;
            document.getElementById('teacherSalaryAmount').value = teacher.salaryAmount;
            document.getElementById('joiningDate').value = teacher.joiningDate || getCurrentDate();
            document.getElementById('teacherAddress').value = teacher.address || '';
            
            // Show form page
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('teacher-form-page').classList.add('active');
        }
    };
    
    // Save teacher form
    document.getElementById('teacherForm').addEventListener('submit', (e) => {
        e.preventDefault();
        
        const teacherId = document.getElementById('teacherId').value;
        const teacher = {
            name: document.getElementById('teacherName').value,
            subjects: document.getElementById('teacherSubjects').value,
            phone: document.getElementById('teacherPhone').value,
            salaryType: document.getElementById('teacherSalaryType').value,
            salaryAmount: parseInt(document.getElementById('teacherSalaryAmount').value, 10),
            joiningDate: document.getElementById('joiningDate').value,
            address: document.getElementById('teacherAddress').value
        };
        
        if (teacherId) {
            // Update existing teacher
            const index = db.teachers.findIndex(t => t.id === teacherId);
            if (index !== -1) {
                teacher.id = teacherId;
                db.teachers[index] = teacher;
            }
        } else {
            // Add new teacher
            teacher.id = 'T' + (db.teachers.length + 1).toString().padStart(3, '0');
            db.teachers.push(teacher);
        }
        
        // Save data and update UI
        saveData();
        updateUI();
        
        // Go back to teacher page
                // Go back to teacher page
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('teacher-page').classList.add('active');
    });

    // Cancel teacher form
    document.getElementById('cancelTeacherForm').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('teacher-page').classList.add('active');
    });

    // Search teachers
    document.getElementById('teacherSearchInput').addEventListener('input', () => {
        updateTeacherTable();
    });

    // CLASS FUNCTIONS

    // Update class table
    const updateClassTable = () => {
        const tableBody = document.getElementById('classTableBody');
        tableBody.innerHTML = '';

        db.classes.forEach(cls => {
            const subjects = cls.subjects ? cls.subjects.map(s => s.name).join(', ') : '';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${cls.name}</td>
                <td>${subjects}</td>
                <td>${cls.fee} روپے</td>
                <td>
                    <button class="btn edit-class" data-id="${cls.id}">ترمیم</button>
                    <button class="btn delete-class" data-id="${cls.id}">حذف</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // Add event listeners for edit and delete buttons
        document.querySelectorAll('.edit-class').forEach(button => {
            button.addEventListener('click', () => {
                const classId = button.getAttribute('data-id');
                editClass(classId);
            });
        });

        document.querySelectorAll('.delete-class').forEach(button => {
            button.addEventListener('click', () => {
                const classId = button.getAttribute('data-id');
                deleteClass(classId);
            });
        });
    };

    // Add new class
    document.getElementById('addClassBtn').addEventListener('click', () => {
        document.getElementById('classFormTitle').textContent = 'نئی کلاس شامل کریں';
        document.getElementById('classForm').reset();
        document.getElementById('classId').value = '';
        document.getElementById('subjectsContainer').innerHTML = `
            <div class="form-row subject-row">
                <div class="form-group" style="flex: 3;">
                    <input type="text" class="form-control subject-name" placeholder="مضمون کا نام" required>
                </div>
                <div class="form-group" style="flex: 3;">
                    <select class="form-control subject-teacher">
                        <option value="">استاد منتخب کریں</option>
                        ${db.teachers.map(teacher => `<option value="${teacher.id}">${teacher.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button type="button" class="btn remove-subject">-</button>
                </div>
            </div>
        `;

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('class-form-page').classList.add('active');

        attachSubjectEventListeners();
    });

    // Edit class
    const editClass = (classId) => {
        const cls = db.classes.find(c => c.id === classId);
        if (cls) {
            document.getElementById('classFormTitle').textContent = 'کلاس میں ترمیم کریں';
            document.getElementById('classId').value = cls.id;
            document.getElementById('className').value = cls.name;
            document.getElementById('classFee').value = cls.fee;

            const subjectsContainer = document.getElementById('subjectsContainer');
            subjectsContainer.innerHTML = '';
            cls.subjects.forEach(subject => {
                subjectsContainer.innerHTML += `
                    <div class="form-row subject-row">
                        <div class="form-group" style="flex: 3;">
                            <input type="text" class="form-control subject-name" value="${subject.name}" required>
                        </div>
                        <div class="form-group" style="flex: 3;">
                            <select class="form-control subject-teacher">
                                <option value="">استاد منتخب کریں</option>
                                ${db.teachers.map(teacher => `<option value="${teacher.id}" ${subject.teacherId === teacher.id ? 'selected' : ''}>${teacher.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <button type="button" class="btn remove-subject">-</button>
                        </div>
                    </div>
                `;
            });

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('class-form-page').classList.add('active');

            attachSubjectEventListeners();
        }
    };

    // Delete class
    const deleteClass = (classId) => {
        if (confirm('کیا آپ واقعی اس کلاس کو حذف کرنا چاہتے ہیں؟')) {
            db.classes = db.classes.filter(c => c.id !== classId);
            db.students = db.students.map(student => {
                if (student.classId === classId) {
                    return { ...student, classId: '' };
                }
                return student;
            });
            saveData();
            updateUI();
        }
    };

    // Add subject row
    document.getElementById('addSubjectBtn').addEventListener('click', () => {
        const subjectsContainer = document.getElementById('subjectsContainer');
        subjectsContainer.innerHTML += `
            <div class="form-row subject-row">
                <div class="form-group" style="flex: 3;">
                    <input type="text" class="form-control subject-name" placeholder="مضمون کا نام" required>
                </div>
                <div class="form-group" style="flex: 3;">
                    <select class="form-control subject-teacher">
                        <option value="">استاد منتخب کریں</option>
                        ${db.teachers.map(teacher => `<option value="${teacher.id}">${teacher.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button type="button" class="btn remove-subject">-</button>
                </div>
            </div>
        `;
        attachSubjectEventListeners();
    });

    // Attach event listeners for subject rows
    const attachSubjectEventListeners = () => {
        document.querySelectorAll('.remove-subject').forEach(button => {
            button.addEventListener('click', () => {
                if (document.querySelectorAll('.subject-row').length > 1) {
                    button.closest('.subject-row').remove();
                }
            });
        });
    };

    // Save class form
    document.getElementById('classForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const classId = document.getElementById('classId').value;
        const subjects = [];
        document.querySelectorAll('.subject-row').forEach(row => {
            const subjectName = row.querySelector('.subject-name').value;
            const teacherId = row.querySelector('.subject-teacher').value;
            if (subjectName) {
                subjects.push({
                    name: subjectName,
                    teacherId: teacherId
                });
            }
        });

        const cls = {
            name: document.getElementById('className').value,
            fee: parseInt(document.getElementById('classFee').value),
            subjects: subjects
        };

        if (classId) {
            const index = db.classes.findIndex(c => c.id === classId);
            if (index !== -1) {
                cls.id = classId;
                db.classes[index] = cls;
            }
        } else {
            cls.id = generateId();
            db.classes.push(cls);
        }

        saveData();
        updateUI();

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('class-page').classList.add('active');
    });

    // Cancel class form
    document.getElementById('cancelClassForm').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('class-page').classList.add('active');
    });

    // ATTENDANCE FUNCTIONS

    const updateAttendanceTable = () => {
        const tableBody = document.getElementById('attendanceTableBody');
        const attendanceType = document.getElementById('attendanceType').value;
        const classId = document.getElementById('attendanceClass').value;
        const date = document.getElementById('attendanceDate').value;

        tableBody.innerHTML = '';
        let entities = [];

        if (attendanceType === 'student') {
            entities = db.students.filter(student => student.status === 'active' && (!classId || student.classId === classId));
            document.getElementById('attendanceTitle').textContent = 'طلبہ کی حاضری';
        } else {
            entities = db.teachers;
            document.getElementById('attendanceTitle').textContent = 'اساتذہ کی حاضری';
        }

        entities.forEach(entity => {
            const existingRecord = db.attendance.find(record => 
                record.date === date && 
                record.type === attendanceType && 
                record.entityId === entity.id
            );

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${entity.name}</td>
                <td>
                    <select class="form-control attendance-status" data-id="${entity.id}">
                        <option value="present" ${existingRecord && existingRecord.status === 'present' ? 'selected' : ''}>حاضر</option>
                        <option value="absent" ${existingRecord && existingRecord.status === 'absent' ? 'selected' : ''}>غیر حاضر</option>
                        <option value="leave" ${existingRecord && existingRecord.status === 'leave' ? 'selected' : ''}>رخصت</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="form-control attendance-comment" value="${existingRecord ? existingRecord.comment || '' : ''}">
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    document.getElementById('attendanceType').addEventListener('change', updateAttendanceTable);
    document.getElementById('attendanceClass').addEventListener('change', updateAttendanceTable);
    document.getElementById('attendanceDate').addEventListener('change', updateAttendanceTable);

    document.getElementById('saveAttendanceBtn').addEventListener('click', () => {
        const attendanceType = document.getElementById('attendanceType').value;
        const classId = document.getElementById('attendanceClass').value;
        const date = document.getElementById('attendanceDate').value;

        const attendanceRecords = [];
        document.querySelectorAll('#attendanceTableBody tr').forEach(row => {
            const entityId = row.querySelector('.attendance-status').getAttribute('data-id');
            const status = row.querySelector('.attendance-status').value;
            const comment = row.querySelector('.attendance-comment').value;

            attendanceRecords.push({
                id: generateId(),
                type: attendanceType,
                entityId: entityId,
                date: date,
                status: status,
                comment: comment,
                classId: attendanceType === 'student' ? classId : null
            });
        });

        // Remove existing records for this date and type
        db.attendance = db.attendance.filter(record => 
            !(record.date === date && record.type === attendanceType && (!classId || record.classId === classId))
        );

        // Add new records
        db.attendance = db.attendance.concat(attendanceRecords);
        saveData();
        updateDashboard();
        alert('حاضری محفوظ ہو گئی!');
    });

    document.getElementById('printAttendanceBtn').addEventListener('click', () => {
        window.print();
    });

    const updateAttendanceSummary = () => {
        const month = document.getElementById('summaryMonth').value;
        const year = document.getElementById('summaryYear').value;
        const classId = document.getElementById('summaryClass').value;

        const summaryDiv = document.getElementById('attendanceSummary');
        summaryDiv.innerHTML = '';

        const filteredAttendance = db.attendance.filter(record => {
            const recordDate = new Date(record.date);
            return recordDate.getMonth() + 1 === parseInt(month) &&
                   recordDate.getFullYear() === parseInt(year) &&
                   (!classId || record.classId === classId);
        });

        const entities = classId ? 
            db.students.filter(s => s.classId === classId && s.status === 'active') : 
            db.students.filter(s => s.status === 'active');

        let summaryHTML = '<table class="register-table"><thead><tr><th>نام</th><th>حاضر</th><th>غیر حاضر</th><th>رخصت</th></tr></thead><tbody>';

        entities.forEach(entity => {
            const entityRecords = filteredAttendance.filter(r => r.entityId === entity.id);
            const present = entityRecords.filter(r => r.status === 'present').length;
            const absent = entityRecords.filter(r => r.status === 'absent').length;
            const leave = entityRecords.filter(r => r.status === 'leave').length;

            summaryHTML += `
                <tr>
                    <td>${entity.name}</td>
                    <td>${present}</td>
                    <td>${absent}</td>
                    <td>${leave}</td>
                </tr>
            `;
        });

        summaryHTML += '</tbody></table>';
        summaryDiv.innerHTML = summaryHTML;
    };

    document.getElementById('summaryMonth').addEventListener('change', updateAttendanceSummary);
    document.getElementById('summaryYear').addEventListener('change', updateAttendanceSummary);
    document.getElementById('summaryClass').addEventListener('change', updateAttendanceSummary);

    document.getElementById('printSummaryBtn').addEventListener('click', () => {
        window.print();
    });

    // EXAM FUNCTIONS

    const updateExamTable = () => {
        const tableBody = document.getElementById('examTableBody');
        tableBody.innerHTML = '';

        db.exams.forEach(exam => {
            const cls = db.classes.find(c => c.id === exam.classId);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${exam.name}</td>
                <td>${cls ? cls.name : ''}</td>
                <td>${formatDate(exam.startDate)}</td>
                <td>${formatDate(exam.endDate)}</td>
                <td>
                    <button class="btn enter-marks" data-id="${exam.id}">نمبرات درج کریں</button>
                    <button class="btn edit-exam" data-id="${exam.id}">ترمیم</button>
                    <button class="btn delete-exam" data-id="${exam.id}">حذف</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        document.querySelectorAll('.enter-marks').forEach(button => {
            button.addEventListener('click', () => {
                const examId = button.getAttribute('data-id');
                enterMarks(examId);
            });
        });

        document.querySelectorAll('.edit-exam').forEach(button => {
            button.addEventListener('click', () => {
                const examId = button.getAttribute('data-id');
                editExam(examId);
            });
        });

        document.querySelectorAll('.delete-exam').forEach(button => {
            button.addEventListener('click', () => {
                const examId = button.getAttribute('data-id');
                deleteExam(examId);
            });
        });
    };

    document.getElementById('createExamBtn').addEventListener('click', () => {
        document.getElementById('examFormTitle').textContent = 'نیا امتحان بنائیں';
        document.getElementById('examForm').reset();
        document.getElementById('examId').value = '';
        document.getElementById('examStartDate').value = getCurrentDate();
        document.getElementById('examEndDate').value = getCurrentDate();

        const subjectsContainer = document.getElementById('examSubjectsContainer');
        subjectsContainer.innerHTML = '';

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('exam-form-page').classList.add('active');
    });

    const editExam = (examId) => {
        const exam = db.exams.find(e => e.id === examId);
        if (exam) {
            document.getElementById('examFormTitle').textContent = 'امتحان میں ترمیم کریں';
            document.getElementById('examId').value = exam.id;
            document.getElementById('examName').value = exam.name;
            document.getElementById('examClass').value = exam.classId;
            document.getElementById('examStartDate').value = exam.startDate;
            document.getElementById('examEndDate').value = exam.endDate;

            const subjectsContainer = document.getElementById('examSubjectsContainer');
            subjectsContainer.innerHTML = '';
            const cls = db.classes.find(c => c.id === exam.classId);
            if (cls && cls.subjects) {
                cls.subjects.forEach(subject => {
                    subjectsContainer.innerHTML += `
                        <div class="form-group">
                            <label>${subject.name}</label>
                            <input type="number" class="form-control" data-subject-id="${subject.name}" value="100">
                        </div>
                    `;
                });
            }

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('exam-form-page').classList.add('active');
        }
    };

    const deleteExam = (examId) => {
        if (confirm('کیا آپ واقعی اس امتحان کو حذف کرنا چاہتے ہیں؟')) {
            db.exams = db.exams.filter(e => e.id !== examId);
            db.marks = db.marks.filter(m => m.examId !== examId);
            saveData();
            updateExamTable();
        }
    };

    document.getElementById('examForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const examId = document.getElementById('examId').value;
        const subjects = [];
        document.querySelectorAll('#examSubjectsContainer input').forEach(input => {
            subjects.push({
                name: input.getAttribute('data-subject-id'),
                totalMarks: parseInt(input.value)
            });
        });

        const exam = {
            name: document.getElementById('examName').value,
            classId: document.getElementById('examClass').value,
            startDate: document.getElementById('examStartDate').value,
            endDate: document.getElementById('examEndDate').value,
            subjects: subjects
        };

        if (examId) {
            const index = db.exams.findIndex(e => e.id === examId);
            if (index !== -1) {
                exam.id = examId;
                db.exams[index] = exam;
            }
        } else {
            exam.id = generateId();
            db.exams.push(exam);
        }

        saveData();
        updateExamTable();

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('exam-page').classList.add('active');
    });

    document.getElementById('examClass').addEventListener('change', () => {
        const classId = document.getElementById('examClass').value;
        const subjectsContainer = document.getElementById('examSubjectsContainer');
        subjectsContainer.innerHTML = '';

        const cls = db.classes.find(c => c.id === classId);
        if (cls && cls.subjects) {
            cls.subjects.forEach(subject => {
                subjectsContainer.innerHTML += `
                    <div class="form-group">
                        <label>${subject.name}</label>
                        <input type="number" class="form-control" data-subject-id="${subject.name}" value="100">
                    </div>
                `;
            });
        }
    });

    document.getElementById('cancelExamForm').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('exam-page').classList.add('active');
    });

    const enterMarks = (examId) => {
        const exam = db.exams.find(e => e.id === examId);
        if (exam) {
            document.getElementById('marksExamId').value = exam.id;
            document.getElementById('marksExamId').innerHTML = `<option value="${exam.id}">${exam.name}</option>`;

            const subjectSelect = document.getElementById('marksSubjectId');
            subjectSelect.innerHTML = exam.subjects.map(subject => 
                `<option value="${subject.name}">${subject.name}</option>`
            ).join('');

            updateMarksTable();
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('marks-entry-page').classList.add('active');
        }
    };

    const updateMarksTable = () => {
        const examId = document.getElementById('marksExamId').value;
        const subjectId = document.getElementById('marksSubjectId').value;
        const tableBody = document.getElementById('marksTableBody');
        tableBody.innerHTML = '';

        const exam = db.exams.find(e => e.id === examId);
        const cls = db.classes.find(c => c.id === exam.classId);
        const students = db.students.filter(s => s.classId === exam.classId && s.status === 'active');
        const subject = exam.subjects.find(s => s.name === subjectId);

        students.forEach(student => {
            const existingMark = db.marks.find(m => 
                m.examId === examId && 
                m.studentId === student.id && 
                m.subject === subjectId
            );

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.name}</td>
                <td>${student.admissionNumber}</td>
                <td>${subject.totalMarks}</td>
                <td>
                    <input type="number" class="form-control marks-input" 
                           data-student-id="${student.id}" 
                           value="${existingMark ? existingMark.obtainedMarks : ''}"
                           max="${subject.totalMarks}">
                </td>
            `;
            tableBody.appendChild(row);
        });
    };

    document.getElementById('marksSubjectId').addEventListener('change', updateMarksTable);

    document.getElementById('saveMarksBtn').addEventListener('click', () => {
        const examId = document.getElementById('marksExamId').value;
        const subjectId = document.getElementById('marksSubjectId').value;

        const marks = [];
        document.querySelectorAll('.marks-input').forEach(input => {
            const studentId = input.getAttribute('data-student-id');
            const obtainedMarks = parseInt(input.value) || 0;

            marks.push({
                id: generateId(),
                examId: examId,
                studentId: studentId,
                subject: subjectId,
                obtainedMarks: obtainedMarks
            });
        });

        db.marks = db.marks.filter(m => 
            !(m.examId === examId && m.subject === subjectId)
        );
        db.marks = db.marks.concat(marks);
        saveData();
        alert('نمبرات محفوظ ہو گئے!');
    });

    document.getElementById('backFromMarksBtn').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('exam-page').classList.add('active');
    });

    const updateResultCard = () => {
        const examId = document.getElementById('resultExamId').value;
        const studentId = document.getElementById('resultStudentId').value;
        const tableBody = document.getElementById('resultTableBody');
        tableBody.innerHTML = '';

        if (examId && studentId) {
            const exam = db.exams.find(e => e.id === examId);
            const student = db.students.find(s => s.id === studentId);
            const cls = db.classes.find(c => c.id === exam.classId);

            document.getElementById('resultMadrasaName').textContent = db.settings.madrasaName;
            document.getElementById('resultMadrasaAddress').textContent = db.settings.madrasaAddress;
            document.getElementById('resultStudentName').textContent = student.name;
            document.getElementById('resultFatherName').textContent = student.fatherName;
            document.getElementById('resultClassName').textContent = cls ? cls.name : '';
            document.getElementById('resultAdmissionNumber').textContent = student.admissionNumber;
            document.getElementById('resultExamName').textContent = exam.name;
            document.getElementById('resultDate').textContent = formatDate(exam.endDate);
            if (db.settings.madrasaStamp) {
                document.getElementById('resultStampArea').innerHTML = `<img src="${db.settings.madrasaStamp}" class="stamp-preview">`;
            }

            let totalMarks = 0;
            let obtainedMarks = 0;

            exam.subjects.forEach(subject => {
                const mark = db.marks.find(m => 
                    m.examId === examId && 
                    m.studentId === studentId && 
                    m.subject === subject.name
                );

                const subjectObtained = mark ? mark.obtainedMarks : 0;
                const percentage = subject.totalMarks > 0 ? (subjectObtained / subject.totalMarks * 100).toFixed(2) : 0;
                const grade = calculateGrade(percentage);

                totalMarks += subject.totalMarks;
                obtainedMarks += subjectObtained;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${subject.name}</td>
                    <td>${subject.totalMarks}</td>
                    <td>${subjectObtained}</td>
                    <td>${percentage}%</td>
                    <td>${grade}</td>
                `;
                tableBody.appendChild(row);
            });

            const overallPercentage = totalMarks > 0 ? (obtainedMarks / totalMarks * 100).toFixed(2) : 0;
            const overallGrade = calculateGrade(overallPercentage);

            document.getElementById('resultTotalMarks').textContent = totalMarks;
            document.getElementById('resultObtainedMarks').textContent = obtainedMarks;
            document.getElementById('resultPercentage').textContent = overallPercentage + '%';
            document.getElementById('resultGrade').textContent = overallGrade;
        }
    };

    const calculateGrade = (percentage) => {
        if (percentage >= 80) return 'A+';
        if (percentage >= 70) return 'A';
        if (percentage >= 60) return 'B';
        if (percentage >= 50) return 'C';
        if (percentage >= 40) return 'D';
        return 'F';
    };

    document.getElementById('resultExamId').addEventListener('change', () => {
        const examId = document.getElementById('resultExamId').value;
        const exam = db.exams.find(e => e.id === examId);
        const studentSelect = document.getElementById('resultStudentId');
        studentSelect.innerHTML = '';

        if (exam) {
            const students = db.students.filter(s => s.classId === exam.classId && s.status === 'active');
            studentSelect.innerHTML = students.map(student => 
                `<option value="${student.id}">${student.name}</option>`
            ).join('');
        }
        updateResultCard();
    });

    document.getElementById('resultStudentId').addEventListener('change', updateResultCard);

    document.getElementById('resultExamId').innerHTML = db.exams.map(exam => 
        `<option value="${exam.id}">${exam.name}</option>`
    ).join('');

    document.getElementById('printResultBtn').addEventListener('click', () => {
        window.print();
    });

    document.getElementById('backFromResultBtn').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('exam-page').classList.add('active');
    });

    // FEE FUNCTIONS

    const updateFeeTable = () => {
        const tableBody = document.getElementById('feeTableBody');
        const month = document.getElementById('feeMonth').value;
        const year = document.getElementById('feeYear').value;
        const classId = document.getElementById('feeClass').value;
        const status = document.getElementById('feeStatus').value;

        tableBody.innerHTML = '';

        let filteredFees = db.fees.filter(fee => {
            const feeDate = new Date(fee.dueDate);
            return feeDate.getMonth() + 1 === parseInt(month) &&
                   feeDate.getFullYear() === parseInt(year) &&
                   (!classId || db.students.find(s => s.id === fee.studentId)?.classId === classId) &&
                   (status === 'all' || fee.status === status);
        });

        filteredFees.forEach(fee => {
            const student = db.students.find(s => s.id === fee.studentId);
            const cls = db.classes.find(c => c.id === student?.classId);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student?.admissionNumber || ''}</td>
                <td>${student?.name || ''}</td>
                <td>${cls?.name || ''}</td>
                <td>${month}/${year}</td>
                <td>${fee.amount}</td>
                <td>${fee.paid || 0}</td>
                <td>${fee.amount - (fee.paid || 0)}</td>
                <td>${fee.status === 'paid' ? 'ادا شدہ' : fee.status === 'unpaid' ? 'غیر ادا شدہ' : 'جزوی ادا شدہ'}</td>
                <td>
                    <button class="btn collect-fee" data-id="${fee.id}">وصول کریں</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        document.querySelectorAll('.collect-fee').forEach(button => {
            button.addEventListener('click', () => {
                const feeId = button.getAttribute('data-id');
                collectFee(feeId);
            });
        });
    };

    document.getElementById('generateFeesBtn').addEventListener('click', () => {
        const month = document.getElementById('feeMonth').value;
        const year = document.getElementById('feeYear').value;
        const activeStudents = db.students.filter(s => s.status === 'active');

        activeStudents.forEach(student => {
            const cls = db.classes.find(c => c.id === student.classId);
            if (cls) {
                const existingFee = db.fees.find(f => 
                    f.studentId === student.id &&
                    new Date(f.dueDate).getMonth() + 1 === parseInt(month) &&
                    new Date(f.dueDate).getFullYear() === parseInt(year)
                );

                if (!existingFee) {
                    db.fees.push({
                        id: generateId(),
                        studentId: student.id,
                        amount: cls.fee,
                        paid: 0,
                        discount: 0,
                        dueDate: `${year}-${month.padStart(2, '0')}-01`,
                        paymentDate: null,
                        status: 'unpaid',
                        remarks: ''
                    });
                }
            }
        });

        saveData();
        updateFeeTable();
        alert('ماہانہ فیس تیار ہو گئی!');
    });

    document.getElementById('collectFeesBtn').addEventListener('click', () => {
        document.getElementById('feeCollectionForm').reset();
        document.getElementById('feeId').value = '';
        document.getElementById('feeDueDate').value = getCurrentDate();
        document.getElementById('feeStudentId').innerHTML = db.students
            .filter(s => s.status === 'active')
            .map(s => `<option value="${s.id}">${s.name}</option>`).join('');

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('fee-collection-page').classList.add('active');
    });

    const collectFee = (feeId) => {
        const fee = db.fees.find(f => f.id === feeId);
        if (fee) {
            const student = db.students.find(s => s.id === fee.studentId);
            document.getElementById('feeId').value = fee.id;
            document.getElementById('feeStudentId').innerHTML = `<option value="${student.id}">${student.name}</option>`;
            document.getElementById('feeDueDate').value = fee.dueDate;
            document.getElementById('feeAmount').value = fee.amount;
            document.getElementById('feeDiscount').value = fee.discount;
            document.getElementById('feePaid').value = '';
            document.getElementById('feeRemarks').value = fee.remarks;

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('fee-collection-page').classList.add('active');
        }
    };

    document.getElementById('feeCollectionForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const feeId = document.getElementById('feeId').value;
        const paidAmount = parseInt(document.getElementById('feePaid').value);
        const fee = {
            studentId: document.getElementById('feeStudentId').value,
            amount: parseInt(document.getElementById('feeAmount').value),
            discount: parseInt(document.getElementById('feeDiscount').value) || 0,
            paid: paidAmount,
            dueDate: document.getElementById('feeDueDate').value,
            paymentDate: getCurrentDate(),
            remarks: document.getElementById('feeRemarks').value
        };

        fee.status = fee.amount - fee.discount === paidAmount ? 'paid' : 
                     paidAmount > 0 ? 'partial' : 'unpaid';

        if (feeId) {
            const index = db.fees.findIndex(f => f.id === feeId);
            if (index !== -1) {
                fee.id = feeId;
                fee.paid += db.fees[index].paid;
                fee.status = fee.amount - fee.discount === fee.paid ? 'paid' : 
                            fee.paid > 0 ? 'partial' : 'unpaid';
                db.fees[index] = fee;
            }
        } else {
            fee.id = generateId();
            db.fees.push(fee);
        }

        saveData();
        updateDashboard();

        showFeeReceipt(fee.id);

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('fee-receipt-page').classList.add('active');
    });

    const showFeeReceipt = (feeId) => {
        const fee = db.fees.find(f => f.id === feeId);
        const student = db.students.find(s => s.id === fee.studentId);
        const cls = db.classes.find(c => c.id === student.classId);

        document.getElementById('receiptMadrasaName').textContent = db.settings.madrasaName;
        document.getElementById('receiptMadrasaAddress').textContent = db.settings.madrasaAddress;
        document.getElementById('receiptNumber').textContent = fee.id;
        document.getElementById('receiptStudentName').textContent = student.name;
        document.getElementById('receiptFatherName').textContent = student.fatherName;
        document.getElementById('receiptClassName').textContent = cls ? cls.name : '';
        document.getElementById('receiptAdmissionNumber').textContent = student.admissionNumber;
        document.getElementById('receiptDate').textContent = formatDate(fee.paymentDate);
        document.getElementById('receiptAmount').textContent = fee.amount;
        document.getElementById('receiptDiscount').textContent = fee.discount;
        document.getElementById('receiptTotal').textContent = fee.amount - fee.discount;
        document.getElementById('receiptPaid').textContent = fee.paid;
        document.getElementById('receiptBalance').textContent = (fee.amount - fee.discount) - fee.paid;
        document.getElementById('receiptRemarks').textContent = fee.remarks;
        if (db.settings.madrasaStamp) {
            document.getElementById('receiptStampArea').innerHTML = `<img src="${db.settings.madrasaStamp}" class="stamp-preview">`;
        }
    };

    document.getElementById('printReceiptBtn').addEventListener('click', () => {
        showFeeReceipt(document.getElementById('feeId').value);
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('fee-receipt-page').classList.add('active');
    });

    document.getElementById('printFeeReceiptBtn').addEventListener('click', () => {
        window.print();
    });

    document.getElementById('backFromReceiptBtn').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('fee-page').classList.add('active');
    });

    document.getElementById('cancelFeeForm').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('fee-page').classList.add('active');
    });

    document.getElementById('feeMonth').addEventListener('change', updateFeeTable);
    document.getElementById('feeYear').addEventListener('change', updateFeeTable);
    document.getElementById('feeClass').addEventListener('change', updateFeeTable);
    document.getElementById('feeStatus').addEventListener('change', updateFeeTable);

    // SALARY FUNCTIONS

    const updateSalaryTable = () => {
        const tableBody = document.getElementById('salaryTableBody');
        const month = document.getElementById('salaryMonth').value;
        const year = document.getElementById('salaryYear').value;
        const status = document.getElementById('salaryStatus').value;

        tableBody.innerHTML = '';

        let filteredSalaries = db.salaries.filter(salary => {
            const salaryDate = new Date(salary.dueDate);
            return salaryDate.getMonth() + 1 === parseInt(month) &&
                   salaryDate.getFullYear() === parseInt(year) &&
                   (status === 'all' || salary.status === status);
        });

        filteredSalaries.forEach(salary => {
            const teacher = db.teachers.find(t => t.id === salary.teacherId);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${teacher?.id || ''}</td>
                <td>${teacher?.name || ''}</td>
                <td>${month}/${year}</td>
                <td>${salary.basic}</td>
                <td>${salary.bonus || 0}</td>
                <td>${salary.deduction || 0}</td>
                <td>${salary.basic + (salary.bonus || 0) - (salary.deduction || 0)}</td>
                <td>${salary.status === 'paid' ? 'ادا شدہ' : 'غیر ادا شدہ'}</td>
                <td>
                    <button class="btn pay-salary" data-id="${salary.id}">ادا کریں</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        document.querySelectorAll('.pay-salary').forEach(button => {
            button.addEventListener('click', () => {
                const salaryId = button.getAttribute('data-id');
                paySalary(salaryId);
            });
        });
    };

    document.getElementById('paySalaryBtn').addEventListener('click', () => {
        document.getElementById('salaryPaymentForm').reset();
        document.getElementById('salaryId').value = '';
        document.getElementById('salaryDueDate').value = getCurrentDate();
        document.getElementById('salaryTeacherId').innerHTML = db.teachers
            .map(t => `<option value="${t.id}">${t.name}</option>`).join('');

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('salary-payment-page').classList.add('active');
    });

    const paySalary = (salaryId) => {
        const salary = db.salaries.find(s => s.id === salaryId);
        if (salary) {
            const teacher = db.teachers.find(t => t.id === salary.teacherId);
            document.getElementById('salaryId').value = salary.id;
            document.getElementById('salaryTeacherId').innerHTML = `<option value="${teacher.id}">${teacher.name}</option>`;
            document.getElementById('salaryDueDate').value = salary.dueDate;
            document.getElementById('salaryBasic').value = salary.basic;
            document.getElementById('salaryBonus').value = salary.bonus;
            document.getElementById('salaryDeduction').value = salary.deduction;
            document.getElementById('salaryRemarks').value = salary.remarks;

            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById('salary-payment-page').classList.add('active');
        }
    };

    document.getElementById('salaryPaymentForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const salaryId = document.getElementById('salaryId').value;
        const salary = {
            teacherId: document.getElementById('salaryTeacherId').value,
            basic: parseInt(document.getElementById('salaryBasic').value),
            bonus: parseInt(document.getElementById('salaryBonus').value) || 0,
            deduction: parseInt(document.getElementById('salaryDeduction').value) || 0,
            dueDate: document.getElementById('salaryDueDate').value,
            paymentDate: getCurrentDate(),
            remarks: document.getElementById('salaryRemarks').value,
            status: 'paid'
        };

        if (salaryId) {
            const index = db.salaries.findIndex(s => s.id === salaryId);
            if (index !== -1) {
                salary.id = salaryId;
                db.salaries[index] = salary;
            }
        } else {
            salary.id = generateId();
            db.salaries.push(salary);
        }

        saveData();
        showSalarySlip(salary.id);

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('salary-slip-page').classList.add('active');
    });

    const showSalarySlip = (salaryId) => {
        const salary = db.salaries.find(s => s.id === salaryId);
        const teacher = db.teachers.find(t => t.id === salary.teacherId);

        document.getElementById('slipMadrasaName').textContent = db.settings.madrasaName;
        document.getElementById('slipMadrasaAddress').textContent = db.settings.madrasaAddress;
        document.getElementById('slipNumber').textContent = salary.id;
        document.getElementById('slipTeacherName').textContent = teacher.name;
        document.getElementById('slipTeacherId').textContent = teacher.id;
        document.getElementById('slipDate').textContent = formatDate(salary.paymentDate);
        document.getElementById('slipBasic').textContent = salary.basic;
        document.getElementById('slipBonus').textContent = salary.bonus;
        document.getElementById('slipDeduction').textContent = salary.deduction;
        document.getElementById('slipTotal').textContent = salary.basic + salary.bonus - salary.deduction;
        document.getElementById('slipRemarks').textContent = salary.remarks;
        if (db.settings.madrasaStamp) {
            document.getElementById('slipStampArea').innerHTML = `<img src="${db.settings.madrasaStamp}" class="stamp-preview">`;
        }
    };

    document.getElementById('printSalarySlipBtn').addEventListener('click', () => {
        showSalarySlip(document.getElementById('salaryId').value);
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('salary-slip-page').classList.add('active');
    });

    document.getElementById('printSalarySlipBtn2').addEventListener('click', () => {
        window.print();
    });

    document.getElementById('backFromSlipBtn').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('salary-page').classList.add('active');
    });

    document.getElementById('cancelSalaryForm').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('salary-page').classList.add('active');
    });

    document.getElementById('salaryMonth').addEventListener('change', updateSalaryTable);
    document.getElementById('salaryYear').addEventListener('change', updateSalaryTable);
    document.getElementById('salaryStatus').addEventListener('change', updateSalaryTable);

    // LEDGER FUNCTIONS

    const updateLedgerTable = () => {
        const ledgerType = document.getElementById('ledgerType').value;
        const ledgerId = document.getElementById('ledgerId').value;
        const tableBody = document.getElementById('ledgerTableBody');
        tableBody.innerHTML = '';

        let filteredLedger = db.ledger.filter(entry => 
            entry.type === ledgerType && entry.entityId === ledgerId
        );

        let balance = 0;
        filteredLedger.forEach(entry => {
            balance += entry.entryType === 'credit' ? entry.amount : -entry.amount;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(entry.date)}</td>
                <td>${entry.description}</td>
                <td>${entry.entryType === 'credit' ? entry.amount : ''}</td>
                <td>${entry.entryType === 'debit' ? entry.amount : ''}</td>
                <td>${balance}</td>
            `;
            tableBody.appendChild(row);
        });

        document.getElementById('ledgerTitle').textContent = 
            ledgerType === 'student' ? 'طالب علم کا کھاتہ' :
            ledgerType === 'teacher' ? 'استاد کا کھاتہ' :
            'مدرسہ کا کھاتہ';
    };

    document.getElementById('ledgerType').addEventListener('change', () => {
        const ledgerType = document.getElementById('ledgerType').value;
        const ledgerIdSelect = document.getElementById('ledgerId');
        ledgerIdSelect.innerHTML = '';

        if (ledgerType === 'student') {
            ledgerIdSelect.innerHTML = db.students
                .filter(s => s.status === 'active')
                .map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        } else if (ledgerType === 'teacher') {
            ledgerIdSelect.innerHTML = db.teachers
                .map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        } else {
            ledgerIdSelect.innerHTML = `<option value="madrasa">مدرسہ</option>`;
        }

        updateLedgerTable();
    });

    document.getElementById('ledgerId').addEventListener('change', updateLedgerTable);

    document.getElementById('addLedgerEntryBtn').addEventListener('click', () => {
        document.getElementById('ledgerEntryForm').reset();
        document.getElementById('ledgerEntryId').value = '';
        document.getElementById('ledgerEntryDate').value = getCurrentDate();

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('ledger-entry-page').classList.add('active');
    });

    document.getElementById('ledgerEntryForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const entry = {
            id: generateId(),
            type: document.getElementById('ledgerType').value,
            entityId: document.getElementById('ledgerId').value,
            date: document.getElementById('ledgerEntryDate').value,
            entryType: document.getElementById('ledgerEntryType').value,
            amount: parseInt(document.getElementById('ledgerEntryAmount').value),
            description: document.getElementById('ledgerEntryDescription').value
        };

        db.ledger.push(entry);
        saveData();
        updateLedgerTable();

        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('ledger-page').classList.add('active');
    });

    document.getElementById('cancelLedgerEntryBtn').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById('ledger-page').classList.add('active');
    });

    document.getElementById('printLedgerBtn').addEventListener('click', () => {
        window.print();
    });

    // REPORT FUNCTIONS

    const generateReport = () => {
        const reportType = document.getElementById('reportType').value;
        const reportContent = document.getElementById('reportContent');
        const reportTitle = document.getElementById('reportTitle');
        reportContent.innerHTML = '';

        if (reportType === 'student') {
            reportTitle.textContent = 'طلبہ کی رپورٹ';
            let tableHTML = '<table class="register-table"><thead><tr><th>داخلہ نمبر</th><th>نام</th><th>کلاس</th><th>رابطہ</th><th>حیثیت</th></tr></thead><tbody>';
            db.students.forEach(student => {
                const cls = db.classes.find(c => c.id === student.classId);
                tableHTML += `
                    <tr>
                        <td>${student.admissionNumber}</td>
                        <td>${student.name}</td>
                        <td>${cls ? cls.name : ''}</td>
                        <td>${student.contactNumber || ''}</td>
                        <td>${student.status === 'active' ? 'فعال' : 'غیر فعال'}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            reportContent.innerHTML = tableHTML;

        } else if (reportType === 'teacher') {
            reportTitle.textContent = 'اساتذہ کی رپورٹ';
            let tableHTML = '<table class="register-table"><thead><tr><th>آئی ڈی</th><th>نام</th><th>مضامین</th><th>رابطہ</th><th>تنخواہ</th></tr></thead><tbody>';
            db.teachers.forEach(teacher => {
                tableHTML += `
                    <tr>
                        <td>${teacher.id}</td>
                        <td>${teacher.name}</td>
                        <td>${teacher.subjects || ''}</td>
                        <td>${teacher.phone || ''}</td>
                        <td>${teacher.salaryAmount}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            reportContent.innerHTML = tableHTML;

        } else if (reportType === 'fee') {
            reportTitle.textContent = 'فیس کی رپورٹ';
            let tableHTML = '<table class="register-table"><thead><tr><th>طالب علم</th><th>کلاس</th><th>مہینہ/سال</th><th>فیس</th><th>ادا شدہ</th><th>بقایا</th></tr></thead><tbody>';
            db.fees.forEach(fee => {
                const student = db.students.find(s => s.id === fee.studentId);
                const cls = db.classes.find(c => c.id === student?.classId);
                const feeDate = new Date(fee.dueDate);
                tableHTML += `
                    <tr>
                        <td>${student?.name || ''}</td>
                        <td>${cls?.name || ''}</td>
                        <td>${feeDate.getMonth() + 1}/${feeDate.getFullYear()}</td>
                        <td>${fee.amount}</td>
                        <td>${fee.paid || 0}</td>
                        <td>${fee.amount - (fee.paid || 0)}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            reportContent.innerHTML = tableHTML;

        } else if (reportType === 'attendance') {
            reportTitle.textContent = 'حاضری کی رپورٹ';
            reportContent.innerHTML = document.getElementById('attendanceSummary').innerHTML;

        } else if (reportType === 'exam') {
            reportTitle.textContent = 'امتحانی نتائج کی رپورٹ';
            let tableHTML = '<table class="register-table"><thead><tr><th>امتحان</th><th>طالب علم</th><th>مضمون</th><th>حاصل کردہ نمبر</th><th>کل نمبر</th></tr></thead><tbody>';
            db.marks.forEach(mark => {
                const exam = db.exams.find(e => e.id === mark.examId);
                const student = db.students.find(s => s.id === mark.studentId);
                const subject = exam.subjects.find(s => s.name === mark.subject);
                tableHTML += `
                    <tr>
                        <td>${exam.name}</td>
                        <td>${student?.name || ''}</td>
                        <td>${mark.subject}</td>
                        <td>${mark.obtainedMarks}</td>
                        <td>${subject.totalMarks}</td>
                    </tr>
                `;
            });
            tableHTML += '</tbody></table>';
            reportContent.innerHTML = tableHTML;

        } else if (reportType === 'finance') {
            reportTitle.textContent = 'مالی رپورٹ';
            let totalFees = db.fees.reduce((sum, fee) => sum + (fee.paid || 0), 0);
            let totalSalaries = db.salaries.reduce((sum, salary) => sum + (salary.basic + (salary.bonus || 0) - (salary.deduction || 0)), 0);
            let tableHTML = `
                <table class="register-table">
                    <tr><th>تفصیل</th><th>رقم</th></tr>
                    <tr><td>کل فیس وصولی</td><td>${totalFees}</td></tr>
                    <tr><td>کل تنخواہ کی ادائیگی</td><td>${totalSalaries}</td></tr>
                    <tr><td>خالص بیلنس</td><td>${totalFees - totalSalaries}</td></tr>
                </table>
            `;
            reportContent.innerHTML = tableHTML;
        }
    };

    document.getElementById('generateReportBtn').addEventListener('click', generateReport);
    document.getElementById('reportType').addEventListener('change', generateReport);

    document.getElementById('printReportBtn').addEventListener('click', () => {
        window.print();
    });

    // SETTINGS FUNCTIONS

    document.getElementById('madrasaInfoForm').addEventListener('submit', (e) => {
        e.preventDefault();

        db.settings.madrasaName = document.getElementById('madrasaName').value;
        db.settings.madrasaAddress = document.getElementById('madrasaAddress').value;
        db.settings.madrasaPhone = document.getElementById('madrasaPhone').value;
        db.settings.madrasaEmail = document.getElementById('madrasaEmail').value;
        db.settings.madrasaWebsite = document.getElementById('madrasaWebsite').value;

        saveData();
        updateUI();
        alert('معلومات محفوظ ہو گئی!');
    });

    document.getElementById('madrasaLogo').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                db.settings.madrasaLogo = event.target.result;
                document.getElementById('logoPreview').src = event.target.result;
                saveData();
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('madrasaStamp').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                db.settings.madrasaStamp = event.target.result;
                document.getElementById('stampPreview').src = event.target.result;
                saveData();
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('exportDataBtn').addEventListener('click', () => {
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'madrasa_data.json';
        link.click();
        URL.revokeObjectURL(url);
    });

    document.getElementById('importDataBtn').addEventListener('click', () => {
        document.getElementById('importDataFile').click();
    });

    document.getElementById('importDataFile').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    db = JSON.parse(event.target.result);
                    saveData();
                    updateUI();
                    alert('ڈیٹا کامیابی سے امپورٹ ہو گیا!');
                } catch (error) {
                    alert('ڈیٹا امپورٹ کرنے میں ناکامی!');
                }
            };
            reader.readAsText(file);
        }
    });

    document.getElementById('backupDataBtn').addEventListener('click', () => {
        const dataStr = JSON.stringify(db);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `madrasa_backup_${getCurrentDate()}.json`;
        link.click();
        URL.revokeObjectURL(url);
        alert('بیک اپ کامیابی سے بن گیا!');
    });

    // Initialize the application
    initApp();


/*                     ///////////// this is for the Notification feature yasin when needed///////////////////
function checkNotifications() {
    const today = new Date();
    const notifications = [];
    db.fees.forEach(fee => {
        const dueDate = new Date(fee.dueDate);
        if (dueDate > today && dueDate < new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000) && fee.status !== 'paid') {
            const student = db.students.find(s => s.id === fee.studentId);
            notifications.push(`Fee due for ${student.name} on ${formatDate(fee.dueDate)}`);
        }
    });
    const notificationDiv = document.createElement('div');
    notificationDiv.className = 'card';
    notificationDiv.innerHTML = `<h3>اطلاعات</h3><ul>${notifications.map(n => `<li>${n}</li>`).join('')}</ul>`;
    document.getElementById('dashboard-page').appendChild(notificationDiv);

    if (Notification.permission === 'granted') {
        notifications.forEach(n => new Notification(n));
    } else if (Notification.permission !== 'denied') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                notifications.forEach(n => new Notification(n));
            }
        });
    }
}
document.addEventListener('DOMContentLoaded', checkNotifications);
*/





// Load Chart.js from CDN and initialize charts
function loadChartJs(callback) {
    if (window.Chart) {
        callback();
        return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
    script.onload = callback;
    script.onerror = () => console.error('Failed to load Chart.js');
    document.head.appendChild(script);
}

// Initialize dashboard charts
function initDashboardCharts() {
    loadChartJs(() => {
        // Add chart containers to dashboard
        const dashboardPage = document.getElementById('dashboard-page');
        if (!dashboardPage) {
            console.error('Dashboard page not found');
            return;
        }
        const chartSection = document.createElement('div');
        chartSection.className = 'card';
        chartSection.style.marginTop = '20px';
        chartSection.innerHTML = `
            <h3>تجزیاتی چارٹس</h3>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label for="examSelect">امتحان منتخب کریں</label>
                    <select class="form-control" id="examSelect"></select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <button class="btn" id="refreshChartsBtn">چارٹس تازہ کریں</button>
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <canvas id="attendanceChart"></canvas>
                </div>
                <div style="flex: 1;">
                    <canvas id="feeChart"></canvas>
                </div>
            </div>
            <div class="form-row">
                <div style="flex: 1;">
                    <canvas id="examChart"></canvas>
                </div>
                <div style="flex: 1;">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        `;
        dashboardPage.appendChild(chartSection);

        // Populate exam dropdown
        const examSelect = document.getElementById('examSelect');
        examSelect.innerHTML = '<option value="">امتحان منتخب کریں</option>' + 
            (db.exams || []).map(exam => `<option value="${exam.id}">${exam.name}</option>`).join('');

        // Render all charts
        renderCharts();

        // Event listeners
        examSelect.addEventListener('change', renderCharts);
        document.getElementById('refreshChartsBtn').addEventListener('click', renderCharts);
    });
}

// Render all charts
function renderCharts() {
    renderAttendanceChart();
    renderFeeChart();
    renderExamChart();
    renderGrowthChart();
}

// Attendance Trend Chart (Line)
function renderAttendanceChart() {
    const canvas = document.getElementById('attendanceChart');
    const ctx = canvas?.getContext('2d');
    if (!ctx) {
        console.error('Attendance chart canvas not found');
        return;
    }

    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const labels = Array.from({ length: daysInMonth }, (_, i) => (i + 1).toString());
    const data = labels.map(day => {
        const date = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.padStart(2, '0')}`;
        const records = (db.attendance || []).filter(r => r.date === date && r.type === 'student');
        const total = records.length;
        const present = records.filter(r => r.status === 'present').length;
        return total > 0 ? (present / total * 100).toFixed(2) : 0;
    });

    if (data.every(d => d === 0)) {
        canvas.parentNode.innerHTML = '<p style="text-align: center;">اس مہینے کے لیے کوئی حاضری کا ڈیٹا نہیں ہے</p>';
        return;
    }

    // Safely destroy previous chart
    if (window.attendanceChart && typeof window.attendanceChart.destroy === 'function') {
        window.attendanceChart.destroy();
    }
    window.attendanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                label: 'حاضری فیصد',
                data,
                borderColor: '#333',
                backgroundColor: 'rgba(51, 51, 51, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'ماہانہ حاضری کا رجحان', font: { family: 'Arial', size: 18 } }
            },
            scales: {
                x: { title: { display: true, text: 'دن', font: { family: 'Arial' } } },
                y: { 
                    title: { display: true, text: 'حاضری (%)', font: { family: 'Arial' } },
                    beginAtZero: true,
                    max: 100
                }
            },
            layout: { padding: 10 }
        }
    });
}

// Fee Collection Chart (Bar)
function renderFeeChart() {
    const canvas = document.getElementById('feeChart');
    const ctx = canvas?.getContext('2d');
    if (!ctx) {
        console.error('Fee chart canvas not found');
        return;
    }

    const currentYear = new Date().getFullYear();
    const labels = ['جنوری', 'فروری', 'مارچ', 'اپریل', 'مئی', 'جون', 'جولائی', 'اگست', 'ستمبر', 'اکتوبر', 'نومبر', 'دسمبر'];
    const data = labels.map((_, i) => {
        return (db.fees || [])
            .filter(f => f.paymentDate && new Date(f.paymentDate).getFullYear() === currentYear && new Date(f.paymentDate).getMonth() === i)
            .reduce((sum, f) => sum + (f.paid || 0), 0);
    });

    if (data.every(d => d === 0)) {
        canvas.parentNode.innerHTML = '<p style="text-align: center;">اس سال کے لیے کوئی فیس کا ڈیٹا نہیں ہے</p>';
        return;
    }

    if (window.feeChart && typeof window.feeChart.destroy === 'function') {
        window.feeChart.destroy();
    }
    window.feeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'فیس وصولی (روپے)',
                data,
                backgroundColor: '#f9f7f1',
                borderColor: '#333',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'ماہانہ فیس وصولی', font: { family: 'Arial', size: 18 } }
            },
            scales: {
                x: { title: { display: true, text: 'مہینہ', font: { family: 'Arial' } } },
                y: { 
                    title: { display: true, text: 'رقم (روپے)', font: { family: 'Arial' } },
                    beginAtZero: true
                }
            },
            layout: { padding: 10 }
        }
    });
}

// Exam Performance Chart (Bar)
function renderExamChart() {
    const canvas = document.getElementById('examChart');
    const ctx = canvas?.getContext('2d');
    if (!ctx) {
        console.error('Exam chart canvas not found');
        return;
    }

    const examId = document.getElementById('examSelect')?.value;
    if (!examId) {
        canvas.parentNode.innerHTML = '<p style="text-align: center;">براہ کرم ایک امتحان منتخب کریں</p>';
        return;
    }

    const exam = (db.exams || []).find(e => e.id === examId);
    if (!exam) {
        canvas.parentNode.innerHTML = '<p style="text-align: center;">امتحان کا ڈیٹا نہیں ملا</p>';
        return;
    }

    const labels = (exam.subjects || []).map(s => s.name);
    const data = (exam.subjects || []).map(subject => {
        const marks = (db.marks || []).filter(m => m.examId === examId && m.subject === subject.name);
        const totalMarks = marks.reduce((sum, m) => sum + (m.obtainedMarks || 0), 0);
        return marks.length > 0 ? (totalMarks / marks.length).toFixed(2) : 0;
    });

    if (data.every(d => d === 0)) {
        canvas.parentNode.innerHTML = '<p style="text-align: center;">اس امتحان کے لیے کوئی نمبرات نہیں ہیں</p>';
        return;
    }

    if (window.examChart && typeof window.examChart.destroy === 'function') {
        window.examChart.destroy();
    }
    window.examChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [{
                label: 'اوسط نمبرات',
                data,
                backgroundColor: '#ebe6d9',
                borderColor: '#333',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: `امتحان: ${exam.name}`, font: { family: 'Arial', size: 18 } }
            },
            scales: {
                x: { title: { display: true, text: 'مضمون', font: { family: 'Arial' } } },
                y: { 
                    title: { display: true, text: 'اوسط نمبرات', font: { family: 'Arial' } },
                    beginAtZero: true,
                    max: 100
                }
            },
            layout: { padding: 10 }
        }
    });
}

// Student and Teacher Growth Chart (Line)
function renderGrowthChart() {
    const canvas = document.getElementById('growthChart');
    const ctx = canvas?.getContext('2d');
    if (!ctx) {
        console.error('Growth chart canvas not found');
        return;
    }

    const today = new Date();
    const labels = Array.from({ length: 12 }, (_, i) => {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        return `${date.getMonth() + 1}/${date.getFullYear()}`;
    }).reverse();

    const studentData = labels.map(label => {
        const [month, year] = label.split('/').map(Number);
        return (db.students || []).filter(s => {
            const admissionDate = s.admissionDate ? new Date(s.admissionDate) : new Date();
            return admissionDate.getFullYear() < year || 
                   (admissionDate.getFullYear() === year && admissionDate.getMonth() + 1 <= month);
        }).length;
    });

    const teacherData = labels.map(label => {
        const [month, year] = label.split('/').map(Number);
        return (db.teachers || []).filter(t => {
            const joiningDate = t.joiningDate ? new Date(t.joiningDate) : new Date();
            return joiningDate.getFullYear() < year || 
                   (joiningDate.getFullYear() === year && joiningDate.getMonth() + 1 <= month);
        }).length;
    });

    if (studentData.every(d => d === 0) && teacherData.every(d => d === 0)) {
        canvas.parentNode.innerHTML = '<p style="text-align: center;">کوئی طلبہ یا اساتذہ کا ڈیٹا نہیں ہے</p>';
        return;
    }

    if (window.growthChart && typeof window.growthChart.destroy === 'function') {
        window.growthChart.destroy();
    }
    window.growthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                {
                    label: 'طلبہ',
                    data: studentData,
                    borderColor: '#333',
                    backgroundColor: 'rgba(51, 51, 51, 0.1)',
                    fill: true
                },
                {
                    label: 'اساتذہ',
                    data: teacherData,
                    borderColor: '#999',
                    backgroundColor: 'rgba(153, 153, 153, 0.1)',
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'طلبہ اور اساتذہ کی تعداد', font: { family: 'Arial', size: 18 } }
            },
            scales: {
                x: { title: { display: true, text: 'مہینہ/سال', font: { family: 'Arial' } } },
                y: { 
                    title: { display: true, text: 'تعداد', font: { family: 'Arial' } },
                    beginAtZero: true
                }
            },
            layout: { padding: 10 }
        }
    });
}

// Hook into updateDashboard without reassignment
function wrapUpdateDashboard() {
    if (typeof updateDashboard === 'function') {
        const originalUpdateDashboard = updateDashboard;
        window.updateDashboard = function() {
            originalUpdateDashboard();
            renderCharts();
        };
    } else {
        console.warn('updateDashboard function not found, calling renderCharts directly');
        renderCharts();
    }
}

// Initialize charts and add sample data
document.addEventListener('DOMContentLoaded', () => {
    initDashboardCharts();
    wrapUpdateDashboard();
    addSampleData();
});

// Add sample data for testing
function addSampleData() {
    // Only add sample data if critical chart data is missing
    if (
        (db.attendance?.length > 0) &&
        (db.fees?.length > 0) &&
        (db.marks?.length > 0) &&
        (db.exams?.length > 0)
    ) {
        console.log('Chart data already exists, skipping sample data addition');
        return;
    }

    // Ensure generateId exists
    if (!window.generateId) {
        window.generateId = () => Date.now().toString() + Math.random().toString().slice(2, 8);
    }

    // Initialize db arrays if undefined
    db.students = db.students || [];
    db.teachers = db.teachers || [];
    db.classes = db.classes || [];
    db.exams = db.exams || [];
    db.fees = db.fees || [];
    db.attendance = db.attendance || [];
    db.marks = db.marks || [];

    // Clear existing data for testing (optional, comment out if you want to keep existing data)
    // db.students = [];
    // db.teachers = [];
    // db.classes = [];
    // db.exams = [];
    // db.fees = [];
    // db.attendance = [];
    // db.marks = [];

    /*	Add sample data
    const classId = generateId();
    db.classes.push({
        id: classId,
        name: 'پہلی جماعت',
        fee: 5000,
        subjects: [{ name: 'ریاضی', teacherId: '' }]
    });

    const studentId = generateId();
    db.students.push({
        id: studentId,
        name: 'علی احمد',
        fatherName: 'محمد احمد',
        admissionNumber: '001',
        classId: classId,
        contactNumber: '03001234567',
        admissionDate: '2024-12-01', // For growth chart
        status: 'active'
    });

    const teacherId = generateId();
    db.teachers.push({
        id: teacherId,
        name: 'احمد خان',
        contactNumber: '03101234567',
        joiningDate: '2024-11-01', // For growth chart
        salaryAmount: 30000,
        status: 'active'
    });

    const examId = generateId();
    db.exams.push({
        id: examId,
        name: 'ماہانہ امتحان اپریل 2025',
        classId: classId,
        startDate: '2025-04-01',
        endDate: '2025-04-05',
        subjects: [{ name: 'ریاضی', totalMarks: 100 }]
    });

    db.fees.push({
        id: generateId(),
        studentId: studentId,
        amount: 5000,
        paid: 5000,
        dueDate: '2025-04-01',
        paymentDate: '2025-04-01', // For fee chart
        status: 'paid'
    });

    db.attendance.push({
        id: generateId(),
        type: 'student',
        entityId: studentId,
        date: '2025-04-01', // For attendance chart
        status: 'present',
        comment: ''
    });

    db.marks.push({
        id: generateId(),
        examId: examId,
        studentId: studentId,
        subject: 'ریاضی',
        obtainedMarks: 85 // For exam chart
    });
*/
    // Save data and update UI
    if (typeof saveData === 'function') {
        saveData();
    }
    if (typeof updateUI === 'function') {
        updateUI();
    }
    renderCharts();
    console.log('Sample data added:', db);
}
    </script>
</body>
</html>
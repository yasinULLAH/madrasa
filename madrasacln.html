<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>School &amp; Madrasa Management System</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-bg: #ecf0f1;
            --dark-bg: #34495e;
            --text-color: #2c3e50;
            --border-color: #bdc3c7;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .logo h1 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--accent-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Navigation */
        .nav {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .nav-item {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 16px;
        }

        .nav-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .nav-item i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        /* Content Area */
        .content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .hidden {
            display: none !important;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
        }

        .table tr:hover {
            background: var(--light-bg);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card-header {
            border-bottom: 2px solid var(--light-bg);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .card-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--accent-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .nav-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Language Toggle */
        .language-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .content {
                box-shadow: none;
                border: 1px solid #000;
            }
        }

        /* Search and Filter */
        .search-filters {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding-right: 40px;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
        }

        /* Attendance Grid */
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .student-attendance {
            background: white;
            border: 2px solid var(--border-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .student-attendance h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .attendance-buttons {
            display: flex;
            justify-content: space-between;
            gap: 5px;
        }

        .attendance-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .attendance-present {
            background: var(--success-color);
            color: white;
        }

        .attendance-absent {
            background: var(--accent-color);
            color: white;
        }

        .attendance-late {
            background: var(--warning-color);
            color: white;
        }

        .attendance-leave {
            background: var(--dark-bg);
            color: white;
        }

        /* ID Card Styles */
        .id-card {
            width: 350px;
            height: 220px;
            background: white;
            border: 2px solid var(--primary-color);
            border-radius: 15px;
            padding: 15px;
            margin: 20px auto;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .id-card-header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .id-card-body {
            display: flex;
            gap: 15px;
        }

        .id-photo {
            width: 80px;
            height: 100px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background: var(--light-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-color);
        }

        .id-details {
            flex: 1;
            font-size: 14px;
        }

        .id-qr {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
        }

        /* Fee Collection */
        .fee-structure {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .fee-total {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary-color);
            border-top: 2px solid var(--primary-color);
            margin-top: 10px;
            padding-top: 10px;
        }

        /* Reception/Receipt */
        .receipt {
            max-width: 400px;
            margin: 20px auto;
            background: white;
            border: 2px dashed var(--primary-color);
            padding: 20px;
        }

        .receipt-header {
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .receipt-details {
            margin-bottom: 15px;
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
        }

        /* Progress Bars */
        .progress {
            background: var(--light-bg);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--secondary-color));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--accent-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --text-color: #ecf0f1;
                --light-bg: #2c3e50;
                --border-color: #34495e;
            }
        }
    </style>
<link href="manifest.json" rel="manifest"/></head>
<body>
<div id="loginSection">
<div class="container">
<div class="content" style="max-width: 400px; margin: 100px auto;">
<div class="card-header">
<h2 class="card-title text-center">School &amp; Madrasa Management</h2>
</div>
<form id="loginForm">
<div class="form-group">
<label>User Role</label>
<select class="form-control" id="userRole" required="">
<option value="">Select Role</option>
<option value="admin">Admin</option>
<option value="teacher">Teacher</option>
<option value="accountant">Accountant</option>
</select>
</div>
<div class="form-group">
<label>Username</label>
<input class="form-control" id="username" required="" type="text" value="admin"/>
</div>
<div class="form-group">
<label>Password</label>
<input class="form-control" id="password" required="" type="password" value="admin123"/>
</div>
<button class="btn btn-primary" style="width: 100%;" type="submit">Login</button>
</form>
</div>
</div>
</div>
<div class="hidden" id="mainApp">
<div class="container">
<!-- Header -->
<div class="header">
<div class="logo">
<img alt="School Logo" id="schoolLogo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjUiIGN5PSIyNSIgcj0iMjUiIGZpbGw9IiMyYzNlNTAiLz4KPHN2ZyB4PSIxMCIgeT0iMTAiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAzTDEgOWwxMSA2IDktNS05LTdtMCAwdjguMThtMC04LjE4TDIwIDEwdjdtLTggOWwtOS03Ii8+Cjwvc3ZnPgo8L3N2Zz4K"/>
<div>
<h1 id="schoolName">Al-Noor School &amp; Madrasa</h1>
<small id="currentUser"></small>
</div>
</div>
<div class="user-info">
<button class="language-toggle" onclick="toggleLanguage()">
<span id="langToggle">اردو</span>
</button>
<button class="btn btn-danger" onclick="logout()">Logout</button>
</div>
</div>
<!-- Navigation -->
<div class="nav no-print">
<div class="nav-grid" id="navigationGrid">
<button class="nav-item" onclick="showSection('dashboard')">
<span style="font-size: 2rem;">📊</span>
<span data-en="Dashboard" data-ur="ڈیش بورڈ">Dashboard</span>
</button>
<button class="nav-item" onclick="showSection('students')">
<span style="font-size: 2rem;">👨‍🎓</span>
<span data-en="Students" data-ur="طلباء">Students</span>
</button>
<button class="nav-item" onclick="showSection('teachers')">
<span style="font-size: 2rem;">👨‍🏫</span>
<span data-en="Teachers" data-ur="اساتذہ">Teachers</span>
</button>
<button class="nav-item" onclick="showSection('classes')">
<span style="font-size: 2rem;">🏫</span>
<span data-en="Classes" data-ur="کلاسیں">Classes</span>
</button>
<button class="nav-item" onclick="showSection('attendance')">
<span style="font-size: 2rem;">📝</span>
<span data-en="Attendance" data-ur="حاضری">Attendance</span>
</button>
<button class="nav-item" onclick="showSection('exams')">
<span style="font-size: 2rem;">📋</span>
<span data-en="Exams" data-ur="امتحانات">Exams</span>
</button>
<button class="nav-item" onclick="showSection('fees')">
<span style="font-size: 2rem;">💰</span>
<span data-en="Fees" data-ur="فیس">Fees</span>
</button>
<button class="nav-item" onclick="showSection('salary')">
<span style="font-size: 2rem;">💳</span>
<span data-en="Salary" data-ur="تنخواہ">Salary</span>
</button>
<button class="nav-item" onclick="showSection('library')">
<span style="font-size: 2rem;">📚</span>
<span data-en="Library" data-ur="لائبریری">Library</span>
</button>
<button class="nav-item" onclick="showSection('madrasa')">
<span style="font-size: 2rem;">📖</span>
<span data-en="Madrasa" data-ur="مدرسہ">Madrasa</span>
</button>
<button class="nav-item" onclick="showSection('reports')">
<span style="font-size: 2rem;">📈</span>
<span data-en="Reports" data-ur="رپورٹس">Reports</span>
</button>
<button class="nav-item" onclick="showSection('settings')">
<span style="font-size: 2rem;">⚙️</span>
<span data-en="Settings" data-ur="ترتیبات">Settings</span>
</button>
</div>
</div>
<!-- Content Area -->
<div class="content">
<!-- Dashboard Section -->
<div class="section" id="dashboardSection">
<h2 data-en="Dashboard" data-ur="ڈیش بورڈ">Dashboard</h2>
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalStudents">0</div>
<div class="stat-label" data-en="Total Students" data-ur="کل طلباء">Total Students</div>
</div>
<div class="stat-card">
<div class="stat-number" id="totalTeachers">0</div>
<div class="stat-label" data-en="Total Teachers" data-ur="کل اساتذہ">Total Teachers</div>
</div>
<div class="stat-card">
<div class="stat-number" id="totalFeeCollected">₨0</div>
<div class="stat-label" data-en="Fee Collected" data-ur="فیس جمع">Fee Collected</div>
</div>
<div class="stat-card">
<div class="stat-number" id="pendingFees">₨0</div>
<div class="stat-label" data-en="Pending Fees" data-ur="بقایا فیس">Pending Fees</div>
</div>
</div>
<div class="form-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Recent Activities" data-ur="حالیہ سرگرمیاں">Recent Activities</h3>
</div>
<div id="recentActivities">
<p data-en="No recent activities" data-ur="کوئی حالیہ سرگرمی نہیں">No recent activities</p>
</div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Quick Actions" data-ur="فوری اعمال">Quick Actions</h3>
</div>
<div style="display: grid; gap: 10px;">
<button class="btn btn-primary" onclick="showSection('students')">
<span data-en="Add New Student" data-ur="نیا طالب علم شامل کریں">Add New Student</span>
</button>
<button class="btn btn-success" onclick="showSection('attendance')">
<span data-en="Mark Attendance" data-ur="حاضری لگائیں">Mark Attendance</span>
</button>
<button class="btn btn-warning" onclick="showSection('fees')">
<span data-en="Collect Fees" data-ur="فیس جمع کریں">Collect Fees</span>
</button>
</div>
</div>
</div>
<div class="chart-container">
<canvas id="dashboardChart"></canvas>
</div>
</div>
<!-- Students Section -->
<div class="section hidden" id="studentsSection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Students Management" data-ur="طلباء کا انتظام">Students Management</h2>
<button class="btn btn-primary" onclick="openModal('studentModal')">
<span data-en="Add New Student" data-ur="نیا طالب علم شامل کریں">Add New Student</span>
</button>
</div>
<div class="search-filters">
<div class="search-box">
<input class="form-control search-input" id="studentSearch" onkeyup="searchStudents()" placeholder="Search students..." type="text"/>
<span class="search-icon">🔍</span>
</div>
<div class="form-group">
<select class="form-control" id="classFilter" onchange="filterStudents()">
<option value="">All Classes</option>
</select>
</div>
<div class="form-group">
<select class="form-control" id="feeStatusFilter" onchange="filterStudents()">
<option value="">All Fee Status</option>
<option value="paid">Fee Paid</option>
<option value="pending">Fee Pending</option>
</select>
</div>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th data-en="ID" data-ur="شناخت">ID</th>
<th data-en="Name" data-ur="نام">Name</th>
<th data-en="Class" data-ur="کلاس">Class</th>
<th data-en="Father Name" data-ur="والد کا نام">Father Name</th>
<th data-en="Phone" data-ur="فون">Phone</th>
<th data-en="Fee Status" data-ur="فیس کی صورتحال">Fee Status</th>
<th data-en="Actions" data-ur="اعمال">Actions</th>
</tr>
</thead>
<tbody id="studentsTableBody"></tbody>
</table>
</div>
</div>
<!-- Teachers Section -->
<div class="section hidden" id="teachersSection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Teachers Management" data-ur="اساتذہ کا انتظام">Teachers Management</h2>
<button class="btn btn-primary" onclick="openModal('teacherModal')">
<span data-en="Add New Teacher" data-ur="نیا استاد شامل کریں">Add New Teacher</span>
</button>
</div>
<div class="search-filters">
<div class="search-box">
<input class="form-control search-input" id="teacherSearch" onkeyup="searchTeachers()" placeholder="Search teachers..." type="text"/>
<span class="search-icon">🔍</span>
</div>
<div class="form-group">
<select class="form-control" id="subjectFilter" onchange="filterTeachers()">
<option value="">All Subjects</option>
</select>
</div>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th data-en="ID" data-ur="شناخت">ID</th>
<th data-en="Name" data-ur="نام">Name</th>
<th data-en="Subject" data-ur="مضمون">Subject</th>
<th data-en="Qualification" data-ur="تعلیمی قابلیت">Qualification</th>
<th data-en="Phone" data-ur="فون">Phone</th>
<th data-en="Salary" data-ur="تنخواہ">Salary</th>
<th data-en="Actions" data-ur="اعمال">Actions</th>
</tr>
</thead>
<tbody id="teachersTableBody"></tbody>
</table>
</div>
</div>
<!-- Classes Section -->
<div class="section hidden" id="classesSection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Classes &amp; Subjects" data-ur="کلاسیں اور مضامین">Classes &amp; Subjects</h2>
<div>
<button class="btn btn-primary" onclick="openModal('classModal')" style="margin-right: 10px;">
<span data-en="Add Class" data-ur="کلاس شامل کریں">Add Class</span>
</button>
<button class="btn btn-success" onclick="openModal('subjectModal')">
<span data-en="Add Subject" data-ur="مضمون شامل کریں">Add Subject</span>
</button>
</div>
</div>
<div class="form-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Classes" data-ur="کلاسیں">Classes</h3>
</div>
<div id="classesList"></div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Subjects" data-ur="مضامین">Subjects</h3>
</div>
<div id="subjectsList"></div>
</div>
</div>
</div>
<!-- Attendance Section -->
<div class="section hidden" id="attendanceSection">
<h2 data-en="Attendance Management" data-ur="حاضری کا انتظام">Attendance Management</h2>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Mark Today's Attendance" data-ur="آج کی حاضری لگائیں">Mark Today's Attendance</h3>
</div>
<div class="form-grid">
<div class="form-group">
<label data-en="Select Class" data-ur="کلاس منتخب کریں">Select Class</label>
<select class="form-control" id="attendanceClass" onchange="loadStudentsForAttendance()">
<option value="">Select Class</option>
</select>
</div>
<div class="form-group">
<label data-en="Date" data-ur="تاریخ">Date</label>
<input class="form-control" id="attendanceDate" type="date"/>
</div>
</div>
<div class="attendance-grid" id="attendanceGrid"></div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" onclick="saveAttendance()">
<span data-en="Save Attendance" data-ur="حاضری محفوظ کریں">Save Attendance</span>
</button>
<button class="btn btn-primary" onclick="generateAttendanceReport()" style="margin-left: 10px;">
<span data-en="Generate Report" data-ur="رپورٹ بنائیں">Generate Report</span>
</button>
</div>
</div>
</div>
<!-- Exams Section -->
<div class="section hidden" id="examsSection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Examinations" data-ur="امتحانات">Examinations</h2>
<button class="btn btn-primary" onclick="openModal('examModal')">
<span data-en="Create New Exam" data-ur="نیا امتحان بنائیں">Create New Exam</span>
</button>
</div>
<div class="form-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Exam List" data-ur="امتحانات کی فہرست">Exam List</h3>
</div>
<div id="examsList"></div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Enter Marks" data-ur="نمبر داخل کریں">Enter Marks</h3>
</div>
<div class="form-group">
<label data-en="Select Exam" data-ur="امتحان منتخب کریں">Select Exam</label>
<select class="form-control" id="marksExamSelect" onchange="loadExamMarks()">
<option value="">Select Exam</option>
</select>
</div>
<div id="marksEntry"></div>
</div>
</div>
</div>
<!-- Fees Section -->
<div class="section hidden" id="feesSection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Fee Management" data-ur="فیس کا انتظام">Fee Management</h2>
<div>
<button class="btn btn-primary" onclick="openModal('feeStructureModal')" style="margin-right: 10px;">
<span data-en="Fee Structure" data-ur="فیس کی ساخت">Fee Structure</span>
</button>
<button class="btn btn-success" onclick="openModal('feeCollectionModal')">
<span data-en="Collect Fee" data-ur="فیس جمع کریں">Collect Fee</span>
</button>
</div>
</div>
<div class="search-filters">
<div class="search-box">
<input class="form-control search-input" id="feeSearch" onkeyup="searchFees()" placeholder="Search by student name or ID..." type="text"/>
<span class="search-icon">🔍</span>
</div>
<div class="form-group">
<select class="form-control" id="feeStatusFilter2" onchange="filterFees()">
<option value="">All Status</option>
<option value="paid">Paid</option>
<option value="pending">Pending</option>
<option value="partial">Partially Paid</option>
</select>
</div>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th data-en="Student" data-ur="طالب علم">Student</th>
<th data-en="Class" data-ur="کلاس">Class</th>
<th data-en="Total Fee" data-ur="کل فیس">Total Fee</th>
<th data-en="Paid" data-ur="ادا شدہ">Paid</th>
<th data-en="Pending" data-ur="باقی">Pending</th>
<th data-en="Status" data-ur="صورتحال">Status</th>
<th data-en="Actions" data-ur="اعمال">Actions</th>
</tr>
</thead>
<tbody id="feesTableBody"></tbody>
</table>
</div>
</div>
<!-- Salary Section -->
<div class="section hidden" id="salarySection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Salary Management" data-ur="تنخواہ کا انتظام">Salary Management</h2>
<button class="btn btn-success" onclick="processMonthlySalary()">
<span data-en="Process Monthly Salary" data-ur="ماہانہ تنخواہ کا عمل">Process Monthly Salary</span>
</button>
</div>
<div class="form-grid">
<div class="form-group">
<label data-en="Select Month" data-ur="مہینہ منتخب کریں">Select Month</label>
<input class="form-control" id="salaryMonth" type="month"/>
</div>
<div class="form-group">
<button class="btn btn-primary" onclick="generateSalaryReport()">
<span data-en="Generate Salary Report" data-ur="تنخواہ کی رپورٹ بنائیں">Generate Salary Report</span>
</button>
</div>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th data-en="Teacher" data-ur="استاد">Teacher</th>
<th data-en="Basic Salary" data-ur="بنیادی تنخواہ">Basic Salary</th>
<th data-en="Allowances" data-ur="الاؤنسز">Allowances</th>
<th data-en="Deductions" data-ur="کٹوتیاں">Deductions</th>
<th data-en="Net Salary" data-ur="خالص تنخواہ">Net Salary</th>
<th data-en="Status" data-ur="صورتحال">Status</th>
<th data-en="Actions" data-ur="اعمال">Actions</th>
</tr>
</thead>
<tbody id="salaryTableBody"></tbody>
</table>
</div>
</div>
<!-- Library Section -->
<div class="section hidden" id="librarySection">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h2 data-en="Library Management" data-ur="لائبریری کا انتظام">Library Management</h2>
<button class="btn btn-primary" onclick="openModal('bookModal')">
<span data-en="Add New Book" data-ur="نئی کتاب شامل کریں">Add New Book</span>
</button>
</div>
<div class="form-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Book Issue/Return" data-ur="کتاب جاری/واپسی">Book Issue/Return</h3>
</div>
<form id="bookIssueForm">
<div class="form-group">
<label data-en="Student" data-ur="طالب علم">Student</label>
<select class="form-control" id="issueStudent" required="">
<option value="">Select Student</option>
</select>
</div>
<div class="form-group">
<label data-en="Book" data-ur="کتاب">Book</label>
<select class="form-control" id="issueBook" required="">
<option value="">Select Book</option>
</select>
</div>
<div class="form-group">
<label data-en="Return Date" data-ur="واپسی کی تاریخ">Return Date</label>
<input class="form-control" id="returnDate" required="" type="date"/>
</div>
<button class="btn btn-success" type="submit">
<span data-en="Issue Book" data-ur="کتاب جاری کریں">Issue Book</span>
</button>
</form>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Issued Books" data-ur="جاری کردہ کتابیں">Issued Books</h3>
</div>
<div id="issuedBooksList"></div>
</div>
</div>
<div class="table-responsive">
<table class="table">
<thead>
<tr>
<th data-en="Book ID" data-ur="کتاب کی شناخت">Book ID</th>
<th data-en="Title" data-ur="عنوان">Title</th>
<th data-en="Author" data-ur="مصنف">Author</th>
<th data-en="Category" data-ur="قسم">Category</th>
<th data-en="Copies" data-ur="کاپیاں">Copies</th>
<th data-en="Available" data-ur="دستیاب">Available</th>
<th data-en="Actions" data-ur="اعمال">Actions</th>
</tr>
</thead>
<tbody id="booksTableBody"></tbody>
</table>
</div>
</div>
<!-- Madrasa Section -->
<div class="section hidden" id="madrasaSection">
<h2 data-en="Madrasa Management" data-ur="مدرسہ کا انتظام">Madrasa Management</h2>
<div class="form-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Hifz Progress" data-ur="حفظ کی پیش قدمی">Hifz Progress</h3>
</div>
<form id="hifzProgressForm">
<div class="form-group">
<label data-en="Student" data-ur="طالب علم">Student</label>
<select class="form-control" id="hifzStudent" required="">
<option value="">Select Student</option>
</select>
</div>
<div class="form-group">
<label data-en="Sabaq (New Lesson)" data-ur="سبق (نیا سبق)">Sabaq (New Lesson)</label>
<input class="form-control" id="sabaq" placeholder="Surah and Ayah" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Sabaqi (Recent Revision)" data-ur="سبقی (حالیہ اعادہ)">Sabaqi (Recent Revision)</label>
<input class="form-control" id="sabaqi" placeholder="Surah and Ayah" type="text"/>
</div>
<div class="form-group">
<label data-en="Manzil (Old Revision)" data-ur="منزل (پرانا اعادہ)">Manzil (Old Revision)</label>
<input class="form-control" id="manzil" placeholder="Surah and Ayah" type="text"/>
</div>
<div class="form-group">
<label data-en="Performance" data-ur="کارکردگی">Performance</label>
<select class="form-control" id="hifzPerformance" required="">
<option value="">Select Performance</option>
<option value="excellent">Excellent</option>
<option value="good">Good</option>
<option value="average">Average</option>
<option value="needs-improvement">Needs Improvement</option>
</select>
</div>
<button class="btn btn-success" type="submit">
<span data-en="Save Progress" data-ur="پیش قدمی محفوظ کریں">Save Progress</span>
</button>
</form>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Progress Report" data-ur="پیش قدمی کی رپورٹ">Progress Report</h3>
</div>
<div class="form-group">
<label data-en="Select Student" data-ur="طالب علم منتخب کریں">Select Student</label>
<select class="form-control" id="progressReportStudent" onchange="loadHifzProgress()">
<option value="">Select Student</option>
</select>
</div>
<div id="hifzProgressReport"></div>
</div>
</div>
</div>
<!-- Reports Section -->
<div class="section hidden" id="reportsSection">
<h2 data-en="Reports &amp; Analytics" data-ur="رپورٹس اور تجزیات">Reports &amp; Analytics</h2>
<div class="form-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Generate Reports" data-ur="رپورٹس بنائیں">Generate Reports</h3>
</div>
<div style="display: grid; gap: 15px;">
<button class="btn btn-primary" onclick="generateStudentReport()">
<span data-en="Student Report" data-ur="طلباء کی رپورٹ">Student Report</span>
</button>
<button class="btn btn-primary" onclick="generateAttendanceReport()">
<span data-en="Attendance Report" data-ur="حاضری کی رپورٹ">Attendance Report</span>
</button>
<button class="btn btn-primary" onclick="generateFeeReport()">
<span data-en="Fee Collection Report" data-ur="فیس جمع کرنے کی رپورٹ">Fee Collection Report</span>
</button>
<button class="btn btn-primary" onclick="generateExamReport()">
<span data-en="Exam Results Report" data-ur="امتحانی نتائج کی رپورٹ">Exam Results Report</span>
</button>
<button class="btn btn-primary" onclick="generateIDCards()">
<span data-en="Generate ID Cards" data-ur="شناختی کارڈ بنائیں">Generate ID Cards</span>
</button>
</div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Data Management" data-ur="ڈیٹا کا انتظام">Data Management</h3>
</div>
<div style="display: grid; gap: 15px;">
<button class="btn btn-success" onclick="exportData()">
<span data-en="Export Data" data-ur="ڈیٹا ایکسپورٹ کریں">Export Data</span>
</button>
<input accept=".json" id="importFile" onchange="importData()" style="display: none;" type="file"/>
<button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
<span data-en="Import Data" data-ur="ڈیٹا درآمد کریں">Import Data</span>
</button>
<button class="btn btn-danger" onclick="clearAllData()">
<span data-en="Clear All Data" data-ur="تمام ڈیٹا صاف کریں">Clear All Data</span>
</button>
</div>
</div>
</div>
<div class="chart-container">
<canvas id="reportsChart"></canvas>
</div>
</div>
<!-- Settings Section -->
<div class="section hidden" id="settingsSection">
<h2 data-en="Settings" data-ur="ترتیبات">Settings</h2>
<div class="card">
<div class="card-header">
<h3 class="card-title" data-en="Institution Settings" data-ur="ادارے کی ترتیبات">Institution Settings</h3>
</div>
<form id="settingsForm">
<div class="form-grid">
<div class="form-group">
<label data-en="Institution Name" data-ur="ادارے کا نام">Institution Name</label>
<input class="form-control" id="institutionName" type="text" value="Al-Noor School &amp; Madrasa"/>
</div>
<div class="form-group">
<label data-en="Address" data-ur="پتہ">Address</label>
<textarea class="form-control" id="institutionAddress" rows="3"></textarea>
</div>
<div class="form-group">
<label data-en="Phone" data-ur="فون">Phone</label>
<input class="form-control" id="institutionPhone" type="tel"/>
</div>
<div class="form-group">
<label data-en="Email" data-ur="ای میل">Email</label>
<input class="form-control" id="institutionEmail" type="email"/>
</div>
<div class="form-group">
<label data-en="Academic Year Start" data-ur="تعلیمی سال کی شروعات">Academic Year Start</label>
<input class="form-control" id="academicYearStart" type="date"/>
</div>
<div class="form-group">
<label data-en="Academic Year End" data-ur="تعلیمی سال کا اختتام">Academic Year End</label>
<input class="form-control" id="academicYearEnd" type="date"/>
</div>
</div>
<button class="btn btn-success" type="submit">
<span data-en="Save Settings" data-ur="ترتیبات محفوظ کریں">Save Settings</span>
</button>
</form>
</div>
</div>
</div>
</div>
</div>
<!-- Modals -->
<!-- Student Modal -->
<div class="modal" id="studentModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Add/Edit Student" data-ur="طالب علم شامل/ترمیم کریں">Add/Edit Student</h3>
<span class="close" onclick="closeModal('studentModal')">×</span>
</div>
<form id="studentForm">
<input id="studentId" type="hidden"/>
<div class="form-grid">
<div class="form-group">
<label data-en="Student Name" data-ur="طالب علم کا نام">Student Name</label>
<input class="form-control" id="studentName" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Father Name" data-ur="والد کا نام">Father Name</label>
<input class="form-control" id="fatherName" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Date of Birth" data-ur="تاریخ پیدائش">Date of Birth</label>
<input class="form-control" id="dateOfBirth" type="date"/>
</div>
<div class="form-group">
<label data-en="Class" data-ur="کلاس">Class</label>
<select class="form-control" id="studentClass" required="">
</select>
</div>
<div class="form-group">
<label data-en="Address" data-ur="پتہ">Address</label>
<textarea class="form-control" id="studentAddress" rows="2"></textarea>
</div>
<div class="form-group">
<label data-en="Phone" data-ur="فون">Phone</label>
<input class="form-control" id="studentPhone" type="tel"/>
</div>
<div class="form-group">
<label data-en="Email" data-ur="ای میل">Email</label>
<input class="form-control" id="studentEmail" type="email"/>
</div>
<div class="form-group">
<label data-en="Fee Category" data-ur="فیس کی قسم">Fee Category</label>
<select class="form-control" id="feeCategory">
<option value="general">General</option>
<option value="deserving">Deserving</option>
</select>
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Save Student" data-ur="طالب علم محفوظ کریں">Save Student</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('studentModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Teacher Modal -->
<div class="modal" id="teacherModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Add/Edit Teacher" data-ur="استاد شامل/ترمیم کریں">Add/Edit Teacher</h3>
<span class="close" onclick="closeModal('teacherModal')">×</span>
</div>
<form id="teacherForm">
<input id="teacherId" type="hidden"/>
<div class="form-grid">
<div class="form-group">
<label data-en="Teacher Name" data-ur="استاد کا نام">Teacher Name</label>
<input class="form-control" id="teacherName" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Subject" data-ur="مضمون">Subject</label>
<select class="form-control" id="teacherSubject" required="">
</select>
</div>
<div class="form-group">
<label data-en="Qualification" data-ur="تعلیمی قابلیت">Qualification</label>
<input class="form-control" id="teacherQualification" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Experience (Years)" data-ur="تجربہ (سال)">Experience (Years)</label>
<input class="form-control" id="teacherExperience" type="number"/>
</div>
<div class="form-group">
<label data-en="Phone" data-ur="فون">Phone</label>
<input class="form-control" id="teacherPhone" required="" type="tel"/>
</div>
<div class="form-group">
<label data-en="Email" data-ur="ای میل">
<input class="form-control" id="teacherEmail" type="email"/>
</label></div>
<div class="form-group">
<label data-en="Address" data-ur="پتہ">Address</label>
<textarea class="form-control" id="teacherAddress" rows="2"></textarea>
</div>
<div class="form-group">
<label data-en="Salary" data-ur="تنخواہ">Salary</label>
<input class="form-control" id="teacherSalary" required="" type="number"/>
</div>
<div class="form-group">
<label data-en="Joining Date" data-ur="ملازمت کی تاریخ">Joining Date</label>
<input class="form-control" id="teacherJoiningDate" type="date"/>
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Save Teacher" data-ur="استاد محفوظ کریں">Save Teacher</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('teacherModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Class Modal -->
<div class="modal" id="classModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Add Class" data-ur="کلاس شامل کریں">Add Class</h3>
<span class="close" onclick="closeModal('classModal')">×</span>
</div>
<form id="classForm">
<div class="form-group">
<label data-en="Class Name" data-ur="کلاس کا نام">Class Name</label>
<input class="form-control" id="className" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Section" data-ur="سیکشن">Section</label>
<input class="form-control" id="classSection" type="text"/>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Add Class" data-ur="کلاس شامل کریں">Add Class</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('classModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Subject Modal -->
<div class="modal" id="subjectModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Add Subject" data-ur="مضمون شامل کریں">Add Subject</h3>
<span class="close" onclick="closeModal('subjectModal')">×</span>
</div>
<form id="subjectForm">
<div class="form-group">
<label data-en="Subject Name" data-ur="مضمون کا نام">Subject Name</label>
<input class="form-control" id="subjectName" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Subject Code" data-ur="مضمون کا کوڈ">Subject Code</label>
<input class="form-control" id="subjectCode" type="text"/>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Add Subject" data-ur="مضمون شامل کریں">Add Subject</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('subjectModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Exam Modal -->
<div class="modal" id="examModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Create Exam" data-ur="امتحان بنائیں">Create Exam</h3>
<span class="close" onclick="closeModal('examModal')">×</span>
</div>
<form id="examForm">
<div class="form-grid">
<div class="form-group">
<label data-en="Exam Name" data-ur="امتحان کا نام">Exam Name</label>
<input class="form-control" id="examName" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Exam Type" data-ur="امتحان کی قسم">Exam Type</label>
<select class="form-control" id="examType" required="">
<option value="">Select Type</option>
<option value="monthly">Monthly</option>
<option value="midterm">Mid Term</option>
<option value="final">Final</option>
<option value="quiz">Quiz</option>
</select>
</div>
<div class="form-group">
<label data-en="Class" data-ur="کلاس">Class</label>
<select class="form-control" id="examClass" required="">
</select>
</div>
<div class="form-group">
<label data-en="Subject" data-ur="مضمون">Subject</label>
<select class="form-control" id="examSubject" required="">
</select>
</div>
<div class="form-group">
<label data-en="Total Marks" data-ur="کل نمبر">Total Marks</label>
<input class="form-control" id="examTotalMarks" required="" type="number"/>
</div>
<div class="form-group">
<label data-en="Exam Date" data-ur="امتحان کی تاریخ">Exam Date</label>
<input class="form-control" id="examDate" required="" type="date"/>
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Create Exam" data-ur="امتحان بنائیں">Create Exam</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('examModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Fee Structure Modal -->
<div class="modal" id="feeStructureModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Fee Structure" data-ur="فیس کی ساخت">Fee Structure</h3>
<span class="close" onclick="closeModal('feeStructureModal')">×</span>
</div>
<form id="feeStructureForm">
<div class="form-grid">
<div class="form-group">
<label data-en="Class" data-ur="کلاس">Class</label>
<select class="form-control" id="feeClass" required="">
</select>
</div>
<div class="form-group">
<label data-en="Category" data-ur="قسم">Category</label>
<select class="form-control" id="feeCategoryType" required="">
<option value="general">General</option>
<option value="deserving">Deserving</option>
</select>
</div>
<div class="form-group">
<label data-en="Tuition Fee" data-ur="تعلیمی فیس">Tuition Fee</label>
<input class="form-control" id="tuitionFee" required="" type="number"/>
</div>
<div class="form-group">
<label data-en="Admission Fee" data-ur="داخلہ فیس">Admission Fee</label>
<input class="form-control" id="admissionFee" type="number"/>
</div>
<div class="form-group">
<label data-en="Exam Fee" data-ur="امتحانی فیس">Exam Fee</label>
<input class="form-control" id="examFee" type="number"/>
</div>
<div class="form-group">
<label data-en="Other Fee" data-ur="دیگر فیس">Other Fee</label>
<input class="form-control" id="otherFee" type="number"/>
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Save Fee Structure" data-ur="فیس کی ساخت محفوظ کریں">Save Fee Structure</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('feeStructureModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Fee Collection Modal -->
<div class="modal" id="feeCollectionModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Collect Fee" data-ur="فیس جمع کریں">Collect Fee</h3>
<span class="close" onclick="closeModal('feeCollectionModal')">×</span>
</div>
<form id="feeCollectionForm">
<div class="form-group">
<label data-en="Student" data-ur="طالب علم">Student</label>
<select class="form-control" id="feeStudent" onchange="loadStudentFeeDetails()" required="">
<option value="">Select Student</option>
</select>
</div>
<div id="studentFeeDetails"></div>
<div class="form-group">
<label data-en="Amount Paying" data-ur="ادا کرنے والی رقم">Amount Paying</label>
<input class="form-control" id="amountPaying" required="" type="number"/>
</div>
<div class="form-group">
<label data-en="Payment Method" data-ur="ادائیگی کا طریقہ">Payment Method</label>
<select class="form-control" id="paymentMethod" required="">
<option value="cash">Cash</option>
<option value="bank">Bank Transfer</option>
<option value="cheque">Cheque</option>
</select>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Collect Fee" data-ur="فیس جمع کریں">Collect Fee</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('feeCollectionModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Book Modal -->
<div class="modal" id="bookModal">
<div class="modal-content">
<div class="modal-header">
<h3 data-en="Add Book" data-ur="کتاب شامل کریں">Add Book</h3>
<span class="close" onclick="closeModal('bookModal')">×</span>
</div>
<form id="bookForm">
<div class="form-grid">
<div class="form-group">
<label data-en="Book Title" data-ur="کتاب کا عنوان">Book Title</label>
<input class="form-control" id="bookTitle" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="Author" data-ur="مصنف">Author</label>
<input class="form-control" id="bookAuthor" required="" type="text"/>
</div>
<div class="form-group">
<label data-en="ISBN" data-ur="آئی ایس بی این">ISBN</label>
<input class="form-control" id="bookISBN" type="text"/>
</div>
<div class="form-group">
<label data-en="Category" data-ur="قسم">Category</label>
<select class="form-control" id="bookCategory" required="">
<option value="">Select Category</option>
<option value="academic">Academic</option>
<option value="islamic">Islamic</option>
<option value="literature">Literature</option>
<option value="reference">Reference</option>
</select>
</div>
<div class="form-group">
<label data-en="Total Copies" data-ur="کل کاپیاں">Total Copies</label>
<input class="form-control" id="bookCopies" required="" type="number"/>
</div>
<div class="form-group">
<label data-en="Publisher" data-ur="پبلشر">Publisher</label>
<input class="form-control" id="bookPublisher" type="text"/>
</div>
</div>
<div style="text-align: center; margin-top: 20px;">
<button class="btn btn-success" type="submit">
<span data-en="Add Book" data-ur="کتاب شامل کریں">Add Book</span>
</button>
<button class="btn btn-secondary" onclick="closeModal('bookModal')" style="margin-left: 10px;" type="button">
<span data-en="Cancel" data-ur="منسوخ">Cancel</span>
</button>
</div>
</form>
</div>
</div>
<!-- Notification -->
<div class="notification" id="notification"></div>
<script>
        // Global Variables
        let currentUser = null;
        let currentLanguage = 'en';
        let db = null;

        // IndexedDB Setup
        const DB_NAME = 'SchoolMadrasaDB';
        const DB_VERSION = 1;

        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object stores
                    const stores = [
                        'students', 'teachers', 'classes', 'subjects', 'attendance', 'exams', 
                        'examMarks', 'feeStructure', 'feePayments', 'books', 'bookIssues', 
                        'hifzProgress', 'salary', 'settings', 'activities'
                    ];
                    
                    stores.forEach(storeName => {
                        if (!db.objectStoreNames.contains(storeName)) {
                            const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                            
                            // Create indexes based on store type
                            switch(storeName) {
                                case 'students':
                                    store.createIndex('name', 'name');
                                    store.createIndex('class', 'class');
                                    break;
                                case 'teachers':
                                    store.createIndex('name', 'name');
                                    store.createIndex('subject', 'subject');
                                    break;
                                case 'attendance':
                                    store.createIndex('date', 'date');
                                    store.createIndex('class', 'class');
                                    break;
                                case 'feePayments':
                                    store.createIndex('studentId', 'studentId');
                                    store.createIndex('date', 'date');
                                    break;
                            }
                        }
                    });
                };
            });
        };

        // Database Operations
        const saveData = async (storeName, data) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            return store.put(data);
        };

        const getData = async (storeName, id = null) => {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            
            if (id) {
                return store.get(id);
            } else {
                return store.getAll();
            }
        };

        const deleteData = async (storeName, id) => {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            return store.delete(id);
        };

        // Utility Functions
        const generateId = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const showNotification = (message, type = 'success') => {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        };

        const openModal = (modalId) => {
            document.getElementById(modalId).style.display = 'block';
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        const showSection = (sectionName) => {
            // Hide all sections
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(sectionName + 'Section').classList.remove('hidden');
            
            // Load section data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'students':
                    loadStudents();
                    break;
                case 'teachers':
                    loadTeachers();
                    break;
                case 'classes':
                    loadClasses();
                    break;
                case 'attendance':
                    loadAttendance();
                    break;
                case 'exams':
                    loadExams();
                    break;
                case 'fees':
                    loadFees();
                    break;
                case 'salary':
                    loadSalary();
                    break;
                case 'library':
                    loadLibrary();
                    break;
                case 'madrasa':
                    loadMadrasa();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        };

        // Language Functions
        const toggleLanguage = () => {
            currentLanguage = currentLanguage === 'en' ? 'ur' : 'en';
            updateLanguage();
        };

        const updateLanguage = () => {
            const elements = document.querySelectorAll('[data-en][data-ur]');
            elements.forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
            
            document.getElementById('langToggle').textContent = currentLanguage === 'en' ? 'اردو' : 'English';
            document.body.style.direction = currentLanguage === 'ur' ? 'rtl' : 'ltr';
        };

        // Authentication
        const login = (event) => {
            event.preventDefault();
            const role = document.getElementById('userRole').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (in real app, this should be secure)
            if (username && password && role) {
                currentUser = { username, role };
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('currentUser').textContent = `${role} - ${username}`;
                
                // Adjust UI based on role
                adjustUIForRole(role);
                
                // Load dashboard
                showSection('dashboard');
                
                showNotification('Login successful!');
            } else {
                showNotification('Please fill all fields', 'error');
            }
        };

        const logout = () => {
            currentUser = null;
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            showNotification('Logged out successfully');
        };

        const adjustUIForRole = (role) => {
            const navigation = document.getElementById('navigationGrid');
            const buttons = navigation.querySelectorAll('.nav-item');
            
            // Hide/show sections based on role
            buttons.forEach(button => {
                const text = button.querySelector('span[data-en]').getAttribute('data-en');
                
                if (role === 'teacher') {
                    // Teachers can only access certain sections
                    if (!['Dashboard', 'Students', 'Attendance', 'Exams', 'Madrasa'].includes(text)) {
                        button.style.display = 'none';
                    }
                } else if (role === 'accountant') {
                    // Accountants can access financial sections
                    if (!['Dashboard', 'Students', 'Fees', 'Salary', 'Reports'].includes(text)) {
                        button.style.display = 'none';
                    }
                }
                // Admin can access everything
            });
        };

        // Dashboard Functions
        const loadDashboard = async () => {
            try {
                const [students, teachers, feePayments] = await Promise.all([
                    getData('students'),
                    getData('teachers'),
                    getData('feePayments')
                ]);
                
                // Update statistics
                document.getElementById('totalStudents').textContent = students.length || 0;
                document.getElementById('totalTeachers').textContent = teachers.length || 0;
                
                const totalCollected = feePayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                document.getElementById('totalFeeCollected').textContent = `₨${totalCollected}`;
                
                // Load recent activities
                loadRecentActivities();
                
                // Create chart
                createDashboardChart(students, teachers, feePayments);
                
            } catch (error) {
                showNotification('Error loading dashboard', 'error');
            }
        };

        const loadRecentActivities = async () => {
            try {
                const activities = await getData('activities');
                const recentActivities = activities
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 5);
                
                const container = document.getElementById('recentActivities');
                if (recentActivities.length === 0) {
                    container.innerHTML = '<p>No recent activities</p>';
                } else {
                    container.innerHTML = recentActivities
                        .map(activity => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                <strong>${activity.action}</strong>
                                <small style="display: block; color: #666;">
                                    ${new Date(activity.timestamp).toLocaleString()}
                                </small>
                            </div>
                        `).join('');
                }
            } catch (error) {
                document.getElementById('recentActivities').innerHTML = '<p>Error loading activities</p>';
            }
        };

        const createDashboardChart = (students, teachers, feePayments) => {
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Teachers', 'Fee Payments'],
                    datasets: [{
                        data: [students.length, teachers.length, feePayments.length],
                        backgroundColor: [
                            '#3498db',
                            '#2c3e50',
                            '#27ae60'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        };

        // Students Functions
        const loadStudents = async () => {
            try {
                const [students, classes] = await Promise.all([
                    getData('students'),
                    getData('classes')
                ]);
                
                // Populate class dropdown
                populateSelect('studentClass', classes, 'name', 'name');
                populateSelect('classFilter', classes, 'name', 'name');
                
                displayStudents(students);
            } catch (error) {
                showNotification('Error loading students', 'error');
            }
        };

        const displayStudents = (students) => {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = students.map(student => `
                <tr>
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${student.class}</td>
                    <td>${student.fatherName}</td>
                    <td>${student.phone}</td>
                    <td>
                        <span class="badge ${student.feeStatus === 'paid' ? 'success' : 'warning'}">
                            ${student.feeStatus || 'Pending'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        const saveStudent = async (event) => {
            event.preventDefault();
            
            const studentData = {
                name: document.getElementById('studentName').value,
                fatherName: document.getElementById('fatherName').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                class: document.getElementById('studentClass').value,
                address: document.getElementById('studentAddress').value,
                phone: document.getElementById('studentPhone').value,
                email: document.getElementById('studentEmail').value,
                feeCategory: document.getElementById('feeCategory').value,
                timestamp: new Date().toISOString()
            };
            
            const id = document.getElementById('studentId').value;
            if (id) {
                studentData.id = parseInt(id);
            }
            
            try {
                await saveData('students', studentData);
                
                // Add activity
                await saveData('activities', {
                    action: `Student ${id ? 'updated' : 'added'}: ${studentData.name}`,
                    timestamp: new Date().toISOString(),
                    user: currentUser.username
                });
                
                closeModal('studentModal');
                loadStudents();
                showNotification(id ? 'Student updated successfully!' : 'Student added successfully!');
                document.getElementById('studentForm').reset();
            } catch (error) {
                showNotification('Error saving student', 'error');
            }
        };

        const editStudent = async (id) => {
            try {
                const student = await getData('students', id);
                if (student) {
                    document.getElementById('studentId').value = student.id;
                    document.getElementById('studentName').value = student.name || '';
                    document.getElementById('fatherName').value = student.fatherName || '';
                    document.getElementById('dateOfBirth').value = student.dateOfBirth || '';
                    document.getElementById('studentClass').value = student.class || '';
                    document.getElementById('studentAddress').value = student.address || '';
                    document.getElementById('studentPhone').value = student.phone || '';
                    document.getElementById('studentEmail').value = student.email || '';
                    document.getElementById('feeCategory').value = student.feeCategory || 'general';
                    
                    openModal('studentModal');
                }
            } catch (error) {
                showNotification('Error loading student data', 'error');
            }
        };

        const deleteStudent = async (id) => {
            if (confirm('Are you sure you want to delete this student?')) {
                try {
                    await deleteData('students', id);
                    loadStudents();
                    showNotification('Student deleted successfully!');
                } catch (error) {
                    showNotification('Error deleting student', 'error');
                }
            }
        };

        const searchStudents = () => {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        };

        const filterStudents = async () => {
            const classFilter = document.getElementById('classFilter').value;
            const feeStatusFilter = document.getElementById('feeStatusFilter').value;
            
            let students = await getData('students');
            
            if (classFilter) {
                students = students.filter(student => student.class === classFilter);
            }
            
            if (feeStatusFilter) {
                students = students.filter(student => student.feeStatus === feeStatusFilter);
            }
            
            displayStudents(students);
        };

        // Teachers Functions
        const loadTeachers = async () => {
            try {
                const [teachers, subjects] = await Promise.all([
                    getData('teachers'),
                    getData('subjects')
                ]);
                
                // Populate subject dropdown
                populateSelect('teacherSubject', subjects, 'name', 'name');
                populateSelect('subjectFilter', subjects, 'name', 'name');
                
                displayTeachers(teachers);
            } catch (error) {
                showNotification('Error loading teachers', 'error');
            }
        };

        const displayTeachers = (teachers) => {
            const tbody = document.getElementById('teachersTableBody');
            tbody.innerHTML = teachers.map(teacher => `
                <tr>
                    <td>${teacher.id}</td>
                    <td>${teacher.name}</td>
                    <td>${teacher.subject}</td>
                    <td>${teacher.qualification}</td>
                    <td>${teacher.phone}</td>
                    <td>₨${teacher.salary || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editTeacher(${teacher.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTeacher(${teacher.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        const saveTeacher = async (event) => {
            event.preventDefault();
            
            const teacherData = {
                name: document.getElementById('teacherName').value,
                subject: document.getElementById('teacherSubject').value,
                qualification: document.getElementById('teacherQualification').value,
                experience: parseInt(document.getElementById('teacherExperience').value) || 0,
                phone: document.getElementById('teacherPhone').value,
                email: document.getElementById('teacherEmail').value,
                address: document.getElementById('teacherAddress').value,
                salary: parseInt(document.getElementById('teacherSalary').value) || 0,
                joiningDate: document.getElementById('teacherJoiningDate').value,
                timestamp: new Date().toISOString()
            };
            
            const id = document.getElementById('teacherId').value;
            if (id) {
                teacherData.id = parseInt(id);
            }
            
            try {
                await saveData('teachers', teacherData);
                
                // Add activity
                await saveData('activities', {
                    action: `Teacher ${id ? 'updated' : 'added'}: ${teacherData.name}`,
                    timestamp: new Date().toISOString(),
                    user: currentUser.username
                });
                
                closeModal('teacherModal');
                loadTeachers();
                showNotification(id ? 'Teacher updated successfully!' : 'Teacher added successfully!');
                document.getElementById('teacherForm').reset();
            } catch (error) {
                showNotification('Error saving teacher', 'error');
            }
        };

        const editTeacher = async (id) => {
            try {
                const teacher = await getData('teachers', id);
                if (teacher) {
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name || '';
                    document.getElementById('teacherSubject').value = teacher.subject || '';
                    document.getElementById('teacherQualification').value = teacher.qualification || '';
                    document.getElementById('teacherExperience').value = teacher.experience || '';
                    document.getElementById('teacherPhone').value = teacher.phone || '';
                    document.getElementById('teacherEmail').value = teacher.email || '';
                    document.getElementById('teacherAddress').value = teacher.address || '';
                    document.getElementById('teacherSalary').value = teacher.salary || '';
                    document.getElementById('teacherJoiningDate').value = teacher.joiningDate || '';
                    
                    openModal('teacherModal');
                }
            } catch (error) {
                showNotification('Error loading teacher data', 'error');
            }
        };

        const deleteTeacher = async (id) => {
            if (confirm('Are you sure you want to delete this teacher?')) {
                try {
                    await deleteData('teachers', id);
                    loadTeachers();
                    showNotification('Teacher deleted successfully!');
                } catch (error) {
                    showNotification('Error deleting teacher', 'error');
                }
            }
        };

        const searchTeachers = () => {
            const searchTerm = document.getElementById('teacherSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#teachersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        };

        const filterTeachers = async () => {
            const subjectFilter = document.getElementById('subjectFilter').value;
            
            let teachers = await getData('teachers');
            
            if (subjectFilter) {
                teachers = teachers.filter(teacher => teacher.subject === subjectFilter);
            }
            
            displayTeachers(teachers);
        };

        // Classes Functions
        const loadClasses = async () => {
            try {
                const [classes, subjects] = await Promise.all([
                    getData('classes'),
                    getData('subjects')
                ]);
                
                displayClasses(classes);
                displaySubjects(subjects);
            } catch (error) {
                showNotification('Error loading classes', 'error');
            }
        };

        const displayClasses = (classes) => {
            const container = document.getElementById('classesList');
            container.innerHTML = classes.map(cls => `
                <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${cls.name}</strong>
                        ${cls.section ? ` - ${cls.section}` : ''}
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteClass(${cls.id})">Delete</button>
                </div>
            `).join('');
        };

        const displaySubjects = (subjects) => {
            const container = document.getElementById('subjectsList');
            container.innerHTML = subjects.map(subject => `
                <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${subject.name}</strong>
                        ${subject.code ? ` (${subject.code})` : ''}
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="deleteSubject(${subject.id})">Delete</button>
                </div>
            `).join('');
        };

        const saveClass = async (event) => {
            event.preventDefault();
            
            const classData = {
                name: document.getElementById('className').value,
                section: document.getElementById('classSection').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('classes', classData);
                closeModal('classModal');
                loadClasses();
                showNotification('Class added successfully!');
                document.getElementById('classForm').reset();
            } catch (error) {
                showNotification('Error saving class', 'error');
            }
        };

        const saveSubject = async (event) => {
            event.preventDefault();
            
            const subjectData = {
                name: document.getElementById('subjectName').value,
                code: document.getElementById('subjectCode').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('subjects', subjectData);
                closeModal('subjectModal');
                loadClasses();
                showNotification('Subject added successfully!');
                document.getElementById('subjectForm').reset();
            } catch (error) {
                showNotification('Error saving subject', 'error');
            }
        };

        const deleteClass = async (id) => {
            if (confirm('Are you sure you want to delete this class?')) {
                try {
                    await deleteData('classes', id);
                    loadClasses();
                    showNotification('Class deleted successfully!');
                } catch (error) {
                    showNotification('Error deleting class', 'error');
                }
            }
        };

        const deleteSubject = async (id) => {
            if (confirm('Are you sure you want to delete this subject?')) {
                try {
                    await deleteData('subjects', id);
                    loadClasses();
                    showNotification('Subject deleted successfully!');
                } catch (error) {
                    showNotification('Error deleting subject', 'error');
                }
            }
        };

        // Attendance Functions
        const loadAttendance = async () => {
            try {
                const classes = await getData('classes');
                populateSelect('attendanceClass', classes, 'name', 'name');
                
                // Set today's date
                document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
                
            } catch (error) {
                showNotification('Error loading attendance', 'error');
            }
        };

        const loadStudentsForAttendance = async () => {
            const selectedClass = document.getElementById('attendanceClass').value;
            if (!selectedClass) return;
            
            try {
                const students = await getData('students');
                const classStudents = students.filter(student => student.class === selectedClass);
                
                const container = document.getElementById('attendanceGrid');
                container.innerHTML = classStudents.map(student => `
                    <div class="student-attendance">
                        <h4>${student.name}</h4>
                        <div class="attendance-buttons">
                            <button class="attendance-btn attendance-present" onclick="markAttendance(${student.id}, 'present')">P</button>
                            <button class="attendance-btn attendance-absent" onclick="markAttendance(${student.id}, 'absent')">A</button>
                            <button class="attendance-btn attendance-late" onclick="markAttendance(${student.id}, 'late')">L</button>
                            <button class="attendance-btn attendance-leave" onclick="markAttendance(${student.id}, 'leave')">Leave</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                showNotification('Error loading students for attendance', 'error');
            }
        };

        let attendanceData = {};

        const markAttendance = (studentId, status) => {
            attendanceData[studentId] = status;
            
            // Update UI to show selected status
            const studentCard = event.target.closest('.student-attendance');
            const buttons = studentCard.querySelectorAll('.attendance-btn');
            buttons.forEach(btn => btn.style.opacity = '0.5');
            event.target.style.opacity = '1';
        };

        const saveAttendance = async () => {
            const selectedClass = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!selectedClass || !date || Object.keys(attendanceData).length === 0) {
                showNotification('Please select class, date and mark attendance', 'warning');
                return;
            }
            
            try {
                const attendanceRecord = {
                    class: selectedClass,
                    date: date,
                    attendance: attendanceData,
                    timestamp: new Date().toISOString(),
                    markedBy: currentUser.username
                };
                
                await saveData('attendance', attendanceRecord);
                
                // Add activity
                await saveData('activities', {
                    action: `Attendance marked for ${selectedClass} on ${date}`,
                    timestamp: new Date().toISOString(),
                    user: currentUser.username
                });
                
                showNotification('Attendance saved successfully!');
                attendanceData = {};
                document.getElementById('attendanceGrid').innerHTML = '';
                
            } catch (error) {
                showNotification('Error saving attendance', 'error');
            }
        };

        // Exam Functions
        const loadExams = async () => {
            try {
                const [exams, classes, subjects] = await Promise.all([
                    getData('exams'),
                    getData('classes'),
                    getData('subjects')
                ]);
                
                populateSelect('examClass', classes, 'name', 'name');
                populateSelect('examSubject', subjects, 'name', 'name');
                populateSelect('marksExamSelect', exams, 'name', 'id');
                
                displayExams(exams);
            } catch (error) {
                showNotification('Error loading exams', 'error');
            }
        };

        const displayExams = (exams) => {
            const container = document.getElementById('examsList');
            container.innerHTML = exams.map(exam => `
                <div style="padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 5px;">
                    <h4>${exam.name}</h4>
                    <p><strong>Type:</strong> ${exam.type}</p>
                    <p><strong>Class:</strong> ${exam.class} | <strong>Subject:</strong> ${exam.subject}</p>
                    <p><strong>Total Marks:</strong> ${exam.totalMarks} | <strong>Date:</strong> ${exam.date}</p>
                    <button class="btn btn-sm btn-danger" onclick="deleteExam(${exam.id})">Delete</button>
                </div>
            `).join('');
        };

        const saveExam = async (event) => {
            event.preventDefault();
            
            const examData = {
                name: document.getElementById('examName').value,
                type: document.getElementById('examType').value,
                class: document.getElementById('examClass').value,
                subject: document.getElementById('examSubject').value,
                totalMarks: parseInt(document.getElementById('examTotalMarks').value),
                date: document.getElementById('examDate').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('exams', examData);
                closeModal('examModal');
                loadExams();
                showNotification('Exam created successfully!');
                document.getElementById('examForm').reset();
            } catch (error) {
                showNotification('Error saving exam', 'error');
            }
        };

        const deleteExam = async (id) => {
            if (confirm('Are you sure you want to delete this exam?')) {
                try {
                    await deleteData('exams', id);
                    loadExams();
                    showNotification('Exam deleted successfully!');
                } catch (error) {
                    showNotification('Error deleting exam', 'error');
                }
            }
        };

        // Fee Functions
        const loadFees = async () => {
            try {
                const [students, feePayments, classes] = await Promise.all([
                    getData('students'),
                    getData('feePayments'),
                    getData('classes')
                ]);
                
                populateSelect('feeClass', classes, 'name', 'name');
                populateSelect('feeStudent', students, 'name', 'id');
                
                displayFees(students, feePayments);
            } catch (error) {
                showNotification('Error loading fees', 'error');
            }
        };

        const displayFees = (students, feePayments) => {
            const tbody = document.getElementById('feesTableBody');
            tbody.innerHTML = students.map(student => {
                const studentPayments = feePayments.filter(payment => payment.studentId === student.id);
                const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
                const totalFee = 5000; // This should come from fee structure
                const pending = totalFee - totalPaid;
                const status = pending <= 0 ? 'paid' : totalPaid > 0 ? 'partial' : 'pending';
                
                return `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.class}</td>
                        <td>₨${totalFee}</td>
                        <td>₨${totalPaid}</td>
                        <td>₨${pending}</td>
                        <td>
                            <span class="badge ${status === 'paid' ? 'success' : status === 'partial' ? 'warning' : 'danger'}">
                                ${status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="collectFee(${student.id})">Collect</button>
                            <button class="btn btn-sm btn-primary" onclick="generateReceipt(${student.id})">Receipt</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const saveFeeStructure = async (event) => {
            event.preventDefault();
            
            const feeData = {
                class: document.getElementById('feeClass').value,
                category: document.getElementById('feeCategoryType').value,
                tuitionFee: parseInt(document.getElementById('tuitionFee').value) || 0,
                admissionFee: parseInt(document.getElementById('admissionFee').value) || 0,
                examFee: parseInt(document.getElementById('examFee').value) || 0,
                otherFee: parseInt(document.getElementById('otherFee').value) || 0,
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('feeStructure', feeData);
                closeModal('feeStructureModal');
                showNotification('Fee structure saved successfully!');
                document.getElementById('feeStructureForm').reset();
            } catch (error) {
                showNotification('Error saving fee structure', 'error');
            }
        };

        const collectFee = (studentId) => {
            document.getElementById('feeStudent').value = studentId;
            loadStudentFeeDetails();
            openModal('feeCollectionModal');
        };

        const loadStudentFeeDetails = async () => {
            const studentId = parseInt(document.getElementById('feeStudent').value);
            if (!studentId) return;
            
            try {
                const [student, feePayments] = await Promise.all([
                    getData('students', studentId),
                    getData('feePayments')
                ]);
                
                const studentPayments = feePayments.filter(payment => payment.studentId === studentId);
                const totalPaid = studentPayments.reduce((sum, payment) => sum + payment.amount, 0);
                const totalFee = 5000; // This should come from fee structure
                const pending = totalFee - totalPaid;
                
                document.getElementById('studentFeeDetails').innerHTML = `
                    <div class="fee-structure">
                        <h4>${student.name} - ${student.class}</h4>
                        <div class="fee-item">
                            <span>Total Fee:</span>
                            <span>₨${totalFee}</span>
                        </div>
                        <div class="fee-item">
                            <span>Paid:</span>
                            <span>₨${totalPaid}</span>
                        </div>
                        <div class="fee-item fee-total">
                            <span>Pending:</span>
                            <span>₨${pending}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('amountPaying').max = pending;
                
            } catch (error) {
                showNotification('Error loading student fee details', 'error');
            }
        };

        const saveFeePayment = async (event) => {
            event.preventDefault();
            
            const paymentData = {
                studentId: parseInt(document.getElementById('feeStudent').value),
                amount: parseInt(document.getElementById('amountPaying').value),
                paymentMethod: document.getElementById('paymentMethod').value,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                collectedBy: currentUser.username
            };
            
            try {
                await saveData('feePayments', paymentData);
                
                // Add activity
                await saveData('activities', {
                    action: `Fee collected: ₨${paymentData.amount} from student ID ${paymentData.studentId}`,
                    timestamp: new Date().toISOString(),
                    user: currentUser.username
                });
                
                closeModal('feeCollectionModal');
                loadFees();
                showNotification('Fee payment recorded successfully!');
                document.getElementById('feeCollectionForm').reset();
                
            } catch (error) {
                showNotification('Error recording fee payment', 'error');
            }
        };

        // Utility Functions
        const populateSelect = (selectId, data, textField, valueField) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Select...</option>';
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item[valueField];
                option.textContent = item[textField];
                select.appendChild(option);
            });
        };

        // Library Functions
        const loadLibrary = async () => {
            try {
                const [books, students] = await Promise.all([
                    getData('books'),
                    getData('students')
                ]);
                
                populateSelect('issueStudent', students, 'name', 'id');
                populateSelect('issueBook', books, 'title', 'id');
                
                displayBooks(books);
                loadIssuedBooks();
                
            } catch (error) {
                showNotification('Error loading library', 'error');
            }
        };

        const displayBooks = (books) => {
            const tbody = document.getElementById('booksTableBody');
            tbody.innerHTML = books.map(book => `
                <tr>
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.category}</td>
                    <td>${book.totalCopies}</td>
                    <td>${book.availableCopies || book.totalCopies}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook(${book.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        const saveBook = async (event) => {
            event.preventDefault();
            
            const bookData = {
                title: document.getElementById('bookTitle').value,
                author: document.getElementById('bookAuthor').value,
                isbn: document.getElementById('bookISBN').value,
                category: document.getElementById('bookCategory').value,
                totalCopies: parseInt(document.getElementById('bookCopies').value),
                availableCopies: parseInt(document.getElementById('bookCopies').value),
                publisher: document.getElementById('bookPublisher').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('books', bookData);
                closeModal('bookModal');
                loadLibrary();
                showNotification('Book added successfully!');
                document.getElementById('bookForm').reset();
            } catch (error) {
                showNotification('Error saving book', 'error');
            }
        };

        const issueBook = async (event) => {
            event.preventDefault();
            
            const issueData = {
                studentId: parseInt(document.getElementById('issueStudent').value),
                bookId: parseInt(document.getElementById('issueBook').value),
                issueDate: new Date().toISOString().split('T')[0],
                returnDate: document.getElementById('returnDate').value,
                status: 'issued',
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('bookIssues', issueData);
                
                // Update available copies
                const book = await getData('books', issueData.bookId);
                book.availableCopies = (book.availableCopies || book.totalCopies) - 1;
                await saveData('books', book);
                
                loadLibrary();
                showNotification('Book issued successfully!');
                document.getElementById('bookIssueForm').reset();
                
            } catch (error) {
                showNotification('Error issuing book', 'error');
            }
        };

        const loadIssuedBooks = async () => {
            try {
                const [bookIssues, students, books] = await Promise.all([
                    getData('bookIssues'),
                    getData('students'),
                    getData('books')
                ]);
                
                const activeIssues = bookIssues.filter(issue => issue.status === 'issued');
                
                const container = document.getElementById('issuedBooksList');
                container.innerHTML = activeIssues.map(issue => {
                    const student = students.find(s => s.id === issue.studentId);
                    const book = books.find(b => b.id === issue.bookId);
                    
                    return `
                        <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px;">
                            <strong>${book?.title || 'Unknown Book'}</strong><br>
                            Student: ${student?.name || 'Unknown'}<br>
                            Return Date: ${issue.returnDate}<br>
                            <button class="btn btn-sm btn-success" onclick="returnBook(${issue.id})">Return</button>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                showNotification('Error loading issued books', 'error');
            }
        };

        const returnBook = async (issueId) => {
            try {
                const issue = await getData('bookIssues', issueId);
                issue.status = 'returned';
                issue.actualReturnDate = new Date().toISOString().split('T')[0];
                await saveData('bookIssues', issue);
                
                // Update available copies
                const book = await getData('books', issue.bookId);
                book.availableCopies = (book.availableCopies || 0) + 1;
                await saveData('books', book);
                
                loadLibrary();
                showNotification('Book returned successfully!');
                
            } catch (error) {
                showNotification('Error returning book', 'error');
            }
        };

        // Madrasa Functions
        const loadMadrasa = async () => {
            try {
                const students = await getData('students');
                populateSelect('hifzStudent', students, 'name', 'id');
                populateSelect('progressReportStudent', students, 'name', 'id');
            } catch (error) {
                showNotification('Error loading madrasa', 'error');
            }
        };

        const saveHifzProgress = async (event) => {
            event.preventDefault();
            
            const progressData = {
                studentId: parseInt(document.getElementById('hifzStudent').value),
                sabaq: document.getElementById('sabaq').value,
                sabaqi: document.getElementById('sabaqi').value,
                manzil: document.getElementById('manzil').value,
                performance: document.getElementById('hifzPerformance').value,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                teacher: currentUser.username
            };
            
            try {
                await saveData('hifzProgress', progressData);
                showNotification('Hifz progress saved successfully!');
                document.getElementById('hifzProgressForm').reset();
            } catch (error) {
                showNotification('Error saving hifz progress', 'error');
            }
        };

        const loadHifzProgress = async () => {
            const studentId = parseInt(document.getElementById('progressReportStudent').value);
            if (!studentId) return;
            
            try {
                const [student, progress] = await Promise.all([
                    getData('students', studentId),
                    getData('hifzProgress')
                ]);
                
                const studentProgress = progress
                    .filter(p => p.studentId === studentId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const container = document.getElementById('hifzProgressReport');
                container.innerHTML = `
                    <h4>${student.name} - Hifz Progress</h4>
                    ${studentProgress.map(p => `
                        <div style="padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px;">
                            <strong>Date:</strong> ${p.date}<br>
                            <strong>Sabaq:</strong> ${p.sabaq}<br>
                            <strong>Sabaqi:</strong> ${p.sabaqi}<br>
                            <strong>Manzil:</strong> ${p.manzil}<br>
                            <strong>Performance:</strong> ${p.performance}<br>
                        </div>
                    `).join('')}
                `;
                
            } catch (error) {
                showNotification('Error loading hifz progress', 'error');
            }
        };

        // Reports Functions
        const loadReports = () => {
            createReportsChart();
        };

        const createReportsChart = async () => {
            try {
                const [students, teachers, feePayments] = await Promise.all([
                    getData('students'),
                    getData('teachers'),
                    getData('feePayments')
                ]);
                
                const ctx = document.getElementById('reportsChart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Students', 'Teachers', 'Fee Collections'],
                        datasets: [{
                            label: 'Count',
                            data: [students.length, teachers.length, feePayments.length],
                            backgroundColor: [
                                '#3498db',
                                '#2c3e50',
                                '#27ae60'
                            ]
                        }]
                    },
                    options: {
                                                responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } catch (error) {
                showNotification('Error creating reports chart', 'error');
            }
        };

        const generateStudentReport = () => {
            window.print();
        };

        const generateAttendanceReport = async () => {
            try {
                const attendance = await getData('attendance');
                const reportData = attendance.map(record => ({
                    class: record.class,
                    date: record.date,
                    present: Object.values(record.attendance).filter(status => status === 'present').length,
                    absent: Object.values(record.attendance).filter(status => status === 'absent').length,
                    late: Object.values(record.attendance).filter(status => status === 'late').length
                }));
                
                console.log('Attendance Report:', reportData);
                showNotification('Attendance report generated. Check console for details.');
            } catch (error) {
                showNotification('Error generating attendance report', 'error');
            }
        };

        const generateFeeReport = async () => {
            try {
                const feePayments = await getData('feePayments');
                const totalCollected = feePayments.reduce((sum, payment) => sum + payment.amount, 0);
                
                console.log('Fee Report:');
                console.log('Total Collected:', totalCollected);
                console.log('Payment Details:', feePayments);
                
                showNotification('Fee report generated. Check console for details.');
            } catch (error) {
                showNotification('Error generating fee report', 'error');
            }
        };

        const generateExamReport = async () => {
            try {
                const [exams, examMarks] = await Promise.all([
                    getData('exams'),
                    getData('examMarks')
                ]);
                
                console.log('Exam Report:');
                console.log('Total Exams:', exams.length);
                console.log('Exam Details:', exams);
                console.log('Marks Details:', examMarks);
                
                showNotification('Exam report generated. Check console for details.');
            } catch (error) {
                showNotification('Error generating exam report', 'error');
            }
        };

        const generateIDCards = async () => {
            try {
                const students = await getData('students');
                const printWindow = window.open('', '_blank');
                
                const idCardsHTML = students.map(student => `
                    <div class="id-card">
                        <div class="id-card-header">
                            <h3>${document.getElementById('schoolName').textContent}</h3>
                            <p style="margin: 0; font-size: 12px;">Student ID Card</p>
                        </div>
                        <div class="id-card-body">
                            <div class="id-photo">
                                Photo
                            </div>
                            <div class="id-details">
                                <p><strong>Name:</strong> ${student.name}</p>
                                <p><strong>ID:</strong> ${student.id}</p>
                                <p><strong>Class:</strong> ${student.class}</p>
                                <p><strong>Father:</strong> ${student.fatherName}</p>
                            </div>
                        </div>
                        <div class="id-qr">
                            <canvas id="qr-${student.id}" width="50" height="50"></canvas>
                        </div>
                    </div>
                `).join('');
                
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Student ID Cards</title>
                            <style>
                                ${document.querySelector('style').innerHTML}
                                @media print {
                                    .id-card {
                                        page-break-after: always;
                                        margin: 20px;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            ${idCardsHTML}
                        </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // Generate QR codes
                students.forEach(student => {
                    const canvas = printWindow.document.getElementById(`qr-${student.id}`);
                    if (canvas) {
                        QRCode.toCanvas(canvas, `Student ID: ${student.id}`, { width: 50 });
                    }
                });
                
                setTimeout(() => printWindow.print(), 1000);
                
            } catch (error) {
                showNotification('Error generating ID cards', 'error');
            }
        };

        // Salary Functions
        const loadSalary = async () => {
            try {
                const teachers = await getData('teachers');
                displaySalaryTable(teachers);
                
                // Set current month
                const currentMonth = new Date().toISOString().slice(0, 7);
                document.getElementById('salaryMonth').value = currentMonth;
                
            } catch (error) {
                showNotification('Error loading salary', 'error');
            }
        };

        const displaySalaryTable = (teachers) => {
            const tbody = document.getElementById('salaryTableBody');
            tbody.innerHTML = teachers.map(teacher => {
                const basicSalary = teacher.salary || 0;
                const allowances = Math.floor(basicSalary * 0.1); // 10% allowances
                const deductions = Math.floor(basicSalary * 0.05); // 5% deductions
                const netSalary = basicSalary + allowances - deductions;
                
                return `
                    <tr>
                        <td>${teacher.name}</td>
                        <td>₨${basicSalary}</td>
                        <td>₨${allowances}</td>
                        <td>₨${deductions}</td>
                        <td>₨${netSalary}</td>
                        <td>
                            <span class="badge warning">Pending</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="processSalary(${teacher.id})">Process</button>
                            <button class="btn btn-sm btn-primary" onclick="generatePayslip(${teacher.id})">Payslip</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        const processMonthlySalary = async () => {
            try {
                const teachers = await getData('teachers');
                const month = document.getElementById('salaryMonth').value;
                
                for (const teacher of teachers) {
                    const salaryRecord = {
                        teacherId: teacher.id,
                        month: month,
                        basicSalary: teacher.salary || 0,
                        allowances: Math.floor((teacher.salary || 0) * 0.1),
                        deductions: Math.floor((teacher.salary || 0) * 0.05),
                        netSalary: (teacher.salary || 0) + Math.floor((teacher.salary || 0) * 0.1) - Math.floor((teacher.salary || 0) * 0.05),
                        status: 'processed',
                        processedDate: new Date().toISOString(),
                        processedBy: currentUser.username
                    };
                    
                    await saveData('salary', salaryRecord);
                }
                
                showNotification('Monthly salary processed successfully!');
                loadSalary();
                
            } catch (error) {
                showNotification('Error processing salary', 'error');
            }
        };

        const generatePayslip = async (teacherId) => {
            try {
                const teacher = await getData('teachers', teacherId);
                const month = document.getElementById('salaryMonth').value;
                
                const basicSalary = teacher.salary || 0;
                const allowances = Math.floor(basicSalary * 0.1);
                const deductions = Math.floor(basicSalary * 0.05);
                const netSalary = basicSalary + allowances - deductions;
                
                const payslipHTML = `
                    <div class="receipt">
                        <div class="receipt-header">
                            <h3>${document.getElementById('schoolName').textContent}</h3>
                            <h4>Salary Slip</h4>
                            <p>Month: ${month}</p>
                        </div>
                        <div class="receipt-details">
                            <div class="receipt-row">
                                <span><strong>Teacher:</strong></span>
                                <span>${teacher.name}</span>
                            </div>
                            <div class="receipt-row">
                                <span><strong>Designation:</strong></span>
                                <span>${teacher.subject} Teacher</span>
                            </div>
                            <div class="receipt-row">
                                <span>Basic Salary:</span>
                                <span>₨${basicSalary}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Allowances:</span>
                                <span>₨${allowances}</span>
                            </div>
                            <div class="receipt-row">
                                <span>Deductions:</span>
                                <span>₨${deductions}</span>
                            </div>
                            <div class="receipt-row" style="border-top: 2px solid #000; font-weight: bold;">
                                <span>Net Salary:</span>
                                <span>₨${netSalary}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Payslip - ${teacher.name}</title>
                            <style>${document.querySelector('style').innerHTML}</style>
                        </head>
                        <body>${payslipHTML}</body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
                
            } catch (error) {
                showNotification('Error generating payslip', 'error');
            }
        };

        // Settings Functions
        const loadSettings = async () => {
            try {
                const settings = await getData('settings');
                if (settings.length > 0) {
                    const setting = settings[0];
                    document.getElementById('institutionName').value = setting.name || '';
                    document.getElementById('institutionAddress').value = setting.address || '';
                    document.getElementById('institutionPhone').value = setting.phone || '';
                    document.getElementById('institutionEmail').value = setting.email || '';
                    document.getElementById('academicYearStart').value = setting.academicYearStart || '';
                    document.getElementById('academicYearEnd').value = setting.academicYearEnd || '';
                }
            } catch (error) {
                showNotification('Error loading settings', 'error');
            }
        };

        const saveSettings = async (event) => {
            event.preventDefault();
            
            const settingsData = {
                id: 1, // Always use ID 1 for settings
                name: document.getElementById('institutionName').value,
                address: document.getElementById('institutionAddress').value,
                phone: document.getElementById('institutionPhone').value,
                email: document.getElementById('institutionEmail').value,
                academicYearStart: document.getElementById('academicYearStart').value,
                academicYearEnd: document.getElementById('academicYearEnd').value,
                timestamp: new Date().toISOString()
            };
            
            try {
                await saveData('settings', settingsData);
                
                // Update header
                document.getElementById('schoolName').textContent = settingsData.name;
                
                showNotification('Settings saved successfully!');
            } catch (error) {
                showNotification('Error saving settings', 'error');
            }
        };

        // Data Management Functions
        const exportData = async () => {
            try {
                const stores = [
                    'students', 'teachers', 'classes', 'subjects', 'attendance', 'exams',
                    'examMarks', 'feeStructure', 'feePayments', 'books', 'bookIssues',
                    'hifzProgress', 'salary', 'settings', 'activities'
                ];
                
                const exportData = {};
                
                for (const store of stores) {
                    exportData[store] = await getData(store);
                }
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `school_data_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Data exported successfully!');
                
            } catch (error) {
                showNotification('Error exporting data', 'error');
            }
        };

        const importData = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedData = JSON.parse(text);
                
                const stores = Object.keys(importedData);
                
                for (const store of stores) {
                    const data = importedData[store];
                    for (const item of data) {
                        await saveData(store, item);
                    }
                }
                
                showNotification('Data imported successfully!');
                showSection('dashboard');
                
            } catch (error) {
                showNotification('Error importing data', 'error');
            }
        };

        const clearAllData = async () => {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone!')) {
                if (confirm('This will delete ALL students, teachers, and other data. Are you absolutely sure?')) {
                    try {
                        const stores = [
                            'students', 'teachers', 'classes', 'subjects', 'attendance', 'exams',
                            'examMarks', 'feeStructure', 'feePayments', 'books', 'bookIssues',
                            'hifzProgress', 'salary', 'activities'
                        ];
                        
                        for (const storeName of stores) {
                            const transaction = db.transaction([storeName], 'readwrite');
                            const store = transaction.objectStore(storeName);
                            await store.clear();
                        }
                        
                        showNotification('All data cleared successfully!');
                        showSection('dashboard');
                        
                    } catch (error) {
                        showNotification('Error clearing data', 'error');
                    }
                }
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initDB();
                console.log('Database initialized successfully');
                
                // Add some sample data if database is empty
                const students = await getData('students');
                if (students.length === 0) {
                    await initializeSampleData();
                }
                
            } catch (error) {
                console.error('Error initializing database:', error);
                showNotification('Error initializing database', 'error');
            }
        });

        // Form event listeners
        document.getElementById('loginForm').addEventListener('submit', login);
        document.getElementById('studentForm').addEventListener('submit', saveStudent);
        document.getElementById('teacherForm').addEventListener('submit', saveTeacher);
        document.getElementById('classForm').addEventListener('submit', saveClass);
        document.getElementById('subjectForm').addEventListener('submit', saveSubject);
        document.getElementById('examForm').addEventListener('submit', saveExam);
        document.getElementById('feeStructureForm').addEventListener('submit', saveFeeStructure);
        document.getElementById('feeCollectionForm').addEventListener('submit', saveFeePayment);
        document.getElementById('bookForm').addEventListener('submit', saveBook);
        document.getElementById('bookIssueForm').addEventListener('submit', issueBook);
        document.getElementById('hifzProgressForm').addEventListener('submit', saveHifzProgress);
        document.getElementById('settingsForm').addEventListener('submit', saveSettings);

        // Initialize sample data
        const initializeSampleData = async () => {
            try {
                // Sample classes
                const sampleClasses = [
                    { name: 'Class 1', section: 'A' },
                    { name: 'Class 2', section: 'A' },
                    { name: 'Class 3', section: 'A' },
                    { name: 'Hifz Class', section: 'A' }
                ];
                
                for (const cls of sampleClasses) {
                    await saveData('classes', cls);
                }
                
                // Sample subjects
                const sampleSubjects = [
                    { name: 'Mathematics', code: 'MATH' },
                    { name: 'English', code: 'ENG' },
                    { name: 'Urdu', code: 'URD' },
                    { name: 'Islamiat', code: 'ISL' },
                    { name: 'Science', code: 'SCI' },
                    { name: 'Quran', code: 'QUR' }
                ];
                
                for (const subject of sampleSubjects) {
                    await saveData('subjects', subject);
                }
                
                // Sample students
                const sampleStudents = [
                    {
                        name: 'Muhammad Ahmad',
                        fatherName: 'Muhammad Ali',
                        class: 'Class 1',
                        phone: '03001234567',
                        email: 'ahmad@example.com',
                        feeCategory: 'general',
                        address: 'Sample Address 1'
                    },
                    {
                        name: 'Fatima Khan',
                        fatherName: 'Abdul Khan',
                        class: 'Class 2',
                        phone: '03001234568',
                        email: 'fatima@example.com',
                        feeCategory: 'general',
                        address: 'Sample Address 2'
                    }
                ];
                
                for (const student of sampleStudents) {
                    await saveData('students', student);
                }
                
                // Sample teachers
                const sampleTeachers = [
                    {
                        name: 'Ustad Muhammad Hassan',
                        subject: 'Mathematics',
                        qualification: 'M.Sc Mathematics',
                        phone: '03009876543',
                        salary: 25000,
                        experience: 5
                    },
                    {
                        name: 'Ustaza Aisha Siddiq',
                        subject: 'English',
                        qualification: 'M.A English',
                        phone: '03009876544',
                        salary: 23000,
                        experience: 3
                    }
                ];
                
                for (const teacher of sampleTeachers) {
                    await saveData('teachers', teacher);
                }
                
                console.log('Sample data initialized');
                
            } catch (error) {
                console.error('Error initializing sample data:', error);
            }
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Print functionality
        window.addEventListener('beforeprint', () => {
            document.body.classList.add('printing');
        });

        window.addEventListener('afterprint', () => {
            document.body.classList.remove('printing');
        });

    </script>
<script type="module">
  import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

  const swUrl = './sw.js';
  const wb = new Workbox(swUrl);

  // This event fires when a new service worker has installed but is waiting to activate.
  wb.addEventListener('waiting', (event) => {
    console.log('A new service worker is waiting to activate.');
    // This sends a message to the waiting service worker, telling it to activate.
    wb.messageSW({ type: 'SKIP_WAITING' });
  });

  // This event fires when the new service worker has taken control.
  wb.addEventListener('controlling', (event) => {
    console.log('The new service worker is now in control. Reloading page for updates...');
    window.location.reload();
  });

  // Register the service worker.
  wb.register();
</script></body>
</html>

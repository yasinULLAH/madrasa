<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>School &amp; Madrasa Management System</title>
<style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --sidebar-width: 250px;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }

        /* Header Styles */
        header {
            background-color: var(--dark-color);
            color: white;
            height: var(--header-height);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo img {
            height: 40px;
            width: 40px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark-color);
            color: white;
            position: fixed;
            top: var(--header-height);
            left: 0;
            bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 90;
        }

        .sidebar-menu {
            list-style: none;
            padding: 15px 0;
        }

        .sidebar-menu li {
            position: relative;
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-menu li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu li a i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .sidebar-menu li.active a {
            background-color: var(--primary-color);
        }

        .submenu {
            list-style: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background-color: rgba(0, 0, 0, 0.1);
        }

        .submenu li a {
            padding-left: 50px;
        }

        .sidebar-menu li.has-submenu>a::after {
            content: '\f078';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            margin-left: auto;
            transition: transform 0.3s;
        }

        .sidebar-menu li.has-submenu.open>a::after {
            transform: rotate(180deg);
        }

        /* Main Content Styles */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 20px;
            transition: margin-left 0.3s ease;
            min-height: calc(100vh - var(--header-height));
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }

        .page-header h2 {
            color: var(--dark-color);
        }

        .breadcrumb {
            display: flex;
            list-style: none;
            gap: 5px;
        }

        .breadcrumb li {
            font-size: 0.9rem;
        }

        .breadcrumb li:not(:last-child)::after {
            content: '/';
            margin-left: 5px;
        }

        /* Dashboard Styles */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .stat-card.students::before {
            background-color: var(--primary-color);
        }

        .stat-card.teachers::before {
            background-color: var(--secondary-color);
        }

        .stat-card.fees::before {
            background-color: var(--warning-color);
        }

        .stat-card.attendance::before {
            background-color: var(--danger-color);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-title {
            font-size: 0.9rem;
            color: #777;
            font-weight: 500;
        }

        .stat-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-card.students .stat-card-icon {
            background-color: var(--primary-color);
        }

        .stat-card.teachers .stat-card-icon {
            background-color: var(--secondary-color);
        }

        .stat-card.fees .stat-card-icon {
            background-color: var(--warning-color);
        }

        .stat-card.attendance .stat-card-icon {
            background-color: var(--danger-color);
        }

        .stat-card-value {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-card-change {
            font-size: 0.8rem;
            color: #777;
        }

        .stat-card-change.positive {
            color: var(--secondary-color);
        }

        .stat-card-change.negative {
            color: var(--danger-color);
        }

        .dashboard-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dashboard-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .dashboard-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .dashboard-card-actions {
            display: flex;
            gap: 10px;
        }

        .recent-activities {
            list-style: none;
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(52, 152, 219, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .activity-content {
            flex-grow: 1;
        }

        .activity-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .activity-time {
            font-size: 0.8rem;
            color: #777;
        }

        .upcoming-events {
            list-style: none;
        }

        .event-item {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-date {
            width: 50px;
            height: 50px;
            background-color: rgba(46, 204, 113, 0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--secondary-color);
        }

        .event-day {
            font-size: 1.2rem;
            font-weight: 600;
            line-height: 1;
        }

        .event-month {
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .event-content {
            flex-grow: 1;
        }

        .event-title {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .event-time {
            font-size: 0.8rem;
            color: #777;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Form Styles */
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            background-color: white;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #d68910;
        }

        .btn-outline-primary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 15px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            width: 200px;
        }

        .search-box i {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
        }

        .status-inactive {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .status-pending {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }

        .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .pagination {
            display: flex;
            justify-content: flex-end;
            margin-top: 15px;
            gap: 5px;
        }

        .page-item {
            list-style: none;
        }

        .page-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 4px;
            background-color: white;
            border: 1px solid #ddd;
            color: #555;
            text-decoration: none;
            transition: all 0.3s;
        }

        .page-link:hover {
            background-color: #f8f9fa;
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-item.disabled .page-link {
            color: #ddd;
            pointer-events: none;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-dialog {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-50px);
            transition: transform 0.3s;
        }

        .modal.show .modal-dialog {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Tabs Styles */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            color: #777;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Card Styles */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .card-body {
            padding: 20px;
        }

        /* Alert Styles */
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
            border-left: 4px solid var(--secondary-color);
        }

        .alert-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }

        .alert-warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
            border-left: 4px solid var(--warning-color);
        }

        .alert-info {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        .badge-success {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
        }

        .badge-danger {
            background-color: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background-color: rgba(241, 196, 15, 0.1);
            color: var(--warning-color);
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .dashboard-row {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Utility Classes */
        .mb-0 {
            margin-bottom: 0 !important;
        }

        .mt-0 {
            margin-top: 0 !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-muted {
            color: #777 !important;
        }

        .d-flex {
            display: flex;
        }

        .align-items-center {
            align-items: center;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .w-100 {
            width: 100%;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* Print Styles */
        @media print {

            header,
            .sidebar,
            .page-header {
                display: none !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Custom CSS for specific components */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-info h3 {
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .profile-info p {
            color: #777;
            margin-bottom: 10px;
        }

        .profile-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .profile-tabs {
            margin-bottom: 20px;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .attendance-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .attendance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .attendance-card.present {
            border-top: 3px solid var(--secondary-color);
        }

        .attendance-card.absent {
            border-top: 3px solid var(--danger-color);
        }

        .attendance-card.late {
            border-top: 3px solid var(--warning-color);
        }

        .attendance-card.leave {
            border-top: 3px solid var(--primary-color);
        }

        .attendance-card h4 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .attendance-card p {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0;
        }

        .fee-structure {
            margin-bottom: 30px;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .fee-item:last-child {
            border-bottom: none;
        }

        .fee-item.total {
            font-weight: 600;
            color: var(--dark-color);
        }

        .qr-code {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #777;
            font-size: 0.8rem;
            border: 1px dashed #ddd;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .sidebar-menu li.has-submenu.open > .submenu {
    max-height: 500px; /* A value large enough for any submenu */
}
    </style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"/>
<link href="manifest.json" rel="manifest"/><link href="favicon.ico" rel="icon" type="image/x-icon"/></head>
<body>
<header>
<div class="logo">
<img alt="Logo" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZmZmIiBkPSJNNDk0LjEgMjI1LjZjLTcuMS04LTE2LjktMTIuNy0yNy4xLTEyLjdoLTQwLjVjLTguNSAwLTE2LjYtMy40LTIyLjYtOS40bC0zMC4xLTMwLjFjLTIuMy0yLjMtNS4zLTMuNS04LjUtMy41cy02LjIgMS4yLTguNSAzLjVsLTU5LjUgNTkuNWMtMTIuNSAxMi41LTEyLjUgMzIuOCAwIDQ1LjNsMjYuNCAyNi40YzEyLjUgMTIuNSAzMi44IDEyLjUgNDUuMyAwbDEyMC41LTEyMC41YzIuMy0yLjMgMy41LTUuMyAzLjUtOC41cy0xLjItNi4yLTMuNS04LjVsLTMwLjEtMzAuMWMtMi4zLTIuMy01LjMtMy41LTguNS0zLjVzLTYuMiAxLjItOC41IDMuNWwtNjEuMSA2MS4xYy0yLjMgMi4zLTMuNSA1LjMtMy41IDguNXMxLjIgNi4yIDMuNSA4LjVsMzAuMSAzMC4xYzYuMSA2LjEgMTQuMSA5LjQgMjIuNiA5LjRoNDAuNWMxMC4yIDAgMjAgNC43IDI3LjEgMTIuN2w2MS4xIDY4LjljNS40IDYgOC4xIDEzLjcgOC4xIDIxLjR2MzQuN2MwIDguNS0zLjQgMTYuNi05LjQgMjIuNmwtNTUuNSA1NS41Yy02IDYtMTQuMSA5LjQtMjIuNiA5LjRIMTQxLjNjLTguNSAwLTE2LjYtMy40LTIyLjYtOS40TDYzLjIgNDQ4LjNjLTYuMS02LTkuNC0xNC4xLTkuNC0yMi42VjE0MS4zYzAtOC41IDMuNC0xNi42IDkuNC0yMi42bDU1LjUtNTUuNWM2LTYgMTQuMS05LjQgMjIuNi05LjQzNCIvPjwvc3ZnPg=="/>
<h1>School &amp; Madrasa Management</h1>
</div>
<div class="header-actions">
<div class="user-profile">
<div class="user-avatar">A</div>
<span>Admin</span>
</div>
<button class="mobile-menu-btn">
<i class="fas fa-bars"></i>
</button>
</div>
</header>
<aside class="sidebar">
<ul class="sidebar-menu">
<li class="active">
<a href="#dashboard">
<i class="fas fa-tachometer-alt"></i>
<span>Dashboard</span>
</a>
</li>
<li class="has-submenu">
<a href="#">
<i class="fas fa-users"></i>
<span>People Management</span>
</a>
<ul class="submenu">
<li><a href="#students"><i class="fas fa-user-graduate"></i> Students</a></li>
<li><a href="#teachers"><i class="fas fa-chalkboard-teacher"></i> Teachers</a></li>
<li><a href="#staff"><i class="fas fa-user-tie"></i> Staff</a></li>
</ul>
</li>
<li class="has-submenu">
<a href="#">
<i class="fas fa-book-open"></i>
<span>Academic Management</span>
</a>
<ul class="submenu">
<li><a href="#classes"><i class="fas fa-school"></i> Classes &amp; Subjects</a></li>
<li><a href="#attendance"><i class="fas fa-clipboard-check"></i> Attendance</a></li>
<li><a href="#examinations"><i class="fas fa-file-alt"></i> Examinations</a></li>
</ul>
</li>
<li class="has-submenu">
<a href="#">
<i class="fas fa-money-bill-wave"></i>
<span>Financial Management</span>
</a>
<ul class="submenu">
<li><a href="#fees"><i class="fas fa-hand-holding-usd"></i> Fee Management</a></li>
<li><a href="#salaries"><i class="fas fa-money-check-alt"></i> Salary Management</a></li>
<li><a href="#expenses"><i class="fas fa-receipt"></i> Expenses &amp; Income</a></li>
</ul>
</li>
<li>
<a href="#library">
<i class="fas fa-book"></i>
<span>Library</span>
</a>
</li>
<li>
<a href="#madrasa">
<i class="fas fa-mosque"></i>
<span>Madrasa Module</span>
</a>
</li>
<li class="has-submenu">
<a href="#">
<i class="fas fa-chart-bar"></i>
<span>Reports</span>
</a>
<ul class="submenu">
<li><a href="#reports-students"><i class="fas fa-user-graduate"></i> Student Reports</a></li>
<li><a href="#reports-attendance"><i class="fas fa-clipboard-list"></i> Attendance Reports</a></li>
<li><a href="#reports-financial"><i class="fas fa-file-invoice-dollar"></i> Financial Reports</a>
</li>
</ul>
</li>
<li>
<a href="#utilities">
<i class="fas fa-id-card"></i>
<span>ID Cards &amp; Certificates</span>
</a>
</li>
<li>
<a href="#settings">
<i class="fas fa-cog"></i>
<span>Settings</span>
</a>
</li>
</ul>
</aside>
<main class="main-content">
<!-- Dashboard Section -->
<section class="content-section active" id="dashboard-section">
<div class="page-header">
<h2>Dashboard</h2>
<ul class="breadcrumb">
<li>Home</li>
<li>Dashboard</li>
</ul>
</div>
<div class="stats-cards">
<div class="stat-card students">
<div class="stat-card-header">
<span class="stat-card-title">Total Students</span>
<div class="stat-card-icon">
<i class="fas fa-user-graduate"></i>
</div>
</div>
<div class="stat-card-value" id="total-students">0</div>
<div class="stat-card-change positive">
<i class="fas fa-arrow-up"></i> 5.2% from last month
                    </div>
</div>
<div class="stat-card teachers">
<div class="stat-card-header">
<span class="stat-card-title">Total Teachers</span>
<div class="stat-card-icon">
<i class="fas fa-chalkboard-teacher"></i>
</div>
</div>
<div class="stat-card-value" id="total-teachers">0</div>
<div class="stat-card-change positive">
<i class="fas fa-arrow-up"></i> 2.1% from last month
                    </div>
</div>
<div class="stat-card fees">
<div class="stat-card-header">
<span class="stat-card-title">Fee Collection</span>
<div class="stat-card-icon">
<i class="fas fa-hand-holding-usd"></i>
</div>
</div>
<div class="stat-card-value" id="fee-collection">0</div>
<div class="stat-card-change negative">
<i class="fas fa-arrow-down"></i> 3.5% from last month
                    </div>
</div>
<div class="stat-card attendance">
<div class="stat-card-header">
<span class="stat-card-title">Today's Attendance</span>
<div class="stat-card-icon">
<i class="fas fa-clipboard-check"></i>
</div>
</div>
<div class="stat-card-value" id="today-attendance">0%</div>
<div class="stat-card-change positive">
<i class="fas fa-arrow-up"></i> 1.8% from yesterday
                    </div>
</div>
</div>
<div class="dashboard-row">
<div class="dashboard-card">
<div class="dashboard-card-header">
<h3 class="dashboard-card-title">Recent Activities</h3>
<div class="dashboard-card-actions">
<button class="btn btn-sm btn-outline-primary">View All</button>
</div>
</div>
<ul class="recent-activities" id="recent-activities">
<!-- Activities will be loaded here -->
</ul>
</div>
<div class="dashboard-card">
<div class="dashboard-card-header">
<h3 class="dashboard-card-title">Upcoming Events</h3>
<div class="dashboard-card-actions">
<button class="btn btn-sm btn-outline-primary">View All</button>
</div>
</div>
<ul class="upcoming-events" id="upcoming-events">
<!-- Events will be loaded here -->
</ul>
</div>
</div>
<div class="dashboard-card">
<div class="dashboard-card-header">
<h3 class="dashboard-card-title">Quick Actions</h3>
</div>
<div class="dashboard-card-body">
<div class="quick-actions">
<button class="btn btn-primary">
<i class="fas fa-user-plus"></i> Add New Student
                        </button>
<button class="btn btn-success">
<i class="fas fa-clipboard-check"></i> Mark Attendance
                        </button>
<button class="btn btn-warning">
<i class="fas fa-hand-holding-usd"></i> Collect Fee
                        </button>
<button class="btn btn-danger">
<i class="fas fa-book"></i> Issue Book
                        </button>
</div>
</div>
</div>
</section>
<!-- Students Management Section -->
<section class="content-section" id="students-section">
<div class="page-header">
<h2>Student Management</h2>
<ul class="breadcrumb">
<li>People Management</li>
<li>Students</li>
</ul>
</div>
<div class="table-actions">
<div class="search-box">
<i class="fas fa-search"></i>
<input id="student-search" placeholder="Search students..." type="text"/>
</div>
<button class="btn btn-primary" id="add-student-btn">
<i class="fas fa-plus"></i> Add Student
                </button>
</div>
<div class="table-container">
<table id="students-table">
<thead>
<tr>
<th>ID</th>
<th>Photo</th>
<th>Name</th>
<th>Class</th>
<th>Section</th>
<th>Father Name</th>
<th>Contact</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="students-table-body">
<!-- Students will be loaded here -->
</tbody>
</table>
<div class="pagination">
<ul>
<li class="page-item"><a class="page-link" href="#">Previous</a></li>
<li class="page-item active"><a class="page-link" href="#">1</a></li>
<li class="page-item"><a class="page-link" href="#">2</a></li>
<li class="page-item"><a class="page-link" href="#">3</a></li>
<li class="page-item"><a class="page-link" href="#">Next</a></li>
</ul>
</div>
</div>
</section>
<!-- Add/Edit Student Modal -->
<div class="modal" id="student-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Student</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="student-form">
<div class="form-row">
<div class="form-group">
<label for="student-first-name">First Name</label>
<input class="form-control" id="student-first-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="student-last-name">Last Name</label>
<input class="form-control" id="student-last-name" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="student-gender">Gender</label>
<select class="form-select" id="student-gender" required="">
<option value="">Select Gender</option>
<option value="Male">Male</option>
<option value="Female">Female</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label for="student-dob">Date of Birth</label>
<input class="form-control" id="student-dob" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="student-class">Class</label>
<select class="form-select" id="student-class" required="">
<option value="">Select Class</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="student-section">Section</label>
<select class="form-select" id="student-section" required="">
<option value="">Select Section</option>
<!-- Sections will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="student-admission-date">Admission Date</label>
<input class="form-control" id="student-admission-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="student-admission-number">Admission Number</label>
<input class="form-control" id="student-admission-number" required="" type="text"/>
</div>
</div>
<div class="form-group">
<label for="student-address">Address</label>
<textarea class="form-control form-textarea" id="student-address"></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label for="student-father-name">Father's Name</label>
<input class="form-control" id="student-father-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="student-father-phone">Father's Phone</label>
<input class="form-control" id="student-father-phone" required="" type="tel"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="student-mother-name">Mother's Name</label>
<input class="form-control" id="student-mother-name" type="text"/>
</div>
<div class="form-group">
<label for="student-mother-phone">Mother's Phone</label>
<input class="form-control" id="student-mother-phone" type="tel"/>
</div>
</div>
<div class="form-group">
<label for="student-photo">Photo</label>
<input accept="image/*" class="form-control" id="student-photo" type="file"/>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Student</button>
</div>
</form>
</div>
</div>
</div>
<!-- Teachers Management Section -->
<section class="content-section" id="teachers-section">
<div class="page-header">
<h2>Teacher Management</h2>
<ul class="breadcrumb">
<li>People Management</li>
<li>Teachers</li>
</ul>
</div>
<div class="table-actions">
<div class="search-box">
<i class="fas fa-search"></i>
<input id="teacher-search" placeholder="Search teachers..." type="text"/>
</div>
<button class="btn btn-primary" id="add-teacher-btn">
<i class="fas fa-plus"></i> Add Teacher
                </button>
</div>
<div class="table-container">
<table id="teachers-table">
<thead>
<tr>
<th>ID</th>
<th>Photo</th>
<th>Name</th>
<th>Subjects</th>
<th>Qualification</th>
<th>Contact</th>
<th>Joining Date</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="teachers-table-body">
<!-- Teachers will be loaded here -->
</tbody>
</table>
<div class="pagination">
<ul>
<li class="page-item"><a class="page-link" href="#">Previous</a></li>
<li class="page-item active"><a class="page-link" href="#">1</a></li>
<li class="page-item"><a class="page-link" href="#">2</a></li>
<li class="page-item"><a class="page-link" href="#">3</a></li>
<li class="page-item"><a class="page-link" href="#">Next</a></li>
</ul>
</div>
</div>
</section>
<!-- Add/Edit Teacher Modal -->
<div class="modal" id="teacher-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Teacher</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="teacher-form">
<div class="form-row">
<div class="form-group">
<label for="teacher-first-name">First Name</label>
<input class="form-control" id="teacher-first-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="teacher-last-name">Last Name</label>
<input class="form-control" id="teacher-last-name" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="teacher-gender">Gender</label>
<select class="form-select" id="teacher-gender" required="">
<option value="">Select Gender</option>
<option value="Male">Male</option>
<option value="Female">Female</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label for="teacher-dob">Date of Birth</label>
<input class="form-control" id="teacher-dob" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="teacher-email">Email</label>
<input class="form-control" id="teacher-email" required="" type="email"/>
</div>
<div class="form-group">
<label for="teacher-phone">Phone</label>
<input class="form-control" id="teacher-phone" required="" type="tel"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="teacher-qualification">Qualification</label>
<input class="form-control" id="teacher-qualification" required="" type="text"/>
</div>
<div class="form-group">
<label for="teacher-subjects">Subjects</label>
<select class="form-select" id="teacher-subjects" multiple="">
<!-- Subjects will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="teacher-joining-date">Joining Date</label>
<input class="form-control" id="teacher-joining-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="teacher-salary">Salary</label>
<input class="form-control" id="teacher-salary" required="" type="number"/>
</div>
</div>
<div class="form-group">
<label for="teacher-address">Address</label>
<textarea class="form-control form-textarea" id="teacher-address"></textarea>
</div>
<div class="form-group">
<label for="teacher-photo">Photo</label>
<input accept="image/*" class="form-control" id="teacher-photo" type="file"/>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Teacher</button>
</div>
</form>
</div>
</div>
</div>
<!-- Staff Management Section -->
<section class="content-section" id="staff-section">
<div class="page-header">
<h2>Staff Management</h2>
<ul class="breadcrumb">
<li>People Management</li>
<li>Staff</li>
</ul>
</div>
<div class="table-actions">
<div class="search-box">
<i class="fas fa-search"></i>
<input id="staff-search" placeholder="Search staff..." type="text"/>
</div>
<button class="btn btn-primary" id="add-staff-btn">
<i class="fas fa-plus"></i> Add Staff
                </button>
</div>
<div class="table-container">
<table id="staff-table">
<thead>
<tr>
<th>ID</th>
<th>Photo</th>
<th>Name</th>
<th>Role</th>
<th>Contact</th>
<th>Joining Date</th>
<th>Salary</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="staff-table-body">
<!-- Staff will be loaded here -->
</tbody>
</table>
<div class="pagination">
<ul>
<li class="page-item"><a class="page-link" href="#">Previous</a></li>
<li class="page-item active"><a class="page-link" href="#">1</a></li>
<li class="page-item"><a class="page-link" href="#">2</a></li>
<li class="page-item"><a class="page-link" href="#">3</a></li>
<li class="page-item"><a class="page-link" href="#">Next</a></li>
</ul>
</div>
</div>
</section>
<!-- Add/Edit Staff Modal -->
<div class="modal" id="staff-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Staff</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="staff-form">
<div class="form-row">
<div class="form-group">
<label for="staff-first-name">First Name</label>
<input class="form-control" id="staff-first-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="staff-last-name">Last Name</label>
<input class="form-control" id="staff-last-name" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="staff-gender">Gender</label>
<select class="form-select" id="staff-gender" required="">
<option value="">Select Gender</option>
<option value="Male">Male</option>
<option value="Female">Female</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label for="staff-dob">Date of Birth</label>
<input class="form-control" id="staff-dob" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="staff-email">Email</label>
<input class="form-control" id="staff-email" type="email"/>
</div>
<div class="form-group">
<label for="staff-phone">Phone</label>
<input class="form-control" id="staff-phone" required="" type="tel"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="staff-role">Role</label>
<select class="form-select" id="staff-role" required="">
<option value="">Select Role</option>
<option value="Accountant">Accountant</option>
<option value="Librarian">Librarian</option>
<option value="Receptionist">Receptionist</option>
<option value="Cleaner">Cleaner</option>
<option value="Security">Security</option>
<option value="Other">Other</option>
</select>
</div>
<div class="form-group">
<label for="staff-joining-date">Joining Date</label>
<input class="form-control" id="staff-joining-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="staff-salary">Salary</label>
<input class="form-control" id="staff-salary" required="" type="number"/>
</div>
<div class="form-group">
<label for="staff-status">Status</label>
<select class="form-select" id="staff-status" required="">
<option value="Active">Active</option>
<option value="Inactive">Inactive</option>
</select>
</div>
</div>
<div class="form-group">
<label for="staff-address">Address</label>
<textarea class="form-control form-textarea" id="staff-address"></textarea>
</div>
<div class="form-group">
<label for="staff-photo">Photo</label>
<input accept="image/*" class="form-control" id="staff-photo" type="file"/>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Staff</button>
</div>
</form>
</div>
</div>
</div>
<!-- Classes & Subjects Section -->
<section class="content-section" id="classes-section">
<div class="page-header">
<h2>Classes &amp; Subjects</h2>
<ul class="breadcrumb">
<li>Academic Management</li>
<li>Classes &amp; Subjects</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="classes">Classes</div>
<div class="tab" data-tab="subjects">Subjects</div>
<div class="tab" data-tab="assign-subjects">Assign Subjects</div>
</div>
<div class="tab-content active" id="classes-tab">
<div class="table-actions">
<button class="btn btn-primary" id="add-class-btn">
<i class="fas fa-plus"></i> Add Class
                    </button>
</div>
<div class="table-container">
<table id="classes-table">
<thead>
<tr>
<th>ID</th>
<th>Class Name</th>
<th>Sections</th>
<th>Class Teacher</th>
<th>Students</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="classes-table-body">
<!-- Classes will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="subjects-tab">
<div class="table-actions">
<button class="btn btn-primary" id="add-subject-btn">
<i class="fas fa-plus"></i> Add Subject
                    </button>
</div>
<div class="table-container">
<table id="subjects-table">
<thead>
<tr>
<th>ID</th>
<th>Subject Name</th>
<th>Subject Code</th>
<th>Type</th>
<th>Teachers</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="subjects-table-body">
<!-- Subjects will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="assign-subjects-tab">
<div class="form-container">
<form id="assign-subjects-form">
<div class="form-row">
<div class="form-group">
<label for="assign-class">Class</label>
<select class="form-select" id="assign-class" required="">
<option value="">Select Class</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="assign-section">Section</label>
<select class="form-select" id="assign-section" required="">
<option value="">Select Section</option>
<!-- Sections will be loaded here -->
</select>
</div>
</div>
<div class="form-group">
<label>Subjects</label>
<div id="subject-assignments">
<!-- Subject assignments will be loaded here -->
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Save Assignments</button>
</div>
</form>
</div>
</div>
</section>
<!-- Add/Edit Class Modal -->
<div class="modal" id="class-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Class</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="class-form">
<div class="form-row">
<div class="form-group">
<label for="class-name">Class Name</label>
<input class="form-control" id="class-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="class-numeric-value">Numeric Value</label>
<input class="form-control" id="class-numeric-value" required="" type="number"/>
</div>
</div>
<div class="form-group">
<label for="class-sections">Sections (comma separated)</label>
<input class="form-control" id="class-sections" placeholder="A,B,C,D" type="text"/>
</div>
<div class="form-group">
<label for="class-teacher">Class Teacher</label>
<select class="form-select" id="class-teacher">
<option value="">Select Teacher</option>
<!-- Teachers will be loaded here -->
</select>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Class</button>
</div>
</form>
</div>
</div>
</div>
<!-- Add/Edit Subject Modal -->
<div class="modal" id="subject-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Subject</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="subject-form">
<div class="form-row">
<div class="form-group">
<label for="subject-name">Subject Name</label>
<input class="form-control" id="subject-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="subject-code">Subject Code</label>
<input class="form-control" id="subject-code" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="subject-type">Subject Type</label>
<select class="form-select" id="subject-type" required="">
<option value="Core">Core</option>
<option value="Elective">Elective</option>
<option value="Optional">Optional</option>
</select>
</div>
<div class="form-group">
<label for="subject-teacher">Subject Teacher</label>
<select class="form-select" id="subject-teacher">
<option value="">Select Teacher</option>
<!-- Teachers will be loaded here -->
</select>
</div>
</div>
<div class="form-group">
<label for="subject-description">Description</label>
<textarea class="form-control form-textarea" id="subject-description"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Subject</button>
</div>
</form>
</div>
</div>
</div>
<!-- Attendance Management Section -->
<section class="content-section" id="attendance-section">
<div class="page-header">
<h2>Attendance Management</h2>
<ul class="breadcrumb">
<li>Academic Management</li>
<li>Attendance</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="mark-attendance">Mark Attendance</div>
<div class="tab" data-tab="attendance-reports">Reports</div>
</div>
<div class="tab-content active" id="mark-attendance-tab">
<div class="form-container">
<form id="attendance-filter-form">
<div class="form-row">
<div class="form-group">
<label for="attendance-date">Date</label>
<input class="form-control" id="attendance-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="attendance-class">Class</label>
<select class="form-select" id="attendance-class" required="">
<option value="">Select Class</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="attendance-section">Section</label>
<select class="form-select" id="attendance-section-select" required="">
<option value="">Select Section</option>
<!-- Sections will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Load Students</button>
</div>
</form>
</div>
<div class="table-container" id="attendance-table-container" style="display: none;">
<table id="attendance-table">
<thead>
<tr>
<th>Student ID</th>
<th>Student Name</th>
<th>Status</th>
<th>Remarks</th>
</tr>
</thead>
<tbody id="attendance-table-body">
<!-- Attendance records will be loaded here -->
</tbody>
</table>
<div class="form-actions">
<button class="btn btn-success" id="save-attendance-btn" type="button">Save Attendance</button>
</div>
</div>
</div>
<div class="tab-content" id="attendance-reports-tab">
<div class="form-container">
<form id="attendance-report-form">
<div class="form-row">
<div class="form-group">
<label for="report-class">Class</label>
<select class="form-select" id="report-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="report-section">Section</label>
<select class="form-select" id="report-section">
<option value="">All Sections</option>
<!-- Sections will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="report-student">Student</label>
<select class="form-select" id="report-student">
<option value="">All Students</option>
<!-- Students will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="report-month">Month</label>
<select class="form-select" id="report-month">
<option value="">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label for="report-year">Year</label>
<select class="form-select" id="report-year">
<!-- Years will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="report-type">Report Type</label>
<select class="form-select" id="report-type">
<option value="summary">Summary Report</option>
<option value="detailed">Detailed Report</option>
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-report-btn" type="button">Print Report</button>
</div>
</form>
</div>
<div class="table-container" id="attendance-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Attendance Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-attendance-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="attendance-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
</section>
<!-- Examinations Management Section -->
<section class="content-section" id="examinations-section">
<div class="page-header">
<h2>Examinations Management</h2>
<ul class="breadcrumb">
<li>Academic Management</li>
<li>Examinations</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="exam-schedule">Exam Schedule</div>
<div class="tab" data-tab="marks-entry">Marks Entry</div>
<div class="tab" data-tab="report-cards">Report Cards</div>
</div>
<div class="tab-content active" id="exam-schedule-tab">
<div class="table-actions">
<button class="btn btn-primary" id="add-exam-btn">
<i class="fas fa-plus"></i> Add Exam
                    </button>
</div>
<div class="table-container">
<table id="exams-table">
<thead>
<tr>
<th>Exam ID</th>
<th>Exam Name</th>
<th>Exam Type</th>
<th>Start Date</th>
<th>End Date</th>
<th>Classes</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="exams-table-body">
<!-- Exams will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="marks-entry-tab">
<div class="form-container">
<form id="marks-filter-form">
<div class="form-row">
<div class="form-group">
<label for="marks-exam">Exam</label>
<select class="form-select" id="marks-exam" required="">
<option value="">Select Exam</option>
<!-- Exams will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="marks-class">Class</label>
<select class="form-select" id="marks-class" required="">
<option value="">Select Class</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="marks-section">Section</label>
<select class="form-select" id="marks-section" required="">
<option value="">Select Section</option>
<!-- Sections will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="marks-subject">Subject</label>
<select class="form-select" id="marks-subject" required="">
<option value="">Select Subject</option>
<!-- Subjects will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Load Students</button>
</div>
</form>
</div>
<div class="table-container" id="marks-table-container" style="display: none;">
<table id="marks-table">
<thead>
<tr>
<th>Student ID</th>
<th>Student Name</th>
<th>Marks</th>
<th>Grade</th>
<th>Remarks</th>
</tr>
</thead>
<tbody id="marks-table-body">
<!-- Marks records will be loaded here -->
</tbody>
</table>
<div class="form-actions">
<button class="btn btn-success" id="save-marks-btn" type="button">Save Marks</button>
</div>
</div>
</div>
<div class="tab-content" id="report-cards-tab">
<div class="form-container">
<form id="report-card-filter-form">
<div class="form-row">
<div class="form-group">
<label for="rc-exam">Exam</label>
<select class="form-select" id="rc-exam" required="">
<option value="">Select Exam</option>
<!-- Exams will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="rc-class">Class</label>
<select class="form-select" id="rc-class" required="">
<option value="">Select Class</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="rc-section">Section</label>
<select class="form-select" id="rc-section" required="">
<option value="">Select Section</option>
<!-- Sections will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="rc-student">Student</label>
<select class="form-select" id="rc-student">
<option value="">All Students</option>
<!-- Students will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report Cards</button>
<button class="btn btn-secondary" id="print-report-cards-btn" type="button">Print Report
                                Cards</button>
</div>
</form>
</div>
<div id="report-cards-container" style="display: none;">
<!-- Report cards will be loaded here -->
</div>
</div>
</section>
<!-- Add/Edit Exam Modal -->
<div class="modal" id="exam-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Exam</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="exam-form">
<div class="form-row">
<div class="form-group">
<label for="exam-name">Exam Name</label>
<input class="form-control" id="exam-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="exam-type">Exam Type</label>
<select class="form-select" id="exam-type" required="">
<option value="Monthly">Monthly</option>
<option value="Term">Term</option>
<option value="Final">Final</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="exam-start-date">Start Date</label>
<input class="form-control" id="exam-start-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="exam-end-date">End Date</label>
<input class="form-control" id="exam-end-date" required="" type="date"/>
</div>
</div>
<div class="form-group">
<label for="exam-classes">Classes</label>
<select class="form-select" id="exam-classes" multiple="">
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="exam-description">Description</label>
<textarea class="form-control form-textarea" id="exam-description"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Exam</button>
</div>
</form>
</div>
</div>
</div>
<!-- Fee Management Section -->
<section class="content-section" id="fees-section">
<div class="page-header">
<h2>Fee Management</h2>
<ul class="breadcrumb">
<li>Financial Management</li>
<li>Fee Management</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="fee-structure">Fee Structure</div>
<div class="tab" data-tab="collect-fee">Collect Fee</div>
<div class="tab" data-tab="fee-reports">Reports</div>
<div class="tab" data-tab="fee-defaulters">Defaulters</div>
</div>
<div class="tab-content active" id="fee-structure-tab">
<div class="table-actions">
<button class="btn btn-primary" id="add-fee-type-btn">
<i class="fas fa-plus"></i> Add Fee Type
                    </button>
<button class="btn btn-success" id="assign-fee-btn">
<i class="fas fa-tasks"></i> Assign Fee to Classes
                    </button>
</div>
<div class="table-container">
<table id="fee-types-table">
<thead>
<tr>
<th>Fee ID</th>
<th>Fee Name</th>
<th>Amount</th>
<th>Frequency</th>
<th>Description</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="fee-types-table-body">
<!-- Fee types will be loaded here -->
</tbody>
</table>
</div>
<div class="table-container mt-20">
<h3>Class-wise Fee Structure</h3>
<table id="class-fee-structure-table">
<thead>
<tr>
<th>Class</th>
<th>Fee Name</th>
<th>Amount</th>
<th>Due Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="class-fee-structure-table-body">
<!-- Class fee structure will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="collect-fee-tab">
<div class="form-container">
<form id="fee-collection-form">
<div class="form-row">
<div class="form-group">
<label for="fee-student">Student</label>
<select class="form-select" id="fee-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="fee-class">Class</label>
<select class="form-select" id="fee-class" required="">
<option value="">Select Class</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="fee-section">Section</label>
<select class="form-select" id="fee-section" required="">
<option value="">Select Section</option>
<!-- Sections will be loaded here -->
</select>
</div>
</div>
<div class="form-group">
<label>Fee Details</label>
<div id="fee-details-container">
<!-- Fee details will be loaded here -->
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="fee-total-amount">Total Amount</label>
<input class="form-control" id="fee-total-amount" readonly="" type="number"/>
</div>
<div class="form-group">
<label for="fee-discount">Discount</label>
<input class="form-control" id="fee-discount" min="0" type="number" value="0"/>
</div>
<div class="form-group">
<label for="fee-fine">Fine</label>
<input class="form-control" id="fee-fine" min="0" type="number" value="0"/>
</div>
<div class="form-group">
<label for="fee-paid-amount">Paid Amount</label>
<input class="form-control" id="fee-paid-amount" required="" type="number"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="fee-payment-method">Payment Method</label>
<select class="form-select" id="fee-payment-method" required="">
<option value="Cash">Cash</option>
<option value="Cheque">Cheque</option>
<option value="Bank Transfer">Bank Transfer</option>
<option value="Online Payment">Online Payment</option>
</select>
</div>
<div class="form-group">
<label for="fee-payment-date">Payment Date</label>
<input class="form-control" id="fee-payment-date" required="" type="date"/>
</div>
</div>
<div class="form-group">
<label for="fee-remarks">Remarks</label>
<textarea class="form-control form-textarea" id="fee-remarks"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Collect Fee</button>
<button class="btn btn-secondary" id="print-receipt-btn" type="button">Print
                                Receipt</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="fee-reports-tab">
<div class="form-container">
<form id="fee-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="fr-class">Class</label>
<select class="form-select" id="fr-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="fr-section">Section</label>
<select class="form-select" id="fr-section">
<option value="">All Sections</option>
<!-- Sections will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="fr-fee-type">Fee Type</label>
<select class="form-select" id="fr-fee-type">
<option value="">All Fee Types</option>
<!-- Fee types will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="fr-month">Month</label>
<select class="form-select" id="fr-month">
<option value="">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label for="fr-year">Year</label>
<select class="form-select" id="fr-year">
<!-- Years will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="fr-report-type">Report Type</label>
<select class="form-select" id="fr-report-type">
<option value="summary">Summary Report</option>
<option value="detailed">Detailed Report</option>
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-fee-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="fee-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Fee Collection Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-fee-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="fee-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
<div class="tab-content" id="fee-defaulters-tab">
<div class="form-container">
<form id="defaulters-filter-form">
<div class="form-row">
<div class="form-group">
<label for="df-class">Class</label>
<select class="form-select" id="df-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="df-section">Section</label>
<select class="form-select" id="df-section">
<option value="">All Sections</option>
<!-- Sections will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="df-fee-type">Fee Type</label>
<select class="form-select" id="df-fee-type">
<option value="">All Fee Types</option>
<!-- Fee types will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="df-month">Month</label>
<select class="form-select" id="df-month">
<option value="">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Find Defaulters</button>
<button class="btn btn-success" id="send-reminders-btn" type="button">Send
                                Reminders</button>
</div>
</form>
</div>
<div class="table-container" id="defaulters-container" style="display: none;">
<table id="defaulters-table">
<thead>
<tr>
<th>Student ID</th>
<th>Student Name</th>
<th>Class</th>
<th>Section</th>
<th>Fee Type</th>
<th>Due Amount</th>
<th>Due Since</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="defaulters-table-body">
<!-- Defaulters will be loaded here -->
</tbody>
</table>
</div>
</div>
</section>
<!-- Add/Edit Fee Type Modal -->
<div class="modal" id="fee-type-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Fee Type</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="fee-type-form">
<div class="form-row">
<div class="form-group">
<label for="fee-type-name">Fee Name</label>
<input class="form-control" id="fee-type-name" required="" type="text"/>
</div>
<div class="form-group">
<label for="fee-type-code">Fee Code</label>
<input class="form-control" id="fee-type-code" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="fee-type-amount">Amount</label>
<input class="form-control" id="fee-type-amount" required="" type="number"/>
</div>
<div class="form-group">
<label for="fee-type-frequency">Frequency</label>
<select class="form-select" id="fee-type-frequency" required="">
<option value="One Time">One Time</option>
<option value="Monthly">Monthly</option>
<option value="Quarterly">Quarterly</option>
<option value="Half Yearly">Half Yearly</option>
<option value="Yearly">Yearly</option>
</select>
</div>
</div>
<div class="form-group">
<label for="fee-type-description">Description</label>
<textarea class="form-control form-textarea" id="fee-type-description"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Fee Type</button>
</div>
</form>
</div>
</div>
</div>
<!-- Assign Fee to Classes Modal -->
<div class="modal" id="assign-fee-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Assign Fee to Classes</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="assign-fee-form">
<div class="form-group">
<label for="assign-fee-type">Fee Type</label>
<select class="form-select" id="assign-fee-type" required="">
<option value="">Select Fee Type</option>
<!-- Fee types will be loaded here -->
</select>
</div>
<div class="form-group">
<label>Classes</label>
<div id="class-fee-assignments">
<!-- Class assignments will be loaded here -->
</div>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Assignments</button>
</div>
</form>
</div>
</div>
</div>
<!-- Salary Management Section -->
<section class="content-section" id="salaries-section">
<div class="page-header">
<h2>Salary Management</h2>
<ul class="breadcrumb">
<li>Financial Management</li>
<li>Salary Management</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="salary-structure">Salary Structure</div>
<div class="tab" data-tab="process-salary">Process Salary</div>
<div class="tab" data-tab="salary-reports">Reports</div>
</div>
<div class="tab-content active" id="salary-structure-tab">
<div class="table-container">
<table id="salary-structure-table">
<thead>
<tr>
<th>Employee ID</th>
<th>Employee Name</th>
<th>Designation</th>
<th>Basic Salary</th>
<th>Allowances</th>
<th>Deductions</th>
<th>Net Salary</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="salary-structure-table-body">
<!-- Salary structure will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="process-salary-tab">
<div class="form-container">
<form id="salary-process-form">
<div class="form-row">
<div class="form-group">
<label for="salary-month">Month</label>
<select class="form-select" id="salary-month" required="">
<option value="">Select Month</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label for="salary-year">Year</label>
<select class="form-select" id="salary-year" required="">
<!-- Years will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="salary-employee-type">Employee Type</label>
<select class="form-select" id="salary-employee-type">
<option value="">All Employees</option>
<option value="Teacher">Teachers</option>
<option value="Staff">Staff</option>
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Load Employees</button>
</div>
</form>
</div>
<div class="table-container" id="salary-process-container" style="display: none;">
<table id="salary-process-table">
<thead>
<tr>
<th>Employee ID</th>
<th>Employee Name</th>
<th>Designation</th>
<th>Basic Salary</th>
<th>Allowances</th>
<th>Deductions</th>
<th>Net Salary</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="salary-process-table-body">
<!-- Salary process records will be loaded here -->
</tbody>
</table>
<div class="form-actions">
<button class="btn btn-success" id="process-salary-btn" type="button">Process Salary</button>
<button class="btn btn-primary" id="print-payslips-btn" type="button">Print Payslips</button>
</div>
</div>
</div>
<div class="tab-content" id="salary-reports-tab">
<div class="form-container">
<form id="salary-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="sr-employee">Employee</label>
<select class="form-select" id="sr-employee">
<option value="">All Employees</option>
<!-- Employees will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sr-employee-type">Employee Type</label>
<select class="form-select" id="sr-employee-type">
<option value="">All Types</option>
<option value="Teacher">Teachers</option>
<option value="Staff">Staff</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="sr-month">Month</label>
<select class="form-select" id="sr-month">
<option value="">All Months</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label for="sr-year">Year</label>
<select class="form-select" id="sr-year">
<!-- Years will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sr-report-type">Report Type</label>
<select class="form-select" id="sr-report-type">
<option value="summary">Summary Report</option>
<option value="detailed">Detailed Report</option>
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-salary-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="salary-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Salary Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-salary-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="salary-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
</section>
<!-- Expenses & Income Section -->
<section class="content-section" id="expenses-section">
<div class="page-header">
<h2>Expenses &amp; Income</h2>
<ul class="breadcrumb">
<li>Financial Management</li>
<li>Expenses &amp; Income</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="expenses">Expenses</div>
<div class="tab" data-tab="income">Income</div>
<div class="tab" data-tab="financial-reports">Reports</div>
</div>
<div class="tab-content active" id="expenses-tab">
<div class="table-actions">
<button class="btn btn-primary" id="add-expense-btn">
<i class="fas fa-plus"></i> Add Expense
                    </button>
</div>
<div class="table-container">
<table id="expenses-table">
<thead>
<tr>
<th>Expense ID</th>
<th>Date</th>
<th>Category</th>
<th>Amount</th>
<th>Payment Method</th>
<th>Description</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="expenses-table-body">
<!-- Expenses will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="income-tab">
<div class="table-actions">
<button class="btn btn-primary" id="add-income-btn">
<i class="fas fa-plus"></i> Add Income
                    </button>
</div>
<div class="table-container">
<table id="income-table">
<thead>
<tr>
<th>Income ID</th>
<th>Date</th>
<th>Category</th>
<th>Amount</th>
<th>Payment Method</th>
<th>Description</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="income-table-body">
<!-- Income records will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="financial-reports-tab">
<div class="form-container">
<form id="financial-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="fr-type">Type</label>
<select class="form-select" id="fr-type">
<option value="all">All Transactions</option>
<option value="expense">Expenses Only</option>
<option value="income">Income Only</option>
</select>
</div>
<div class="form-group">
<label for="fr-category">Category</label>
<select class="form-select" id="fr-category">
<option value="">All Categories</option>
<!-- Categories will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="fr-start-date">Start Date</label>
<input class="form-control" id="fr-start-date" type="date"/>
</div>
<div class="form-group">
<label for="fr-end-date">End Date</label>
<input class="form-control" id="fr-end-date" type="date"/>
</div>
<div class="form-group">
<label for="fr-report-type">Report Type</label>
<select class="form-select" id="fr-report-type">
<option value="summary">Summary Report</option>
<option value="detailed">Detailed Report</option>
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-financial-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="financial-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Financial Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-financial-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="financial-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
</section>
<!-- Add/Edit Expense Modal -->
<div class="modal" id="expense-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Expense</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="expense-form">
<div class="form-row">
<div class="form-group">
<label for="expense-date">Date</label>
<input class="form-control" id="expense-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="expense-category">Category</label>
<select class="form-select" id="expense-category" required="">
<option value="">Select Category</option>
<option value="Salaries">Salaries</option>
<option value="Utilities">Utilities</option>
<option value="Maintenance">Maintenance</option>
<option value="Stationery">Stationery</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="expense-amount">Amount</label>
<input class="form-control" id="expense-amount" required="" type="number"/>
</div>
<div class="form-group">
<label for="expense-payment-method">Payment Method</label>
<select class="form-select" id="expense-payment-method" required="">
<option value="Cash">Cash</option>
<option value="Cheque">Cheque</option>
<option value="Bank Transfer">Bank Transfer</option>
<option value="Online Payment">Online Payment</option>
</select>
</div>
</div>
<div class="form-group">
<label for="expense-description">Description</label>
<textarea class="form-control form-textarea" id="expense-description"></textarea>
</div>
<div class="form-group">
<label for="expense-attachment">Attachment</label>
<input class="form-control" id="expense-attachment" type="file"/>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Expense</button>
</div>
</form>
</div>
</div>
</div>
<!-- Add/Edit Income Modal -->
<div class="modal" id="income-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Income</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="income-form">
<div class="form-row">
<div class="form-group">
<label for="income-date">Date</label>
<input class="form-control" id="income-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="income-category">Category</label>
<select class="form-select" id="income-category" required="">
<option value="">Select Category</option>
<option value="Fees">Fees</option>
<option value="Donation">Donation</option>
<option value="Grant">Grant</option>
<option value="Other">Other</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="income-amount">Amount</label>
<input class="form-control" id="income-amount" required="" type="number"/>
</div>
<div class="form-group">
<label for="income-payment-method">Payment Method</label>
<select class="form-select" id="income-payment-method" required="">
<option value="Cash">Cash</option>
<option value="Cheque">Cheque</option>
<option value="Bank Transfer">Bank Transfer</option>
<option value="Online Payment">Online Payment</option>
</select>
</div>
</div>
<div class="form-group">
<label for="income-description">Description</label>
<textarea class="form-control form-textarea" id="income-description"></textarea>
</div>
<div class="form-group">
<label for="income-attachment">Attachment</label>
<input class="form-control" id="income-attachment" type="file"/>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Income</button>
</div>
</form>
</div>
</div>
</div>
<!-- Library Management Section -->
<section class="content-section" id="library-section">
<div class="page-header">
<h2>Library Management</h2>
<ul class="breadcrumb">
<li>Library</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="books">Books</div>
<div class="tab" data-tab="book-issue">Book Issue</div>
<div class="tab" data-tab="book-return">Book Return</div>
<div class="tab" data-tab="library-reports">Reports</div>
</div>
<div class="tab-content active" id="books-tab">
<div class="table-actions">
<div class="search-box">
<i class="fas fa-search"></i>
<input id="book-search" placeholder="Search books..." type="text"/>
</div>
<button class="btn btn-primary" id="add-book-btn">
<i class="fas fa-plus"></i> Add Book
                    </button>
</div>
<div class="table-container">
<table id="books-table">
<thead>
<tr>
<th>Book ID</th>
<th>Title</th>
<th>Author</th>
<th>Subject</th>
<th>Publisher</th>
<th>Available</th>
<th>Total</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="books-table-body">
<!-- Books will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="book-issue-tab">
<div class="form-container">
<form id="book-issue-form">
<div class="form-row">
<div class="form-group">
<label for="issue-book">Book</label>
<select class="form-select" id="issue-book" required="">
<option value="">Select Book</option>
<!-- Books will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="issue-student">Student</label>
<select class="form-select" id="issue-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="issue-date">Issue Date</label>
<input class="form-control" id="issue-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="due-date">Due Date</label>
<input class="form-control" id="due-date" required="" type="date"/>
</div>
</div>
<div class="form-group">
<label for="issue-remarks">Remarks</label>
<textarea class="form-control form-textarea" id="issue-remarks"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Issue Book</button>
</div>
</form>
</div>
<div class="table-container">
<h3>Currently Issued Books</h3>
<table id="issued-books-table">
<thead>
<tr>
<th>Issue ID</th>
<th>Book Title</th>
<th>Student Name</th>
<th>Issue Date</th>
<th>Due Date</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="issued-books-table-body">
<!-- Issued books will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="book-return-tab">
<div class="form-container">
<form id="book-return-form">
<div class="form-row">
<div class="form-group">
<label for="return-issue-id">Issue ID</label>
<input class="form-control" id="return-issue-id" placeholder="Enter Issue ID or scan barcode" type="text"/>
</div>
<div class="form-group">
<label for="return-book">Book</label>
<select class="form-select" id="return-book">
<option value="">Select Book</option>
<!-- Issued books will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="return-student">Student</label>
<select class="form-select" id="return-student">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="return-date">Return Date</label>
<input class="form-control" id="return-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="fine-amount">Fine Amount</label>
<input class="form-control" id="fine-amount" min="0" type="number" value="0"/>
</div>
</div>
<div class="form-group">
<label for="return-remarks">Remarks</label>
<textarea class="form-control form-textarea" id="return-remarks"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Return Book</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="library-reports-tab">
<div class="form-container">
<form id="library-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="lr-report-type">Report Type</label>
<select class="form-select" id="lr-report-type" required="">
<option value="inventory">Book Inventory</option>
<option value="issue-return">Issue &amp; Return</option>
<option value="overdue">Overdue Books</option>
</select>
</div>
<div class="form-group">
<label for="lr-start-date">Start Date</label>
<input class="form-control" id="lr-start-date" type="date"/>
</div>
<div class="form-group">
<label for="lr-end-date">End Date</label>
<input class="form-control" id="lr-end-date" type="date"/>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-library-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="library-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Library Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-library-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="library-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
</section>
<!-- Add/Edit Book Modal -->
<div class="modal" id="book-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add New Book</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="book-form">
<div class="form-row">
<div class="form-group">
<label for="book-title">Title</label>
<input class="form-control" id="book-title" required="" type="text"/>
</div>
<div class="form-group">
<label for="book-author">Author</label>
<input class="form-control" id="book-author" required="" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="book-subject">Subject</label>
<input class="form-control" id="book-subject" required="" type="text"/>
</div>
<div class="form-group">
<label for="book-publisher">Publisher</label>
<input class="form-control" id="book-publisher" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="book-isbn">ISBN</label>
<input class="form-control" id="book-isbn" type="text"/>
</div>
<div class="form-group">
<label for="book-edition">Edition</label>
<input class="form-control" id="book-edition" type="text"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="book-copies">Number of Copies</label>
<input class="form-control" id="book-copies" min="1" required="" type="number" value="1"/>
</div>
<div class="form-group">
<label for="book-price">Price</label>
<input class="form-control" id="book-price" min="0" step="0.01" type="number"/>
</div>
</div>
<div class="form-group">
<label for="book-description">Description</label>
<textarea class="form-control form-textarea" id="book-description"></textarea>
</div>
<div class="form-group">
<label for="book-cover">Book Cover</label>
<input accept="image/*" class="form-control" id="book-cover" type="file"/>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Book</button>
</div>
</form>
</div>
</div>
</div>
<!-- Madrasa Module Section -->
<section class="content-section" id="madrasa-section">
<div class="page-header">
<h2>Madrasa Module</h2>
<ul class="breadcrumb">
<li>Madrasa Module</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="hifz-tracking">Hifz Tracking</div>
<div class="tab" data-tab="sabaq-sabaqi">Sabaq &amp; Sabaqi</div>
<div class="tab" data-tab="madrasa-reports">Reports</div>
</div>
<div class="tab-content active" id="hifz-tracking-tab">
<div class="form-container">
<form id="hifz-filter-form">
<div class="form-row">
<div class="form-group">
<label for="hifz-student">Student</label>
<select class="form-select" id="hifz-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="hifz-class">Class</label>
<select class="form-select" id="hifz-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="hifz-teacher">Teacher</label>
<select class="form-select" id="hifz-teacher">
<option value="">All Teachers</option>
<!-- Teachers will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Load Records</button>
<button class="btn btn-success" id="add-hifz-record-btn">
<i class="fas fa-plus"></i> Add Hifz Record
                            </button>
</div>
</form>
</div>
<div class="table-container">
<table id="hifz-records-table">
<thead>
<tr>
<th>Date</th>
<th>Student</th>
<th>Surah</th>
<th>From Ayah</th>
<th>To Ayah</th>
<th>Status</th>
<th>Teacher</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="hifz-records-table-body">
<!-- Hifz records will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="sabaq-sabaqi-tab">
<div class="form-container">
<form id="sabaq-filter-form">
<div class="form-row">
<div class="form-group">
<label for="sabaq-student">Student</label>
<select class="form-select" id="sabaq-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sabaq-class">Class</label>
<select class="form-select" id="sabaq-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sabaq-teacher">Teacher</label>
<select class="form-select" id="sabaq-teacher">
<option value="">All Teachers</option>
<!-- Teachers will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Load Records</button>
<button class="btn btn-success" id="add-sabaq-record-btn">
<i class="fas fa-plus"></i> Add Sabaq Record
                            </button>
</div>
</form>
</div>
<div class="table-container">
<table id="sabaq-records-table">
<thead>
<tr>
<th>Date</th>
<th>Student</th>
<th>Sabaq (New)</th>
<th>Sabaqi (Recent)</th>
<th>Manzil (Old)</th>
<th>Teacher</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="sabaq-records-table-body">
<!-- Sabaq records will be loaded here -->
</tbody>
</table>
</div>
</div>
<div class="tab-content" id="madrasa-reports-tab">
<div class="form-container">
<form id="madrasa-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="mr-report-type">Report Type</label>
<select class="form-select" id="mr-report-type" required="">
<option value="hifz-progress">Hifz Progress</option>
<option value="sabaq-progress">Sabaq Progress</option>
<option value="student-performance">Student Performance</option>
</select>
</div>
<div class="form-group">
<label for="mr-student">Student</label>
<select class="form-select" id="mr-student">
<option value="">All Students</option>
<!-- Students will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="mr-class">Class</label>
<select class="form-select" id="mr-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="mr-start-date">Start Date</label>
<input class="form-control" id="mr-start-date" type="date"/>
</div>
<div class="form-group">
<label for="mr-end-date">End Date</label>
<input class="form-control" id="mr-end-date" type="date"/>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-madrasa-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="madrasa-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Madrasa Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-madrasa-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="madrasa-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
</section>
<!-- Add/Edit Hifz Record Modal -->
<div class="modal" id="hifz-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add Hifz Record</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="hifz-form">
<div class="form-row">
<div class="form-group">
<label for="hifz-record-student">Student</label>
<select class="form-select" id="hifz-record-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="hifz-record-date">Date</label>
<input class="form-control" id="hifz-record-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="hifz-surah">Surah</label>
<select class="form-select" id="hifz-surah" required="">
<option value="">Select Surah</option>
<!-- Surahs will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="hifz-teacher-record">Teacher</label>
<select class="form-select" id="hifz-teacher-record" required="">
<option value="">Select Teacher</option>
<!-- Teachers will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="hifz-from-ayah">From Ayah</label>
<input class="form-control" id="hifz-from-ayah" min="1" required="" type="number"/>
</div>
<div class="form-group">
<label for="hifz-to-ayah">To Ayah</label>
<input class="form-control" id="hifz-to-ayah" min="1" required="" type="number"/>
</div>
</div>
<div class="form-group">
<label for="hifz-status">Status</label>
<select class="form-select" id="hifz-status" required="">
<option value="Memorized">Memorized</option>
<option value="Revised">Revised</option>
<option value="In Progress">In Progress</option>
</select>
</div>
<div class="form-group">
<label for="hifz-remarks">Remarks</label>
<textarea class="form-control form-textarea" id="hifz-remarks"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Record</button>
</div>
</form>
</div>
</div>
</div>
<!-- Add/Edit Sabaq Record Modal -->
<div class="modal" id="sabaq-modal">
<div class="modal-dialog">
<div class="modal-header">
<h3 class="modal-title">Add Sabaq Record</h3>
<button class="modal-close">×</button>
</div>
<div class="modal-body">
<form id="sabaq-form">
<div class="form-row">
<div class="form-group">
<label for="sabaq-record-student">Student</label>
<select class="form-select" id="sabaq-record-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sabaq-record-date">Date</label>
<input class="form-control" id="sabaq-record-date" required="" type="date"/>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="sabaq-teacher-record">Teacher</label>
<select class="form-select" id="sabaq-teacher-record" required="">
<option value="">Select Teacher</option>
<!-- Teachers will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sabaq-status">Status</label>
<select class="form-select" id="sabaq-status" required="">
<option value="Completed">Completed</option>
<option value="In Progress">In Progress</option>
<option value="Pending">Pending</option>
</select>
</div>
</div>
<div class="form-group">
<label for="sabaq-new">Sabaq (New Lesson)</label>
<textarea class="form-control form-textarea" id="sabaq-new" required=""></textarea>
</div>
<div class="form-group">
<label for="sabaq-recent">Sabaqi (Recent Revision)</label>
<textarea class="form-control form-textarea" id="sabaq-recent" required=""></textarea>
</div>
<div class="form-group">
<label for="sabaq-old">Manzil (Old Revision)</label>
<textarea class="form-control form-textarea" id="sabaq-old"></textarea>
</div>
<div class="form-group">
<label for="sabaq-remarks">Remarks</label>
<textarea class="form-control form-textarea" id="sabaq-remarks"></textarea>
</div>
<div class="form-actions">
<button class="btn btn-secondary modal-close" type="button">Cancel</button>
<button class="btn btn-primary" type="submit">Save Record</button>
</div>
</form>
</div>
</div>
</div>
<!-- Reports Section -->
<section class="content-section" id="reports-section">
<div class="page-header">
<h2>Reports</h2>
<ul class="breadcrumb">
<li>Reports</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="student-reports">Student Reports</div>
<div class="tab" data-tab="attendance-reports">Attendance Reports</div>
<div class="tab" data-tab="financial-reports">Financial Reports</div>
</div>
<div class="tab-content active" id="student-reports-tab">
<div class="form-container">
<form id="student-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="sr-report-type">Report Type</label>
<select class="form-select" id="sr-report-type" required="">
<option value="admission">Admission Report</option>
<option value="class-wise">Class-wise Report</option>
<option value="gender-wise">Gender-wise Report</option>
</select>
</div>
<div class="form-group">
<label for="sr-class">Class</label>
<select class="form-select" id="sr-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="sr-section">Section</label>
<select class="form-select" id="sr-section">
<option value="">All Sections</option>
<!-- Sections will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="sr-start-date">Start Date</label>
<input class="form-control" id="sr-start-date" type="date"/>
</div>
<div class="form-group">
<label for="sr-end-date">End Date</label>
<input class="form-control" id="sr-end-date" type="date"/>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-student-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="student-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Student Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-student-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="student-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
<div class="tab-content" id="attendance-reports-tab">
<div class="form-container">
<form id="attendance-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="ar-report-type">Report Type</label>
<select class="form-select" id="ar-report-type" required="">
<option value="daily">Daily Attendance</option>
<option value="monthly">Monthly Summary</option>
<option value="student-wise">Student-wise</option>
</select>
</div>
<div class="form-group">
<label for="ar-class">Class</label>
<select class="form-select" id="ar-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
<div class="form-group">
<label for="ar-section">Section</label>
<select class="form-select" id="ar-section">
<option value="">All Sections</option>
<!-- Sections will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="ar-date">Date</label>
<input class="form-control" id="ar-date" type="date"/>
</div>
<div class="form-group">
<label for="ar-month">Month</label>
<select class="form-select" id="ar-month">
<option value="">Select Month</option>
<option value="1">January</option>
<option value="2">February</option>
<option value="3">March</option>
<option value="4">April</option>
<option value="5">May</option>
<option value="6">June</option>
<option value="7">July</option>
<option value="8">August</option>
<option value="9">September</option>
<option value="10">October</option>
<option value="11">November</option>
<option value="12">December</option>
</select>
</div>
<div class="form-group">
<label for="ar-year">Year</label>
<select class="form-select" id="ar-year">
<!-- Years will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-attendance-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="attendance-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Attendance Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-attendance-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="attendance-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
<div class="tab-content" id="financial-reports-tab">
<div class="form-container">
<form id="financial-report-filter-form">
<div class="form-row">
<div class="form-group">
<label for="fr-report-type">Report Type</label>
<select class="form-select" id="fr-report-type" required="">
<option value="fee-collection">Fee Collection</option>
<option value="expenses">Expenses</option>
<option value="income">Income</option>
<option value="balance-sheet">Balance Sheet</option>
</select>
</div>
<div class="form-group">
<label for="fr-class">Class</label>
<select class="form-select" id="fr-class">
<option value="">All Classes</option>
<!-- Classes will be loaded here -->
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="fr-start-date">Start Date</label>
<input class="form-control" id="fr-start-date" type="date"/>
</div>
<div class="form-group">
<label for="fr-end-date">End Date</label>
<input class="form-control" id="fr-end-date" type="date"/>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Report</button>
<button class="btn btn-secondary" id="print-financial-report-btn" type="button">Print
                                Report</button>
</div>
</form>
</div>
<div class="table-container" id="financial-report-container" style="display: none;">
<div class="table-header">
<h3 class="table-title">Financial Report</h3>
<div class="table-actions">
<button class="btn btn-sm btn-outline-primary" id="export-financial-report-btn">
<i class="fas fa-download"></i> Export
                            </button>
</div>
</div>
<div id="financial-report-content">
<!-- Report content will be loaded here -->
</div>
</div>
</div>
</section>
<!-- ID Cards & Certificates Section -->
<section class="content-section" id="utilities-section">
<div class="page-header">
<h2>ID Cards &amp; Certificates</h2>
<ul class="breadcrumb">
<li>Utilities</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="id-cards">ID Cards</div>
<div class="tab" data-tab="certificates">Certificates</div>
</div>
<div class="tab-content active" id="id-cards-tab">
<div class="form-container">
<form id="id-card-filter-form">
<div class="form-row">
<div class="form-group">
<label for="id-card-type">ID Card Type</label>
<select class="form-select" id="id-card-type" required="">
<option value="student">Student ID Card</option>
<option value="teacher">Teacher ID Card</option>
<option value="staff">Staff ID Card</option>
</select>
</div>
<div class="form-group">
<label for="id-card-person">Person</label>
<select class="form-select" id="id-card-person" required="">
<option value="">Select Person</option>
<!-- People will be loaded here based on type -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate ID Card</button>
<button class="btn btn-secondary" id="print-id-card-btn" type="button">Print ID
                                Card</button>
</div>
</form>
</div>
<div class="card" id="id-card-preview" style="display: none;">
<div class="card-body">
<div id="id-card-content">
<!-- ID card content will be loaded here -->
</div>
</div>
</div>
</div>
<div class="tab-content" id="certificates-tab">
<div class="form-container">
<form id="certificate-filter-form">
<div class="form-row">
<div class="form-group">
<label for="certificate-type">Certificate Type</label>
<select class="form-select" id="certificate-type" required="">
<option value="bonafide">Bonafide Certificate</option>
<option value="transfer">Transfer Certificate</option>
<option value="character">Character Certificate</option>
<option value="hifz-completion">Hifz Completion Certificate</option>
</select>
</div>
<div class="form-group">
<label for="certificate-student">Student</label>
<select class="form-select" id="certificate-student" required="">
<option value="">Select Student</option>
<!-- Students will be loaded here -->
</select>
</div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Generate Certificate</button>
<button class="btn btn-secondary" id="print-certificate-btn" type="button">Print
                                Certificate</button>
</div>
</form>
</div>
<div class="card" id="certificate-preview" style="display: none;">
<div class="card-body">
<div id="certificate-content">
<!-- Certificate content will be loaded here -->
</div>
</div>
</div>
</div>
</section>
<!-- Settings Section -->
<section class="content-section" id="settings-section">
<div class="page-header">
<h2>Settings</h2>
<ul class="breadcrumb">
<li>Settings</li>
</ul>
</div>
<div class="tabs">
<div class="tab active" data-tab="institution">Institution</div>
<div class="tab" data-tab="academic">Academic</div>
<div class="tab" data-tab="fee">Fee</div>
<div class="tab" data-tab="system">System</div>
<div class="tab" data-tab="backup">Backup &amp; Restore</div>
</div>
<div class="tab-content active" id="institution-tab">
<div class="form-container">
<form id="institution-settings-form">
<div class="form-group">
<label for="institution-name">Institution Name</label>
<input class="form-control" id="institution-name" required="" type="text"/>
</div>
<div class="form-row">
<div class="form-group">
<label for="institution-phone">Phone</label>
<input class="form-control" id="institution-phone" required="" type="tel"/>
</div>
<div class="form-group">
<label for="institution-email">Email</label>
<input class="form-control" id="institution-email" required="" type="email"/>
</div>
</div>
<div class="form-group">
<label for="institution-address">Address</label>
<textarea class="form-control form-textarea" id="institution-address" required=""></textarea>
</div>
<div class="form-group">
<label for="institution-logo">Logo</label>
<input accept="image/*" class="form-control" id="institution-logo" type="file"/>
<div id="logo-preview" style="margin-top: 10px;"></div>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Save Settings</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="academic-tab">
<div class="form-container">
<form id="academic-settings-form">
<div class="form-row">
<div class="form-group">
<label for="academic-year">Academic Year</label>
<input class="form-control" id="academic-year" required="" type="text"/>
</div>
<div class="form-group">
<label for="academic-session">Session</label>
<select class="form-select" id="academic-session" required="">
<option value="Morning">Morning</option>
<option value="Evening">Evening</option>
<option value="Both">Both</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label for="academic-start-date">Academic Start Date</label>
<input class="form-control" id="academic-start-date" required="" type="date"/>
</div>
<div class="form-group">
<label for="academic-end-date">Academic End Date</label>
<input class="form-control" id="academic-end-date" required="" type="date"/>
</div>
</div>
<div class="form-group">
<label for="weekends">Weekends</label>
<select class="form-select" id="weekends" multiple="">
<option value="Friday">Friday</option>
<option value="Saturday">Saturday</option>
<option value="Sunday">Sunday</option>
<option value="Monday">Monday</option>
<option value="Tuesday">Tuesday</option>
<option value="Wednesday">Wednesday</option>
<option value="Thursday">Thursday</option>
</select>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Save Settings</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="fee-tab">
<div class="form-container">
<form id="fee-settings-form">
<div class="form-group">
<label for="fee-currency">Currency</label>
<select class="form-select" id="fee-currency" required="">
<option value="$">Dollar ($)</option>
<option value="€">Euro (€)</option>
<option value="£">Pound (£)</option>
<option value="¥">Yen (¥)</option>
<option value="₹">Rupee (₹)</option>
<option value="₨">Rupee (₨)</option>
</select>
</div>
<div class="form-group">
<label for="fee-fine-rate">Late Fee Fine Rate (per day)</label>
<input class="form-control" id="fee-fine-rate" min="0" required="" step="0.01" type="number"/>
</div>
<div class="form-group">
<label for="fee-payment-methods">Payment Methods</label>
<select class="form-select" id="fee-payment-methods" multiple="">
<option value="Cash">Cash</option>
<option value="Cheque">Cheque</option>
<option value="Bank Transfer">Bank Transfer</option>
<option value="Online Payment">Online Payment</option>
</select>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Save Settings</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="system-tab">
<div class="form-container">
<form id="system-settings-form">
<div class="form-group">
<label for="system-language">Language</label>
<select class="form-select" id="system-language" required="">
<option value="en">English</option>
<option value="ur">Urdu</option>
</select>
</div>
<div class="form-group">
<label for="system-theme">Theme</label>
<select class="form-select" id="system-theme" required="">
<option value="light">Light</option>
<option value="dark">Dark</option>
<option value="blue">Blue</option>
<option value="green">Green</option>
</select>
</div>
<div class="form-group">
<label for="system-timezone">Timezone</label>
<select class="form-select" id="system-timezone" required="">
<option value="UTC">UTC</option>
<option value="GMT+5">GMT+5 (Pakistan Standard Time)</option>
<option value="GMT-5">GMT-5 (Eastern Time)</option>
<!-- More timezones can be added -->
</select>
</div>
<div class="form-actions">
<button class="btn btn-primary" type="submit">Save Settings</button>
</div>
</form>
</div>
</div>
<div class="tab-content" id="backup-tab">
<div class="form-container">
<div class="form-group">
<label>Backup Data</label>
<p>Create a backup of all system data. This will download a JSON file containing all your data.
                        </p>
<button class="btn btn-primary" id="backup-data-btn">
<i class="fas fa-download"></i> Backup Data
                        </button>
</div>
<div class="form-group">
<label for="restore-data">Restore Data</label>
<p>Restore system data from a previously created backup file.</p>
<input accept=".json" class="form-control" id="restore-data" type="file"/>
<button class="btn btn-warning mt-10" disabled="" id="restore-data-btn">
<i class="fas fa-upload"></i> Restore Data
                        </button>
</div>
<div class="form-group">
<label>Reset Data</label>
<p>Warning: This will delete all data and reset the system to its initial state.</p>
<button class="btn btn-danger" id="reset-data-btn">
<i class="fas fa-trash"></i> Reset Data
                        </button>
</div>
</div>
</div>
</section>
</main>
<script>
        // Database setup
        const dbName = "SchoolMadrasaManagementDB";
        const dbVersion = 1;

        // Open or create the database
        let db;
        const request = indexedDB.open(dbName, dbVersion);

        request.onupgradeneeded = function (event) {
            const db = event.target.result;

            // Create object stores (tables)
            if (!db.objectStoreNames.contains('students')) {
                const studentsStore = db.createObjectStore('students', { keyPath: 'id', autoIncrement: true });
                studentsStore.createIndex('class', 'class', { unique: false });
                studentsStore.createIndex('section', 'section', { unique: false });
                studentsStore.createIndex('admissionNumber', 'admissionNumber', { unique: true });
            }

            if (!db.objectStoreNames.contains('teachers')) {
                const teachersStore = db.createObjectStore('teachers', { keyPath: 'id', autoIncrement: true });
                teachersStore.createIndex('subject', 'subjects', { unique: false, multiEntry: true });
            }

            if (!db.objectStoreNames.contains('staff')) {
                db.createObjectStore('staff', { keyPath: 'id', autoIncrement: true });
            }

            if (!db.objectStoreNames.contains('classes')) {
                const classesStore = db.createObjectStore('classes', { keyPath: 'id', autoIncrement: true });
                classesStore.createIndex('name', 'name', { unique: true });
            }

            if (!db.objectStoreNames.contains('subjects')) {
                const subjectsStore = db.createObjectStore('subjects', { keyPath: 'id', autoIncrement: true });
                subjectsStore.createIndex('name', 'name', { unique: true });
                subjectsStore.createIndex('code', 'code', { unique: true });
            }

            if (!db.objectStoreNames.contains('classSubjects')) {
                db.createObjectStore('classSubjects', { keyPath: 'id', autoIncrement: true });
            }

            if (!db.objectStoreNames.contains('attendance')) {
                const attendanceStore = db.createObjectStore('attendance', { keyPath: 'id', autoIncrement: true });
                attendanceStore.createIndex('date', 'date', { unique: false });
                attendanceStore.createIndex('studentId', 'studentId', { unique: false });
                attendanceStore.createIndex('class', 'class', { unique: false });
                attendanceStore.createIndex('section', 'section', { unique: false });
            }

            if (!db.objectStoreNames.contains('exams')) {
                const examsStore = db.createObjectStore('exams', { keyPath: 'id', autoIncrement: true });
                examsStore.createIndex('name', 'name', { unique: true });
            }

            if (!db.objectStoreNames.contains('examMarks')) {
                const examMarksStore = db.createObjectStore('examMarks', { keyPath: 'id', autoIncrement: true });
                examMarksStore.createIndex('examId', 'examId', { unique: false });
                examMarksStore.createIndex('studentId', 'studentId', { unique: false });
                examMarksStore.createIndex('subjectId', 'subjectId', { unique: false });
            }

            if (!db.objectStoreNames.contains('feeTypes')) {
                const feeTypesStore = db.createObjectStore('feeTypes', { keyPath: 'id', autoIncrement: true });
                feeTypesStore.createIndex('name', 'name', { unique: true });
                feeTypesStore.createIndex('code', 'code', { unique: true });
            }

            if (!db.objectStoreNames.contains('classFees')) {
                const classFeesStore = db.createObjectStore('classFees', { keyPath: 'id', autoIncrement: true });
                classFeesStore.createIndex('classId', 'classId', { unique: false });
                classFeesStore.createIndex('feeTypeId', 'feeTypeId', { unique: false });
            }

            if (!db.objectStoreNames.contains('feePayments')) {
                const feePaymentsStore = db.createObjectStore('feePayments', { keyPath: 'id', autoIncrement: true });
                feePaymentsStore.createIndex('studentId', 'studentId', { unique: false });
                feePaymentsStore.createIndex('feeTypeId', 'feeTypeId', { unique: false });
                feePaymentsStore.createIndex('date', 'date', { unique: false });
            }

            if (!db.objectStoreNames.contains('salaries')) {
                const salariesStore = db.createObjectStore('salaries', { keyPath: 'id', autoIncrement: true });
                salariesStore.createIndex('employeeId', 'employeeId', { unique: false });
                salariesStore.createIndex('employeeType', 'employeeType', { unique: false });
                salariesStore.createIndex('month', 'month', { unique: false });
                salariesStore.createIndex('year', 'year', { unique: false });
            }

            if (!db.objectStoreNames.contains('expenses')) {
                const expensesStore = db.createObjectStore('expenses', { keyPath: 'id', autoIncrement: true });
                expensesStore.createIndex('date', 'date', { unique: false });
                expensesStore.createIndex('category', 'category', { unique: false });
            }

            if (!db.objectStoreNames.contains('income')) {
                const incomeStore = db.createObjectStore('income', { keyPath: 'id', autoIncrement: true });
                incomeStore.createIndex('date', 'date', { unique: false });
                incomeStore.createIndex('category', 'category', { unique: false });
            }

            if (!db.objectStoreNames.contains('books')) {
                const booksStore = db.createObjectStore('books', { keyPath: 'id', autoIncrement: true });
                booksStore.createIndex('title', 'title', { unique: false });
                booksStore.createIndex('author', 'author', { unique: false });
                booksStore.createIndex('subject', 'subject', { unique: false });
            }

            if (!db.objectStoreNames.contains('bookIssues')) {
                const bookIssuesStore = db.createObjectStore('bookIssues', { keyPath: 'id', autoIncrement: true });
                bookIssuesStore.createIndex('bookId', 'bookId', { unique: false });
                bookIssuesStore.createIndex('studentId', 'studentId', { unique: false });
                bookIssuesStore.createIndex('issueDate', 'issueDate', { unique: false });
                bookIssuesStore.createIndex('dueDate', 'dueDate', { unique: false });
                bookIssuesStore.createIndex('status', 'status', { unique: false });
            }

            if (!db.objectStoreNames.contains('hifzRecords')) {
                const hifzRecordsStore = db.createObjectStore('hifzRecords', { keyPath: 'id', autoIncrement: true });
                hifzRecordsStore.createIndex('studentId', 'studentId', { unique: false });
                hifzRecordsStore.createIndex('teacherId', 'teacherId', { unique: false });
                hifzRecordsStore.createIndex('date', 'date', { unique: false });
                hifzRecordsStore.createIndex('surah', 'surah', { unique: false });
            }

            if (!db.objectStoreNames.contains('sabaqRecords')) {
                const sabaqRecordsStore = db.createObjectStore('sabaqRecords', { keyPath: 'id', autoIncrement: true });
                sabaqRecordsStore.createIndex('studentId', 'studentId', { unique: false });
                sabaqRecordsStore.createIndex('teacherId', 'teacherId', { unique: false });
                sabaqRecordsStore.createIndex('date', 'date', { unique: false });
            }

            if (!db.objectStoreNames.contains('settings')) {
                db.createObjectStore('settings', { keyPath: 'key' });
            }

            if (!db.objectStoreNames.contains('activities')) {
                const activitiesStore = db.createObjectStore('activities', { keyPath: 'id', autoIncrement: true });
                activitiesStore.createIndex('date', 'date', { unique: false });
            }

            if (!db.objectStoreNames.contains('events')) {
                const eventsStore = db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
                eventsStore.createIndex('date', 'date', { unique: false });
            }
        };

        request.onsuccess = function (event) {
            db = event.target.result;
            console.log("Database opened successfully");

            // Initialize the application
            initApp();
        };

        request.onerror = function (event) {
            console.error("Database error:", event.target.error);
        };

        // Application initialization

        // Load dashboard data
        function loadDashboardData() {
            // Count students
            countRecords('students', (count) => {
                document.getElementById('total-students').textContent = count;
            });

            // Count teachers
            countRecords('teachers', (count) => {
                document.getElementById('total-teachers').textContent = count;
            });

            // Calculate fee collection (this is a simplified example)
            calculateFeeCollection((total) => {
                document.getElementById('fee-collection').textContent = `$${total.toLocaleString()}`;
            });

            // Calculate today's attendance (simplified)
            calculateTodaysAttendance((percentage) => {
                document.getElementById('today-attendance').textContent = `${percentage}%`;
            });

            // Load recent activities
            loadRecentActivities();

            // Load upcoming events
            loadUpcomingEvents();
        }

        // Count records in a store
        function countRecords(storeName, callback) {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.count();

            request.onsuccess = function () {
                callback(request.result);
            };

            request.onerror = function (event) {
                console.error(`Error counting records in ${storeName}:`, event.target.error);
                callback(0);
            };
        }

        // Calculate fee collection (simplified)
        function calculateFeeCollection(callback) {
            const transaction = db.transaction(['feePayments'], 'readonly');
            const store = transaction.objectStore('feePayments');
            const request = store.getAll();

            request.onsuccess = function () {
                const payments = request.result;
                const total = payments.reduce((sum, payment) => sum + payment.amount, 0);
                callback(total);
            };

            request.onerror = function (event) {
                console.error("Error calculating fee collection:", event.target.error);
                callback(0);
            };
        }

        // Calculate today's attendance (simplified)
        function calculateTodaysAttendance(callback) {
            const today = new Date().toISOString().split('T')[0];
            const transaction = db.transaction(['attendance'], 'readonly');
            const store = transaction.objectStore('attendance');
            const index = store.index('date');
            const request = index.getAll(today);

            request.onsuccess = function () {
                const records = request.result;
                if (records.length === 0) {
                    callback(0);
                    return;
                }

                const presentCount = records.filter(r => r.status === 'Present').length;
                const percentage = Math.round((presentCount / records.length) * 100);
                callback(percentage);
            };

            request.onerror = function (event) {
                console.error("Error calculating today's attendance:", event.target.error);
                callback(0);
            };
        }

        // Load recent activities
        function loadRecentActivities() {
            const transaction = db.transaction(['activities'], 'readonly');
            const store = transaction.objectStore('activities');
            const index = store.index('date');
            const request = index.getAll().onsuccess = function (event) {
                const activities = event.target.result;
                // Sort by date descending and take the last 5
                const recentActivities = activities.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

                const activitiesList = document.getElementById('recent-activities');
                activitiesList.innerHTML = '';

                recentActivities.forEach(activity => {
                    const activityItem = document.createElement('li');
                    activityItem.className = 'activity-item';

                    activityItem.innerHTML = `
                        <div class="activity-icon">
                            <i class="fas ${getActivityIcon(activity.type)}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${formatTime(activity.date)}</div>
                        </div>
                    `;

                    activitiesList.appendChild(activityItem);
                });
            };
        }

        // Get icon for activity type
        function getActivityIcon(type) {
            const icons = {
                'student': 'fa-user-graduate',
                'teacher': 'fa-chalkboard-teacher',
                'fee': 'fa-money-bill-wave',
                'attendance': 'fa-clipboard-check',
                'exam': 'fa-file-alt',
                'library': 'fa-book',
                'system': 'fa-cog'
            };

            return icons[type] || 'fa-bell';
        }

        // Format time for display
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Load upcoming events
        function loadUpcomingEvents() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);

            const transaction = db.transaction(['events'], 'readonly');
            const store = transaction.objectStore('events');
            const index = store.index('date');
            const range = IDBKeyRange.bound(today.toISOString(), nextWeek.toISOString());
            const request = index.getAll(range);

            request.onsuccess = function (event) {
                const events = event.target.result;
                const upcomingEvents = events.sort((a, b) => new Date(a.date) - new Date(b.date));

                const eventsList = document.getElementById('upcoming-events');
                eventsList.innerHTML = '';

                upcomingEvents.forEach(event => {
                    const eventDate = new Date(event.date);

                    const eventItem = document.createElement('li');
                    eventItem.className = 'event-item';

                    eventItem.innerHTML = `
                        <div class="event-date">
                            <div class="event-day">${eventDate.getDate()}</div>
                            <div class="event-month">${eventDate.toLocaleString('default', { month: 'short' })}</div>
                        </div>
                        <div class="event-content">
                            <div class="event-title">${event.title}</div>
                            <div class="event-time">
                                <i class="far fa-clock"></i>
                                ${eventDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    `;

                    eventsList.appendChild(eventItem);
                });
            };
        }

        // Load students
        function loadStudents() {
            const transaction = db.transaction(['students'], 'readonly');
            const store = transaction.objectStore('students');
            const request = store.getAll();

            request.onsuccess = function () {
                const students = request.result;
                const tbody = document.getElementById('students-table-body');
                tbody.innerHTML = '';

                students.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${student.id}</td>
                        <td><img src="${student.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzM0OThEQiIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDIwVjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg=='}" alt="Student Photo" class="avatar"></td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.class || 'N/A'}</td>
                        <td>${student.section || 'N/A'}</td>
                        <td>${student.fatherName || 'N/A'}</td>
                        <td>${student.fatherPhone || 'N/A'}</td>
                        <td><span class="status-badge status-active">Active</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-student" data-id="${student.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-student" data-id="${student.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-student').forEach(button => {
                    button.addEventListener('click', function () {
                        const studentId = parseInt(this.getAttribute('data-id'));
                        editStudent(studentId);
                    });
                });

                document.querySelectorAll('.delete-student').forEach(button => {
                    button.addEventListener('click', function () {
                        const studentId = parseInt(this.getAttribute('data-id'));
                        deleteStudent(studentId);
                    });
                });
            };

            request.onerror = function (event) {
                console.error("Error loading students:", event.target.error);
            };
        }

        // Edit student
        function editStudent(studentId) {
            const transaction = db.transaction(['students'], 'readonly');
            const store = transaction.objectStore('students');
            const request = store.get(studentId);

            request.onsuccess = function () {
                const student = request.result;
                if (student) {
                    // Populate the form with student data
                    document.getElementById('student-first-name').value = student.firstName || '';
                    document.getElementById('student-last-name').value = student.lastName || '';
                    document.getElementById('student-gender').value = student.gender || '';
                    document.getElementById('student-dob').value = student.dob || '';
                    document.getElementById('student-class').value = student.class || '';
                    document.getElementById('student-section').value = student.section || '';
                    document.getElementById('student-admission-date').value = student.admissionDate || '';
                    document.getElementById('student-admission-number').value = student.admissionNumber || '';
                    document.getElementById('student-address').value = student.address || '';
                    document.getElementById('student-father-name').value = student.fatherName || '';
                    document.getElementById('student-father-phone').value = student.fatherPhone || '';
                    document.getElementById('student-mother-name').value = student.motherName || '';
                    document.getElementById('student-mother-phone').value = student.motherPhone || '';

                    // Set the form to edit mode
                    document.getElementById('student-form').setAttribute('data-id', studentId);
                    document.querySelector('.modal-title').textContent = 'Edit Student';

                    // Open the modal
                    document.getElementById('student-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching student:", event.target.error);
            };
        }

        // Delete student
        function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student?')) {
                const transaction = db.transaction(['students'], 'readwrite');
                const store = transaction.objectStore('students');
                const request = store.delete(studentId);

                request.onsuccess = function () {
                    console.log("Student deleted successfully");
                    loadStudents();
                    addActivity('student', 'Student Deleted', `Student with ID ${studentId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting student:", event.target.error);
                };
            }
        }

        // Load teachers
        function loadTeachers() {
            const transaction = db.transaction(['teachers'], 'readonly');
            const store = transaction.objectStore('teachers');
            const request = store.getAll();

            request.onsuccess = function () {
                const teachers = request.result;
                const tbody = document.getElementById('teachers-table-body');
                tbody.innerHTML = '';

                teachers.forEach(teacher => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${teacher.id}</td>
                        <td><img src="${teacher.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iIzJFRjFGNyIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDIwVjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg=='}" alt="Teacher Photo" class="avatar"></td>
                        <td>${teacher.firstName} ${teacher.lastName}</td>
                        <td>${teacher.subjects ? teacher.subjects.join(', ') : 'N/A'}</td>
                        <td>${teacher.qualification || 'N/A'}</td>
                        <td>${teacher.phone || 'N/A'}</td>
                        <td>${teacher.joiningDate || 'N/A'}</td>
                        <td><span class="status-badge status-active">Active</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-teacher" data-id="${teacher.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-teacher" data-id="${teacher.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-teacher').forEach(button => {
                    button.addEventListener('click', function () {
                        const teacherId = parseInt(this.getAttribute('data-id'));
                        editTeacher(teacherId);
                    });
                });

                document.querySelectorAll('.delete-teacher').forEach(button => {
                    button.addEventListener('click', function () {
                        const teacherId = parseInt(this.getAttribute('data-id'));
                        deleteTeacher(teacherId);
                    });
                });
            };

            request.onerror = function (event) {
                console.error("Error loading teachers:", event.target.error);
            };
        }

        // Edit teacher
        function editTeacher(teacherId) {
            const transaction = db.transaction(['teachers'], 'readonly');
            const store = transaction.objectStore('teachers');
            const request = store.get(teacherId);

            request.onsuccess = function () {
                const teacher = request.result;
                if (teacher) {
                    // Populate the form with teacher data
                    document.getElementById('teacher-first-name').value = teacher.firstName || '';
                    document.getElementById('teacher-last-name').value = teacher.lastName || '';
                    document.getElementById('teacher-gender').value = teacher.gender || '';
                    document.getElementById('teacher-dob').value = teacher.dob || '';
                    document.getElementById('teacher-email').value = teacher.email || '';
                    document.getElementById('teacher-phone').value = teacher.phone || '';
                    document.getElementById('teacher-qualification').value = teacher.qualification || '';
                    document.getElementById('teacher-joining-date').value = teacher.joiningDate || '';
                    document.getElementById('teacher-salary').value = teacher.salary || '';
                    document.getElementById('teacher-address').value = teacher.address || '';

                    // Set subjects (this is a simplified example)
                    if (teacher.subjects) {
                        const subjectSelect = document.getElementById('teacher-subjects');
                        teacher.subjects.forEach(subject => {
                            const option = Array.from(subjectSelect.options).find(opt => opt.value === subject);
                            if (option) option.selected = true;
                        });
                    }

                    // Set the form to edit mode
                    document.getElementById('teacher-form').setAttribute('data-id', teacherId);
                    document.querySelector('#teacher-modal .modal-title').textContent = 'Edit Teacher';

                    // Open the modal
                    document.getElementById('teacher-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching teacher:", event.target.error);
            };
        }

        // Delete teacher
        function deleteTeacher(teacherId) {
            if (confirm('Are you sure you want to delete this teacher?')) {
                const transaction = db.transaction(['teachers'], 'readwrite');
                const store = transaction.objectStore('teachers');
                const request = store.delete(teacherId);

                request.onsuccess = function () {
                    console.log("Teacher deleted successfully");
                    loadTeachers();
                    addActivity('teacher', 'Teacher Deleted', `Teacher with ID ${teacherId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting teacher:", event.target.error);
                };
            }
        }

        // Load staff
        function loadStaff() {
            const transaction = db.transaction(['staff'], 'readonly');
            const store = transaction.objectStore('staff');
            const request = store.getAll();

            request.onsuccess = function () {
                const staff = request.result;
                const tbody = document.getElementById('staff-table-body');
                tbody.innerHTML = '';

                staff.forEach(staffMember => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${staffMember.id}</td>
                        <td><img src="${staffMember.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0YzOUMyMSIgZD0iTTEyLDEzQzkuMzMsMTMgNCwxNC4zMyA0LDE3VjIwSDIwVjE3QzIwLDE0LjMzIDE0LjY3LDEzIDEyLDEzTTEyLDEyQTEuNSwxLjUgMCAwLDAgMTMuNSwxMC41QTEuNSwxLjUgMCAwLDAgMTIsOUExLjUsMS41IDAgMCwwIDEwLjUsMTAuNUExLjUsMS41IDAgMCwwIDEyLDEyTTEyLDNMMTAsNUgxNEwxMiwzTTE3LDVMMTUsN1YxMUgxOVY3TDE3LDVNNSw3TDcsMTFIMTFMNyw3TDUsNUw1LDdNMTIsMkExMCwxMCAwIDAsMCAyLDEyQTEwLDEwIDAgMCwwIDEyLDIyQTEwLDEwIDAgMCwwIDIyLDEyQTEwLDEwIDAgMCwwIDEyLDJaIiAvPjwvc3ZnPg=='}" alt="Staff Photo" class="avatar"></td>
                        <td>${staffMember.firstName} ${staffMember.lastName}</td>
                        <td>${staffMember.role || 'N/A'}</td>
                        <td>${staffMember.phone || 'N/A'}</td>
                        <td>${staffMember.joiningDate || 'N/A'}</td>
                        <td>${staffMember.salary ? '$' + staffMember.salary : 'N/A'}</td>
                        <td><span class="status-badge ${staffMember.status === 'Active' ? 'status-active' : 'status-inactive'}">${staffMember.status || 'Inactive'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-staff" data-id="${staffMember.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-staff" data-id="${staffMember.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-staff').forEach(button => {
                    button.addEventListener('click', function () {
                        const staffId = parseInt(this.getAttribute('data-id'));
                        editStaff(staffId);
                    });
                });

                document.querySelectorAll('.delete-staff').forEach(button => {
                    button.addEventListener('click', function () {
                        const staffId = parseInt(this.getAttribute('data-id'));
                        deleteStaff(staffId);
                    });
                });
            };

            request.onerror = function (event) {
                console.error("Error loading staff:", event.target.error);
            };
        }

        // Edit staff
        function editStaff(staffId) {
            const transaction = db.transaction(['staff'], 'readonly');
            const store = transaction.objectStore('staff');
            const request = store.get(staffId);

            request.onsuccess = function () {
                const staff = request.result;
                if (staff) {
                    // Populate the form with staff data
                    document.getElementById('staff-first-name').value = staff.firstName || '';
                    document.getElementById('staff-last-name').value = staff.lastName || '';
                    document.getElementById('staff-gender').value = staff.gender || '';
                    document.getElementById('staff-dob').value = staff.dob || '';
                    document.getElementById('staff-email').value = staff.email || '';
                    document.getElementById('staff-phone').value = staff.phone || '';
                    document.getElementById('staff-role').value = staff.role || '';
                    document.getElementById('staff-joining-date').value = staff.joiningDate || '';
                    document.getElementById('staff-salary').value = staff.salary || '';
                    document.getElementById('staff-status').value = staff.status || 'Active';
                    document.getElementById('staff-address').value = staff.address || '';

                    // Set the form to edit mode
                    document.getElementById('staff-form').setAttribute('data-id', staffId);
                    document.querySelector('#staff-modal .modal-title').textContent = 'Edit Staff';

                    // Open the modal
                    document.getElementById('staff-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching staff:", event.target.error);
            };
        }

        // Delete staff
        function deleteStaff(staffId) {
            if (confirm('Are you sure you want to delete this staff member?')) {
                const transaction = db.transaction(['staff'], 'readwrite');
                const store = transaction.objectStore('staff');
                const request = store.delete(staffId);

                request.onsuccess = function () {
                    console.log("Staff deleted successfully");
                    loadStaff();
                    addActivity('staff', 'Staff Deleted', `Staff with ID ${staffId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting staff:", event.target.error);
                };
            }
        }

        // Load classes
        function loadClasses() {
            const transaction = db.transaction(['classes'], 'readonly');
            const store = transaction.objectStore('classes');
            const request = store.getAll();

            request.onsuccess = function () {
                const classes = request.result;
                const tbody = document.getElementById('classes-table-body');
                tbody.innerHTML = '';

                classes.forEach(cls => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cls.id}</td>
                        <td>${cls.name || 'N/A'}</td>
                        <td>${cls.sections ? cls.sections.join(', ') : 'N/A'}</td>
                        <td>${cls.classTeacher || 'N/A'}</td>
                        <td>${cls.studentCount || 0}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-class" data-id="${cls.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-class" data-id="${cls.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-class').forEach(button => {
                    button.addEventListener('click', function () {
                        const classId = parseInt(this.getAttribute('data-id'));
                        editClass(classId);
                    });
                });

                document.querySelectorAll('.delete-class').forEach(button => {
                    button.addEventListener('click', function () {
                        const classId = parseInt(this.getAttribute('data-id'));
                        deleteClass(classId);
                    });
                });

                // Also populate class dropdowns in other forms
                populateClassDropdowns();
            };

            request.onerror = function (event) {
                console.error("Error loading classes:", event.target.error);
            };
        }

        // Edit class
        function editClass(classId) {
            const transaction = db.transaction(['classes'], 'readonly');
            const store = transaction.objectStore('classes');
            const request = store.get(classId);

            request.onsuccess = function () {
                const cls = request.result;
                if (cls) {
                    // Populate the form with class data
                    document.getElementById('class-name').value = cls.name || '';
                    document.getElementById('class-numeric-value').value = cls.numericValue || '';
                    document.getElementById('class-sections').value = cls.sections ? cls.sections.join(',') : '';
                    document.getElementById('class-teacher').value = cls.classTeacher || '';

                    // Set the form to edit mode
                    document.getElementById('class-form').setAttribute('data-id', classId);
                    document.querySelector('#class-modal .modal-title').textContent = 'Edit Class';

                    // Open the modal
                    document.getElementById('class-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching class:", event.target.error);
            };
        }

        // Delete class
        function deleteClass(classId) {
            if (confirm('Are you sure you want to delete this class? This will also delete all associated data.')) {
                const transaction = db.transaction(['classes'], 'readwrite');
                const store = transaction.objectStore('classes');
                const request = store.delete(classId);

                request.onsuccess = function () {
                    console.log("Class deleted successfully");
                    loadClasses();
                    addActivity('system', 'Class Deleted', `Class with ID ${classId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting class:", event.target.error);
                };
            }
        }

        // Populate class dropdowns in various forms
        function populateClassDropdowns() {
            const transaction = db.transaction(['classes'], 'readonly');
            const store = transaction.objectStore('classes');
            const request = store.getAll();

            request.onsuccess = function () {
                const classes = request.result;

                // Get all class dropdowns
                const classDropdowns = [
                    'student-class', 'attendance-class', 'report-class',
                    'marks-class', 'rc-class', 'fee-class', 'fr-class',
                    'df-class', 'assign-class', 'hifz-class', 'sabaq-class',
                    'sr-class', 'ar-class', 'mr-class'
                ];

                classDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        // Save the current value
                        const currentValue = dropdown.value;

                        // Clear existing options except the first one
                        while (dropdown.options.length > 1) {
                            dropdown.remove(1);
                        }

                        // Add new options
                        classes.forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls.id;
                            option.textContent = cls.name;
                            dropdown.appendChild(option);
                        });

                        // Restore the previous value if it still exists
                        if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                            dropdown.value = currentValue;
                        }
                    }
                });
            };
        }

        // Load subjects
        function loadSubjects() {
            const transaction = db.transaction(['subjects'], 'readonly');
            const store = transaction.objectStore('subjects');
            const request = store.getAll();

            request.onsuccess = function () {
                const subjects = request.result;
                const tbody = document.getElementById('subjects-table-body');
                tbody.innerHTML = '';

                subjects.forEach(subject => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${subject.id}</td>
                        <td>${subject.name || 'N/A'}</td>
                        <td>${subject.code || 'N/A'}</td>
                        <td>${subject.type || 'N/A'}</td>
                        <td>${subject.teacher || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-subject" data-id="${subject.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-subject" data-id="${subject.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-subject').forEach(button => {
                    button.addEventListener('click', function () {
                        const subjectId = parseInt(this.getAttribute('data-id'));
                        editSubject(subjectId);
                    });
                });

                document.querySelectorAll('.delete-subject').forEach(button => {
                    button.addEventListener('click', function () {
                        const subjectId = parseInt(this.getAttribute('data-id'));
                        deleteSubject(subjectId);
                    });
                });

                // Also populate subject dropdowns in other forms
                populateSubjectDropdowns();
            };

            request.onerror = function (event) {
                console.error("Error loading subjects:", event.target.error);
            };
        }

        // Edit subject
        function editSubject(subjectId) {
            const transaction = db.transaction(['subjects'], 'readonly');
            const store = transaction.objectStore('subjects');
            const request = store.get(subjectId);

            request.onsuccess = function () {
                const subject = request.result;
                if (subject) {
                    // Populate the form with subject data
                    document.getElementById('subject-name').value = subject.name || '';
                    document.getElementById('subject-code').value = subject.code || '';
                    document.getElementById('subject-type').value = subject.type || 'Core';
                    document.getElementById('subject-teacher').value = subject.teacher || '';
                    document.getElementById('subject-description').value = subject.description || '';

                    // Set the form to edit mode
                    document.getElementById('subject-form').setAttribute('data-id', subjectId);
                    document.querySelector('#subject-modal .modal-title').textContent = 'Edit Subject';

                    // Open the modal
                    document.getElementById('subject-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching subject:", event.target.error);
            };
        }

        // Delete subject
        function deleteSubject(subjectId) {
            if (confirm('Are you sure you want to delete this subject? This will also delete all associated data.')) {
                const transaction = db.transaction(['subjects'], 'readwrite');
                const store = transaction.objectStore('subjects');
                const request = store.delete(subjectId);

                request.onsuccess = function () {
                    console.log("Subject deleted successfully");
                    loadSubjects();
                    addActivity('system', 'Subject Deleted', `Subject with ID ${subjectId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting subject:", event.target.error);
                };
            }
        }

        // Populate subject dropdowns in various forms
        function populateSubjectDropdowns() {
            const transaction = db.transaction(['subjects'], 'readonly');
            const store = transaction.objectStore('subjects');
            const request = store.getAll();

            request.onsuccess = function () {
                const subjects = request.result;

                // Get all subject dropdowns
                const subjectDropdowns = [
                    'teacher-subjects', 'marks-subject', 'subject-teacher'
                ];

                subjectDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        // Save the current value(s)
                        let currentValues = [];
                        if (dropdown.multiple) {
                            currentValues = Array.from(dropdown.selectedOptions).map(opt => opt.value);
                        } else {
                            currentValues = [dropdown.value];
                        }

                        // Clear existing options except the first one
                        while (dropdown.options.length > (dropdownId === 'teacher-subjects' ? 0 : 1)) {
                            dropdown.remove(dropdownId === 'teacher-subjects' ? 0 : 1);
                        }

                        // Add new options
                        subjects.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject.id;
                            option.textContent = subject.name;
                            dropdown.appendChild(option);
                        });

                        // Restore the previous values if they still exist
                        if (dropdown.multiple) {
                            currentValues.forEach(value => {
                                const option = Array.from(dropdown.options).find(opt => opt.value === value);
                                if (option) option.selected = true;
                            });
                        } else if (currentValues[0] && Array.from(dropdown.options).some(opt => opt.value === currentValues[0])) {
                            dropdown.value = currentValues[0];
                        }
                    }
                });
            };
        }

        // Load fee types
        function loadFeeTypes() {
            const transaction = db.transaction(['feeTypes'], 'readonly');
            const store = transaction.objectStore('feeTypes');
            const request = store.getAll();

            request.onsuccess = function () {
                const feeTypes = request.result;
                const tbody = document.getElementById('fee-types-table-body');
                tbody.innerHTML = '';

                feeTypes.forEach(feeType => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${feeType.id}</td>
                        <td>${feeType.name || 'N/A'}</td>
                        <td>$${feeType.amount || '0'}</td>
                        <td>${feeType.frequency || 'N/A'}</td>
                        <td>${feeType.description || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-fee-type" data-id="${feeType.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-fee-type" data-id="${feeType.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-fee-type').forEach(button => {
                    button.addEventListener('click', function () {
                        const feeTypeId = parseInt(this.getAttribute('data-id'));
                        editFeeType(feeTypeId);
                    });
                });

                document.querySelectorAll('.delete-fee-type').forEach(button => {
                    button.addEventListener('click', function () {
                        const feeTypeId = parseInt(this.getAttribute('data-id'));
                        deleteFeeType(feeTypeId);
                    });
                });

                // Also populate fee type dropdowns in other forms
                populateFeeTypeDropdowns();
            };

            request.onerror = function (event) {
                console.error("Error loading fee types:", event.target.error);
            };
        }

        // Edit fee type
        function editFeeType(feeTypeId) {
            const transaction = db.transaction(['feeTypes'], 'readonly');
            const store = transaction.objectStore('feeTypes');
            const request = store.get(feeTypeId);

            request.onsuccess = function () {
                const feeType = request.result;
                if (feeType) {
                    // Populate the form with fee type data
                    document.getElementById('fee-type-name').value = feeType.name || '';
                    document.getElementById('fee-type-code').value = feeType.code || '';
                    document.getElementById('fee-type-amount').value = feeType.amount || '';
                    document.getElementById('fee-type-frequency').value = feeType.frequency || 'Monthly';
                    document.getElementById('fee-type-description').value = feeType.description || '';

                    // Set the form to edit mode
                    document.getElementById('fee-type-form').setAttribute('data-id', feeTypeId);
                    document.querySelector('#fee-type-modal .modal-title').textContent = 'Edit Fee Type';

                    // Open the modal
                    document.getElementById('fee-type-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching fee type:", event.target.error);
            };
        }

        // Delete fee type
        function deleteFeeType(feeTypeId) {
            if (confirm('Are you sure you want to delete this fee type? This will also delete all associated data.')) {
                const transaction = db.transaction(['feeTypes'], 'readwrite');
                const store = transaction.objectStore('feeTypes');
                const request = store.delete(feeTypeId);

                request.onsuccess = function () {
                    console.log("Fee type deleted successfully");
                    loadFeeTypes();
                    addActivity('fee', 'Fee Type Deleted', `Fee type with ID ${feeTypeId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting fee type:", event.target.error);
                };
            }
        }

        // Populate fee type dropdowns in various forms
        function populateFeeTypeDropdowns() {
            const transaction = db.transaction(['feeTypes'], 'readonly');
            const store = transaction.objectStore('feeTypes');
            const request = store.getAll();

            request.onsuccess = function () {
                const feeTypes = request.result;

                // Get all fee type dropdowns
                const feeTypeDropdowns = [
                    'assign-fee-type', 'fr-fee-type', 'df-fee-type'
                ];

                feeTypeDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        // Save the current value
                        const currentValue = dropdown.value;

                        // Clear existing options except the first one
                        while (dropdown.options.length > 1) {
                            dropdown.remove(1);
                        }

                        // Add new options
                        feeTypes.forEach(feeType => {
                            const option = document.createElement('option');
                            option.value = feeType.id;
                            option.textContent = feeType.name;
                            dropdown.appendChild(option);
                        });

                        // Restore the previous value if it still exists
                        if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                            dropdown.value = currentValue;
                        }
                    }
                });
            };
        }

        // Load exams
        function loadExams() {
            const transaction = db.transaction(['exams'], 'readonly');
            const store = transaction.objectStore('exams');
            const request = store.getAll();

            request.onsuccess = function () {
                const exams = request.result;
                const tbody = document.getElementById('exams-table-body');
                tbody.innerHTML = '';

                exams.forEach(exam => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${exam.id}</td>
                        <td>${exam.name || 'N/A'}</td>
                        <td>${exam.type || 'N/A'}</td>
                        <td>${exam.startDate || 'N/A'}</td>
                        <td>${exam.endDate || 'N/A'}</td>
                        <td>${exam.classes ? exam.classes.join(', ') : 'N/A'}</td>
                        <td><span class="status-badge ${exam.status === 'Active' ? 'status-active' : 'status-inactive'}">${exam.status || 'Inactive'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-exam" data-id="${exam.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-exam" data-id="${exam.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Add event listeners to edit and delete buttons
                document.querySelectorAll('.edit-exam').forEach(button => {
                    button.addEventListener('click', function () {
                        const examId = parseInt(this.getAttribute('data-id'));
                        editExam(examId);
                    });
                });

                document.querySelectorAll('.delete-exam').forEach(button => {
                    button.addEventListener('click', function () {
                        const examId = parseInt(this.getAttribute('data-id'));
                        deleteExam(examId);
                    });
                });

                // Also populate exam dropdowns in other forms
                populateExamDropdowns();
            };

            request.onerror = function (event) {
                console.error("Error loading exams:", event.target.error);
            };
        }

        // Edit exam
        function editExam(examId) {
            const transaction = db.transaction(['exams'], 'readonly');
            const store = transaction.objectStore('exams');
            const request = store.get(examId);

            request.onsuccess = function () {
                const exam = request.result;
                if (exam) {
                    // Populate the form with exam data
                    document.getElementById('exam-name').value = exam.name || '';
                    document.getElementById('exam-type').value = exam.type || 'Monthly';
                    document.getElementById('exam-start-date').value = exam.startDate || '';
                    document.getElementById('exam-end-date').value = exam.endDate || '';
                    document.getElementById('exam-description').value = exam.description || '';

                    // Set classes (this is a simplified example)
                    if (exam.classes) {
                        const classSelect = document.getElementById('exam-classes');
                        exam.classes.forEach(classId => {
                            const option = Array.from(classSelect.options).find(opt => opt.value === classId.toString());
                            if (option) option.selected = true;
                        });
                    }

                    // Set the form to edit mode
                    document.getElementById('exam-form').setAttribute('data-id', examId);
                    document.querySelector('#exam-modal .modal-title').textContent = 'Edit Exam';

                    // Open the modal
                    document.getElementById('exam-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching exam:", event.target.error);
            };
        }

        // Delete exam
        function deleteExam(examId) {
            if (confirm('Are you sure you want to delete this exam? This will also delete all associated data.')) {
                const transaction = db.transaction(['exams'], 'readwrite');
                const store = transaction.objectStore('exams');
                const request = store.delete(examId);
                request.onsuccess = function () {
                    console.log(`Exam ${action} successfully`);
                    loadExams();

                    const activityTitle = id ? 'Exam Updated' : 'New Exam Added';
                    const activityDesc = id ?
                        `Exam "${data.name}" (ID: ${id}) was updated` :
                        `New exam "${data.name}" was added`;

                    addActivity('exam', activityTitle, activityDesc);

                    document.getElementById('exam-modal').classList.remove('show');
                };

                request.onerror = function (event) {
                    console.error(`Error ${action} exam:`, event.target.error);
                    alert(`Error ${action} exam. Please try again.`);
                };
            }
        }

        // Save book to database
        function saveBook(id, data) {
            const transaction = db.transaction(['books'], 'readwrite');
            const store = transaction.objectStore('books');

            let request;
            let action;

            if (id) {
                data.id = id;
                request = store.put(data);
                action = 'updated';
            } else {
                request = store.add(data);
                action = 'added';
            }

            request.onsuccess = function () {
                console.log(`Book ${action} successfully`);
                loadBooks();

                const activityTitle = id ? 'Book Updated' : 'New Book Added';
                const activityDesc = id ?
                    `Book "${data.title}" (ID: ${id}) was updated` :
                    `New book "${data.title}" was added`;

                addActivity('library', activityTitle, activityDesc);

                document.getElementById('book-modal').classList.remove('show');
            };

            request.onerror = function (event) {
                console.error(`Error ${action} book:`, event.target.error);
                alert(`Error ${action} book. Please try again.`);
            };
        }

        // Save hifz record to database
        async function saveHifzRecord(id, data) {
            const transaction = db.transaction(['hifzRecords', 'students', 'teachers'], 'readwrite');
            const hifzStore = transaction.objectStore('hifzRecords');
            const studentsStore = transaction.objectStore('students');
            const teachersStore = transaction.objectStore('teachers');

            try {
                // Fetch student and teacher names for display
                const student = await getRecord(studentsStore, parseInt(data.studentId));
                const teacher = await getRecord(teachersStore, parseInt(data.teacherId));
                data.studentName = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                data.teacherName = teacher ? `${teacher.firstName} ${teacher.lastName}` : 'Unknown Teacher';

                let request;
                let action;

                if (id) {
                    data.id = id;
                    request = hifzStore.put(data);
                    action = 'updated';
                } else {
                    request = hifzStore.add(data);
                    action = 'added';
                }

                request.onsuccess = function () {
                    console.log(`Hifz record ${action} successfully`);
                    loadHifzRecords();

                    const activityTitle = id ? 'Hifz Record Updated' : 'New Hifz Record Added';
                    const activityDesc = id ?
                        `Hifz record for ${data.studentName} (ID: ${id}) was updated` :
                        `New Hifz record added for ${data.studentName}`;

                    addActivity('madrasa', activityTitle, activityDesc);

                    document.getElementById('hifz-modal').classList.remove('show');
                };

                request.onerror = function (event) {
                    console.error(`Error ${action} hifz record:`, event.target.error);
                    alert(`Error ${action} hifz record. Please try again.`);
                };
            } catch (error) {
                console.error("Error fetching related data for hifz record:", error);
                alert("Error saving Hifz record. Could not find student or teacher.");
            }
        }

        // Save sabaq record to database
        async function saveSabaqRecord(id, data) {
            const transaction = db.transaction(['sabaqRecords', 'students', 'teachers'], 'readwrite');
            const sabaqStore = transaction.objectStore('sabaqRecords');
            const studentsStore = transaction.objectStore('students');
            const teachersStore = transaction.objectStore('teachers');

            try {
                // Fetch student and teacher names for display
                const student = await getRecord(studentsStore, parseInt(data.studentId));
                const teacher = await getRecord(teachersStore, parseInt(data.teacherId));
                data.studentName = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                data.teacherName = teacher ? `${teacher.firstName} ${teacher.lastName}` : 'Unknown Teacher';

                let request;
                let action;

                if (id) {
                    data.id = id;
                    request = sabaqStore.put(data);
                    action = 'updated';
                } else {
                    request = sabaqStore.add(data);
                    action = 'added';
                }

                request.onsuccess = function () {
                    console.log(`Sabaq record ${action} successfully`);
                    loadSabaqRecords();

                    const activityTitle = id ? 'Sabaq Record Updated' : 'New Sabaq Record Added';
                    const activityDesc = id ?
                        `Sabaq record for ${data.studentName} (ID: ${id}) was updated` :
                        `New Sabaq record added for ${data.studentName}`;

                    addActivity('madrasa', activityTitle, activityDesc);

                    document.getElementById('sabaq-modal').classList.remove('show');
                };

                request.onerror = function (event) {
                    console.error(`Error ${action} sabaq record:`, event.target.error);
                    alert(`Error ${action} sabaq record. Please try again.`);
                };
            } catch (error) {
                console.error("Error fetching related data for sabaq record:", error);
                alert("Error saving Sabaq record. Could not find student or teacher.");
            }
        }


        // Save settings to database
        function saveSettings(key, data) {
            const transaction = db.transaction(['settings'], 'readwrite');
            const store = transaction.objectStore('settings');

            const request = store.put({ key: key, value: data });

            request.onsuccess = function () {
                console.log(`${key} settings saved successfully`);
                loadSettings();
                addActivity('system', 'Settings Updated', `${key} settings were updated`);
                alert(`${key} settings saved!`); // Basic feedback
            };

            request.onerror = function (event) {
                console.error(`Error saving ${key} settings:`, event.target.error);
                alert(`Error saving ${key} settings. Please try again.`);
            };
        }

        // Helper function to get a record by ID
        function getRecord(store, id) {
            return new Promise((resolve, reject) => {
                const request = store.get(id);
                request.onsuccess = function () {
                    resolve(request.result);
                };
                request.onerror = function (event) {
                    reject(event.target.error);
                };
            });
        }

        // Helper function to get all records from a store
        function getAllRecords(store) {
            return new Promise((resolve, reject) => {
                const request = store.getAll();
                request.onsuccess = function () {
                    resolve(request.result);
                };
                request.onerror = function (event) {
                    reject(event.target.error);
                };
            });
        }

        // Populate student dropdowns
        function populateStudentDropdowns() {
            const transaction = db.transaction(['students'], 'readonly');
            const store = transaction.objectStore('students');
            const request = store.getAll();

            request.onsuccess = function () {
                const students = request.result;

                const studentDropdowns = [
                    'fee-student', 'hifz-student', 'sabaq-student',
                    'rc-student', 'certificate-student', 'id-card-person' // Assuming student type
                ];

                studentDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        const currentValue = dropdown.value;
                        while (dropdown.options.length > 1) {
                            dropdown.remove(1);
                        }
                        students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.firstName} ${student.lastName} (ID: ${student.id})`;
                            dropdown.appendChild(option);
                        });
                        if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                            dropdown.value = currentValue;
                        }
                    }
                });
            };
        }

        // Populate teacher dropdowns
        function populateTeacherDropdowns() {
            const transaction = db.transaction(['teachers'], 'readonly');
            const store = transaction.objectStore('teachers');
            const request = store.getAll();

            request.onsuccess = function () {
                const teachers = request.result;

                const teacherDropdowns = [
                    'class-teacher', 'subject-teacher', 'hifz-teacher', 'sabaq-teacher', 'id-card-person' // Assuming teacher type
                ];

                teacherDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        const currentValue = dropdown.value;
                        // Clear existing options except the first one (or none for multiple select)
                        while (dropdown.options.length > (dropdownId === 'teacher-subjects' ? 0 : 1)) {
                            dropdown.remove(dropdownId === 'teacher-subjects' ? 0 : 1);
                        }
                        teachers.forEach(teacher => {
                            const option = document.createElement('option');
                            option.value = teacher.id;
                            option.textContent = `${teacher.firstName} ${teacher.lastName} (ID: ${teacher.id})`;
                            dropdown.appendChild(option);
                        });
                        if (!dropdown.multiple && currentValue && Array.from(dropdown.options).some(opt => opt.value == currentValue)) {
                            dropdown.value = currentValue;
                        } else if (dropdown.multiple) {
                            // Need to handle multiple selection restore separately if necessary
                        }
                    }
                });
            };
        }

        // Populate staff dropdowns
        function populateStaffDropdowns() {
            const transaction = db.transaction(['staff'], 'readonly');
            const store = transaction.objectStore('staff');
            const request = store.getAll();

            request.onsuccess = function () {
                const staffMembers = request.result;

                const staffDropdowns = [
                    'id-card-person' // Assuming staff type
                ];

                staffDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    // This assumes id-card-person dropdown is dynamically populated based on type
                    // or needs options for all types. We'll skip populating it here directly
                    // and handle it based on id-card-type selection.
                });
            };
        }

        // Populate date range dropdowns (Years)
        function populateYearDropdowns() {
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 10; // 10 years back
            const endYear = currentYear + 5;    // 5 years forward

            const yearDropdowns = [
                'report-year', 'fr-year', 'sr-year', 'ar-year', 'salary-year'
            ];

            yearDropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    const currentValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">Select Year</option>'; // Keep the default option
                    for (let year = startYear; year <= endYear; year++) {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === currentYear) {
                            option.selected = true; // Default to current year
                        }
                        dropdown.appendChild(option);
                    }
                    if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                        dropdown.value = currentValue;
                    }
                }
            });
        }

        // Populate static data dropdowns (example: Surahs)
        function populateStaticDropdowns() {
            const surahDropdown = document.getElementById('hifz-surah');
            if (surahDropdown) {
                // Example Surah list - replace with a more comprehensive list
                const surahs = [
                    "Al-Fatihah", "Al-Baqarah", "Al 'Imran", "An-Nisa'", "Al-Ma'idah",
                    "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus"
                    // ... add more surahs
                ];
                const currentValue = surahDropdown.value;
                while (surahDropdown.options.length > 1) {
                    surahDropdown.remove(1);
                }
                surahs.forEach((surah, index) => {
                    const option = document.createElement('option');
                    option.value = surah; // Or use Surah number
                    option.textContent = `${index + 1}. ${surah}`;
                    surahDropdown.appendChild(option);
                });
                if (currentValue && Array.from(surahDropdown.options).some(opt => opt.value === currentValue)) {
                    surahDropdown.value = currentValue;
                }
            }

            // Populate expense categories
            const expenseCategoryDropdown = document.getElementById('expense-category');
            if (expenseCategoryDropdown) {
                const categories = ["Salaries", "Utilities", "Maintenance", "Stationery", "Rent", "Other"];
                const currentValue = expenseCategoryDropdown.value;
                while (expenseCategoryDropdown.options.length > 1) {
                    expenseCategoryDropdown.remove(1);
                }
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    expenseCategoryDropdown.appendChild(option);
                });
                if (currentValue && Array.from(expenseCategoryDropdown.options).some(opt => opt.value === currentValue)) {
                    expenseCategoryDropdown.value = currentValue;
                }
            }

            // Populate income categories
            const incomeCategoryDropdown = document.getElementById('income-category');
            if (incomeCategoryDropdown) {
                const categories = ["Fees", "Donation", "Grant", "Fundraising", "Other"];
                const currentValue = incomeCategoryDropdown.value;
                while (incomeCategoryDropdown.options.length > 1) {
                    incomeCategoryDropdown.remove(1);
                }
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    incomeCategoryDropdown.appendChild(option);
                });
                if (currentValue && Array.from(incomeCategoryDropdown.options).some(opt => opt.value === currentValue)) {
                    incomeCategoryDropdown.value = currentValue;
                }
            }
        }


        // Function to switch between main content sections
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId + '-section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
                // Update active sidebar link
                document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
                const activeLink = document.querySelector(`.sidebar-menu a[href="#${sectionId}"]`);
                if (activeLink) {
                    activeLink.parentElement.classList.add('active');
                    // Also expand parent submenu if any
                    let parentUl = activeLink.parentElement.closest('.submenu');
                    while (parentUl) {
                        parentUl.parentElement.classList.add('open');
                        parentUl = parentUl.parentElement.closest('.submenu');
                    }
                }
                // Update breadcrumbs (basic)
                const breadcrumb = document.querySelector('.main-content .breadcrumb');
                if (breadcrumb) {
                    const items = breadcrumb.querySelectorAll('li:not(:first-child)');
                    items.forEach(item => item.remove()); // Remove existing breadcrumbs except Home
                    let currentLink = activeLink;
                    const crumbs = [];
                    while (currentLink && currentLink.textContent.trim() !== 'Home') {
                        crumbs.unshift(currentLink.textContent.trim());
                        currentLink = currentLink.parentElement.closest('.submenu')?.previousElementSibling;
                    }
                    crumbs.forEach(crumbText => {
                        const li = document.createElement('li');
                        li.textContent = crumbText;
                        breadcrumb.appendChild(li);
                    });
                }
            }
        }

        // Function to handle tab switching within sections
        function setupTabs() {
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabContainer = this.parentElement;
                    const parentSection = tabContainer.closest('.content-section');
                    const tabId = this.getAttribute('data-tab');

                    tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    if (parentSection) {
                        parentSection.querySelectorAll('.tab-content').forEach(content => {
                            content.classList.remove('active');
                            content.style.display = 'none';
                        });
                    }
                    
                    const targetContent = document.getElementById(`${tabId}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        targetContent.style.display = 'block';
                        loadTabContent(tabId);
                    }
                });
            });

            document.querySelectorAll('.content-section').forEach(section => {
                const firstTab = section.querySelector('.tabs .tab');
                if (firstTab) {
                    firstTab.click();
                }
            });
        }
        
        // Function to load data when a tab becomes active
        function loadTabContent(tabId) {
            console.log('Loading content for tab:', tabId);
            switch (tabId) {
                case 'classes':
                    loadClasses(); // Already called in initApp, but good to re-call on tab switch if needed
                    break;
                case 'subjects':
                    loadSubjects(); // Already called in initApp
                    break;
                case 'assign-subjects':
                    // Load classes, subjects, and existing classSubjects data
                    populateClassDropdowns(); // Ensure dropdowns are populated
                    populateSubjectDropdowns(); // Ensure dropdowns are populated
                    loadClassSubjectAssignments(); // New function needed
                    break;
                case 'mark-attendance':
                    populateClassDropdowns();
                    // Attendance form logic handled by form submission
                    break;
                case 'attendance-reports':
                    populateClassDropdowns();
                    populateYearDropdowns();
                    // Report generation handled by form submission
                    break;
                case 'exam-schedule':
                    loadExams(); // Already called in initApp
                    break;
                case 'marks-entry':
                    populateExamDropdowns();
                    populateClassDropdowns();
                    populateSubjectDropdowns();
                    // Marks entry form logic handled by form submission
                    break;
                case 'report-cards':
                    populateExamDropdowns();
                    populateClassDropdowns();
                    populateStudentDropdowns();
                    // Report card generation handled by form submission
                    break;
                case 'fee-structure':
                    loadFeeTypes(); // Already called in initApp
                    loadClassFeeStructure(); // New function needed
                    break;
                case 'collect-fee':
                    populateStudentDropdowns();
                    populateClassDropdowns();
                    // Fee collection form logic handled by form submission (selecting student/class)
                    break;
                case 'fee-reports':
                    populateClassDropdowns();
                    populateFeeTypeDropdowns();
                    populateYearDropdowns();
                    // Report generation handled by form submission
                    break;
                case 'fee-defaulters':
                    populateClassDropdowns();
                    populateFeeTypeDropdowns();
                    // Report generation handled by form submission
                    break;
                case 'salary-structure':
                    loadSalaryStructure(); // New function needed
                    break;
                case 'process-salary':
                    populateTeacherDropdowns(); // Assuming teachers/staff for salary
                    populateStaffDropdowns(); // Assuming teachers/staff for salary
                    populateYearDropdowns();
                    // Salary process form logic handled by form submission
                    break;
                case 'salary-reports':
                    populateTeacherDropdowns();
                    populateStaffDropdowns();
                    populateYearDropdowns();
                    // Report generation handled by form submission
                    break;
                case 'expenses':
                    loadExpenses(); // New function needed
                    break;
                case 'income':
                    loadIncome(); // New function needed
                    break;
                case 'financial-reports':
                    populateStaticDropdowns(); // For expense/income categories
                    // Report generation handled by form submission
                    break;
                case 'books':
                    loadBooks(); // Already called in initApp
                    break;
                case 'book-issue':
                    populateBookDropdowns();
                    populateStudentDropdowns();
                    loadIssuedBooks(); // New function needed
                    break;
                case 'book-return':
                    populateBookDropdowns(); // Maybe only issued books? Needs refinement
                    populateStudentDropdowns();
                    break;
                case 'library-reports':
                    // Report generation handled by form submission
                    break;
                case 'hifz-tracking':
                    populateStudentDropdowns();
                    populateClassDropdowns(); // Hifz students might be linked to classes
                    populateTeacherDropdowns(); // Hifz teachers
                    loadHifzRecords(); // Already called in initApp
                    populateStaticDropdowns(); // Surah dropdown
                    break;
                case 'sabaq-sabaqi':
                    populateStudentDropdowns();
                    populateClassDropdowns(); // Sabaq students might be linked to classes
                    populateTeacherDropdowns(); // Sabaq teachers
                    loadSabaqRecords(); // Already called in initApp
                    break;
                case 'madrasa-reports':
                    populateStudentDropdowns();
                    populateClassDropdowns();
                    // Report generation handled by form submission
                    break;
                case 'student-reports':
                    populateClassDropdowns();
                    populateYearDropdowns(); // Admission dates might span years
                    // Report generation handled by form submission
                    break;
                // Note: Financial Reports tab in the Reports section might point to the same logic as in the Financial Management section
                case 'attendance-reports': // Duplicate case name from main attendance section - assuming this refers to the one in the Reports section
                    populateClassDropdowns();
                    populateYearDropdowns();
                    // Report generation handled by form submission
                    break;
                case 'financial-reports': // Duplicate case name - assuming this refers to the one in the Reports section
                    populateClassDropdowns();
                    populateStaticDropdowns(); // For categories
                    // Report generation handled by form submission
                    break;
                case 'id-cards':
                    setupIDCardGeneration(); // New function needed for type-based person dropdown
                    break;
                case 'certificates':
                    populateStudentDropdowns();
                    // Certificate generation handled by form submission
                    break;
                case 'institution':
                case 'academic':
                case 'fee':
                case 'system':
                case 'backup':
                    loadSettings(); // Load all settings when any settings tab is clicked
                    // Individual form handling done by form submit listeners
                    break;
                default:
                    console.warn('No specific loading logic for tab:', tabId);
                    break;
            }
        }


        // --- Placeholder/Basic Implementations for Complex Logic ---

        // Load and display Class-Subject Assignments
        function loadClassSubjectAssignments() {
            const form = document.getElementById('assign-subjects-form');
            const classSelect = document.getElementById('assign-class');
            const sectionSelect = document.getElementById('assign-section');
            const assignmentsDiv = document.getElementById('subject-assignments');

            assignmentsDiv.innerHTML = '<p>Select Class and Section to view/assign subjects.</p>';

            // Listen for class/section changes to load assignments
            classSelect.onchange = updateAssignSubjectForm;
            sectionSelect.onchange = updateAssignSubjectForm;

            async function updateAssignSubjectForm() {
                const classId = classSelect.value;
                const section = sectionSelect.value;

                if (!classId || !section) {
                    assignmentsDiv.innerHTML = '<p>Select Class and Section to view/assign subjects.</p>';
                    return;
                }

                assignmentsDiv.innerHTML = 'Loading...';

                const transaction = db.transaction(['classSubjects', 'subjects', 'teachers'], 'readonly');
                const classSubjectsStore = transaction.objectStore('classSubjects');
                const subjectsStore = transaction.objectStore('subjects');
                const teachersStore = transaction.objectStore('teachers');

                try {
                    const allSubjects = await getAllRecords(subjectsStore);
                    const allTeachers = await getAllRecords(teachersStore);
                    // Find existing assignments for this class and section
                    const existingAssignments = (await getAllRecords(classSubjectsStore)).filter(assignment =>
                        assignment.classId == classId && assignment.section === section
                    );

                    assignmentsDiv.innerHTML = ''; // Clear loading message

                    if (allSubjects.length === 0) {
                        assignmentsDiv.innerHTML = '<p>No subjects available to assign. Add subjects first.</p>';
                        return;
                    }

                    assignmentsDiv.innerHTML = '<h3>Assign Subjects for ' + classSelect.options[classSelect.selectedIndex].text + ' - ' + section + '</h3>';

                    allSubjects.forEach(subject => {
                        const assignment = existingAssignments.find(ea => ea.subjectId == subject.id);
                        const isAssigned = !!assignment;
                        const assignedTeacherId = assignment ? assignment.teacherId : '';

                        const subjectHtml = document.createElement('div');
                        subjectHtml.className = 'form-row align-items-center'; // Simple styling
                        subjectHtml.innerHTML = `
                           <div class="form-group" style="flex: 1;">
                                <input type="checkbox" id="assign-subject-${subject.id}" value="${subject.id}" ${isAssigned ? 'checked' : ''}>
                                <label for="assign-subject-${subject.id}">${subject.name} (${subject.code})</label>
                           </div>
                           <div class="form-group" style="flex: 1;">
                                <label for="assign-teacher-${subject.id}" class="text-muted">Teacher:</label>
                                <select id="assign-teacher-${subject.id}" class="form-select form-select-sm" ${!isAssigned ? 'disabled' : ''}>
                                     <option value="">Select Teacher</option>
                                     ${allTeachers.map(teacher =>
                            `<option value="${teacher.id}" ${assignedTeacherId == teacher.id ? 'selected' : ''}>${teacher.firstName} ${teacher.lastName}</option>`
                        ).join('')}
                                </select>
                           </div>
                      `;
                        assignmentsDiv.appendChild(subjectHtml);

                        // Enable/disable teacher dropdown based on checkbox
                        subjectHtml.querySelector(`#assign-subject-${subject.id}`).addEventListener('change', function () {
                            subjectHtml.querySelector(`#assign-teacher-${subject.id}`).disabled = !this.checked;
                            if (!this.checked) {
                                subjectHtml.querySelector(`#assign-teacher-${subject.id}`).value = ''; // Clear teacher when unassigned
                            }
                        });
                    });

                } catch (error) {
                    console.error("Error loading class subject assignments:", error);
                    assignmentsDiv.innerHTML = '<p>Error loading assignments.</p>';
                }
            }

            // Initially populate sections dropdown based on selected class
            document.getElementById('assign-class').addEventListener('change', function () {
                const classId = this.value;
                const sectionSelect = document.getElementById('assign-section');
                sectionSelect.innerHTML = '<option value="">Select Section</option>'; // Clear current options

                if (classId) {
                    const transaction = db.transaction(['classes'], 'readonly');
                    const store = transaction.objectStore('classes');
                    const request = store.get(parseInt(classId));
                    request.onsuccess = function () {
                        const cls = request.result;
                        if (cls && cls.sections) {
                            cls.sections.forEach(section => {
                                const option = document.createElement('option');
                                option.value = section;
                                option.textContent = section;
                                sectionSelect.appendChild(option);
                            });
                        }
                    };
                }
                updateAssignSubjectForm(); // Update form when class changes
            });
        }

        // Handle Assign Subjects Form Submission
        document.getElementById('assign-subjects-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const classId = document.getElementById('assign-class').value;
            const section = document.getElementById('assign-section').value;
            const assignmentsDiv = document.getElementById('subject-assignments');

            if (!classId || !section) {
                alert('Please select a Class and Section.');
                return;
            }

            const newAssignments = [];
            assignmentsDiv.querySelectorAll('.form-row input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const subjectId = parseInt(checkbox.value);
                    const teacherSelect = assignmentsDiv.querySelector(`#assign-teacher-${subjectId}`);
                    const teacherId = teacherSelect.value ? parseInt(teacherSelect.value) : null; // Allow no teacher

                    newAssignments.push({
                        classId: parseInt(classId),
                        section: section,
                        subjectId: subjectId,
                        teacherId: teacherId
                    });
                }
            });

            // Use a single transaction to clear old and add new assignments
            const transaction = db.transaction(['classSubjects'], 'readwrite');
            const store = transaction.objectStore('classSubjects');

            try {
                // Find and delete old assignments for this class and section
                const oldAssignments = (await getAllRecords(store)).filter(assignment =>
                    assignment.classId == classId && assignment.section === section
                );
                for (const assignment of oldAssignments) {
                    await new Promise((resolve, reject) => {
                        const req = store.delete(assignment.id);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }

                // Add the new assignments
                for (const assignment of newAssignments) {
                    await new Promise((resolve, reject) => {
                        const req = store.add(assignment);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }

                transaction.oncomplete = function () {
                    console.log("Class subject assignments saved successfully");
                    addActivity('system', 'Subject Assignments Updated', `Subjects assigned for Class ${classId}, Section ${section}`);
                    alert('Subject assignments saved!');
                    // Reload assignments view
                    loadClassSubjectAssignments();
                };

                transaction.onerror = function (event) {
                    console.error("Error saving class subject assignments:", event.target.error);
                    alert("Error saving assignments. Please try again.");
                };

            } catch (error) {
                console.error("Error during assignment transaction:", error);
                alert("Error saving assignments. Please try again.");
            }
        });


        // Load and display Class-Fee Structure
        function loadClassFeeStructure() {
            const tbody = document.getElementById('class-fee-structure-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

            const transaction = db.transaction(['classFees', 'classes', 'feeTypes'], 'readonly');
            const classFeesStore = transaction.objectStore('classFees');
            const classesStore = transaction.objectStore('classes');
            const feeTypesStore = transaction.objectStore('feeTypes');

            Promise.all([
                getAllRecords(classFeesStore),
                getAllRecords(classesStore),
                getAllRecords(feeTypesStore)
            ]).then(([classFees, classes, feeTypes]) => {
                tbody.innerHTML = '';
                if (classFees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No class fee assignments found.</td></tr>';
                    return;
                }

                classFees.forEach(assignment => {
                    const cls = classes.find(c => c.id === assignment.classId);
                    const feeType = feeTypes.find(ft => ft.id === assignment.feeTypeId);

                    if (cls && feeType) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                          <td>${cls.name || 'N/A'}</td>
                          <td>${feeType.name || 'N/A'}</td>
                          <td>$${assignment.amount || feeType.amount || '0'}</td>
                          <td>${assignment.dueDate || 'N/A'}</td>
                          <td>
                              <button class="btn btn-sm btn-danger delete-class-fee" data-id="${assignment.id}">
                                   <i class="fas fa-trash"></i>
                              </button>
                          </td>
                      `;
                        tbody.appendChild(tr);
                    }
                });

                // Add event listeners for delete buttons
                document.querySelectorAll('.delete-class-fee').forEach(button => {
                    button.addEventListener('click', function () {
                        const assignmentId = parseInt(this.getAttribute('data-id'));
                        deleteClassFeeAssignment(assignmentId);
                    });
                });

            }).catch(error => {
                console.error("Error loading class fee structure:", error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data.</td></tr>';
            });
        }

        // Delete Class Fee Assignment
        function deleteClassFeeAssignment(assignmentId) {
            if (confirm('Are you sure you want to remove this fee assignment from the class?')) {
                const transaction = db.transaction(['classFees'], 'readwrite');
                const store = transaction.objectStore('classFees');
                const request = store.delete(assignmentId);

                request.onsuccess = function () {
                    console.log("Class fee assignment deleted successfully");
                    loadClassFeeStructure(); // Reload the table
                    addActivity('fee', 'Fee Assignment Removed', `Fee assignment with ID ${assignmentId} was removed`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting class fee assignment:", event.target.error);
                    alert("Error deleting assignment.");
                };
            }
        }


        // Populate Assign Fee to Classes Modal form
        document.getElementById('assign-fee-btn').addEventListener('click', async function () {
            const classesStore = db.transaction(['classes'], 'readonly').objectStore('classes');
            const allClasses = await getAllRecords(classesStore);

            const assignmentsDiv = document.getElementById('class-fee-assignments');
            assignmentsDiv.innerHTML = ''; // Clear previous content

            if (allClasses.length === 0) {
                assignmentsDiv.innerHTML = '<p>No classes available. Add classes first.</p>';
                return;
            }

            assignmentsDiv.innerHTML = '<h3>Select Classes and Set Details</h3>';

            allClasses.forEach(cls => {
                const classAssignHtml = document.createElement('div');
                classAssignHtml.className = 'form-row align-items-center'; // Simple styling
                classAssignHtml.innerHTML = `
                 <div class="form-group" style="flex: 1.5;">
                      <input type="checkbox" id="assign-class-${cls.id}" value="${cls.id}">
                      <label for="assign-class-${cls.id}">${cls.name}</label>
                 </div>
                 <div class="form-group" style="flex: 1; margin-left: 15px;">
                      <label for="assign-fee-amount-${cls.id}" class="text-muted">Amount:</label>
                      <input type="number" id="assign-fee-amount-${cls.id}" class="form-control form-control-sm" placeholder="Default Amount" disabled>
                 </div>
                  <div class="form-group" style="flex: 1; margin-left: 15px;">
                      <label for="assign-fee-due-date-${cls.id}" class="text-muted">Due Date:</label>
                      <input type="date" id="assign-fee-due-date-${cls.id}" class="form-control form-control-sm" disabled>
                 </div>
            `;
                assignmentsDiv.appendChild(classAssignHtml);

                // Enable/disable inputs based on checkbox
                classAssignHtml.querySelector(`#assign-class-${cls.id}`).addEventListener('change', function () {
                    classAssignHtml.querySelector(`#assign-fee-amount-${cls.id}`).disabled = !this.checked;
                    classAssignHtml.querySelector(`#assign-fee-due-date-${cls.id}`).disabled = !this.checked;
                    if (!this.checked) {
                        classAssignHtml.querySelector(`#assign-fee-amount-${cls.id}`).value = '';
                        classAssignHtml.querySelector(`#assign-fee-due-date-${cls.id}`).value = '';
                    }
                });
            });

            // Open the modal after populating
            document.getElementById('assign-fee-modal').classList.add('show');
        });

        // Handle Assign Fee Form Submission
        document.getElementById('assign-fee-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const feeTypeId = document.getElementById('assign-fee-type').value;
            const assignmentsDiv = document.getElementById('class-fee-assignments');

            if (!feeTypeId) {
                alert('Please select a Fee Type.');
                return;
            }

            const assignmentsToSave = [];
            assignmentsDiv.querySelectorAll('.form-row input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    const classId = parseInt(checkbox.value);
                    const amountInput = assignmentsDiv.querySelector(`#assign-fee-amount-${classId}`);
                    const dueDateInput = assignmentsDiv.querySelector(`#assign-fee-due-date-${classId}`);

                    assignmentsToSave.push({
                        classId: classId,
                        feeTypeId: parseInt(feeTypeId),
                        amount: amountInput.value ? parseFloat(amountInput.value) : null, // Null allows using fee type's default amount
                        dueDate: dueDateInput.value || null
                    });
                }
            });

            if (assignmentsToSave.length === 0) {
                alert('Please select at least one class to assign the fee.');
                return;
            }

            // Use a single transaction
            const transaction = db.transaction(['classFees'], 'readwrite');
            const store = transaction.objectStore('classFees');

            try {
                // Check for existing assignments of this fee type to these classes and update/skip if needed
                const existingAssignments = await getAllRecords(store);
                const updates = [];
                const adds = [];

                assignmentsToSave.forEach(newAssignment => {
                    const existing = existingAssignments.find(ea =>
                        ea.classId === newAssignment.classId && ea.feeTypeId === newAssignment.feeTypeId
                    );
                    if (existing) {
                        // Decide whether to update or skip. For simplicity, let's update.
                        existing.amount = newAssignment.amount;
                        existing.dueDate = newAssignment.dueDate;
                        updates.push(existing);
                    } else {
                        adds.push(newAssignment);
                    }
                });

                // Perform updates
                for (const assignment of updates) {
                    await new Promise((resolve, reject) => {
                        const req = store.put(assignment);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }

                // Perform adds
                for (const assignment of adds) {
                    await new Promise((resolve, reject) => {
                        const req = store.add(assignment);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }


                transaction.oncomplete = function () {
                    console.log("Fee assignments saved successfully");
                    loadClassFeeStructure(); // Reload the table
                    addActivity('fee', 'Fee Assigned to Classes', `Fee type ${feeTypeId} assigned to ${assignmentsToSave.length} classes`);
                    alert('Fee assignments saved!');
                    document.getElementById('assign-fee-modal').classList.remove('show');
                };

                transaction.onerror = function (event) {
                    console.error("Error saving fee assignments:", event.target.error);
                    alert("Error saving assignments. Please try again.");
                };

            } catch (error) {
                console.error("Error during fee assignment transaction:", error);
                alert("Error saving assignments. Please try again.");
            }
        });

        // Load Employees for Salary Structure (Teachers and Staff combined)
        async function loadSalaryStructure() {
            const tbody = document.getElementById('salary-structure-table-body');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">Loading...</td></tr>';

            const transaction = db.transaction(['teachers', 'staff'], 'readonly');
            const teachersStore = transaction.objectStore('teachers');
            const staffStore = transaction.objectStore('staff');

            try {
                const teachers = await getAllRecords(teachersStore);
                const staff = await getAllRecords(staffStore);

                const employees = [
                    ...teachers.map(t => ({ ...t, type: 'Teacher', designation: 'Teacher' })),
                    ...staff.map(s => ({ ...s, type: 'Staff', designation: s.role }))
                ];

                tbody.innerHTML = '';
                if (employees.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No employees found.</td></tr>';
                    return;
                }

                employees.forEach(emp => {
                    // Basic salary, allowances, deductions will likely need a separate structure or be stored on the employee record
                    // For this example, we'll use basic salary from the record and show placeholders for others
                    const basicSalary = emp.salary || 0;
                    const allowances = 0; // Placeholder
                    const deductions = 0; // Placeholder
                    const netSalary = basicSalary + allowances - deductions;

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                     <td>${emp.id}</td>
                     <td><img src="${emp.photo || 'data:image/svg+xml;base64,...'}" alt="Photo" class="avatar"> ${emp.firstName} ${emp.lastName}</td>
                     <td>${emp.designation || 'N/A'}</td>
                     <td>$${basicSalary.toFixed(2)}</td>
                     <td>$${allowances.toFixed(2)}</td>
                     <td>$${deductions.toFixed(2)}</td>
                     <td>$${netSalary.toFixed(2)}</td>
                     <td>
                         <button class="btn btn-sm btn-primary edit-salary-structure" data-id="${emp.id}" data-type="${emp.type}">
                              <i class="fas fa-edit"></i>
                         </button>
                     </td>
                 `;
                    tbody.appendChild(tr);
                });

                // Add event listeners (Edit button functionality for salary structure not implemented here,
                // it would likely open a modal to edit employee's salary details)
                document.querySelectorAll('.edit-salary-structure').forEach(button => {
                    button.addEventListener('click', function () {
                        alert('Editing salary structure not implemented yet.');
                        // const empId = parseInt(this.getAttribute('data-id'));
                        // const empType = this.getAttribute('data-type');
                        // Open a modal/form to edit basic salary, allowances, deductions
                    });
                });


            } catch (error) {
                console.error("Error loading salary structure:", error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading data.</td></tr>';
            }
        }


        // Load Expenses
        function loadExpenses() {
            const tbody = document.getElementById('expenses-table-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

            const transaction = db.transaction(['expenses'], 'readonly');
            const store = transaction.objectStore('expenses');
            const request = store.getAll();

            request.onsuccess = function () {
                const expenses = request.result;
                tbody.innerHTML = '';
                if (expenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No expenses found.</td></tr>';
                    return;
                }

                expenses.forEach(expense => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                       <td>${expense.id}</td>
                       <td>${expense.date || 'N/A'}</td>
                       <td>${expense.category || 'N/A'}</td>
                       <td>$${(expense.amount || 0).toFixed(2)}</td>
                       <td>${expense.paymentMethod || 'N/A'}</td>
                       <td>${expense.description || 'N/A'}</td>
                       <td>
                           <div class="action-buttons">
                               <button class="btn btn-sm btn-primary edit-expense" data-id="${expense.id}">
                                   <i class="fas fa-edit"></i>
                               </button>
                               <button class="btn btn-sm btn-danger delete-expense" data-id="${expense.id}">
                                   <i class="fas fa-trash"></i>
                               </button>
                           </div>
                       </td>
                  `;
                    tbody.appendChild(tr);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-expense').forEach(button => {
                    button.addEventListener('click', function () {
                        const expenseId = parseInt(this.getAttribute('data-id'));
                        editExpense(expenseId);
                    });
                });

                document.querySelectorAll('.delete-expense').forEach(button => {
                    button.addEventListener('click', function () {
                        const expenseId = parseInt(this.getAttribute('data-id'));
                        deleteExpense(expenseId);
                    });
                });
            };

            request.onerror = function (event) {
                console.error("Error loading expenses:", event.target.error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data.</td></tr>';
            };
        }

        // Edit Expense
        function editExpense(expenseId) {
            const transaction = db.transaction(['expenses'], 'readonly');
            const store = transaction.objectStore('expenses');
            const request = store.get(expenseId);

            request.onsuccess = function () {
                const expense = request.result;
                if (expense) {
                    document.getElementById('expense-date').value = expense.date || '';
                    document.getElementById('expense-category').value = expense.category || '';
                    document.getElementById('expense-amount').value = expense.amount || '';
                    document.getElementById('expense-payment-method').value = expense.paymentMethod || '';
                    document.getElementById('expense-description').value = expense.description || '';
                    // Attachment handling is more complex, just clear file input for edit
                    document.getElementById('expense-attachment').value = '';


                    document.getElementById('expense-form').setAttribute('data-id', expenseId);
                    document.querySelector('#expense-modal .modal-title').textContent = 'Edit Expense';

                    document.getElementById('expense-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching expense:", event.target.error);
            };
        }

        // Delete Expense
        function deleteExpense(expenseId) {
            if (confirm('Are you sure you want to delete this expense record?')) {
                const transaction = db.transaction(['expenses'], 'readwrite');
                const store = transaction.objectStore('expenses');
                const request = store.delete(expenseId);

                request.onsuccess = function () {
                    console.log("Expense deleted successfully");
                    loadExpenses();
                    addActivity('financial', 'Expense Deleted', `Expense with ID ${expenseId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting expense:", event.target.error);
                };
            }
        }


        // Save Expense
        document.getElementById('expense-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const expenseId = this.getAttribute('data-id');
            const expenseData = {
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                paymentMethod: document.getElementById('expense-payment-method').value,
                description: document.getElementById('expense-description').value
                // attachment: ... handle file reader if saving attachments
            };

            const transaction = db.transaction(['expenses'], 'readwrite');
            const store = transaction.objectStore('expenses');

            let request;
            let action;

            if (expenseId) {
                expenseData.id = parseInt(expenseId);
                request = store.put(expenseData);
                action = 'updated';
            } else {
                request = store.add(expenseData);
                action = 'added';
            }

            request.onsuccess = function () {
                console.log(`Expense ${action} successfully`);
                loadExpenses();

                const activityTitle = expenseId ? 'Expense Updated' : 'New Expense Added';
                const activityDesc = expenseId ?
                    `Expense (ID: ${expenseData.id}) updated` :
                    `New expense added (Amount: $${expenseData.amount})`;

                addActivity('financial', activityTitle, activityDesc);

                document.getElementById('expense-modal').classList.remove('show');
            };

            request.onerror = function (event) {
                console.error(`Error ${action} expense:`, event.target.error);
                alert(`Error ${action} expense. Please try again.`);
            };
        });


        // Load Income
        function loadIncome() {
            const tbody = document.getElementById('income-table-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

            const transaction = db.transaction(['income'], 'readonly');
            const store = transaction.objectStore('income');
            const request = store.getAll();

            request.onsuccess = function () {
                const incomeRecords = request.result;
                tbody.innerHTML = '';
                if (incomeRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No income records found.</td></tr>';
                    return;
                }

                incomeRecords.forEach(income => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                       <td>${income.id}</td>
                       <td>${income.date || 'N/A'}</td>
                       <td>${income.category || 'N/A'}</td>
                       <td>$${(income.amount || 0).toFixed(2)}</td>
                       <td>${income.paymentMethod || 'N/A'}</td>
                       <td>${income.description || 'N/A'}</td>
                       <td>
                           <div class="action-buttons">
                               <button class="btn btn-sm btn-primary edit-income" data-id="${income.id}">
                                   <i class="fas fa-edit"></i>
                               </button>
                               <button class="btn btn-sm btn-danger delete-income" data-id="${income.id}">
                                   <i class="fas fa-trash"></i>
                               </button>
                           </div>
                       </td>
                  `;
                    tbody.appendChild(tr);
                });

                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-income').forEach(button => {
                    button.addEventListener('click', function () {
                        const incomeId = parseInt(this.getAttribute('data-id'));
                        editIncome(incomeId);
                    });
                });

                document.querySelectorAll('.delete-income').forEach(button => {
                    button.addEventListener('click', function () {
                        const incomeId = parseInt(this.getAttribute('data-id'));
                        deleteIncome(incomeId);
                    });
                });
            };

            request.onerror = function (event) {
                console.error("Error loading income:", event.target.error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data.</td></tr>';
            };
        }

        // Edit Income
        function editIncome(incomeId) {
            const transaction = db.transaction(['income'], 'readonly');
            const store = transaction.objectStore('income');
            const request = store.get(incomeId);

            request.onsuccess = function () {
                const income = request.result;
                if (income) {
                    document.getElementById('income-date').value = income.date || '';
                    document.getElementById('income-category').value = income.category || '';
                    document.getElementById('income-amount').value = income.amount || '';
                    document.getElementById('income-payment-method').value = income.paymentMethod || '';
                    document.getElementById('income-description').value = income.description || '';
                    // Attachment handling is more complex, just clear file input for edit
                    document.getElementById('income-attachment').value = '';

                    document.getElementById('income-form').setAttribute('data-id', incomeId);
                    document.querySelector('#income-modal .modal-title').textContent = 'Edit Income';

                    document.getElementById('income-modal').classList.add('show');
                }
            };

            request.onerror = function (event) {
                console.error("Error fetching income:", event.target.error);
            };
        }

        // Delete Income
        function deleteIncome(incomeId) {
            if (confirm('Are you sure you want to delete this income record?')) {
                const transaction = db.transaction(['income'], 'readwrite');
                const store = transaction.objectStore('income');
                const request = store.delete(incomeId);

                request.onsuccess = function () {
                    console.log("Income deleted successfully");
                    loadIncome();
                    addActivity('financial', 'Income Deleted', `Income record with ID ${incomeId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting income:", event.target.error);
                };
            }
        }

        // Save Income
        document.getElementById('income-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const incomeId = this.getAttribute('data-id');
            const incomeData = {
                date: document.getElementById('income-date').value,
                category: document.getElementById('income-category').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                paymentMethod: document.getElementById('income-payment-method').value,
                description: document.getElementById('income-description').value
                // attachment: ... handle file reader if saving attachments
            };

            const transaction = db.transaction(['income'], 'readwrite');
            const store = transaction.objectStore('income');

            let request;
            let action;

            if (incomeId) {
                incomeData.id = parseInt(incomeId);
                request = store.put(incomeData);
                action = 'updated';
            } else {
                request = store.add(incomeData);
                action = 'added';
            }

            request.onsuccess = function () {
                console.log(`Income ${action} successfully`);
                loadIncome();

                const activityTitle = incomeId ? 'Income Updated' : 'New Income Added';
                const activityDesc = incomeId ?
                    `Income (ID: ${incomeData.id}) updated` :
                    `New income added (Amount: $${incomeData.amount})`;

                addActivity('financial', activityTitle, activityDesc);

                document.getElementById('income-modal').classList.remove('show');
            };

            request.onerror = function (event) {
                console.error(`Error ${action} income:`, event.target.error);
                alert(`Error ${action} income. Please try again.`);
            };
        });


        // Load Issued Books
        function loadIssuedBooks() {
            const tbody = document.getElementById('issued-books-table-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

            const transaction = db.transaction(['bookIssues', 'books', 'students'], 'readonly');
            const issuesStore = transaction.objectStore('bookIssues');
            const booksStore = transaction.objectStore('books');
            const studentsStore = transaction.objectStore('students');

            Promise.all([
                getAllRecords(issuesStore),
                getAllRecords(booksStore),
                getAllRecords(studentsStore)
            ]).then(([issues, books, students]) => {
                tbody.innerHTML = '';
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date

                issues.forEach(issue => {
                    const book = books.find(b => b.id === issue.bookId);
                    const student = students.find(s => s.id === issue.studentId);
                    const dueDate = new Date(issue.dueDate);
                    dueDate.setHours(0, 0, 0, 0);
                    const status = issue.status || (dueDate < today ? 'Overdue' : 'Issued');
                    const statusClass = status === 'Returned' ? 'status-success' : (status === 'Overdue' ? 'status-danger' : 'status-warning');


                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                       <td>${issue.id}</td>
                       <td>${book ? book.title : 'Unknown Book'}</td>
                       <td>${student ? `${student.firstName} ${student.lastName}` : 'Unknown Student'}</td>
                       <td>${issue.issueDate || 'N/A'}</td>
                       <td>${issue.dueDate || 'N/A'}</td>
                       <td><span class="status-badge ${statusClass}">${status}</span></td>
                       <td>
                           <div class="action-buttons">
                               ${status !== 'Returned' ? `<button class="btn btn-sm btn-success mark-returned" data-id="${issue.id}">
                                   <i class="fas fa-undo"></i> Return
                               </button>` : ''}
                                <button class="btn btn-sm btn-danger delete-issue" data-id="${issue.id}">
                                   <i class="fas fa-trash"></i>
                               </button>
                           </div>
                       </td>
                  `;
                    tbody.appendChild(tr);
                });

                // Add event listeners for return and delete buttons
                document.querySelectorAll('.mark-returned').forEach(button => {
                    button.addEventListener('click', function () {
                        const issueId = parseInt(this.getAttribute('data-id'));
                        markBookReturned(issueId);
                    });
                });
                document.querySelectorAll('.delete-issue').forEach(button => {
                    button.addEventListener('click', function () {
                        const issueId = parseInt(this.getAttribute('data-id'));
                        deleteBookIssue(issueId);
                    });
                });

            }).catch(error => {
                console.error("Error loading issued books:", error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data.</td></tr>';
            });
        }

        // Save Book Issue
        document.getElementById('book-issue-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const issueData = {
                bookId: parseInt(document.getElementById('issue-book').value),
                studentId: parseInt(document.getElementById('issue-student').value),
                issueDate: document.getElementById('issue-date').value,
                dueDate: document.getElementById('due-date').value,
                remarks: document.getElementById('issue-remarks').value,
                status: 'Issued'
            };

            if (!issueData.bookId || !issueData.studentId || !issueData.issueDate || !issueData.dueDate) {
                alert('Please fill in all required fields.');
                return;
            }

            const transaction = db.transaction(['bookIssues', 'books'], 'readwrite');
            const issuesStore = transaction.objectStore('bookIssues');
            const booksStore = transaction.objectStore('books');

            try {
                // Check book availability
                const book = await getRecord(booksStore, issueData.bookId);
                if (!book || (book.availableCopies || 0) <= 0) {
                    alert('Book is not available for issue.');
                    return;
                }

                // Add issue record
                const addIssueRequest = issuesStore.add(issueData);

                addIssueRequest.onsuccess = async function () {
                    console.log('Book issue added successfully');

                    // Decrease available copies
                    book.availableCopies = (book.availableCopies || 0) - 1;
                    await new Promise((resolve, reject) => {
                        const updateBookReq = booksStore.put(book);
                        updateBookReq.onsuccess = resolve;
                        updateBookReq.onerror = reject;
                    });

                    transaction.oncomplete = function () {
                        console.log("Issue transaction complete");
                        loadIssuedBooks(); // Reload issued books table
                        loadBooks(); // Reload books table to update available count
                        addActivity('library', 'Book Issued', `Book "${book.title}" issued to student ${issueData.studentId}`);
                        alert('Book issued successfully!');
                        document.getElementById('book-issue-form').reset();
                    };

                    transaction.onerror = function (event) {
                        console.error("Error during book issue transaction:", event.target.error);
                        alert("Error issuing book. Please try again.");
                    };
                };

                addIssueRequest.onerror = function (event) {
                    console.error("Error adding book issue:", event.target.error);
                    alert("Error issuing book. Please try again.");
                    transaction.abort(); // Abort the transaction
                };


            } catch (error) {
                console.error("Error during book issue process:", error);
                alert("Error issuing book. Please try again.");
            }
        });

        // Mark Book as Returned
        async function markBookReturned(issueId) {
            if (confirm('Mark this book as returned?')) {
                const transaction = db.transaction(['bookIssues', 'books'], 'readwrite');
                const issuesStore = transaction.objectStore('bookIssues');
                const booksStore = transaction.objectStore('books');

                try {
                    // Get issue record
                    const issue = await getRecord(issuesStore, issueId);
                    if (!issue || issue.status === 'Returned') {
                        alert('Issue record not found or already returned.');
                        return;
                    }

                    // Update issue status and add return date (today)
                    issue.status = 'Returned';
                    issue.returnDate = new Date().toISOString().split('T')[0]; // Set return date to today
                    // Calculate fine if overdue (simplified)
                    const dueDate = new Date(issue.dueDate);
                    const returnDate = new Date(issue.returnDate);
                    let fine = 0;
                    if (returnDate > dueDate) {
                        const diffTime = Math.abs(returnDate - dueDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        const feeSettings = (await getRecord(db.transaction('settings', 'readonly').objectStore('settings'), 'fee'))?.value || {};
                        const fineRate = feeSettings.fineRate || 0.1; // Default fine rate if setting not found
                        fine = diffDays * fineRate;
                        alert(`Book returned late! Fine calculated: $${fine.toFixed(2)}`);
                        // Note: Fine collection is not automatically handled here.
                        // A real system would link this to fee collection.
                    }
                    issue.fine = fine; // Store calculated fine

                    await new Promise((resolve, reject) => {
                        const updateIssueReq = issuesStore.put(issue);
                        updateIssueReq.onsuccess = resolve;
                        updateIssueReq.onerror = reject;
                    });


                    // Increase available copies of the book
                    const book = await getRecord(booksStore, issue.bookId);
                    if (book) {
                        book.availableCopies = (book.availableCopies || 0) + 1;
                        await new Promise((resolve, reject) => {
                            const updateBookReq = booksStore.put(book);
                            updateBookReq.onsuccess = resolve;
                            updateBookReq.onerror = reject;
                        });
                    }


                    transaction.oncomplete = function () {
                        console.log("Book return transaction complete");
                        loadIssuedBooks(); // Reload issued books table
                        loadBooks(); // Reload books table
                        addActivity('library', 'Book Returned', `Book "${book ? book.title : 'Unknown'}" returned by student ${issue.studentId}`);
                        alert('Book returned successfully!');
                    };

                    transaction.onerror = function (event) {
                        console.error("Error during book return transaction:", event.target.error);
                        alert("Error marking book as returned. Please try again.");
                        transaction.abort();
                    };


                } catch (error) {
                    console.error("Error marking book as returned:", error);
                    alert("Error marking book as returned. Please try again.");
                }
            }
        }

        // Delete Book Issue
        function deleteBookIssue(issueId) {
            if (confirm('Are you sure you want to delete this book issue record? This does NOT affect book counts.')) {
                const transaction = db.transaction(['bookIssues'], 'readwrite');
                const store = transaction.objectStore('bookIssues');
                const request = store.delete(issueId);

                request.onsuccess = function () {
                    console.log("Book issue deleted successfully");
                    loadIssuedBooks(); // Reload the table
                    addActivity('library', 'Book Issue Deleted', `Book issue record with ID ${issueId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting book issue:", event.target.error);
                };
            }
        }

        // Handle Book Return Form Submission (basic search/lookup placeholder)
        document.getElementById('book-return-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            // This form is designed for lookup then return.
            // For this example, we'll just simulate finding an issue by ID
            // and then marking it as returned. A real system would load details first.

            const issueId = parseInt(document.getElementById('return-issue-id').value);
            if (issueId) {
                markBookReturned(issueId); // Re-use the return logic
                document.getElementById('book-return-form').reset(); // Clear form after attempt
            } else {
                alert('Please enter an Issue ID.');
            }
        });


        // Setup ID Card Generation form (Populate Person dropdown based on Type)
        function setupIDCardGeneration() {
            const typeSelect = document.getElementById('id-card-type');
            const personSelect = document.getElementById('id-card-person');
            const previewDiv = document.getElementById('id-card-preview');
            const contentDiv = document.getElementById('id-card-content');
            const generateBtn = document.querySelector('#id-cards-tab .form-actions button[type="submit"]');
            const printBtn = document.getElementById('print-id-card-btn');

            personSelect.innerHTML = '<option value="">Select Person</option>';
            previewDiv.style.display = 'none';

            typeSelect.addEventListener('change', async function () {
                const type = this.value;
                personSelect.innerHTML = '<option value="">Select Person</option>';
                personSelect.disabled = true;
                generateBtn.disabled = true;
                previewDiv.style.display = 'none';
                contentDiv.innerHTML = '';

                if (!type) return;

                let storeName = '';
                if (type === 'student') storeName = 'students';
                else if (type === 'teacher') storeName = 'teachers';
                else if (type === 'staff') storeName = 'staff';

                if (storeName) {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const records = await getAllRecords(store);

                    records.forEach(record => {
                        const option = document.createElement('option');
                        option.value = record.id;
                        const name = record.firstName && record.lastName ? `${record.firstName} ${record.lastName}` : record.name || 'Unknown';
                        const identifier = record.admissionNumber || record.id;
                        option.textContent = `${name} (ID: ${identifier})`;
                        personSelect.appendChild(option);
                    });
                    personSelect.disabled = false;
                }
            });

            personSelect.addEventListener('change', function () {
                generateBtn.disabled = !this.value;
                previewDiv.style.display = 'none';
                contentDiv.innerHTML = '';
            });

            // Handle Generate ID Card Form Submission
            document.getElementById('id-card-filter-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                const type = typeSelect.value;
                const personId = parseInt(personSelect.value);

                if (!type || !personId) return;

                let storeName = '';
                let person = null;
                if (type === 'student') storeName = 'students';
                else if (type === 'teacher') storeName = 'teachers';
                else if (type === 'staff') storeName = 'staff';

                if (storeName) {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    person = await getRecord(store, personId);
                }

                if (person) {
                    // Generate simple ID card HTML
                    contentDiv.innerHTML = generateIDCardHTML(type, person);
                    previewDiv.style.display = 'block';
                    printBtn.disabled = false;
                } else {
                    contentDiv.innerHTML = '<p class="text-danger text-center">Person not found.</p>';
                    previewDiv.style.display = 'block';
                    printBtn.disabled = true;
                }
            });

            // Print ID Card
            printBtn.addEventListener('click', function () {
                const printContent = document.getElementById('id-card-content').innerHTML;
                const originalContent = document.body.innerHTML;
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalContent; // Restore content (simple but effective)
                window.location.reload(); // Hard refresh to fully restore state
            });
        }

        // Helper to generate simple ID card HTML
        function generateIDCardHTML(type, person) {
            const photo = person.photo || 'data:image/svg+xml;base64,...'; // Use placeholder
            const name = person.firstName && person.lastName ? `${person.firstName} ${person.lastName}` : person.name || 'N/A';
            const idLabel = type === 'student' ? 'Admission No.' : 'Employee ID';
            const idValue = person.admissionNumber || person.id || 'N/A';
            const roleLabel = type === 'student' ? 'Class/Section' : 'Role';
            const roleValue = type === 'student' ? `${person.class || 'N/A'}/${person.section || 'N/A'}` : person.role || 'N/A';
            const contactLabel = type === 'student' ? 'Father\'s Phone' : 'Phone';
            const contactValue = type === 'student' ? person.fatherPhone || 'N/A' : person.phone || 'N/A';

            return `
               <div style="width: 300px; border: 1px solid #ccc; border-radius: 8px; padding: 15px; font-family: sans-serif; text-align: center; box-shadow: 2px 2px 10px rgba(0,0,0,0.1);">
                   <h4 style="margin: 0 0 10px 0; color: var(--dark-color);">Institution Name Here</h4>
                   <img src="${photo}" alt="Photo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--primary-color);">
                   <h3 style="margin: 5px 0; color: var(--primary-color);">${name}</h3>
                   <p style="margin: 3px 0; font-size: 0.9em; color: #555;">${type.charAt(0).toUpperCase() + type.slice(1)}</p>
                   <hr style="border: none; border-top: 1px dashed #eee; margin: 10px 0;">
                   <p style="margin: 5px 0; font-size: 0.8em; color: #333;"><strong class="text-muted">${idLabel}:</strong> ${idValue}</p>
                   <p style="margin: 5px 0; font-size: 0.8em; color: #333;"><strong class="text-muted">${roleLabel}:</strong> ${roleValue}</p>
                   <p style="margin: 5px 0; font-size: 0.8em; color: #333;"><strong class="text-muted">${contactLabel}:</strong> ${contactValue}</p>
                   <div class="qr-code" style="width: 80px; height: 80px; font-size: 0.7em; margin-top: 15px; border: 1px dashed #ccc;">QR Code Placeholder</div>
               </div>
          `;
        }

        // Handle Certificate Generation Form Submission (basic placeholder)
        document.getElementById('certificate-filter-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            const certificateType = document.getElementById('certificate-type').value;
            const studentId = parseInt(document.getElementById('certificate-student').value);
            const previewDiv = document.getElementById('certificate-preview');
            const contentDiv = document.getElementById('certificate-content');
            const printBtn = document.getElementById('print-certificate-btn');

            if (!certificateType || !studentId) {
                contentDiv.innerHTML = '<p class="text-danger text-center">Please select a certificate type and a student.</p>';
                previewDiv.style.display = 'block';
                printBtn.disabled = true;
                return;
            }

            const transaction = db.transaction(['students', 'settings'], 'readonly');
            const studentsStore = transaction.objectStore('students');
            const settingsStore = transaction.objectStore('settings');

            try {
                const student = await getRecord(studentsStore, studentId);
                const institutionSettings = (await getRecord(settingsStore, 'institution'))?.value || {};

                if (student) {
                    // Generate simple Certificate HTML
                    contentDiv.innerHTML = generateCertificateHTML(certificateType, student, institutionSettings);
                    previewDiv.style.display = 'block';
                    printBtn.disabled = false;
                } else {
                    contentDiv.innerHTML = '<p class="text-danger text-center">Student not found.</p>';
                    previewDiv.style.display = 'block';
                    printBtn.disabled = true;
                }
            } catch (error) {
                console.error("Error generating certificate:", error);
                contentDiv.innerHTML = '<p class="text-danger text-center">Error generating certificate.</p>';
                previewDiv.style.display = 'block';
                printBtn.disabled = true;
            }
        });

        // Helper to generate simple Certificate HTML
        function generateCertificateHTML(type, student, institution) {
            const certTitle = type.replace(/-/g, ' ').toUpperCase() + ' CERTIFICATE';
            const studentName = `${student.firstName} ${student.lastName}`;
            const institutionName = institution.name || 'Your Institution Name';
            const issueDate = new Date().toISOString().split('T')[0];

            let certificateText = '';
            switch (type) {
                case 'bonafide':
                    certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, is a bonafide student of this institution, currently enrolled in Class <strong>${student.class || 'N/A'}</strong>, Section <strong>${student.section || 'N/A'}</strong>. His/Her Admission Number is ${student.admissionNumber || 'N/A'}.`;
                    break;
                case 'transfer':
                    certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, was a student of this institution from ${student.admissionDate || 'N/A'} to ${issueDate}. He/She was last enrolled in Class <strong>${student.class || 'N/A'}</strong>, Section <strong>${student.section || 'N/A'}</strong>. He/She bears a good moral character.`;
                    break;
                case 'character':
                    certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, has been a student of this institution. During his/her stay, his/her character has been found to be <strong>satisfactory/good/excellent</strong>.`; // Add a field for character assessment in student data
                    break;
                case 'hifz-completion':
                    certificateText = `This is to certify that Mr./Ms. <strong>${studentName}</strong>, son/daughter of Mr. ${student.fatherName || 'N/A'}, has successfully completed the memorization (Hifz) of the Holy Quran in this institution.`; // Requires checking Hifz records
                    break;
                default:
                    certificateText = `Certificate for ${studentName}. Type: ${certTitle}.`;
            }


            return `
              <div style="width: 800px; margin: 20px auto; padding: 40px; border: 2px solid #000; font-family: serif; text-align: center; background: #fff; position: relative;">
                  <img src="${institution.logo || 'data:image/svg+xml;base64,...'}" alt="Logo" style="position: absolute; top: 30px; left: 30px; height: 80px;">
                   <h1 style="color: var(--dark-color); margin-bottom: 10px;">${institutionName}</h1>
                   <h2 style="color: var(--primary-color); margin-bottom: 30px; text-decoration: underline;">${certTitle}</h2>

                   <div style="font-size: 1.1em; line-height: 1.6; text-align: justify; margin: 0 50px 40px 50px;">
                       ${certificateText}
                   </div>

                   <div style="display: flex; justify-content: space-between; margin-top: 50px;">
                       <div style="width: 200px; border-top: 1px solid #000; padding-top: 5px; text-align: center;">
                           Student Signature
                       </div>
                        <div style="width: 200px; text-align: center;">
                           <p style="margin-bottom: 5px;">Date: ${issueDate}</p>
                           <div style="border-top: 1px solid #000; padding-top: 5px;">
                               Principal Signature
                           </div>
                       </div>
                   </div>
               </div>
          `;
        }

        // Print Certificate
        document.getElementById('print-certificate-btn').addEventListener('click', function () {
            const printContent = document.getElementById('certificate-content').innerHTML;
            const originalContent = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = originalContent; // Restore content
            window.location.reload(); // Hard refresh
        });


        // --- Backup/Restore/Reset Logic ---

        // Backup Data
        async function backupData() {
            try {
                const transaction = db.transaction(db.objectStoreNames, 'readonly');
                const backup = {};

                for (const storeName of db.objectStoreNames) {
                    const store = transaction.objectStore(storeName);
                    backup[storeName] = await getAllRecords(store);
                }

                transaction.oncomplete = function () {
                    const jsonString = JSON.stringify(backup, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `sms_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a); // Append to body is needed for Firefox
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    console.log("Backup created successfully");
                    addActivity('system', 'Data Backup', 'System data was backed up');
                    alert('Data backup created successfully!');
                };

                transaction.onerror = function (event) {
                    console.error("Error during backup transaction:", event.target.error);
                    alert('Error creating backup.');
                };


            } catch (error) {
                console.error("Error creating backup:", error);
                alert('Error creating backup.');
            }
        }

        // Restore Data
        function restoreData(file) {
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    if (confirm('WARNING: Restoring data will erase all current data and replace it with the backup. Are you sure?')) {
                        const transaction = db.transaction(db.objectStoreNames, 'readwrite');

                        // Clear existing data in all stores
                        for (const storeName of db.objectStoreNames) {
                            if (transaction.objectStoreNames.contains(storeName)) { // Check if store exists in transaction scope
                                await new Promise((resolve, reject) => {
                                    const clearRequest = transaction.objectStore(storeName).clear();
                                    clearRequest.onsuccess = resolve;
                                    clearRequest.onerror = reject;
                                });
                            }
                        }

                        // Add data from backup
                        for (const storeName in backupData) {
                            if (db.objectStoreNames.contains(storeName) && Array.isArray(backupData[storeName])) {
                                const store = transaction.objectStore(storeName);
                                for (const item of backupData[storeName]) {
                                    // IndexedDB auto-increments keys. If the backup includes keys,
                                    // using store.add() might fail if keys conflict or if keyPath is autoIncrement.
                                    // For simplicity with autoIncrement, we let IndexedDB assign new keys on restore.
                                    // If keys must be preserved, a different strategy is needed (e.g., deleting/recreating store, or using put if keyPath is not autoIncrement).
                                    // Assuming autoIncrement, we'll remove the key before adding.
                                    if (store.autoIncrement && item.hasOwnProperty(store.keyPath)) {
                                        delete item[store.keyPath];
                                    }
                                    await new Promise((resolve, reject) => {
                                        const addRequest = store.add(item);
                                        addRequest.onsuccess = resolve;
                                        addRequest.onerror = reject; // Handle errors (e.g., unique constraint)
                                    });
                                }
                            }
                        }

                        transaction.oncomplete = function () {
                            console.log("Data restored successfully");
                            addActivity('system', 'Data Restore', 'System data was restored from backup');
                            alert('Data restored successfully! Please refresh the page.');
                            // A full reload might be necessary for all UI components to reflect new data
                            // window.location.reload(); // Consider doing this after successful restore
                        };

                        transaction.onerror = function (event) {
                            console.error("Error during restore transaction:", event.target.error);
                            alert('Error restoring data. Some data might be inconsistent.');
                        };
                    }
                } catch (error) {
                    console.error("Error processing restore file:", error);
                    alert('Invalid backup file or data format.');
                }
            };
            reader.readAsText(file);
        }

        // Reset Data
        function resetData() {
            if (confirm('This action cannot be undone. Are you absolutely sure you want to delete ALL system data?')) {
                const transaction = db.transaction(db.objectStoreNames, 'readwrite');

                Promise.all(Array.from(db.objectStoreNames).map(storeName => {
                    return new Promise((resolve, reject) => {
                        if (transaction.objectStoreNames.contains(storeName)) { // Check if store exists in transaction scope
                            const request = transaction.objectStore(storeName).clear();
                            request.onsuccess = resolve;
                            request.onerror = reject;
                        } else {
                            resolve(); // Store not in this transaction, skip
                        }
                    });
                })).then(() => {
                    transaction.oncomplete = function () {
                        console.log("All data reset successfully");
                        addActivity('system', 'Data Reset', 'All system data was reset');
                        alert('All data has been deleted. The system is reset.');
                        // Reload the application state
                        initApp();
                        // window.location.reload(); // Consider a full reload
                    };
                    transaction.onerror = function (event) {
                        console.error("Error during reset transaction:", event.target.error);
                        alert('Error resetting data.');
                    };
                }).catch(error => {
                    console.error("Error clearing stores during reset:", error);
                    alert('Error resetting data.');
                });
            }
        }


        // --- Generic Report Generation Logic (Placeholder) ---
        // This is a simplified function. Real reports require fetching specific data,
        // filtering it based on form inputs, and generating detailed HTML or other formats.
        function generateReport(formId, reportContainerId, title) {
            const form = document.getElementById(formId);
            const container = document.getElementById(reportContainerId);
            const contentDiv = container.querySelector('div:last-child'); // Assuming the last div is content
            const titleElement = container.querySelector('.table-title');

            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Collect filter values (example)
                const filters = {};
                Array.from(form.elements).forEach(input => {
                    if (input.name && input.value) {
                        filters[input.name] = input.value;
                    }
                });

                console.log(`Generating report for ${title} with filters:`, filters);
                contentDiv.innerHTML = '<p class="text-center">Generating report...</p>';
                container.style.display = 'block';
                titleElement.textContent = title;

                // --- Replace with actual data fetching and processing based on filters ---
                let data = [];
                let columns = [];
                try {
                    // Example: Fetch all students if student report form is used
                    if (formId === 'student-report-filter-form') {
                        const studentsStore = db.transaction('students', 'readonly').objectStore('students');
                        data = await getAllRecords(studentsStore);
                        // Apply filtering based on `filters` object
                        if (filters['sr-class']) data = data.filter(s => s.class == filters['sr-class']);
                        if (filters['sr-section']) data = data.filter(s => s.section == filters['sr-section']);
                        // Date filters for admission date, etc.

                        columns = ['id', 'firstName', 'lastName', 'class', 'section', 'fatherName', 'admissionDate']; // Example columns
                    }
                    // Add cases for other report types (attendance, financial, library, madrasa)
                    else if (formId === 'attendance-report-filter-form') {
                        // Fetch attendance records, potentially join with students/classes
                        const attendanceStore = db.transaction('attendance', 'readonly').objectStore('attendance');
                        data = await getAllRecords(attendanceStore);
                        // Apply filters (date, month, year, class, section, student)
                        // Join with student names for display
                        columns = ['date', 'studentName', 'status', 'remarks']; // Example columns
                    }
                    else if (formId === 'financial-report-filter-form') {
                        // Fetch income/expense records
                        const tx = db.transaction(['income', 'expenses'], 'readonly');
                        const incomeStore = tx.objectStore('income');
                        const expenseStore = tx.objectStore('expenses');
                        const incomeData = await getAllRecords(incomeStore);
                        const expenseData = await getAllRecords(expenseStore);

                        data = [];
                        if (filters['fr-type'] !== 'expense') data = [...data, ...incomeData.map(d => ({ ...d, type: 'Income' }))];
                        if (filters['fr-type'] !== 'income') data = [...data, ...expenseData.map(d => ({ ...d, type: 'Expense' }))];

                        // Apply filters (category, date range)
                        // Sort by date
                        data.sort((a, b) => new Date(a.date) - new Date(b.date));

                        columns = ['date', 'type', 'category', 'amount', 'description']; // Example columns
                        // Calculate totals for summary reports
                    }
                    // Add more report types...

                } catch (error) {
                    console.error("Error fetching data for report:", error);
                    contentDiv.innerHTML = '<p class="text-danger text-center">Error fetching report data.</p>';
                    return;
                }


                // --- Render data as a table ---
                if (data.length === 0) {
                    contentDiv.innerHTML = '<p class="text-center">No data found for the selected filters.</p>';
                } else {
                    let tableHtml = '<table><thead><tr>';
                    columns.forEach(col => {
                        // Basic column name formatting
                        const colName = col.replace(/([A-Z])/g, ' $1').trim().replace(/^./, str => str.toUpperCase());
                        tableHtml += `<th>${colName}</th>`;
                    });
                    tableHtml += '</tr></thead><tbody>';

                    data.forEach(item => {
                        tableHtml += '<tr>';
                        columns.forEach(col => {
                            let value = item[col] !== undefined ? item[col] : 'N/A';
                            if (col === 'amount' && typeof value === 'number') value = '$' + value.toFixed(2);
                            if (col === 'photo' && value) value = `<img src="${value}" class="avatar" style="width:30px; height:30px;">`; // Example for photo
                            if (Array.isArray(value)) value = value.join(', '); // Handle arrays like subjects
                            tableHtml += `<td>${value}</td>`;
                        });
                        tableHtml += '</tr>';
                    });

                    tableHtml += '</tbody></table>';
                    contentDiv.innerHTML = tableHtml;

                    // Add summary info for financial reports
                    if (formId === 'financial-report-filter-form' && filters['fr-report-type'] === 'summary') {
                        const totalIncome = incomeData.reduce((sum, item) => sum + item.amount, 0);
                        const totalExpense = expenseData.reduce((sum, item) => sum + item.amount, 0);
                        const balance = totalIncome - totalExpense;
                        contentDiv.innerHTML += `
                             <div class="d-flex justify-content-between mt-20" style="font-weight: bold;">
                                  <span>Total Income: $${totalIncome.toFixed(2)}</span>
                                   <span>Total Expenses: $${totalExpense.toFixed(2)}</span>
                                   <span>Balance: $${balance.toFixed(2)}</span>
                              </div>
                        `;
                    }
                }
            });
        }


        // --- Backup/Restore/Reset event listeners (already added in setupEventListeners, but ensure IDs match) ---
        // document.getElementById('backup-data-btn').addEventListener('click', backupData);
        // document.getElementById('restore-data').addEventListener('change', ...);
        // document.getElementById('restore-data-btn').addEventListener('click', ...);
        // document.getElementById('reset-data-btn').addEventListener('click', ...);

function populateSectionDropdown(classDropdown) {
    // Correctly finds IDs like "attendance-section-select"
    const sectionDropdownId = classDropdown.id.replace('-class', '-section-select');
    const sectionDropdown = document.getElementById(sectionDropdownId);

    if (!sectionDropdown) {
        // This fallback handles other forms that use the simple "...-section" ID
        const fallbackId = classDropdown.id.replace('-class', '-section');
        const fallbackDropdown = document.getElementById(fallbackId);
        if(fallbackDropdown) {
            fallbackDropdown.innerHTML = '<option value="">Select Section</option>';
             // In a real scenario, you'd populate this too, but for the reported bug this is enough to prevent errors.
        }
        return; 
    }

    const selectedClassId = classDropdown.value;
    sectionDropdown.innerHTML = '<option value="">Select Section</option>';

    if (!selectedClassId) {
        return;
    }

    const transaction = db.transaction(['classes'], 'readonly');
    const store = transaction.objectStore('classes');
    const request = store.get(parseInt(selectedClassId));

    request.onsuccess = function () {
        const cls = request.result;
        if (cls && cls.sections && Array.isArray(cls.sections)) {
            cls.sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section;
                sectionDropdown.appendChild(option);
            });
        }
    };
    request.onerror = (e) => console.error("Error fetching class sections:", e.target.error);
}    // Setup event listeners
        function setupEventListeners() {
            // Universal handler to populate any section dropdown when its class dropdown changes
document.querySelectorAll('[id$="-class"]').forEach(classDropdown => {
    classDropdown.addEventListener('change', function () {
        populateSectionDropdown(this);
    });
});

        // Settings Form Submissions
        document.getElementById('institution-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('institution-name').value,
                phone: document.getElementById('institution-phone').value,
                email: document.getElementById('institution-email').value,
                address: document.getElementById('institution-address').value,
            };
            saveSettings('institution', data);
        });

        document.getElementById('academic-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                year: document.getElementById('academic-year').value,
                session: document.getElementById('academic-session').value,
                startDate: document.getElementById('academic-start-date').value,
                endDate: document.getElementById('academic-end-date').value,
            };
            saveSettings('academic', data);
        });

        document.getElementById('fee-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                currency: document.getElementById('fee-currency').value,
                fineRate: parseFloat(document.getElementById('fee-fine-rate').value),
            };
            saveSettings('fee', data);
        });

        document.getElementById('system-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                language: document.getElementById('system-language').value,
                theme: document.getElementById('system-theme').value,
                timezone: document.getElementById('system-timezone').value,
            };
            saveSettings('system', data);
        });
            // --- Section Switching ---
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.addEventListener('click', function (e) {
                    // Handle submenu toggle if applicable
                    const parentLi = this.parentElement;
                    if (parentLi.classList.contains('has-submenu')) {
                        e.preventDefault(); // Prevent immediate navigation if it has a submenu
                        parentLi.classList.toggle('open');
                        // Don't show section yet, let the user click a submenu item
                        return;
                    }

                    e.preventDefault(); // Prevent default hash link behavior for main sections
                    const sectionId = this.getAttribute('href').substring(1); // Get section ID from href
                    showSection(sectionId);

                    // Close mobile sidebar after clicking a link
                    document.querySelector('.sidebar').classList.remove('show');
                });
            });
        // --- COMPLETE SAVE FUNCTIONALITY FOR ALL MODULES ---

        // Student Form Submission
        document.getElementById('student-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const studentData = {
                firstName: document.getElementById('student-first-name').value,
                lastName: document.getElementById('student-last-name').value,
                gender: document.getElementById('student-gender').value,
                dob: document.getElementById('student-dob').value,
                class: document.getElementById('student-class').value,
                section: document.getElementById('student-section').value,
                admissionDate: document.getElementById('student-admission-date').value,
                admissionNumber: document.getElementById('student-admission-number').value,
                address: document.getElementById('student-address').value,
                fatherName: document.getElementById('student-father-name').value,
                fatherPhone: document.getElementById('student-father-phone').value,
                motherName: document.getElementById('student-mother-name').value,
                motherPhone: document.getElementById('student-mother-phone').value,
            };
            saveStudent(id ? parseInt(id) : null, studentData);
        });

        function saveStudent(id, data) {
            const transaction = db.transaction(['students'], 'readwrite');
            const store = transaction.objectStore('students');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadStudents();
                addActivity('student', `Student ${action}`, `Student "${data.firstName} ${data.lastName}" was ${action}.`);
                document.getElementById('student-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Teacher Form Submission
        document.getElementById('teacher-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const teacherData = {
                firstName: document.getElementById('teacher-first-name').value,
                lastName: document.getElementById('teacher-last-name').value,
                gender: document.getElementById('teacher-gender').value,
                dob: document.getElementById('teacher-dob').value,
                email: document.getElementById('teacher-email').value,
                phone: document.getElementById('teacher-phone').value,
                qualification: document.getElementById('teacher-qualification').value,
                subjects: Array.from(document.getElementById('teacher-subjects').selectedOptions).map(opt => opt.value),
                joiningDate: document.getElementById('teacher-joining-date').value,
                salary: parseFloat(document.getElementById('teacher-salary').value),
                address: document.getElementById('teacher-address').value,
            };
            saveTeacher(id ? parseInt(id) : null, teacherData);
        });

        function saveTeacher(id, data) {
            const transaction = db.transaction(['teachers'], 'readwrite');
            const store = transaction.objectStore('teachers');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadTeachers();
                addActivity('teacher', `Teacher ${action}`, `Teacher "${data.firstName} ${data.lastName}" was ${action}.`);
                document.getElementById('teacher-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Staff Form Submission
        document.getElementById('staff-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const staffData = {
                firstName: document.getElementById('staff-first-name').value,
                lastName: document.getElementById('staff-last-name').value,
                gender: document.getElementById('staff-gender').value,
                dob: document.getElementById('staff-dob').value,
                email: document.getElementById('staff-email').value,
                phone: document.getElementById('staff-phone').value,
                role: document.getElementById('staff-role').value,
                joiningDate: document.getElementById('staff-joining-date').value,
                salary: parseFloat(document.getElementById('staff-salary').value),
                status: document.getElementById('staff-status').value,
                address: document.getElementById('staff-address').value,
            };
            saveStaff(id ? parseInt(id) : null, staffData);
        });

        function saveStaff(id, data) {
            const transaction = db.transaction(['staff'], 'readwrite');
            const store = transaction.objectStore('staff');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadStaff();
                addActivity('staff', `Staff ${action}`, `Staff member "${data.firstName} ${data.lastName}" was ${action}.`);
                document.getElementById('staff-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Class Form Submission
        document.getElementById('class-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const classData = {
                name: document.getElementById('class-name').value,
                numericValue: document.getElementById('class-numeric-value').value,
                sections: document.getElementById('class-sections').value.split(',').map(s => s.trim()).filter(Boolean),
                classTeacher: document.getElementById('class-teacher').value,
            };
            saveClass(id ? parseInt(id) : null, classData);
        });

        function saveClass(id, data) {
            const transaction = db.transaction(['classes'], 'readwrite');
            const store = transaction.objectStore('classes');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadClasses();
                addActivity('system', `Class ${action}`, `Class "${data.name}" was ${action}.`);
                document.getElementById('class-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Subject Form Submission
        document.getElementById('subject-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const subjectData = {
                name: document.getElementById('subject-name').value,
                code: document.getElementById('subject-code').value,
                type: document.getElementById('subject-type').value,
                teacher: document.getElementById('subject-teacher').value,
                description: document.getElementById('subject-description').value,
            };
            saveSubject(id ? parseInt(id) : null, subjectData);
        });

        function saveSubject(id, data) {
            const transaction = db.transaction(['subjects'], 'readwrite');
            const store = transaction.objectStore('subjects');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadSubjects();
                addActivity('system', `Subject ${action}`, `Subject "${data.name}" was ${action}.`);
                document.getElementById('subject-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Fee Type Form Submission
        document.getElementById('fee-type-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const feeTypeData = {
                name: document.getElementById('fee-type-name').value,
                code: document.getElementById('fee-type-code').value,
                amount: parseFloat(document.getElementById('fee-type-amount').value),
                frequency: document.getElementById('fee-type-frequency').value,
                description: document.getElementById('fee-type-description').value,
            };
            saveFeeType(id ? parseInt(id) : null, feeTypeData);
        });

        function saveFeeType(id, data) {
            const transaction = db.transaction(['feeTypes'], 'readwrite');
            const store = transaction.objectStore('feeTypes');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadFeeTypes();
                addActivity('fee', `Fee Type ${action}`, `Fee type "${data.name}" was ${action}.`);
                document.getElementById('fee-type-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Exam Form Submission
        document.getElementById('exam-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const examData = {
                name: document.getElementById('exam-name').value,
                type: document.getElementById('exam-type').value,
                startDate: document.getElementById('exam-start-date').value,
                endDate: document.getElementById('exam-end-date').value,
                classes: Array.from(document.getElementById('exam-classes').selectedOptions).map(opt => opt.value),
                description: document.getElementById('exam-description').value,
                status: 'Active', // Default status
            };
            saveExam(id ? parseInt(id) : null, examData);
        });

        function saveExam(id, data) {
            const transaction = db.transaction(['exams'], 'readwrite');
            const store = transaction.objectStore('exams');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadExams();
                addActivity('exam', `Exam ${action}`, `Exam "${data.name}" was ${action}.`);
                document.getElementById('exam-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }
        
        // Book Form Submission
        document.getElementById('book-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const copies = parseInt(document.getElementById('book-copies').value);
            const bookData = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                subject: document.getElementById('book-subject').value,
                publisher: document.getElementById('book-publisher').value,
                isbn: document.getElementById('book-isbn').value,
                edition: document.getElementById('book-edition').value,
                copies: copies,
                availableCopies: copies, // Initially, all copies are available
                price: parseFloat(document.getElementById('book-price').value),
                description: document.getElementById('book-description').value,
            };
            saveBook(id ? parseInt(id) : null, bookData);
        });

        // Hifz Form Submission
        document.getElementById('hifz-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const hifzData = {
                studentId: document.getElementById('hifz-record-student').value,
                date: document.getElementById('hifz-record-date').value,
                surah: document.getElementById('hifz-surah').value,
                teacherId: document.getElementById('hifz-teacher-record').value,
                fromAyah: parseInt(document.getElementById('hifz-from-ayah').value),
                toAyah: parseInt(document.getElementById('hifz-to-ayah').value),
                status: document.getElementById('hifz-status').value,
                remarks: document.getElementById('hifz-remarks').value,
            };
            saveHifzRecord(id ? parseInt(id) : null, hifzData);
        });

        // Sabaq Form Submission
        document.getElementById('sabaq-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const sabaqData = {
                studentId: document.getElementById('sabaq-record-student').value,
                date: document.getElementById('sabaq-record-date').value,
                teacherId: document.getElementById('sabaq-teacher-record').value,
                status: document.getElementById('sabaq-status').value,
                sabaqNew: document.getElementById('sabaq-new').value,
                sabaqRecent: document.getElementById('sabaq-recent').value,
                sabaqOld: document.getElementById('sabaq-old').value,
                remarks: document.getElementById('sabaq-remarks').value,
            };
            saveSabaqRecord(id ? parseInt(id) : null, sabaqData);
        });

        // Expense Form Submission
        document.getElementById('expense-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const expenseData = {
                date: document.getElementById('expense-date').value,
                category: document.getElementById('expense-category').value,
                amount: parseFloat(document.getElementById('expense-amount').value),
                paymentMethod: document.getElementById('expense-payment-method').value,
                description: document.getElementById('expense-description').value,
            };
            saveExpense(id ? parseInt(id) : null, expenseData);
        });

        function saveExpense(id, data) {
            const transaction = db.transaction(['expenses'], 'readwrite');
            const store = transaction.objectStore('expenses');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadExpenses();
                addActivity('financial', `Expense ${action}`, `Expense of $${data.amount} for ${data.category} was ${action}.`);
                document.getElementById('expense-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

        // Income Form Submission
        document.getElementById('income-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const incomeData = {
                date: document.getElementById('income-date').value,
                category: document.getElementById('income-category').value,
                amount: parseFloat(document.getElementById('income-amount').value),
                paymentMethod: document.getElementById('income-payment-method').value,
                description: document.getElementById('income-description').value,
            };
            saveIncome(id ? parseInt(id) : null, incomeData);
        });
        
        function saveIncome(id, data) {
            const transaction = db.transaction(['income'], 'readwrite');
            const store = transaction.objectStore('income');
            const action = id ? 'updated' : 'added';
            if (id) data.id = id;
            const request = id ? store.put(data) : store.add(data);

            request.onsuccess = function () {
                loadIncome();
                addActivity('financial', `Income ${action}`, `Income of $${data.amount} from ${data.category} was ${action}.`);
                document.getElementById('income-modal').classList.remove('show');
            };
            request.onerror = (e) => alert(`Error: ${e.target.error.message}`);
        }

            // --- Mobile menu toggle ---
            document.querySelector('.mobile-menu-btn').addEventListener('click', function () {
                document.querySelector('.sidebar').classList.toggle('show');
            });

            // --- Tabs ---
            setupTabs();


            // --- Modals ---
            document.querySelectorAll('.modal-close').forEach(button => {
                button.addEventListener('click', function () {
                    this.closest('.modal').classList.remove('show');
                });
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });


        // --- START: Complete Form Submission Handlers ---

        // Student Form Submission
        document.getElementById('student-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const studentData = {
                firstName: document.getElementById('student-first-name').value,
                lastName: document.getElementById('student-last-name').value,
                gender: document.getElementById('student-gender').value,
                dob: document.getElementById('student-dob').value,
                class: document.getElementById('student-class').value,
                section: document.getElementById('student-section').value,
                admissionDate: document.getElementById('student-admission-date').value,
                admissionNumber: document.getElementById('student-admission-number').value,
                address: document.getElementById('student-address').value,
                fatherName: document.getElementById('student-father-name').value,
                fatherPhone: document.getElementById('student-father-phone').value,
                motherName: document.getElementById('student-mother-name').value,
                motherPhone: document.getElementById('student-mother-phone').value,
            };
            saveStudent(id ? parseInt(id) : null, studentData);
        });

        // Teacher Form Submission
        document.getElementById('teacher-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const teacherData = {
                firstName: document.getElementById('teacher-first-name').value,
                lastName: document.getElementById('teacher-last-name').value,
                gender: document.getElementById('teacher-gender').value,
                dob: document.getElementById('teacher-dob').value,
                email: document.getElementById('teacher-email').value,
                phone: document.getElementById('teacher-phone').value,
                qualification: document.getElementById('teacher-qualification').value,
                subjects: Array.from(document.getElementById('teacher-subjects').selectedOptions).map(opt => opt.value),
                joiningDate: document.getElementById('teacher-joining-date').value,
                salary: parseFloat(document.getElementById('teacher-salary').value),
                address: document.getElementById('teacher-address').value,
            };
            saveTeacher(id ? parseInt(id) : null, teacherData);
        });

        // Staff Form Submission
        document.getElementById('staff-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const staffData = {
                firstName: document.getElementById('staff-first-name').value,
                lastName: document.getElementById('staff-last-name').value,
                gender: document.getElementById('staff-gender').value,
                dob: document.getElementById('staff-dob').value,
                email: document.getElementById('staff-email').value,
                phone: document.getElementById('staff-phone').value,
                role: document.getElementById('staff-role').value,
                joiningDate: document.getElementById('staff-joining-date').value,
                salary: parseFloat(document.getElementById('staff-salary').value),
                status: document.getElementById('staff-status').value,
                address: document.getElementById('staff-address').value,
            };
            saveStaff(id ? parseInt(id) : null, staffData);
        });

        // Class Form Submission
        document.getElementById('class-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const classData = {
                name: document.getElementById('class-name').value,
                numericValue: document.getElementById('class-numeric-value').value,
                sections: document.getElementById('class-sections').value.split(',').map(s => s.trim()).filter(Boolean),
                classTeacher: document.getElementById('class-teacher').value,
            };
            saveClass(id ? parseInt(id) : null, classData);
        });

        // Subject Form Submission
        document.getElementById('subject-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const subjectData = {
                name: document.getElementById('subject-name').value,
                code: document.getElementById('subject-code').value,
                type: document.getElementById('subject-type').value,
                teacher: document.getElementById('subject-teacher').value,
                description: document.getElementById('subject-description').value,
            };
            saveSubject(id ? parseInt(id) : null, subjectData);
        });

        // Fee Type Form Submission
        document.getElementById('fee-type-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const feeTypeData = {
                name: document.getElementById('fee-type-name').value,
                code: document.getElementById('fee-type-code').value,
                amount: parseFloat(document.getElementById('fee-type-amount').value),
                frequency: document.getElementById('fee-type-frequency').value,
                description: document.getElementById('fee-type-description').value,
            };
            saveFeeType(id ? parseInt(id) : null, feeTypeData);
        });

        // Exam Form Submission
        document.getElementById('exam-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const examData = {
                name: document.getElementById('exam-name').value,
                type: document.getElementById('exam-type').value,
                startDate: document.getElementById('exam-start-date').value,
                endDate: document.getElementById('exam-end-date').value,
                classes: Array.from(document.getElementById('exam-classes').selectedOptions).map(opt => opt.value),
                description: document.getElementById('exam-description').value,
                status: 'Active',
            };
            saveExam(id ? parseInt(id) : null, examData);
        });
        
        // Book Form Submission
        document.getElementById('book-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const copies = parseInt(document.getElementById('book-copies').value);
            const bookData = {
                title: document.getElementById('book-title').value,
                author: document.getElementById('book-author').value,
                subject: document.getElementById('book-subject').value,
                publisher: document.getElementById('book-publisher').value,
                isbn: document.getElementById('book-isbn').value,
                edition: document.getElementById('book-edition').value,
                copies: copies,
                availableCopies: copies,
                price: parseFloat(document.getElementById('book-price').value),
                description: document.getElementById('book-description').value,
            };
            saveBook(id ? parseInt(id) : null, bookData);
        });

        // Hifz Form Submission
        document.getElementById('hifz-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const hifzData = {
                studentId: document.getElementById('hifz-record-student').value,
                date: document.getElementById('hifz-record-date').value,
                surah: document.getElementById('hifz-surah').value,
                teacherId: document.getElementById('hifz-teacher-record').value,
                fromAyah: parseInt(document.getElementById('hifz-from-ayah').value),
                toAyah: parseInt(document.getElementById('hifz-to-ayah').value),
                status: document.getElementById('hifz-status').value,
                remarks: document.getElementById('hifz-remarks').value,
            };
            saveHifzRecord(id ? parseInt(id) : null, hifzData);
        });

        // Sabaq Form Submission
        document.getElementById('sabaq-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const id = this.getAttribute('data-id');
            const sabaqData = {
                studentId: document.getElementById('sabaq-record-student').value,
                date: document.getElementById('sabaq-record-date').value,
                teacherId: document.getElementById('sabaq-teacher-record').value,
                status: document.getElementById('sabaq-status').value,
                sabaqNew: document.getElementById('sabaq-new').value,
                sabaqRecent: document.getElementById('sabaq-recent').value,
                sabaqOld: document.getElementById('sabaq-old').value,
                remarks: document.getElementById('sabaq-remarks').value,
            };
            saveSabaqRecord(id ? parseInt(id) : null, sabaqData);
        });

        // Settings Form Submissions
        document.getElementById('institution-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                name: document.getElementById('institution-name').value,
                phone: document.getElementById('institution-phone').value,
                email: document.getElementById('institution-email').value,
                address: document.getElementById('institution-address').value,
            };
            saveSettings('institution', data);
        });

        document.getElementById('academic-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                year: document.getElementById('academic-year').value,
                session: document.getElementById('academic-session').value,
                startDate: document.getElementById('academic-start-date').value,
                endDate: document.getElementById('academic-end-date').value,
            };
            saveSettings('academic', data);
        });

        document.getElementById('fee-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                currency: document.getElementById('fee-currency').value,
                fineRate: parseFloat(document.getElementById('fee-fine-rate').value),
            };
            saveSettings('fee', data);
        });

        document.getElementById('system-settings-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                language: document.getElementById('system-language').value,
                theme: document.getElementById('system-theme').value,
                timezone: document.getElementById('system-timezone').value,
            };
            saveSettings('system', data);
        });

        // Assign Subjects Form Submission
        document.getElementById('assign-subjects-form').addEventListener('submit', async function(e) { e.preventDefault(); /* Logic exists elsewhere */ });
        
        // Assign Fee to Classes Form Submission
        document.getElementById('assign-fee-form').addEventListener('submit', async function(e) { e.preventDefault(); /* Logic exists elsewhere */ });

        // Book Issue Form Submission
        document.getElementById('book-issue-form').addEventListener('submit', async function(e) { e.preventDefault(); /* Logic exists elsewhere */ });
        
        // Book Return Form Submission
        document.getElementById('book-return-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const issueId = parseInt(document.getElementById('return-issue-id').value);
            if (issueId) {
                markBookReturned(issueId);
                this.reset();
            } else {
                alert('Please enter an Issue ID to return a book.');
            }
        });

        // ID Card Generation
        document.getElementById('id-card-filter-form').addEventListener('submit', async function(e) { e.preventDefault(); /* Logic exists elsewhere */ });

        // Certificate Generation
        document.getElementById('certificate-filter-form').addEventListener('submit', async function(e) { e.preventDefault(); /* Logic exists elsewhere */ });

        // --- END: Complete Form Submission Handlers ---


            // --- "Add New" Buttons (Opening Modals) ---
            document.getElementById('add-student-btn').addEventListener('click', function () {
                document.getElementById('student-form').reset();
                document.getElementById('student-form').removeAttribute('data-id');
                document.querySelector('#student-modal .modal-title').textContent = 'Add New Student';
                // Populate class/section dropdowns in modal if needed
                populateClassDropdowns();
                document.getElementById('student-modal').classList.add('show');
            });

            document.getElementById('add-teacher-btn').addEventListener('click', function () {
                document.getElementById('teacher-form').reset();
                document.getElementById('teacher-form').removeAttribute('data-id');
                document.querySelector('#teacher-modal .modal-title').textContent = 'Add New Teacher';
                populateSubjectDropdowns(); // Populate subjects for multiple select
                document.getElementById('teacher-modal').classList.add('show');
            });

            document.getElementById('add-staff-btn').addEventListener('click', function () {
                document.getElementById('staff-form').reset();
                document.getElementById('staff-form').removeAttribute('data-id');
                document.querySelector('#staff-modal .modal-title').textContent = 'Add New Staff';
                document.getElementById('staff-modal').classList.add('show');
            });

            document.getElementById('add-class-btn').addEventListener('click', function () {
                document.getElementById('class-form').reset();
                document.getElementById('class-form').removeAttribute('data-id');
                document.querySelector('#class-modal .modal-title').textContent = 'Add New Class';
                populateTeacherDropdowns(); // Populate class teacher dropdown
                document.getElementById('class-modal').classList.add('show');
            });

            document.getElementById('add-subject-btn').addEventListener('click', function () {
                document.getElementById('subject-form').reset();
                document.getElementById('subject-form').removeAttribute('data-id');
                document.querySelector('#subject-modal .modal-title').textContent = 'Add New Subject';
                populateTeacherDropdowns(); // Populate subject teacher dropdown
                document.getElementById('subject-modal').classList.add('show');
            });

            document.getElementById('add-fee-type-btn').addEventListener('click', function () {
                document.getElementById('fee-type-form').reset();
                document.getElementById('fee-type-form').removeAttribute('data-id');
                document.querySelector('#fee-type-modal .modal-title').textContent = 'Add New Fee Type';
                document.getElementById('fee-type-modal').classList.add('show');
            });

            document.getElementById('assign-fee-btn').addEventListener('click', function () {
                document.getElementById('assign-fee-form').reset();
                // Assignment UI is built dynamically inside loadClassFeeStructure
                populateFeeTypeDropdowns();
                document.getElementById('assign-fee-modal').classList.add('show');
            });

            document.getElementById('add-exam-btn').addEventListener('click', function () {
                document.getElementById('exam-form').reset();
                document.getElementById('exam-form').removeAttribute('data-id');
                document.querySelector('#exam-modal .modal-title').textContent = 'Add New Exam';
                populateClassDropdowns(); // Populate classes dropdown for multi-select
                document.getElementById('exam-modal').classList.add('show');
            });

            document.getElementById('add-book-btn').addEventListener('click', function () {
                document.getElementById('book-form').reset();
                document.getElementById('book-form').removeAttribute('data-id');
                document.querySelector('#book-modal .modal-title').textContent = 'Add New Book';
                document.getElementById('book-modal').classList.add('show');
            });

            document.getElementById('add-hifz-record-btn').addEventListener('click', function () {
                document.getElementById('hifz-form').reset();
                document.getElementById('hifz-form').removeAttribute('data-id');
                document.querySelector('#hifz-modal .modal-title').textContent = 'Add Hifz Record';
                populateStudentDropdowns(); // Populate student dropdown
                populateTeacherDropdowns(); // Populate teacher dropdown
                populateStaticDropdowns(); // Populate Surah dropdown
                document.getElementById('hifz-modal').classList.add('show');
            });

            document.getElementById('add-sabaq-record-btn').addEventListener('click', function () {
                document.getElementById('sabaq-form').reset();
                document.getElementById('sabaq-form').removeAttribute('data-id');
                document.querySelector('#sabaq-modal .modal-title').textContent = 'Add Sabaq Record';
                populateStudentDropdowns(); // Populate student dropdown
                populateTeacherDropdowns(); // Populate teacher dropdown
                document.getElementById('sabaq-modal').classList.add('show');
            });


            // --- Search Functionality (Basic Filter) ---
            document.getElementById('student-search').addEventListener('input', function () {
                filterTable('students-table', this.value);
            });
            document.getElementById('teacher-search').addEventListener('input', function () {
                filterTable('teachers-table', this.value);
            });
            document.getElementById('staff-search').addEventListener('input', function () {
                filterTable('staff-table', this.value);
            });
            document.getElementById('book-search').addEventListener('input', function () {
                filterTable('books-table', this.value);
            });

            // Helper for basic table filtering
            function filterTable(tableId, searchTerm) {
                const table = document.getElementById(tableId);
                const rows = table.querySelectorAll('tbody tr');
                const filter = searchTerm.toLowerCase();

                rows.forEach(row => {
                    let rowText = '';
                    row.querySelectorAll('td').forEach((cell, index) => {
                        // Exclude actions column or other non-searchable columns by index if needed
                        if (index !== row.cells.length - 1) { // Exclude last cell (actions)
                            rowText += cell.textContent.toLowerCase() + ' ';
                        }
                    });

                    if (rowText.includes(filter)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }


            // --- Pagination (Placeholder) ---
            document.querySelectorAll('.pagination a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    alert('Pagination not fully implemented in this example.');
                });
            });


            // --- Attendance Tab Logic (Placeholder) ---
            document.getElementById('attendance-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Load Students for Attendance not implemented.');
                // Basic display toggle
                document.getElementById('attendance-table-container').style.display = 'block';
            });
            document.getElementById('save-attendance-btn').addEventListener('click', function () {
                alert('Save Attendance not implemented.');
            });
            document.getElementById('attendance-report-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Generate Attendance Report not implemented.');
                // Basic display toggle
                document.getElementById('attendance-report-container').style.display = 'block';
            });


            // --- Examinations Tab Logic (Placeholder) ---
            document.getElementById('marks-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Load Students for Marks Entry not implemented.');
                // Basic display toggle
                document.getElementById('marks-table-container').style.display = 'block';
            });
            document.getElementById('save-marks-btn').addEventListener('click', function () {
                alert('Save Marks not implemented.');
            });
            document.getElementById('report-card-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Generate Report Cards not implemented.');
                // Basic display toggle
                document.getElementById('report-cards-container').style.display = 'block';
            });
            document.getElementById('print-report-cards-btn').addEventListener('click', function () {
                alert('Print Report Cards not implemented.');
            });


            // --- Fee Management Tab Logic (Placeholder) ---
            // Assign fee form submission is handled above
            document.getElementById('fee-collection-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Fee Collection not implemented.');
            });
            document.getElementById('print-receipt-btn').addEventListener('click', function () {
                alert('Print Receipt not implemented.');
            });
            document.getElementById('fee-report-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Generate Fee Report not implemented.');
                // Basic display toggle
                document.getElementById('fee-report-container').style.display = 'block';
            });
            document.getElementById('defaulters-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Find Defaulters not implemented.');
                // Basic display toggle
                document.getElementById('defaulters-container').style.display = 'block';
            });


            // --- Salary Management Tab Logic (Placeholder) ---
            document.getElementById('salary-process-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Load Employees for Salary Processing not implemented.');
                // Basic display toggle
                document.getElementById('salary-process-container').style.display = 'block';
            });
            document.getElementById('process-salary-btn').addEventListener('click', function () {
                alert('Process Salary not implemented.');
            });
            document.getElementById('print-payslips-btn').addEventListener('click', function () {
                alert('Print Payslips not implemented.');
            });
            document.getElementById('salary-report-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Generate Salary Report not implemented.');
                // Basic display toggle
                document.getElementById('salary-report-container').style.display = 'block';
            });


            // --- Expenses/Income Tab Logic (Placeholder) ---
            document.getElementById('add-expense-btn').addEventListener('click', function () {
                document.getElementById('expense-form').reset();
                document.getElementById('expense-form').removeAttribute('data-id');
                document.querySelector('#expense-modal .modal-title').textContent = 'Add New Expense';
                document.getElementById('expense-modal').classList.add('show');
            });
            document.getElementById('add-income-btn').addEventListener('click', function () {
                document.getElementById('income-form').reset();
                document.getElementById('income-form').removeAttribute('data-id');
                document.querySelector('#income-modal .modal-title').textContent = 'Add New Income';
                document.getElementById('income-modal').classList.add('show');
            });
            document.getElementById('financial-report-filter-form').addEventListener('submit', function (e) {
                // This form is duplicated in Reports and Financial sections, ensure one handler covers both
                // Using the generic generateReport function
                generateReport('financial-report-filter-form', 'financial-report-container', 'Financial Report');
                e.preventDefault(); // Prevent default submission
            });


            // --- Library Tab Logic (Placeholder) ---
            // Book issue form submission handled above
            // Book return form submission handled above
            document.getElementById('library-report-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Generate Library Report not implemented.');
                // Basic display toggle
                document.getElementById('library-report-container').style.display = 'block';
            });


            // --- Madrasa Tab Logic (Placeholder) ---
            document.getElementById('hifz-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Load Hifz Records with Filters not fully implemented.');
                loadHifzRecords(); // Re-load all for now
            });
            document.getElementById('sabaq-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Load Sabaq Records with Filters not fully implemented.');
                loadSabaqRecords(); // Re-load all for now
            });
            document.getElementById('madrasa-report-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                alert('Generate Madrasa Report not implemented.');
                // Basic display toggle
                document.getElementById('madrasa-report-container').style.display = 'block';
            });


            // --- Reports Section (Using Generic Handler) ---
            // The actual report generation logic needs to be implemented fully inside generateReport or similar functions
            document.getElementById('student-report-filter-form').addEventListener('submit', function (e) {
                e.preventDefault();
                generateReport('student-report-filter-form', 'student-report-container', 'Student Report');
            });
            // Attendance report handler might be linked or duplicated, need to be careful
            // Financial report handler might be linked or duplicated

            // --- Utilities (ID Cards & Certificates) ---
            setupIDCardGeneration(); // Setup logic for ID card form/preview/print
            // Certificate generation form submission handled above
            // Print buttons handled within their respective setup/submit functions


            // --- Settings Tab Logic (Placeholder) ---
            document.getElementById('institution-settings-form').addEventListener('submit', function (e) { /* Handled above */ });
            document.getElementById('academic-settings-form').addEventListener('submit', function (e) { /* Handled above */ });
            document.getElementById('fee-settings-form').addEventListener('submit', function (e) { /* Handled above */ });
            document.getElementById('system-settings-form').addEventListener('submit', function (e) { /* Handled above */ });

            // Backup/Restore/Reset
            document.getElementById('backup-data-btn').addEventListener('click', backupData);
            document.getElementById('restore-data').addEventListener('change', function () {
                document.getElementById('restore-data-btn').disabled = this.files.length === 0;
            });
            document.getElementById('restore-data-btn').addEventListener('click', function () {
                const fileInput = document.getElementById('restore-data');
                if (fileInput.files.length > 0) {
                    restoreData(fileInput.files[0]);
                } else {
                    alert('Please select a backup file first.');
                }
            });
            document.getElementById('reset-data-btn').addEventListener('click', resetData);

            // Initial load of settings to populate forms
            loadSettings();

            // Populate dropdowns used in multiple forms
            populateStudentDropdowns();
            populateTeacherDropdowns();
            populateStaffDropdowns(); // Note: Staff dropdown is currently only used in ID card which is dynamic
            populateClassDropdowns();
            populateSubjectDropdowns();
            populateFeeTypeDropdowns();
            populateExamDropdowns();
            populateBookDropdowns();
            populateYearDropdowns();
            populateStaticDropdowns(); // e.g., Surahs, categories

            // Show initial section (Dashboard)
            showSection('dashboard');
        }
                // Populate exam dropdowns in various forms
        function populateExamDropdowns() {
            const transaction = db.transaction(['exams'], 'readonly');
            const store = transaction.objectStore('exams');
            const request = store.getAll();

            request.onsuccess = function () {
                const exams = request.result;
                const examDropdowns = ['marks-exam', 'rc-exam'];

                examDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        const currentValue = dropdown.value;
                        while (dropdown.options.length > 1) {
                            dropdown.remove(1);
                        }
                        exams.forEach(exam => {
                            const option = document.createElement('option');
                            option.value = exam.id;
                            option.textContent = exam.name;
                            dropdown.appendChild(option);
                        });
                        if (currentValue && Array.from(dropdown.options).some(opt => opt.value === currentValue)) {
                            dropdown.value = currentValue;
                        }
                    }
                });
            };
        }

        // Delete exam
        function deleteExam(examId) {
            if (confirm('Are you sure you want to delete this exam? This will also delete all associated data.')) {
                const transaction = db.transaction(['exams'], 'readwrite');
                const store = transaction.objectStore('exams');
                const request = store.delete(examId);

                request.onsuccess = function () {
                    console.log("Exam deleted successfully");
                    loadExams();
                    addActivity('exam', 'Exam Deleted', `Exam with ID ${examId} was deleted`);
                };

                request.onerror = function (event) {
                    console.error("Error deleting exam:", event.target.error);
                };
            }
        }

        // Load books
        function loadBooks() {
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.getAll();

            request.onsuccess = function () {
                const books = request.result;
                const tbody = document.getElementById('books-table-body');
                tbody.innerHTML = '';

                books.forEach(book => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${book.id}</td>
                        <td>${book.title || 'N/A'}</td>
                        <td>${book.author || 'N/A'}</td>
                        <td>${book.subject || 'N/A'}</td>
                        <td>${book.publisher || 'N/A'}</td>
                        <td>${book.availableCopies || 0}</td>
                        <td>${book.copies || 0}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-book" data-id="${book.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-book" data-id="${book.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                document.querySelectorAll('.edit-book').forEach(button => {
                    button.addEventListener('click', function () {
                        editBook(parseInt(this.getAttribute('data-id')));
                    });
                });

                document.querySelectorAll('.delete-book').forEach(button => {
                    button.addEventListener('click', function () {
                        deleteBook(parseInt(this.getAttribute('data-id')));
                    });
                });

                populateBookDropdowns();
            };
        }

        function editBook(bookId) {
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.get(bookId);

            request.onsuccess = function () {
                const book = request.result;
                if (book) {
                    document.getElementById('book-title').value = book.title || '';
                    document.getElementById('book-author').value = book.author || '';
                    document.getElementById('book-subject').value = book.subject || '';
                    document.getElementById('book-publisher').value = book.publisher || '';
                    document.getElementById('book-isbn').value = book.isbn || '';
                    document.getElementById('book-edition').value = book.edition || '';
                    document.getElementById('book-copies').value = book.copies || '';
                    document.getElementById('book-price').value = book.price || '';
                    document.getElementById('book-description').value = book.description || '';

                    document.getElementById('book-form').setAttribute('data-id', bookId);
                    document.querySelector('#book-modal .modal-title').textContent = 'Edit Book';
                    document.getElementById('book-modal').classList.add('show');
                }
            };
        }

        function deleteBook(bookId) {
            if (confirm('Are you sure you want to delete this book?')) {
                const transaction = db.transaction(['books'], 'readwrite');
                const store = transaction.objectStore('books');
                const request = store.delete(bookId);
                request.onsuccess = function () {
                    console.log("Book deleted successfully");
                    loadBooks();
                    addActivity('library', 'Book Deleted', `Book with ID ${bookId} was deleted`);
                };
            }
        }

        function populateBookDropdowns() {
            const transaction = db.transaction(['books'], 'readonly');
            const store = transaction.objectStore('books');
            const request = store.getAll();

            request.onsuccess = function () {
                const books = request.result;
                const bookDropdowns = ['issue-book', 'return-book'];

                bookDropdowns.forEach(id => {
                    const dropdown = document.getElementById(id);
                    if (dropdown) {
                        dropdown.innerHTML = '<option value="">Select Book</option>';
                        books.forEach(book => {
                            if ((book.availableCopies || 0) > 0) { // Only show available books for issue
                                const option = document.createElement('option');
                                option.value = book.id;
                                option.textContent = `${book.title} (by ${book.author})`;
                                dropdown.appendChild(option);
                            }
                        });
                    }
                });
            };
        }

        function loadHifzRecords() {
            const transaction = db.transaction(['hifzRecords'], 'readonly');
            const store = transaction.objectStore('hifzRecords');
            const request = store.getAll();
            request.onsuccess = function () {
                const records = request.result;
                const tbody = document.getElementById('hifz-records-table-body');
                tbody.innerHTML = '';
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${record.date || 'N/A'}</td>
                        <td>${record.studentName || 'N/A'}</td>
                        <td>${record.surah || 'N/A'}</td>
                        <td>${record.fromAyah || 'N/A'}</td>
                        <td>${record.toAyah || 'N/A'}</td>
                        <td><span class="badge badge-primary">${record.status || 'N/A'}</span></td>
                        <td>${record.teacherName || 'N/A'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-hifz" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-hifz" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            };
        }

        function loadSabaqRecords() {
            const transaction = db.transaction(['sabaqRecords'], 'readonly');
            const store = transaction.objectStore('sabaqRecords');
            const request = store.getAll();
            request.onsuccess = function () {
                const records = request.result;
                const tbody = document.getElementById('sabaq-records-table-body');
                tbody.innerHTML = '';
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${record.date || 'N/A'}</td>
                        <td>${record.studentName || 'N/A'}</td>
                        <td>${record.sabaqNew || 'N/A'}</td>
                        <td>${record.sabaqRecent || 'N/A'}</td>
                        <td>${record.sabaqOld || 'N/A'}</td>
                        <td>${record.teacherName || 'N/A'}</td>
                        <td>
                             <div class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-sabaq" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-sabaq" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            };
        }
                function loadSettings() {
            const transaction = db.transaction(['settings'], 'readonly');
            const store = transaction.objectStore('settings');
            const request = store.getAll();

            request.onsuccess = function() {
                const settings = request.result;
                const getSetting = (key) => settings.find(s => s.key === key)?.value;

                const institutionSettings = getSetting('institution') || {};
                document.getElementById('institution-name').value = institutionSettings.name || '';
                document.getElementById('institution-phone').value = institutionSettings.phone || '';
                document.getElementById('institution-email').value = institutionSettings.email || '';
                document.getElementById('institution-address').value = institutionSettings.address || '';
                if (institutionSettings.logo) {
                    document.getElementById('logo-preview').innerHTML = `<img src="${institutionSettings.logo}" alt="Logo Preview" style="max-width: 150px;">`;
                }

                const academicSettings = getSetting('academic') || {};
                document.getElementById('academic-year').value = academicSettings.year || '';
                document.getElementById('academic-session').value = academicSettings.session || 'Morning';

                const feeSettings = getSetting('fee') || {};
                document.getElementById('fee-currency').value = feeSettings.currency || '$';
                document.getElementById('fee-fine-rate').value = feeSettings.fineRate || 0;

                const systemSettings = getSetting('system') || {};
                document.getElementById('system-language').value = systemSettings.language || 'en';
                document.getElementById('system-theme').value = systemSettings.theme || 'light';
                document.getElementById('system-timezone').value = systemSettings.timezone || 'UTC';
            };

            request.onerror = function(event) {
                console.error("Error loading settings:", event.target.error);
            };
        }

        function addActivity(type, title, description) {
            if (!db) return;
            const transaction = db.transaction(['activities'], 'readwrite');
            const store = transaction.objectStore('activities');
            const activity = {
                type: type,
                title: title,
                description: description,
                date: new Date().toISOString()
            };
            store.add(activity).onerror = (e) => console.error("Error logging activity:", e.target.error);
        }
        function initApp() {
            // Load initial data
            loadDashboardData();
            loadStudents();
            loadTeachers();
            loadStaff();
            loadClasses();
            loadSubjects();
            loadFeeTypes();
            loadExams();
            loadBooks();
            loadHifzRecords();
            loadSabaqRecords();
            loadSettings();

            // Set up event listeners
            setupEventListeners();
        }

    </script>
<script type="module">
  import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

  const swUrl = './sw.js';
  const wb = new Workbox(swUrl);

  wb.addEventListener('waiting', () => {
    console.log('A new service worker is waiting to activate.');
    wb.messageSW({ type: 'SKIP_WAITING' });
  });

  wb.addEventListener('controlling', () => {
    console.log('The new service worker is now in control. Reloading page for updates...');
    window.location.reload();
  });

  wb.register();
</script></body>
</html>

<!DOCTYPE html>
<html dir="rtl" lang="ur">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دینی مدرسہ مینجمنٹ سسٹم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap');
        body {
            font-family: 'Noto Nastaliq Urdu', serif;
            background-color: #f8f9fa;
        }
        .sidebar {
            min-height: 100vh;
            background-color: #1e293b;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            margin-bottom: 5px;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        .main-content {
            padding: 20px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-control, .form-select {
            margin-bottom: 15px;
        }
        .btn-action {
            margin-right: 5px;
        }
        #printArea {
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #printArea, #printArea * {
                visibility: visible;
            }
            #printArea {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
        .dir-ltr {
            direction: ltr;
        }
    </style>
</head>
<body>
<div class="container-fluid">
<div class="row">
<div class="col-md-2 sidebar p-0">
<div class="p-3 text-center">
<h4>دینی مدرسہ مینجمنٹ</h4>
</div>
<ul class="nav flex-column">
<li class="nav-item">
<a class="nav-link active" href="#" onclick="n('dashboard')">
<i class="bi bi-speedometer2"></i> ڈیش بورڈ
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('students')">
<i class="bi bi-people"></i> طلاب
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('teachers')">
<i class="bi bi-person-workspace"></i> اساتذہ
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('classes')">
<i class="bi bi-book"></i> کلاسز/درس
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('attendance')">
<i class="bi bi-calendar-check"></i> حاضری
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('fees')">
<i class="bi bi-cash-coin"></i> فیس
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('salary')">
<i class="bi bi-wallet2"></i> تنخواہ
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" onclick="n('reports')">
<i class="bi bi-file-earmark-text"></i> رپورٹس
</a>
</li>
</ul>
</div>

            <div class="col-md-10 main-content" id="content">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>
    
    <div id="printArea"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // IndexedDB initialization
        let db;
        const r = window.indexedDB.open('MadrasaDB', 1);
        
        r.onupgradeneeded = function(e) {
            db = e.target.result;
            
            // Students store
            if (!db.objectStoreNames.contains('students')) {
                const s = db.createObjectStore('students', {keyPath: 'id', autoIncrement: true});
                s.createIndex('name', 'name', {unique: false});
                s.createIndex('class', 'class', {unique: false});
            }
            
            // Teachers store
            if (!db.objectStoreNames.contains('teachers')) {
                const t = db.createObjectStore('teachers', {keyPath: 'id', autoIncrement: true});
                t.createIndex('name', 'name', {unique: false});
            }
            
            // Classes store
            if (!db.objectStoreNames.contains('classes')) {
                const c = db.createObjectStore('classes', {keyPath: 'id', autoIncrement: true});
                c.createIndex('name', 'name', {unique: false});
            }
            
            // Attendance store
            if (!db.objectStoreNames.contains('attendance')) {
                const a = db.createObjectStore('attendance', {keyPath: 'id', autoIncrement: true});
                a.createIndex('date', 'date', {unique: false});
                a.createIndex('studentId', 'studentId', {unique: false});
            }
            
            // Fees store
            if (!db.objectStoreNames.contains('fees')) {
                const f = db.createObjectStore('fees', {keyPath: 'id', autoIncrement: true});
                f.createIndex('studentId', 'studentId', {unique: false});
                f.createIndex('date', 'date', {unique: false});
            }
            
            // Salary store
            if (!db.objectStoreNames.contains('salary')) {
                const sl = db.createObjectStore('salary', {keyPath: 'id', autoIncrement: true});
                sl.createIndex('teacherId', 'teacherId', {unique: false});
                sl.createIndex('date', 'date', {unique: false});
            }
        };
        
        r.onsuccess = function(e) {
            db = e.target.result;
            n('dashboard');
        };
        
        r.onerror = function(e) {
            console.error('Database error:', e.target.error);
            alert('ڈیٹابیس کے ساتھ مسئلہ ہے۔');
        };
    
// Replace your current navigation function with this:
function n(p) {
    // First deactivate all links
    const l = document.querySelectorAll('.nav-link');
    l.forEach(link => link.classList.remove('active'));
    
    // Then activate the clicked link
    const clickedLink = document.querySelector(`.nav-link[onclick="n('${p}')"]`);
    if (clickedLink) clickedLink.classList.add('active');
    
    const c = document.getElementById('content');
    
    // Debug line to check what page is being requested
    console.log('Navigating to:', p);
    
    switch(p) {
        case 'dashboard':
            loadDashboard(c);
            break;
        case 'students':
            loadStudents(c);
            break;
        case 'teachers':
            loadTeachers(c);
            break;
        case 'classes':
            loadClasses(c);
            break;
        case 'attendance':
            loadAttendance(c);
            break;
        case 'fees':
            loadFees(c);
            break;
        case 'salary':
            loadSalary(c);
            break;
        case 'reports':
            loadReports(c);
            break;
        default:
            console.error('Unknown page:', p);
            loadDashboard(c);
    }
}

        
        // Dashboard
        function loadDashboard(c) {
            c.innerHTML = `
                <h2 class="mb-4">ڈیش بورڈ</h2>
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <h5 class="card-title">طلاب</h5>
                                <h2 class="card-text" id="studentCount">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <h5 class="card-title">اساتذہ</h5>
                                <h2 class="card-text" id="teacherCount">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h5 class="card-title">کلاسز</h5>
                                <h2 class="card-text" id="classCount">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card bg-warning text-dark">
                            <div class="card-body">
                                <h5 class="card-title">آج کی حاضری</h5>
                                <h2 class="card-text" id="todayAttendance">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>حالیہ فیس ادائیگی</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>طالب علم</th>
                                                <th>تاریخ</th>
                                                <th>رقم</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentFees"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>غیر حاضر طلاب (آج)</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>نام</th>
                                                <th>کلاس</th>
                                                <th>رابطہ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="absentToday"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            updateDashboardCounts();
        }
        
        function updateDashboardCounts() {
            countRecords('students').then(count => {
                document.getElementById('studentCount').textContent = count;
            });
            
            countRecords('teachers').then(count => {
                document.getElementById('teacherCount').textContent = count;
            });
            
            countRecords('classes').then(count => {
                document.getElementById('classCount').textContent = count;
            });
            
            // Today's attendance count
            const today = new Date().toISOString().split('T');
            const t = db.transaction(['attendance'], 'readonly');
            const s = t.objectStore('attendance');
            const i = s.index('date');
            const r = i.getAll(IDBKeyRange.only(today));
            
            r.onsuccess = function() {
                document.getElementById('todayAttendance').textContent = r.result.filter(a => a.status === 'present').length;
            };
            
            // Recent fees
            const ft = db.transaction(['fees', 'students'], 'readonly');
            const fs = ft.objectStore('fees');
            const ss = ft.objectStore('students');
            const fr = fs.getAll();
            
            fr.onsuccess = function() {
                const fees = fr.result.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                let html = '';
                
                let processed = 0;
                fees.forEach(fee => {
                    const sr = ss.get(fee.studentId);
                    sr.onsuccess = function() {
                        const student = sr.result;
                        html += `
                            <tr>
                                <td>${student ? student.name : 'غیر معلوم'}</td>
                                <td>${fee.date}</td>
                                <td>Rs. ${fee.amount}</td>
                            </tr>
                        `;
                        processed++;
                        if (processed === fees.length) {
                            document.getElementById('recentFees').innerHTML = html;
                        }
                    };
                });
                
                if (fees.length === 0) {
                    document.getElementById('recentFees').innerHTML = '<tr><td colspan="3">کوئی حالیہ ادائیگی نہیں</td></tr>';
                }
            };
            
            // Absent today
            const at = db.transaction(['attendance', 'students'], 'readonly');
            const as = at.objectStore('attendance');
            const ast = at.objectStore('students');
            const ai = as.index('date');
            const ar = ai.getAll(IDBKeyRange.only(today));
            
            ar.onsuccess = function() {
                const absents = ar.result.filter(a => a.status === 'absent');
                let html = '';
                
                if (absents.length === 0) {
                    document.getElementById('absentToday').innerHTML = '<tr><td colspan="3">آج کوئی غیر حاضر نہیں</td></tr>';
                    return;
                }
                
                let processed = 0;
                absents.forEach(absent => {
                    const sr = ast.get(absent.studentId);
                    sr.onsuccess = function() {
                        const student = sr.result;
                        if (student) {
                            html += `
                                <tr>
                                    <td>${student.name}</td>
                                    <td>${student.class}</td>
                                    <td>${student.contact || 'غیر معلوم'}</td>
                                </tr>
                            `;
                        }
                        processed++;
                        if (processed === absents.length) {
                            document.getElementById('absentToday').innerHTML = html || '<tr><td colspan="3">آج کوئی غیر حاضر نہیں</td></tr>';
                        }
                    };
                });
            };
        }
        
        function countRecords(storeName) {
            return new Promise((resolve, reject) => {
                const t = db.transaction([storeName], 'readonly');
                const s = t.objectStore(storeName);
                const r = s.count();
                
                r.onsuccess = function() {
                    resolve(r.result);
                };
                
                r.onerror = function(err) {
                    reject(err);
                };
            });
        }
        
        // Students Management
function loadStudents(c) {
    c.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>طلاب کا انتظام</h2>
            <button class="btn btn-primary" onclick="showStudentForm()">
                <i class="bi bi-plus-circle"></i> نیا طالب علم
            </button>
        </div>
        
        <div id="studentForm" style="display: none;" class="card mb-4">
            <div class="card-header">
                <h5 id="formTitle">نیا طالب علم</h5>
            </div>
            <div class="card-body">
                <form id="addStudentForm">
                    <input type="hidden" id="studentId">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="studentName" class="form-label">نام</label>
                            <input type="text" class="form-control" id="studentName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="fatherName" class="form-label">والد کا نام</label>
                            <input type="text" class="form-control" id="fatherName" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <label for="studentAge" class="form-label">عمر</label>
                            <input type="number" class="form-control" id="studentAge" required>
                        </div>
                        <div class="col-md-3">
                            <label for="studentClass" class="form-label">کلاس</label>
                            <select class="form-select" id="studentClass" required>
                                <option value="">کلاس منتخب کریں</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="admissionDate" class="form-label">داخلے کی تاریخ</label>
                            <input type="date" class="form-control" id="admissionDate" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="contactNumber" class="form-label">رابطہ نمبر</label>
                            <input type="text" class="form-control" id="contactNumber">
                        </div>
                        <div class="col-md-6">
                            <label for="address" class="form-label">پتہ</label>
                            <textarea class="form-control" id="address" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <div id="extraFields"></div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-secondary" onclick="addExtraField()">
                            <i class="bi bi-plus-circle"></i> اضافی فیلڈ
                        </button>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-secondary me-2" onclick="cancelStudentForm()">منسوخ</button>
                        <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>طلاب کی فہرست</h5>
                    <div class="d-flex">
                        <input type="text" class="form-control form-control-sm me-2" id="studentSearch" placeholder="تلاش کریں...">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportStudentsCsv()">
                            <i class="bi bi-download"></i> CSV
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>نام</th>
                                <th>والد کا نام</th>
                                <th>عمر</th>
                                <th>کلاس</th>
                                <th>داخلے کی تاریخ</th>
                                <th>اقدامات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('addStudentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveStudent();
    });
    
    document.getElementById('studentSearch').addEventListener('input', function() {
        loadStudentsList();
    });
    
    // Now that the HTML is created, load class options and then students list
    setTimeout(() => {
        loadClassOptions('studentClass').then(() => {
            loadStudentsList();
        });
    }, 100);
}

        
        function showStudentForm() {
            document.getElementById('studentForm').style.display = 'block';
            document.getElementById('formTitle').textContent = 'نیا طالب علم';
            document.getElementById('addStudentForm').reset();
            document.getElementById('studentId').value = '';
            document.getElementById('extraFields').innerHTML = '';
            loadClassOptions();
        }
        
        function cancelStudentForm() {
            document.getElementById('studentForm').style.display = 'none';
        }
        
        function addExtraField() {
            const e = document.getElementById('extraFields');
            const i = e.children.length;
            
            const f = document.createElement('div');
            f.className = 'row mt-3';
            f.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" id="fieldName${i}" placeholder="فیلڈ کا نام">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" id="fieldValue${i}" placeholder="فیلڈ کی قیمت">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger" onclick="this.parentNode.parentNode.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            e.appendChild(f);
        }
        
        function loadClassOptions() {
            const s = document.getElementById('studentClass');
            s.innerHTML = '<option value="">کلاس منتخب کریں</option>';
            
            const t = db.transaction(['classes'], 'readonly');
            const st = t.objectStore('classes');
            const r = st.getAll();
            
            r.onsuccess = function() {
                const classes = r.result;
                classes.forEach(c => {
                    const o = document.createElement('option');
                    o.value = c.name;
                    o.textContent = c.name;
                    s.appendChild(o);
                });
            };
        }
        
        function loadStudentsList() {
            const t = db.transaction(['students'], 'readonly');
            const s = t.objectStore('students');
            const r = s.getAll();
            
            r.onsuccess = function() {
                let students = r.result;
                const searchText = document.getElementById('studentSearch').value.toLowerCase();
                
                if (searchText) {
                    students = students.filter(student => 
                        student.name.toLowerCase().includes(searchText) || 
                        (student.fatherName && student.fatherName.toLowerCase().includes(searchText)) ||
                        (student.class && student.class.toLowerCase().includes(searchText))
                    );
                }
                
                const l = document.getElementById('studentsList');
                l.innerHTML = '';
                
                students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${student.name}</td>
                        <td>${student.fatherName || '-'}</td>
                        <td>${student.age || '-'}</td>
                        <td>${student.class || '-'}</td>
                        <td>${student.admissionDate || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-action" onclick="editStudent(${student.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteStudent(${student.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-info btn-action" onclick="viewStudentDetails(${student.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                    l.appendChild(row);
                });
                
                if (students.length === 0) {
                    l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی طالب علم نہیں ملا</td></tr>';
                }
            };
        }
        
        function saveStudent() {
            const i = document.getElementById('studentId').value;
            const extraFields = {};
            const ef = document.getElementById('extraFields');
            
            for (let i = 0; i < ef.children.length; i++) {
                const name = document.getElementById(`fieldName${i}`).value;
                const value = document.getElementById(`fieldValue${i}`).value;
                if (name && value) {
                    extraFields[name] = value;
                }
            }
            
            const student = {
                name: document.getElementById('studentName').value,
                fatherName: document.getElementById('fatherName').value,
                age: parseInt(document.getElementById('studentAge').value),
                class: document.getElementById('studentClass').value,
                admissionDate: document.getElementById('admissionDate').value,
                contact: document.getElementById('contactNumber').value,
                address: document.getElementById('address').value,
                extraFields: extraFields
            };
            
            const t = db.transaction(['students'], 'readwrite');
            const s = t.objectStore('students');
            
            if (i) {
                student.id = parseInt(i);
                s.put(student);
            } else {
                s.add(student);
            }
            
            t.oncomplete = function() {
                document.getElementById('studentForm').style.display = 'none';
                loadStudentsList();
                alert(i ? 'طالب علم کی معلومات اپڈیٹ ہو گئیں' : 'نیا طالب علم شامل کر دیا گیا');
            };
            
            t.onerror = function(e) {
                console.error('Transaction error:', e.target.error);
                alert('طالب علم کو محفوظ کرنے میں خرابی');
            };
        }
        
        function editStudent(id) {
            const t = db.transaction(['students'], 'readonly');
            const s = t.objectStore('students');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const student = r.result;
                if (student) {
                    document.getElementById('formTitle').textContent = 'طالب علم کی تفصیلات میں ترمیم کریں';
                    document.getElementById('studentId').value = student.id;
                    document.getElementById('studentName').value = student.name || '';
                    document.getElementById('fatherName').value = student.fatherName || '';
                    document.getElementById('studentAge').value = student.age || '';
                    document.getElementById('admissionDate').value = student.admissionDate || '';
                    document.getElementById('contactNumber').value = student.contact || '';
                    document.getElementById('address').value = student.address || '';
                    
                    loadClassOptions().then(() => {
                        document.getElementById('studentClass').value = student.class || '';
                    });
                    
                    // Extra fields
                    const ef = document.getElementById('extraFields');
                    ef.innerHTML = '';
                    
                    if (student.extraFields) {
                        let i = 0;
                        for (const [key, value] of Object.entries(student.extraFields)) {
                            const f = document.createElement('div');
                            f.className = 'row mt-3';
                            f.innerHTML = `
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="fieldName${i}" placeholder="فیلڈ کا نام" value="${key}">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="fieldValue${i}" placeholder="فیلڈ کی قیمت" value="${value}">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger" onclick="this.parentNode.parentNode.remove()">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                            
                            ef.appendChild(f);
                            i++;
                        }
                    }
                    
                    document.getElementById('studentForm').style.display = 'block';
                }
            };
        }
        
        function deleteStudent(id) {
            if (confirm('کیا آپ واقعی اس طالب علم کو حذف کرنا چاہتے ہیں؟')) {
                const t = db.transaction(['students'], 'readwrite');
                const s = t.objectStore('students');
                s.delete(id);
                
                t.oncomplete = function() {
                    loadStudentsList();
                    alert('طالب علم کامیابی سے حذف کر دیا گیا');
                };
                
                t.onerror = function(e) {
                    console.error('Delete error:', e.target.error);
                    alert('طالب علم کو حذف کرنے میں خرابی');
                };
            }
        }
        
        function viewStudentDetails(id) {
            const t = db.transaction(['students', 'attendance', 'fees'], 'readonly');
            const s = t.objectStore('students');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const student = r.result;
                if (student) {
                    let extraFieldsHtml = '';
                    if (student.extraFields) {
                        for (const [key, value] of Object.entries(student.extraFields)) {
                            extraFieldsHtml += `
                                <tr>
                                    <th>${key}</th>
                                    <td>${value}</td>
                                </tr>
                            `;
                        }
                    }
                    
                    // Get attendance statistics
                    const as = t.objectStore('attendance');
                    const ai = as.index('studentId');
                    const ar = ai.getAll(IDBKeyRange.only(student.id));
                    
                    ar.onsuccess = function() {
                        const attendance = ar.result;
                        const present = attendance.filter(a => a.status === 'present').length;
                        const absent = attendance.filter(a => a.status === 'absent').length;
                        const total = attendance.length;
                        
                        // Get fee payments
                        const fs = t.objectStore('fees');
                        const fi = fs.index('studentId');
                        const fr = fi.getAll(IDBKeyRange.only(student.id));
                        
                        fr.onsuccess = function() {
                            const fees = fr.result;
                            const totalPaid = fees.reduce((sum, fee) => sum + parseFloat(fee.amount), 0);
                            
                            const c = document.getElementById('content');
                            c.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>طالب علم کی تفصیلات</h2>
                                    <button class="btn btn-secondary" onclick="n('students')">
                                        <i class="bi bi-arrow-left"></i> واپس
                                    </button>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5>${student.name}</h5>
                                            </div>
                                            <div class="card-body">
                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <th>نام</th>
                                                            <td>${student.name || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>والد کا نام</th>
                                                            <td>${student.fatherName || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>عمر</th>
                                                            <td>${student.age || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>کلاس</th>
                                                            <td>${student.class || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>داخلے کی تاریخ</th>
                                                            <td>${student.admissionDate || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>رابطہ</th>
                                                            <td>${student.contact || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>پتہ</th>
                                                            <td>${student.address || '-'}</td>
                                                        </tr>
                                                        ${extraFieldsHtml}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5>حاضری</h5>
                                            </div>
                                            <div class="card-body text-center">
                                                <h3>${present} / ${total}</h3>
                                                <p>حاضر: ${present} | غیر حاضر: ${absent}</p>
                                                <div class="progress">
                                                    <div class="progress-bar bg-success" role="progressbar" style="width: ${total > 0 ? (present / total * 100) : 0}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>فیس</h5>
                                            </div>
                                            <div class="card-body text-center">
                                                <h3>Rs. ${totalPaid.toFixed(2)}</h3>
                                                <p>کل ادائیگی: ${fees.length}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>حالیہ حاضری</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>تاریخ</th>
                                                                <th>حیثیت</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="recentAttendance"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>حالیہ ادائیگی</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>تاریخ</th>
                                                                <th>رقم</th>
                                                                <th>تفصیلات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="recentPayments"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Populate recent attendance
                            const recentAttendance = attendance.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                            const ra = document.getElementById('recentAttendance');
                            
                            if (recentAttendance.length === 0) {
                                ra.innerHTML = '<tr><td colspan="2">کوئی حاضری ریکارڈ نہیں</td></tr>';
                            } else {
                                recentAttendance.forEach(a => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${a.date}</td>
                                        <td><span class="badge ${a.status === 'present' ? 'bg-success' : 'bg-danger'}">${a.status === 'present' ? 'حاضر' : 'غیر حاضر'}</span></td>
                                    `;
                                    ra.appendChild(row);
                                });
                            }
                            
                            // Populate recent payments
                            const recentPayments = fees.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                            const rp = document.getElementById('recentPayments');
                            
                            if (recentPayments.length === 0) {
                                rp.innerHTML = '<tr><td colspan="3">کوئی ادائیگی ریکارڈ نہیں</td></tr>';
                            } else {
                                recentPayments.forEach(f => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${f.date}</td>
                                        <td>Rs. ${f.amount}</td>
                                        <td>${f.description || '-'}</td>
                                    `;
                                    rp.appendChild(row);
                                });
                            }
                        };
                    };
                }
            };
        }
        
        function exportStudentsCsv() {
            const t = db.transaction(['students'], 'readonly');
            const s = t.objectStore('students');
            const r = s.getAll();
            
            r.onsuccess = function() {
                const students = r.result;
                if (students.length === 0) {
                    alert('برآمد کرنے کے لیے کوئی ڈیٹا نہیں ہے');
                    return;
                }
                
                let csvContent = 'ID,Name,Father Name,Age,Class,Admission Date,Contact,Address\n';
                
                students.forEach(student => {
                    const row = [
                        student.id,
                        `"${student.name || ''}"`,
                        `"${student.fatherName || ''}"`,
                        student.age || '',
                        `"${student.class || ''}"`,
                        student.admissionDate || '',
                        `"${student.contact || ''}"`,
                        `"${student.address || ''}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'طلاب.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }
        
        // Teachers Management
        function loadTeachers(c) {
            c.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>اساتذہ کا انتظام</h2>
                    <button class="btn btn-primary" onclick="showTeacherForm()">
                        <i class="bi bi-plus-circle"></i> نیا استاد
                    </button>
                </div>
                
                <div id="teacherForm" style="display: none;" class="card mb-4">
                    <div class="card-header">
                        <h5 id="teacherFormTitle">نیا استاد</h5>
                    </div>
                    <div class="card-body">
                        <form id="addTeacherForm">
                            <input type="hidden" id="teacherId">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="teacherName" class="form-label">نام</label>
                                    <input type="text" class="form-control" id="teacherName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="teacherQualification" class="form-label">تعلیمی قابلیت</label>
                                    <input type="text" class="form-control" id="teacherQualification">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="teacherSpecialization" class="form-label">تخصص</label>
                                    <input type="text" class="form-control" id="teacherSpecialization">
                                </div>
                                <div class="col-md-6">
                                    <label for="joiningDate" class="form-label">شمولیت کی تاریخ</label>
                                    <input type="date" class="form-control" id="joiningDate" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="teacherContact" class="form-label">رابطہ نمبر</label>
                                    <input type="text" class="form-control" id="teacherContact">
                                </div>
                                <div class="col-md-6">
                                    <label for="teacherAddress" class="form-label">پتہ</label>
                                    <textarea class="form-control" id="teacherAddress" rows="2"></textarea>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="monthlySalary" class="form-label">ماہانہ تنخواہ</label>
                                    <input type="number" class="form-control" id="monthlySalary">
                                </div>
                            </div>
                            
                            <div id="teacherExtraFields"></div>
                            
                            <div class="mt-3">
                                <button type="button" class="btn btn-secondary" onclick="addTeacherExtraField()">
                                    <i class="bi bi-plus-circle"></i> اضافی فیلڈ
                                </button>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-3">
                                <button type="button" class="btn btn-secondary me-2" onclick="cancelTeacherForm()">منسوخ</button>
                                <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>اساتذہ کی فہرست</h5>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="teacherSearch" placeholder="تلاش کریں...">
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportTeachersCsv()">
                                    <i class="bi bi-download"></i> CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>نام</th>
                                        <th>تعلیمی قابلیت</th>
                                        <th>تخصص</th>
                                        <th>شمولیت کی تاریخ</th>
                                        <th>تنخواہ</th>
                                        <th>اقدامات</th>
                                    </tr>
                                </thead>
                                <tbody id="teachersList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('addTeacherForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveTeacher();
            });
            
            document.getElementById('teacherSearch').addEventListener('input', function() {
                loadTeachersList();
            });
            
            loadTeachersList();
        }
        
        function showTeacherForm() {
            document.getElementById('teacherForm').style.display = 'block';
            document.getElementById('teacherFormTitle').textContent = 'نیا استاد';
            document.getElementById('addTeacherForm').reset();
            document.getElementById('teacherId').value = '';
            document.getElementById('teacherExtraFields').innerHTML = '';
        }
        
        function cancelTeacherForm() {
            document.getElementById('teacherForm').style.display = 'none';
        }
        
        function addTeacherExtraField() {
            const e = document.getElementById('teacherExtraFields');
            const i = e.children.length;
            
            const f = document.createElement('div');
            f.className = 'row mt-3';
            f.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" id="teacherFieldName${i}" placeholder="فیلڈ کا نام">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" id="teacherFieldValue${i}" placeholder="فیلڈ کی قیمت">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger" onclick="this.parentNode.parentNode.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            e.appendChild(f);
        }
        
        function loadTeachersList() {
            const t = db.transaction(['teachers'], 'readonly');
            const s = t.objectStore('teachers');
            const r = s.getAll();
            
            r.onsuccess = function() {
                let teachers = r.result;
                const searchText = document.getElementById('teacherSearch').value.toLowerCase();
                
                if (searchText) {
                    teachers = teachers.filter(teacher => 
                        teacher.name.toLowerCase().includes(searchText) || 
                        (teacher.qualification && teacher.qualification.toLowerCase().includes(searchText)) ||
                        (teacher.specialization && teacher.specialization.toLowerCase().includes(searchText))
                    );
                }
                
                const l = document.getElementById('teachersList');
                l.innerHTML = '';
                
                teachers.forEach((teacher, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${teacher.name}</td>
                        <td>${teacher.qualification || '-'}</td>
                        <td>${teacher.specialization || '-'}</td>
                        <td>${teacher.joiningDate || '-'}</td>
                        <td>${teacher.salary ? 'Rs. ' + teacher.salary : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btn-action" onclick="editTeacher(${teacher.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteTeacher(${teacher.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-info btn-action" onclick="viewTeacherDetails(${teacher.id})">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    `;
                    l.appendChild(row);
                });
                
                if (teachers.length === 0) {
                    l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی استاد نہیں ملا</td></tr>';
                }
            };
        }
        
        function saveTeacher() {
            const i = document.getElementById('teacherId').value;
            const extraFields = {};
            const ef = document.getElementById('teacherExtraFields');
            
            for (let i = 0; i < ef.children.length; i++) {
                const name = document.getElementById(`teacherFieldName${i}`).value;
                const value = document.getElementById(`teacherFieldValue${i}`).value;
                if (name && value) {
                    extraFields[name] = value;
                }
            }
            
            const teacher = {
                name: document.getElementById('teacherName').value,
                qualification: document.getElementById('teacherQualification').value,
                specialization: document.getElementById('teacherSpecialization').value,
                joiningDate: document.getElementById('joiningDate').value,
                contact: document.getElementById('teacherContact').value,
                address: document.getElementById('teacherAddress').value,
                salary: document.getElementById('monthlySalary').value,
                extraFields: extraFields
            };
            
            const t = db.transaction(['teachers'], 'readwrite');
            const s = t.objectStore('teachers');
            
            if (i) {
                teacher.id = parseInt(i);
                s.put(teacher);
            } else {
                s.add(teacher);
            }
            
            t.oncomplete = function() {
                document.getElementById('teacherForm').style.display = 'none';
                loadTeachersList();
                alert(i ? 'استاد کی معلومات اپڈیٹ ہو گئیں' : 'نیا استاد شامل کر دیا گیا');
            };
            
            t.onerror = function(e) {
                console.error('Transaction error:', e.target.error);
                alert('استاد کو محفوظ کرنے میں خرابی');
            };
        }
        
        function editTeacher(id) {
            const t = db.transaction(['teachers'], 'readonly');
            const s = t.objectStore('teachers');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const teacher = r.result;
                if (teacher) {
                    document.getElementById('teacherFormTitle').textContent = 'استاد کی تفصیلات میں ترمیم کریں';
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name || '';
                    document.getElementById('teacherQualification').value = teacher.qualification || '';
                    document.getElementById('teacherSpecialization').value = teacher.specialization || '';
                    document.getElementById('joiningDate').value = teacher.joiningDate || '';
                    document.getElementById('teacherContact').value = teacher.contact || '';
                    document.getElementById('teacherAddress').value = teacher.address || '';
                    document.getElementById('monthlySalary').value = teacher.salary || '';
                    
                    // Extra fields
                    const ef = document.getElementById('teacherExtraFields');
                    ef.innerHTML = '';
                    
                    if (teacher.extraFields) {
                        let i = 0;
                        for (const [key, value] of Object.entries(teacher.extraFields)) {
                            const f = document.createElement('div');
                            f.className = 'row mt-3';
                            f.innerHTML = `
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="teacherFieldName${i}" placeholder="فیلڈ کا نام" value="${key}">
                                </div>
                                <div class="col-md-5">
                                    <input type="text" class="form-control" id="teacherFieldValue${i}" placeholder="فیلڈ کی قیمت" value="${value}">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger" onclick="this.parentNode.parentNode.remove()">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                            
                            ef.appendChild(f);
                            i++;
                        }
                    }
                    
                    document.getElementById('teacherForm').style.display = 'block';
                }
            };
        }
        
        function deleteTeacher(id) {
            if (confirm('کیا آپ واقعی اس استاد کو حذف کرنا چاہتے ہیں؟')) {
                const t = db.transaction(['teachers'], 'readwrite');
                const s = t.objectStore('teachers');
                s.delete(id);
                
                t.oncomplete = function() {
                    loadTeachersList();
                    alert('استاد کامیابی سے حذف کر دیا گیا');
                };
                
                t.onerror = function(e) {
                    console.error('Delete error:', e.target.error);
                    alert('استاد کو حذف کرنے میں خرابی');
                };
            }
        }
        
        function viewTeacherDetails(id) {
            const t = db.transaction(['teachers', 'classes', 'salary'], 'readonly');
            const s = t.objectStore('teachers');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const teacher = r.result;
                if (teacher) {
                    let extraFieldsHtml = '';
                    if (teacher.extraFields) {
                        for (const [key, value] of Object.entries(teacher.extraFields)) {
                            extraFieldsHtml += `
                                <tr>
                                    <th>${key}</th>
                                    <td>${value}</td>
                                </tr>
                            `;
                        }
                    }
                    
                    // Get assigned classes
                    const cs = t.objectStore('classes');
                    const cr = cs.getAll();
                    
                    cr.onsuccess = function() {
                        const classes = cr.result.filter(c => c.teacherId === teacher.id);
                        
                        // Get salary payments
                        const ss = t.objectStore('salary');
                        const si = ss.index('teacherId');
                        const sr = si.getAll(IDBKeyRange.only(teacher.id));
                        
                        sr.onsuccess = function() {
                            const salaries = sr.result;
                            const totalPaid = salaries.reduce((sum, salary) => sum + parseFloat(salary.amount), 0);
                            
                            const c = document.getElementById('content');
                            c.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>استاد کی تفصیلات</h2>
                                    <button class="btn btn-secondary" onclick="n('teachers')">
                                        <i class="bi bi-arrow-left"></i> واپس
                                    </button>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5>${teacher.name}</h5>
                                            </div>
                                            <div class="card-body">
                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <th>نام</th>
                                                            <td>${teacher.name || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>تعلیمی قابلیت</th>
                                                            <td>${teacher.qualification || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>تخصص</th>
                                                            <td>${teacher.specialization || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>شمولیت کی تاریخ</th>
                                                            <td>${teacher.joiningDate || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>رابطہ</th>
                                                            <td>${teacher.contact || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>پتہ</th>
                                                            <td>${teacher.address || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>ماہانہ تنخواہ</th>
                                                            <td>${teacher.salary ? 'Rs. ' + teacher.salary : '-'}</td>
                                                        </tr>
                                                        ${extraFieldsHtml}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5>تفویض کردہ کلاسز</h5>
												
</div>
<div class="card-body">
<ul class="list-group">
${classes.length > 0 
                                                        ? classes.map(c => `<li class="list-group-item">${c.name}</li>`).join('')
: '<li class="list-group-item">کوئی کلاس تفویض نہیں کی گئی</li>'
}
</ul>
</div>
</div>

                                        <div class="card">
                                            <div class="card-header">
                                                <h5>تنخواہ</h5>
                                            </div>
                                            <div class="card-body text-center">
                                                <h3>Rs. ${totalPaid.toFixed(2)}</h3>
                                                <p>کل ادائیگی: ${salaries.length}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5>حالیہ تنخواہ ادائیگی</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>تاریخ</th>
                                                                <th>رقم</th>
                                                                <th>مہینہ</th>
                                                                <th>تفصیلات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="recentSalaries"></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Populate recent salaries
                            const recentSalaries = salaries.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                            const rs = document.getElementById('recentSalaries');
                            
                            if (recentSalaries.length === 0) {
                                rs.innerHTML = '<tr><td colspan="4">کوئی تنخواہ ریکارڈ نہیں</td></tr>';
                            } else {
                                recentSalaries.forEach(s => {
                                    const row = document.createElement('tr');
                                    row.innerHTML = `
                                        <td>${s.date}</td>
                                        <td>Rs. ${s.amount}</td>
                                        <td>${s.month || '-'}</td>
                                        <td>${s.description || '-'}</td>
                                    `;
                                    rs.appendChild(row);
                                });
                            }
                        };
                    };
                }
            };
        }
        
        function exportTeachersCsv() {
            const t = db.transaction(['teachers'], 'readonly');
            const s = t.objectStore('teachers');
            const r = s.getAll();
            
            r.onsuccess = function() {
                const teachers = r.result;
                if (teachers.length === 0) {
                    alert('برآمد کرنے کے لیے کوئی ڈیٹا نہیں ہے');
                    return;
                }
                
                let csvContent = 'ID,Name,Qualification,Specialization,Joining Date,Contact,Address,Salary\n';
                
                teachers.forEach(teacher => {
                    const row = [
                        teacher.id,
                        `"${teacher.name || ''}"`,
                        `"${teacher.qualification || ''}"`,
                        `"${teacher.specialization || ''}"`,
                        teacher.joiningDate || '',
                        `"${teacher.contact || ''}"`,
                        `"${teacher.address || ''}"`,
                        teacher.salary || ''
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'اساتذہ.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }
        
function loadClasses(c) {
    try {
        c.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>کلاسز کا انتظام</h2>
                <button class="btn btn-primary" onclick="showClassForm()">
                    <i class="bi bi-plus-circle"></i> نئی کلاس
                </button>
            </div>
            
            <div id="classForm" style="display: none;" class="card mb-4">
                <div class="card-header">
                    <h5 id="classFormTitle">نئی کلاس</h5>
                </div>
                <div class="card-body">
                    <form id="addClassForm">
                        <input type="hidden" id="classId">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="className" class="form-label">کلاس کا نام</label>
                                <input type="text" class="form-control" id="className" required>
                            </div>
                            <div class="col-md-6">
                                <label for="classTeacher" class="form-label">استاد</label>
                                <select class="form-select" id="classTeacher" required>
                                    <option value="">استاد منتخب کریں</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="classTiming" class="form-label">اوقات</label>
                                <input type="text" class="form-control" id="classTiming">
                            </div>
                            <div class="col-md-6">
                                <label for="classRoom" class="form-label">کمرہ</label>
                                <input type="text" class="form-control" id="classRoom">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <label for="classDescription" class="form-label">تفصیلات</label>
                                <textarea class="form-control" id="classDescription" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end mt-3">
                            <button type="button" class="btn btn-secondary me-2" onclick="cancelClassForm()">منسوخ</button>
                            <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5>کلاسز کی فہرست</h5>
                        <div class="d-flex">
                            <input type="text" class="form-control form-control-sm me-2" id="classSearch" placeholder="تلاش کریں...">
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportClassesCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>کلاس کا نام</th>
                                    <th>استاد</th>
                                    <th>اوقات</th>
                                    <th>کمرہ</th>
                                    <th>اقدامات</th>
                                </tr>
                            </thead>
                            <tbody id="classesList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('addClassForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveClass();
        });

        document.getElementById('classSearch').addEventListener('input', function() {
            loadClassesList();
        });

        function tryLoadTeacherOptions(attempts = 5, delay = 1000) {
            try {
                const content = document.getElementById('content');
                const form = document.getElementById('addClassForm');
                if (!content || !form || !content.contains(form)) {
                    if (attempts > 1) {
                        setTimeout(() => tryLoadTeacherOptions(attempts - 1, delay), delay);
                        return;
                    }
                    loadClassesList();
                    return;
                }

                let classTeacherElement = document.getElementById('classTeacher');
                if (!classTeacherElement) {
                    const div = form.querySelector('.col-md-6:nth-child(2)');
                    if (div) {
                        const select = document.createElement('select');
                        select.id = 'classTeacher';
                        select.className = 'form-select';
                        select.required = true;
                        select.innerHTML = '<option value="">استاد منتخب کریں</option>';
                        div.appendChild(select);
                        classTeacherElement = select;
                    }
                }

                if (classTeacherElement && document.body.contains(classTeacherElement)) {
                    loadTeacherOptions('classTeacher').then(() => {
                        loadClassesList();
                    });
                } else if (attempts > 1) {
                    setTimeout(() => tryLoadTeacherOptions(attempts - 1, delay), delay);
                } else {
                    loadClassesList();
                }
            } catch (error) {
                if (attempts > 1) {
                    setTimeout(() => tryLoadTeacherOptions(attempts - 1, delay), delay);
                } else {
                    loadClassesList();
                }
            }
        }

        if (document.readyState === 'complete') {
            tryLoadTeacherOptions();
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                tryLoadTeacherOptions();
            }, { once: true });
        }

    } catch (error) {
        // Handle error silently
    }
}


function loadTeacherOptions(elementId) {
    try {
        const s = document.getElementById(elementId);
        if (!s || !document.body.contains(s)) {
            return Promise.resolve();
        }
        s.innerHTML = '<option value="">استاد منتخب کریں</option>';

        const t = db.transaction(['teachers'], 'readonly');
        const st = t.objectStore('teachers');
        const r = st.getAll();

        r.onsuccess = function() {
            const teachers = r.result;
            teachers.sort((a, b) => a.name.localeCompare(b.name));

            teachers.forEach(teacher => {
                const o = document.createElement('option');
                o.value = teacher.id;
                o.textContent = teacher.name;
                s.appendChild(o);
            });
        };

        r.onerror = function() {
            // Handle database error silently
        };

        return Promise.resolve();
    } catch (error) {
        return Promise.resolve();
    }
}

function showClassForm() {
    try {
        document.getElementById('classForm').style.display = 'block';
        document.getElementById('classFormTitle').textContent = 'نئی کلاس';
        document.getElementById('addClassForm').reset();
        document.getElementById('classId').value = '';

        function tryLoadTeacherOptionsForForm(attempts = 5, delay = 1000) {
            try {
                const content = document.getElementById('content');
                const form = document.getElementById('addClassForm');
                if (!content || !form || !content.contains(form)) {
                    if (attempts > 1) {
                        setTimeout(() => tryLoadTeacherOptionsForForm(attempts - 1, delay), delay);
                    }
                    return;
                }

                let classTeacherElement = document.getElementById('classTeacher');
                if (!classTeacherElement) {
                    const div = form.querySelector('.col-md-6:nth-child(2)');
                    if (div) {
                        const select = document.createElement('select');
                        select.id = 'classTeacher';
                        select.className = 'form-select';
                        select.required = true;
                        select.innerHTML = '<option value="">استاد منتخب کریں</option>';
                        div.appendChild(select);
                        classTeacherElement = select;
                    }
                }

                if (classTeacherElement && document.body.contains(classTeacherElement)) {
                    loadTeacherOptions('classTeacher');
                } else if (attempts > 1) {
                    setTimeout(() => tryLoadTeacherOptionsForForm(attempts - 1, delay), delay);
                }
            } catch (error) {
                if (attempts > 1) {
                    setTimeout(() => tryLoadTeacherOptionsForForm(attempts - 1, delay), delay);
                }
            }
        }

        if (document.readyState === 'complete') {
            tryLoadTeacherOptionsForForm();
        } else {
            document.addEventListener('DOMContentLoaded', () => {
                tryLoadTeacherOptionsForForm();
            }, { once: true });
        }
    } catch (error) {
        // Handle error silently
    }
}      

        
        function cancelClassForm() {
            document.getElementById('classForm').style.display = 'none';
        }
        
        function addClassExtraField() {
            const e = document.getElementById('classExtraFields');
            const i = e.children.length;
            
            const f = document.createElement('div');
            f.className = 'row mt-3';
            f.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" id="classFieldName${i}" placeholder="فیلڈ کا نام">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" id="classFieldValue${i}" placeholder="فیلڈ کی قیمت">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger" onclick="this.parentNode.parentNode.remove()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
            
            e.appendChild(f);
        }
        
        function loadClassesList() {
            const t = db.transaction(['classes', 'teachers', 'students'], 'readonly');
            const cs = t.objectStore('classes');
            const ts = t.objectStore('teachers');
            const ss = t.objectStore('students');
            const cr = cs.getAll();
            
            cr.onsuccess = function() {
                let classes = cr.result;
                const searchText = document.getElementById('classSearch').value.toLowerCase();
                
                if (searchText) {
                    classes = classes.filter(c => 
                        c.name.toLowerCase().includes(searchText)
                    );
                }
                
                const l = document.getElementById('classesList');
                l.innerHTML = '';
                
                let processed = 0;
                classes.forEach((c, index) => {
                    // Get teacher name
                    let teacherName = '-';
                    if (c.teacherId) {
                        const tr = ts.get(parseInt(c.teacherId));
                        tr.onsuccess = function() {
                            const teacher = tr.result;
                            if (teacher) {
                                teacherName = teacher.name;
                            }
                            
                            // Get student count
                            const si = ss.index('class');
                            const sr = si.count(IDBKeyRange.only(c.name));
                            
                            sr.onsuccess = function() {
                                const studentCount = sr.result;
                                
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${index + 1}</td>
                                    <td>${c.name}</td>
                                    <td>${teacherName}</td>
                                    <td>${c.timing || '-'}</td>
                                    <td>${c.room || '-'}</td>
                                    <td>${studentCount}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary btn-action" onclick="editClass(${c.id})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger btn-action" onclick="deleteClass(${c.id})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        <button class="btn btn-sm btn-info btn-action" onclick="viewClassDetails(${c.id})">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                `;
                                l.appendChild(row);
                                
                                processed++;
                                if (processed === classes.length && classes.length === 0) {
                                    l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی کلاس/درس نہیں ملا</td></tr>';
                                }
                            };
                        };
                    } else {
                        // Get student count without teacher
                        const si = ss.index('class');
                        const sr = si.count(IDBKeyRange.only(c.name));
                        
                        sr.onsuccess = function() {
                            const studentCount = sr.result;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${c.name}</td>
                                <td>${teacherName}</td>
                                <td>${c.timing || '-'}</td>
                                <td>${c.room || '-'}</td>
                                <td>${studentCount}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary btn-action" onclick="editClass(${c.id})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteClass(${c.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info btn-action" onclick="viewClassDetails(${c.id})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            `;
                            l.appendChild(row);
                            
                            processed++;
                            if (processed === classes.length && classes.length === 0) {
                                l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی کلاس/درس نہیں ملا</td></tr>';
                            }
                        };
                    }
                });
                
                if (classes.length === 0) {
                    l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی کلاس/درس نہیں ملا</td></tr>';
                }
            };
        }
        

        
        function deleteClass(id) {
            if (confirm('کیا آپ واقعی اس کلاس/درس کو حذف کرنا چاہتے ہیں؟')) {
                const t = db.transaction(['classes'], 'readwrite');
                const s = t.objectStore('classes');
                s.delete(id);
                
                t.oncomplete = function() {
                    loadClassesList();
                    alert('کلاس/درس کامیابی سے حذف کر دی گئی');
                };
                
                t.onerror = function(e) {
                    console.error('Delete error:', e.target.error);
                    alert('کلاس/درس کو حذف کرنے میں خرابی');
                };
            }
        }
        
        function viewClassDetails(id) {
            const t = db.transaction(['classes', 'teachers', 'students'], 'readonly');
            const cs = t.objectStore('classes');
            const ts = t.objectStore('teachers');
            const ss = t.objectStore('students');
            const r = cs.get(id);
            
            r.onsuccess = function() {
                const classObj = r.result;
                if (classObj) {
                    let extraFieldsHtml = '';
                    if (classObj.extraFields) {
                        for (const [key, value] of Object.entries(classObj.extraFields)) {
                            extraFieldsHtml += `
                                <tr>
                                    <th>${key}</th>
                                    <td>${value}</td>
                                </tr>
                            `;
                        }
                    }
                    
                    // Get teacher details
                    let teacherDetails = null;
                    if (classObj.teacherId) {
                        const tr = ts.get(parseInt(classObj.teacherId));
                        tr.onsuccess = function() {
                            teacherDetails = tr.result;
                            
                            // Get students in this class
                            const si = ss.index('class');
                            const sr = si.getAll(IDBKeyRange.only(classObj.name));
                            
                            sr.onsuccess = function() {
                                const students = sr.result;
                                
                                const c = document.getElementById('content');
                                c.innerHTML = `
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h2>کلاس/درس کی تفصیلات</h2>
                                        <button class="btn btn-secondary" onclick="n('classes')">
                                            <i class="bi bi-arrow-left"></i> واپس
                                        </button>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5>${classObj.name}</h5>
                                                </div>
                                                <div class="card-body">
                                                    <table class="table">
                                                        <tbody>
                                                            <tr>
                                                                <th>کلاس/درس کا نام</th>
                                                                <td>${classObj.name || '-'}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>استاد</th>
                                                                <td>${teacherDetails ? teacherDetails.name : '-'}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>اوقات</th>
                                                                <td>${classObj.timing || '-'}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>کمرہ</th>
                                                                <td>${classObj.room || '-'}</td>
                                                            </tr>
                                                            <tr>
                                                                <th>تفصیلات</th>
                                                                <td>${classObj.description || '-'}</td>
                                                            </tr>
                                                            ${extraFieldsHtml}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5>استاد کی تفصیلات</h5>
                                                </div>
                                                <div class="card-body">
                                                    ${teacherDetails ? `
                                                        <div class="text-center mb-3">
                                                            <h5>${teacherDetails.name}</h5>
                                                            ${teacherDetails.qualification ? `<p>${teacherDetails.qualification}</p>` : ''}
                                                        </div>
                                                        <div>
                                                            <p><strong>تخصص:</strong> ${teacherDetails.specialization || '-'}</p>
                                                            <p><strong>رابطہ:</strong> ${teacherDetails.contact || '-'}</p>
                                                            <button class="btn btn-sm btn-info" onclick="viewTeacherDetails(${teacherDetails.id})">مکمل پروفائل دیکھیں</button>
                                                        </div>
                                                    ` : '<p class="text-center">کوئی استاد تفویض نہیں کیا گیا</p>'}
                                                </div>
                                            </div>
                                            
                                            <div class="card">
                                                <div class="card-header">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h5>طلاب کی تعداد</h5>
                                                        <span class="badge bg-primary">${students.length}</span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="viewClassStudents('${classObj.name}')">
                                                        طلاب کی فہرست دیکھیں
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            };
                        };
                    } else {
                        // No teacher assigned
                        // Get students in this class
                        const si = ss.index('class');
                        const sr = si.getAll(IDBKeyRange.only(classObj.name));
                        
                        sr.onsuccess = function() {
                            const students = sr.result;
                            
                            const c = document.getElementById('content');
                            c.innerHTML = `
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h2>کلاس/درس کی تفصیلات</h2>
                                    <button class="btn btn-secondary" onclick="n('classes')">
                                        <i class="bi bi-arrow-left"></i> واپس
                                    </button>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5>${classObj.name}</h5>
                                            </div>
                                            <div class="card-body">
                                                <table class="table">
                                                    <tbody>
                                                        <tr>
                                                            <th>کلاس/درس کا نام</th>
                                                            <td>${classObj.name || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>استاد</th>
                                                            <td>-</td>
                                                        </tr>
                                                        <tr>
                                                            <th>اوقات</th>
                                                            <td>${classObj.timing || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>کمرہ</th>
                                                            <td>${classObj.room || '-'}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>تفصیلات</th>
                                                            <td>${classObj.description || '-'}</td>
                                                        </tr>
                                                        ${extraFieldsHtml}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <h5>طلاب کی تعداد</h5>
                                                    <span class="badge bg-primary">${students.length}</span>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <p class="text-center mb-3">کوئی استاد تفویض نہیں کیا گیا</p>
                                                <button class="btn btn-sm btn-outline-primary w-100" onclick="viewClassStudents('${classObj.name}')">
                                                    طلاب کی فہرست دیکھیں
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        };
                    }
                }
            };
        }
        
        function viewClassStudents(className) {
            const t = db.transaction(['students'], 'readonly');
            const s = t.objectStore('students');
            const i = s.index('class');
            const r = i.getAll(IDBKeyRange.only(className));
            
            r.onsuccess = function() {
                const students = r.result;
                
                const c = document.getElementById('content');
                c.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>${className} - طلاب کی فہرست</h2>
                        <button class="btn btn-secondary" onclick="viewClassDetails()">
                            <i class="bi bi-arrow-left"></i> واپس
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>طلاب (${students.length})</h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportClassStudentsCsv('${className}')">
                                    <i class="bi bi-download"></i> CSV
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>نام</th>
                                            <th>والد کا نام</th>
                                            <th>عمر</th>
                                            <th>داخلے کی تاریخ</th>
                                            <th>رابطہ</th>
                                            <th>اقدامات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="classStudentsList">
                                        ${students.length === 0 ? '<tr><td colspan="7" class="text-center">اس کلاس میں کوئی طالب علم نہیں ہے</td></tr>' : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
                
                const l = document.getElementById('classStudentsList');
                
                if (students.length > 0) {
                    students.forEach((student, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${student.name}</td>
                            <td>${student.fatherName || '-'}</td>
                            <td>${student.age || '-'}</td>
                            <td>${student.admissionDate || '-'}</td>
                            <td>${student.contact || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-info btn-action" onclick="viewStudentDetails(${student.id})">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        `;
                        l.appendChild(row);
                    });
                }
            };
        }
        
        function exportClassesCsv() {
            const t = db.transaction(['classes', 'teachers'], 'readonly');
            const cs = t.objectStore('classes');
            const ts = t.objectStore('teachers');
            const r = cs.getAll();
            
            r.onsuccess = function() {
                const classes = r.result;
                if (classes.length === 0) {
                    alert('برآمد کرنے کے لیے کوئی ڈیٹا نہیں ہے');
                    return;
                }
                
                let teacherNames = {};
                let processed = 0;
                
                classes.forEach(c => {
                    if (c.teacherId) {
                        const tr = ts.get(parseInt(c.teacherId));
                        tr.onsuccess = function() {
                            const teacher = tr.result;
                            teacherNames[c.teacherId] = teacher ? teacher.name : '';
                            
                            processed++;
                            if (processed === classes.length) {
                                generateClassesCsv(classes, teacherNames);
                            }
                        };
                    } else {
                        processed++;
                        if (processed === classes.length) {
                            generateClassesCsv(classes, teacherNames);
                        }
                    }
                });
            };
        }
        
        function generateClassesCsv(classes, teacherNames) {
            let csvContent = 'ID,Name,Teacher,Timing,Room,Description\n';
            
            classes.forEach(c => {
                const row = [
                    c.id,
                    `"${c.name || ''}"`,
                    `"${c.teacherId ? teacherNames[c.teacherId] || '' : ''}"`,
                    `"${c.timing || ''}"`,
                    `"${c.room || ''}"`,
                    `"${c.description || ''}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'کلاسز.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportClassStudentsCsv(className) {
            const t = db.transaction(['students'], 'readonly');
            const s = t.objectStore('students');
            const i = s.index('class');
            const r = i.getAll(IDBKeyRange.only(className));
            
            r.onsuccess = function() {
                const students = r.result;
                if (students.length === 0) {
                    alert('برآمد کرنے کے لیے کوئی ڈیٹا نہیں ہے');
                    return;
                }
                
                let csvContent = 'ID,Name,Father Name,Age,Admission Date,Contact,Address\n';
                
                students.forEach(student => {
                    const row = [
                        student.id,
                        `"${student.name || ''}"`,
                        `"${student.fatherName || ''}"`,
                        student.age || '',
                        student.admissionDate || '',
                        `"${student.contact || ''}"`,
                        `"${student.address || ''}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${className}-طلاب.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
        }
        
        // Attendance Management
        function loadAttendance(c) {
            c.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>حاضری کا انتظام</h2>
                    <div>
                        <button class="btn btn-success me-2" onclick="markAttendance()">
                            <i class="bi bi-calendar-check"></i> حاضری مارک کریں
                        </button>
                        <button class="btn btn-primary" onclick="viewAttendanceReport()">
                            <i class="bi bi-file-text"></i> حاضری رپورٹ
                        </button>
                    </div>
                </div>
                
                <div id="attendanceContent"></div>
            `;
            
            // Show today's attendance by default
            viewTodayAttendance();
        }
        
        function viewTodayAttendance() {
            const today = new Date().toISOString().split('T');
            
            const ac = document.getElementById('attendanceContent');
            ac.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5>آج کی حاضری - ${today}</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                <select class="form-select" id="attendanceClassFilter">
                                    <option value="">سب کلاسز</option>
                                </select>
                            </div>
                            <div class="d-flex">
                                <input type="text" class="form-control form-control-sm me-2" id="attendanceSearch" placeholder="تلاش کریں...">
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportTodayAttendanceCsv()">
                                    <i class="bi bi-download"></i> CSV
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>طالب علم</th>
                                        <th>کلاس</th>
                                        <th>حاضری</th>
                                        <th>تاریخ</th>
                                        <th>اقدامات</th>
                                    </tr>
                                </thead>
                                <tbody id="todayAttendanceList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Load class filter options
            loadClassOptions('attendanceClassFilter');
            
            // Add event listeners
            document.getElementById('attendanceClassFilter').addEventListener('change', function() {
                loadTodayAttendanceList();
            });
            
            document.getElementById('attendanceSearch').addEventListener('input', function() {
                loadTodayAttendanceList();
            });
            
            // Load today's attendance
            loadTodayAttendanceList();
        }
        
        function loadTodayAttendanceList() {
            const today = new Date().toISOString().split('T');
            
            const t = db.transaction(['attendance', 'students'], 'readonly');
            const as = t.objectStore('attendance');
            const ss = t.objectStore('students');
            const ai = as.index('date');
            const r = ai.getAll(IDBKeyRange.only(today));
            
            r.onsuccess = function() {
                let attendances = r.result;
                const classFilter = document.getElementById('attendanceClassFilter').value;
                const searchText = document.getElementById('attendanceSearch').value.toLowerCase();
                
                const l = document.getElementById('todayAttendanceList');
                l.innerHTML = '';
                
                if (attendances.length === 0) {
                    l.innerHTML = '<tr><td colspan="6" class="text-center">آج کی کوئی حاضری نہیں ہے</td></tr>';
                    return;
                }
                
                let processed = 0;
                attendances.forEach((attendance, index) => {
                    const sr = ss.get(attendance.studentId);
                    sr.onsuccess = function() {
                        const student = sr.result;
                        if (student) {
                            // Apply filters
                            if ((classFilter && student.class !== classFilter) ||
                                (searchText && !student.name.toLowerCase().includes(searchText))) {
                                processed++;
                                if (processed === attendances.length && l.innerHTML === '') {
                                    l.innerHTML = '<tr><td colspan="6" class="text-center">کوئی حاضری نہیں ملی</td></tr>';
                                }
                                return;
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${student.name}</td>
                                <td>${student.class || '-'}</td>
                                <td>
                                    <span class="badge ${attendance.status === 'present' ? 'bg-success' : 'bg-danger'}">
                                        ${attendance.status === 'present' ? 'حاضر' : 'غیر حاضر'}
                                    </span>
                                </td>
                                <td>${attendance.date}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="changeAttendanceStatus(${attendance.id})">
                                        <i class="bi bi-arrow-repeat"></i> تبدیل کریں
                                    </button>
                                </td>
                            `;
                            l.appendChild(row);
                        }
                        
                        processed++;
                        if (processed === attendances.length && l.innerHTML === '') {
                            l.innerHTML = '<tr><td colspan="6" class="text-center">کوئی حاضری نہیں ملی</td></tr>';
                        }
                    };
                });
            };
        }
        
        function changeAttendanceStatus(id) {
            const t = db.transaction(['attendance'], 'readwrite');
            const s = t.objectStore('attendance');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const attendance = r.result;
                if (attendance) {
                    attendance.status = attendance.status === 'present' ? 'absent' : 'present';
                    s.put(attendance);
                    
                    t.oncomplete = function() {
                        loadTodayAttendanceList();
                    };
                }
            };
        }
        
function markAttendance() {
    const date = document.getElementById('attendanceDate').value;
    const className = document.getElementById('attendanceClass').value;
    const checkboxes = document.querySelectorAll('.attendance-checkbox');
    
    if (!date || !className) {
        alert('تاریخ اور کلاس منتخب کریں');
        return;
    }

    const t = db.transaction(['attendance'], 'readwrite');
    const s = t.objectStore('attendance');
    
    checkboxes.forEach(checkbox => {
        const studentId = parseInt(checkbox.value);
        const status = checkbox.checked ? 'present' : 'absent';
        
        const attendance = {
            studentId,
            date,
            class: className,
            status
        };
        
        s.add(attendance);
    });
    
    t.oncomplete = function() {
        alert('حاضری کامیابی سے ریکارڈ کر لی گئی');
        viewAttendanceReport();
    };
    
    t.onerror = function(e) {
        console.error('Attendance error:', e.target.error);
        alert('حاضری ریکارڈ کرنے میں خرابی');
    };
}
        
        function loadStudentsForAttendance() {
            const classFilter = document.getElementById('markAttendanceClassFilter').value;
            const attendanceDate = document.getElementById('attendanceDate').value;
            
            if (!classFilter) {
                document.getElementById('markAttendanceForm').innerHTML = '<p class="text-center">کلاس منتخب کریں</p>';
                return;
            }
            
            const t = db.transaction(['students', 'attendance'], 'readonly');
            const ss = t.objectStore('students');
            const as = t.objectStore('attendance');
            const si = ss.index('class');
            const r = si.getAll(IDBKeyRange.only(classFilter));
            
            r.onsuccess = function() {
                const students = r.result;
                if (students.length === 0) {
                    document.getElementById('markAttendanceForm').innerHTML = '<p class="text-center">اس کلاس میں کوئی طالب علم نہیں ہے</p>';
                    return;
                }
                
                // Check if attendance already marked for this date
                const ai = as.index('date');
                const ar = ai.getAll(IDBKeyRange.only(attendanceDate));
                
                ar.onsuccess = function() {
                    const existingAttendance = ar.result;
                    const attendanceMap = {};
                    
                    existingAttendance.forEach(a => {
                        attendanceMap[a.studentId] = a.status;
                    });
                    
                    const maf = document.getElementById('markAttendanceForm');
                    maf.innerHTML = `
                        <form id="attendanceMarkingForm">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>طالب علم</th>
                                            <th>حاضری</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${students.map((student, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${student.name}</td>
                                                <td>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="attendance_${student.id}" id="present_${student.id}" value="present" ${attendanceMap[student.id] === 'present' ? 'checked' : ''}>
                                                        <label class="form-check-label" for="present_${student.id}">حاضر</label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input class="form-check-input" type="radio" name="attendance_${student.id}" id="absent_${student.id}" value="absent" ${attendanceMap[student.id] === 'absent' ? 'checked' : ''}>
                                                        <label class="form-check-label" for="absent_${student.id}">غیر حاضر</label>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <button type="button" class="btn btn-primary" onclick="markAllPresent()">سب کو حاضر مارک کریں</button>
                                <button type="submit" class="btn btn-success">حاضری محفوظ کریں</button>
                            </div>
                        </form>
                    `;
                    
                    document.getElementById('attendanceMarkingForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveAttendance(students);
                    });
                };
            };
        }
        
        function markAllPresent() {
            const form = document.getElementById('attendanceMarkingForm');
            const radios = form.querySelectorAll('input[type="radio"][value="present"]');
            radios.forEach(radio => {
                radio.checked = true;
            });
        }
        
        function saveAttendance(students) {
            const date = document.getElementById('attendanceDate').value;
            const t = db.transaction(['attendance'], 'readwrite');
            const s = t.objectStore('attendance');
            
            // First, delete any existing attendance for this date for these students
            const deletePromises = students.map(student => {
                return new Promise((resolve, reject) => {
                    const ai = s.index('date');
                    const r = ai.getAllKeys(IDBKeyRange.only(date));
                    
                    r.onsuccess = function() {
                        const keys = r.result;
                        const deletePromises = keys.map(key => {
                            return new Promise((res, rej) => {
                                const gr = s.get(key);
                                gr.onsuccess = function() {
                                    const attendance = gr.result;
                                    if (attendance && attendance.studentId === student.id) {
                                        const dr = s.delete(key);
                                        dr.onsuccess = res;
                                        dr.onerror = rej;
                                    } else {
                                        res();
                                    }
                                };
                                gr.onerror = rej;
                            });
                        });
                        
                        Promise.all(deletePromises).then(resolve).catch(reject);
                    };
                    
                    r.onerror = reject;
                });
            });
            
            Promise.all(deletePromises).then(() => {
                // Now add new attendance records
                students.forEach(student => {
                    const status = document.querySelector(`input[name="attendance_${student.id}"]:checked`);
                    if (status) {
                        const attendance = {
                            studentId: student.id,
                            date: date,
                            status: status.value
                        };
                        s.add(attendance);
                    }
                });
                
                t.oncomplete = function() {
                    alert('حاضری کامیابی سے محفوظ ہو گئی');
                    viewTodayAttendance();
                };
                
                t.onerror = function(e) {
                    console.error('Transaction error:', e.target.error);
                    alert('حاضری محفوظ کرنے میں خرابی');
                };
            }).catch(error => {
                console.error('Error deleting existing attendance:', error);
                alert('حاضری محفوظ کرنے میں خرابی');
            });
        }
        
        function viewAttendanceReport() {
            const ac = document.getElementById('attendanceContent');
            ac.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5>حاضری رپورٹ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">کلاس</label>
                                <select class="form-select" id="reportClassFilter">
                                    <option value="">سب کلاسز</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">طالب علم</label>
                                <select class="form-select" id="reportStudentFilter">
                                    <option value="">سب طلاب</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">تاریخ سے</label>
                                <input type="date" class="form-control" id="reportStartDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">تاریخ تک</label>
                                <input type="date" class="form-control" id="reportEndDate">
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <button class="btn btn-primary" onclick="generateAttendanceReport()">
                                <i class="bi bi-search"></i> رپورٹ بنائیں
                            </button>
                            <button class="btn btn-outline-secondary" id="exportReportBtn" style="display: none;" onclick="exportAttendanceReportCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                        <div id="attendanceReportResult"></div>
                    </div>
                </div>
            `;
            
            // Set default dates (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T');
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T');
            
            document.getElementById('reportStartDate').value = firstDay;
            document.getElementById('reportEndDate').value = lastDay;
            
            // Load class and student filter options
            loadClassOptions('reportClassFilter');
            loadStudentOptions('reportStudentFilter');
            
            // Add event listeners
            document.getElementById('reportClassFilter').addEventListener('change', function() {
                updateStudentOptions();
            });
        }
        
        function updateStudentOptions() {
            const classFilter = document.getElementById('reportClassFilter').value;
            const studentSelect = document.getElementById('reportStudentFilter');
            
            // Clear current options except first one
            while (studentSelect.options.length > 1) {
                studentSelect.remove(1);
            }
            
            if (!classFilter) {
                loadStudentOptions('reportStudentFilter');
                return;
            }
            
            const t = db.transaction(['students'], 'readonly');
            const s = t.objectStore('students');
            const i = s.index('class');
            const r = i.getAll(IDBKeyRange.only(classFilter));
            
            r.onsuccess = function() {
                const students = r.result;
                students.sort((a, b) => a.name.localeCompare(b.name));
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    studentSelect.appendChild(option);
                });
            };
        }
        
        function generateAttendanceReport() {
            const classId = document.getElementById('reportClassFilter').value;
            const studentId = document.getElementById('reportStudentFilter').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('تاریخیں منتخب کریں');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('شروع کی تاریخ آخری تاریخ سے پہلے ہونی چاہیے');
                return;
            }
            
            const t = db.transaction(['attendance', 'students', 'classes'], 'readonly');
            const as = t.objectStore('attendance');
            const ss = t.objectStore('students');
            const cs = t.objectStore('classes');
            
            // Get all attendance records in date range
            const ai = as.index('date');
            const range = IDBKeyRange.bound(startDate, endDate);
            const r = ai.getAll(range);
            
            r.onsuccess = function() {
                let attendances = r.result;
                
                // Filter by student if specified
                if (studentId) {
                    attendances = attendances.filter(a => a.studentId == studentId);
                    
                    // Get student details
                    const sr = ss.get(parseInt(studentId));
                    sr.onsuccess = function() {
                        const student = sr.result;
                        if (student) {
                            // Generate individual student report
                            generateStudentReport(student, attendances, startDate, endDate);
                        }
                    };
                }
                // Filter by class if specified
                else if (classId) {
                    // Get all students in this class
                    const si = ss.index('class');
                    const sr = si.getAll(IDBKeyRange.only(classId));
                    
                    sr.onsuccess = function() {
                        const students = sr.result;
                        const studentIds = students.map(s => s.id);
                        attendances = attendances.filter(a => studentIds.includes(a.studentId));
                        
                        // Generate class report
                        generateClassReport(classId, students, attendances, startDate, endDate);
                    };
                }
                // No filter, generate overall report
                else {
                    generateOverallReport(attendances, startDate, endDate);
                }
                
                // Show export button
                document.getElementById('exportReportBtn').style.display = 'block';
            };
        }
        
        function generateStudentReport(student, attendances, startDate, endDate) {
            // Calculate statistics
            const total = attendances.length;
            const present = attendances.filter(a => a.status === 'present').length;
            const absent = total - present;
            const percentage = total > 0 ? (present / total * 100).toFixed(2) : 0;
            
            // Group attendances by date
            const attendanceByDate = {};
            attendances.forEach(a => {
                attendanceByDate[a.date] = a.status;
            });
            
            // Create all dates in range
            const dates = [];
            let currentDate = new Date(startDate);
            const endDateTime = new Date(endDate);
            
            while (currentDate <= endDateTime) {
                dates.push(currentDate.toISOString().split('T'));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const reportDiv = document.getElementById('attendanceReportResult');
            reportDiv.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>${student.name} - حاضری رپورٹ</h5>
						
<p class="mb-0">\${startDate} سے ${endDate} تک</p>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>کل دن</h6>
                                        <h2>${total}</h2>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-success text-white">
<div class="card-body text-center">
<h6>حاضر</h6>
<h2>${present}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h6>غیر حاضر</h6>
                                        <h2>${absent}</h2>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-info text-white">
<div class="card-body text-center">
<h6>حاضری فیصد</h6>
<h2>\${percentage}%</h2>
</div>
</div>
</div>
</div>

                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>تاریخ</th>
                                        <th>حیثیت</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dates.map(date => `
                                        <tr>
                                            <td>${date}</td>
                                            <td>
                                                ${attendanceByDate[date] ? 
                                                    `<span class="badge ${attendanceByDate[date] === 'present' ? 'bg-success' : 'bg-danger'}">
                                                        ${attendanceByDate[date] === 'present' ? 'حاضر' : 'غیر حاضر'}
                                                    </span>` : 
                                                    '<span class="badge bg-secondary">غیر معلوم</span>'
                                                }
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateClassReport(className, students, attendances, startDate, endDate) {
            // Calculate statistics
            const studentsCount = students.length;
            const daysCount = (new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24) + 1;
            const totalPossibleAttendances = studentsCount * daysCount;
            const totalPresent = attendances.filter(a => a.status === 'present').length;
            const totalAbsent = attendances.filter(a => a.status === 'absent').length;
            const percentage = totalPossibleAttendances > 0 ? (totalPresent / attendances.length * 100).toFixed(2) : 0;
            
            // Organize attendance by student
            const attendanceByStudent = {};
            students.forEach(s => {
                attendanceByStudent[s.id] = {
                    student: s,
                    present: 0,
                    absent: 0,
                    total: 0
                };
            });
            
            attendances.forEach(a => {
                if (attendanceByStudent[a.studentId]) {
                    attendanceByStudent[a.studentId].total++;
                    if (a.status === 'present') {
                        attendanceByStudent[a.studentId].present++;
                    } else {
                        attendanceByStudent[a.studentId].absent++;
                    }
                }
            });
            
            const reportDiv = document.getElementById('attendanceReportResult');
            reportDiv.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>${className} - کلاس حاضری رپورٹ</h5>
                        <p class="mb-0">${startDate} سے ${endDate} تک</p>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>طلاب</h6>
                                        <h2>${studentsCount}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h6>کل دن</h6>
                                        <h2>${daysCount}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6>اوسط حاضری</h6>
                                        <h2>${percentage}%</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h6>کل حاضریاں</h6>
                                        <h2>${attendances.length}</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mb-3">طالب علم کے مطابق حاضری</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>طالب علم</th>
                                        <th>کل دن</th>
                                        <th>حاضر</th>
                                        <th>غیر حاضر</th>
                                        <th>حاضری %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.values(attendanceByStudent).map((data, index) => `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td>${data.student.name}</td>
                                            <td>${data.total}</td>
                                            <td>${data.present}</td>
                                            <td>${data.absent}</td>
                                            <td>${data.total > 0 ? (data.present / data.total * 100).toFixed(2) : 0}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateOverallReport(attendances, startDate, endDate) {
            // Calculate statistics
            const totalAttendances = attendances.length;
            const totalPresent = attendances.filter(a => a.status === 'present').length;
            const totalAbsent = attendances.filter(a => a.status === 'absent').length;
            const percentage = totalAttendances > 0 ? (totalPresent / totalAttendances * 100).toFixed(2) : 0;
            
            // Group attendances by date
            const attendanceByDate = {};
            attendances.forEach(a => {
                if (!attendanceByDate[a.date]) {
                    attendanceByDate[a.date] = { total: 0, present: 0, absent: 0 };
                }
                attendanceByDate[a.date].total++;
                if (a.status === 'present') {
                    attendanceByDate[a.date].present++;
                } else {
                    attendanceByDate[a.date].absent++;
                }
            });
            
            // Convert to array and sort by date
            const dailyAttendance = Object.entries(attendanceByDate).map(([date, stats]) => {
                return {
                    date,
                    ...stats,
                    percentage: stats.total > 0 ? (stats.present / stats.total * 100).toFixed(2) : 0
                };
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const reportDiv = document.getElementById('attendanceReportResult');
            reportDiv.innerHTML = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>مجموعی حاضری رپورٹ</h5>
                        <p class="mb-0">${startDate} سے ${endDate} تک</p>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>کل حاضریاں</h6>
                                        <h2>${totalAttendances}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6>حاضر</h6>
                                        <h2>${totalPresent}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h6>غیر حاضر</h6>
                                        <h2>${totalAbsent}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h6>اوسط حاضری</h6>
                                        <h2>${percentage}%</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mb-3">روزانہ حاضری</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>تاریخ</th>
                                        <th>کل طلاب</th>
                                        <th>حاضر</th>
                                        <th>غیر حاضر</th>
                                        <th>حاضری %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dailyAttendance.map(day => `
                                        <tr>
                                            <td>${day.date}</td>
                                            <td>${day.total}</td>
                                            <td>${day.present}</td>
                                            <td>${day.absent}</td>
                                            <td>${day.percentage}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function exportAttendanceReportCsv() {
            const classId = document.getElementById('reportClassFilter').value;
            const studentId = document.getElementById('reportStudentFilter').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            const t = db.transaction(['attendance', 'students', 'classes'], 'readonly');
            const as = t.objectStore('attendance');
            const ss = t.objectStore('students');
            
            // Get all attendance records in date range
            const ai = as.index('date');
            const range = IDBKeyRange.bound(startDate, endDate);
            const r = ai.getAll(range);
            
            r.onsuccess = function() {
                let attendances = r.result;
                
                // Filter by student if specified
                if (studentId) {
                    attendances = attendances.filter(a => a.studentId == studentId);
                    
                    // Get student details
                    const sr = ss.get(parseInt(studentId));
                    sr.onsuccess = function() {
                        const student = sr.result;
                        if (student) {
                            exportStudentAttendanceCsv(student, attendances, startDate, endDate);
                        }
                    };
                }
                // Filter by class if specified
                else if (classId) {
                    // Get all students in this class
                    const si = ss.index('class');
                    const sr = si.getAll(IDBKeyRange.only(classId));
                    
                    sr.onsuccess = function() {
                        const students = sr.result;
                        const studentIds = students.map(s => s.id);
                        attendances = attendances.filter(a => studentIds.includes(a.studentId));
                        
                        exportClassAttendanceCsv(classId, students, attendances, startDate, endDate);
                    };
                }
                // No filter, export overall report
                else {
                    exportOverallAttendanceCsv(attendances, startDate, endDate);
                }
            };
        }
        
        function exportStudentAttendanceCsv(student, attendances, startDate, endDate) {
            // Group attendances by date
            const attendanceByDate = {};
            attendances.forEach(a => {
                attendanceByDate[a.date] = a.status;
            });
            
            // Create all dates in range
            const dates = [];
            let currentDate = new Date(startDate);
            const endDateTime = new Date(endDate);
            
            while (currentDate <= endDateTime) {
                dates.push(currentDate.toISOString().split('T'));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let csvContent = 'Student Name,Date,Status\n';
            
            dates.forEach(date => {
                const status = attendanceByDate[date] ? 
                    (attendanceByDate[date] === 'present' ? 'Present' : 'Absent') : 
                    'Not Marked';
                csvContent += `"${student.name}",${date},${status}\n`;
            });
            
            downloadCsv(csvContent, `${student.name}_attendance.csv`);
        }
        
        function exportClassAttendanceCsv(className, students, attendances, startDate, endDate) {
            // Organize attendance by student and date
            const attendanceMap = {};
            attendances.forEach(a => {
                if (!attendanceMap[a.studentId]) {
                    attendanceMap[a.studentId] = {};
                }
                attendanceMap[a.studentId][a.date] = a.status;
            });
            
            // Create all dates in range
            const dates = [];
            let currentDate = new Date(startDate);
            const endDateTime = new Date(endDate);
            
            while (currentDate <= endDateTime) {
                dates.push(currentDate.toISOString().split('T'));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let csvContent = 'Student Name,';
            dates.forEach(date => {
                csvContent += `${date},`;
            });
            csvContent += 'Total Present,Total Absent,Attendance %\n';
            
            students.forEach(student => {
                let present = 0;
                let absent = 0;
                
                csvContent += `"${student.name}",`;
                
                dates.forEach(date => {
                    const status = attendanceMap[student.id] && attendanceMap[student.id][date] ?
                        attendanceMap[student.id][date] : 'N/A';
                        
                    if (status === 'present') present++;
                    if (status === 'absent') absent++;
                    
                    csvContent += `${status === 'present' ? 'Present' : (status === 'absent' ? 'Absent' : 'Not Marked')},`;
                });
                
                const total = present + absent;
                const percentage = total > 0 ? (present / total * 100).toFixed(2) : 0;
                
                csvContent += `${present},${absent},${percentage}%\n`;
            });
            
            downloadCsv(csvContent, `${className}_class_attendance.csv`);
        }
        
        function exportOverallAttendanceCsv(attendances, startDate, endDate) {
            // Group attendances by date
            const attendanceByDate = {};
            attendances.forEach(a => {
                if (!attendanceByDate[a.date]) {
                    attendanceByDate[a.date] = { total: 0, present: 0, absent: 0 };
                }
                attendanceByDate[a.date].total++;
                if (a.status === 'present') {
                    attendanceByDate[a.date].present++;
                } else {
                    attendanceByDate[a.date].absent++;
                }
            });
            
            // Convert to array and sort by date
            const dailyAttendance = Object.entries(attendanceByDate).map(([date, stats]) => {
                return {
                    date,
                    ...stats,
                    percentage: stats.total > 0 ? (stats.present / stats.total * 100).toFixed(2) : 0
                };
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let csvContent = 'Date,Total Students,Present,Absent,Attendance %\n';
            
            dailyAttendance.forEach(day => {
                csvContent += `${day.date},${day.total},${day.present},${day.absent},${day.percentage}%\n`;
            });
            
            downloadCsv(csvContent, `overall_attendance_${startDate}_to_${endDate}.csv`);
        }
        
        function exportTodayAttendanceCsv() {
            const today = new Date().toISOString().split('T');
            const classFilter = document.getElementById('attendanceClassFilter').value;
            
            const t = db.transaction(['attendance', 'students'], 'readonly');
            const as = t.objectStore('attendance');
            const ss = t.objectStore('students');
            const ai = as.index('date');
            const r = ai.getAll(IDBKeyRange.only(today));
            
            r.onsuccess = function() {
                let attendances = r.result;
                
                // Get all student details
                const studentPromises = attendances.map(attendance => {
                    return new Promise((resolve, reject) => {
                        const sr = ss.get(attendance.studentId);
                        sr.onsuccess = function() {
                            const student = sr.result;
                            resolve({
                                attendance,
                                student
                            });
                        };
                        sr.onerror = reject;
                    });
                });
                
                Promise.all(studentPromises).then(results => {
                    // Filter by class if needed
                    if (classFilter) {
                        results = results.filter(r => r.student && r.student.class === classFilter);
                    }
                    
                    let csvContent = 'Student ID,Student Name,Class,Status,Date\n';
                    
                    results.forEach(({ attendance, student }) => {
                        if (student) {
                            csvContent += `${student.id},"${student.name}","${student.class || ''}",${attendance.status === 'present' ? 'Present' : 'Absent'},${attendance.date}\n`;
                        }
                    });
                    
                    downloadCsv(csvContent, `attendance_${today}.csv`);
                });
            };
        }
        
        function downloadCsv(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Fee Management
        function loadFees(c) {
            c.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>فیس کا انتظام</h2>
                    <button class="btn btn-primary" onclick="showFeeForm()">
                        <i class="bi bi-plus-circle"></i> نئی ادائیگی
                    </button>
                </div>
                
                <div id="feeForm" style="display: none;" class="card mb-4">
                    <div class="card-header">
                        <h5>فیس کی ادائیگی</h5>
                    </div>
                    <div class="card-body">
                        <form id="addFeeForm">
                            <input type="hidden" id="feeId">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="feeStudent" class="form-label">طالب علم</label>
                                    <select class="form-select" id="feeStudent" required>
                                        <option value="">طالب علم منتخب کریں</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="feeDate" class="form-label">تاریخ</label>
                                    <input type="date" class="form-control" id="feeDate" required value="${new Date().toISOString().split('T')}">
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="feeAmount" class="form-label">رقم (Rs)</label>
                                    <input type="number" class="form-control" id="feeAmount" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="feeType" class="form-label">فیس کی قسم</label>
                                    <select class="form-select" id="feeType">
                                        <option value="monthly">ماہانہ فیس</option>
                                        <option value="admission">داخلہ فیس</option>
                                        <option value="exam">امتحان فیس</option>
                                        <option value="other">دیگر</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="feeStatus" class="form-label">حیثیت</label>
                                    <select class="form-select" id="feeStatus">
                                        <option value="paid">ادا شدہ</option>
                                        <option value="partial">جزوی ادائیگی</option>
                                        <option value="pending">زیر التواء</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="feeMonth" class="form-label">مہینہ</label>
                                    <select class="form-select" id="feeMonth">
                                        <option value="">منتخب کریں</option>
                                        <option value="january">جنوری</option>
                                        <option value="february">فروری</option>
                                        <option value="march">مارچ</option>
                                        <option value="april">اپریل</option>
                                        <option value="may">مئی</option>
                                        <option value="june">جون</option>
                                        <option value="july">جولائی</option>
                                        <option value="august">اگست</option>
                                        <option value="september">ستمبر</option>
                                        <option value="october">اکتوبر</option>
                                        <option value="november">نومبر</option>
                                        <option value="december">دسمبر</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <label for="feeDescription" class="form-label">تفصیلات</label>
                                    <textarea class="form-control" id="feeDescription" rows="3"></textarea>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end mt-3">
                                <button type="button" class="btn btn-secondary me-2" onclick="cancelFeeForm()">منسوخ</button>
                                <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5>فیس کی تاریخ</h5>
                            <div class="d-flex">
                                <select class="form-select form-select-sm me-2" id="feeStatusFilter">
                                    <option value="">سب حیثیت</option>
                                    <option value="paid">ادا شدہ</option>
                                    <option value="partial">جزوی ادائیگی</option>
                                    <option value="pending">زیر التواء</option>
                                </select>
                                <input type="text" class="form-control form-control-sm me-2" id="feeSearch" placeholder="تلاش کریں...">
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportFeesCsv()">
                                    <i class="bi bi-download"></i> CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>طالب علم</th>
                                        <th>تاریخ</th>
                                        <th>رقم</th>
                                        <th>قسم</th>
                                        <th>حیثیت</th>
                                        <th>اقدامات</th>
                                    </tr>
                                </thead>
                                <tbody id="feesList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('addFeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveFee();
            });
            
            document.getElementById('feeStatusFilter').addEventListener('change', function() {
                loadFeesList();
            });
            
            document.getElementById('feeSearch').addEventListener('input', function() {
                loadFeesList();
            });
            
            loadStudentOptions('feeStudent');
            loadFeesList();
        }
        
        function showFeeForm() {
            document.getElementById('feeForm').style.display = 'block';
            document.getElementById('addFeeForm').reset();
            document.getElementById('feeId').value = '';
            document.getElementById('feeDate').value = new Date().toISOString().split('T');
            
            // Set current month
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentMonth = months[new Date().getMonth()];
            document.getElementById('feeMonth').value = currentMonth;
        }
        
        function cancelFeeForm() {
            document.getElementById('feeForm').style.display = 'none';
        }
        
        function loadFeesList() {
            const t = db.transaction(['fees', 'students'], 'readonly');
            const fs = t.objectStore('fees');
            const ss = t.objectStore('students');
            const r = fs.getAll();
            
            r.onsuccess = function() {
                let fees = r.result;
                const statusFilter = document.getElementById('feeStatusFilter').value;
                const searchText = document.getElementById('feeSearch').value.toLowerCase();
                
                if (statusFilter) {
                    fees = fees.filter(f => f.status === statusFilter);
                }
                
                // Sort by date (newest first)
                fees.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const l = document.getElementById('feesList');
                l.innerHTML = '';
                
                let processed = 0;
                fees.forEach((fee, index) => {
                    const sr = ss.get(fee.studentId);
                    sr.onsuccess = function() {
                        const student = sr.result;
                        
                        // Apply search filter on student name
                        if (searchText && student && !student.name.toLowerCase().includes(searchText)) {
                            processed++;
                            if (processed === fees.length && l.innerHTML === '') {
                                l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی فیس ریکارڈ نہیں ملا</td></tr>';
                            }
                            return;
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${student ? student.name : 'غیر معلوم'}</td>
                            <td>${fee.date}</td>
                            <td>Rs. ${fee.amount}</td>
                            <td>${getFeeTypeName(fee.type)}</td>
                            <td>
                                <span class="badge ${getFeeStatusBadgeClass(fee.status)}">
                                    ${getFeeStatusName(fee.status)}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editFee(${fee.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteFee(${fee.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="printFeeReceipt(${fee.id})">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </td>
                        `;
                        l.appendChild(row);
                        
                        processed++;
                        if (processed === fees.length && l.innerHTML === '') {
                            l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی فیس ریکارڈ نہیں ملا</td></tr>';
                        }
                    };
                });
                
                if (fees.length === 0) {
                    l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی فیس ریکارڈ نہیں ملا</td></tr>';
                }
            };
        }
        
        function getFeeTypeName(type) {
            switch(type) {
                case 'monthly': return 'ماہانہ فیس';
                case 'admission': return 'داخلہ فیس';
                case 'exam': return 'امتحان فیس';
                case 'other': return 'دیگر';
                default: return type || 'دیگر';
            }
        }
        
        function getFeeStatusName(status) {
            switch(status) {
                case 'paid': return 'ادا شدہ';
                case 'partial': return 'جزوی ادائیگی';
                case 'pending': return 'زیر التواء';
                default: return status || 'زیر التواء';
            }
        }
        
        function getFeeStatusBadgeClass(status) {
            switch(status) {
                case 'paid': return 'bg-success';
                case 'partial': return 'bg-warning';
                case 'pending': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function saveFee() {
            const i = document.getElementById('feeId').value;
            
            const fee = {
                studentId: parseInt(document.getElementById('feeStudent').value),
                date: document.getElementById('feeDate').value,
                amount: document.getElementById('feeAmount').value,
                type: document.getElementById('feeType').value,
                status: document.getElementById('feeStatus').value,
                month: document.getElementById('feeMonth').value,
                description: document.getElementById('feeDescription').value
            };
            
            const t = db.transaction(['fees'], 'readwrite');
            const s = t.objectStore('fees');
            
            if (i) {
                fee.id = parseInt(i);
                s.put(fee);
            } else {
                s.add(fee);
            }
            
            t.oncomplete = function() {
                document.getElementById('feeForm').style.display = 'none';
                loadFeesList();
                alert(i ? 'فیس کی معلومات اپڈیٹ ہو گئیں' : 'نئی فیس شامل کر دی گئی');
            };
            
            t.onerror = function(e) {
                console.error('Transaction error:', e.target.error);
                alert('فیس کو محفوظ کرنے میں خرابی');
            };
        }
        
        function editFee(id) {
            const t = db.transaction(['fees'], 'readonly');
            const s = t.objectStore('fees');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const fee = r.result;
                if (fee) {
                    document.getElementById('feeId').value = fee.id;
                    document.getElementById('feeStudent').value = fee.studentId;
                    document.getElementById('feeDate').value = fee.date;
                    document.getElementById('feeAmount').value = fee.amount;
                    document.getElementById('feeType').value = fee.type || 'monthly';
                    document.getElementById('feeStatus').value = fee.status || 'paid';
                    document.getElementById('feeMonth').value = fee.month || '';
                    document.getElementById('feeDescription').value = fee.description || '';
                    
                    document.getElementById('feeForm').style.display = 'block';
                }
            };
        }
        
        function deleteFee(id) {
            if (confirm('کیا آپ واقعی اس فیس ریکارڈ کو حذف کرنا چاہتے ہیں؟')) {
                const t = db.transaction(['fees'], 'readwrite');
                const s = t.objectStore('fees');
                s.delete(id);
                
                t.oncomplete = function() {
                    loadFeesList();
                    alert('فیس ریکارڈ کامیابی سے حذف کر دیا گیا');
                };
                
                t.onerror = function(e) {
                    console.error('Delete error:', e.target.error);
                    alert('فیس ریکارڈ کو حذف کرنے میں خرابی');
                };
            }
        }
        
        function printFeeReceipt(id) {
            const t = db.transaction(['fees', 'students'], 'readonly');
            const fs = t.objectStore('fees');
            const ss = t.objectStore('students');
            const r = fs.get(id);
            
            r.onsuccess = function() {
                const fee = r.result;
                if (fee) {
                    const sr = ss.get(fee.studentId);
                    sr.onsuccess = function() {
                        const student = sr.result;
                        
                        const pa = document.getElementById('printArea');
                        pa.innerHTML = `
                            <div style="max-width: 800px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; direction: rtl; font-family: 'Noto Nastaliq Urdu', serif;">
                                <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                                    <h2 style="margin: 0;">دینی مدرسہ مینجمنٹ سسٹم</h2>
                                    <p>فیس رسید</p>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                    <div>
                                        <p><strong>رسید نمبر:</strong> ${fee.id}</p>
                                        <p><strong>تاریخ:</strong> ${fee.date}</p>
                                    </div>
                                    <div>
                                        <p><strong>حیثیت:</strong> ${getFeeStatusName(fee.status)}</p>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <p><strong>طالب علم کا نام:</strong> ${student ? student.name : ''}</p>
                                    <p><strong>طالب علم آئی ڈی:</strong> ${student ? student.id : ''}</p>
                                    <p><strong>کلاس:</strong> ${student ? student.class : ''}</p>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">تفصیلات</th>
                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">مہینہ</th>
                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">رقم (Rs)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${getFeeTypeName(fee.type)}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${getMonthName(fee.month)}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${fee.amount}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="border: 1px solid #ddd; padding: 8px; text-align: left;"><strong>کل رقم:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>${fee.amount}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style="margin-bottom: 20px;">
                                    <p><strong>تفصیلات:</strong> ${fee.description || '-'}</p>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                                    <div>
                                        <p>____________________</p>
                                        <p>طالب علم کے دستخط</p>
                                    </div>
                                    <div>
                                        <p>____________________</p>
                                        <p>ادارے کے دستخط</p>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; margin-top: 30px; font-size: 0.8em;">
                                    <p>یہ کمپیوٹر سے جنریٹ کردہ رسید ہے</p>
                                </div>
                            </div>
                        `;
                        
                        window.print();
                    };
                }
            };
        }
        
        function getMonthName(month) {
            switch(month) {
                case 'january': return 'جنوری';
                case 'february': return 'فروری';
                case 'march': return 'مارچ';
                case 'april': return 'اپریل';
                case 'may': return 'مئی';
                case 'june': return 'جون';
                case 'july': return 'جولائی';
                case 'august': return 'اگست';
                case 'september': return 'ستمبر';
                case 'october': return 'اکتوبر';
                case 'november': return 'نومبر';
                case 'december': return 'دسمبر';
                default: return month || '-';
            }
        }
        
        function exportFeesCsv() {
            const t = db.transaction(['fees', 'students'], 'readonly');
            const fs = t.objectStore('fees');
            const ss = t.objectStore('students');
            const r = fs.getAll();
            
            r.onsuccess = function() {
                const fees = r.result;
                if (fees.length === 0) {
                    alert('برآمد کرنے کے لیے کوئی ڈیٹا نہیں ہے');
                    return;
                }
                
                // Get all student details first
                const studentPromises = fees.map(fee => {
                    return new Promise((resolve, reject) => {
                        const sr = ss.get(fee.studentId);
                        sr.onsuccess = function() {
                            resolve({
                                fee,
                                student: sr.result
                            });
                        };
                        sr.onerror = reject;
                    });
                });
                
                Promise.all(studentPromises).then(results => {
                    let csvContent = 'Fee ID,Student ID,Student Name,Date,Amount,Type,Status,Month,Description\n';
                    
                    results.forEach(({ fee, student }) => {
                        const row = [
                            fee.id,
                            fee.studentId,
                            `"${student ? student.name : 'Unknown'}"`,
                            fee.date,
                            fee.amount,
                            `"${getFeeTypeName(fee.type)}"`,
                            `"${getFeeStatusName(fee.status)}"`,
                            `"${getMonthName(fee.month)}"`,
                            `"${fee.description || ''}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    
                    downloadCsv(csvContent, 'fees_record.csv');
                });
            };
        }
        
        // Salary Management
function loadSalary(c) {
    c.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>تنخواہ کا انتظام</h2>
            <button class="btn btn-primary" onclick="showSalaryForm()">
                <i class="bi bi-plus-circle"></i> نئی تنخواہ ادائیگی
            </button>
        </div>
        
        <div id="salaryForm" style="display: none;" class="card mb-4">
            <div class="card-header">
                <h5>تنخواہ کی ادائیگی</h5>
            </div>
            <div class="card-body">
                <form id="addSalaryForm">
                    <input type="hidden" id="salaryId">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="salaryTeacher" class="form-label">استاد</label>
                            <select class="form-select" id="salaryTeacher" required onchange="loadTeacherSalary()">
                                <option value="">استاد منتخب کریں</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="salaryDate" class="form-label">تاریخ</label>
                            <input type="date" class="form-control" id="salaryDate" required>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="salaryAmount" class="form-label">رقم (Rs)</label>
                            <input type="number" class="form-control" id="salaryAmount" required>
                        </div>
                        <div class="col-md-6">
                            <label for="salaryMonth" class="form-label">مہینہ</label>
                            <select class="form-select" id="salaryMonth" required>
                                <option value="">منتخب کریں</option>
                                <option value="january">جنوری</option>
                                <option value="february">فروری</option>
                                <option value="march">مارچ</option>
                                <option value="april">اپریل</option>
                                <option value="may">مئی</option>
                                <option value="june">جون</option>
                                <option value="july">جولائی</option>
                                <option value="august">اگست</option>
                                <option value="september">ستمبر</option>
                                <option value="october">اکتوبر</option>
                                <option value="november">نومبر</option>
                                <option value="december">دسمبر</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="salaryStatus" class="form-label">حیثیت</label>
                            <select class="form-select" id="salaryStatus">
                                <option value="paid">ادا شدہ</option>
                                <option value="partial">جزوی ادائیگی</option>
                                <option value="pending">زیر التواء</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="paymentMethod" class="form-label">ادائیگی کا طریقہ</label>
                            <select class="form-select" id="paymentMethod">
                                <option value="cash">نقد</option>
                                <option value="bank">بینک</option>
                                <option value="other">دیگر</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label for="salaryDescription" class="form-label">تفصیلات</label>
                            <textarea class="form-control" id="salaryDescription" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-3">
                        <button type="button" class="btn btn-secondary me-2" onclick="cancelSalaryForm()">منسوخ</button>
                        <button type="submit" class="btn btn-primary">محفوظ کریں</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5>تنخواہ کی تاریخ</h5>
                    <div class="d-flex">
                        <select class="form-select form-select-sm me-2" id="salaryTeacherFilter">
                            <option value="">سب اساتذہ</option>
                        </select>
                        <select class="form-select form-select-sm me-2" id="salaryStatusFilter">
                            <option value="">سب حیثیت</option>
                            <option value="paid">ادا شدہ</option>
                            <option value="partial">جزوی ادائیگی</option>
                            <option value="pending">زیر التواء</option>
                        </select>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportSalariesCsv()">
                            <i class="bi bi-download"></i> CSV
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>استاد</th>
                                <th>تاریخ</th>
                                <th>مہینہ</th>
                                <th>رقم</th>
                                <th>حیثیت</th>
                                <th>اقدامات</th>
                            </tr>
                        </thead>
                        <tbody id="salariesList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('addSalaryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSalary();
    });
    
    // Set date with proper format
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0]; // This gets YYYY-MM-DD format
    
    // Make sure the date field exists before trying to set its value
    setTimeout(() => {
        if (document.getElementById('salaryDate')) {
            document.getElementById('salaryDate').value = formattedDate;
        }
        
        // Set event listeners
        if (document.getElementById('salaryStatusFilter')) {
            document.getElementById('salaryStatusFilter').addEventListener('change', function() {
                loadSalariesList();
            });
        }
        
        if (document.getElementById('salaryTeacherFilter')) {
            document.getElementById('salaryTeacherFilter').addEventListener('change', function() {
                loadSalariesList();
            });
        }
        
        // First load teacher options, then teacher filter options, then salary list
        if (document.getElementById('salaryTeacher')) {
            loadTeacherOptions('salaryTeacher').then(() => {
                if (document.getElementById('salaryTeacherFilter')) {
                    loadTeacherFilterOptions('salaryTeacherFilter').then(() => {
                        loadSalariesList();
                    });
                } else {
                    loadSalariesList();
                }
            });
        } else {
            if (document.getElementById('salaryTeacherFilter')) {
                loadTeacherFilterOptions('salaryTeacherFilter').then(() => {
                    loadSalariesList();
                });
            } else {
                loadSalariesList();
            }
        }
    }, 100);
}

        
function loadTeacherOptions(elementId) {
    try {
        // Always re-query DOM to avoid stale references
        const s = document.getElementById(elementId);
        if (!s) {
            return Promise.resolve(); // Exit gracefully
        }
        // Verify element is still in the DOM
        if (!document.body.contains(s)) {
            return Promise.resolve();
        }
        s.innerHTML = '<option value="">استاد منتخب کریں</option>';

        const t = db.transaction(['teachers'], 'readonly');
        const st = t.objectStore('teachers');
        const r = st.getAll();

        r.onsuccess = function() {
            const teachers = r.result;
            teachers.sort((a, b) => a.name.localeCompare(b.name));

            teachers.forEach(teacher => {
                const o = document.createElement('option');
                o.value = teacher.id;
                o.textContent = teacher.name;
                s.appendChild(o);
            });
        };

        r.onerror = function(e) {
        };

        return Promise.resolve();
    } catch (error) {
        return Promise.resolve(); // Prevent crash
    }
}
        
function loadTeacherFilterOptions(elementId) {
    const s = document.getElementById(elementId || 'salaryTeacherFilter');
    if (!s) {
        console.warn(`Teacher filter select element '${elementId || 'salaryTeacherFilter'}' not found`);
        return Promise.resolve();
    }
    
    s.innerHTML = '<option value="">سب اساتذہ</option>';
    
    const t = db.transaction(['teachers'], 'readonly');
    const st = t.objectStore('teachers');
    const r = st.getAll();
    
    return new Promise((resolve) => {
        r.onsuccess = function() {
            const teachers = r.result;
            teachers.forEach(teacher => {
                const o = document.createElement('option');
                o.value = teacher.id;
                o.textContent = teacher.name;
                s.appendChild(o);
            });
            resolve();
        };
        
        r.onerror = function() {
            console.warn('Error loading teachers for filter');
            resolve();
        };
    });
}

        
        function loadTeacherSalary() {
            const select = document.getElementById('salaryTeacher');
            const option = select.options[select.selectedIndex];
            
            if (option && option.dataset.salary) {
                document.getElementById('salaryAmount').value = option.dataset.salary;
            } else {
                document.getElementById('salaryAmount').value = '';
            }
        }
        
        function showSalaryForm() {
            document.getElementById('salaryForm').style.display = 'block';
            document.getElementById('addSalaryForm').reset();
            document.getElementById('salaryId').value = '';
            document.getElementById('salaryDate').value = new Date().toISOString().split('T');
            
            // Set current month
            const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentMonth = months[new Date().getMonth()];
            document.getElementById('salaryMonth').value = currentMonth;
        }
        
        function cancelSalaryForm() {
            document.getElementById('salaryForm').style.display = 'none';
        }
        
        function loadSalariesList() {
            const t = db.transaction(['salary', 'teachers'], 'readonly');
            const ss = t.objectStore('salary');
            const ts = t.objectStore('teachers');
            const r = ss.getAll();
            
            r.onsuccess = function() {
                let salaries = r.result;
                const teacherFilter = document.getElementById('salaryTeacherFilter').value;
                const statusFilter = document.getElementById('salaryStatusFilter').value;
                
                if (teacherFilter) {
                    salaries = salaries.filter(s => s.teacherId == teacherFilter);
                }
                
                if (statusFilter) {
                    salaries = salaries.filter(s => s.status === statusFilter);
                }
                
                // Sort by date (newest first)
                salaries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const l = document.getElementById('salariesList');
                l.innerHTML = '';
                
                let processed = 0;
                salaries.forEach((salary, index) => {
                    const tr = ts.get(parseInt(salary.teacherId));
                    tr.onsuccess = function() {
                        const teacher = tr.result;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${teacher ? teacher.name : 'غیر معلوم'}</td>
                            <td>${salary.date}</td>
                            <td>${getMonthName(salary.month)}</td>
                            <td>Rs. ${salary.amount}</td>
                            <td>
                                <span class="badge ${getFeeStatusBadgeClass(salary.status)}">
                                    ${getFeeStatusName(salary.status)}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary btn-action" onclick="editSalary(${salary.id})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteSalary(${salary.id})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="printSalaryReceipt(${salary.id})">
                                    <i class="bi bi-printer"></i>
                                </button>
                            </td>
                        `;
                        l.appendChild(row);
                        
                        processed++;
                        if (processed === salaries.length && l.innerHTML === '') {
                            l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی تنخواہ ریکارڈ نہیں ملا</td></tr>';
                        }
                    };
                });
                
                if (salaries.length === 0) {
                    l.innerHTML = '<tr><td colspan="7" class="text-center">کوئی تنخواہ ریکارڈ نہیں ملا</td></tr>';
                }
            };
        }
        
        function saveSalary() {
            const i = document.getElementById('salaryId').value;
            
            const salary = {
                teacherId: parseInt(document.getElementById('salaryTeacher').value),
                date: document.getElementById('salaryDate').value,
                amount: document.getElementById('salaryAmount').value,
                month: document.getElementById('salaryMonth').value,
                status: document.getElementById('salaryStatus').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                description: document.getElementById('salaryDescription').value
            };
            
            const t = db.transaction(['salary'], 'readwrite');
            const s = t.objectStore('salary');
            
            if (i) {
                salary.id = parseInt(i);
                s.put(salary);
            } else {
                s.add(salary);
            }
            
            t.oncomplete = function() {
                document.getElementById('salaryForm').style.display = 'none';
                loadSalariesList();
                alert(i ? 'تنخواہ کی معلومات اپڈیٹ ہو گئیں' : 'نئی تنخواہ شامل کر دی گئی');
            };
            
            t.onerror = function(e) {
                console.error('Transaction error:', e.target.error);
                alert('تنخواہ کو محفوظ کرنے میں خرابی');
            };
        }
        
        function editSalary(id) {
            const t = db.transaction(['salary'], 'readonly');
            const s = t.objectStore('salary');
            const r = s.get(id);
            
            r.onsuccess = function() {
                const salary = r.result;
                if (salary) {
                    document.getElementById('salaryId').value = salary.id;
                    document.getElementById('salaryTeacher').value = salary.teacherId;
                    document.getElementById('salaryDate').value = salary.date;
                    document.getElementById('salaryAmount').value = salary.amount;
                    document.getElementById('salaryMonth').value = salary.month || '';
                    document.getElementById('salaryStatus').value = salary.status || 'paid';
                    document.getElementById('paymentMethod').value = salary.paymentMethod || 'cash';
                    document.getElementById('salaryDescription').value = salary.description || '';
                    
                    document.getElementById('salaryForm').style.display = 'block';
                }
            };
        }
        
        function deleteSalary(id) {
            if (confirm('کیا آپ واقعی اس تنخواہ ریکارڈ کو حذف کرنا چاہتے ہیں؟')) {
                const t = db.transaction(['salary'], 'readwrite');
                const s = t.objectStore('salary');
                s.delete(id);
                
                t.oncomplete = function() {
                    loadSalariesList();
                    alert('تنخواہ ریکارڈ کامیابی سے حذف کر دیا گیا');
                };
                
                t.onerror = function(e) {
                    console.error('Delete error:', e.target.error);
                    alert('تنخواہ ریکارڈ کو حذف کرن e میں خرابی');
};
}
}

        function printSalaryReceipt(id) {
            const t = db.transaction(['salary', 'teachers'], 'readonly');
            const ss = t.objectStore('salary');
            const ts = t.objectStore('teachers');
            const r = ss.get(id);
            
            r.onsuccess = function() {
                const salary = r.result;
                if (salary) {
                    const tr = ts.get(parseInt(salary.teacherId));
                    tr.onsuccess = function() {
                        const teacher = tr.result;
                        
                        const pa = document.getElementById('printArea');
                        pa.innerHTML = `
                            <div style="max-width: 800px; margin: 0 auto; padding: 20px; border: 1px solid #ddd; direction: rtl; font-family: 'Noto Nastaliq Urdu', serif;">
                                <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px;">
                                    <h2 style="margin: 0;">دینی مدرسہ مینجمنٹ سسٹم</h2>
                                    <p>تنخواہ رسید</p>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                    <div>
                                        <p><strong>رسید نمبر:</strong> ${salary.id}</p>
                                        <p><strong>تاریخ:</strong> ${salary.date}</p>
                                    </div>
                                    <div>
                                        <p><strong>حیثیت:</strong> ${getFeeStatusName(salary.status)}</p>
                                        <p><strong>ادائیگی کا طریقہ:</strong> ${getPaymentMethodName(salary.paymentMethod)}</p>
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 20px;">
                                    <p><strong>استاد کا نام:</strong> ${teacher ? teacher.name : ''}</p>
                                    <p><strong>استاد آئی ڈی:</strong> ${teacher ? teacher.id : ''}</p>
                                    <p><strong>تعلیمی قابلیت:</strong> ${teacher ? teacher.qualification || '-' : '-'}</p>
                                </div>
                                
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                    <thead>
                                        <tr style="background-color: #f2f2f2;">
                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">مہینہ</th>
                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">بنیادی تنخواہ</th>
                                            <th style="border: 1px solid #ddd; padding: 8px; text-align: right;">ادا شدہ رقم</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${getMonthName(salary.month)}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${teacher ? teacher.salary || '-' : '-'}</td>
                                            <td style="border: 1px solid #ddd; padding: 8px;">${salary.amount}</td>
                                        </tr>
                                        <tr>
                                            <td colspan="2" style="border: 1px solid #ddd; padding: 8px; text-align: left;"><strong>کل رقم:</strong></td>
                                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>${salary.amount}</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style="margin-bottom: 20px;">
                                    <p><strong>تفصیلات:</strong> ${salary.description || '-'}</p>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                                    <div>
                                        <p>____________________</p>
                                        <p>استاد کے دستخط</p>
                                    </div>
                                    <div>
                                        <p>____________________</p>
                                        <p>ادارے کے دستخط</p>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; margin-top: 30px; font-size: 0.8em;">
                                    <p>یہ کمپیوٹر سے جنریٹ کردہ رسید ہے</p>
                                </div>
                            </div>
                        `;
                        
                        window.print();
                    };
                }
            };
        }
        
        function getPaymentMethodName(method) {
            switch(method) {
                case 'cash': return 'نقد';
                case 'bank': return 'بینک';
                case 'other': return 'دیگر';
                default: return method || 'نقد';
            }
        }
        
        function exportSalariesCsv() {
            const t = db.transaction(['salary', 'teachers'], 'readonly');
            const ss = t.objectStore('salary');
            const ts = t.objectStore('teachers');
            const r = ss.getAll();
            
            r.onsuccess = function() {
                const salaries = r.result;
                if (salaries.length === 0) {
                    alert('برآمد کرنے کے لیے کوئی ڈیٹا نہیں ہے');
                    return;
                }
                
                // Get all teacher details first
                const teacherPromises = salaries.map(salary => {
                    return new Promise((resolve, reject) => {
                        const tr = ts.get(parseInt(salary.teacherId));
                        tr.onsuccess = function() {
                            resolve({
                                salary,
                                teacher: tr.result
                            });
                        };
                        tr.onerror = reject;
                    });
                });
                
                Promise.all(teacherPromises).then(results => {
                    let csvContent = 'Salary ID,Teacher ID,Teacher Name,Date,Month,Amount,Status,Payment Method,Description\n';
                    
                    results.forEach(({ salary, teacher }) => {
                        const row = [
                            salary.id,
                            salary.teacherId,
                            `"${teacher ? teacher.name : 'Unknown'}"`,
                            salary.date,
                            `"${getMonthName(salary.month)}"`,
                            salary.amount,
                            `"${getFeeStatusName(salary.status)}"`,
                            `"${getPaymentMethodName(salary.paymentMethod)}"`,
                            `"${salary.description || ''}"`
                        ];
                        csvContent += row.join(',') + '\n';
                    });
                    
                    downloadCsv(csvContent, 'salary_record.csv');
                });
            };
        }
        
        // Reports
        function loadReports(c) {
            c.innerHTML = `
                <h2 class="mb-4">رپورٹس</h2>
                
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">طلاب</h5>
                                <p class="card-text">طلاب کی رپورٹس، کلاس کے مطابق فلٹر کریں</p>
                                <button class="btn btn-primary" onclick="showStudentReport()">
                                    <i class="bi bi-file-text"></i> رپورٹ دیکھیں
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">حاضری</h5>
                                <p class="card-text">حاضری کی رپورٹس، تاریخ اور کلاس کے مطابق فلٹر کریں</p>
                                <button class="btn btn-primary" onclick="showAttendanceReportPage()">
                                    <i class="bi bi-file-text"></i> رپورٹ دیکھیں
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">فیس</h5>
                                <p class="card-text">فیس کی رپورٹس، تاریخ اور حیثیت کے مطابق فلٹر کریں</p>
                                <button class="btn btn-primary" onclick="showFeeReport()">
                                    <i class="bi bi-file-text"></i> رپورٹ دیکھیں
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">اساتذہ</h5>
                                <p class="card-text">اساتذہ کی رپورٹس اور ان کی کلاسز</p>
                                <button class="btn btn-primary" onclick="showTeacherReport()">
                                    <i class="bi bi-file-text"></i> رپورٹ دیکھیں
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">کلاسز</h5>
                                <p class="card-text">کلاسز کی رپورٹس اور طلاب کی تعداد</p>
                                <button class="btn btn-primary" onclick="showClassReport()">
                                    <i class="bi bi-file-text"></i> رپورٹ دیکھیں
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">تنخواہ</h5>
                                <p class="card-text">تنخواہ کی رپورٹس، استاد اور مہینہ کے مطابق</p>
                                <button class="btn btn-primary" onclick="showSalaryReport()">
                                    <i class="bi bi-file-text"></i> رپورٹ دیکھیں
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="reportContent"></div>
            `;
        }
        
        function showStudentReport() {
            const rc = document.getElementById('reportContent');
            rc.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>طلاب کی رپورٹس</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">کلاس</label>
                                <select class="form-select" id="studentReportClassFilter">
                                    <option value="">سب کلاسز</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">ترتیب</label>
                                <select class="form-select" id="studentReportSortBy">
                                    <option value="name">نام</option>
                                    <option value="id">آئی ڈی</option>
                                    <option value="admissionDate">داخلے کی تاریخ</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="generateStudentReport()">
                                    <i class="bi bi-search"></i> رپورٹ بنائیں
                                </button>
                            </div>
                        </div>
                        
                        <div id="studentReportResult"></div>
                    </div>
                </div>
            `;
            
            loadClassOptions('studentReportClassFilter');
        }
        
        function generateStudentReport() {
            const classFilter = document.getElementById('studentReportClassFilter').value;
            const sortBy = document.getElementById('studentReportSortBy').value;
            
            const t = db.transaction(['students', 'fees', 'attendance'], 'readonly');
            const ss = t.objectStore('students');
            const fs = t.objectStore('fees');
            const as = t.objectStore('attendance');
            
            let r;
            if (classFilter) {
                const i = ss.index('class');
                r = i.getAll(IDBKeyRange.only(classFilter));
            } else {
                r = ss.getAll();
            }
            
            r.onsuccess = function() {
                let students = r.result;
                
                // Sort students
                switch(sortBy) {
                    case 'name':
                        students.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'id':
                        students.sort((a, b) => a.id - b.id);
                        break;
                    case 'admissionDate':
                        students.sort((a, b) => new Date(a.admissionDate || '1970-01-01') - new Date(b.admissionDate || '1970-01-01'));
                        break;
                }
                
                // Get fee and attendance data for all students
                const studentPromises = students.map(student => {
                    return new Promise((resolve, reject) => {
                        const fi = fs.index('studentId');
                        const fr = fi.getAll(IDBKeyRange.only(student.id));
                        
                        fr.onsuccess = function() {
                            const fees = fr.result;
                            const totalFees = fees.reduce((sum, fee) => sum + parseFloat(fee.amount), 0);
                            
                            const ai = as.index('studentId');
                            const ar = ai.getAll(IDBKeyRange.only(student.id));
                            
                            ar.onsuccess = function() {
                                const attendance = ar.result;
                                const present = attendance.filter(a => a.status === 'present').length;
                                const absent = attendance.filter(a => a.status === 'absent').length;
                                
                                resolve({
                                    student,
                                    fees: {
                                        total: totalFees,
                                        count: fees.length
                                    },
                                    attendance: {
                                        present,
                                        absent,
                                        total: present + absent,
                                        percentage: present + absent > 0 ? (present / (present + absent) * 100).toFixed(2) : 0
                                    }
                                });
                            };
                        };
                    });
                });
                
                Promise.all(studentPromises).then(results => {
                    const sr = document.getElementById('studentReportResult');
                    
                    if (results.length === 0) {
                        sr.innerHTML = '<div class="alert alert-info">کوئی طالب علم نہیں ملا</div>';
                        return;
                    }
                    
                    let html = `
                        <div class="d-flex justify-content-between mb-3">
                            <h5>${classFilter ? classFilter + ' - ' : ''}طلاب کی فہرست (${results.length})</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportGeneratedStudentReportCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="generatedStudentReport">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>نام</th>
                                        <th>والد کا نام</th>
                                        <th>کلاس</th>
                                        <th>داخلے کی تاریخ</th>
                                        <th>کل فیس</th>
                                        <th>حاضری %</th>
                                        <th>رابطہ</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    results.forEach((result, index) => {
                        const { student, fees, attendance } = result;
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student.name}</td>
                                <td>${student.fatherName || '-'}</td>
                                <td>${student.class || '-'}</td>
                                <td>${student.admissionDate || '-'}</td>
                                <td>Rs. ${fees.total.toFixed(2)}</td>
                                <td>${attendance.percentage}%</td>
                                <td>${student.contact || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    sr.innerHTML = html;
                });
            };
        }
        
        function exportGeneratedStudentReportCsv() {
            const table = document.getElementById('generatedStudentReport');
            if (!table) {
                alert('پہلے رپورٹ بنائیں');
                return;
            }
            
            let csvContent = '';
            
            // Get header row
            const headerRow = table.querySelector('thead tr');
            const headers = headerRow.querySelectorAll('th');
            const headerTexts = Array.from(headers).map(header => `"${header.textContent.trim()}"`);
            csvContent += headerTexts.join(',') + '\n';
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const cellTexts = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cellTexts.join(',') + '\n';
            });
            
            downloadCsv(csvContent, 'students_report.csv');
        }
        
        function showAttendanceReportPage() {
            n('attendance');
            setTimeout(() => {
                viewAttendanceReport();
            }, 100);
        }
        
        function showFeeReport() {
            const rc = document.getElementById('reportContent');
            rc.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>فیس رپورٹس</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">تاریخ سے</label>
                                <input type="date" class="form-control" id="feeReportStartDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">تاریخ تک</label>
                                <input type="date" class="form-control" id="feeReportEndDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">حیثیت</label>
                                <select class="form-select" id="feeReportStatusFilter">
                                    <option value="">سب</option>
                                    <option value="paid">ادا شدہ</option>
                                    <option value="partial">جزوی ادائیگی</option>
                                    <option value="pending">زیر التواء</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="generateFeeReport()">
                                    <i class="bi bi-search"></i> رپورٹ بنائیں
                                </button>
                            </div>
                        </div>
                        
                        <div id="feeReportResult"></div>
                    </div>
                </div>
            `;
            
            // Set default dates (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T');
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T');
            
            document.getElementById('feeReportStartDate').value = firstDay;
            document.getElementById('feeReportEndDate').value = lastDay;
        }
        
        function generateFeeReport() {
            const startDate = document.getElementById('feeReportStartDate').value;
            const endDate = document.getElementById('feeReportEndDate').value;
            const statusFilter = document.getElementById('feeReportStatusFilter').value;
            
            if (!startDate || !endDate) {
                alert('تاریخیں منتخب کریں');
                return;
            }
            
            const t = db.transaction(['fees', 'students'], 'readonly');
            const fs = t.objectStore('fees');
            const ss = t.objectStore('students');
            const r = fs.getAll();
            
            r.onsuccess = function() {
                let fees = r.result;
                
                // Filter by date range
                fees = fees.filter(fee => 
                    fee.date >= startDate && fee.date <= endDate
                );
                
                // Filter by status if selected
                if (statusFilter) {
                    fees = fees.filter(fee => fee.status === statusFilter);
                }
                
                // Sort by date (newest first)
                fees.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get student data for all fees
                const feePromises = fees.map(fee => {
                    return new Promise((resolve, reject) => {
                        const sr = ss.get(fee.studentId);
                        sr.onsuccess = function() {
                            resolve({
                                fee,
                                student: sr.result
                            });
                        };
                        sr.onerror = reject;
                    });
                });
                
                Promise.all(feePromises).then(results => {
                    const fr = document.getElementById('feeReportResult');
                    
                    if (results.length === 0) {
                        fr.innerHTML = '<div class="alert alert-info">اس تاریخ کی حد میں کوئی فیس ریکارڈ نہیں ملا</div>';
                        return;
                    }
                    
                    // Calculate summary stats
                    const totalAmount = results.reduce((sum, { fee }) => sum + parseFloat(fee.amount), 0);
                    const paidAmount = results
                        .filter(({ fee }) => fee.status === 'paid')
                        .reduce((sum, { fee }) => sum + parseFloat(fee.amount), 0);
                    const partialAmount = results
                        .filter(({ fee }) => fee.status === 'partial')
                        .reduce((sum, { fee }) => sum + parseFloat(fee.amount), 0);
                    const pendingAmount = results
                        .filter(({ fee }) => fee.status === 'pending')
                        .reduce((sum, { fee }) => sum + parseFloat(fee.amount), 0);
                    
                    let html = `
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6>کل رقم</h6>
                                        <h2>Rs. ${totalAmount.toFixed(2)}</h2>
                                        <p>کل ادائیگی: ${results.length}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6>ادا شدہ</h6>
                                        <h2>Rs. ${paidAmount.toFixed(2)}</h2>
                                        <p>${results.filter(({ fee }) => fee.status === 'paid').length} ادائیگی</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h6>جزوی ادائیگی</h6>
                                        <h2>Rs. ${partialAmount.toFixed(2)}</h2>
                                        <p>${results.filter(({ fee }) => fee.status === 'partial').length} ادائیگی</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h6>زیر التواء</h6>
                                        <h2>Rs. ${pendingAmount.toFixed(2)}</h2>
                                        <p>${results.filter(({ fee }) => fee.status === 'pending').length} ادائیگی</p>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <div class="d-flex justify-content-between mb-3">
                            <h5>فیس کی تفصیلات</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportGeneratedFeeReportCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="generatedFeeReport">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>طالب علم</th>
                                        <th>کلاس</th>
                                        <th>تاریخ</th>
                                        <th>مہینہ</th>
                                        <th>قسم</th>
                                        <th>رقم</th>
                                        <th>حیثیت</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    results.forEach(({ fee, student }, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student ? student.name : 'غیر معلوم'}</td>
                                <td>${student ? student.class || '-' : '-'}</td>
                                <td>${fee.date}</td>
                                <td>${getMonthName(fee.month) || '-'}</td>
                                <td>${getFeeTypeName(fee.type)}</td>
                                <td>Rs. ${fee.amount}</td>
                                <td>
                                    <span class="badge ${getFeeStatusBadgeClass(fee.status)}">
                                        ${getFeeStatusName(fee.status)}
                                    </span>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    fr.innerHTML = html;
                });
            };
        }
        
        function exportGeneratedFeeReportCsv() {
            const table = document.getElementById('generatedFeeReport');
            if (!table) {
                alert('پہلے رپورٹ بنائیں');
                return;
            }
            
            let csvContent = '';
            
            // Get header row
            const headerRow = table.querySelector('thead tr');
            const headers = headerRow.querySelectorAll('th');
            const headerTexts = Array.from(headers).map(header => `"${header.textContent.trim()}"`);
            csvContent += headerTexts.join(',') + '\n';
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const cellTexts = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cellTexts.join(',') + '\n';
            });
            
            downloadCsv(csvContent, 'fees_report.csv');
        }
        
        function showTeacherReport() {
            const rc = document.getElementById('reportContent');
            rc.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>اساتذہ کی رپورٹس</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-primary" onclick="generateTeacherReport()">
                                <i class="bi bi-search"></i> رپورٹ بنائیں
                            </button>
                        </div>
                        
                        <div id="teacherReportResult"></div>
                    </div>
                </div>
            `;
            
            // Generate report immediately
            generateTeacherReport();
        }
        
        function generateTeacherReport() {
            const t = db.transaction(['teachers', 'classes', 'salary'], 'readonly');
            const ts = t.objectStore('teachers');
            const cs = t.objectStore('classes');
            const ss = t.objectStore('salary');
            const r = ts.getAll();
            
            r.onsuccess = function() {
                const teachers = r.result;
                
                // Sort teachers by name
                teachers.sort((a, b) => a.name.localeCompare(b.name));
                
                // Get classes and salary data for all teachers
                const teacherPromises = teachers.map(teacher => {
                    return new Promise((resolve, reject) => {
                        const cr = cs.getAll();
                        cr.onsuccess = function() {
                            const classes = cr.result.filter(c => c.teacherId == teacher.id);
                            
                            const si = ss.index('teacherId');
                            const sr = si.getAll(IDBKeyRange.only(teacher.id));
                            
                            sr.onsuccess = function() {
                                const salaries = sr.result;
                                const totalSalary = salaries.reduce((sum, salary) => sum + parseFloat(salary.amount), 0);
                                
                                resolve({
                                    teacher,
                                    classes,
                                    salary: {
                                        total: totalSalary,
                                        count: salaries.length
                                    }
                                });
                            };
                        };
                    });
                });
                
                Promise.all(teacherPromises).then(results => {
                    const tr = document.getElementById('teacherReportResult');
                    
                    if (results.length === 0) {
                        tr.innerHTML = '<div class="alert alert-info">کوئی استاد نہیں ملا</div>';
                        return;
                    }
                    
                    let html = `
                        <div class="d-flex justify-content-between mb-3">
                            <h5>اساتذہ کی فہرست (${results.length})</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportGeneratedTeacherReportCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="generatedTeacherReport">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>نام</th>
                                        <th>تعلیمی قابلیت</th>
                                        <th>تخصص</th>
                                        <th>شمولیت کی تاریخ</th>
                                        <th>کلاسز</th>
                                        <th>ماہانہ تنخواہ</th>
                                        <th>کل ادا شدہ</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    results.forEach((result, index) => {
                        const { teacher, classes, salary } = result;
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${teacher.name}</td>
                                <td>${teacher.qualification || '-'}</td>
                                <td>${teacher.specialization || '-'}</td>
                                <td>${teacher.joiningDate || '-'}</td>
                                <td>${classes.length} (${classes.map(c => c.name).join(', ')})</td>
                                <td>Rs. ${teacher.salary || '0'}</td>
                                <td>Rs. ${salary.total.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    tr.innerHTML = html;
                });
            };
        }
        
        function exportGeneratedTeacherReportCsv() {
            const table = document.getElementById('generatedTeacherReport');
            if (!table) {
                alert('پہلے رپورٹ بنائیں');
                return;
            }
            
            let csvContent = '';
            
            // Get header row
            const headerRow = table.querySelector('thead tr');
            const headers = headerRow.querySelectorAll('th');
            const headerTexts = Array.from(headers).map(header => `"${header.textContent.trim()}"`);
            csvContent += headerTexts.join(',') + '\n';
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const cellTexts = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cellTexts.join(',') + '\n';
            });
            
            downloadCsv(csvContent, 'teachers_report.csv');
        }
        
        function showClassReport() {
            const rc = document.getElementById('reportContent');
            rc.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>کلاسز کی رپورٹس</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-end mb-3">
                            <button class="btn btn-primary" onclick="generateClassReport()">
                                <i class="bi bi-search"></i> رپورٹ بنائیں
                            </button>
                        </div>
                        
                        <div id="classReportResult"></div>
                    </div>
                </div>
            `;
            
            // Generate report immediately
            generateClassReport();
        }
        
        function generateClassReport() {
            const t = db.transaction(['classes', 'teachers', 'students'], 'readonly');
            const cs = t.objectStore('classes');
            const ts = t.objectStore('teachers');
            const ss = t.objectStore('students');
            const r = cs.getAll();
            
            r.onsuccess = function() {
                const classes = r.result;
                
                // Sort classes by name
                classes.sort((a, b) => a.name.localeCompare(b.name));
                
                // Get teacher and student data for all classes
                const classPromises = classes.map(classObj => {
                    return new Promise((resolve, reject) => {
                        let teacherPromise;
                        if (classObj.teacherId) {
                            teacherPromise = new Promise((res, rej) => {
                                const tr = ts.get(parseInt(classObj.teacherId));
                                tr.onsuccess = function() {
                                    res(tr.result);
                                };
                                tr.onerror = rej;
                            });
                        } else {
                            teacherPromise = Promise.resolve(null);
                        }
                        
                        const studentsPromise = new Promise((res, rej) => {
                            const si = ss.index('class');
                            const sr = si.getAll(IDBKeyRange.only(classObj.name));
                            sr.onsuccess = function() {
                                res(sr.result);
                            };
                            sr.onerror = rej;
                        });
                        
                        Promise.all([teacherPromise, studentsPromise]).then(([teacher, students]) => {
                            resolve({
                                class: classObj,
                                teacher,
                                students
                            });
                        }).catch(reject);
                    });
                });
                
                Promise.all(classPromises).then(results => {
                    const cr = document.getElementById('classReportResult');
                    
                    if (results.length === 0) {
                        cr.innerHTML = '<div class="alert alert-info">کوئی کلاس نہیں ملی</div>';
                        return;
                    }
                    
                    let html = `
                        <div class="d-flex justify-content-between mb-3">
                            <h5>کلاسز کی فہرست (${results.length})</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportGeneratedClassReportCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="generatedClassReport">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>کلاس کا نام</th>
                                        <th>استاد</th>
                                        <th>اوقات</th>
                                        <th>کمرہ</th>
                                        <th>طلاب کی تعداد</th>
                                        <th>تفصیلات</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    results.forEach((result, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${result.class.name}</td>
                                <td>${result.teacher ? result.teacher.name : '-'}</td>
                                <td>${result.class.timing || '-'}</td>
                                <td>${result.class.room || '-'}</td>
                                <td>${result.students.length}</td>
                                <td>${result.class.description || '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    cr.innerHTML = html;
                });
            };
        }
        
        function exportGeneratedClassReportCsv() {
            const table = document.getElementById('generatedClassReport');
            if (!table) {
                alert('پہلے رپورٹ بنائیں');
                return;
            }
            
            let csvContent = '';
            
            // Get header row
            const headerRow = table.querySelector('thead tr');
            const headers = headerRow.querySelectorAll('th');
            const headerTexts = Array.from(headers).map(header => `"${header.textContent.trim()}"`);
            csvContent += headerTexts.join(',') + '\n';
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const cellTexts = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cellTexts.join(',') + '\n';
            });
            
            downloadCsv(csvContent, 'classes_report.csv');
        }
        
        function showSalaryReport() {
            const rc = document.getElementById('reportContent');
            rc.innerHTML = `
                <div class="card mt-4">
                    <div class="card-header">
                        <h5>تنخواہ رپورٹس</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label class="form-label">استاد</label>
                                <select class="form-select" id="salaryReportTeacherFilter">
                                    <option value="">سب اساتذہ</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">تاریخ سے</label>
                                <input type="date" class="form-control" id="salaryReportStartDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">تاریخ تک</label>
                                <input type="date" class="form-control" id="salaryReportEndDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="generateSalaryReport()">
                                    <i class="bi bi-search"></i> رپورٹ بنائیں
                                </button>
                            </div>
                        </div>
                        
                        <div id="salaryReportResult"></div>
                    </div>
                </div>
            `;
            
            // Set default dates (current month)
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T');
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T');
            
            document.getElementById('salaryReportStartDate').value = firstDay;
            document.getElementById('salaryReportEndDate').value = lastDay;
            
            // Load teacher options
            loadTeacherFilterOptions('salaryReportTeacherFilter');
        }
        
        function loadTeacherFilterOptions(elementId) {
            const s = document.getElementById(elementId);
            s.innerHTML = '<option value="">سب اساتذہ</option>';
            
            const t = db.transaction(['teachers'], 'readonly');
            const st = t.objectStore('teachers');
            const r = st.getAll();
            
            r.onsuccess = function() {
                const teachers = r.result;
                teachers.forEach(teacher => {
                    const o = document.createElement('option');
                    o.value = teacher.id;
                    o.textContent = teacher.name;
                    s.appendChild(o);
                });
            };
        }
        
        function generateSalaryReport() {
            const teacherId = document.getElementById('salaryReportTeacherFilter').value;
            const startDate = document.getElementById('salaryReportStartDate').value;
            const endDate = document.getElementById('salaryReportEndDate').value;
            
            if (!startDate || !endDate) {
                alert('تاریخیں منتخب کریں');
                return;
            }
            
            const t = db.transaction(['salary', 'teachers'], 'readonly');
            const ss = t.objectStore('salary');
            const ts = t.objectStore('teachers');
            let sr;
            
            if (teacherId) {
                const si = ss.index('teacherId');
                sr = si.getAll(IDBKeyRange.only(parseInt(teacherId)));
            } else {
                sr = ss.getAll();
            }
            
            sr.onsuccess = function() {
                let salaries = sr.result;
                
                // Filter by date range
                salaries = salaries.filter(salary => 
                    salary.date >= startDate && salary.date <= endDate
                );
                
                // Sort by date (newest first)
                salaries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get teacher data for all salaries
                const salaryPromises = salaries.map(salary => {
                    return new Promise((resolve, reject) => {
                        const tr = ts.get(parseInt(salary.teacherId));
                        tr.onsuccess = function() {
                            resolve({
                                salary,
                                teacher: tr.result
                            });
                        };
                        tr.onerror = reject;
                    });
                });
                
                Promise.all(salaryPromises).then(results => {
                    const sr = document.getElementById('salaryReportResult');
                    
                    if (results.length === 0) {
                        sr.innerHTML = '<div class="alert alert-info">اس تاریخ کی حد میں کوئی تنخواہ ریکارڈ نہیں ملا</div>';
                        return;
                    }
                    
                    // Calculate summary stats
                    const totalAmount = results.reduce((sum, { salary }) => sum + parseFloat(salary.amount), 0);
                    
                    // Group by teacher
                    const teacherSummary = {};
                    results.forEach(({ salary, teacher }) => {
                        if (!teacherSummary[teacher.id]) {
                            teacherSummary[teacher.id] = {
                                teacher,
                                total: 0,
                                count: 0
                            };
                        }
                        teacherSummary[teacher.id].total += parseFloat(salary.amount);
                        teacherSummary[teacher.id].count++;
                    });
                    
                    let html = `
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h6>کل تنخواہ</h6>
                                        <h2>Rs. ${totalAmount.toFixed(2)}</h2>
                                        <p>کل ادائیگی: ${results.length}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h6>اساتذہ</h6>
                                        <h2>${Object.keys(teacherSummary).length}</h2>
                                        <p>مختلف اساتذہ</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h6>اوسط تنخواہ</h6>
                                        <h2>Rs. ${(totalAmount / Object.keys(teacherSummary).length).toFixed(2)}</h2>
                                        <p>فی استاد</p>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <div class="d-flex justify-content-between mb-3">
                            <h5>تنخواہ کی تفصیلات</h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="exportGeneratedSalaryReportCsv()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped" id="generatedSalaryReport">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>استاد</th>
                                        <th>تاریخ</th>
                                        <th>مہینہ</th>
                                        <th>رقم</th>
                                        <th>حیثیت</th>
                                        <th>ادائیگی کا طریقہ</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    results.forEach(({ salary, teacher }, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${teacher ? teacher.name : 'غیر معلوم'}</td>
                                <td>${salary.date}</td>
                                <td>${getMonthName(salary.month)}</td>
                                <td>Rs. ${salary.amount}</td>
                                <td>
                                    <span class="badge ${getFeeStatusBadgeClass(salary.status)}">
                                        ${getFeeStatusName(salary.status)}
                                    </span>
                                </td>
                                <td>${getPaymentMethodName(salary.paymentMethod)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <h5 class="mt-4 mb-3">استاد کے مطابق خلاصہ</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>استاد</th>
                                        <th>ادائیگی کی تعداد</th>
                                        <th>کل رقم</th>
                                        <th>اوسط رقم</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    Object.values(teacherSummary).forEach((summary, index) => {
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${summary.teacher.name}</td>
                                <td>${summary.count}</td>
                                <td>Rs. ${summary.total.toFixed(2)}</td>
                                <td>Rs. ${(summary.total / summary.count).toFixed(2)}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    sr.innerHTML = html;
                });
            };
        }
        
        function exportGeneratedSalaryReportCsv() {
            const table = document.getElementById('generatedSalaryReport');
            if (!table) {
                alert('پہلے رپورٹ بنائیں');
                return;
            }
            
            let csvContent = '';
            
            // Get header row
            const headerRow = table.querySelector('thead tr');
            const headers = headerRow.querySelectorAll('th');
            const headerTexts = Array.from(headers).map(header => `"${header.textContent.trim()}"`);
            csvContent += headerTexts.join(',') + '\n';
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const cellTexts = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`);
                csvContent += cellTexts.join(',') + '\n';
            });
            
            downloadCsv(csvContent, 'salary_report.csv');
        }
        
        // Helper functions
        function loadStudentOptions(elementId) {
            const s = document.getElementById(elementId);
            s.innerHTML = '<option value="">طالب علم منتخب کریں</option>';
            
            const t = db.transaction(['students'], 'readonly');
            const st = t.objectStore('students');
            const r = st.getAll();
            
            r.onsuccess = function() {
                const students = r.result;
                students.sort((a, b) => a.name.localeCompare(b.name));
                
                students.forEach(student => {
                    const o = document.createElement('option');
                    o.value = student.id;
                    o.textContent = student.name;
                    s.appendChild(o);
                });
            };
            
            return Promise.resolve();
        }
        
function loadClassOptions(elementId) {
    const s = document.getElementById(elementId);
    if (!s) return Promise.resolve(); // Exit if element not found
    s.innerHTML = '<option value="">کلاس منتخب کریں</option>';
    
    const t = db.transaction(['classes'], 'readonly');
    const st = t.objectStore('classes');
    const r = st.getAll();
    
    r.onsuccess = function() {
        const classes = r.result;
        classes.sort((a, b) => a.name.localeCompare(b.name));
        
        classes.forEach(c => {
            const o = document.createElement('option');
            o.value = c.name;
            o.textContent = c.name;
            s.appendChild(o);
        });
    };
    
    return Promise.resolve();
}
    </script>
    </body>
</html>


<!DOCTYPE html>

<html dir="rtl" lang="ur">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="Yasin Ullah, Pakistani" name="author"/>
<meta content="A complete Madrasa Management System for Pakistani Islamic institutions. Manage students, fees, attendance, library, and more. Developed by Yasin Ullah." name="description"/>
<meta content="madrasa management system, islamic school software, student management, fee management, urdu software, pakistan, yasin ullah" name="keywords"/>
<title>ŸÖÿØÿ±ÿ≥€Å ÿßŸÜÿ™ÿ∏ÿßŸÖ€å ŸÜÿ∏ÿßŸÖ - ÿ¨ÿßŸÖÿπ€Å ÿßÿ≥ŸÑÿßŸÖ€å€Å</title>
<link href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90' fill='%234CAF50'%3Eüïå%3C/text%3E%3C/svg%3E" rel="icon"/>
<style>
        :root {
            --bg-dark: #121212;
            --bg-surface: #1e1e1e;
            --bg-surface-2: #2a2a2a;
            --primary: #28a745;
            --primary-light: #34c759;
            --secondary: #d4af37;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #333;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --font-family: Calibri, 'Tahoma', 'Segoe UI', 'Arial', sans-serif;
            --sidebar-width: 260px;
            --sidebar-width-collapsed: 70px;
        }

        *,
        select,
        input,
        button {
            font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        }

        @font-face {
            font-family: 'Noto Nastaliq Urdu';
            src: url('data:font/woff2;base64,d09GMgABAAAAA...');
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding-right: var(--sidebar-width);
            transition: padding-right 0.3s ease;
            overflow-x: hidden;
        }

        body.sidebar-collapsed {
            padding-right: var(--sidebar-width-collapsed);
        }

        .sidebar {
            overflow-y: scroll;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background-color: var(--bg-surface);
            border-left: 1px solid var(--border-color);
            transition: width 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiPgo8cGF0aCBkPSJNIDUwIDAgbCAxNC42IDM1LjQgTCAxMDAgNTBsIC0zNS40IDE0LjYgTCA1MCAxMDBsIC0xNC42IC0zNS40IEwgMCA1MCBsIDM1LjQgLTE0LjYgeiIgZmlsbD0icmdiYSgyMTIsIDE3NSwgNTUsIDAuMDUpIi8+Cjwvc3ZnPg==');
        }

        body.sidebar-collapsed .sidebar {
            width: var(--sidebar-width-collapsed);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h2 {
            color: var(--secondary);
            font-size: 1.5rem;
            white-space: nowrap;
            overflow: hidden;
        }

        body.sidebar-collapsed .sidebar-header h2 {
            display: none;
        }

        .sidebar-header .icon-only {
            display: none;
            font-size: 2rem;
            color: var(--secondary);
        }

        body.sidebar-collapsed .sidebar-header .icon-only {
            display: block;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            flex-grow: 1;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            transition: background-color 0.2s, color 0.2s;
        }

        .sidebar-nav li a:hover,
        .sidebar-nav li a.active {
            background-color: var(--primary);
            color: white;
        }

        .sidebar-nav li a .nav-icon {
            font-size: 1.5rem;
            margin-left: 15px;
            width: 30px;
            text-align: center;
            transition: margin-left 0.3s ease;
        }

        body.sidebar-collapsed .sidebar-nav li a {
            justify-content: center;
        }

        body.sidebar-collapsed .sidebar-nav li a .nav-text {
            display: none;
        }

        body.sidebar-collapsed .sidebar-nav li a .nav-icon {
            margin-left: 0;
        }

        .sidebar-footer {
            padding: 15px 20px;
            font-size: 0.8em;
            text-align: center;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
            white-space: nowrap;
            overflow: hidden;
        }

        body.sidebar-collapsed .sidebar-footer {
            display: none;
        }

        .main-content {
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .toggle-sidebar-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.8rem;
            cursor: pointer;
            margin-left: 15px;
        }

        .page-title {
            font-size: 1.8rem;
            color: var(--text-primary);
        }

        .user-menu {
            position: relative;
        }

        .user-menu button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .user-menu button .user-icon {
            margin-left: 8px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background-color: var(--bg-surface);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.3rem;
            color: var(--secondary);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .stats-card {
            background-color: var(--bg-surface-2);
            padding: 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            border-right: 5px solid var(--primary);
        }

        .stats-card-icon {
            font-size: 2.5rem;
            margin-left: 20px;
            color: var(--primary);
        }

        .stats-card-info h4 {
            font-size: 1.8rem;
            color: var(--text-primary);
        }

        .stats-card-info p {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-primary);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border-color);
        }

        thead {
            background-color: var(--bg-surface-2);
        }

        th {
            color: var(--secondary);
        }

        tbody tr:hover {
            background-color: var(--bg-surface-2);
        }

        .action-btns button {
            margin: 0 5px;
            padding: 5px 8px;
            font-size: 0.9em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
        }

        .form-control,
        select.form-control {
            width: 100%;
            padding: 10px;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.5);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--bg-dark);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-icon {
            padding: 8px 10px;
        }

        .search-filter-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filter-box .form-control {
            min-width: 200px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: var(--bg-surface);
            margin: 1% auto;
            padding: 0;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-btn {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            text-align: left;
        }

        #notification-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
        }

        .toast {
            background-color: var(--bg-surface-2);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            border-left: 5px solid;
            opacity: 0;
            transition: all 0.3s ease;
            transform: translateX(-100%);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast.info {
            border-color: var(--secondary);
        }

        #loader {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-box {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background: var(--bg-surface);
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 10px;
            color: var(--secondary);
        }

        .login-box p {
            margin-bottom: 30px;
            color: var(--text-secondary);
        }

        @media print {
            body {
                padding-right: 0 !important;
                background-color: white;
                color: black;
            }

            .sidebar,
            .header,
            .card-header button,
            .action-btns,
            .search-filter-box,
            .modal {
                display: none !important;
            }

            .main-content {
                padding: 0;
            }

            .page.active {
                display: block !important;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                padding: 10px;
            }

            .printable-area {
                display: block !important;
            }

            #printable-receipt,
            #printable-id-card {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                z-index: 99999;
                background: white;
            }

            table,
            th,
            td {
                color: black;
                border: 1px solid #ddd;
            }

            thead {
                background-color: #f2f2f2;
            }
        }

        .printable-area {
            display: none;
            padding: 20px;
            font-family: 'Times New Roman', serif;
        }

        #printable-receipt,
        #printable-id-card {
            border: 2px solid #333;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            background: white;
            color: black;
        }

        .id-card {
            width: 250px;
            height: 400px;
            border: 1px solid black;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin: 10px;
            display: inline-block;
        }

        @media (max-width: 768px) {
            body {
                padding-right: 0;
            }

            .sidebar {
                transform: translateX(100%);
                transition: transform 0.3s ease;
            }

            body.sidebar-open .sidebar {
                transform: translateX(0);
                width: 280px;
            }

            body.sidebar-collapsed {
                padding-right: 0;
            }

            .toggle-sidebar-btn {
                display: block !important;
            }

            .grid-container {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        button.tab-btn {
            padding: 8px;
            border-radius: 7px;
            background: #e1ffe1;
            font-size: 15px;
            cursor: pointer;
        }

        button.tab-btn:hover {
            padding: 8px;
            border-radius: 0px;
            background: #000000;
            font-size: 15px;
            cursor: pointer;
            color: #fff;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            margin: 0;
            padding-right: var(--sidebar-width);
            transition: padding-right 0.3s ease;
            overflow: hidden;
        }

        .main-content {
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
        }
    </style>
<link href="manifest.json" rel="manifest"/></head>
<body>
<div id="login-screen">
<div class="login-box">
<h2>ŸÖÿØÿ±ÿ≥€Å ÿßŸÜÿ™ÿ∏ÿßŸÖ€å ŸÜÿ∏ÿßŸÖ</h2>
<p>ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ŸÑÿß⁄Ø ÿßŸÜ ⁄©ÿ±€å⁄∫€î</p>
<form id="login-form">
<div class="form-group" style="text-align: right;">
<label for="username">ÿµÿßÿ±ŸÅ ŸÜÿßŸÖ</label>
<input class="form-control" id="username" required="" type="text" value="admin"/>
</div>
<div class="form-group" style="text-align: right;">
<label for="password">Ÿæÿßÿ≥ Ÿàÿ±⁄à</label>
<input class="form-control" id="password" required="" type="password" value="admin123"/>
</div>
<p id="login-error" style="color: var(--danger); display: none;"></p>
<button class="btn btn-primary" style="width: 100%;" type="submit">ŸÑÿß⁄Ø ÿßŸÜ</button>
</form>
<p style="margin-top: 20px; font-size: 0.8em;">(ÿß€å⁄àŸÖŸÜ: admin/admin123 | ÿßÿ≥ÿ™ÿßÿØ: teacher/teacher123)</p>
</div>
</div>
<div id="app-container" style="display: none;">
<aside class="sidebar">
<div class="sidebar-header">
<span class="icon-only">üïå</span>
<h2>ÿ¨ÿßŸÖÿπ€Å ÿßÿ≥ŸÑÿßŸÖ€å€Å</h2>
</div>
<ul class="sidebar-nav">
<li><a class="nav-link active" href="#dashboard"><span class="nav-icon">üè†</span> <span class="nav-text">⁄à€åÿ¥ ÿ®Ÿàÿ±⁄à</span></a></li>
<li><a class="nav-link" href="#students"><span class="nav-icon">üë®‚Äçüéì</span> <span class="nav-text">ÿ∑ŸÑÿ®ÿßÿ°</span></a></li>
<li><a class="nav-link" href="#fees"><span class="nav-icon">üí∞</span> <span class="nav-text">ŸÅ€åÿ≥</span></a></li>
<li><a class="nav-link" href="#attendance"><span class="nav-icon">üìÖ</span> <span class="nav-text">ÿ≠ÿßÿ∂ÿ±€å</span></a></li>
<li><a class="nav-link" href="#library"><span class="nav-icon">üìñ</span> <span class="nav-text">ŸÑÿßÿ¶ÿ®ÿ±€åÿ±€å</span></a></li>
<li data-role="admin"><a class="nav-link" href="#users"><span class="nav-icon">üë•</span> <span class="nav-text">ÿµÿßÿ±ŸÅ€åŸÜ</span></a></li>
<li><a class="nav-link" href="#reports"><span class="nav-icon">üìä</span> <span class="nav-text">ÿ±ŸæŸàÿ±Ÿπÿ≥</span></a></li>
<li data-role="admin"><a class="nav-link" href="#settings"><span class="nav-icon">‚öôÔ∏è</span> <span class="nav-text">ÿ™ÿ±ÿ™€åÿ®ÿßÿ™</span></a></li>
<li data-role="admin"><a class="nav-link" href="#backup"><span class="nav-icon">üíæ</span> <span class="nav-text">ÿ®€å⁄© ÿßŸæ</span></a></li>
</ul>
<div class="sidebar-footer">
<p>¬© <span id="currentYear"></span> Yasin Ullah</p>
<p>Ÿàÿ±⁄òŸÜ 1.0</p>
</div>
</aside>
<main class="main-content">
<header class="header">
<div class="header-left">
<button class="toggle-sidebar-btn">‚ò∞</button>
<h1 class="page-title" id="page-title">⁄à€åÿ¥ ÿ®Ÿàÿ±⁄à</h1>
</div>
<div class="user-menu">
<button id="logout-btn"><span id="currentUserDisplay"></span> <span class="user-icon">üë§</span></button>
</div>
</header>
<div id="content-area">
</div>
</main>
</div>
<div class="modal" id="appModal">
<div class="modal-content">
<div class="modal-header">
<h2 class="modal-title" id="modal-title">Modal Title</h2>
<span class="close-btn">√ó</span>
</div>
<div class="modal-body" id="modal-body">
</div>
<div class="modal-footer" id="modal-footer">
<button class="btn btn-secondary" id="modal-close-btn">ÿ®ŸÜÿØ ⁄©ÿ±€å⁄∫</button>
</div>
</div>
</div>
<div id="notification-container"></div>
<div id="loader">
<div class="spinner"></div>
</div>
<div class="printable-area" id="printable-content"></div>
<script>
        document.addEventListener('DOMContentLoaded', () => {
            const App = {
                db: null,
                dbName: 'MadrasaDB_v4_0',
                dbVersion: 1,
                currentUser: null,
                settings: {},
                init() {
                    this.initDB().then(() => {
                        console.log('Database initialized successfully.');
                        this.loadSettings();
                        this.setupEventListeners();
                        this.checkLoginState();
                        document.getElementById('currentYear').textContent = new Date().getFullYear();
                    }).catch(error => {
                        console.error('Database initialization failed:', error);
                        this.showToast('⁄à€åŸπÿß ÿ®€åÿ≥ ÿ¥ÿ±Ÿàÿπ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error');
                    });
                },
                setupEventListeners() {
                    document.getElementById('login-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                    document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());
                    document.querySelector('.sidebar-nav').addEventListener('click', (e) => {
                        const link = e.target.closest('a');
                        if (link && link.getAttribute('href')) {
                            e.preventDefault();
                            const targetPage = link.getAttribute('href').substring(1);
                            this.navigateTo(targetPage);
                        }
                    });
                    document.querySelector('.toggle-sidebar-btn').addEventListener('click', () => {
                        const body = document.body;
                        if (window.innerWidth <= 768) {
                            body.classList.toggle('sidebar-open');
                        } else {
                            body.classList.toggle('sidebar-collapsed');
                        }
                    });
                    document.querySelector('.modal .close-btn').addEventListener('click', () => this.closeModal());
                    document.getElementById('modal-close-btn').addEventListener('click', () => this.closeModal());
                    window.addEventListener('click', (e) => {
                        if (e.target === document.getElementById('appModal')) {
                            this.closeModal();
                        }
                    });
                    document.getElementById('content-area').addEventListener('click', (e) => {
                        const actionTarget = e.target.closest('[data-action]');
                        if (!actionTarget) return;
                        const { action, id, module, studentId, examId, type } = actionTarget.dataset;
                        const handlerMap = {
                            students: { edit: 'showForm', delete: 'confirmDelete', view: 'viewProfile', 'generate-id': 'generateIdCard' },
                            fees: { collect: 'showCollectionForm', 'view-history': 'viewStudentFeeHistory' },
                            library: {
                                issue: 'showIssueForm',
                                return: 'returnBook',
                                edit: 'showBookForm',
                                delete: 'confirmDeleteBook'
                            },
                            users: { edit: 'showForm', delete: 'confirmDelete' },
                            salary: {
                                pay: 'showPaymentForm',
                                payslip: 'generatePayslip',
                                edit: 'showStaffForm',
                                delete: 'confirmDeleteStaff'
                            },
                            exams: { edit: 'showExamForm', delete: 'confirmDeleteExam', 'marks-entry': () => this.Exams.renderMarksEntrySheet(id), 'view-card': () => this.Exams.renderResultCard(studentId, examId) },
                            accounts: { edit: () => this.Accounts.showTransactionForm(type, id), delete: () => this.Accounts.confirmDeleteTransaction(type, id) },
                            transport: { edit: 'showRouteForm', delete: 'confirmDeleteRoute', unassign: 'unassignStudentFromRoute' },
                            hostel: { edit: 'showRoomForm', delete: 'confirmDeleteRoom', unassign: 'unassignStudentFromRoom' },
                            syllabus: { delete: 'confirmDeleteSyllabus' },
                            noticeboard: { edit: 'showForm', delete: 'confirmDelete' }
                        };
                        if (handlerMap[module] && handlerMap[module][action]) {
                            const func = handlerMap[module][action];
                            const moduleObject = this[module.charAt(0).toUpperCase() + module.slice(1)];
                            if (typeof func === 'string') {
                                moduleObject[func](id);
                            } else {
                                func();
                            }
                        }
                    });
                },
                showLoader() { document.getElementById('loader').style.display = 'flex'; },
                hideLoader() { document.getElementById('loader').style.display = 'none'; },
                showToast(message, type = 'info') {
                    const container = document.getElementById('notification-container');
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.textContent = message;
                    container.appendChild(toast);
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        setTimeout(() => container.removeChild(toast), 300);
                    }, 3000);
                },
                navigateTo(page) {
                    document.querySelectorAll('.sidebar-nav .nav-link').forEach(link => link.classList.remove('active'));
                    const activeLink = document.querySelector(`.sidebar-nav a[href="#${page}"]`);
                    if (activeLink) {
                        activeLink.classList.add('active');
                        const pageTitle = activeLink.querySelector(`.nav-text`).textContent;
                        document.getElementById('page-title').textContent = pageTitle;
                    } else {
                        document.getElementById('page-title').textContent = '⁄à€åÿ¥ ÿ®Ÿàÿ±⁄à';
                    }
                    this.showLoader();
                    setTimeout(async () => {
                        try {
                            const contentArea = document.getElementById('content-area');
                            const moduleName = page.charAt(0).toUpperCase() + page.slice(1);
                            if (this[moduleName] && typeof this[moduleName].render === 'function') {
                                contentArea.innerHTML = await this[moduleName].render();
                                if (typeof this[moduleName].postRender === 'function') {
                                    await this[moduleName].postRender();
                                }
                            } else {
                                contentArea.innerHTML = `<div class="card"><p>ÿµŸÅÿ≠€Å ŸÜ€Å€å⁄∫ ŸÖŸÑÿß: ${page}</p></div>`;
                            }
                        } catch (err) {
                            console.error(`Error rendering page ${page}:`, err);
                            this.showToast('ÿµŸÅÿ≠€Å ŸÑŸà⁄à ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å!', 'error');
                            document.getElementById('content-area').innerHTML = `<div class="card"><p>ÿßÿ≥ ÿµŸÅÿ≠€í ⁄©Ÿà ŸÑŸà⁄à ⁄©ÿ±ÿ™€í ŸàŸÇÿ™ ÿß€å⁄© ÿÆÿ±ÿßÿ®€å Ÿæ€åÿ¥ ÿ¢⁄Øÿ¶€å€î</p></div>`;
                        } finally {
                            this.hideLoader();
                        }
                    }, 100);
                },
                checkLoginState() {
                    const user = sessionStorage.getItem('currentUser');
                    if (user) {
                        this.currentUser = JSON.parse(user);
                        this.showApp();
                    } else {
                        this.showLogin();
                    }
                },
                async handleLogin() {
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    const errorEl = document.getElementById('login-error');
                    errorEl.style.display = 'none';
                    if (!username || !password) {
                        errorEl.textContent = 'ÿµÿßÿ±ŸÅ ŸÜÿßŸÖ ÿßŸàÿ± Ÿæÿßÿ≥ Ÿàÿ±⁄à ÿØÿ±⁄©ÿßÿ± €Å€å⁄∫€î';
                        errorEl.style.display = 'block';
                        return;
                    }
                    try {
                        const user = await this.dbAction('users', 'get', username, 'username');
                        if (user && user.password === password) {
                            this.currentUser = user;
                            sessionStorage.setItem('currentUser', JSON.stringify(user));
                            this.showApp();
                        } else {
                            errorEl.textContent = 'ÿ∫ŸÑÿ∑ ÿµÿßÿ±ŸÅ ŸÜÿßŸÖ €åÿß Ÿæÿßÿ≥ Ÿàÿ±⁄à€î';
                            errorEl.style.display = 'block';
                        }
                    } catch (err) {
                        console.error('Login error:', err);
                        errorEl.textContent = 'ŸÑÿß⁄Ø ÿßŸÜ ⁄©€í ÿØŸàÿ±ÿßŸÜ ÿÆÿ±ÿßÿ®€å Ÿæ€åÿ¥ ÿ¢ÿ¶€å€î';
                        errorEl.style.display = 'block';
                    }
                },
                handleLogout() {
                    this.currentUser = null;
                    sessionStorage.removeItem('currentUser');
                    this.showLogin();
                },
                showApp() {
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    document.getElementById('currentUserDisplay').textContent = `${this.currentUser.name || this.currentUser.username} (${this.currentUser.role})`;
                    this.injectSidebarLinks();
                    document.querySelectorAll('[data-role]').forEach(el => {
                        const roles = el.dataset.role.split(',');
                        if (!roles.includes(this.currentUser.role)) {
                            el.style.display = 'none';
                        } else {
                            el.style.display = '';
                        }
                    });
                    this.navigateTo('dashboard');
                },
                showLogin() {
                    document.getElementById('login-screen').style.display = 'flex';
                    document.getElementById('app-container').style.display = 'none';
                },
                injectSidebarLinks() {
                    if (document.querySelector('a[href="#salary"]')) return;
                    const sidebarNav = document.querySelector('.sidebar-nav');
                    const reportsLink = sidebarNav.querySelector('a[href="#reports"]').parentElement;
                    const newLinks = [
                        { href: '#salary', icon: 'üíµ', text: 'ÿ™ŸÜÿÆŸàÿß€Å', role: 'admin' },
                        { href: '#accounts', icon: 'üßæ', text: 'ÿ¢ŸÖÿØŸÜ€å Ÿà ÿßÿÆÿ±ÿßÿ¨ÿßÿ™', role: 'admin' },
                        { href: '#exams', icon: 'üìù', text: 'ÿßŸÖÿ™ÿ≠ÿßŸÜ Ÿà ŸÜÿ™€åÿ¨€Å', role: 'admin,teacher' },
                        { href: '#transport', icon: 'üöå', text: 'Ÿπÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿπ', role: 'admin' },
                        { href: '#hostel', icon: 'üè®', text: '€Åÿßÿ≥ŸπŸÑ', role: 'admin' },
                        { href: '#syllabus', icon: 'üìö', text: 'ŸÜÿµÿßÿ®', role: 'admin,teacher' },
                        { href: '#noticeboard', icon: 'üì¢', text: 'ŸÜŸàŸπÿ≥ ÿ®Ÿàÿ±⁄à', role: 'admin,teacher,staff' },
                    ];
                    newLinks.forEach(linkInfo => {
                        const li = document.createElement('li');
                        li.dataset.role = linkInfo.role;
                        li.innerHTML = `<a href="${linkInfo.href}" class="nav-link"><span class="nav-icon">${linkInfo.icon}</span> <span class="nav-text">${linkInfo.text}</span></a>`;
                        sidebarNav.insertBefore(li, reportsLink);
                    });
                },
                initDB() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(this.dbName, this.dbVersion);
                        request.onerror = (e) => reject('Database error: ' + e.target.error.message);
                        request.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                        request.onupgradeneeded = (e) => {
                            this.db = e.target.result;
                            const objectStores = [
                                { name: 'students', key: 'id', autoIncrement: true, indexes: [['name', 'name'], ['classId', 'classId'], ['rollNo', 'rollNo', { unique: true }]] },
                                { name: 'classes', key: 'id', autoIncrement: true, indexes: [['name', 'name']] },
                                { name: 'fees', key: 'id', autoIncrement: true, indexes: [['studentId', 'studentId'], ['monthYear', ['month', 'year']], ['status', 'status']] },
                                { name: 'attendance', key: 'id', autoIncrement: true, indexes: [['date_student', ['date', 'studentId'], { unique: true }], ['date', 'date'], ['classId', 'classId']] },
                                { name: 'books', key: 'id', autoIncrement: true, indexes: [['title', 'title'], ['categoryId', 'categoryId']] },
                                { name: 'bookCategories', key: 'id', autoIncrement: true, indexes: [['name', 'name']] },
                                { name: 'libraryLog', key: 'id', autoIncrement: true, indexes: [['bookId', 'bookId'], ['studentId', 'studentId'], ['status', 'status']] },
                                { name: 'users', key: 'id', autoIncrement: true, indexes: [['username', 'username', { unique: true }]] },
                                { name: 'settings', key: 'key' },
                                { name: 'backupHistory', key: 'id', autoIncrement: true, indexes: [['timestamp', 'timestamp']] },
                                { name: 'subjects', key: 'id', autoIncrement: true, indexes: [['name', 'name']] },
                                { name: 'staff', key: 'id', autoIncrement: true, indexes: [['name', 'name']] },
                                { name: 'salaries', key: 'id', autoIncrement: true, indexes: [['staffId', 'staffId'], ['monthYear', ['month', 'year']]] },
                                { name: 'exams', key: 'id', autoIncrement: true, indexes: [['name', 'name']] },
                                { name: 'marks', key: 'id', autoIncrement: true, indexes: [['exam_student_subject', ['examId', 'studentId', 'subjectId'], { unique: true }], ['examId', 'examId'], ['studentId', 'studentId']] },
                                { name: 'income', key: 'id', autoIncrement: true, indexes: [['date', 'date']] },
                                { name: 'expenses', key: 'id', autoIncrement: true, indexes: [['date', 'date']] },
                                { name: 'notices', key: 'id', autoIncrement: true, indexes: [['issueDate', 'issueDate']] },
                                { name: 'transportRoutes', key: 'id', autoIncrement: true, indexes: [['routeName', 'routeName']] },
                                { name: 'transportAssignments', key: 'studentId' },
                                { name: 'hostelRooms', key: 'id', autoIncrement: true, indexes: [['roomNumber', 'roomNumber']] },
                                { name: 'hostelAssignments', key: 'studentId' },
                                { name: 'syllabus', key: 'id', autoIncrement: true, indexes: [['class_subject', ['classId', 'subjectId'], { unique: true }]] }
                            ];
                            objectStores.forEach(s => {
                                if (!this.db.objectStoreNames.contains(s.name)) {
                                    const store = this.db.createObjectStore(s.name, { keyPath: s.key, autoIncrement: s.autoIncrement });
                                    if (s.indexes) s.indexes.forEach(idx => store.createIndex(...idx));
                                }
                            });
                            const transaction = e.target.transaction;
                            transaction.oncomplete = () => this.seedData().then(() => console.log('Seeding complete.')).catch(err => console.error('Seeding error:', err));
                        };
                    });
                },
                async seedData() {
                    const storesToSeed = {
                        'users': [
                            { id: 1, name: 'Yasin Ullah', username: 'admin', password: 'admin123', role: 'admin' },
                            { id: 2, name: 'ÿßÿ≥ÿ™ÿßÿØ ÿµÿßÿ≠ÿ®', username: 'teacher', password: 'teacher123', role: 'teacher' },
                            { id: 3, name: 'ÿßÿ≥ŸπÿßŸÅ ŸÖŸÖÿ®ÿ±', username: 'staff', password: 'staff123', role: 'staff' },
                        ],
                        'classes': [
                            { id: 1, name: 'ÿ≠ŸÅÿ∏ ÿßŸÑŸÇÿ±ÿ¢ŸÜ', section: 'ÿßŸÑŸÅ' },
                            { id: 2, name: 'ÿØÿ±ÿ≥ ŸÜÿ∏ÿßŸÖ€å ÿ≥ÿßŸÑ ÿßŸàŸÑ', section: 'ÿßŸÑŸÅ' },
                            { id: 3, name: 'ÿ™ÿ¨Ÿà€åÿØ Ÿà ŸÇÿ±ÿ£ÿ™', section: 'ÿ®' },
                        ],
                        'students': [
                            { id: 1, name: 'ÿßÿ≠ŸÖÿØ ÿπŸÑ€å', fatherName: 'ŸÖÿ≠ŸÖÿØ ÿπŸÑ€å', classId: 1, rollNo: '101', contact: '03001234567', address: 'ŸÑÿß€ÅŸàÿ±', admissionDate: '2023-01-15', status: 'active' },
                            { id: 2, name: 'ÿ®ŸÑÿßŸÑ ÿÆÿßŸÜ', fatherName: 'ÿπŸÖÿ±ÿßŸÜ ÿÆÿßŸÜ', classId: 2, rollNo: '201', contact: '03217654321', address: '⁄©ÿ±ÿß⁄Ü€å', admissionDate: '2023-02-20', status: 'active' },
                            { id: 3, name: 'ÿπÿ´ŸÖÿßŸÜ ÿ±ÿ∂ÿß', fatherName: 'ÿ±ÿ∂ÿß ÿ≠ÿ≥€åŸÜ', classId: 1, rollNo: '102', contact: '03339876543', address: 'ÿßÿ≥ŸÑÿßŸÖ ÿ¢ÿ®ÿßÿØ', admissionDate: '2023-03-10', status: 'active' },
                            { id: 4, name: 'ÿ≤€åÿØ ÿ®ŸÜ ÿ≠ÿßÿ±ÿ´', fatherName: 'ÿ≠ÿßÿ±ÿ´ ŸÖÿ≠ŸÖŸàÿØ', classId: 3, rollNo: '301', contact: '03451122334', address: 'Ÿæÿ¥ÿßŸàÿ±', admissionDate: '2023-04-05', status: 'active' },
                        ],
                        'fees': [
                            { studentId: 1, classId: 1, month: 5, year: 2024, amount: 2000, paidAmount: 2000, dueDate: '2024-06-10', paymentDate: '2024-06-05', status: 'paid', paymentMethod: '⁄©€åÿ¥' },
                            { studentId: 2, classId: 2, month: 5, year: 2024, amount: 2500, paidAmount: 0, dueDate: '2024-06-10', paymentDate: null, status: 'unpaid', paymentMethod: null },
                        ],
                        'attendance': [
                            { studentId: 1, classId: 1, date: new Date().toISOString().split('T')[0], status: 'present', timestamp: new Date().toISOString() },
                            { studentId: 3, classId: 1, date: new Date().toISOString().split('T')[0], status: 'absent', timestamp: new Date().toISOString() },
                        ],
                        'bookCategories': [{ id: 1, name: 'ÿ™ŸÅÿ≥€åÿ±' }, { id: 2, name: 'ÿ≠ÿØ€åÿ´' }, { id: 3, name: 'ŸÅŸÇ€Å' }, { id: 4, name: 'ÿ™ÿßÿ±€åÿÆ ÿßÿ≥ŸÑÿßŸÖ' }],
                        'books': [
                            { id: 1, title: 'ÿµÿ≠€åÿ≠ ÿ®ÿÆÿßÿ±€å', author: 'ÿßŸÖÿßŸÖ ÿ®ÿÆÿßÿ±€å', categoryId: 2, isbn: '978-123', quantity: 5, availableQuantity: 4 },
                            { id: 2, title: 'ÿ™ŸÅÿ≥€åÿ± ÿßÿ®ŸÜ ⁄©ÿ´€åÿ±', author: 'ÿßÿ®ŸÜ ⁄©ÿ´€åÿ±', categoryId: 1, isbn: '978-456', quantity: 3, availableQuantity: 3 },
                        ],
                        'settings': [
                            { key: 'schoolName', value: 'ÿ¨ÿßŸÖÿπ€Å ÿßÿ≥ŸÑÿßŸÖ€å€Å' },
                            { key: 'schoolAddress', value: 'ŸÖ€åŸÜ ÿ±Ÿà⁄àÿå ÿßÿ≥ŸÑÿßŸÖ ÿ¢ÿ®ÿßÿØÿå Ÿæÿß⁄©ÿ≥ÿ™ÿßŸÜ' },
                            { key: 'schoolContact', value: '051-1234567' },
                            { key: 'academicYear', value: '2024-2025' },
                            { key: 'feeDueDate', value: '10' }
                        ],
                        'subjects': [{ id: 1, name: 'ŸÇÿ±ÿ¢ŸÜ ⁄©ÿ±€åŸÖ' }, { id: 2, name: 'ÿπÿ±ÿ®€å ⁄Øÿ±ÿßŸÖÿ±' }, { id: 3, name: 'ÿßÿµŸàŸÑŸê ŸÅŸÇ€Å' }],
                        'staff': [
                            { id: 1, name: 'ŸÖŸàŸÑÿßŸÜÿß ÿ∑ÿßÿ±ŸÇ ÿ¨ŸÖ€åŸÑ', designation: 'ÿ¥€åÿÆ ÿßŸÑÿ≠ÿØ€åÿ´', contact: '0301-111222', salary: 80000, joinDate: '2020-01-01' },
                            { id: 2, name: 'ŸÇÿßÿ±€å ÿπÿ®ÿØÿßŸÑÿ®ÿßÿ≥ÿ∑', designation: 'ÿßÿ≥ÿ™ÿßÿØ ÿ™ÿ¨Ÿà€åÿØ', contact: '0302-333444', salary: 55000, joinDate: '2021-05-10' },
                            { id: 3, name: 'ÿß⁄©ÿ±ÿßŸÖ ÿßŸÑÿ≠ŸÇ', designation: 'ÿß⁄©ÿßÿ§ŸÜŸπŸÜŸπ', contact: '0303-555666', salary: 45000, joinDate: '2022-02-15' },
                        ],
                        'salaries': [
                            { staffId: 1, month: 5, year: 2024, amount: 80000, status: 'paid', paymentDate: '2024-06-01' },
                            { staffId: 2, month: 5, year: 2024, amount: 55000, status: 'unpaid', paymentDate: null },
                        ],
                        'exams': [{ id: 1, name: 'ÿ¥ÿ¥ŸÖÿß€Å€å ÿßŸÖÿ™ÿ≠ÿßŸÜ 2024', academicYear: '2024-2025', date: '2024-07-15' }],
                        'marks': [
                            { examId: 1, studentId: 1, subjectId: 1, classId: 1, totalMarks: 100, obtainedMarks: 85 },
                            { examId: 1, studentId: 2, subjectId: 2, classId: 2, totalMarks: 100, obtainedMarks: 78 },
                        ],
                        'income': [{ category: 'ÿπÿ∑€åÿßÿ™', amount: 50000, date: '2024-06-01', description: 'ÿß€å⁄© ŸÖÿÆ€åÿ± ÿ≠ÿ∂ÿ±ÿßÿ™ ⁄©€å ÿ∑ÿ±ŸÅ ÿ≥€í' }],
                        'expenses': [{ category: 'ÿ®ÿ¨ŸÑ€å ⁄©ÿß ÿ®ŸÑ', amount: 15000, date: '2024-06-03', description: 'ŸÖÿ¶€å 2024 ⁄©ÿß ÿ®ŸÑ' }],
                        'notices': [{ title: 'ÿ¥ÿ¥ŸÖÿß€Å€å ÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™ ⁄©ÿß ÿßÿπŸÑÿßŸÜ', content: 'ÿ™ŸÖÿßŸÖ ÿ∑ŸÑÿ®ÿßÿ° ⁄©Ÿà ŸÖÿ∑ŸÑÿπ ⁄©€åÿß ÿ¨ÿßÿ™ÿß €Å€í ⁄©€Å ÿ¥ÿ¥ŸÖÿß€Å€å ÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™ 15 ÿ¨ŸàŸÑÿßÿ¶€å 2024 ÿ≥€í ÿ¥ÿ±Ÿàÿπ €ÅŸà⁄∫ ⁄Ø€í€î', targetAudience: 'students', issueDate: new Date().toISOString().split('T')[0] }],
                        'transportRoutes': [{ id: 1, routeName: 'ÿ±ÿßŸàŸÑŸæŸÜ⁄à€å ÿµÿØÿ±', vehicleNumber: 'RPT-123', driverName: 'ŸÜŸàÿ± ÿÆÿßŸÜ', fee: 1500 }],
                        'transportAssignments': [{ studentId: 1, routeId: 1 }],
                        'hostelRooms': [{ id: 1, roomNumber: 'G-01', capacity: 4, currentOccupants: 1, fee: 3000 }],
                        'hostelAssignments': [{ studentId: 2, roomId: 1 }],
                        'syllabus': [{ classId: 2, subjectId: 2, title: 'ÿπÿ±ÿ®€å ⁄Øÿ±ÿßŸÖÿ± - ÿ¥ÿ¥ŸÖÿß€Å€å', details: 'ÿßÿ®Ÿàÿßÿ® 1 ÿ™ÿß 5' }]
                    };
                    for (const storeName in storesToSeed) {
                        try {
                            const count = await this.dbAction(storeName, 'count');
                            if (count === 0) {
                                console.log(`Seeding ${storeName}...`);
                                await this.dbAction(storeName, 'bulkAdd', storesToSeed[storeName]);
                            }
                        } catch (e) { console.warn(`Could not seed data for store: ${storeName}.`); }
                    }
                },
                dbAction(storeName, action, ...args) {
                    return new Promise((resolve, reject) => {
                        if (!this.db) return reject("Database is not initialized.");
                        if (!this.db.objectStoreNames.contains(storeName)) return reject(`Object store "${storeName}" does not exist.`);
                        const readWrite = ['add', 'put', 'delete', 'clear', 'bulkAdd'];
                        const mode = readWrite.includes(action) ? 'readwrite' : 'readonly';
                        const transaction = this.db.transaction(storeName, mode);
                        const store = transaction.objectStore(storeName);
                        let request;
                        let indexName = null;
                        if (args.length > 0 && typeof args[args.length - 1] === 'string') {
                            const potentialIndexName = args[args.length - 1];
                            if (store.indexNames.contains(potentialIndexName)) {
                                indexName = args.pop();
                            }
                        }
                        const target = indexName ? store.index(indexName) : store;
                        if (action === 'bulkAdd') {
                            const [data] = args;
                            data.forEach(item => store.add(item));
                            request = {};
                        } else {
                            request = target[action](...args);
                        }
                        transaction.oncomplete = () => action === 'bulkAdd' ? resolve() : resolve(request.result);
                        transaction.onerror = (e) => {
                            console.error(`DB Action Error (${storeName}, ${action}):`, e.target.error);
                            reject(e.target.error);
                        };
                    });
                },
                async loadSettings() {
                    try {
                        const settingsArray = await this.dbAction('settings', 'getAll');
                        settingsArray.forEach(item => { this.settings[item.key] = item.value; });
                        document.title = `ŸÖÿØÿ±ÿ≥€Å ÿßŸÜÿ™ÿ∏ÿßŸÖ€å ŸÜÿ∏ÿßŸÖ - ${this.settings.schoolName || 'ÿ¨ÿßŸÖÿπ€Å ÿßÿ≥ŸÑÿßŸÖ€å€Å'}`;
                    } catch (err) { console.error("Failed to load settings:", err); }
                },
                showModal(title, body, footer = '') {
                    document.getElementById('modal-title').innerHTML = title;
                    document.getElementById('modal-body').innerHTML = body;
                    const modalFooter = document.getElementById('modal-footer');
                    if (footer) {
                        modalFooter.innerHTML = footer;
                        modalFooter.style.display = 'flex';
                        modalFooter.style.justifyContent = 'flex-end';
                        modalFooter.style.gap = '10px';
                    } else {
                        modalFooter.style.display = 'none';
                    }
                    document.getElementById('appModal').style.display = 'block';
                },
                closeModal() {
                    document.getElementById('appModal').style.display = 'none';
                    document.getElementById('modal-body').innerHTML = '';
                },
                Dashboard: {
                    async render() {
                        const [studentCount, staffCount, allFees, allAttendance, lastNotice] = await Promise.all([
                            App.dbAction('students', 'count'),
                            App.dbAction('staff', 'count'),
                            App.dbAction('fees', 'getAll'),
                            App.dbAction('attendance', 'getAll'),
                            App.dbAction('notices', 'getAll').then(notices => notices.sort((a, b) => new Date(b.issueDate) - new Date(a.issueDate))[0])
                        ]);
                        const dueFees = allFees.filter(f => f.status !== 'paid');
                        const totalDue = dueFees.reduce((sum, fee) => sum + (fee.amount - fee.paidAmount), 0);
                        const todayStr = new Date().toISOString().split('T')[0];
                        const presentToday = allAttendance.filter(a => a.date === todayStr && a.status === 'present').length;
                        return `
                        <div class="grid-container">
                            <div class="stats-card"><div class="stats-card-icon">üë®‚Äçüéì</div><div class="stats-card-info"><h4>${studentCount}</h4><p>⁄©ŸÑ ÿ∑ŸÑÿ®ÿßÿ°</p></div></div>
                            <div class="stats-card" style="border-color: #17a2b8;"><div class="stats-card-icon" style="color: #17a2b8;">üë®‚Äçüè´</div><div class="stats-card-info"><h4>${staffCount}</h4><p>⁄©ŸÑ ÿßÿ≥ŸπÿßŸÅ</p></div></div>
                            <div class="stats-card" style="border-color: var(--danger);"><div class="stats-card-icon" style="color: var(--danger);">üí∞</div><div class="stats-card-info"><h4>${totalDue.toLocaleString()} <small>PKR</small></h4><p>Ÿàÿßÿ¨ÿ® ÿßŸÑÿßÿØÿß ŸÅ€åÿ≥</p></div></div>
                            <div class="stats-card" style="border-color: var(--warning);"><div class="stats-card-icon" style="color: var(--warning);">üìÖ</div><div class="stats-card-info"><h4>${presentToday || 0}</h4><p>ÿ¢ÿ¨ ÿ≠ÿßÿ∂ÿ±</p></div></div>
                        </div>
                        <div class="grid-container" style="grid-template-columns: 2fr 1fr; margin-top: 20px;">
                            <div class="card"><div class="card-header"><h3 class="card-title">ÿ¢ŸÖÿØŸÜ€å ÿ®ŸÖŸÇÿßÿ®ŸÑ€Å ÿßÿÆÿ±ÿßÿ¨ÿßÿ™ (ÿßÿ≥ ŸÖ€Å€åŸÜ€í)</h3></div><div id="income-expense-chart-container" style="height: 300px;"></div></div>
                            <div class="card"><div class="card-header"><h3 class="card-title">ÿ™ÿßÿ≤€Å ÿ™ÿ±€åŸÜ ŸÜŸàŸπÿ≥</h3></div><div id="latest-notice">${lastNotice ? `<h4>${lastNotice.title}</h4><p>${lastNotice.content.substring(0, 100)}...</p><small>ÿ¨ÿßÿ±€å ÿ¥ÿØ€Å: ${new Date(lastNotice.issueDate).toLocaleDateString('ur-PK')}</small>` : '<p>⁄©Ÿàÿ¶€å ŸÜ€åÿß ŸÜŸàŸπÿ≥ ŸÜ€Å€å⁄∫ €Å€í€î</p>'}</div></div>
                        </div>
                    `;
                    },
                    async postRender() {
                        const currentMonth = new Date().getMonth() + 1;
                        const currentYear = new Date().getFullYear();
                        const allIncome = await App.dbAction('income', 'getAll');
                        const allExpenses = await App.dbAction('expenses', 'getAll');
                        const monthlyIncome = allIncome.filter(i => new Date(i.date).getMonth() + 1 === currentMonth && new Date(i.date).getFullYear() === currentYear).reduce((sum, i) => sum + i.amount, 0);
                        const monthlyExpense = allExpenses.filter(e => new Date(e.date).getMonth() + 1 === currentMonth && new Date(e.date).getFullYear() === currentYear).reduce((sum, e) => sum + e.amount, 0);
                        const chartData = { labels: ['ÿ¢ŸÖÿØŸÜ€å', 'ÿßÿÆÿ±ÿßÿ¨ÿßÿ™'], datasets: [{ data: [monthlyIncome, monthlyExpense], colors: ['#28a745', '#dc3545'] }] };
                        this.createBarChart('income-expense-chart-container', chartData);
                    },
                    createBarChart(containerId, chartData) {
                        const container = document.getElementById(containerId);
                        if (!container) return;
                        const maxValue = Math.max(...chartData.datasets[0].data, 1);
                        const bars = chartData.labels.map((label, index) => {
                            const value = chartData.datasets[0].data[index];
                            const percent = (value / maxValue) * 100;
                            return `<div style="margin-bottom: 10px; text-align: right;"><small>${label} (${value.toLocaleString()} PKR)</small><div style="background-color: var(--bg-surface-2); border-radius: 5px; overflow: hidden;"><div style="width: ${percent}%; background-color: ${chartData.datasets[0].colors[index]}; height: 20px;"></div></div></div>`;
                        }).join('');
                        container.innerHTML = `<div style="padding: 10px;">${bars}</div>`;
                    }
                },
                Students: {
                    render() {
                        return `
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">ÿ∑ŸÑÿ®ÿßÿ° ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™</h3>
                                <button class="btn btn-primary" onclick="App.Students.showForm()">ŸÜ€åÿß ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button>
                            </div>
                            <div class="search-filter-box">
                                <input type="text" id="student-search" class="form-control" placeholder="ŸÜÿßŸÖ €åÿß ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ± ÿ≥€í ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫...">
                                <select id="student-class-filter" class="form-control"></select>
                            </div>
                            <div class="table-responsive">
                                <table id="students-table">
                                    <thead>
                                        <tr>
                                            <th>ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±</th>
                                            <th>ŸÜÿßŸÖ</th>
                                            <th>ŸàÿßŸÑÿØ ⁄©ÿß ŸÜÿßŸÖ</th>
                                            <th>⁄©ŸÑÿßÿ≥</th>
                                            <th>ÿ±ÿßÿ®ÿ∑€Å ŸÜŸÖÿ®ÿ±</th>
                                            <th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    },
                    async postRender() {
                        await this.renderTable();
                        const searchInput = document.getElementById('student-search');
                        const classFilterSelect = document.getElementById('student-class-filter');
                        if (searchInput && !searchInput.dataset.listenerAttached) {
                            searchInput.addEventListener('input', (e) => this.renderTable(e.target.value, classFilterSelect.value));
                            searchInput.dataset.listenerAttached = 'true';
                        }
                        if (classFilterSelect && !classFilterSelect.dataset.listenerAttached) {
                            classFilterSelect.addEventListener('change', (e) => this.renderTable(searchInput.value, e.target.value));
                            classFilterSelect.dataset.listenerAttached = 'true';
                        }
                    },
                    async renderTable(searchTerm = '', classIdFilter = '') {
                        App.showLoader();
                        const tableBody = document.querySelector('#students-table tbody');
                        const classFilter = document.getElementById('student-class-filter');
                        if (classFilter && classFilter.options.length <= 1) {
                            const classes = await App.dbAction('classes', 'getAll');
                            classFilter.innerHTML = `<option value="">ÿ™ŸÖÿßŸÖ ⁄©ŸÑÿßÿ≥ÿ≤</option>` + classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        }
                        let students = await App.dbAction('students', 'getAll');
                        const classes = await App.dbAction('classes', 'getAll');
                        const classMap = new Map(classes.map(c => [c.id, c.name]));
                        if (searchTerm) {
                            students = students.filter(s =>
                                (s.name && s.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                                (s.rollNo && s.rollNo.includes(searchTerm))
                            );
                        }
                        if (classIdFilter && classIdFilter !== "") {
                            students = students.filter(s => s.classId == classIdFilter);
                        }
                        tableBody.innerHTML = students.map(student => `
                        <tr>
                            <td>${student.rollNo}</td>
                            <td>${student.name}</td>
                            <td>${student.fatherName}</td>
                            <td>${classMap.get(student.classId) || 'N/A'}</td>
                            <td>${student.contact || 'N/A'}</td>
                            <td class="action-btns">
                                <button class="btn btn-secondary btn-icon" data-action="view" data-module="students" data-id="${student.id}" title="Ÿæÿ±ŸàŸÅÿßÿ¶ŸÑ ÿØ€å⁄©⁄æ€å⁄∫">üëÅÔ∏è</button>
                                <button class="btn btn-primary btn-icon" data-action="edit" data-module="students" data-id="${student.id}" title="ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-icon" data-action="delete" data-module="students" data-id="${student.id}" title="ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `).join('');
                        App.hideLoader();
                    },
                    async showForm(id = null) {
                        let student = {};
                        const classes = await App.dbAction('classes', 'getAll');
                        if (id) {
                            const studentId = parseInt(id);
                            if (!isNaN(studentId)) {
                                student = await App.dbAction('students', 'get', studentId) || {};
                            } else {
                                console.error("Invalid ID passed to showForm for student:", id);
                                App.showToast("ÿ∫ŸÑÿ∑ ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ID€î ÿ™ÿ±ŸÖ€åŸÖ ⁄©€í ŸÑ€å€í ŸÑŸà⁄à ŸÜ€Å€å⁄∫ ⁄©€åÿß ÿ¨ÿß ÿ≥⁄©ÿß€î", "error");
                                return;
                            }
                        }
                        const classOptions = classes.map(c => `<option value="${c.id}" ${student.classId == c.id ? 'selected' : ''}>${c.name}</option>`).join('');
                        const title = student.id ? 'ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©€å ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ' : 'ŸÜ€åÿß ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫';
                        const formHtml = `
                        <form id="student-form">
                            <input type="hidden" name="id" value="${student.id || ''}">
                            <div class="form-group"><label for="name">ŸÜÿßŸÖ</label><input type="text" id="name" name="name" class="form-control" value="${student.name || ''}" required></div>
                            <div class="form-group"><label for="fatherName">ŸàÿßŸÑÿØ ⁄©ÿß ŸÜÿßŸÖ</label><input type="text" id="fatherName" name="fatherName" class="form-control" value="${student.fatherName || ''}" required></div>
                            <div class="form-group"><label for="rollNo">ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±</label><input type="text" id="rollNo" name="rollNo" class="form-control" value="${student.rollNo || ''}" required></div>
                            <div class="form-group"><label for="classId">⁄©ŸÑÿßÿ≥</label><select id="classId" name="classId" class="form-control" required>${classOptions}</select></div>
                            <div class="form-group"><label for="contact">ÿ±ÿßÿ®ÿ∑€Å ŸÜŸÖÿ®ÿ±</label><input type="tel" id="contact" name="contact" class="form-control" value="${student.contact || ''}"></div>
                            <div class="form-group"><label for="address">Ÿæÿ™€Å</label><textarea id="address" name="address" class="form-control">${student.address || ''}</textarea></div>
                            <div class="form-group"><label for="admissionDate">ÿØÿßÿÆŸÑ€Å ⁄©€å ÿ™ÿßÿ±€åÿÆ</label><input type="date" id="admissionDate" name="admissionDate" class="form-control" value="${student.admissionDate || new Date().toISOString().split('T')[0]}" required></div>
                        </form>
                    `;
                        const footerHtml = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-student-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footerHtml);
                        document.getElementById('save-student-btn').onclick = () => this.saveForm();
                    },
                    async saveForm() {
                        const form = document.getElementById('student-form');
                        if (!form.checkValidity()) { form.reportValidity(); return; }
                        const formData = new FormData(form);
                        const studentData = Object.fromEntries(formData.entries());
                        const formIdString = studentData.id;
                        if (formIdString && formIdString !== "") {
                            studentData.id = parseInt(formIdString);
                            if (isNaN(studentData.id)) {
                                console.error("Student ID from form ('" + formIdString + "') is invalid after parsing.");
                                App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ID ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å: ID ÿ∫€åÿ± ÿπÿØÿØ€å €Å€í€î', 'error');
                                return;
                            }
                        } else {
                            delete studentData.id;
                        }
                        if (studentData.classId && studentData.classId !== "") {
                            studentData.classId = parseInt(studentData.classId);
                            if (isNaN(studentData.classId)) {
                                console.error("Class ID from form ('" + studentData.classId + "') is invalid after parsing.");
                                App.showToast('⁄©ŸÑÿßÿ≥ ID ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å: ID ÿ∫€åÿ± ÿπÿØÿØ€å €Å€í€î', 'error');
                                return;
                            }
                        } else {
                            console.error("Class ID is missing or empty.");
                            App.showToast('⁄©ŸÑÿßÿ≥ ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±ŸÜÿß ÿ∂ÿ±Ÿàÿ±€å €Å€í€î', 'error');
                            return;
                        }
                        try {
                            await App.dbAction('students', 'put', studentData);
                            const actionType = (formIdString && formIdString !== "") ? 'ÿßŸæ ⁄à€åŸπ' : 'ŸÖÿ≠ŸÅŸàÿ∏';
                            App.showToast(`ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©€å ŸÖÿπŸÑŸàŸÖÿßÿ™ ${actionType} €ÅŸà ⁄Øÿ¶€å⁄∫!`, 'success');
                            App.closeModal();
                            const searchVal = document.getElementById('student-search')?.value || '';
                            const filterVal = document.getElementById('student-class-filter')?.value || '';
                            this.renderTable(searchVal, filterVal);
                        } catch (err) {
                            console.error('Error saving student:', err);
                            if (err.name === 'ConstraintError') {
                                App.showToast('€å€Å ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ± Ÿæ€ÅŸÑ€í ÿ≥€í ŸÖŸàÿ¨ŸàÿØ €Å€í€î', 'error');
                            } else {
                                App.showToast(`ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å! (${err.message || err.name})`, 'error');
                            }
                        }
                    },
                    confirmDelete(id) {
                        const body = '<p>⁄©€åÿß ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ÿßÿ≥ ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü €å€Å ÿπŸÖŸÑ ŸàÿßŸæÿ≥ ŸÜ€Å€å⁄∫ ⁄©€åÿß ÿ¨ÿß ÿ≥⁄©ÿ™ÿß€î</p>';
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÜ€Å€å⁄∫</button><button class="btn btn-danger" id="confirm-delete-btn">€Åÿß⁄∫ÿå ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫', body, footer);
                        document.getElementById('confirm-delete-btn').onclick = () => this.deleteStudent(id);
                    },
                    async deleteStudent(id) {
                        try {
                            await App.dbAction('students', 'delete', parseInt(id));
                            App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ≠ÿ∞ŸÅ ⁄©ÿ± ÿØ€åÿß ⁄Ø€åÿß!', 'success');
                            App.closeModal();
                            const searchVal = document.getElementById('student-search')?.value || '';
                            const filterVal = document.getElementById('student-class-filter')?.value || '';
                            this.renderTable(searchVal, filterVal);
                        } catch (err) {
                            console.error('Error deleting student:', err);
                            App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error');
                        }
                    },
                    async viewProfile(id) {
                        const student = await App.dbAction('students', 'get', parseInt(id));
                        if (!student) { App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ŸÜ€Å€å⁄∫ ŸÖŸÑÿß!', 'error'); return; }
                        const studentClass = await App.dbAction('classes', 'get', student.classId);
                        const profileHtml = `
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ Ÿæÿ±ŸàŸÅÿßÿ¶ŸÑ</h3><div><button class="btn btn-secondary" data-action="generate-id" data-module="students" data-id="${student.id}">ID ⁄©ÿßÿ±⁄à ÿ®ŸÜÿßÿ¶€å⁄∫</button><button class="btn btn-primary" onclick="App.navigateTo('students')">ŸàÿßŸæÿ≥</button></div></div>
                            <h4>${student.name}</h4><p>ŸàÿßŸÑÿØ ⁄©ÿß ŸÜÿßŸÖ: ${student.fatherName}</p><p>⁄©ŸÑÿßÿ≥: ${studentClass ? studentClass.name : 'N/A'}</p><p>ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±: ${student.rollNo}</p><p>ÿ±ÿßÿ®ÿ∑€Å ŸÜŸÖÿ®ÿ±: ${student.contact || 'N/A'}</p><p>Ÿæÿ™€Å: ${student.address || 'N/A'}</p><p>ÿØÿßÿÆŸÑ€Å ⁄©€å ÿ™ÿßÿ±€åÿÆ: ${student.admissionDate ? new Date(student.admissionDate).toLocaleDateString('ur-PK') : 'N/A'}</p>
                        </div>
                        <div class="card"><div class="card-header"><h3 class="card-title">ŸÅ€åÿ≥ ⁄©€å ÿ™ÿßÿ±€åÿÆ</h3></div><div id="student-fee-history"></div></div>
                        <div class="card"><div class="card-header"><h3 class="card-title">ŸÑÿßÿ¶ÿ®ÿ±€åÿ±€å ⁄©€å ÿ™ÿßÿ±€åÿÆ</h3></div><div id="student-library-history"></div></div>`;
                        document.getElementById('content-area').innerHTML = profileHtml;
                        App.Fees.viewStudentFeeHistory(id, 'student-fee-history');
                        App.Library.viewStudentLibraryHistory(id, 'student-library-history');
                    },
                    async generateIdCard(id) {
                        const student = await App.dbAction('students', 'get', parseInt(id));
                        if (!student) { App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ŸÜ€Å€å⁄∫ ŸÖŸÑÿß!', 'error'); return; }
                        const studentClass = await App.dbAction('classes', 'get', student.classId);
                        const cardHtml = `
                        <div id="printable-id-card">
                            <div class="id-card">
                                <h3 style="background: #28a745; color: white; padding: 5px; margin: -15px -15px 10px -15px;">${App.settings.schoolName || ''}</h3>
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüë§%3C/text%3E%3C/svg%3E" width="80" height="80" alt="Photo" style="border: 2px solid #ccc; border-radius: 50%;">
                                <h4 style="margin: 10px 0 5px 0;">${student.name}</h4>
                                <p style="font-size: 0.9em;">ŸàÿßŸÑÿØ: ${student.fatherName}</p><p style="font-size: 0.9em;">⁄©ŸÑÿßÿ≥: ${studentClass ? studentClass.name : 'N/A'}</p><p style="font-size: 0.9em;">ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±: ${student.rollNo}</p><hr style="margin: 10px 0;">
                                <p style="font-size: 0.8em;"><b>Ÿæÿ™€Å:</b> ${App.settings.schoolAddress || ''}</p><p style="font-size: 0.8em;"><b>ÿ±ÿßÿ®ÿ∑€Å:</b> ${App.settings.schoolContact || ''}</p><p style="font-size: 0.8em; margin-top: 10px;"><b>ÿ≥ÿßŸÑ:</b> ${App.settings.academicYear || ''}</p>
                            </div>
                        </div>`;
                        App.printContent(cardHtml, 'ID ⁄©ÿßÿ±⁄à');
                    }
                },
                Fees: {
                    render() {
                        return `
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ŸÅ€åÿ≥ ŸÖ€åŸÜÿ¨ŸÖŸÜŸπ</h3></div>
                            <div class="search-filter-box">
                                <input type="text" id="fee-student-search" class="form-control" placeholder="ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©ÿß ŸÜÿßŸÖ/ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±">
                                <select id="fee-class-filter" class="form-control"></select>
                                <select id="fee-status-filter" class="form-control">
                                    <option value="">ÿ™ŸÖÿßŸÖ ÿßÿ≥Ÿπ€åŸπÿ≥</option><option value="unpaid">Ÿàÿßÿ¨ÿ® ÿßŸÑÿßÿØÿß</option><option value="paid">ÿßÿØÿß ÿ¥ÿØ€Å</option><option value="partial">ÿ¨ÿ≤Ÿà€å</option>
                                </select>
                                <button class="btn btn-primary" id="generate-monthly-fees">ŸÖÿß€ÅÿßŸÜ€Å ŸÅ€åÿ≥ ÿ®ŸÜÿßÿ¶€å⁄∫</button>
                            </div>
                            <div class="table-responsive"><table id="fees-table"><thead><tr><th>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ</th><th>⁄©ŸÑÿßÿ≥</th><th>ŸÖ€Å€åŸÜ€Å/ÿ≥ÿßŸÑ</th><th>⁄©ŸÑ ŸÅ€åÿ≥</th><th>ÿßÿØÿß ÿ¥ÿØ€Å</th><th>ÿ®ŸÇÿß€åÿß</th><th>ÿ≠€åÿ´€åÿ™</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>
                        </div>`;
                    },
                    async postRender() {
                        await this.renderTable();
                    },
                    async renderTable() {
                        App.showLoader();
                        const classFilterEl = document.getElementById('fee-class-filter');
                        if (classFilterEl.options.length <= 1) {
                            const classes = await App.dbAction('classes', 'getAll');
                            classFilterEl.innerHTML = `<option value="">ÿ™ŸÖÿßŸÖ ⁄©ŸÑÿßÿ≥ÿ≤</option>` + classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        }
                        const searchTerm = document.getElementById('fee-student-search').value;
                        const classId = document.getElementById('fee-class-filter').value;
                        const status = document.getElementById('fee-status-filter').value;
                        let fees = await App.dbAction('fees', 'getAll');
                        const [students, classes] = await Promise.all([App.dbAction('students', 'getAll'), App.dbAction('classes', 'getAll')]);
                        const studentMap = new Map(students.map(s => [s.id, s]));
                        const classMap = new Map(classes.map(c => [c.id, c.name]));
                        if (status) fees = fees.filter(f => f.status === status);
                        if (classId) fees = fees.filter(f => f.classId == classId);
                        if (searchTerm) {
                            fees = fees.filter(f => {
                                const student = studentMap.get(f.studentId);
                                return student && (student.name.includes(searchTerm) || student.rollNo.includes(searchTerm));
                            });
                        }
                        const tableBody = document.querySelector('#fees-table tbody');
                        tableBody.innerHTML = fees.map(fee => {
                            const student = studentMap.get(fee.studentId);
                            const balance = fee.amount - fee.paidAmount;
                            const statusColors = { paid: 'success', unpaid: 'danger', partial: 'warning' };
                            return `
                            <tr>
                                <td>${student ? student.name : 'ŸÜÿßŸÖÿπŸÑŸàŸÖ'}</td><td>${classMap.get(fee.classId) || 'N/A'}</td><td>${fee.month}/${fee.year}</td><td>${fee.amount}</td><td>${fee.paidAmount}</td><td>${balance}</td>
                                <td><span style="color: var(--${statusColors[fee.status]})">${this.getFeeStatusUrdu(fee.status)}</span></td>
                                <td class="action-btns"><button class="btn btn-primary" data-action="collect" data-module="fees" data-id="${fee.id}">ŸÅ€åÿ≥ ŸàÿµŸàŸÑ ⁄©ÿ±€å⁄∫</button><button class="btn btn-secondary" data-action="view-history" data-module="fees" data-id="${fee.studentId}">ÿ™ÿßÿ±€åÿÆ ÿØ€å⁄©⁄æ€å⁄∫</button></td>
                            </tr>`;
                        }).join('');
                        document.getElementById('fee-student-search').oninput = () => this.renderTable();
                        document.getElementById('fee-class-filter').onchange = () => this.renderTable();
                        document.getElementById('fee-status-filter').onchange = () => this.renderTable();
                        document.getElementById('generate-monthly-fees').onclick = () => this.confirmGenerateMonthlyFees();
                        App.hideLoader();
                    },
                    getFeeStatusUrdu(status) {
                        return { paid: 'ÿßÿØÿß ÿ¥ÿØ€Å', unpaid: 'Ÿàÿßÿ¨ÿ® ÿßŸÑÿßÿØÿß', partial: 'ÿ¨ÿ≤Ÿà€å' }[status] || status;
                    },
                    async showCollectionForm(feeId) {
                        const fee = await App.dbAction('fees', 'get', parseInt(feeId));
                        const student = await App.dbAction('students', 'get', fee.studentId);
                        const title = `ŸÅ€åÿ≥ ŸàÿµŸàŸÑ€å - ${student.name}`;
                        const formHtml = `
                        <form id="fee-collection-form">
                            <p><strong>ŸÖ€Å€åŸÜ€Å:</strong> ${fee.month}/${fee.year}</p><p><strong>⁄©ŸÑ ŸÅ€åÿ≥:</strong> ${fee.amount} PKR</p><p><strong>Ÿæ€ÅŸÑ€í ÿ≥€í ÿßÿØÿß ÿ¥ÿØ€Å:</strong> ${fee.paidAmount} PKR</p><p><strong>ÿ®ŸÇÿß€åÿß:</strong> ${fee.amount - fee.paidAmount} PKR</p><hr>
                            <div class="form-group"><label for="amount-to-pay">ŸàÿµŸàŸÑ ⁄©€å ÿ¨ÿßŸÜ€í ŸàÿßŸÑ€å ÿ±ŸÇŸÖ</label><input type="number" id="amount-to-pay" name="amountToPay" class="form-control" value="${fee.amount - fee.paidAmount}" required></div>
                            <div class="form-group"><label for="payment-method">ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©ÿß ÿ∑ÿ±€åŸÇ€Å</label><select id="payment-method" name="paymentMethod" class="form-control"><option value="⁄©€åÿ¥">⁄©€åÿ¥</option><option value="ÿ®€åŸÜ⁄© Ÿπÿ±ÿßŸÜÿ≥ŸÅÿ±">ÿ®€åŸÜ⁄© Ÿπÿ±ÿßŸÜÿ≥ŸÅÿ±</option><option value="ÿ¨ÿßÿ≤ ⁄©€åÿ¥/ÿß€åÿ≤€å Ÿæ€åÿ≥€Å">ÿ¨ÿßÿ≤ ⁄©€åÿ¥/ÿß€åÿ≤€å Ÿæ€åÿ≥€Å</option></select></div>
                        </form>`;
                        const footerHtml = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="collect-fee-btn">ŸàÿµŸàŸÑ ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ÿ±ÿ≥€åÿØ ÿ®ŸÜÿßÿ¶€å⁄∫</button>`;
                        App.showModal(title, formHtml, footerHtml);
                        document.getElementById('collect-fee-btn').onclick = () => this.collectFee(fee.id);
                    },
                    async collectFee(feeId) {
                        const form = document.getElementById('fee-collection-form');
                        if (!form.checkValidity()) { form.reportValidity(); return; }
                        const amountToPay = parseFloat(document.getElementById('amount-to-pay').value);
                        const paymentMethod = document.getElementById('payment-method').value;
                        const fee = await App.dbAction('fees', 'get', feeId);
                        fee.paidAmount += amountToPay;
                        fee.paymentDate = new Date().toISOString().split('T')[0];
                        fee.paymentMethod = paymentMethod;
                        if (fee.paidAmount >= fee.amount) { fee.status = 'paid'; }
                        else if (fee.paidAmount > 0) { fee.status = 'partial'; }
                        await App.dbAction('fees', 'put', fee);
                        const incomeRecord = { category: 'ŸÅ€åÿ≥', amount: amountToPay, date: fee.paymentDate, description: `Student ${fee.studentId} fee for ${fee.month}/${fee.year}` };
                        await App.dbAction('income', 'add', incomeRecord);
                        App.showToast('ŸÅ€åÿ≥ ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ŸàÿµŸàŸÑ ⁄©€å ⁄Øÿ¶€å!', 'success');
                        App.closeModal();
                        this.renderTable();
                        this.printReceipt(fee.id, amountToPay);
                    },
                    async printReceipt(feeId, paidNow) {
                        const fee = await App.dbAction('fees', 'get', feeId);
                        const [student, sClass] = await Promise.all([App.dbAction('students', 'get', fee.studentId), App.dbAction('classes', 'get', fee.classId)]);
                        const receiptHtml = `
                        <div id="printable-receipt">
                            <div style="text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px;"><h2 style="margin:0;">${App.settings.schoolName || 'ÿ¨ÿßŸÖÿπ€Å ÿßÿ≥ŸÑÿßŸÖ€å€Å'}</h2><p style="margin:5px 0;">${App.settings.schoolAddress || ''}</p><p style="margin:5px 0;">ÿ±ÿßÿ®ÿ∑€Å: ${App.settings.schoolContact || ''}</p><h3 style="margin-top: 10px;">ŸÅ€åÿ≥ ⁄©€å ÿ±ÿ≥€åÿØ</h3></div>
                            <table style="width: 100%; border-collapse: collapse; text-align: right;"><tr><td>ÿ±ÿ≥€åÿØ ŸÜŸÖÿ®ÿ±:</td><td>FEE-${fee.id}</td><td>ÿ™ÿßÿ±€åÿÆ:</td><td>${new Date().toLocaleDateString('ur-PK')}</td></tr><tr><td>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©ÿß ŸÜÿßŸÖ:</td><td>${student.name}</td><td>ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±:</td><td>${student.rollNo}</td></tr><tr><td>⁄©ŸÑÿßÿ≥:</td><td colspan="3">${sClass.name}</td></tr></table>
                            <hr style="margin: 20px 0;"><table style="width: 100%; border-collapse: collapse; text-align: right;"><thead style="background-color: #f2f2f2;"><tr><th>ÿ™ŸÅÿµ€åŸÑ</th><th>ÿ±ŸÇŸÖ</th></tr></thead><tbody><tr><td>ŸÖÿß€ÅÿßŸÜ€Å ŸÅ€åÿ≥ (${fee.month}/${fee.year})</td><td>${fee.amount} PKR</td></tr><tr><td><strong>ÿ¢ÿ¨ ÿßÿØÿß ⁄©€åÿß</strong></td><td><strong>${paidNow} PKR</strong></td></tr><tr><td>⁄©ŸÑ ÿßÿØÿß ÿ¥ÿØ€Å</td><td>${fee.paidAmount} PKR</td></tr><tr><td>ÿ®ŸÇÿß€åÿß</td><td>${fee.amount - fee.paidAmount} PKR</td></tr></tbody></table>
                             <p style="margin-top: 20px;">ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©ÿß ÿ∑ÿ±€åŸÇ€Å: ${fee.paymentMethod}</p><div style="margin-top: 50px; text-align: left; border-top: 1px solid #ccc; padding-top: 5px;"><p>ŸÖŸÜÿ™ÿ∏ŸÖ ⁄©€í ÿØÿ≥ÿ™ÿÆÿ∑</p></div>
                        </div>`;
                        App.printContent(receiptHtml, 'ŸÅ€åÿ≥ ⁄©€å ÿ±ÿ≥€åÿØ');
                    },
                    async viewStudentFeeHistory(studentId, containerId = null) {
                        const fees = await App.dbAction('fees', 'getAll', IDBKeyRange.only(parseInt(studentId)), 'studentId');
                        const historyHtml = `<div class="table-responsive"><table style="width: 100%;"><thead><tr><th>ŸÖ€Å€åŸÜ€Å/ÿ≥ÿßŸÑ</th><th>⁄©ŸÑ ŸÅ€åÿ≥</th><th>ÿßÿØÿß ÿ¥ÿØ€Å</th><th>ÿ®ŸÇÿß€åÿß</th><th>ÿ≠€åÿ´€åÿ™</th><th>ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€å ÿ™ÿßÿ±€åÿÆ</th></tr></thead><tbody>
        ${fees.map(f => `<tr><td>${f.month}/${f.year}</td><td>${f.amount}</td><td>${f.paidAmount}</td><td>${f.amount - f.paidAmount}</td><td>${this.getFeeStatusUrdu(f.status)}</td><td>${f.paymentDate ? new Date(f.paymentDate).toLocaleDateString('ur-PK') : 'N/A'}</td></tr>`).join('')}
    </tbody></table></div>`;
                        if (containerId) {
                            document.getElementById(containerId).innerHTML = historyHtml;
                        } else {
                            App.showModal('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©€å ŸÅ€åÿ≥ ⁄©€å ÿ™ÿßÿ±€åÿÆ', historyHtml);
                        }
                    },
                    confirmGenerateMonthlyFees() {
                        const body = '<p>⁄©€åÿß ÿ¢Ÿæ ÿ™ŸÖÿßŸÖ ŸÅÿπÿßŸÑ ÿ∑ŸÑÿ®ÿßÿ° ⁄©€í ŸÑ€å€í ÿßÿ≥ ŸÖ€Å€åŸÜ€í ⁄©€å ŸÅ€åÿ≥ ÿ®ŸÜÿßŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü €å€Å ÿπŸÖŸÑ ŸÖŸàÿ¨ŸàÿØ€Å ŸÖ€Å€åŸÜ€í ⁄©€í ŸÑ€å€í Ÿæ€ÅŸÑ€í ÿ≥€í ŸÖŸàÿ¨ŸàÿØ ŸÅ€åÿ≥ Ÿàÿßÿ§⁄Üÿ±ÿ≤ ⁄©Ÿà ŸÖÿ™ÿßÿ´ÿ± ŸÜ€Å€å⁄∫ ⁄©ÿ±€í ⁄Øÿß€î</p>';
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÜ€Å€å⁄∫</button><button class="btn btn-primary" id="confirm-generate-btn">€Åÿß⁄∫ÿå ÿ®ŸÜÿßÿ¶€å⁄∫</button>`;
                        App.showModal('ŸÖÿß€ÅÿßŸÜ€Å ŸÅ€åÿ≥ ÿ®ŸÜÿßÿ¶€å⁄∫', body, footer);
                        document.getElementById('confirm-generate-btn').onclick = () => this.generateMonthlyFees();
                    },
                    async generateMonthlyFees() {
                        App.showLoader(); App.closeModal();
                        const students = await App.dbAction('students', 'getAll');
                        const feeStructures = new Map(((await App.dbAction('settings', 'get', 'feeStructures'))?.value || []).map(fs => [fs.classId, fs.amount]));
                        const currentDate = new Date();
                        const currentMonth = currentDate.getMonth() + 1;
                        const currentYear = currentDate.getFullYear();
                        const dueDate = new Date(currentYear, currentMonth - 1, App.settings.feeDueDate || 10).toISOString().split('T')[0];
                        const existingFees = await App.dbAction('fees', 'getAll');
                        let newFeesCount = 0;
                        const feePromises = students.filter(student => student.status === 'active').map(student => {
                            const alreadyExists = existingFees.some(f => f.studentId === student.id && f.month === currentMonth && f.year === currentYear);
                            if (!alreadyExists) {
                                const amount = feeStructures.get(student.classId) || 2000;
                                newFeesCount++;
                                return { studentId: student.id, classId: student.classId, month: currentMonth, year: currentYear, amount: amount, paidAmount: 0, dueDate: dueDate, paymentDate: null, status: 'unpaid', paymentMethod: null };
                            }
                            return null;
                        }).filter(Boolean);
                        if (feePromises.length > 0) { await App.dbAction('fees', 'bulkAdd', feePromises); }
                        App.hideLoader();
                        App.showToast(`${newFeesCount} ÿ∑ŸÑÿ®ÿßÿ° ⁄©€í ŸÑ€å€í ŸÖÿß€ÅÿßŸÜ€Å ŸÅ€åÿ≥ ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ®ŸÜÿß ÿØ€å ⁄Øÿ¶€å!`, 'success');
                        this.renderTable();
                    }
                },
                Salary: {
                    render() {
                        return `<div class="card">
                         <div class="card-header" style="padding: 0; border: none;"><div id="salary-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); width: 100%;"><button class="tab-btn active" data-tab="payments">ÿ™ŸÜÿÆŸàÿß€Å ⁄©€å ÿßÿØÿßÿ¶€å⁄Ø€å</button><button class="tab-btn" data-tab="staff">ÿßÿ≥ŸπÿßŸÅ ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßŸÖ</button></div></div>
                         <div id="salary-content" style="padding-top:20px;"></div>
                    </div>`;
                    },
                    async postRender() {
                        this.renderTabs();
                    },
                    renderTabs() {
                        document.querySelectorAll('#salary-tabs .tab-btn').forEach(btn => {
                            btn.onclick = (e) => {
                                document.querySelectorAll('#salary-tabs .tab-btn').forEach(b => b.classList.remove('active'));
                                e.target.classList.add('active');
                                this.renderTabContent(e.target.dataset.tab);
                            };
                        });
                        this.renderTabContent('payments');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('salary-content');
                        App.showLoader();
                        if (tab === 'payments') {
                            const today = new Date();
                            const month = today.getMonth() + 1;
                            const year = today.getFullYear();
                            contentEl.innerHTML = `<div class="search-filter-box"><label>ŸÖ€Å€åŸÜ€Å ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫:</label><input type="month" id="salary-month-selector" class="form-control" value="${year}-${String(month).padStart(2, '0')}"></div><div class="table-responsive"><table id="salary-payments-table"><thead><tr><th>ÿßÿ≥ŸπÿßŸÅ ⁄©ÿß ŸÜÿßŸÖ</th><th>ÿ™ŸÜÿÆŸàÿß€Å</th><th>ÿ≠€åÿ´€åÿ™</th><th>ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€å ÿ™ÿßÿ±€åÿÆ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderPaymentsTable();
                            const monthSelector = document.getElementById('salary-month-selector');
                            if (monthSelector) monthSelector.onchange = () => this.renderPaymentsTable();
                        } else if (tab === 'staff') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>ÿßÿ≥ŸπÿßŸÅ ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™</h4><button class="btn btn-primary" id="add-staff-btn">ŸÜ€åÿß ÿßÿ≥ŸπÿßŸÅ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="staff-table"><thead><tr><th>ŸÜÿßŸÖ</th><th>ÿπ€ÅÿØ€Å</th><th>ÿ™ŸÜÿÆŸàÿß€Å</th><th>ÿ±ÿßÿ®ÿ∑€Å</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderStaffTable();
                            const addStaffBtn = document.getElementById('add-staff-btn');
                            if (addStaffBtn) addStaffBtn.onclick = () => this.showStaffForm();
                        }
                        App.hideLoader();
                    },
                    async renderStaffTable() {
                        const staff = await App.dbAction('staff', 'getAll');
                        const tableBody = document.querySelector('#staff-table tbody');
                        if (tableBody) {
                            tableBody.innerHTML = staff.map(s => `<tr><td>${s.name}</td><td>${s.designation}</td><td>${s.salary ? s.salary.toLocaleString() : 'N/A'}</td><td>${s.contact || 'N/A'}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="salary" data-id="${s.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="salary" data-id="${s.id}">üóëÔ∏è</button></td></tr>`).join('');
                        }
                    },
                    async renderPaymentsTable() {
                        const monthSelector = document.getElementById('salary-month-selector');
                        if (!monthSelector || !monthSelector.value) {
                            App.hideLoader();
                            return;
                        }
                        const [year, month] = monthSelector.value.split('-').map(Number);
                        const [staffList, paidSalaries] = await Promise.all([App.dbAction('staff', 'getAll'), App.dbAction('salaries', 'getAll')]);
                        const tableBody = document.querySelector('#salary-payments-table tbody');
                        if (tableBody) {
                            tableBody.innerHTML = staffList.map(staffMember => {
                                const salaryRecord = paidSalaries.find(s => s.staffId === staffMember.id && s.month === month && s.year === year);
                                const status = salaryRecord ? salaryRecord.status : 'unpaid';
                                const statusText = status === 'paid' ? 'ÿßÿØÿß ÿ¥ÿØ€Å' : 'Ÿàÿßÿ¨ÿ® ÿßŸÑÿßÿØÿß';
                                const statusColor = status === 'paid' ? 'var(--success)' : 'var(--danger)';
                                const paymentDate = App.formatDate(salaryRecord?.paymentDate, '---', `Salary Record ID ${salaryRecord?.id}`);
                                const actionBtn = status === 'unpaid'
                                    ? `<button class="btn btn-primary" data-action="pay" data-module="salary" data-id="${staffMember.id}">ÿ™ŸÜÿÆŸàÿß€Å ÿßÿØÿß ⁄©ÿ±€å⁄∫</button>`
                                    : `<button class="btn btn-secondary" data-action="payslip" data-module="salary" data-id="${salaryRecord.id}">Ÿæ€í ÿ≥ŸÑŸæ</button>`;
                                return `<tr>
                                    <td>${staffMember.name}</td>
                                    <td>${staffMember.salary ? staffMember.salary.toLocaleString() : 'N/A'}</td>
                                    <td style="color: ${statusColor};">${statusText}</td>
                                    <td>${paymentDate}</td>
                                    <td class="action-btns">${actionBtn}</td>
                                </tr>`;
                            }).join('');
                        }
                    },
                    async showStaffForm(id = null) {
                        let staffMember = {};
                        if (id) {
                            const staffId = parseInt(id);
                            if (!isNaN(staffId)) {
                                staffMember = await App.dbAction('staff', 'get', staffId) || {};
                            } else {
                                App.showToast("ÿ∫ŸÑÿ∑ ÿßÿ≥ŸπÿßŸÅ ID", "error");
                                return;
                            }
                        }
                        const title = staffMember.id ? 'ÿßÿ≥ŸπÿßŸÅ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫' : 'ŸÜ€åÿß ÿßÿ≥ŸπÿßŸÅ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫';
                        const formHtml = `<form id="staff-form"><input type="hidden" name="id" value="${staffMember.id || ''}"><div class="form-group"><label>ŸÜÿßŸÖ</label><input type="text" name="name" class="form-control" value="${staffMember.name || ''}" required></div><div class="form-group"><label>ÿπ€ÅÿØ€Å</label><input type="text" name="designation" class="form-control" value="${staffMember.designation || ''}" required></div><div class="form-group"><label>ÿ®ŸÜ€åÿßÿØ€å ÿ™ŸÜÿÆŸàÿß€Å</label><input type="number" name="salary" class="form-control" value="${staffMember.salary || ''}" min="0" required></div><div class="form-group"><label>ÿ±ÿßÿ®ÿ∑€Å</label><input type="text" name="contact" class="form-control" value="${staffMember.contact || ''}"></div><div class="form-group"><label>ÿ¥ŸÖŸàŸÑ€åÿ™ ⁄©€å ÿ™ÿßÿ±€åÿÆ</label><input type="date" name="joinDate" class="form-control" value="${staffMember.joinDate || new Date().toISOString().split('T')[0]}" required></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-staff-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        const saveBtn = document.getElementById('save-staff-btn');
                        if (saveBtn) saveBtn.onclick = () => this.saveStaffForm();
                    },
                    async saveStaffForm() {
                        const form = document.getElementById('staff-form');
                        if (!form.checkValidity()) { form.reportValidity(); return; }
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        const formIdString = data.id;
                        if (formIdString && formIdString !== "") {
                            data.id = parseInt(formIdString);
                            if (isNaN(data.id)) {
                                App.showToast('ÿßÿ≥ŸπÿßŸÅ ID ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å: ID ÿ∫€åÿ± ÿπÿØÿØ€å €Å€í€î', 'error');
                                return;
                            }
                        } else {
                            delete data.id;
                        }
                        data.salary = parseFloat(data.salary);
                        if (isNaN(data.salary) || data.salary < 0) {
                            App.showToast('ÿ™ŸÜÿÆŸàÿß€Å ÿØÿ±ÿ≥ÿ™ €ÅŸàŸÜ€å ⁄Üÿß€Å€å€í€î', 'error');
                            return;
                        }
                        try {
                            await App.dbAction('staff', 'put', data);
                            App.showToast('ÿßÿ≥ŸπÿßŸÅ ⁄©€å ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Øÿ¶€å⁄∫!', 'success');
                            App.closeModal();
                            this.renderStaffTable();
                            this.renderPaymentsTable();
                        } catch (err) {
                            console.error('Error saving staff:', err);
                            App.showToast(`ÿßÿ≥ŸπÿßŸÅ ⁄©Ÿà ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å! (${err.message || err.name})`, 'error');
                        }
                    },
                    async showPaymentForm(staffId) {
                        const staffMember = await App.dbAction('staff', 'get', parseInt(staffId));
                        if (!staffMember) { App.showToast("ÿßÿ≥ŸπÿßŸÅ ŸÖŸÖÿ®ÿ± ŸÜ€Å€å⁄∫ ŸÖŸÑÿß!", "error"); return; }
                        const monthSelector = document.getElementById('salary-month-selector');
                        if (!monthSelector || !monthSelector.value) { App.showToast("ŸÖ€Å€åŸÜ€Å ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫!", "error"); return; }
                        const [year, month] = monthSelector.value.split('-').map(Number);
                        const title = `${staffMember.name} ⁄©€å ÿ™ŸÜÿÆŸàÿß€Å ⁄©€å ÿßÿØÿßÿ¶€å⁄Ø€å`;
                        const body = `<p><strong>ŸÖ€Å€åŸÜ€Å:</strong> ${month}/${year}</p><p><strong>ÿ™ŸÜÿÆŸàÿß€Å:</strong> ${staffMember.salary ? staffMember.salary.toLocaleString() : 'N/A'} PKR</p><p>⁄©€åÿß ÿ¢Ÿæ ÿßÿ≥ ÿ™ŸÜÿÆŸàÿß€Å ⁄©€å ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€å ÿ™ÿµÿØ€åŸÇ ⁄©ÿ±ÿ™€í €Å€å⁄∫ÿü</p>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="confirm-pay-btn">€Åÿß⁄∫ÿå ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, body, footer);
                        const confirmBtn = document.getElementById('confirm-pay-btn');
                        if (confirmBtn) confirmBtn.onclick = () => this.processPayment(staffMember.id, staffMember.salary, month, year);
                    },
                    async processPayment(staffId, amount, month, year) {
                        const paymentDate = new Date().toISOString().split('T')[0];
                        const salaryRecord = { staffId, amount, month, year, status: 'paid', paymentDate: paymentDate };
                        await App.dbAction('salaries', 'add', salaryRecord);
                        const staffMember = await App.dbAction('staff', 'get', staffId);
                        const expenseRecord = {
                            category: 'ÿ™ŸÜÿÆŸàÿß€Å€å⁄∫',
                            amount,
                            date: paymentDate,
                            description: `Staff: ${staffMember ? staffMember.name : 'ID ' + staffId} salary for ${month}/${year}`
                        };
                        await App.dbAction('expenses', 'add', expenseRecord);
                        App.showToast('ÿ™ŸÜÿÆŸàÿß€Å ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿßÿØÿß ⁄©ÿ± ÿØ€å ⁄Øÿ¶€å!', 'success');
                        App.closeModal();
                        this.renderPaymentsTable();
                    },
                    async generatePayslip(salaryId) {
                        const salary = await App.dbAction('salaries', 'get', parseInt(salaryId));
                        if (!salary) { App.showToast("ÿ™ŸÜÿÆŸàÿß€Å ⁄©ÿß ÿ±€å⁄©ÿßÿ±⁄à ŸÜ€Å€å⁄∫ ŸÖŸÑÿß!", "error"); return; }
                        const staffMember = await App.dbAction('staff', 'get', salary.staffId);
                        if (!staffMember) { App.showToast("ÿßÿ≥ŸπÿßŸÅ ŸÖŸÖÿ®ÿ± ŸÜ€Å€å⁄∫ ŸÖŸÑÿß!", "error"); return; }
                        const payslipHtml = `<div id="printable-payslip"><h2 style="text-align:center;">${App.settings.schoolName || ''}</h2><h3 style="text-align:center;">Ÿæ€í ÿ≥ŸÑŸæ</h3><p><strong>ŸÖ€Å€åŸÜ€Å:</strong> ${salary.month}/${salary.year}</p><p><strong>ÿßÿ≥ŸπÿßŸÅ ⁄©ÿß ŸÜÿßŸÖ:</strong> ${staffMember.name}</p><p><strong>ÿπ€ÅÿØ€Å:</strong> ${staffMember.designation}</p><hr><table style="width:100%"><tr><td>ÿ®ŸÜ€åÿßÿØ€å ÿ™ŸÜÿÆŸàÿß€Å:</td><td style="text-align:left;">${staffMember.salary ? staffMember.salary.toLocaleString() : 'N/A'} PKR</td></tr></table><hr><p><strong>⁄©ŸÑ ÿßÿØÿß ÿ¥ÿØ€Å: ${salary.amount.toLocaleString()} PKR</strong></p><p><small>ÿßÿØÿßÿ¶€å⁄Ø€å ⁄©€å ÿ™ÿßÿ±€åÿÆ: ${salary.paymentDate ? App.formatDate(salary.paymentDate) : 'N/A'}</small></p></div>`;
                        App.printContent(payslipHtml, 'Ÿæ€í ÿ≥ŸÑŸæ');
                    },
                    confirmDeleteStaff(id) {
                        const body = '<p>⁄©€åÿß ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ÿßÿ≥ ÿßÿ≥ŸπÿßŸÅ ŸÖŸÖÿ®ÿ± ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü<br>ÿßÿ≥ ÿ≥€í ŸÖŸÜÿ≥ŸÑ⁄© ÿ™ŸÜÿÆŸàÿß€Å ⁄©€í ÿ±€å⁄©ÿßÿ±⁄à ÿ≠ÿ∞ŸÅ ŸÜ€Å€å⁄∫ €ÅŸà⁄∫ ⁄Ø€í ŸÑ€å⁄©ŸÜ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑ ŸÖ€å⁄∫ ÿßÿ≥ ÿßÿ≥ŸπÿßŸÅ ⁄©€í ŸÑ€å€í ÿ™ŸÜÿÆŸàÿß€Å ŸÜ€Å€å⁄∫ ÿ®ŸÜÿßÿ¶€å ÿ¨ÿß ÿ≥⁄©€í ⁄Ø€å€î</p>';
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÜ€Å€å⁄∫</button><button class="btn btn-danger" id="confirm-delete-staff-btn">€Åÿß⁄∫ÿå ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('ÿßÿ≥ŸπÿßŸÅ ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫', body, footer);
                        const confirmBtn = document.getElementById('confirm-delete-staff-btn');
                        if (confirmBtn) confirmBtn.onclick = () => this.deleteStaff(id);
                    },
                    async deleteStaff(id) {
                        try {
                            await App.dbAction('staff', 'delete', parseInt(id));
                            App.showToast('ÿßÿ≥ŸπÿßŸÅ ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ± ÿØ€åÿß ⁄Ø€åÿß!', 'success');
                            App.closeModal();
                            this.renderStaffTable();
                            this.renderPaymentsTable();
                        } catch (err) {
                            console.error("Error deleting staff:", err);
                            App.showToast("ÿßÿ≥ŸπÿßŸÅ ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!", "error");
                        }
                    }
                },
                Accounts: {
                    render() {
                        return `<div class="card"><div class="card-header" style="padding: 0; border: none;"><div id="accounts-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); width: 100%;"><button class="tab-btn active" data-tab="overview">ÿ¨ÿßÿ¶ÿ≤€Å</button><button class="tab-btn" data-tab="income">ÿ¢ŸÖÿØŸÜ€å</button><button class="tab-btn" data-tab="expenses">ÿßÿÆÿ±ÿßÿ¨ÿßÿ™</button></div></div><div id="accounts-content" style="padding-top:20px;"></div></div>`;
                    },
                    async postRender() {
                        this.renderTabs();
                    },
                    renderTabs() {
                        document.querySelectorAll('#accounts-tabs .tab-btn').forEach(btn => btn.onclick = (e) => {
                            document.querySelectorAll('#accounts-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                            this.renderTabContent(e.target.dataset.tab);
                        });
                        this.renderTabContent('overview');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('accounts-content');
                        App.showLoader();
                        switch (tab) {
                            case 'overview':
                                contentEl.innerHTML = await this.getOverviewHtml();
                                break;
                            case 'income':
                                contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>ÿ¢ŸÖÿØŸÜ€å ⁄©ÿß ÿ±€å⁄©ÿßÿ±⁄à</h4><button class="btn btn-primary" id="add-income-btn">ŸÜÿ¶€å ÿ¢ŸÖÿØŸÜ€å ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="income-table"><thead><tr><th>ÿ™ÿßÿ±€åÿÆ</th><th>ÿ≤ŸÖÿ±€Å</th><th>ÿ±ŸÇŸÖ</th><th>ÿ™ŸÅÿµ€åŸÑ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                                await this.renderIncomeTable();
                                const addIncomeBtn = document.getElementById('add-income-btn');
                                if (addIncomeBtn) addIncomeBtn.onclick = () => this.showTransactionForm('income');
                                break;
                            case 'expenses':
                                contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>ÿßÿÆÿ±ÿßÿ¨ÿßÿ™ ⁄©ÿß ÿ±€å⁄©ÿßÿ±⁄à</h4><button class="btn btn-primary" id="add-expense-btn">ŸÜ€åÿß ÿÆÿ±⁄Ü ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="expenses-table"><thead><tr><th>ÿ™ÿßÿ±€åÿÆ</th><th>ÿ≤ŸÖÿ±€Å</th><th>ÿ±ŸÇŸÖ</th><th>ÿ™ŸÅÿµ€åŸÑ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                                await this.renderExpensesTable();
                                const addExpenseBtn = document.getElementById('add-expense-btn');
                                if (addExpenseBtn) addExpenseBtn.onclick = () => this.showTransactionForm('expenses');
                                break;
                        }
                        App.hideLoader();
                    },
                    async getOverviewHtml() {
                        const [allIncome, allExpenses] = await Promise.all([App.dbAction('income', 'getAll'), App.dbAction('expenses', 'getAll')]);
                        const totalIncome = allIncome.reduce((sum, i) => sum + i.amount, 0);
                        const totalExpenses = allExpenses.reduce((sum, e) => sum + e.amount, 0);
                        const balance = totalIncome - totalExpenses;
                        const balanceColor = balance >= 0 ? 'var(--success)' : 'var(--danger)';
                        return `<div class="grid-container"><div class="stats-card"><div class="stats-card-icon">‚ûï</div><div class="stats-card-info"><h4>${totalIncome.toLocaleString()}</h4><p>⁄©ŸÑ ÿ¢ŸÖÿØŸÜ€å</p></div></div><div class="stats-card"><div class="stats-card-icon">‚ûñ</div><div class="stats-card-info"><h4>${totalExpenses.toLocaleString()}</h4><p>⁄©ŸÑ ÿßÿÆÿ±ÿßÿ¨ÿßÿ™</p></div></div><div class="stats-card"><div class="stats-card-icon">‚öñÔ∏è</div><div class="stats-card-info"><h4 style="color:${balanceColor}">${balance.toLocaleString()}</h4><p>ŸÖŸàÿ¨ŸàÿØ€Å ÿ®€åŸÑŸÜÿ≥</p></div></div></div>`;
                    },
                    async renderIncomeTable() {
                        const income = await App.dbAction('income', 'getAll');
                        const incomeTableBody = document.querySelector('#income-table tbody');
                        if (incomeTableBody) {
                            incomeTableBody.innerHTML = income.sort((a, b) => new Date(b.date) - new Date(a.date)).map(i => `<tr><td>${App.formatDate(i.date)}</td><td>${i.category}</td><td>${i.amount.toLocaleString()}</td><td>${i.description || 'N/A'}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="accounts" data-type="income" data-id="${i.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="accounts" data-type="income" data-id="${i.id}">üóëÔ∏è</button></td></tr>`).join('');
                        }
                    },
                    async renderExpensesTable() {
                        const expenses = await App.dbAction('expenses', 'getAll');
                        const expensesTableBody = document.querySelector('#expenses-table tbody');
                        if (expensesTableBody) {
                            expensesTableBody.innerHTML = expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(e => `<tr><td>${App.formatDate(e.date)}</td><td>${e.category}</td><td>${e.amount.toLocaleString()}</td><td>${e.description || 'N/A'}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="accounts" data-type="expenses" data-id="${e.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="accounts" data-type="expenses" data-id="${e.id}">üóëÔ∏è</button></td></tr>`).join('');
                        }
                    },
                    async showTransactionForm(type, id = null) {
                        let item = {};
                        if (id) {
                            const itemId = parseInt(id);
                            if (!isNaN(itemId)) {
                                item = await App.dbAction(type, 'get', itemId) || {};
                            } else {
                                App.showToast("ÿ∫ŸÑÿ∑ ÿ±€å⁄©ÿßÿ±⁄à ID", "error");
                                return;
                            }
                        }
                        const isIncome = type === 'income';
                        const title = `${item.id ? 'ÿ™ÿ±ŸÖ€åŸÖ' : 'ŸÜ€åÿß'} ${isIncome ? 'ÿ¢ŸÖÿØŸÜ€å' : 'ÿÆÿ±⁄Ü'}`;
                        const catListId = `${type}-cats`;
                        const catOptions = isIncome
                            ? `<option value="ŸÅ€åÿ≥"><option value="ÿπÿ∑€åÿßÿ™"><option value="ÿØ€å⁄Øÿ± ÿ¢ŸÖÿØŸÜ€å">`
                            : `<option value="ÿ™ŸÜÿÆŸàÿß€Å€å⁄∫"><option value="€åŸàŸπ€åŸÑ€åŸπ€å ÿ®ŸÑÿ≤"><option value="ŸÖÿ±ŸÖÿ™"><option value="ÿÆÿ±€åÿØÿßÿ±€å"><option value="ÿØ€å⁄Øÿ± ÿßÿÆÿ±ÿßÿ¨ÿßÿ™">`;
                        const formHtml = `<form id="transaction-form">
                        <input type="hidden" name="id" value="${item.id || ''}"><input type="hidden" name="type" value="${type}">
                        <div class="form-group"><label>ÿ™ÿßÿ±€åÿÆ</label><input type="date" name="date" class="form-control" value="${item.date || new Date().toISOString().split('T')[0]}" required></div>
                        <div class="form-group"><label>ÿ≤ŸÖÿ±€Å</label><input type="text" name="category" list="${catListId}" class="form-control" value="${item.category || ''}" required><datalist id="${catListId}">${catOptions}</datalist></div>
                        <div class="form-group"><label>ÿ±ŸÇŸÖ</label><input type="number" name="amount" class="form-control" value="${item.amount || ''}" min="0" required></div>
                        <div class="form-group"><label>ÿ™ŸÅÿµ€åŸÑ</label><input type="text" name="description" class="form-control" value="${item.description || ''}"></div>
                    </form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-transaction-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        const saveBtn = document.getElementById('save-transaction-btn');
                        if (saveBtn) saveBtn.onclick = () => this.saveTransactionForm();
                    },
                    async saveTransactionForm() {
                        const form = document.getElementById('transaction-form');
                        if (!form.checkValidity()) { form.reportValidity(); return; }
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        const type = data.type;
                        delete data.type;
                        const formIdString = data.id;
                        if (formIdString && formIdString !== "") {
                            data.id = parseInt(formIdString);
                            if (isNaN(data.id)) {
                                App.showToast('Ÿπÿ±ÿßŸÜÿ≤€å⁄©ÿ¥ŸÜ ID ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å: ID ÿ∫€åÿ± ÿπÿØÿØ€å €Å€í€î', 'error');
                                return;
                            }
                        } else {
                            delete data.id;
                        }
                        data.amount = parseFloat(data.amount);
                        if (isNaN(data.amount) || data.amount <= 0) {
                            App.showToast('ÿ±ŸÇŸÖ ÿØÿ±ÿ≥ÿ™ €ÅŸàŸÜ€å ⁄Üÿß€Åÿ¶€í ÿßŸàÿ± ÿµŸÅÿ± ÿ≥€í ÿ≤€åÿßÿØ€Å€î', 'error');
                            return;
                        }
                        try {
                            await App.dbAction(type, 'put', data);
                            App.showToast('ÿ±€å⁄©ÿßÿ±⁄à ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Ø€åÿß!', 'success');
                            App.closeModal();
                            if (type === 'income') {
                                this.renderIncomeTable();
                            } else {
                                this.renderExpensesTable();
                            }
                            if (document.querySelector('#accounts-tabs .tab-btn[data-tab="overview"].active')) {
                                this.renderTabContent('overview');
                            }
                        } catch (err) {
                            console.error(`Error saving ${type}:`, err);
                            App.showToast(`${type} ⁄©Ÿà ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å! (${err.message || err.name})`, 'error');
                        }
                    },
                    confirmDeleteTransaction(type, id) {
                        const body = '<p>⁄©€åÿß ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ÿßÿ≥ ÿ±€å⁄©ÿßÿ±⁄à ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü</p>';
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÜ€Å€å⁄∫</button><button class="btn btn-danger" id="confirm-delete-transaction-btn">€Åÿß⁄∫ÿå ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('ÿ±€å⁄©ÿßÿ±⁄à ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫', body, footer);
                        const confirmBtn = document.getElementById('confirm-delete-transaction-btn');
                        if (confirmBtn) confirmBtn.onclick = () => this.deleteTransaction(type, id);
                    },
                    async deleteTransaction(type, id) {
                        try {
                            await App.dbAction(type, 'delete', parseInt(id));
                            App.showToast('ÿ±€å⁄©ÿßÿ±⁄à ÿ≠ÿ∞ŸÅ ⁄©ÿ± ÿØ€åÿß ⁄Ø€åÿß!', 'success');
                            App.closeModal();
                            if (type === 'income') {
                                this.renderIncomeTable();
                            } else {
                                this.renderExpensesTable();
                            }
                            if (document.querySelector('#accounts-tabs .tab-btn[data-tab="overview"].active')) {
                                this.renderTabContent('overview');
                            }
                        } catch (err) {
                            console.error(`Error deleting ${type}:`, err);
                            App.showToast(`${type} ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å! (${err.message || err.name})`, 'error');
                        }
                    }
                },
                Attendance: {
                    render() {
                        return `
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ÿ±Ÿàÿ≤ÿßŸÜ€Å ÿ≠ÿßÿ∂ÿ±€å</h3></div>
                            <div class="search-filter-box"><select id="attendance-class-selector" class="form-control"></select><input type="date" id="attendance-date-selector" class="form-control" value="${new Date().toISOString().split('T')[0]}"></div>
                            <div class="table-responsive"><table id="attendance-table"><thead><tr><th>ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±</th><th>ŸÜÿßŸÖ</th><th>ÿ≠€åÿ´€åÿ™</th></tr></thead><tbody></tbody></table></div>
                            <div style="text-align: left; margin-top: 20px;"><button class="btn btn-primary" id="save-attendance-btn">ÿ≠ÿßÿ∂ÿ±€å ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button></div>
                        </div>`;
                    },
                    async postRender() {
                        await this.renderSelector();
                    },
                    async renderSelector() {
                        const classSelector = document.getElementById('attendance-class-selector');
                        const classes = await App.dbAction('classes', 'getAll');
                        classSelector.innerHTML = classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                        classSelector.onchange = () => this.renderAttendanceSheet();
                        document.getElementById('attendance-date-selector').onchange = () => this.renderAttendanceSheet();
                        document.getElementById('save-attendance-btn').onclick = () => this.saveAttendance();
                        if (classes.length > 0) {
                            this.renderAttendanceSheet();
                        }
                    },
                    async renderAttendanceSheet() {
                        App.showLoader();
                        const classId = parseInt(document.getElementById('attendance-class-selector').value);
                        const date = document.getElementById('attendance-date-selector').value;
                        const students = await App.dbAction('students', 'getAll', IDBKeyRange.only(classId), 'classId');
                        const allAttendance = await App.dbAction('attendance', 'getAll', IDBKeyRange.only(date), 'date');
                        const attendanceMap = new Map(allAttendance.map(a => [a.studentId, a.status]));
                        const tableBody = document.querySelector('#attendance-table tbody');
                        tableBody.innerHTML = students.map(student => {
                            const status = attendanceMap.get(student.id) || 'present';
                            return `
            <tr data-student-id="${student.id}"><td>${student.rollNo}</td><td>${student.name}</td><td>
                <input type="radio" name="status-${student.id}" value="present" ${status === 'present' ? 'checked' : ''}> ÿ≠ÿßÿ∂ÿ±
                <input type="radio" name="status-${student.id}" value="absent" ${status === 'absent' ? 'checked' : ''}> ÿ∫€åÿ± ÿ≠ÿßÿ∂ÿ±
                <input type="radio" name="status-${student.id}" value="leave" ${status === 'leave' ? 'checked' : ''}> ÿ±ÿÆÿµÿ™
            </td></tr>`;
                        }).join('');
                        App.hideLoader();
                    },
                    async saveAttendance() {
                        App.showLoader();
                        try {
                            const classId = parseInt(document.getElementById('attendance-class-selector').value);
                            const date = document.getElementById('attendance-date-selector').value;
                            const rows = document.querySelectorAll('#attendance-table tbody tr');
                            const recordsFromForm = Array.from(rows).map(row => ({
                                studentId: parseInt(row.dataset.studentId),
                                classId,
                                date,
                                status: row.querySelector('input[type="radio"]:checked').value,
                                timestamp: new Date().toISOString()
                            }));
                            const existingRecordsForDay = await App.dbAction('attendance', 'getAll', date, 'date');
                            const classAttendance = existingRecordsForDay.filter(rec => rec.classId === classId);
                            const existingMap = new Map(classAttendance.map(rec => [rec.studentId, rec]));
                            const recordsToSave = recordsFromForm.map(newRecord => {
                                const existing = existingMap.get(newRecord.studentId);
                                if (existing) {
                                    newRecord.id = existing.id;
                                }
                                return newRecord;
                            });
                            const tx = App.db.transaction(['attendance'], 'readwrite');
                            const store = tx.objectStore('attendance');
                            for (const record of recordsToSave) {
                                store.put(record);
                            }
                            await new Promise((resolve, reject) => {
                                tx.oncomplete = resolve;
                                tx.onerror = event => reject(event.target.error);
                            });
                            App.hideLoader();
                            App.showToast('ÿ≠ÿßÿ∂ÿ±€å ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Øÿ¶€å!', 'success');
                        } catch (err) {
                            App.hideLoader();
                            console.error("Error saving attendance", err);
                            App.showToast(`ÿ≠ÿßÿ∂ÿ±€å ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å: ${err.message}`, 'error');
                        }
                    }
                },
                Exams: {
                    render() {
                        return `<div class="card"><div class="card-header" style="padding: 0; border: none;"><div id="exams-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); width: 100%;"><button class="tab-btn active" data-tab="list">ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™</button><button class="tab-btn" data-tab="marks">ŸÜŸÖÿ®ÿ±Ÿà⁄∫ ⁄©ÿß ÿßŸÜÿØÿ±ÿßÿ¨</button><button class="tab-btn" data-tab="cards">ÿ±ÿ≤ŸÑŸπ ⁄©ÿßÿ±⁄àÿ≤</button></div></div><div id="exams-content" style="padding-top:20px;"></div></div>`;
                    },
                    async postRender() { this.renderTabs(); },
                    renderTabs() {
                        document.querySelectorAll('#exams-tabs .tab-btn').forEach(btn => btn.onclick = (e) => {
                            document.querySelectorAll('#exams-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                            this.renderTabContent(e.target.dataset.tab);
                        });
                        this.renderTabContent('list');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('exams-content');
                        App.showLoader();
                        if (tab === 'list') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>ÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™</h4><button class="btn btn-primary" onclick="App.Exams.showExamForm()">ŸÜ€åÿß ÿßŸÖÿ™ÿ≠ÿßŸÜ ÿ®ŸÜÿßÿ¶€å⁄∫</button></div><div class="table-responsive"><table id="exams-table"><thead><tr><th>ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ÿß ŸÜÿßŸÖ</th><th>ÿ™ÿπŸÑ€åŸÖ€å ÿ≥ÿßŸÑ</th><th>ÿ™ÿßÿ±€åÿÆ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderExamsTable();
                        } else if (tab === 'marks') {
                            const [exams, classes] = await Promise.all([App.dbAction('exams', 'getAll'), App.dbAction('classes', 'getAll')]);
                            contentEl.innerHTML = `<h4>ŸÜŸÖÿ®ÿ±Ÿà⁄∫ ⁄©ÿß ÿßŸÜÿØÿ±ÿßÿ¨</h4><div class="search-filter-box"><select id="marks-exam-selector" class="form-control">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select><select id="marks-class-selector" class="form-control">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select><button class="btn btn-primary" id="load-marks-sheet">ÿ¥€åŸπ ŸÑŸà⁄à ⁄©ÿ±€å⁄∫</button></div><div id="marks-entry-sheet"></div>`;
                            document.getElementById('load-marks-sheet').onclick = () => this.renderMarksEntrySheet();
                        } else if (tab === 'cards') {
                            const [exams, classes] = await Promise.all([App.dbAction('exams', 'getAll'), App.dbAction('classes', 'getAll')]);
                            contentEl.innerHTML = `<h4>ÿ±ÿ≤ŸÑŸπ ⁄©ÿßÿ±⁄àÿ≤</h4><div class="search-filter-box"><select id="card-exam-selector" class="form-control">${exams.map(e => `<option value="${e.id}">${e.name}</option>`).join('')}</select><select id="card-class-selector" class="form-control">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select><button class="btn btn-primary" id="load-card-list">ŸÅ€Åÿ±ÿ≥ÿ™ ŸÑŸà⁄à ⁄©ÿ±€å⁄∫</button></div><div id="card-list-container"></div>`;
                            document.getElementById('load-card-list').onclick = () => this.renderResultCardList();
                        }
                        App.hideLoader();
                    },
                    async renderExamsTable() {
                        const exams = await App.dbAction('exams', 'getAll');
                        document.querySelector('#exams-table tbody').innerHTML = exams.map(e => `<tr><td>${e.name}</td><td>${e.academicYear}</td><td>${e.date}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="exams" data-id="${e.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="exams" data-id="${e.id}">üóëÔ∏è</button></td></tr>`).join('');
                    },
                    async renderMarksEntrySheet() {
                        App.showLoader();
                        const examId = parseInt(document.getElementById('marks-exam-selector').value);
                        const classId = parseInt(document.getElementById('marks-class-selector').value);
                        const [students, subjects, marks] = await Promise.all([App.dbAction('students', 'getAll', IDBKeyRange.only(classId), 'classId'), App.dbAction('subjects', 'getAll'), App.dbAction('marks', 'getAll', IDBKeyRange.only(examId), 'examId')]);
                        const sheet = `<div class="table-responsive"><table id="marks-entry-table"><thead><tr><th>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ</th>${subjects.map(s => `<th>${s.name}</th>`).join('')}</tr></thead><tbody>
                        ${students.map(std => `<tr data-student-id="${std.id}"><td>${std.name}</td>
                            ${subjects.map(sub => {
                            const mark = marks.find(m => m.studentId === std.id && m.subjectId === sub.id);
                            return `<td><input type="number" class="form-control marks-input" data-subject-id="${sub.id}" value="${mark?.obtainedMarks || ''}" placeholder="/100" max="100" min="0"></td>`;
                        }).join('')}</tr>`).join('')}
                    </tbody></table></div><button class="btn btn-primary" style="margin-top:20px" id="save-marks-btn">ŸÜŸÖÿ®ÿ± ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        document.getElementById('marks-entry-sheet').innerHTML = sheet;
                        document.getElementById('save-marks-btn').onclick = () => this.saveMarks();
                        App.hideLoader();
                    },
                    async saveMarks() {
                        App.showLoader();
                        const examId = parseInt(document.getElementById('marks-exam-selector').value);
                        const classId = parseInt(document.getElementById('marks-class-selector').value);
                        const rows = document.querySelectorAll('#marks-entry-table tbody tr');
                        let marksToSave = [];
                        rows.forEach(row => {
                            const studentId = parseInt(row.dataset.studentId);
                            const inputs = row.querySelectorAll('.marks-input');
                            inputs.forEach(input => {
                                if (input.value) {
                                    marksToSave.push({ examId, classId, studentId, subjectId: parseInt(input.dataset.subjectId), totalMarks: 100, obtainedMarks: parseInt(input.value) });
                                }
                            });
                        });
                        const tx = App.db.transaction('marks', 'readwrite');
                        const store = tx.objectStore('marks');
                        for (const mark of marksToSave) {
                            store.put(mark);
                        }
                        tx.oncomplete = () => { App.hideLoader(); App.showToast('ŸÜŸÖÿ®ÿ± ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Øÿ¶€í!', 'success'); };
                        tx.onerror = (e) => { App.hideLoader(); App.showToast('ŸÜŸÖÿ®ÿ± ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error'); console.error(e.target.error); };
                    },
                    async renderResultCardList() {
                        App.showLoader();
                        const examId = parseInt(document.getElementById('card-exam-selector').value);
                        const classId = parseInt(document.getElementById('card-class-selector').value);
                        const students = await App.dbAction('students', 'getAll', IDBKeyRange.only(classId), 'classId');
                        const list = `<div class="table-responsive"><table id="result-card-list-table"><thead><tr><th>ÿ±ŸàŸÑ ŸÜŸÖÿ®ÿ±</th><th>ŸÜÿßŸÖ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€å</th></tr></thead><tbody>
                    ${students.map(s => `<tr><td>${s.rollNo}</td><td>${s.name}</td><td><button class="btn btn-secondary" data-action="view-card" data-module="exams" data-student-id="${s.id}" data-id="${examId}">⁄©ÿßÿ±⁄à ÿØ€å⁄©⁄æ€å⁄∫</button></td></tr>`).join('')}
                    </tbody></table></div>`;
                        document.getElementById('card-list-container').innerHTML = list;
                        App.hideLoader();
                    },
                    async renderResultCard(studentId, examId) {
                        studentId = parseInt(studentId); examId = parseInt(examId);
                        const [student, exam, marks, subjects] = await Promise.all([
                            App.dbAction('students', 'get', studentId), App.dbAction('exams', 'get', examId),
                            App.dbAction('marks', 'getAll', IDBKeyRange.only(examId), 'examId'), App.dbAction('subjects', 'getAll')
                        ]);
                        const studentClass = await App.dbAction('classes', 'get', student.classId);
                        const studentMarks = marks.filter(m => m.studentId === studentId);
                        const subjectMap = new Map(subjects.map(s => [s.id, s.name]));
                        let totalObtained = 0, totalMarks = 0;
                        const marksRows = studentMarks.map(m => { totalObtained += m.obtainedMarks; totalMarks += m.totalMarks || 100; return `<tr><td>${subjectMap.get(m.subjectId)}</td><td>${m.totalMarks || 100}</td><td>${m.obtainedMarks}</td></tr>`; }).join('');
                        const percentage = totalMarks > 0 ? ((totalObtained / totalMarks) * 100).toFixed(2) : 0;
                        const grade = percentage >= 80 ? 'ŸÖŸÖÿ™ÿßÿ≤' : percentage >= 70 ? 'ÿ¨€åÿØ ÿ¨ÿØÿßŸã' : percentage >= 60 ? 'ÿ¨€åÿØ' : percentage >= 50 ? 'ŸÖŸÇÿ®ŸàŸÑ' : 'ÿ±ÿßÿ≥ÿ®';
                        const cardHtml = `<div id="printable-result-card" style="padding:20px; border: 1px solid #ccc; background: white; color: black; direction:rtl;"><h2 style="text-align:center;">${App.settings.schoolName}</h2><h3 style="text-align:center;">ŸÜÿ™€åÿ¨€Å ⁄©ÿßÿ±⁄à - ${exam.name}</h3><p><strong>ŸÜÿßŸÖ:</strong> ${student.name}</p><p><strong>⁄©ŸÑÿßÿ≥:</strong> ${studentClass.name}</p><table style="width:100%; border-collapse:collapse; margin-top:20px;" border="1"><thead><tr style="background:#eee;"><th>ŸÖÿ∂ŸÖŸàŸÜ</th><th>⁄©ŸÑ ŸÜŸÖÿ®ÿ±</th><th>ÿ≠ÿßÿµŸÑ ⁄©ÿ±ÿØ€Å ŸÜŸÖÿ®ÿ±</th></tr></thead><tbody>${marksRows}</tbody><tfoot><tr style="font-weight:bold; background:#eee;"><td>⁄©ŸÑ</td><td>${totalMarks}</td><td>${totalObtained}</td></tr></tfoot></table><p style="margin-top:20px;"><strong>ŸÅ€åÿµÿØ:</strong> ${percentage}%</p><p><strong>⁄Øÿ±€å⁄à:</strong> ${grade}</p></div>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.printContent(document.getElementById('printable-result-card').innerHTML, 'Result Card')">Ÿæÿ±ŸÜŸπ</button>`;
                        App.showModal('ÿ±ÿ≤ŸÑŸπ ⁄©ÿßÿ±⁄à', cardHtml, footer);
                    },
                    async showExamForm(id = null) { },
                },
                Library: {
                    render() {
                        return `<div class="card"><div class="card-header" style="padding: 0; border: none;"><div id="library-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); width: 100%;"><button class="tab-btn active" data-tab="books">⁄©ÿ™ÿ® ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßŸÖ</button><button class="tab-btn" data-tab="issue-return">ÿßÿ¨ÿ±ÿßÿ°/ŸàÿßŸæÿ≥€å</button><button class="tab-btn" data-tab="categories">ÿ≤ŸÖÿ±€í</button></div></div><div id="library-content" style="padding-top:20px;"></div></div>`;
                    },
                    async postRender() {
                        this.renderTabs();
                        const bookSearchInput = document.getElementById('book-search');
                        if (bookSearchInput && !bookSearchInput.dataset.listenerAttached) {
                            bookSearchInput.addEventListener('input', () => this.renderBooksTable());
                            bookSearchInput.dataset.listenerAttached = 'true';
                        }
                    },
                    renderTabs() {
                        document.querySelectorAll('#library-tabs .tab-btn').forEach(btn => {
                            btn.onclick = (e) => {
                                document.querySelectorAll('#library-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                                this.renderTabContent(e.target.dataset.tab);
                            };
                        });
                        this.renderTabContent('books');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('library-content');
                        App.showLoader();
                        if (tab === 'books') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>⁄©ÿ™ÿ® ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™</h4><button class="btn btn-primary" id="add-book-btn">ŸÜÿ¶€å ⁄©ÿ™ÿßÿ® ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div><input type="text" id="book-search" class="form-control" placeholder="ÿπŸÜŸàÿßŸÜ €åÿß ŸÖÿµŸÜŸÅ ÿ≥€í ÿ™ŸÑÿßÿ¥ ⁄©ÿ±€å⁄∫..."><div class="table-responsive" style="margin-top: 20px;"><table id="books-table"><thead><tr><th>ÿπŸÜŸàÿßŸÜ</th><th>ŸÖÿµŸÜŸÅ</th><th>ÿ≤ŸÖÿ±€Å</th><th>⁄©ŸÑ ÿ™ÿπÿØÿßÿØ</th><th>ÿØÿ≥ÿ™€åÿßÿ®</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderBooksTable();
                            const addBookBtn = document.getElementById('add-book-btn');
                            if (addBookBtn) addBookBtn.onclick = () => this.showBookForm();
                            const bookSearchInput = document.getElementById('book-search');
                            if (bookSearchInput && !bookSearchInput.dataset.listenerAttached) {
                                bookSearchInput.addEventListener('input', () => this.renderBooksTable());
                                bookSearchInput.dataset.listenerAttached = 'true';
                            }
                        } else if (tab === 'issue-return') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>ÿ¨ÿßÿ±€å ÿ¥ÿØ€Å ⁄©ÿ™ÿ®</h4></div><div class="table-responsive"><table id="issued-books-table"><thead><tr><th>⁄©ÿ™ÿßÿ® ⁄©ÿß ÿπŸÜŸàÿßŸÜ</th><th>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ</th><th>ÿßÿ¨ÿ±ÿßÿ° ⁄©€å ÿ™ÿßÿ±€åÿÆ</th><th>ŸàÿßŸæÿ≥€å ⁄©€å ÿ™ÿßÿ±€åÿÆ</th><th>ÿ≠€åÿ´€åÿ™</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderIssuedBooksTable();
                        } else if (tab === 'categories') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>⁄©ÿ™ÿ® ⁄©€í ÿ≤ŸÖÿ±€í</h4><button class="btn btn-primary" id="add-category-btn">ŸÜ€åÿß ÿ≤ŸÖÿ±€Å</button></div><div class="table-responsive"><table id="categories-table"><thead><tr><th>ÿ≤ŸÖÿ±€Å ⁄©ÿß ŸÜÿßŸÖ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€å</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderCategoriesTable();
                            const addCatBtn = document.getElementById('add-category-btn');
                            if (addCatBtn) addCatBtn.onclick = () => this.showCategoryForm();
                        }
                        App.hideLoader();
                    },
                    async renderBooksTable() {
                        const searchTerm = document.getElementById('book-search')?.value.toLowerCase() || '';
                        const [books, categories] = await Promise.all([App.dbAction('books', 'getAll'), App.dbAction('bookCategories', 'getAll')]);
                        const categoryMap = new Map(categories.map(c => [c.id, c.name]));
                        let filteredBooks = books;
                        if (searchTerm) {
                            filteredBooks = books.filter(b => (b.title && b.title.toLowerCase().includes(searchTerm)) || (b.author && b.author.toLowerCase().includes(searchTerm)));
                        }
                        const booksTableBody = document.querySelector('#books-table tbody');
                        if (booksTableBody) {
                            booksTableBody.innerHTML = filteredBooks.map(book => `<tr><td>${book.title}</td><td>${book.author}</td><td>${categoryMap.get(book.categoryId) || 'N/A'}</td><td>${book.quantity}</td><td>${book.availableQuantity}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="issue" data-module="library" data-id="${book.id}" title="⁄©ÿ™ÿßÿ® ÿ¨ÿßÿ±€å ⁄©ÿ±€å⁄∫" ${book.availableQuantity < 1 ? 'disabled' : ''}>‚Üë</button><button class="btn btn-secondary btn-icon" data-action="edit" data-module="library" data-id="${book.id}" title="ÿ™ÿ±ŸÖ€åŸÖ">‚úèÔ∏è</button>
<button class="btn btn-danger btn-icon" data-action="delete" data-module="library" data-id="${book.id}" title="ÿ≠ÿ∞ŸÅ">üóëÔ∏è</button></td></tr>`).join('');
                        }
                    },
                    async renderIssuedBooksTable() {
                        const [logs, books, students] = await Promise.all([App.dbAction('libraryLog', 'getAll'), App.dbAction('books', 'getAll'), App.dbAction('students', 'getAll')]);
                        const bookMap = new Map(books.map(b => [b.id, b.title]));
                        const studentMap = new Map(students.map(s => [s.id, s.name]));
                        const issuedBooksTableBody = document.querySelector('#issued-books-table tbody');
                        if (issuedBooksTableBody) {
                            issuedBooksTableBody.innerHTML = logs.map(log => {
                                const issueDate = App.formatDate(log.issueDate, '---', `Library Log ID ${log.id} - Issue`);
                                const returnDate = App.formatDate(log.returnDate, '<span style="color: var(--warning);">ŸàÿßŸæÿ≥ ŸÜ€Å€å⁄∫ €ÅŸàÿ¶€å</span>', `Library Log ID ${log.id} - Return`);
                                const statusText = log.status === 'issued' ? 'ÿ¨ÿßÿ±€å ÿ¥ÿØ€Å' : 'ŸàÿßŸæÿ≥ ÿ¥ÿØ€Å';
                                const actionBtn = log.status === 'issued' ? `<button class="btn btn-success" data-action="return" data-module="library" data-id="${log.id}">ŸàÿßŸæÿ≥ ŸÑ€å⁄∫</button>` : '';
                                return `<tr>
                        <td>${bookMap.get(log.bookId) || 'N/A'}</td>
                        <td>${studentMap.get(log.studentId) || 'N/A'}</td>
                        <td>${issueDate}</td>
                        <td>${returnDate}</td>
                        <td>${statusText}</td>
                        <td class="action-btns">${actionBtn}</td>
                    </tr>`;
                            }).join('');
                        }
                    },
                    async renderCategoriesTable() {
                        const categories = await App.dbAction('bookCategories', 'getAll');
                        const categoriesTableBody = document.querySelector('#categories-table tbody');
                        if (categoriesTableBody) {
                            categoriesTableBody.innerHTML = categories.map(cat => `<tr><td>${cat.name}</td><td><button class="btn btn-danger btn-icon" onclick="App.Library.deleteCategory(${cat.id})">üóëÔ∏è</button></td></tr>`).join('');
                        }
                    },
                    async showBookForm(id = null) {
                        let book = {};
                        const categories = await App.dbAction('bookCategories', 'getAll');
                        if (id) {
                            const bookId = parseInt(id);
                            if (!isNaN(bookId)) {
                                book = await App.dbAction('books', 'get', bookId) || {};
                            } else {
                                console.error("Invalid ID passed to showBookForm:", id);
                                App.showToast("ÿ∫ŸÑÿ∑ ⁄©ÿ™ÿßÿ® ID€î ÿ™ÿ±ŸÖ€åŸÖ ⁄©€í ŸÑ€å€í ŸÑŸà⁄à ŸÜ€Å€å⁄∫ ⁄©€åÿß ÿ¨ÿß ÿ≥⁄©ÿß€î", "error");
                                return;
                            }
                        }
                        const catOptions = categories.map(c => `<option value="${c.id}" ${book.categoryId == c.id ? 'selected' : ''}>${c.name}</option>`).join('');
                        const title = book.id ? '⁄©ÿ™ÿßÿ® ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫' : 'ŸÜÿ¶€å ⁄©ÿ™ÿßÿ® ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫';
                        const formHtml = `<form id="book-form"><input type="hidden" name="id" value="${book.id || ''}"><div class="form-group"><label>ÿπŸÜŸàÿßŸÜ</label><input type="text" name="title" class="form-control" value="${book.title || ''}" required></div><div class="form-group"><label>ŸÖÿµŸÜŸÅ</label><input type="text" name="author" class="form-control" value="${book.author || ''}" required></div><div class="form-group"><label>ÿ≤ŸÖÿ±€Å</label><select name="categoryId" class="form-control" required>${catOptions}</select></div><div class="form-group"><label>ISBN</label><input type="text" name="isbn" class="form-control" value="${book.isbn || ''}"></div><div class="form-group"><label>ÿ™ÿπÿØÿßÿØ</label><input type="number" name="quantity" class="form-control" value="${book.quantity || 1}" min="0" required></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-book-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        document.getElementById('save-book-btn').onclick = () => this.saveBook();
                    },
                    async saveBook() {
                        const form = document.getElementById('book-form');
                        if (!form.checkValidity()) { form.reportValidity(); return; }
                        const formData = new FormData(form);
                        const bookData = Object.fromEntries(formData.entries());
                        const formIdString = bookData.id;
                        if (formIdString && formIdString !== "") {
                            bookData.id = parseInt(formIdString);
                            if (isNaN(bookData.id)) {
                                console.error("Book ID from form ('" + formIdString + "') is invalid after parsing.");
                                App.showToast('⁄©ÿ™ÿßÿ® ID ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å: ID ÿ∫€åÿ± ÿπÿØÿØ€å €Å€í€î', 'error');
                                return;
                            }
                        } else {
                            delete bookData.id;
                        }
                        if (bookData.categoryId) {
                            bookData.categoryId = parseInt(bookData.categoryId);
                            if (isNaN(bookData.categoryId)) {
                                App.showToast('ÿ≤ŸÖÿ±€Å ID ŸÖ€å⁄∫ ÿÆÿ±ÿßÿ®€å€î', 'error');
                                return;
                            }
                        } else {
                            App.showToast('ÿ≤ŸÖÿ±€Å ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±ŸÜÿß ÿ∂ÿ±Ÿàÿ±€å €Å€í€î', 'error');
                            return;
                        }
                        bookData.quantity = parseInt(bookData.quantity);
                        if (isNaN(bookData.quantity) || bookData.quantity < 0) {
                            App.showToast('ÿ™ÿπÿØÿßÿØ ÿØÿ±ÿ≥ÿ™ €ÅŸàŸÜ€å ⁄Üÿß€Å€å€í€î', 'error');
                            return;
                        }
                        if (!bookData.id) {
                            bookData.availableQuantity = bookData.quantity;
                        } else {
                            const oldBook = await App.dbAction('books', 'get', bookData.id);
                            if (oldBook) {
                                const issuedCount = oldBook.quantity - oldBook.availableQuantity;
                                bookData.availableQuantity = bookData.quantity - issuedCount;
                                if (bookData.availableQuantity < 0) bookData.availableQuantity = 0;
                            } else {
                                bookData.availableQuantity = bookData.quantity;
                            }
                        }
                        try {
                            await App.dbAction('books', 'put', bookData);
                            App.showToast('⁄©ÿ™ÿßÿ® ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Øÿ¶€å!', 'success');
                            App.closeModal();
                            this.renderTabContent('books');
                        } catch (err) {
                            console.error('Error saving book:', err);
                            App.showToast(`⁄©ÿ™ÿßÿ® ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å! (${err.message || err.name})`, 'error');
                        }
                    },
                    async showCategoryForm() {
                        const formHtml = `<form id="category-form"><div class="form-group"><label>ÿ≤ŸÖÿ±€Å ⁄©ÿß ŸÜÿßŸÖ</label><input type="text" name="name" class="form-control" required></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-cat-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('ŸÜ€åÿß ÿ≤ŸÖÿ±€Å', formHtml, footer);
                        document.getElementById('save-cat-btn').onclick = () => this.saveCategory();
                    },
                    async saveCategory() {
                        const form = document.getElementById('category-form'); if (!form.checkValidity()) { form.reportValidity(); return; }
                        const name = form.elements.name.value;
                        await App.dbAction('bookCategories', 'add', { name });
                        App.showToast('ÿ≤ŸÖÿ±€Å ÿ¥ÿßŸÖŸÑ €ÅŸà⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderCategoriesTable();
                    },
                    async deleteCategory(id) {
                        const books = await App.dbAction('books', 'getAll');
                        const isCategoryUsed = books.some(book => book.categoryId === parseInt(id));
                        if (isCategoryUsed) {
                            App.showToast('€å€Å ÿ≤ŸÖÿ±€Å ⁄©ÿ™ÿ® ŸÖ€å⁄∫ ÿßÿ≥ÿ™ÿπŸÖÿßŸÑ €ÅŸà ÿ±€Åÿß €Å€íÿå ÿßÿ≥€í ÿ≠ÿ∞ŸÅ ŸÜ€Å€å⁄∫ ⁄©€åÿß ÿ¨ÿß ÿ≥⁄©ÿ™ÿß€î', 'error');
                            return;
                        }
                        await App.dbAction('bookCategories', 'delete', parseInt(id));
                        App.showToast('ÿ≤ŸÖÿ±€Å ÿ≠ÿ∞ŸÅ €ÅŸà⁄Ø€åÿß!', 'success'); this.renderCategoriesTable();
                    },
                    async showIssueForm(bookId) {
                        const book = await App.dbAction('books', 'get', parseInt(bookId));
                        if (!book || book.availableQuantity < 1) {
                            App.showToast('€å€Å ⁄©ÿ™ÿßÿ® ÿßÿ¨ÿ±ÿßÿ° ⁄©€í ŸÑ€å€í ÿØÿ≥ÿ™€åÿßÿ® ŸÜ€Å€å⁄∫ €Å€í€î', 'error');
                            return;
                        }
                        const studentOptions = await App.getSelectOptions('students', 'id', 'name');
                        const defaultDueDate = new Date();
                        defaultDueDate.setDate(defaultDueDate.getDate() + 15);
                        const formHtml = `<form id="issue-book-form"><div class="form-group"><label>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫</label><select name="studentId" class="form-control" required>${studentOptions}</select></div><div class="form-group"><label>ŸàÿßŸæÿ≥€å ⁄©€å ŸÖÿ™ŸàŸÇÿπ ÿ™ÿßÿ±€åÿÆ</label><input type="date" name="dueDate" class="form-control" value="${defaultDueDate.toISOString().split('T')[0]}" required></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="issue-book-btn">⁄©ÿ™ÿßÿ® ÿ¨ÿßÿ±€å ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('⁄©ÿ™ÿßÿ® ÿ¨ÿßÿ±€å ⁄©ÿ±€å⁄∫', formHtml, footer);
                        document.getElementById('issue-book-btn').onclick = () => this.issueBook(bookId);
                    },
                    async issueBook(bookId) {
                        const form = document.getElementById('issue-book-form'); if (!form.checkValidity()) { form.reportValidity(); return; }
                        const studentId = parseInt(form.elements.studentId.value);
                        const dueDate = form.elements.dueDate.value;
                        const book = await App.dbAction('books', 'get', parseInt(bookId));
                        if (book.availableQuantity < 1) {
                            App.showToast('⁄©ÿ™ÿßÿ® ÿØÿ≥ÿ™€åÿßÿ® ŸÜ€Å€å⁄∫ €Å€í€î', 'error');
                            App.closeModal();
                            this.renderTabContent('books');
                            return;
                        }
                        book.availableQuantity -= 1;
                        await App.dbAction('books', 'put', book);
                        const logEntry = { bookId: parseInt(bookId), studentId, issueDate: new Date().toISOString().split('T')[0], dueDate, status: 'issued' };
                        await App.dbAction('libraryLog', 'add', logEntry);
                        App.showToast('⁄©ÿ™ÿßÿ® ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ¨ÿßÿ±€å ⁄©ÿ± ÿØ€å ⁄Øÿ¶€å!', 'success'); App.closeModal();
                        this.renderTabContent('books');
                        this.renderTabContent('issue-return');
                    },
                    async returnBook(logId) {
                        const log = await App.dbAction('libraryLog', 'get', parseInt(logId));
                        log.returnDate = new Date().toISOString().split('T')[0]; log.status = 'returned';
                        await App.dbAction('libraryLog', 'put', log);
                        const book = await App.dbAction('books', 'get', log.bookId);
                        book.availableQuantity += 1;
                        if (book.availableQuantity > book.quantity) book.availableQuantity = book.quantity;
                        await App.dbAction('books', 'put', book);
                        App.showToast('⁄©ÿ™ÿßÿ® ŸàÿßŸæÿ≥ €ÅŸà⁄Øÿ¶€å!', 'success');
                        this.renderTabContent('issue-return');
                        this.renderTabContent('books');
                    },
                    async viewStudentLibraryHistory(studentId, containerId) {
                        const [logs, books] = await Promise.all([App.dbAction('libraryLog', 'getAll', parseInt(studentId), 'studentId'), App.dbAction('books', 'getAll')]);
                        const bookMap = new Map(books.map(b => [b.id, b.title]));
                        const historyHtml = `<div class="table-responsive"><table style="width: 100%;"><thead><tr><th>⁄©ÿ™ÿßÿ® ⁄©ÿß ÿπŸÜŸàÿßŸÜ</th><th>ÿßÿ¨ÿ±ÿßÿ° ⁄©€å ÿ™ÿßÿ±€åÿÆ</th><th>ŸàÿßŸæÿ≥€å ⁄©€å ÿ™ÿßÿ±€åÿÆ</th><th>ÿ≠€åÿ´€åÿ™</th></tr></thead><tbody>
                        ${logs.map(log => `<tr><td>${bookMap.get(log.bookId) || 'N/A'}</td><td>${log.issueDate ? new Date(log.issueDate).toLocaleDateString('ur-PK') : 'N/A'}</td><td>${log.returnDate ? new Date(log.returnDate).toLocaleDateString('ur-PK') : 'N/A'}</td><td>${log.status === 'issued' ? 'ÿ¨ÿßÿ±€å ÿ¥ÿØ€Å' : 'ŸàÿßŸæÿ≥ ÿ¥ÿØ€Å'}</td></tr>`).join('')}
                        </tbody></table></div>`;
                        const el = document.getElementById(containerId);
                        if (el) el.innerHTML = historyHtml; else App.showModal('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©€å ŸÑÿßÿ¶ÿ®ÿ±€åÿ±€å ÿ™ÿßÿ±€åÿÆ', historyHtml);
                    },
                    async confirmDeleteBook(id) {
                        const book = await App.dbAction('books', 'get', parseInt(id));
                        if (!book) { App.showToast('⁄©ÿ™ÿßÿ® ŸÜ€Å€å⁄∫ ŸÖŸÑ€å!', 'error'); return; }
                        if (book.quantity !== book.availableQuantity) {
                            App.showToast('€å€Å ⁄©ÿ™ÿßÿ® ⁄©⁄Ü⁄æ ÿ∑ŸÑÿ®ÿßÿ° ⁄©Ÿà ÿ¨ÿßÿ±€å ⁄©€å ⁄Øÿ¶€å €Å€í€î ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜ€í ÿ≥€í Ÿæ€ÅŸÑ€í ÿ™ŸÖÿßŸÖ ŸÜŸÇŸàŸÑ ŸàÿßŸæÿ≥ ŸÑ€å⁄∫€î', 'error');
                            return;
                        }
                        const body = `<p>⁄©€åÿß ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ÿßÿ≥ ⁄©ÿ™ÿßÿ® ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü<br><strong>${book.title}</strong></p>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÜ€Å€å⁄∫</button><button class="btn btn-danger" id="confirm-delete-book-btn">€Åÿß⁄∫ÿå ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('⁄©ÿ™ÿßÿ® ÿ≠ÿ∞ŸÅ ⁄©ÿ±€å⁄∫', body, footer);
                        document.getElementById('confirm-delete-book-btn').onclick = async () => {
                            try {
                                await App.dbAction('books', 'delete', parseInt(id));
                                App.showToast('⁄©ÿ™ÿßÿ® ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ≠ÿ∞ŸÅ ⁄©ÿ± ÿØ€å ⁄Øÿ¶€å!', 'success');
                                App.closeModal();
                                this.renderTabContent('books');
                            } catch (err) {
                                console.error('Error deleting book:', err);
                                App.showToast('⁄©ÿ™ÿßÿ® ⁄©Ÿà ÿ≠ÿ∞ŸÅ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error');
                            }
                        };
                    }
                },
                Transport: {
                    render() { return `<div class="card"><div class="card-header" style="padding: 0; border: none;"><div id="transport-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); width: 100%;"><button class="tab-btn active" data-tab="routes">ÿ±ŸàŸπÿ≥ ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßŸÖ</button><button class="tab-btn" data-tab="assignments">ÿ∑ŸÑÿ®ÿßÿ° ⁄©€å ÿ™ŸÅŸà€åÿ∂</button></div></div><div id="transport-content" style="padding-top:20px;"></div></div>`; },
                    async postRender() {
                        document.querySelectorAll('#transport-tabs .tab-btn').forEach(btn => btn.onclick = (e) => {
                            document.querySelectorAll('#transport-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                            this.renderTabContent(e.target.dataset.tab);
                        });
                        await this.renderTabContent('routes');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('transport-content');
                        App.showLoader();
                        if (tab === 'routes') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>Ÿπÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿπ ÿ±ŸàŸπÿ≥</h4><button class="btn btn-primary" onclick="App.Transport.showRouteForm()">ŸÜ€åÿß ÿ±ŸàŸπ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="routes-table"><thead><tr><th>ÿ±ŸàŸπ ⁄©ÿß ŸÜÿßŸÖ</th><th>⁄Øÿß⁄ë€å ŸÜŸÖÿ®ÿ±</th><th>⁄àÿ±ÿßÿ¶€åŸàÿ±</th><th>ŸÅ€åÿ≥</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderRoutesTable();
                        } else if (tab === 'assignments') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>Ÿπÿ±ÿßŸÜÿ≥ŸæŸàÿ±Ÿπ ⁄©€í ÿ∑ŸÑÿ®ÿßÿ°</h4><button class="btn btn-primary" onclick="App.Transport.showStudentAssignmentForm()">ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="assignments-table"><thead><tr><th>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©ÿß ŸÜÿßŸÖ</th><th>⁄©ŸÑÿßÿ≥</th><th>ÿ±ŸàŸπ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€å</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderAssignmentsTable();
                        }
                        App.hideLoader();
                    },
                    async renderRoutesTable() {
                        const routes = await App.dbAction('transportRoutes', 'getAll');
                        document.querySelector('#routes-table tbody').innerHTML = routes.map(r => `<tr><td>${r.routeName}</td><td>${r.vehicleNumber}</td><td>${r.driverName}</td><td>${r.fee}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="transport" data-id="${r.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="transport" data-id="${r.id}">üóëÔ∏è</button></td></tr>`).join('');
                    },
                    async renderAssignmentsTable() {
                        const [assignments, students, routes, classes] = await Promise.all([App.dbAction('transportAssignments', 'getAll'), App.dbAction('students', 'getAll'), App.dbAction('transportRoutes', 'getAll'), App.dbAction('classes', 'getAll')]);
                        const studentMap = new Map(students.map(s => [s.id, s]));
                        const routeMap = new Map(routes.map(r => [r.id, r.routeName]));
                        const classMap = new Map(classes.map(c => [c.id, c.name]));
                        document.querySelector('#assignments-table tbody').innerHTML = assignments.map(a => {
                            const student = studentMap.get(a.studentId);
                            return student ? `<tr><td>${student.name}</td><td>${classMap.get(student.classId)}</td><td>${routeMap.get(a.routeId)}</td><td><button class="btn btn-danger btn-icon" data-action="unassign" data-module="transport" data-id="${a.studentId}">üóëÔ∏è</button></td></tr>` : '';
                        }).join('');
                    },
                    async showRouteForm(id = null) {
                        const route = id ? await App.dbAction('transportRoutes', 'get', parseInt(id)) : {};
                        const title = id ? 'ÿ±ŸàŸπ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫' : 'ŸÜ€åÿß ÿ±ŸàŸπ';
                        const formHtml = `<form id="route-form"><input type="hidden" name="id" value="${route.id || ''}"><div class="form-group"><label>ÿ±ŸàŸπ ⁄©ÿß ŸÜÿßŸÖ</label><input type="text" name="routeName" class="form-control" value="${route.routeName || ''}" required></div><div class="form-group"><label>⁄Øÿß⁄ë€å ŸÜŸÖÿ®ÿ±</label><input type="text" name="vehicleNumber" class="form-control" value="${route.vehicleNumber || ''}"></div><div class="form-group"><label>⁄àÿ±ÿßÿ¶€åŸàÿ± ⁄©ÿß ŸÜÿßŸÖ</label><input type="text" name="driverName" class="form-control" value="${route.driverName || ''}"></div><div class="form-group"><label>ŸÖÿß€ÅÿßŸÜ€Å ŸÅ€åÿ≥</label><input type="number" name="fee" class="form-control" value="${route.fee || ''}" required></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-route-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        document.getElementById('save-route-btn').onclick = () => this.saveRoute();
                    },
                    async saveRoute() {
                        const form = document.getElementById('route-form'); if (!form.checkValidity()) { form.reportValidity(); return; }
                        const data = Object.fromEntries(new FormData(form).entries());
                        data.id = data.id ? parseInt(data.id) : undefined;
                        data.fee = parseFloat(data.fee);
                        await App.dbAction('transportRoutes', 'put', data);
                        App.showToast('ÿ±ŸàŸπ ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderRoutesTable();
                    },
                    async showStudentAssignmentForm() {
                        const [studentOptions, routeOptions] = await Promise.all([App.getSelectOptions('students', 'id', 'name'), App.getSelectOptions('transportRoutes', 'id', 'routeName')]);
                        const formHtml = `<form id="assign-student-form"><div class="form-group"><label>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ</label><select name="studentId" class="form-control">${studentOptions}</select></div><div class="form-group"><label>ÿ±ŸàŸπ</label><select name="routeId" class="form-control">${routeOptions}</select></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-assignment-btn">ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ÿ±ŸàŸπ ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±€å⁄∫', formHtml, footer);
                        document.getElementById('save-assignment-btn').onclick = () => this.saveStudentAssignment();
                    },
                    async saveStudentAssignment() {
                        const form = document.getElementById('assign-student-form');
                        const data = { studentId: parseInt(form.elements.studentId.value), routeId: parseInt(form.elements.routeId.value) };
                        await App.dbAction('transportAssignments', 'put', data);
                        App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ÿ±ŸàŸπ ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±ÿØ€åÿß ⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderAssignmentsTable();
                    },
                    async unassignStudentFromRoute(studentId) {
                        await App.dbAction('transportAssignments', 'delete', parseInt(studentId));
                        App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ÿ±ŸàŸπ ÿ≥€í €ÅŸπÿß ÿØ€åÿß ⁄Ø€åÿß!', 'success'); this.renderAssignmentsTable();
                    }
                },
                Hostel: {
                    render() { return `<div class="card"><div class="card-header" style="padding: 0; border: none;"><div id="hostel-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); width: 100%;"><button class="tab-btn active" data-tab="rooms">⁄©ŸÖÿ±Ÿà⁄∫ ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßŸÖ</button><button class="tab-btn" data-tab="assignments">ÿ±€Åÿßÿ¶ÿ¥€å ÿ∑ŸÑÿ®ÿßÿ°</button></div></div><div id="hostel-content" style="padding-top:20px;"></div></div>`; },
                    async postRender() {
                        document.querySelectorAll('#hostel-tabs .tab-btn').forEach(btn => btn.onclick = (e) => {
                            document.querySelectorAll('#hostel-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                            this.renderTabContent(e.target.dataset.tab);
                        });
                        await this.renderTabContent('rooms');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('hostel-content');
                        App.showLoader();
                        if (tab === 'rooms') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>€Åÿßÿ≥ŸπŸÑ ⁄©€í ⁄©ŸÖÿ±€í</h4><button class="btn btn-primary" onclick="App.Hostel.showRoomForm()">ŸÜ€åÿß ⁄©ŸÖÿ±€Å ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="rooms-table"><thead><tr><th>⁄©ŸÖÿ±€Å ŸÜŸÖÿ®ÿ±</th><th>⁄ØŸÜÿ¨ÿßÿ¶ÿ¥</th><th>ŸÖŸÇ€åŸÖ ÿ∑ŸÑÿ®ÿßÿ°</th><th>ŸÅ€åÿ≥</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderRoomsTable();
                        } else if (tab === 'assignments') {
                            contentEl.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>€Åÿßÿ≥ŸπŸÑ ⁄©€í ÿ∑ŸÑÿ®ÿßÿ°</h4><button class="btn btn-primary" onclick="App.Hostel.showStudentAssignmentForm()">ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±€å⁄∫</button></div><div class="table-responsive"><table id="hostel-assignments-table"><thead><tr><th>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©ÿß ŸÜÿßŸÖ</th><th>⁄©ŸÑÿßÿ≥</th><th>⁄©ŸÖÿ±€Å ŸÜŸÖÿ®ÿ±</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€å</th></tr></thead><tbody></tbody></table></div>`;
                            await this.renderAssignmentsTable();
                        }
                        App.hideLoader();
                    },
                    async renderRoomsTable() {
                        const rooms = await App.dbAction('hostelRooms', 'getAll');
                        document.querySelector('#rooms-table tbody').innerHTML = rooms.map(r => `<tr><td>${r.roomNumber}</td><td>${r.capacity}</td><td>${r.currentOccupants}</td><td>${r.fee}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="hostel" data-id="${r.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="hostel" data-id="${r.id}">üóëÔ∏è</button></td></tr>`).join('');
                    },
                    async renderAssignmentsTable() {
                        const [assignments, students, rooms, classes] = await Promise.all([App.dbAction('hostelAssignments', 'getAll'), App.dbAction('students', 'getAll'), App.dbAction('hostelRooms', 'getAll'), App.dbAction('classes', 'getAll')]);
                        const studentMap = new Map(students.map(s => [s.id, s]));
                        const roomMap = new Map(rooms.map(r => [r.id, r.roomNumber]));
                        const classMap = new Map(classes.map(c => [c.id, c.name]));
                        document.querySelector('#hostel-assignments-table tbody').innerHTML = assignments.map(a => {
                            const student = studentMap.get(a.studentId);
                            return student ? `<tr><td>${student.name}</td><td>${classMap.get(student.classId)}</td><td>${roomMap.get(a.roomId)}</td><td><button class="btn btn-danger btn-icon" data-action="unassign" data-module="hostel" data-id="${a.studentId}">üóëÔ∏è</button></td></tr>` : '';
                        }).join('');
                    },
                    async showRoomForm(id = null) {
                        const room = id ? await App.dbAction('hostelRooms', 'get', parseInt(id)) : {};
                        const title = id ? '⁄©ŸÖÿ±€í ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ' : 'ŸÜ€åÿß ⁄©ŸÖÿ±€Å';
                        const formHtml = `<form id="room-form"><input type="hidden" name="id" value="${room.id || ''}"><div class="form-group"><label>⁄©ŸÖÿ±€Å ŸÜŸÖÿ®ÿ±</label><input type="text" name="roomNumber" class="form-control" value="${room.roomNumber || ''}" required></div><div class="form-group"><label>⁄ØŸÜÿ¨ÿßÿ¶ÿ¥</label><input type="number" name="capacity" class="form-control" value="${room.capacity || ''}" required></div><div class="form-group"><label>ŸÖÿß€ÅÿßŸÜ€Å ŸÅ€åÿ≥</label><input type="number" name="fee" class="form-control" value="${room.fee || ''}" required></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-room-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        document.getElementById('save-room-btn').onclick = () => this.saveRoom();
                    },
                    async saveRoom() {
                        const form = document.getElementById('room-form'); if (!form.checkValidity()) { form.reportValidity(); return; }
                        const data = Object.fromEntries(new FormData(form).entries());
                        data.id = data.id ? parseInt(data.id) : undefined;
                        data.capacity = parseInt(data.capacity);
                        data.fee = parseFloat(data.fee);
                        if (!data.id) data.currentOccupants = 0;
                        else { const oldRoom = await App.dbAction('hostelRooms', 'get', data.id); data.currentOccupants = oldRoom.currentOccupants; }
                        await App.dbAction('hostelRooms', 'put', data);
                        App.showToast('⁄©ŸÖÿ±€Å ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderRoomsTable();
                    },
                    async showStudentAssignmentForm() {
                        const [studentOptions, roomOptions] = await Promise.all([App.getSelectOptions('students', 'id', 'name'), App.getSelectOptions('hostelRooms', 'id', 'roomNumber')]);
                        const formHtml = `<form id="assign-student-form"><div class="form-group"><label>ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ</label><select name="studentId" class="form-control">${studentOptions}</select></div><div class="form-group"><label>⁄©ŸÖÿ±€Å</label><select name="roomId" class="form-control">${roomOptions}</select></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-assignment-btn">ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ⁄©ŸÖÿ±€Å ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±€å⁄∫', formHtml, footer);
                        document.getElementById('save-assignment-btn').onclick = () => this.saveStudentAssignment();
                    },
                    async saveStudentAssignment() {
                        const form = document.getElementById('assign-student-form');
                        const studentId = parseInt(form.elements.studentId.value);
                        const roomId = parseInt(form.elements.roomId.value);
                        const room = await App.dbAction('hostelRooms', 'get', roomId);
                        if (room.currentOccupants >= room.capacity) { App.showToast('⁄©ŸÖÿ±€í ŸÖ€å⁄∫ ŸÖÿ≤€åÿØ ⁄ØŸÜÿ¨ÿßÿ¶ÿ¥ ŸÜ€Å€å⁄∫!', 'error'); return; }
                        await App.dbAction('hostelAssignments', 'put', { studentId, roomId });
                        room.currentOccupants++;
                        await App.dbAction('hostelRooms', 'put', room);
                        App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ⁄©ŸÖÿ±€Å ÿ™ŸÅŸà€åÿ∂ ⁄©ÿ±ÿØ€åÿß ⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderAssignmentsTable(); this.renderRoomsTable();
                    },
                    async unassignStudentFromRoom(studentId) {
                        const assignment = await App.dbAction('hostelAssignments', 'get', parseInt(studentId));
                        if (assignment) {
                            const room = await App.dbAction('hostelRooms', 'get', assignment.roomId);
                            room.currentOccupants--;
                            await App.dbAction('hostelRooms', 'put', room);
                            await App.dbAction('hostelAssignments', 'delete', parseInt(studentId));
                            App.showToast('ÿ∑ÿßŸÑÿ® ÿπŸÑŸÖ ⁄©Ÿà ⁄©ŸÖÿ±€í ÿ≥€í €ÅŸπÿß ÿØ€åÿß ⁄Ø€åÿß!', 'success'); this.renderAssignmentsTable(); this.renderRoomsTable();
                        }
                    }
                },
                Syllabus: {
                    async render() {
                        return `<div class="card"><div class="card-header"><h4>ŸÜÿµÿßÿ® ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßŸÖ</h4></div><div id="syllabus-list"></div></div>`;
                    },
                    async postRender() {
                        await this.renderSyllabusList();
                    },
                    async renderSyllabusList() {
                        const [syllabi, classes, subjects] = await Promise.all([App.dbAction('syllabus', 'getAll'), App.dbAction('classes', 'getAll'), App.dbAction('subjects', 'getAll')]);
                        const classMap = new Map(classes.map(c => [c.id, c.name]));
                        const subjectMap = new Map(subjects.map(s => [s.id, s.name]));
                        const listEl = document.getElementById('syllabus-list');
                        listEl.innerHTML = `
                        <div class="search-filter-box">
                            <select id="syllabus-class-selector" class="form-control">${classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select>
                            <select id="syllabus-subject-selector" class="form-control">${subjects.map(s => `<option value="${s.id}">${s.name}</option>`).join('')}</select>
                            <button class="btn btn-primary" id="add-syllabus-btn">ŸÜÿµÿßÿ® ÿ¥ÿßŸÖŸÑ/ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫</button>
                        </div>
                        <div class="table-responsive" style="margin-top:20px;"><table id="syllabus-table"><thead><tr><th>⁄©ŸÑÿßÿ≥</th><th>ŸÖÿ∂ŸÖŸàŸÜ</th><th>ÿπŸÜŸàÿßŸÜ</th><th>ÿ™ŸÅÿµ€åŸÑ</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€å</th></tr></thead><tbody>
                        ${syllabi.map(s => `<tr><td>${classMap.get(s.classId)}</td><td>${subjectMap.get(s.subjectId)}</td><td>${s.title}</td><td>${s.details}</td><td class="action-btns"><button class="btn btn-danger btn-icon" data-action="delete" data-module="syllabus" data-id="${s.id}">üóëÔ∏è</button></td></tr>`).join('')}
                        </tbody></table></div>`;
                        document.getElementById('add-syllabus-btn').onclick = () => this.loadSyllabusForm();
                    },
                    async loadSyllabusForm() {
                        const classId = parseInt(document.getElementById('syllabus-class-selector').value);
                        const subjectId = parseInt(document.getElementById('syllabus-subject-selector').value);
                        const syllabusData = await App.dbAction('syllabus', 'get', ['class_subject', [classId, subjectId]]);
                        const title = 'ŸÜÿµÿßÿ® ÿ¥ÿßŸÖŸÑ/ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫';
                        const formHtml = `
                        <form id="syllabus-form"><input type="hidden" name="id" value="${syllabusData?.id || ''}"><input type="hidden" name="classId" value="${classId}"><input type="hidden" name="subjectId" value="${subjectId}"><div class="form-group"><label>ÿπŸÜŸàÿßŸÜ</label><input type="text" name="title" class="form-control" value="${syllabusData?.title || ''}" required></div><div class="form-group"><label>ÿ™ŸÅÿµ€åŸÑÿßÿ™</label><textarea name="details" class="form-control" rows="10">${syllabusData?.details || ''}</textarea></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-syllabus-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        document.getElementById('save-syllabus-btn').onclick = () => this.saveSyllabus();
                    },
                    async saveSyllabus() {
                        const form = document.getElementById('syllabus-form');
                        const data = Object.fromEntries(new FormData(form).entries());
                        data.id = data.id ? parseInt(data.id) : undefined;
                        data.classId = parseInt(data.classId); data.subjectId = parseInt(data.subjectId);
                        await App.dbAction('syllabus', 'put', data);
                        App.showToast('ŸÜÿµÿßÿ® ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà ⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderSyllabusList();
                    },
                    async confirmDeleteSyllabus(id) {
                        await App.dbAction('syllabus', 'delete', parseInt(id));
                        App.showToast('ŸÜÿµÿßÿ® ÿ≠ÿ∞ŸÅ ⁄©ÿ± ÿØ€åÿß ⁄Ø€åÿß!', 'success'); this.renderSyllabusList();
                    }
                },
                Noticeboard: {
                    async render() {
                        const canAdd = ['admin', 'teacher'].includes(App.currentUser.role);
                        return `<div class="card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h4>ŸÜŸàŸπÿ≥ ÿ®Ÿàÿ±⁄à</h4>${canAdd ? `<button class="btn btn-primary" onclick="App.Noticeboard.showForm()">ŸÜ€åÿß ŸÜŸàŸπÿ≥ ÿ®ŸÜÿßÿ¶€å⁄∫</button>` : ''}</div><div id="notice-list"></div></div>`;
                    },
                    async postRender() { await this.renderList(); },
                    async renderList() {
                        const notices = await App.dbAction('notices', 'getAll');
                        document.getElementById('notice-list').innerHTML = notices.sort((a, b) => new Date(b.issueDate) - new Date(a.issueDate)).map(n => `<div class="card" style="background: var(--bg-surface-2);"><div class="card-header"><h5>${n.title}</h5><div><small>ÿ¨ÿßÿ±€å ÿ¥ÿØ€Å: ${new Date(n.issueDate).toLocaleDateString('ur-PK')}</small></div></div><p style="white-space: pre-wrap;">${n.content}</p></div>`).join('');
                    },
                    async showForm(id = null) {
                        const notice = id ? await App.dbAction('notices', 'get', parseInt(id)) : {};
                        const title = id ? 'ŸÜŸàŸπÿ≥ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫' : 'ŸÜ€åÿß ŸÜŸàŸπÿ≥';
                        const formHtml = `<form id="notice-form"><input type="hidden" name="id" value="${notice.id || ''}"><div class="form-group"><label>ÿπŸÜŸàÿßŸÜ</label><input type="text" name="title" class="form-control" value="${notice.title || ''}" required></div><div class="form-group"><label>ŸÖŸàÿßÿØ</label><textarea name="content" class="form-control" rows="6" required>${notice.content || ''}</textarea></div><div class="form-group"><label>⁄©ÿ≥ ⁄©€í ŸÑ€å€í</label><select name="targetAudience" class="form-control"><option value="all" ${notice.targetAudience === 'all' ? 'selected' : ''}>ÿ≥ÿ® ⁄©€í ŸÑ€å€í</option><option value="students" ${notice.targetAudience === 'students' ? 'selected' : ''}>ÿ∑ŸÑÿ®ÿßÿ°</option><option value="staff" ${notice.targetAudience === 'staff' ? 'selected' : ''}>ÿßÿ≥ŸπÿßŸÅ</option></select></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-notice-btn">ÿ¥ÿßÿ¶ÿπ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        document.getElementById('save-notice-btn').onclick = () => this.saveForm();
                    },
                    async saveForm() {
                        const form = document.getElementById('notice-form'); if (!form.checkValidity()) { form.reportValidity(); return; }
                        const data = Object.fromEntries(new FormData(form).entries());
                        data.id = data.id ? parseInt(data.id) : undefined;
                        data.issueDate = new Date().toISOString().split('T')[0];
                        await App.dbAction('notices', 'put', data);
                        App.showToast('ŸÜŸàŸπÿ≥ ÿ¥ÿßÿ¶ÿπ €ÅŸà ⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderList();
                    },
                    async confirmDelete(id) { }
                },
                Users: {
                    render() {
                        if (App.currentUser.role !== 'admin') return '<p>ÿ¢Ÿæ ⁄©€í Ÿæÿßÿ≥ €å€Å ÿµŸÅÿ≠€Å ÿØ€å⁄©⁄æŸÜ€í ⁄©€å ÿßÿ¨ÿßÿ≤ÿ™ ŸÜ€Å€å⁄∫ €Å€í€î</p>';
                        return `
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ÿµÿßÿ±ŸÅ€åŸÜ ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßŸÖ</h3><button class="btn btn-primary" id="add-user-btn">ŸÜ€åÿß ÿµÿßÿ±ŸÅ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫</button></div>
                            <div class="table-responsive"><table id="users-table"><thead><tr><th>ŸæŸàÿ±ÿß ŸÜÿßŸÖ</th><th>ÿµÿßÿ±ŸÅ ŸÜÿßŸÖ</th><th>⁄©ÿ±ÿØÿßÿ±</th><th>⁄©ÿßÿ±ÿ±Ÿàÿßÿ¶€åÿß⁄∫</th></tr></thead><tbody></tbody></table></div>
                        </div>`;
                    },
                    async postRender() {
                        if (App.currentUser.role === 'admin') {
                            document.getElementById('add-user-btn').onclick = () => this.showForm();
                            await this.renderTable();
                        }
                    },
                    async renderTable() {
                        const users = await App.dbAction('users', 'getAll');
                        document.querySelector('#users-table tbody').innerHTML = users.map(user => `<tr><td>${user.name || 'N/A'}</td><td>${user.username}</td><td>${user.role}</td><td class="action-btns"><button class="btn btn-primary btn-icon" data-action="edit" data-module="users" data-id="${user.id}">‚úèÔ∏è</button><button class="btn btn-danger btn-icon" data-action="delete" data-module="users" data-id="${user.id}" ${user.id === App.currentUser.id ? 'disabled' : ''}>üóëÔ∏è</button></td></tr>`).join('');
                    },
                    async showForm(id = null) {
                        const user = id ? await App.dbAction('users', 'get', parseInt(id)) : {};
                        const title = id ? 'ÿµÿßÿ±ŸÅ ŸÖ€å⁄∫ ÿ™ÿ±ŸÖ€åŸÖ ⁄©ÿ±€å⁄∫' : 'ŸÜ€åÿß ÿµÿßÿ±ŸÅ ÿ¥ÿßŸÖŸÑ ⁄©ÿ±€å⁄∫';
                        const formHtml = `<form id="user-form"><input type="hidden" name="id" value="${user.id || ''}"><div class="form-group"><label>ŸæŸàÿ±ÿß ŸÜÿßŸÖ</label><input type="text" name="name" class="form-control" value="${user.name || ''}" required></div><div class="form-group"><label>ÿµÿßÿ±ŸÅ ŸÜÿßŸÖ</label><input type="text" name="username" class="form-control" value="${user.username || ''}" required></div><div class="form-group"><label>Ÿæÿßÿ≥ Ÿàÿ±⁄à</label><input type="password" name="password" class="form-control" placeholder="${id ? 'ÿ™ÿ®ÿØ€åŸÑ ⁄©ÿ±ŸÜ€í ⁄©€í ŸÑ€å€í ŸÜ€åÿß Ÿæÿßÿ≥ Ÿàÿ±⁄à ÿØÿ±ÿ¨ ⁄©ÿ±€å⁄∫' : ''}" ${!id ? 'required' : ''}></div><div class="form-group"><label>⁄©ÿ±ÿØÿßÿ±</label><select name="role" class="form-control" required><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>ÿß€å⁄àŸÖŸÜ</option><option value="teacher" ${user.role === 'teacher' ? 'selected' : ''}>ÿßÿ≥ÿ™ÿßÿØ</option><option value="staff" ${user.role === 'staff' ? 'selected' : ''}>ÿßÿ≥ŸπÿßŸÅ</option></select></div></form>`;
                        const footer = `<button class="btn btn-secondary" onclick="App.closeModal()">ŸÖŸÜÿ≥ŸàÿÆ</button><button class="btn btn-primary" id="save-user-btn">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button>`;
                        App.showModal(title, formHtml, footer);
                        document.getElementById('save-user-btn').onclick = () => this.saveForm();
                    },
                    async saveForm() {
                        const form = document.getElementById('user-form'); if (!form.checkValidity()) { form.reportValidity(); return; }
                        const data = Object.fromEntries(new FormData(form).entries());
                        data.id = data.id ? parseInt(data.id) : undefined;
                        if (!data.password && data.id) { const oldUser = await App.dbAction('users', 'get', data.id); data.password = oldUser.password; }
                        try {
                            await App.dbAction('users', 'put', data);
                            App.showToast('ÿµÿßÿ±ŸÅ ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Ø€åÿß!', 'success'); App.closeModal(); this.renderTable();
                        } catch (err) {
                            if (err.name === 'ConstraintError') App.showToast('€å€Å ÿµÿßÿ±ŸÅ ŸÜÿßŸÖ Ÿæ€ÅŸÑ€í ÿ≥€í ŸÖŸàÿ¨ŸàÿØ €Å€í€î', 'error');
                            else App.showToast('ÿµÿßÿ±ŸÅ ⁄©Ÿà ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error');
                        }
                    },
                    async confirmDelete(id) { }
                },
                Reports: {
                    render() {
                        return `
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">ÿ±ŸæŸàÿ±Ÿπÿ≥</h3></div>
                            <div class="form-group"><label for="report-type">ÿ±ŸæŸàÿ±Ÿπ ⁄©€å ŸÇÿ≥ŸÖ ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫</label>
                                <select id="report-type" class="form-control"><option value="student_list">ÿ∑ŸÑÿ®ÿßÿ° ⁄©€å ŸÅ€Åÿ±ÿ≥ÿ™</option><option value="fee_defaulters">ŸÅ€åÿ≥ ⁄à€åŸÅÿßŸÑŸπÿ±ÿ≤</option><option value="fee_collection">ŸÅ€åÿ≥ ŸàÿµŸàŸÑ€å ÿ±ŸæŸàÿ±Ÿπ</option><option value="attendance_summary">ÿ≠ÿßÿ∂ÿ±€å ⁄©ÿß ÿÆŸÑÿßÿµ€Å</option><option value="library_usage">ŸÑÿßÿ¶ÿ®ÿ±€åÿ±€å ÿßÿ≥ÿ™ÿπŸÖÿßŸÑ ÿ±ŸæŸàÿ±Ÿπ</option><option value="salary_report">ÿ™ŸÜÿÆŸàÿß€ÅŸà⁄∫ ⁄©€å ÿ±ŸæŸàÿ±Ÿπ</option><option value="accounts_statement">ÿ¢ŸÖÿØŸÜ€å Ÿà ÿßÿÆÿ±ÿßÿ¨ÿßÿ™ ⁄©ÿß ⁄ØŸàÿ¥Ÿàÿßÿ±€Å</option></select>
                            </div><div class="search-filter-box" id="report-filters"></div><button class="btn btn-primary" id="generate-report-btn">ÿ±ŸæŸàÿ±Ÿπ ÿ®ŸÜÿßÿ¶€å⁄∫</button>
                        </div><div class="card" id="report-output" style="display:none;"><div class="card-header"><h3 class="card-title" id="report-title"></h3><div><button class="btn btn-secondary" id="print-report-btn">Ÿæÿ±ŸÜŸπ</button><button class="btn btn-success" id="export-csv-btn">CSV ÿ®ÿ±ÿ¢ŸÖÿØ ⁄©ÿ±€å⁄∫</button></div></div><div id="report-content" class="table-responsive"></div></div>`;
                    },
                    async postRender() { this.setupEventListeners(); },
                    setupEventListeners() {
                        const reportTypeEl = document.getElementById('report-type');
                        reportTypeEl.onchange = (e) => this.updateFilters(e.target.value);
                        document.getElementById('generate-report-btn').onclick = () => this.generateReport();
                        document.getElementById('print-report-btn').onclick = () => App.printContent(document.getElementById('report-content').innerHTML, document.getElementById('report-title').textContent);
                        document.getElementById('export-csv-btn').onclick = () => this.exportToCSV();
                        this.updateFilters(reportTypeEl.value);
                    },
                    updateFilters(reportType) {
                        const filterContainer = document.getElementById('report-filters');
                        let filtersHtml = '';
                        switch (reportType) {
                            case 'fee_collection': case 'attendance_summary': case 'library_usage': case 'salary_report': case 'accounts_statement':
                                filtersHtml = `<label>ÿ¥ÿ±Ÿàÿπ ⁄©€å ÿ™ÿßÿ±€åÿÆ</label><input type="date" id="report-start-date" class="form-control"><label>ÿßÿÆÿ™ÿ™ÿßŸÖ ⁄©€å ÿ™ÿßÿ±€åÿÆ</label><input type="date" id="report-end-date" class="form-control">`; break;
                        }
                        filterContainer.innerHTML = filtersHtml;
                    },
                    async generateReport() {
                        const reportType = document.getElementById('report-type').value;
                        App.showLoader();
                        const reportOutput = document.getElementById('report-output');
                        const reportTitleEl = document.getElementById('report-title');
                        const reportContentEl = document.getElementById('report-content');
                        let title = '', content = '';
                        title = document.querySelector('#report-type option:checked').textContent;
                        content = '<p>ÿ±ŸæŸàÿ±Ÿπ ⁄©€å €å€Å ŸÇÿ≥ŸÖ ÿßÿ®⁄æ€å ÿ≤€åÿ±Ÿê ÿ™ÿπŸÖ€åÿ± €Å€í€î</p>';
                        reportTitleEl.textContent = title;
                        reportContentEl.innerHTML = content;
                        reportOutput.style.display = 'block';
                        App.hideLoader();
                    },
                    exportToCSV() { }
                },
                Settings: {
                    render() {
                        if (App.currentUser.role !== 'admin') return '<p>ÿ¢Ÿæ ⁄©€í Ÿæÿßÿ≥ €å€Å ÿµŸÅÿ≠€Å ÿØ€å⁄©⁄æŸÜ€í ⁄©€å ÿßÿ¨ÿßÿ≤ÿ™ ŸÜ€Å€å⁄∫ €Å€í€î</p>';
                        return `<div id="settings-tabs" style="display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;"><button class="tab-btn active" data-tab="info">ÿßÿØÿßÿ±€í ⁄©€å ŸÖÿπŸÑŸàŸÖÿßÿ™</button><button class="tab-btn" data-tab="academic">ÿ™ÿπŸÑ€åŸÖ€å ÿ™ÿ±ÿ™€åÿ®ÿßÿ™</button><button class="tab-btn" data-tab="fees">ŸÅ€åÿ≥ ÿßÿ≥Ÿπÿ±⁄©⁄Üÿ±</button></div><div id="settings-content"></div>`;
                    },
                    async postRender() { if (App.currentUser.role === 'admin') { await this.loadForms(); } },
                    async loadForms() {
                        document.querySelectorAll('#settings-tabs .tab-btn').forEach(btn => {
                            btn.onclick = (e) => {
                                document.querySelectorAll('#settings-tabs .tab-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active');
                                this.renderTabContent(e.target.dataset.tab);
                            };
                        });
                        this.renderTabContent('info');
                    },
                    async renderTabContent(tab) {
                        const contentEl = document.getElementById('settings-content');
                        App.showLoader();
                        let html = '';
                        if (tab === 'info') {
                            html = `<div class="card"><form id="info-settings-form" onsubmit="App.Settings.saveInfo(event)"><div class="form-group"><label>ÿßÿØÿßÿ±€í ⁄©ÿß ŸÜÿßŸÖ</label><input type="text" name="schoolName" class="form-control" value="${App.settings.schoolName || ''}"></div><div class="form-group"><label>Ÿæÿ™€Å</label><input type="text" name="schoolAddress" class="form-control" value="${App.settings.schoolAddress || ''}"></div><div class="form-group"><label>ÿ±ÿßÿ®ÿ∑€Å ŸÜŸÖÿ®ÿ±</label><input type="text" name="schoolContact" class="form-control" value="${App.settings.schoolContact || ''}"></div><button type="submit" class="btn btn-primary">ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button></form></div>`;
                        } else if (tab === 'academic') {
                            const [classes, subjects] = await Promise.all([App.dbAction('classes', 'getAll'), App.dbAction('subjects', 'getAll')]);
                            html = `<div class="card"><h4>⁄©ŸÑÿßÿ≥ÿ≤</h4><div id="class-list">${classes.map(c => `<span class="badge">${c.name} - ${c.section}</span>`).join('')}</div><form id="class-form" onsubmit="App.Settings.saveClass(event)" class="search-filter-box" style="margin-top:15px;"><input type="text" name="name" class="form-control" placeholder="⁄©ŸÑÿßÿ≥ ⁄©ÿß ŸÜÿßŸÖ" required><input type="text" name="section" class="form-control" placeholder="ÿ≥€å⁄©ÿ¥ŸÜ" required><button type="submit" class="btn btn-primary">ŸÜÿ¶€å ⁄©ŸÑÿßÿ≥</button></form></div>
                                <div class="card"><h4>ŸÖÿ∂ÿßŸÖ€åŸÜ</h4><div id="subject-list">${subjects.map(s => `<span class="badge">${s.name}</span>`).join('')}</div><form id="subject-form" onsubmit="App.Settings.saveSubject(event)" class="search-filter-box" style="margin-top:15px;"><input type="text" name="name" class="form-control" placeholder="ŸÖÿ∂ŸÖŸàŸÜ ⁄©ÿß ŸÜÿßŸÖ" required><button type="submit" class="btn btn-primary">ŸÜ€åÿß ŸÖÿ∂ŸÖŸàŸÜ</button></form></div>`;
                        } else if (tab === 'fees') {
                            const classes = await App.dbAction('classes', 'getAll');
                            const feeStructures = new Map((App.settings.feeStructures || []).map(fs => [fs.classId, fs.amount]));
                            html = `<div class="card"><form id="fee-structure-form" onsubmit="App.Settings.saveFeeStructure(event)">${classes.map(c => `<div class="form-group"><label>${c.name}</label><input type="number" data-class-id="${c.id}" class="form-control fee-structure-input" value="${feeStructures.get(c.id) || ''}"></div>`).join('')}<button type="submit" class="btn btn-primary">ŸÅ€åÿ≥ ÿßÿ≥Ÿπÿ±⁄©⁄Üÿ± ŸÖÿ≠ŸÅŸàÿ∏ ⁄©ÿ±€å⁄∫</button></form></div>`;
                        }
                        contentEl.innerHTML = html;
                        App.hideLoader();
                    },
                    async saveInfo(event) {
                        event.preventDefault();
                        const form = document.getElementById('info-settings-form');
                        const settingsToSave = [{ key: 'schoolName', value: form.elements.schoolName.value }, { key: 'schoolAddress', value: form.elements.schoolAddress.value }, { key: 'schoolContact', value: form.elements.schoolContact.value },];
                        for (const setting of settingsToSave) { await App.dbAction('settings', 'put', setting); }
                        await App.loadSettings(); App.showToast('ŸÖÿπŸÑŸàŸÖÿßÿ™ ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Øÿ¶€å!', 'success');
                    },
                    async saveClass(event) {
                        event.preventDefault();
                        const form = document.getElementById('class-form');
                        const newClass = { name: form.elements.name.value, section: form.elements.section.value };
                        await App.dbAction('classes', 'add', newClass);
                        App.showToast('⁄©ŸÑÿßÿ≥ ÿ¥ÿßŸÖŸÑ €ÅŸà⁄Øÿ¶€å!', 'success'); this.renderTabContent('academic');
                    },
                    async saveSubject(event) {
                        event.preventDefault();
                        const form = document.getElementById('subject-form');
                        const newSubject = { name: form.elements.name.value };
                        await App.dbAction('subjects', 'add', newSubject);
                        App.showToast('ŸÖÿ∂ŸÖŸàŸÜ ÿ¥ÿßŸÖŸÑ €ÅŸà⁄Ø€åÿß!', 'success'); this.renderTabContent('academic');
                    },
                    async saveFeeStructure(event) {
                        event.preventDefault();
                        const inputs = document.querySelectorAll('.fee-structure-input');
                        const feeStructures = Array.from(inputs).map(input => ({ classId: parseInt(input.dataset.classId), amount: parseFloat(input.value) || 0 }));
                        await App.dbAction('settings', 'put', { key: 'feeStructures', value: feeStructures });
                        await App.loadSettings(); App.showToast('ŸÅ€åÿ≥ ÿßÿ≥Ÿπÿ±⁄©⁄Üÿ± ŸÖÿ≠ŸÅŸàÿ∏ €ÅŸà⁄Ø€åÿß!', 'success');
                    }
                },
                Backup: {
                    render() {
                        if (App.currentUser.role !== 'admin') return '<p>ÿ¢Ÿæ ⁄©€í Ÿæÿßÿ≥ €å€Å ÿµŸÅÿ≠€Å ÿØ€å⁄©⁄æŸÜ€í ⁄©€å ÿßÿ¨ÿßÿ≤ÿ™ ŸÜ€Å€å⁄∫ €Å€í€î</p>';
                        return `<div class="card"><div class="card-header"><h3 class="card-title">ÿ®€å⁄© ÿßŸæ ÿßŸàÿ± ÿ®ÿ≠ÿßŸÑ€å</h3></div><h4>ÿ®€å⁄© ÿßŸæ</h4><p>ÿßŸæŸÜ€í ÿ™ŸÖÿßŸÖ ⁄à€åŸπÿß ⁄©ÿß ÿ®€å⁄© ÿßŸæ ŸÑ€åŸÜ€í ⁄©€í ŸÑ€å€í ŸÜ€å⁄Ü€í ÿ®ŸπŸÜ Ÿæÿ± ⁄©ŸÑ⁄© ⁄©ÿ±€å⁄∫€î ÿß€å⁄© JSON ŸÅÿßÿ¶ŸÑ ⁄àÿßÿ§ŸÜ ŸÑŸà⁄à €ÅŸà ÿ¨ÿßÿ¶€í ⁄Ø€å€î</p><button class="btn btn-primary" id="backup-btn">ŸÖ⁄©ŸÖŸÑ ÿ®€å⁄© ÿßŸæ ÿ®ŸÜÿßÿ¶€å⁄∫</button><h4 style="margin-top: 30px;">ÿ®ÿ≠ÿßŸÑ€å (Restore)</h4><p style="color: var(--danger);"><strong>ÿßŸÜÿ™ÿ®ÿß€Å:</strong> ⁄à€åŸπÿß ÿ®ÿ≠ÿßŸÑ ⁄©ÿ±ŸÜ€í ÿ≥€í ŸÖŸàÿ¨ŸàÿØ€Å ÿ™ŸÖÿßŸÖ ⁄à€åŸπÿß ÿ≠ÿ∞ŸÅ €ÅŸà ÿ¨ÿßÿ¶€í ⁄Øÿß ÿßŸàÿ± ÿ®€å⁄© ÿßŸæ ŸÅÿßÿ¶ŸÑ ÿ≥€í ŸÜ€åÿß ⁄à€åŸπÿß ŸÑŸà⁄à €ÅŸà ÿ¨ÿßÿ¶€í ⁄Øÿß€î €å€Å ÿπŸÖŸÑ ŸàÿßŸæÿ≥ ŸÜ€Å€å⁄∫ ⁄©€åÿß ÿ¨ÿß ÿ≥⁄©ÿ™ÿß€î</p><input type="file" id="restore-input" accept=".json" class="form-control"><button class="btn btn-danger" id="restore-btn" style="margin-top: 10px;">⁄à€åŸπÿß ÿ®ÿ≠ÿßŸÑ ⁄©ÿ±€å⁄∫</button><h4 style="margin-top: 30px;">ÿ®€å⁄© ÿßŸæ ⁄©€å ÿ™ÿßÿ±€åÿÆ</h4><div id="backup-history"></div></div>`;
                    },
                    async postRender() {
                        if (App.currentUser.role === 'admin') {
                            document.getElementById('backup-btn').onclick = () => this.createBackup();
                            document.getElementById('restore-btn').onclick = () => this.restoreBackup();
                            await this.renderHistory();
                        }
                    },
                    async renderHistory() {
                        const history = await App.dbAction('backupHistory', 'getAll');
                        document.getElementById('backup-history').innerHTML = history.sort((a, b) => b.timestamp - a.timestamp).map(h => `<p>ÿ®€å⁄© ÿßŸæ ŸÑ€åÿß ⁄Ø€åÿß: ${new Date(h.timestamp).toLocaleString('ur-PK')} - ŸÅÿßÿ¶ŸÑ: ${h.fileName}</p>`).join('');
                    },
                    async createBackup() {
                        App.showLoader();
                        try {
                            const backupData = {};
                            const storeNames = App.db.objectStoreNames;
                            for (const storeName of storeNames) { if (storeName === 'backupHistory') continue; backupData[storeName] = await App.dbAction(storeName, 'getAll'); }
                            const jsonString = JSON.stringify(backupData, null, 2);
                            const blob = new Blob([jsonString], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            const fileName = `madrasa_backup_${new Date().toISOString().split('T')[0]}.json`;
                            link.href = url; link.download = fileName;
                            document.body.appendChild(link); link.click(); document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                            await App.dbAction('backupHistory', 'add', { timestamp: Date.now(), fileName: fileName, type: 'full' });
                            this.renderHistory(); App.showToast('ÿ®€å⁄© ÿßŸæ ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ®ŸÜ ⁄Ø€åÿß!', 'success');
                        } catch (err) { console.error('Backup failed:', err); App.showToast('ÿ®€å⁄© ÿßŸæ ÿ®ŸÜÿßŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error'); }
                        finally { App.hideLoader(); }
                    },
                    restoreBackup() {
                        const fileInput = document.getElementById('restore-input');
                        if (fileInput.files.length === 0) { App.showToast('ÿ®ÿ±ÿß€Å ⁄©ÿ±ŸÖ ÿ®ÿ≠ÿßŸÑ ⁄©ÿ±ŸÜ€í ⁄©€í ŸÑ€å€í ŸÅÿßÿ¶ŸÑ ŸÖŸÜÿ™ÿÆÿ® ⁄©ÿ±€å⁄∫', 'error'); return; }
                        if (!confirm("⁄©€åÿß ÿ¢Ÿæ ŸàÿßŸÇÿπ€å ⁄à€åŸπÿß ÿ®ÿ≠ÿßŸÑ ⁄©ÿ±ŸÜÿß ⁄Üÿß€Åÿ™€í €Å€å⁄∫ÿü ŸÖŸàÿ¨ŸàÿØ€Å ÿ™ŸÖÿßŸÖ ⁄à€åŸπÿß ÿ≠ÿ∞ŸÅ €ÅŸà ÿ¨ÿßÿ¶€í ⁄Øÿß€î")) { return; }
                        App.showLoader();
                        const file = fileInput.files[0];
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const backupData = JSON.parse(event.target.result);
                                const transaction = App.db.transaction(App.db.objectStoreNames, 'readwrite');
                                for (const storeName of App.db.objectStoreNames) { if (storeName === 'backupHistory') continue; transaction.objectStore(storeName).clear(); }
                                for (const storeName in backupData) { if (App.db.objectStoreNames.contains(storeName)) { const store = transaction.objectStore(storeName); for (const item of backupData[storeName]) { store.put(item); } } }
                                transaction.oncomplete = () => { App.hideLoader(); App.showToast('⁄à€åŸπÿß ⁄©ÿßŸÖ€åÿßÿ®€å ÿ≥€í ÿ®ÿ≠ÿßŸÑ €ÅŸà ⁄Ø€åÿß! ÿµŸÅÿ≠€Å ÿØŸàÿ®ÿßÿ±€Å ŸÑŸà⁄à €ÅŸà ÿ±€Åÿß €Å€í€î', 'success'); setTimeout(() => window.location.reload(), 2000); };
                                transaction.onerror = (e) => { App.hideLoader(); console.error('Restore error:', e.target.error); App.showToast('⁄à€åŸπÿß ÿ®ÿ≠ÿßŸÑ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error'); };
                            } catch (err) { App.hideLoader(); console.error('Restore failed:', err); App.showToast('ŸÅÿßÿ¶ŸÑ ⁄©Ÿà Ÿæ⁄ë⁄æŸÜ€í €åÿß Ÿæÿßÿ±ÿ≥ ⁄©ÿ±ŸÜ€í ŸÖ€å⁄∫ ŸÜÿß⁄©ÿßŸÖ€å!', 'error'); }
                        };
                        reader.readAsText(file);
                    }
                },
                printContent(content, title) {
                    const printWindow = window.open('', title, 'height=600,width=800');
                    printWindow.document.write('<html><head><title>' + title + '</title>');
                    printWindow.document.write('<style>body{font-family: "Noto Nastaliq Urdu", "Tahoma", sans-serif; direction: rtl; margin: 20px;} table {width: 100%; border-collapse: collapse; margin-top: 15px;} th,td{border:1px solid #333; padding: 8px; text-align: right;} thead{background-color: #f2f2f2;}</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(content);
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                    printWindow.focus();
                    setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
                },
                formatDate(dateString, placeholder = '---', context = 'Unknown') {
                    if (!dateString || typeof dateString !== 'string' || dateString.trim() === '') {
                        console.log(`[DEBUG: ${context}] formatDate received empty input. Using placeholder.`);
                        return placeholder;
                    }
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        console.error(`[DEBUG: ${context}] Invalid date string encountered:`, dateString);
                        return `<span style="color: var(--danger); font-weight: bold;">ÿ™ÿßÿ±€åÿÆ ÿ∫ŸÑÿ∑ €Å€í</span>`;
                    }
                    return date.toLocaleDateString('ur-PK', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                },
                async getSelectOptions(storeName, valueField, textField) {
                    const items = await this.dbAction(storeName, 'getAll');
                    return items.map(item => `<option value="${item[valueField]}">${item[textField]}</option>`).join('');
                }
            };
            App.init();
            window.App = App;
        });
    </script>
<script type="module">
  import { Workbox } from 'https://storage.googleapis.com/workbox-cdn/releases/7.0.0/workbox-window.prod.mjs';

  const swUrl = './sw.js';
  const wb = new Workbox(swUrl);

  // This event fires when a new service worker has installed but is waiting to activate.
  wb.addEventListener('waiting', (event) => {
    console.log('A new service worker is waiting to activate.');
    // This sends a message to the waiting service worker, telling it to activate.
    wb.messageSW({ type: 'SKIP_WAITING' });
  });

  // This event fires when the new service worker has taken control.
  wb.addEventListener('controlling', (event) => {
    console.log('The new service worker is now in control. Reloading page for updates...');
    window.location.reload();
  });

  // Register the service worker.
  wb.register();
</script></body>
</html>
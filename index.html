<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرسہ مینجمنٹ سسٹم Yasin's</title>
    <style>
        body {
            font-family: 'Noto Nastaliq Urdu', sans-serif;
            direction: rtl;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        nav {
            background-color: #5a8dee;
            padding: 10px 0;
            margin-bottom: 20px;
            text-align: center;
        }
        nav button {
            background-color: #4a7bdc;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 1.5em;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        nav button:hover {
            background-color: #3a6bcc;
        }
        nav button.active {
            background-color: #2a5bad;
        }
        .module {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            background-color: #fff;
        }
        .module.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="date"], select, textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
			font-size: larger;
        }
		.container div, p{
			font-size: x-large;
		}
        button, input[type="submit"] {
            background-color: #5cb85c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.3em;
            margin-top: 10px;
            margin-left: 5px;
        }
        button:hover, input[type="submit"]:hover {
            background-color: #4cae4c;
        }
        button.delete {
            background-color: #d9534f;
        }
        button.delete:hover {
            background-color: #c9302c;
        }
        button.edit {
            background-color: #f0ad4e;
        }
        button.edit:hover {
            background-color: #ec971f;
        }
        button.print {
            background-color: #5bc0de;
        }
        button.print:hover {
            background-color: #31b0d5;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        #feeReceiptContainer, #attendancePrintContainer, #resultCardPrintContainer {
            display: none; /* Hidden by default, shown for printing */
            border: 1px solid #000;
            padding: 20px;
            margin: 20px 0;
        }
         #feeReceiptContainer h3, #attendancePrintContainer h3, #resultCardPrintContainer h3 {
            text-align: center;
         }
        @media print {
            body * {
                visibility: hidden;
            }
             nav, .container > h1, .container > button, .module:not(.printable), .module > *:not(.printable-content) {
                display: none !important;
            }
            .printable, .printable * {
                 visibility: visible;
            }
            .printable {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10px;
                border: none;
                box-shadow: none;
                font-size: 12pt;
            }
             .printable table, .printable th, .printable td {
                border: 1px solid #666;
                padding: 5px;
            }
            button { display: none; }
        }
* {
    font-family: 'Jameel Noori Nastaleeq', Arial, sans-serif;
}
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>مدرسہ مینجمنٹ سسٹم</h1>

        <nav>
            <button onclick="showModule('dashboard')">ڈیش بورڈ</button>
            <button onclick="showModule('students')">طلباء</button>
            <button onclick="showModule('teachers')">اساتذہ</button>
            <button onclick="showModule('classes')">کلاسیں</button>
            <button onclick="showModule('fees')">فیس</button>
             <button onclick="showModule('feeStructures')">فیس اسٹرکچر</button>
            <button onclick="showModule('attendance')">حاضری</button>
            <button onclick="showModule('results')">نتائج</button>
            <button onclick="showModule('timetable')">ٹائم ٹیبل / ڈیوٹی روسٹر</button>
            <button onclick="showModule('expenses')">اخراجات</button>
            <button onclick="showModule('reports')">رپورٹس</button>
            <button onclick="showModule('settings')">سیٹنگز</button>
        </nav>

        <div id="dashboard" class="module active">
            <h2>ڈیش بورڈ</h2>
            <p>سسٹم میں خوش آمدید۔ یہاں آپ اہم اعدادوشمار دیکھ سکیں گے۔</p>
            <div class="form-grid">
                 <div>کل طلباء: <span id="totalStudents">0</span></div>
                 <div>کل اساتذہ: <span id="totalTeachers">0</span></div>
                 <div>کل کلاسیں: <span id="totalClasses">0</span></div>
                 <div>آج کی آمدنی (فیس): <span id="todayFees">0</span></div>
                 <div>آج کے اخراجات: <span id="todayExpenses">0</span></div>
            </div>
        </div>

        <div id="students" class="module">
            <h2>طلباء کا انتظام</h2>
            <h3>نیا طالب علم شامل کریں / ترمیم کریں</h3>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-grid">
                    <div>
                        <label for="admissionNo">داخلہ نمبر</label>
                        <input type="text" id="admissionNo" required>
                    </div>
                    <div>
                        <label for="studentName">نام</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div>
                        <label for="fatherName">والد کا نام</label>
                        <input type="text" id="fatherName" required>
                    </div>
                    <div>
                        <label for="studentClass">کلاس</label>
                        <select id="studentClass" required></select>
                    </div>
                     <div>
                        <label for="admissionDate">داخلہ تاریخ</label>
                        <input type="date" id="admissionDate" required>
                    </div>
                     <div>
                        <label for="studentContact">رابطہ نمبر</label>
                        <input type="text" id="studentContact">
                    </div>
                     <div>
                        <label for="studentAddress">پتہ</label>
                        <input type="text" id="studentAddress">
                    </div>
                </div>
                 <button type="submit">محفوظ کریں</button>
                 <button type="button" onclick="resetStudentForm()">منسوخ کریں</button>
            </form>

            <h3>طلباء کی فہرست</h3>
             <input type="text" id="studentSearch" placeholder="نام یا داخلہ نمبر سے تلاش کریں..." onkeyup="loadStudents()">
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th>داخلہ نمبر</th>
                        <th>نام</th>
                        <th>والد کا نام</th>
                        <th>کلاس</th>
                        <th>داخلہ تاریخ</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="teachers" class="module">
            <h2>اساتذہ کا انتظام</h2>
             <h3>نیا استاد شامل کریں / ترمیم کریں</h3>
             <form id="teacherForm">
                 <input type="hidden" id="teacherId">
                 <div class="form-grid">
                    <div>
                         <label for="teacherName">نام</label>
                         <input type="text" id="teacherName" required>
                    </div>
                    <div>
                         <label for="teacherSubjects">مضامین</label>
                         <input type="text" id="teacherSubjects" required>
                    </div>
                     <div>
                        <label for="teacherContact">موبائل نمبر</label>
                        <input type="text" id="teacherContact" required>
                    </div>
                    <div>
                        <label for="teacherSalary">طے شدہ تنخواہ</label>
                        <input type="number" id="teacherSalary" required>
                    </div>
                    <div>
                        <label for="appointmentDate">تقرری تاریخ</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                     <div>
                        <label for="teacherQualification">قابلیت</label>
                        <input type="text" id="teacherQualification">
                    </div>
                </div>
                 <button type="submit">محفوظ کریں</button>
                 <button type="button" onclick="resetTeacherForm()">منسوخ کریں</button>
             </form>

             <h3>اساتذہ کی فہرست</h3>
            <table id="teachersTable">
                <thead>
                    <tr>
                        <th>نام</th>
                        <th>مضامین</th>
                        <th>موبائل نمبر</th>
                        <th>تنخواہ</th>
                        <th>تقرری تاریخ</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="classes" class="module">
            <h2>کلاسوں کا انتظام</h2>
             <h3>نئی کلاس شامل کریں / ترمیم کریں</h3>
             <form id="classForm">
                <input type="hidden" id="classId">
                 <div class="form-grid">
                    <div>
                        <label for="className">کلاس کا نام</label>
                        <input type="text" id="className" required>
                    </div>
                     <div>
                        <label for="classTeacher">استاد</label>
                        <select id="classTeacher" required></select>
                    </div>
                    <div>
                        <label for="classSubjects">مضامین (کوما سے الگ کریں)</label>
                        <input type="text" id="classSubjects" required>
                    </div>
                </div>
                 <button type="submit">محفوظ کریں</button>
                 <button type="button" onclick="resetClassForm()">منسوخ کریں</button>
             </form>

            <h3>کلاسوں کی فہرست</h3>
            <table id="classesTable">
                <thead>
                    <tr>
                        <th>کلاس کا نام</th>
                        <th>استاد</th>
                        <th>مضامین</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

         <div id="feeStructures" class="module">
            <h2>فیس اسٹرکچر</h2>
             <h3>نیا فیس اسٹرکچر شامل کریں / ترمیم کریں</h3>
             <form id="feeStructureForm">
                <input type="hidden" id="feeStructureId">
                 <div class="form-grid">
                    <div>
                         <label for="feeStructureClass">کلاس</label>
                         <select id="feeStructureClass" required></select>
                    </div>
                     <div>
                        <label for="feeType">فیس کی قسم</label>
                        <input type="text" id="feeType" required placeholder="مثال: ٹیوشن فیس, داخلہ فیس">
                    </div>
                    <div>
                        <label for="feeAmount">رقم</label>
                        <input type="number" id="feeAmount" required>
                    </div>
                 </div>
                 <button type="submit">محفوظ کریں</button>
                 <button type="button" onclick="resetFeeStructureForm()">منسوخ کریں</button>
             </form>

            <h3>موجودہ فیس اسٹرکچر</h3>
             <label for="filterFeeStructureClass">کلاس کے لحاظ سے فلٹر کریں:</label>
             <select id="filterFeeStructureClass" onchange="loadFeeStructures()">
                 <option value="">تمام کلاسیں</option>
             </select>
            <table id="feeStructuresTable">
                <thead>
                    <tr>
                        <th>کلاس</th>
                        <th>فیس کی قسم</th>
                        <th>رقم</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>


        <div id="fees" class="module">
            <h2>فیس کا انتظام</h2>
            <h3>فیس وصولی</h3>
            <form id="feeCollectionForm">
                 <div class="form-grid">
                    <div>
                         <label for="feeStudentSelect">طالب علم منتخب کریں</label>
                         <select id="feeStudentSelect" required onchange="loadStudentFeeDetails()">
                             <option value="">-- طالب علم منتخب کریں --</option>
                         </select>
                     </div>
                      <div>
                        <label for="feeCollectionDate">تاریخ</label>
                        <input type="date" id="feeCollectionDate" required>
                    </div>
                     <div>
                         <label for="feeCollectionType">فیس کی قسم (واجب الادا سے)</label>
                         <select id="feeCollectionType" required>
                             <option value="">-- پہلے طالب علم منتخب کریں --</option>
                         </select>
                     </div>
                     <div>
                        <label for="feePaidAmount">ادا شدہ رقم</label>
                        <input type="number" id="feePaidAmount" required>
                    </div>
                     <div>
                         <label for="feeDiscount">رعایت</label>
                        <input type="number" id="feeDiscount" value="0">
                    </div>
                     <div>
                        <label for="feePaymentMethod">طریقہ</label>
                        <select id="feePaymentMethod" required>
                            <option value="Cash">نقد</option>
                            <option value="Bank">بینک</option>
                            <option value="Cheque">چیک</option>
                        </select>
                    </div>
                     <div class="full-width">
                        <label for="feeNotes">تفصیل/نوٹس</label>
                        <textarea id="feeNotes" rows="2"></textarea>
                    </div>
                 </div>
                 <button type="submit">فیس وصول کریں</button>
                 <button type="button" onclick="generateReceipt()">رسید بنائیں</button>
            </form>

             <h3>منتخب طالب علم کی فیس کی تفصیلات</h3>
             <p id="noStudentSelectedMsg">براہ کرم اوپر سے طالب علم منتخب کریں۔</p>
             <div id="studentFeeDetailsContainer" style="display: none;">
                 <h4>واجب الادا فیس</h4>
                 <ul id="dueFeesList"></ul>
                 <h4>جمع شدہ فیس کی تاریخ</h4>
                <table id="feeHistoryTable">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                             <th>فیس کی قسم</th>
                            <th>تفصیل/نوٹس</th>
                            <th>ادا شدہ رقم</th>
                            <th>رعایت</th>
                            <th>طریقہ</th>
                            <th>عمل</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
             </div>
             <div id="feeReceiptContainer" class="printable">
                <h3>فیس رسید</h3>
                 <p><strong>رسید نمبر:</strong> <span id="receiptId"></span></p>
                 <p><strong>تاریخ:</strong> <span id="receiptDate"></span></p>
                 <p><strong>طالب علم کا نام:</strong> <span id="receiptStudentName"></span></p>
                 <p><strong>کلاس:</strong> <span id="receiptStudentClass"></span></p>
                 <p><strong>فیس کی قسم:</strong> <span id="receiptFeeType"></span></p>
                 <p><strong>ادا شدہ رقم:</strong> <span id="receiptPaidAmount"></span></p>
                 <p><strong>رعایت:</strong> <span id="receiptDiscount"></span></p>
                 <p><strong>طریقہ:</strong> <span id="receiptMethod"></span></p>
                 <p><strong>نوٹس:</strong> <span id="receiptNotes"></span></p>
                 <br><br>
                 <p>دستخط وصول کنندہ: _______________</p>
                 <p style="font-size: 0.8em; text-align: center;">یہ کمپیوٹر سے تیار کردہ رسید ہے۔</p>
            </div>
        </div>

        <div id="attendance" class="module">
            <h2>حاضری کا انتظام</h2>
            <h3>حاضری لگائیں</h3>
            <div class="form-grid">
                <div>
                    <label for="attendanceDate">تاریخ</label>
                    <input type="date" id="attendanceDate" required>
                </div>
                <div>
                    <label for="attendanceClass">کلاس</label>
                    <select id="attendanceClass" required onchange="loadStudentsForAttendance()">
                         <option value="">-- کلاس منتخب کریں --</option>
                    </select>
                </div>
            </div>
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>داخلہ نمبر</th>
                        <th>نام</th>
                        <th>حاضری (Present/Absent)</th>
                    </tr>
                </thead>
                <tbody>
                     <tr><td colspan="3">براہ کرم تاریخ اور کلاس منتخب کریں۔</td></tr>
                </tbody>
            </table>
             <button onclick="saveAttendance()">حاضری محفوظ کریں</button>
             <button class="print" onclick="printAttendanceRegister()">حاضری رجسٹر پرنٹ کریں</button>

             <div id="attendancePrintContainer" class="printable">
                 <h3>حاضری رجسٹر</h3>
                 <p><strong>تاریخ:</strong> <span id="printAttendanceDate"></span></p>
                 <p><strong>کلاس:</strong> <span id="printAttendanceClass"></span></p>
                 <table id="attendancePrintTable" class="printable-content">
                     <thead>
                        <tr>
                             <th>داخلہ نمبر</th>
                             <th>نام</th>
                             <th>حالت</th>
                        </tr>
                     </thead>
                     <tbody>
                     </tbody>
                 </table>
             </div>
        </div>

        <div id="results" class="module">
            <h2>نتائج کا انتظام</h2>
            <h3>نتائج درج کریں / ترمیم کریں</h3>
             <div class="form-grid">
                <div>
                    <label for="resultExamName">امتحان کا نام</label>
                    <input type="text" id="resultExamName" placeholder="مثال: Mid Term, Final Term">
                </div>
                <div>
                    <label for="resultClass">کلاس</label>
                     <select id="resultClass" required onchange="loadStudentsAndSubjectsForResult()">
                         <option value="">-- کلاس منتخب کریں --</option>
                     </select>
                </div>
                 <div>
                    <label for="resultSubject">مضمون</label>
                     <select id="resultSubject" required>
                         <option value="">-- کلاس منتخب کریں --</option>
                     </select>
                 </div>
                 <div>
                    <label for="resultDate">تاریخ</label>
                    <input type="date" id="resultDate">
                </div>
            </div>

            <table id="resultsEntryTable">
                <thead>
                    <tr>
                        <th>طالب علم کا نام</th>
                        <th>کل نمبر</th>
                        <th>حاصل کردہ نمبر</th>
                    </tr>
                </thead>
                <tbody>
                     <tr><td colspan="3">براہ کرم امتحان، کلاس اور مضمون منتخب کریں۔</td></tr>
                </tbody>
            </table>
            <button onclick="saveResults()">نتائج محفوظ کریں</button>

             <h3>رزلٹ کارڈ دیکھیں/پرنٹ کریں</h3>
             <div class="form-grid">
                 <div>
                     <label for="resultCardStudent">طالب علم</label>
                     <select id="resultCardStudent">
                          <option value="">-- طالب علم منتخب کریں --</option>
                     </select>
                 </div>
                 <div>
                    <label for="resultCardExam">امتحان</label>
                     <select id="resultCardExam">
                         <option value="">-- امتحان منتخب کریں --</option>
                         </select>
                 </div>
             </div>
             <button class="print" onclick="printResultCard()">رزلٹ کارڈ پرنٹ کریں (منتخب طالب علم)</button>

             <div id="resultCardPrintContainer" class="printable">
                 <h3>رزلٹ کارڈ</h3>
                 <p><strong>امتحان:</strong> <span id="printResultExamName"></span></p>
                 <p><strong>طالب علم:</strong> <span id="printResultStudentName"></span></p>
                 <p><strong>کلاس:</strong> <span id="printResultClassName"></span></p>
                 <table id="resultCardPrintTable" class="printable-content">
                    <thead>
                        <tr>
                            <th>مضمون</th>
                            <th>کل نمبر</th>
                            <th>حاصل کردہ نمبر</th>
                            <th>گریڈ/فیصد</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                 </table>
                 <p><strong>کل حاصل کردہ نمبر:</strong> <span id="printResultTotalObtained"></span></p>
                 <p><strong>کل نمبر:</strong> <span id="printResultTotalMarks"></span></p>
                 <p><strong>مجموعی فیصد:</strong> <span id="printResultOverallPercentage"></span>%</p>
                 <p><strong>نتیجہ:</strong> <span id="printResultStatus"></span></p>
             </div>
        </div>

        <div id="timetable" class="module">
            <h2>ٹائم ٹیبل / ڈیوٹی روسٹر</h2>
            <h3>کلاس ٹائم ٹیبل بنائیں / ترمیم کریں</h3>
             <div class="form-grid">
                 <div>
                    <label for="timetableClass">کلاس</label>
                     <select id="timetableClass" onchange="loadTimetable()">
                         <option value="">-- کلاس منتخب کریں --</option>
                     </select>
                 </div>
             </div>
             <table id="classTimetableTable">
                <thead>
                    <tr>
                        <th>دن / وقت</th>
                        <th>পিরিয়ড ১ (شروع - ختم)</th>
                        <th>পিরিয়ড ২ (شروع - ختم)</th>
                        <th>পিরিয়ড ৩ (شروع - ختم)</th>
                        <th>পিরিয়ড ৪ (شروع - ختم)</th>
                    </tr>
                </thead>
                 <tbody>
                    </tbody>
             </table>
             <button onclick="saveTimetable()">ٹائم ٹیبل محفوظ کریں</button>

            <h3>اساتذہ کا ڈیوٹی روسٹر دیکھیں</h3>
             <div>
                <label for="dutyRoasterTeacher">استاد منتخب کریں</label>
                 <select id="dutyRoasterTeacher" onchange="loadTeacherRoaster()">
                     <option value="">-- استاد منتخب کریں --</option>
                 </select>
             </div>
            <table id="teacherRoasterTable">
                <thead>
                     <tr>
                        <th>دن / وقت</th>
                        <th>পিরিয়ড ১</th>
                        <th>পিরিয়ড ২</th>
                        <th>পিরিয়ড ৩</th>
                        <th>পিরিয়ড ৪</th>
                    </tr>
                </thead>
                 <tbody>
                    <tr><td colspan="5">براہ کرم استاد منتخب کریں۔</td></tr>
                </tbody>
             </table>
        </div>

        <div id="expenses" class="module">
            <h2>اخراجات کا انتظام</h2>
             <h3>نیا خرچہ شامل کریں / ترمیم کریں</h3>
             <form id="expenseForm">
                <input type="hidden" id="expenseId">
                 <div class="form-grid">
                     <div>
                         <label for="expenseDate">تاریخ</label>
                        <input type="date" id="expenseDate" required>
                     </div>
                      <div>
                        <label for="expenseType">قسم</label>
                        <input type="text" id="expenseType" placeholder="مثال: تنخواہ, بجلی کا بل, اسٹیشنری" required>
                     </div>
                      <div>
                        <label for="expenseAmount">رقم</label>
                        <input type="number" id="expenseAmount" required>
                     </div>
                      <div>
                        <label for="expensePaidTo">ادا کیا گیا (استاد/وغیرہ)</label>
                         <input type="text" id="expensePaidTo">
                     </div>
                     <div class="full-width">
                         <label for="expenseDescription">تفصیل</label>
                        <textarea id="expenseDescription" rows="2"></textarea>
                     </div>
                 </div>
                 <button type="submit">محفوظ کریں</button>
                 <button type="button" onclick="resetExpenseForm()">منسوخ کریں</button>
             </form>

             <h3>اخراجات کی فہرست</h3>
             <label for="expenseFilterDate">تاریخ کے لحاظ سے فلٹر کریں:</label>
             <input type="date" id="expenseFilterDate" onchange="loadExpenses()">
            <table id="expensesTable">
                <thead>
                    <tr>
                        <th>تاریخ</th>
                        <th>قسم</th>
                        <th>تفصیل</th>
                        <th>ادا کیا گیا</th>
                        <th>رقم</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div id="reports" class="module">
            <h2>رپورٹس</h2>
            <p>براہ کرم رپورٹ کی قسم منتخب کریں اور فلٹرز کا اطلاق کریں۔</p>
             <div class="form-grid">
                 <div>
                     <label for="reportType">رپورٹ کی قسم:</label>
                     <select id="reportType">
                         <option value="">-- منتخب کریں --</option>
                         <option value="fee_collection">فیس وصولی رپورٹ</option>
                         <option value="outstanding_fees">واجب الادا فیس رپورٹ</option>
                         <option value="attendance_summary">حاضری خلاصہ</option>
                         <option value="expense_report">اخراجات رپورٹ</option>
                          <option value="student_list">طلباء کی فہرست (کلاس وار)</option>
                     </select>
                 </div>
                 <div>
                     <label for="reportStartDate">شروع تاریخ:</label>
                     <input type="date" id="reportStartDate">
                 </div>
                 <div>
                     <label for="reportEndDate">اختتامی تاریخ:</label>
                     <input type="date" id="reportEndDate">
                 </div>
                  <div>
                     <label for="reportClassFilter">کلاس (اگر قابل اطلاق ہو):</label>
                     <select id="reportClassFilter">
                         <option value="">-- تمام --</option>
                     </select>
                 </div>
             </div>
             <button onclick="generateReport()">رپورٹ بنائیں</button>
             <button onclick="printReport()" class="print">رپورٹ پرنٹ کریں</button>

            <div id="reportOutput" class="printable">
                <h3>رپورٹ</h3>
                <div id="reportContent" class="printable-content">
                     <p>رپورٹ کا مواد یہاں ظاہر ہوگا۔</p>
                </div>
            </div>
        </div>

        <div id="settings" class="module">
            <h2>سیٹنگز</h2>
            <h3>ڈیٹا مینجمنٹ</h3>
            <button onclick="backupData()">ڈیٹا بیک اپ کریں (Export JSON)</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <button onclick="document.getElementById('importFile').click()">ڈیٹا امپورٹ کریں (Import JSON)</button>
             <p style="color: red;">نوٹ: امپورٹ کرنے سے موجودہ ڈیٹا مٹ سکتا ہے۔ پہلے بیک اپ ضرور بنا لیں۔</p>

             <h3>پرنٹ سیٹنگز</h3>
             <label for="schoolNamePrint">مدرسہ کا نام (رسیدوں/رپورٹس پر)</label>
             <input type="text" id="schoolNamePrint" placeholder="مدرسہ کا نام درج کریں">
             <button onclick="savePrintSettings()">سیٹنگز محفوظ کریں</button>
        </div>

    </div>

    <script>
        const DB_NAME = 'SchoolManagementDB';
        const DB_VERSION = 14;
        let db;

        const STORE_STUDENTS = 'students';
        const STORE_TEACHERS = 'teachers';
        const STORE_CLASSES = 'classes';
        const STORE_FEES = 'fees';
        const STORE_ATTENDANCE = 'attendance';
        const STORE_RESULTS = 'results';
        const STORE_EXPENSES = 'expenses';
        const STORE_FEE_STRUCTURES = 'feeStructures';
        const STORE_TIMETABLE = 'timetable';
        const STORE_SETTINGS = 'settings';


        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = (event) => {
                    console.error("Database error:", event.target.errorCode);
                    reject("Database error: " + event.target.errorCode);
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Database opened successfully");
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log("Upgrading database...");

                    const upgradeTransaction = event.target.transaction;

                    if (!db.objectStoreNames.contains(STORE_STUDENTS)) {
                        const studentStore = db.createObjectStore(STORE_STUDENTS, { keyPath: 'id', autoIncrement: true });
                        studentStore.createIndex('admissionNo', 'admissionNo', { unique: true });
                        studentStore.createIndex('name', 'name', { unique: false });
                        studentStore.createIndex('classId', 'classId', { unique: false });
                    } else {
                         const studentStore = upgradeTransaction.objectStore(STORE_STUDENTS);
                         if (!studentStore.indexNames.contains('classId')) {
                             studentStore.createIndex('classId', 'classId', { unique: false });
                         }
                    }


                    if (!db.objectStoreNames.contains(STORE_TEACHERS)) {
                        const teacherStore = db.createObjectStore(STORE_TEACHERS, { keyPath: 'id', autoIncrement: true });
                         teacherStore.createIndex('name', 'name', { unique: false });
                    }

                    if (!db.objectStoreNames.contains(STORE_CLASSES)) {
                        const classStore = db.createObjectStore(STORE_CLASSES, { keyPath: 'id', autoIncrement: true });
                        classStore.createIndex('name', 'name', { unique: true });
                         classStore.createIndex('teacherId', 'teacherId', { unique: false });
                     } else {
                         const classStore = upgradeTransaction.objectStore(STORE_CLASSES);
                         if (!classStore.indexNames.contains('teacherId')) {
                              classStore.createIndex('teacherId', 'teacherId', { unique: false });
                         }
                    }

                    if (!db.objectStoreNames.contains(STORE_FEE_STRUCTURES)) {
                         const feeStructureStore = db.createObjectStore(STORE_FEE_STRUCTURES, { keyPath: 'id', autoIncrement: true });
                         feeStructureStore.createIndex('classId_feeType', ['classId', 'feeType'], { unique: true });
                         feeStructureStore.createIndex('classId', 'classId', { unique: false });
                    } else {
                        const feeStructureStore = upgradeTransaction.objectStore(STORE_FEE_STRUCTURES);
                         if (!feeStructureStore.indexNames.contains('classId')) {
                             feeStructureStore.createIndex('classId', 'classId', { unique: false });
                         }
                         if (!feeStructureStore.indexNames.contains('classId_feeType')) {
                             try { feeStructureStore.deleteIndex('classId_feeType'); } catch(e) {}
                             feeStructureStore.createIndex('classId_feeType', ['classId', 'feeType'], { unique: true });
                         }
                    }


                    if (!db.objectStoreNames.contains(STORE_FEES)) {
                        const feeStore = db.createObjectStore(STORE_FEES, { keyPath: 'id', autoIncrement: true });
                        feeStore.createIndex('studentId', 'studentId', { unique: false });
                        feeStore.createIndex('date', 'date', { unique: false });
                        feeStore.createIndex('studentId_date', ['studentId', 'date'], { unique: false });
                    } else {
                         const feeStore = upgradeTransaction.objectStore(STORE_FEES);
                         if (!feeStore.indexNames.contains('studentId_date')) {
                             feeStore.createIndex('studentId_date', ['studentId', 'date'], { unique: false });
                         }
                    }

                    if (!db.objectStoreNames.contains(STORE_ATTENDANCE)) {
                        const attendanceStore = db.createObjectStore(STORE_ATTENDANCE, { keyPath: 'id', autoIncrement: true });
                        attendanceStore.createIndex('date_classId', ['date', 'classId'], { unique: false });
                        attendanceStore.createIndex('date_classId_studentId', ['date', 'classId', 'studentId'], { unique: true });
                    } else {
                         const attendanceStore = upgradeTransaction.objectStore(STORE_ATTENDANCE);
                         if (!attendanceStore.indexNames.contains('date_classId_studentId')) {
                             try { attendanceStore.deleteIndex('date_classId_studentId'); } catch(e) {} // Handle potential old structures
                             attendanceStore.createIndex('date_classId_studentId', ['date', 'classId', 'studentId'], { unique: true });
                         }
                    }


                    if (!db.objectStoreNames.contains(STORE_RESULTS)) {
                        const resultStore = db.createObjectStore(STORE_RESULTS, { keyPath: 'id', autoIncrement: true });
                        resultStore.createIndex('exam_class_subject_student', ['examName', 'classId', 'subject', 'studentId'], { unique: true });
                         resultStore.createIndex('studentId', 'studentId', { unique: false });
                         resultStore.createIndex('examName', 'examName', { unique: false });
                     } else {
                        const resultStore = upgradeTransaction.objectStore(STORE_RESULTS);
                         if (!resultStore.indexNames.contains('exam_class_subject_student')) {
                            try { resultStore.deleteIndex('exam_class_subject_student'); } catch(e) {}
                            resultStore.createIndex('exam_class_subject_student', ['examName', 'classId', 'subject', 'studentId'], { unique: true });
                         }
                         if (!resultStore.indexNames.contains('studentId')) {
                             resultStore.createIndex('studentId', 'studentId', { unique: false });
                         }
                         if (!resultStore.indexNames.contains('examName')) {
                            resultStore.createIndex('examName', 'examName', { unique: false });
                        }
                    }


                    if (!db.objectStoreNames.contains(STORE_EXPENSES)) {
                        const expenseStore = db.createObjectStore(STORE_EXPENSES, { keyPath: 'id', autoIncrement: true });
                        expenseStore.createIndex('date', 'date', { unique: false });
                    }

                     if (!db.objectStoreNames.contains(STORE_TIMETABLE)) {
                         const timetableStore = db.createObjectStore(STORE_TIMETABLE, { keyPath: 'id', autoIncrement: true });
                         timetableStore.createIndex('classId_day_period', ['classId', 'day', 'period'], { unique: true });
                         timetableStore.createIndex('classId', 'classId', { unique: false });
                         timetableStore.createIndex('teacherId', 'teacherId', { unique: false });
                     } else {
                         const timetableStore = upgradeTransaction.objectStore(STORE_TIMETABLE);
                          if (!timetableStore.indexNames.contains('classId')) {
                             timetableStore.createIndex('classId', 'classId', { unique: false });
                         }
                          if (!timetableStore.indexNames.contains('teacherId')) {
                             timetableStore.createIndex('teacherId', 'teacherId', { unique: false });
                         }
                         if (!timetableStore.indexNames.contains('classId_day_period')) {
                             try { timetableStore.deleteIndex('classId_day_period'); } catch(e) {}
                             timetableStore.createIndex('classId_day_period', ['classId', 'day', 'period'], { unique: true });
                         }
                     }

                     if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                        const settingsStore = db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                    }

                    console.log("Database upgrade complete");
                };
            });
        }

       function showModule(moduleId) {
    document.querySelectorAll('.module').forEach(module => module.classList.remove('active', 'printable'));
    document.getElementById(moduleId).classList.add('active');

    document.querySelectorAll('nav button').forEach(button => {
        button.classList.remove('active');
        const moduleName = document.querySelector(`#${moduleId} h2`)?.textContent || '';
        if (button.textContent === moduleName ||
            (moduleId === 'dashboard' && button.textContent === 'ڈیش بورڈ') ||
            (moduleId === 'students' && button.textContent === 'طلباء') ||
            (moduleId === 'teachers' && button.textContent === 'اساتذہ') ||
            (moduleId === 'classes' && button.textContent === 'کلاسیں') ||
            (moduleId === 'feeStructures' && button.textContent === 'فیس اسٹرکچر') ||
            (moduleId === 'fees' && button.textContent === 'فیس') ||
            (moduleId === 'attendance' && button.textContent === 'حاضری') ||
            (moduleId === 'results' && button.textContent === 'نتائج') ||
            (moduleId === 'timetable' && button.textContent === 'ٹائم ٹیبل / ڈیوٹی روسٹر') ||
            (moduleId === 'expenses' && button.textContent === 'اخراجات') ||
            (moduleId === 'reports' && button.textContent === 'رپورٹس') ||
            (moduleId === 'settings' && button.textContent === 'سیٹنگز')) {
            button.classList.add('active');
        }
    });

    if (moduleId === 'students') loadStudents();
    if (moduleId === 'teachers') loadTeachers();
    if (moduleId === 'classes') loadClasses();
    if (moduleId === 'fees') { loadStudentsForFeeSelect(); loadStudentFeeDetails(); }
    if (moduleId === 'attendance') { loadClassesForAttendance(); loadStudentsForAttendance(); }
    if (moduleId === 'results') { 
        createResultsModule(); 
        loadClassesForResults(); 
        loadStudentsForResultCard(); 
        loadExamsForResultCard(); 
        loadPastResults(); 
    }
    if (moduleId === 'expenses') loadExpenses();
    if (moduleId === 'feeStructures') { loadClassesForFeeStructureFilter(); loadFeeStructures(); }
    if (moduleId === 'timetable') { loadClassesForTimetable(); loadTeachersForRoaster(); loadTimetable(); }
    if (moduleId === 'dashboard') loadDashboardStats();
    if (moduleId === 'reports') loadClassesForReportFilter();
    if (moduleId === 'settings') loadPrintSettings();

    loadClassesForStudentForm();
    loadTeachersForClassForm();
}

        async function getObjectStore(storeName, mode) {
            if (!db) await openDatabase();
            const transaction = db.transaction(storeName, mode);
             transaction.onerror = event => console.error(`Transaction error on ${storeName}:`, event.target.error);
            return transaction.objectStore(storeName);
        }

         async function getAll(storeName, indexName = null, query = null) {
            const store = await getObjectStore(storeName, 'readonly');
            const request = indexName ? store.index(indexName).getAll(query) : store.getAll();
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                     console.error(`Error getting all from ${storeName}:`, event.target.error);
                     reject(event.target.error);
                 };
            });
        }

        async function getById(storeName, id) {
            const store = await getObjectStore(storeName, 'readonly');
            const request = store.get(id);
            return new Promise((resolve, reject) => {
                 request.onsuccess = () => resolve(request.result);
                 request.onerror = (event) => reject(event.target.error);
            });
        }

         async function addData(storeName, data) {
            const store = await getObjectStore(storeName, 'readwrite');
            const request = store.add(data);
             return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result); // Returns the key of the new record
                request.onerror = (event) => {
                     console.error(`Error adding data to ${storeName}:`, event.target.error);
                     reject(event.target.error);
                 };
             });
        }

         async function updateData(storeName, data) {
             const store = await getObjectStore(storeName, 'readwrite');
             const request = store.put(data); // put = update if key exists, add if not
             return new Promise((resolve, reject) => {
                 request.onsuccess = () => resolve(request.result);
                 request.onerror = (event) => {
                     console.error(`Error updating data in ${storeName}:`, event.target.error);
                     reject(event.target.error);
                 };
             });
         }

         async function deleteData(storeName, id) {
             const store = await getObjectStore(storeName, 'readwrite');
             const request = store.delete(id);
             return new Promise((resolve, reject) => {
                 request.onsuccess = () => resolve();
                 request.onerror = (event) => {
                    console.error(`Error deleting data from ${storeName}:`, event.target.error);
                     reject(event.target.error);
                 };
             });
         }

         async function clearStore(storeName) {
             const store = await getObjectStore(storeName, 'readwrite');
             const request = store.clear();
             return new Promise((resolve, reject) => {
                 request.onsuccess = () => resolve();
                 request.onerror = (event) => reject(event.target.error);
             });
         }


         async function loadClassesIntoSelect(selectElementId, addDefaultOption = true) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = addDefaultOption ? '<option value="">-- منتخب کریں --</option>' : '';
            try {
                const classes = await getAll(STORE_CLASSES);
                classes.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    select.appendChild(option);
                });
             } catch (error) {
                console.error("Error loading classes into select:", error);
            }
        }

         async function loadTeachersIntoSelect(selectElementId, addDefaultOption = true) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = addDefaultOption ? '<option value="">-- منتخب کریں --</option>' : '';
             try {
                const teachers = await getAll(STORE_TEACHERS);
                 teachers.sort((a, b) => a.name.localeCompare(b.name));
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });
             } catch (error) {
                 console.error("Error loading teachers into select:", error);
            }
        }

        async function loadStudentsIntoSelect(selectElementId, filterByClassId = null, addDefaultOption = true) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = addDefaultOption ? '<option value="">-- طالب علم منتخب کریں --</option>' : '';
            try {
                let students;
                 if (filterByClassId) {
                     students = await getAll(STORE_STUDENTS, 'classId', parseInt(filterByClassId));
                 } else {
                     students = await getAll(STORE_STUDENTS);
                 }
                 students.sort((a, b) => a.name.localeCompare(b.name));
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.admissionNo})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading students into select:", error);
            }
        }


        async function getClassName(classId) {
            if (!classId) return 'N/A';
            try {
                const cls = await getById(STORE_CLASSES, parseInt(classId));
                return cls ? cls.name : 'Unknown';
             } catch (error) {
                console.error("Error getting class name:", error);
                 return 'Error';
            }
        }

        async function getTeacherName(teacherId) {
            if (!teacherId) return 'N/A';
            try {
                 const teacher = await getById(STORE_TEACHERS, parseInt(teacherId));
                return teacher ? teacher.name : 'Unknown';
            } catch (error) {
                 console.error("Error getting teacher name:", error);
                return 'Error';
            }
        }

         async function getStudentName(studentId) {
            if (!studentId) return 'N/A';
            try {
                const student = await getById(STORE_STUDENTS, parseInt(studentId));
                return student ? student.name : 'Unknown';
            } catch (error) {
                console.error("Error getting student name:", error);
                 return 'Error';
            }
        }

        async function getStudentDetails(studentId) {
            if (!studentId) return null;
            try {
                return await getById(STORE_STUDENTS, parseInt(studentId));
            } catch (error) {
                console.error("Error getting student details:", error);
                 return null;
            }
        }

        async function loadDashboardStats() {
            try {
                const students = await getAll(STORE_STUDENTS);
                const teachers = await getAll(STORE_TEACHERS);
                const classes = await getAll(STORE_CLASSES);

                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('totalTeachers').textContent = teachers.length;
                document.getElementById('totalClasses').textContent = classes.length;

                 const today = new Date().toISOString().split('T')[0];
                 const fees = await getAll(STORE_FEES, 'date', today);
                 const expenses = await getAll(STORE_EXPENSES, 'date', today);

                 const totalFeesToday = fees.reduce((sum, fee) => sum + fee.paidAmount, 0);
                 const totalExpensesToday = expenses.reduce((sum, exp) => sum + exp.amount, 0);

                document.getElementById('todayFees').textContent = totalFeesToday.toLocaleString();
                document.getElementById('todayExpenses').textContent = totalExpensesToday.toLocaleString();

            } catch (error) {
                console.error("Error loading dashboard stats:", error);
            }
        }


        const studentForm = document.getElementById('studentForm');
        const studentTableBody = document.getElementById('studentsTable').querySelector('tbody');
        const studentSearchInput = document.getElementById('studentSearch');

        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value;
            const student = {
                admissionNo: document.getElementById('admissionNo').value,
                name: document.getElementById('studentName').value,
                fatherName: document.getElementById('fatherName').value,
                classId: parseInt(document.getElementById('studentClass').value),
                admissionDate: document.getElementById('admissionDate').value,
                 contact: document.getElementById('studentContact').value,
                 address: document.getElementById('studentAddress').value,
            };

             try {
                if (studentId) {
                    student.id = parseInt(studentId);
                    await updateData(STORE_STUDENTS, student);
                    alert('طالب علم کی معلومات اپ ڈیٹ ہو گئی۔');
                } else {
                     // Check uniqueness of admission number before adding
                     const store = await getObjectStore(STORE_STUDENTS, 'readonly');
                     const index = store.index('admissionNo');
                     const request = index.get(student.admissionNo);
                     request.onsuccess = async () => {
                         if (request.result) {
                            alert('یہ داخلہ نمبر پہلے سے موجود ہے۔');
                         } else {
                            await addData(STORE_STUDENTS, student);
                            alert('نیا طالب علم شامل ہو گیا۔');
                         }
                         resetStudentForm();
                         loadStudents();
                         loadDashboardStats(); // Update stats
                    };
                    request.onerror = (event) => {
                         console.error("Error checking admission number uniqueness:", event.target.error);
                         alert('ڈیٹا بیس میں خرابی۔');
                    };
                    // Prevent immediate form reset/load in this async path
                     return;
                }
                 resetStudentForm();
                 loadStudents();
                 loadDashboardStats(); // Update stats
            } catch (error) {
                console.error("Error saving student:", error);
                alert('طالب علم کو محفوظ کرنے میں خرابی: ' + error);
             }
        });

        function resetStudentForm() {
            studentForm.reset();
            document.getElementById('studentId').value = '';
        }

        async function loadStudents() {
            studentTableBody.innerHTML = '<tr><td colspan="6">لوڈ ہو رہا ہے...</td></tr>';
             const searchTerm = studentSearchInput.value.toLowerCase();
            try {
                 const students = await getAll(STORE_STUDENTS);
                 const classes = await getAll(STORE_CLASSES);
                 const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

                 studentTableBody.innerHTML = '';
                 students
                    .filter(student =>
                         student.name.toLowerCase().includes(searchTerm) ||
                         student.admissionNo.toLowerCase().includes(searchTerm)
                    )
                     .sort((a, b) => a.name.localeCompare(b.name)) // Sort alphabetically by name
                     .forEach(student => {
                        const row = studentTableBody.insertRow();
                        row.innerHTML = `
                            <td>${student.admissionNo}</td>
                            <td>${student.name}</td>
                            <td>${student.fatherName}</td>
                            <td>${classMap[student.classId] || 'N/A'}</td>
                            <td>${student.admissionDate}</td>
                            <td>
                                <button class="edit" onclick="editStudent(${student.id})">ترمیم</button>
                                <button class="delete" onclick="deleteStudent(${student.id})">حذف کریں</button>
                            </td>
                        `;
                });
                 if (studentTableBody.rows.length === 0) {
                    studentTableBody.innerHTML = '<tr><td colspan="6">کوئی طالب علم نہیں ملا۔</td></tr>';
                 }
            } catch (error) {
                console.error("Error loading students:", error);
                studentTableBody.innerHTML = '<tr><td colspan="6">طلباء کو لوڈ کرنے میں خرابی۔</td></tr>';
             }
        }


         async function editStudent(id) {
            try {
                const student = await getById(STORE_STUDENTS, id);
                if (student) {
                    document.getElementById('studentId').value = student.id;
                    document.getElementById('admissionNo').value = student.admissionNo;
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('fatherName').value = student.fatherName;
                    document.getElementById('studentClass').value = student.classId;
                    document.getElementById('admissionDate').value = student.admissionDate;
                    document.getElementById('studentContact').value = student.contact || '';
                    document.getElementById('studentAddress').value = student.address || '';
                     showModule('students'); // Switch to the tab if not already there
                     window.scrollTo(0, 0); // Scroll to top
                }
            } catch (error) {
                 console.error("Error fetching student for edit:", error);
                alert('ترمیم کے لیے طالب علم لانے میں خرابی۔');
            }
        }

        async function deleteStudent(id) {
            if (confirm('کیا آپ واقعی اس طالب علم کو حذف کرنا چاہتے ہیں؟')) {
                 try {
                    await deleteData(STORE_STUDENTS, id);
                     // TODO: Optionally delete related fees, attendance, results for this student
                    alert('طالب علم حذف ہو گیا۔');
                    loadStudents();
                    loadDashboardStats(); // Update stats
                 } catch (error) {
                     console.error("Error deleting student:", error);
                    alert('طالب علم کو حذف کرنے میں خرابی۔');
                }
            }
        }

         async function loadClassesForStudentForm() {
            await loadClassesIntoSelect('studentClass');
        }


        const teacherForm = document.getElementById('teacherForm');
        const teacherTableBody = document.getElementById('teachersTable').querySelector('tbody');

        teacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherId = document.getElementById('teacherId').value;
            const teacher = {
                name: document.getElementById('teacherName').value,
                subjects: document.getElementById('teacherSubjects').value,
                contact: document.getElementById('teacherContact').value,
                salary: parseFloat(document.getElementById('teacherSalary').value),
                appointmentDate: document.getElementById('appointmentDate').value,
                 qualification: document.getElementById('teacherQualification').value,
            };

            try {
                if (teacherId) {
                    teacher.id = parseInt(teacherId);
                    await updateData(STORE_TEACHERS, teacher);
                    alert('استاد کی معلومات اپ ڈیٹ ہو گئیں۔');
                } else {
                    await addData(STORE_TEACHERS, teacher);
                    alert('نیا استاد شامل ہو گیا۔');
                }
                resetTeacherForm();
                loadTeachers();
                loadDashboardStats(); // Update stats
             } catch (error) {
                console.error("Error saving teacher:", error);
                alert('استاد کو محفوظ کرنے میں خرابی۔');
            }
        });

        function resetTeacherForm() {
            teacherForm.reset();
            document.getElementById('teacherId').value = '';
        }

        async function loadTeachers() {
             teacherTableBody.innerHTML = '<tr><td colspan="6">لوڈ ہو رہا ہے...</td></tr>';
            try {
                 const teachers = await getAll(STORE_TEACHERS);
                 teacherTableBody.innerHTML = '';
                 teachers
                     .sort((a, b) => a.name.localeCompare(b.name))
                     .forEach(teacher => {
                        const row = teacherTableBody.insertRow();
                        row.innerHTML = `
                            <td>${teacher.name}</td>
                            <td>${teacher.subjects}</td>
                            <td>${teacher.contact}</td>
                            <td>${teacher.salary}</td>
                            <td>${teacher.appointmentDate}</td>
                            <td>
                                <button class="edit" onclick="editTeacher(${teacher.id})">ترمیم</button>
                                <button class="delete" onclick="deleteTeacher(${teacher.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                 if (teachers.length === 0) {
                     teacherTableBody.innerHTML = '<tr><td colspan="6">کوئی استاد نہیں ملا۔</td></tr>';
                 }
            } catch (error) {
                 console.error("Error loading teachers:", error);
                 teacherTableBody.innerHTML = '<tr><td colspan="6">اساتذہ کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }

        async function editTeacher(id) {
            try {
                const teacher = await getById(STORE_TEACHERS, id);
                if (teacher) {
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name;
                    document.getElementById('teacherSubjects').value = teacher.subjects;
                    document.getElementById('teacherContact').value = teacher.contact;
                    document.getElementById('teacherSalary').value = teacher.salary;
                    document.getElementById('appointmentDate').value = teacher.appointmentDate;
                     document.getElementById('teacherQualification').value = teacher.qualification || '';
                     showModule('teachers');
                     window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching teacher for edit:", error);
                alert('ترمیم کے لیے استاد لانے میں خرابی۔');
            }
        }

        async function deleteTeacher(id) {
            if (confirm('کیا آپ واقعی اس استاد کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await deleteData(STORE_TEACHERS, id);
                     // TODO: Maybe update classes assigned to this teacher? Set teacherId to null?
                    alert('استاد حذف ہو گیا۔');
                    loadTeachers();
                     loadDashboardStats(); // Update stats
                     loadTeachersForClassForm(); // Reload teacher dropdown in class form
                     loadTeachersForRoaster(); // Reload teacher dropdown in timetable
                } catch (error) {
                    console.error("Error deleting teacher:", error);
                    alert('استاد کو حذف کرنے میں خرابی۔');
                 }
            }
        }

        const classForm = document.getElementById('classForm');
        const classTableBody = document.getElementById('classesTable').querySelector('tbody');

         classForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const classId = document.getElementById('classId').value;
             const subjectsArray = document.getElementById('classSubjects').value.split(',').map(s => s.trim()).filter(s => s);
            const cls = {
                name: document.getElementById('className').value,
                teacherId: parseInt(document.getElementById('classTeacher').value),
                 subjects: subjectsArray,
             };

             try {
                 if (classId) {
                    cls.id = parseInt(classId);
                    await updateData(STORE_CLASSES, cls);
                    alert('کلاس کی معلومات اپ ڈیٹ ہو گئیں۔');
                 } else {
                    // Check uniqueness of class name
                     const store = await getObjectStore(STORE_CLASSES, 'readonly');
                     const index = store.index('name');
                     const request = index.get(cls.name);
                     request.onsuccess = async () => {
                         if (request.result) {
                             alert('اس نام کی کلاس پہلے سے موجود ہے۔');
                         } else {
                             await addData(STORE_CLASSES, cls);
                             alert('نئی کلاس شامل ہو گئی۔');
                         }
                         resetClassForm();
                         loadClasses();
                         loadDashboardStats(); // Update stats
                         loadClassesForStudentForm(); // Update dropdowns elsewhere
                         loadClassesForAttendance();
                         loadClassesForResults();
                         loadClassesForFeeStructureFilter();
                         loadClassesForTimetable();
                         loadClassesForReportFilter();
                     };
                     request.onerror = (event) => {
                         console.error("Error checking class name uniqueness:", event.target.error);
                         alert('ڈیٹا بیس میں خرابی۔');
                     };
                     return; // Prevent immediate reset/load
                 }
                 resetClassForm();
                 loadClasses();
                 loadDashboardStats(); // Update stats
                 loadClassesForStudentForm(); // Update dropdowns elsewhere
                 loadClassesForAttendance();
                 loadClassesForResults();
                 loadClassesForFeeStructureFilter();
                 loadClassesForTimetable();
                  loadClassesForReportFilter();
            } catch (error) {
                 console.error("Error saving class:", error);
                 alert('کلاس کو محفوظ کرنے میں خرابی: ' + error);
            }
        });

        function resetClassForm() {
            classForm.reset();
            document.getElementById('classId').value = '';
        }

         async function loadClasses() {
             classTableBody.innerHTML = '<tr><td colspan="4">لوڈ ہو رہا ہے...</td></tr>';
             try {
                 const classes = await getAll(STORE_CLASSES);
                 const teachers = await getAll(STORE_TEACHERS);
                 const teacherMap = teachers.reduce((map, teacher) => { map[teacher.id] = teacher.name; return map; }, {});

                 classTableBody.innerHTML = '';
                 classes
                    .sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true}))
                    .forEach(cls => {
                        const row = classTableBody.insertRow();
                        row.innerHTML = `
                            <td>${cls.name}</td>
                            <td>${teacherMap[cls.teacherId] || 'N/A'}</td>
                             <td>${cls.subjects ? cls.subjects.join(', ') : ''}</td>
                            <td>
                                <button class="edit" onclick="editClass(${cls.id})">ترمیم</button>
                                <button class="delete" onclick="deleteClass(${cls.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                 if (classes.length === 0) {
                    classTableBody.innerHTML = '<tr><td colspan="4">کوئی کلاس نہیں ملی۔</td></tr>';
                 }
             } catch (error) {
                console.error("Error loading classes:", error);
                 classTableBody.innerHTML = '<tr><td colspan="4">کلاسوں کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }


        async function editClass(id) {
            try {
                const cls = await getById(STORE_CLASSES, id);
                if (cls) {
                    document.getElementById('classId').value = cls.id;
                    document.getElementById('className').value = cls.name;
                    document.getElementById('classTeacher').value = cls.teacherId;
                    document.getElementById('classSubjects').value = cls.subjects ? cls.subjects.join(', ') : '';
                     showModule('classes');
                     window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching class for edit:", error);
                alert('ترمیم کے لیے کلاس لانے میں خرابی۔');
            }
        }

        async function deleteClass(id) {
             if (confirm('کیا آپ واقعی اس کلاس کو حذف کرنا چاہتے ہیں؟ اس سے متعلقہ طلباء، فیس اسٹرکچر، حاضری، نتائج اور ٹائم ٹیبل بھی متاثر ہو سکتے ہیں۔')) {
                 try {
                     // Check if any students are in this class
                     const studentsInClass = await getAll(STORE_STUDENTS, 'classId', id);
                     if (studentsInClass.length > 0) {
                         alert(`کلاس حذف نہیں کی جا سکتی کیونکہ اس میں ${studentsInClass.length} طلباء ہیں۔ پہلے طلباء کو منتقل کریں یا حذف کریں۔`);
                         return;
                     }
                     // Check fee structures
                     const feeStructuresInClass = await getAll(STORE_FEE_STRUCTURES, 'classId', id);
                     if (feeStructuresInClass.length > 0) {
                          alert(`کلاس حذف نہیں کی جا سکتی کیونکہ اس کے لیے فیس اسٹرکچر موجود ہیں۔ پہلے فیس اسٹرکچر حذف کریں۔`);
                         return;
                     }
                     // Add checks for attendance, results, timetable if needed

                    await deleteData(STORE_CLASSES, id);
                    alert('کلاس حذف ہو گئی۔');
                    loadClasses();
                     loadDashboardStats(); // Update stats
                     loadClassesForStudentForm(); // Update dropdowns elsewhere
                     loadClassesForAttendance();
                     loadClassesForResults();
                     loadClassesForFeeStructureFilter();
                     loadClassesForTimetable();
                     loadClassesForReportFilter();
                 } catch (error) {
                    console.error("Error deleting class:", error);
                    alert('کلاس کو حذف کرنے میں خرابی۔');
                }
            }
        }

         async function loadTeachersForClassForm() {
             await loadTeachersIntoSelect('classTeacher');
        }


        // Fee Structure Management
        const feeStructureForm = document.getElementById('feeStructureForm');
        const feeStructuresTableBody = document.getElementById('feeStructuresTable').querySelector('tbody');
        const filterFeeStructureClassSelect = document.getElementById('filterFeeStructureClass');

        feeStructureForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const structureId = document.getElementById('feeStructureId').value;
            const structure = {
                classId: parseInt(document.getElementById('feeStructureClass').value),
                feeType: document.getElementById('feeType').value.trim(),
                amount: parseFloat(document.getElementById('feeAmount').value),
            };

            if (!structure.classId || !structure.feeType || isNaN(structure.amount) || structure.amount <= 0) {
                 alert('براہ کرم تمام فیلڈز درست طریقے سے بھریں۔');
                 return;
            }

            try {
                 const indexKey = [structure.classId, structure.feeType];
                 const store = await getObjectStore(STORE_FEE_STRUCTURES, 'readwrite');
                 const index = store.index('classId_feeType');
                 const request = index.get(IDBKeyRange.only(indexKey));

                 request.onsuccess = async () => {
                     const existing = request.result;
                     if (existing && (!structureId || parseInt(structureId) !== existing.id)) {
                         alert('اس کلاس کے لیے یہ فیس کی قسم پہلے سے موجود ہے۔');
                         return;
                     }

                     if (structureId) {
                         structure.id = parseInt(structureId);
                         await updateData(STORE_FEE_STRUCTURES, structure);
                         alert('فیس اسٹرکچر اپ ڈیٹ ہو گیا۔');
                     } else {
                         await addData(STORE_FEE_STRUCTURES, structure);
                         alert('نیا فیس اسٹرکچر شامل ہو گیا۔');
                     }
                     resetFeeStructureForm();
                     loadFeeStructures();
                 };
                  request.onerror = (event) => {
                     console.error("Error checking fee structure uniqueness:", event.target.error);
                     alert('ڈیٹا بیس میں خرابی۔');
                 };

             } catch (error) {
                console.error("Error saving fee structure:", error);
                alert('فیس اسٹرکچر کو محفوظ کرنے میں خرابی: ' + error.message);
            }
        });

        function resetFeeStructureForm() {
            feeStructureForm.reset();
            document.getElementById('feeStructureId').value = '';
        }

        async function loadFeeStructures() {
             feeStructuresTableBody.innerHTML = '<tr><td colspan="4">لوڈ ہو رہا ہے...</td></tr>';
             const filterClassId = filterFeeStructureClassSelect.value ? parseInt(filterFeeStructureClassSelect.value) : null;

             try {
                 let structures;
                 if (filterClassId) {
                     structures = await getAll(STORE_FEE_STRUCTURES, 'classId', filterClassId);
                 } else {
                     structures = await getAll(STORE_FEE_STRUCTURES);
                 }
                const classes = await getAll(STORE_CLASSES);
                 const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

                 feeStructuresTableBody.innerHTML = '';
                 structures
                     .sort((a, b) => {
                        const classCompare = (classMap[a.classId] || '').localeCompare(classMap[b.classId] || '', undefined, { numeric: true });
                        if (classCompare !== 0) return classCompare;
                         return a.feeType.localeCompare(b.feeType);
                     })
                     .forEach(structure => {
                        const row = feeStructuresTableBody.insertRow();
                        row.innerHTML = `
                            <td>${classMap[structure.classId] || 'N/A'}</td>
                            <td>${structure.feeType}</td>
                            <td>${structure.amount.toLocaleString()}</td>
                            <td>
                                <button class="edit" onclick="editFeeStructure(${structure.id})">ترمیم</button>
                                <button class="delete" onclick="deleteFeeStructure(${structure.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                 if (structures.length === 0) {
                     feeStructuresTableBody.innerHTML = '<tr><td colspan="4">کوئی فیس اسٹرکچر نہیں ملا۔</td></tr>';
                 }
            } catch (error) {
                 console.error("Error loading fee structures:", error);
                 feeStructuresTableBody.innerHTML = '<tr><td colspan="4">فیس اسٹرکچر کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }

        async function editFeeStructure(id) {
            try {
                 const structure = await getById(STORE_FEE_STRUCTURES, id);
                if (structure) {
                    document.getElementById('feeStructureId').value = structure.id;
                    document.getElementById('feeStructureClass').value = structure.classId;
                    document.getElementById('feeType').value = structure.feeType;
                    document.getElementById('feeAmount').value = structure.amount;
                     showModule('feeStructures');
                     window.scrollTo(0, 0);
                }
             } catch (error) {
                console.error("Error fetching fee structure for edit:", error);
                alert('ترمیم کے لیے فیس اسٹرکچر لانے میں خرابی۔');
            }
        }

        async function deleteFeeStructure(id) {
             if (confirm('کیا آپ واقعی اس فیس اسٹرکچر کو حذف کرنا چاہتے ہیں؟')) {
                 try {
                    await deleteData(STORE_FEE_STRUCTURES, id);
                    alert('فیس اسٹرکچر حذف ہو گیا۔');
                    loadFeeStructures();
                } catch (error) {
                     console.error("Error deleting fee structure:", error);
                    alert('فیس اسٹرکچر کو حذف کرنے میں خرابی۔');
                }
            }
        }

        async function loadClassesForFeeStructureFilter() {
            await loadClassesIntoSelect('feeStructureClass'); // For the form
            await loadClassesIntoSelect('filterFeeStructureClass'); // For the filter dropdown
        }


        // Fee Collection Management
        const feeCollectionForm = document.getElementById('feeCollectionForm');
        const feeStudentSelect = document.getElementById('feeStudentSelect');
        const feeHistoryTableBody = document.getElementById('feeHistoryTable').querySelector('tbody');
        const studentFeeDetailsContainer = document.getElementById('studentFeeDetailsContainer');
        const noStudentSelectedMsg = document.getElementById('noStudentSelectedMsg');
         const dueFeesList = document.getElementById('dueFeesList');
         const feeCollectionTypeSelect = document.getElementById('feeCollectionType');

         feeCollectionForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             const studentId = parseInt(feeStudentSelect.value);
             const feeType = feeCollectionTypeSelect.value;
             const paidAmount = parseFloat(document.getElementById('feePaidAmount').value);

             if (!studentId || !feeType || isNaN(paidAmount) || paidAmount <= 0) {
                 alert('براہ کرم طالب علم، فیس کی قسم، اور ادا شدہ رقم درست درج کریں۔');
                 return;
             }

            const feeRecord = {
                studentId: studentId,
                date: document.getElementById('feeCollectionDate').value || new Date().toISOString().split('T')[0],
                feeType: feeType,
                paidAmount: paidAmount,
                discount: parseFloat(document.getElementById('feeDiscount').value) || 0,
                method: document.getElementById('feePaymentMethod').value,
                notes: document.getElementById('feeNotes').value.trim()
             };

             try {
                 await addData(STORE_FEES, feeRecord);
                 alert('فیس کامیابی سے وصول ہو گئی۔');
                 feeCollectionForm.reset(); // Reset specific fields might be better
                 document.getElementById('feePaidAmount').value = '';
                 document.getElementById('feeDiscount').value = '0';
                 document.getElementById('feeNotes').value = '';
                 // Don't reset student selection, reload details instead
                 loadStudentFeeDetails(studentId); // Reload details for the same student
                 loadDashboardStats(); // Update dashboard
            } catch (error) {
                 console.error("Error saving fee record:", error);
                 alert('فیس ریکارڈ کو محفوظ کرنے میں خرابی۔');
            }
        });

        async function loadStudentsForFeeSelect() {
             await loadStudentsIntoSelect('feeStudentSelect', null, true); // Load all students
        }

        async function loadStudentFeeDetails(selectedStudentId = null) {
            const studentId = selectedStudentId || parseInt(feeStudentSelect.value);

             feeHistoryTableBody.innerHTML = ''; // Clear previous history
            dueFeesList.innerHTML = ''; // Clear previous due fees
             feeCollectionTypeSelect.innerHTML = '<option value="">-- پہلے طالب علم منتخب کریں --</option>'; // Clear fee types

            if (!studentId || isNaN(studentId)) {
                 studentFeeDetailsContainer.style.display = 'none';
                 noStudentSelectedMsg.style.display = 'block';
                return;
            }

             studentFeeDetailsContainer.style.display = 'block';
             noStudentSelectedMsg.style.display = 'none';
             feeHistoryTableBody.innerHTML = '<tr><td colspan="7">لوڈ ہو رہا ہے...</td></tr>';
             dueFeesList.innerHTML = '<li>لوڈ ہو رہا ہے...</li>';


             try {
                 const student = await getById(STORE_STUDENTS, studentId);
                 if (!student || !student.classId) {
                     throw new Error('Student or student class not found.');
                 }

                 // 1. Get applicable fee structures for the student's class
                 const feeStructures = await getAll(STORE_FEE_STRUCTURES, 'classId', student.classId);

                 // 2. Get all fee payments made by this student
                 const feePayments = await getAll(STORE_FEES, 'studentId', studentId);

                 // 3. Calculate paid amounts for each fee type
                 const paidAmounts = feePayments.reduce((acc, payment) => {
                     acc[payment.feeType] = (acc[payment.feeType] || 0) + payment.paidAmount + payment.discount;
                     return acc;
                 }, {});

                 // 4. Determine due fees and populate fee type dropdown
                 dueFeesList.innerHTML = '';
                 feeCollectionTypeSelect.innerHTML = '<option value="">-- فیس کی قسم منتخب کریں --</option>';
                 let hasDueFees = false;

                 feeStructures.forEach(structure => {
                     const totalPaid = paidAmounts[structure.feeType] || 0;
                     const dueAmount = structure.amount - totalPaid;

                     if (dueAmount > 0) {
                         hasDueFees = true;
                         const li = document.createElement('li');
                         li.textContent = `${structure.feeType}: ${structure.amount.toLocaleString()} (واجب الادا: ${dueAmount.toLocaleString()})`;
                         dueFeesList.appendChild(li);

                         const option = document.createElement('option');
                         option.value = structure.feeType;
                         option.textContent = `${structure.feeType} (${dueAmount.toLocaleString()} واجب الادا)`;
                         feeCollectionTypeSelect.appendChild(option);
                     }
                 });

                 if (!hasDueFees) {
                    dueFeesList.innerHTML = '<li>کوئی فیس واجب الادا نہیں۔</li>';
                 }
                 if (feeCollectionTypeSelect.options.length <= 1) {
                      feeCollectionTypeSelect.innerHTML = '<option value="">کوئی واجب الادا فیس نہیں۔</option>';
                      feeCollectionTypeSelect.disabled = true;
                 } else {
                      feeCollectionTypeSelect.disabled = false;
                 }


                 // 5. Populate fee payment history table
                 feeHistoryTableBody.innerHTML = '';
                 feePayments
                    .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date descending
                     .forEach(payment => {
                        const row = feeHistoryTableBody.insertRow();
                        row.innerHTML = `
                            <td>${payment.date}</td>
                            <td>${payment.feeType}</td>
                            <td>${payment.notes || '-'}</td>
                            <td>${payment.paidAmount.toLocaleString()}</td>
                            <td>${payment.discount.toLocaleString()}</td>
                            <td>${payment.method}</td>
                             <td><button class="delete" onclick="deleteFeeRecord(${payment.id})">حذف کریں</button></td>
                        `;
                    });

                 if (feePayments.length === 0) {
                     feeHistoryTableBody.innerHTML = '<tr><td colspan="7">کوئی فیس جمع نہیں کرائی گئی۔</td></tr>';
                 }

             } catch (error) {
                 console.error("Error loading student fee details:", error);
                 feeHistoryTableBody.innerHTML = '<tr><td colspan="7">فیس کی تفصیلات لوڈ کرنے میں خرابی۔</td></tr>';
                 dueFeesList.innerHTML = '<li>فیس کی تفصیلات لوڈ کرنے میں خرابی۔</li>';
                 studentFeeDetailsContainer.style.display = 'none';
                 noStudentSelectedMsg.style.display = 'block';
                 noStudentSelectedMsg.textContent = 'فیس کی تفصیلات لوڈ کرنے میں خرابی۔';
             }
        }

         async function deleteFeeRecord(id) {
             if (confirm('کیا آپ واقعی اس فیس ریکارڈ کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    const studentId = parseInt(feeStudentSelect.value); // Get current student to reload
                    await deleteData(STORE_FEES, id);
                    alert('فیس ریکارڈ حذف ہو گیا۔');
                    loadStudentFeeDetails(studentId); // Reload details
                    loadDashboardStats(); // Update dashboard
                 } catch (error) {
                    console.error("Error deleting fee record:", error);
                    alert('فیس ریکارڈ کو حذف کرنے میں خرابی۔');
                }
            }
        }

        async function generateReceipt() {
            const studentId = parseInt(feeStudentSelect.value);
             const paidAmount = parseFloat(document.getElementById('feePaidAmount').value);
             const feeType = feeCollectionTypeSelect.value; // Use the selected due fee type

             if (!studentId || !feeType || isNaN(paidAmount) || paidAmount <= 0) {
                alert('رسید بنانے کے لیے براہ کرم طالب علم منتخب کریں، واجب الادا فیس کی قسم منتخب کریں، اور ادا شدہ رقم درج کریں۔');
                return;
            }

            try {
                 const student = await getById(STORE_STUDENTS, studentId);
                 const cls = student ? await getById(STORE_CLASSES, student.classId) : null;

                 document.getElementById('receiptId').textContent = `F-${Date.now()}`; // Simple temporary ID
                 document.getElementById('receiptDate').textContent = document.getElementById('feeCollectionDate').value || new Date().toLocaleDateString('en-CA'); // Use YYYY-MM-DD
                document.getElementById('receiptStudentName').textContent = student ? student.name : 'N/A';
                document.getElementById('receiptStudentClass').textContent = cls ? cls.name : 'N/A';
                document.getElementById('receiptFeeType').textContent = feeType;
                document.getElementById('receiptPaidAmount').textContent = paidAmount.toLocaleString();
                document.getElementById('receiptDiscount').textContent = (parseFloat(document.getElementById('feeDiscount').value) || 0).toLocaleString();
                document.getElementById('receiptMethod').textContent = document.getElementById('feePaymentMethod').value;
                document.getElementById('receiptNotes').textContent = document.getElementById('feeNotes').value || '-';

                 const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                 const schoolName = schoolNameSetting ? schoolNameSetting.value : 'مدرسہ کا نام';
                 const receiptHeader = document.createElement('h3');
                 receiptHeader.textContent = `${schoolName} - فیس رسید`;
                 const receiptContainer = document.getElementById('feeReceiptContainer');
                  // Remove existing h3 if any before prepending new one
                  const existingHeader = receiptContainer.querySelector('h3');
                  if (existingHeader) existingHeader.remove();
                  receiptContainer.prepend(receiptHeader); // Add school name to header


                 // Make the receipt container printable and print
                 receiptContainer.style.display = 'block';
                 receiptContainer.classList.add('printable');
                 window.print();
                 receiptContainer.classList.remove('printable');
                 receiptContainer.style.display = 'none';

            } catch (error) {
                 console.error("Error generating receipt:", error);
                 alert('رسید بنانے میں خرابی۔');
            }
        }


        // Attendance Management
        const attendanceClassSelect = document.getElementById('attendanceClass');
        const attendanceDateInput = document.getElementById('attendanceDate');
        const attendanceTableBody = document.getElementById('attendanceTable').querySelector('tbody');

        async function loadClassesForAttendance() {
             await loadClassesIntoSelect('attendanceClass');
        }

         async function loadStudentsForAttendance() {
             const classId = parseInt(attendanceClassSelect.value);
             const date = attendanceDateInput.value;
             attendanceTableBody.innerHTML = '';

            if (!classId || !date) {
                 attendanceTableBody.innerHTML = '<tr><td colspan="3">براہ کرم تاریخ اور کلاس منتخب کریں۔</td></tr>';
                 return;
             }

             attendanceTableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';

            try {
                const students = await getAll(STORE_STUDENTS, 'classId', classId);
                if (students.length === 0) {
                     attendanceTableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
                     return;
                }

                // Fetch existing attendance for this date and class to pre-fill
                const existingAttendance = await getAll(STORE_ATTENDANCE, 'date_classId', [date, classId]);
                 const attendanceMap = existingAttendance.reduce((map, record) => {
                     map[record.studentId] = record.status;
                     return map;
                 }, {});


                 attendanceTableBody.innerHTML = '';
                students
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(student => {
                        const row = attendanceTableBody.insertRow();
                        const existingStatus = attendanceMap[student.id] || 'Present'; // Default to Present

                        row.innerHTML = `
                            <td>${student.admissionNo}</td>
                            <td>${student.name}</td>
                            <td>
                                <label>
                                    <input type="radio" name="attendance_${student.id}" value="Present" data-student-id="${student.id}" ${existingStatus === 'Present' ? 'checked' : ''}> حاضر
                                </label>
                                <label style="margin-right: 15px;">
                                    <input type="radio" name="attendance_${student.id}" value="Absent" data-student-id="${student.id}" ${existingStatus === 'Absent' ? 'checked' : ''}> غیر حاضر
                                </label>
                             </td>
                        `;
                    });
            } catch (error) {
                console.error("Error loading students for attendance:", error);
                 attendanceTableBody.innerHTML = '<tr><td colspan="3">حاضری کے لیے طلباء کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }

        async function saveAttendance() {
            const date = attendanceDateInput.value;
            const classId = parseInt(attendanceClassSelect.value);
            const attendanceRows = attendanceTableBody.querySelectorAll('input[type="radio"]:checked');

             if (!date || !classId || attendanceRows.length === 0) {
                 alert('براہ کرم تاریخ، کلاس منتخب کریں اور حاضری لگائیں۔');
                 return;
             }

             const attendanceData = [];
             attendanceRows.forEach(input => {
                 attendanceData.push({
                     date: date,
                     classId: classId,
                     studentId: parseInt(input.dataset.studentId),
                     status: input.value
                 });
             });

             try {
                 const store = await getObjectStore(STORE_ATTENDANCE, 'readwrite');
                 const index = store.index('date_classId_studentId');
                 let completed = 0;

                 // Use transaction for multiple puts (upserts)
                 const transaction = store.transaction;

                 attendanceData.forEach(record => {
                     // We need to find the existing record's key if it exists, or just put.
                      // Using put directly handles both add and update based on the keyPath (id).
                      // However, our unique index is on date_classId_studentId. We should first query
                      // if a record exists for this combination, get its ID, then update, otherwise add.
                      // Simpler approach for now: Delete existing for the day/class, then add new ones.
                      // More robust: Query each student, update if exists, add if not.

                      // Let's try the robust approach:
                      const request = index.get([record.date, record.classId, record.studentId]);
                      request.onsuccess = () => {
                          const existingRecord = request.result;
                          if (existingRecord) {
                              // Update existing record
                              existingRecord.status = record.status;
                              const updateRequest = store.put(existingRecord);
                              updateRequest.onsuccess = () => checkCompletion();
                               updateRequest.onerror = (e) => console.error("Error updating attendance record:", e.target.error);
                          } else {
                              // Add new record
                               const addRequest = store.add(record);
                               addRequest.onsuccess = () => checkCompletion();
                               addRequest.onerror = (e) => console.error("Error adding attendance record:", e.target.error);
                          }
                      };
                      request.onerror = (e) => console.error("Error querying existing attendance:", e.target.error);

                 });

                 function checkCompletion() {
                     completed++;
                     if (completed === attendanceData.length) {
                         transaction.oncomplete = () => {
                             alert('حاضری کامیابی سے محفوظ ہو گئی۔');
                         };
                         transaction.onerror = (event) => {
                              console.error("Transaction error saving attendance:", event.target.error);
                             alert('حاضری محفوظ کرنے میں خرابی: ٹرانزیکشن ناکام۔');
                         };
                         // If the transaction auto-commits before all requests finish, this might not work as expected.
                         // For simplicity and given the scope, we assume it works for now.
                         // A more complex Promise.all approach might be needed for perfect handling.
                     }
                 }
                 // Fallback alert in case transaction handling isn't perfect
                 setTimeout(() => {
                     if (completed === attendanceData.length) alert('حاضری کامیابی سے محفوظ ہو گئی۔ (Fallback)');
                 }, 500);


             } catch (error) {
                console.error("Error saving attendance:", error);
                 alert('حاضری کو محفوظ کرنے میں خرابی۔');
            }
        }


        async function printAttendanceRegister() {
             const date = attendanceDateInput.value;
             const classId = parseInt(attendanceClassSelect.value);
             const className = attendanceClassSelect.options[attendanceClassSelect.selectedIndex]?.text || 'N/A';

             if (!date || !classId) {
                 alert('پرنٹ کرنے کے لیے براہ کرم تاریخ اور کلاس منتخب کریں۔');
                 return;
             }

             const printContainer = document.getElementById('attendancePrintContainer');
             const printTableBody = document.getElementById('attendancePrintTable').querySelector('tbody');
             printTableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';

             document.getElementById('printAttendanceDate').textContent = date;
             document.getElementById('printAttendanceClass').textContent = className;

             try {
                 const attendanceRecords = await getAll(STORE_ATTENDANCE, 'date_classId', [date, classId]);
                 if (attendanceRecords.length === 0) {
                     alert('اس تاریخ اور کلاس کے لیے کوئی حاضری ریکارڈ نہیں ملا۔');
                     printTableBody.innerHTML = '<tr><td colspan="3">کوئی حاضری ریکارڈ نہیں۔</td></tr>';
                     return;
                 }

                 const studentIds = attendanceRecords.map(rec => rec.studentId);
                 const students = await Promise.all(studentIds.map(id => getById(STORE_STUDENTS, id)));

                 const studentMap = students.reduce((map, student) => {
                     if(student) map[student.id] = student;
                     return map;
                 }, {});

                 printTableBody.innerHTML = '';
                 attendanceRecords
                    .sort((a, b) => (studentMap[a.studentId]?.name || '').localeCompare(studentMap[b.studentId]?.name || ''))
                     .forEach(record => {
                        const student = studentMap[record.studentId];
                        if (student) {
                             const row = printTableBody.insertRow();
                             row.innerHTML = `
                                 <td>${student.admissionNo}</td>
                                 <td>${student.name}</td>
                                 <td>${record.status === 'Present' ? 'حاضر' : 'غیر حاضر'}</td>
                             `;
                        }
                    });

                 const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                 const schoolName = schoolNameSetting ? schoolNameSetting.value : 'مدرسہ کا نام';
                 const printHeader = document.createElement('h3');
                 printHeader.textContent = `${schoolName} - حاضری رجسٹر`;
                 const existingHeader = printContainer.querySelector('h3');
                 if (existingHeader) existingHeader.remove();
                 printContainer.prepend(printHeader);


                 printContainer.style.display = 'block';
                 printContainer.classList.add('printable');
                 window.print();
                 printContainer.classList.remove('printable');
                 printContainer.style.display = 'none';

            } catch (error) {
                 console.error("Error preparing attendance register for print:", error);
                 alert('حاضری رجسٹر تیار کرنے میں خرابی۔');
                 printTableBody.innerHTML = '<tr><td colspan="3">خرابی۔</td></tr>';
            }
        }

        // Results Management
         const resultClassSelect = document.getElementById('resultClass');
         const resultSubjectSelect = document.getElementById('resultSubject');
         const resultsEntryTableBody = document.getElementById('resultsEntryTable').querySelector('tbody');
         const resultExamNameInput = document.getElementById('resultExamName');
         const resultDateInput = document.getElementById('resultDate');

         const resultCardStudentSelect = document.getElementById('resultCardStudent');
         const resultCardExamSelect = document.getElementById('resultCardExam');

         async function loadClassesForResults() {
             await loadClassesIntoSelect('resultClass');
         }

         async function loadStudentsAndSubjectsForResult() {
             const classId = parseInt(resultClassSelect.value);
             resultsEntryTableBody.innerHTML = ''; // Clear table first
             resultSubjectSelect.innerHTML = '<option value="">-- کلاس منتخب کریں --</option>'; // Clear subjects

             if (!classId) {
                 resultsEntryTableBody.innerHTML = '<tr><td colspan="3">براہ کرم امتحان، کلاس اور مضمون منتخب کریں۔</td></tr>';
                 return;
             }

             try {
                 // Load Subjects for the selected class
                 const cls = await getById(STORE_CLASSES, classId);
                 if (cls && cls.subjects && cls.subjects.length > 0) {
                     resultSubjectSelect.innerHTML = '<option value="">-- مضمون منتخب کریں --</option>';
                     cls.subjects.forEach(subject => {
                         const option = document.createElement('option');
                         option.value = subject;
                         option.textContent = subject;
                         resultSubjectSelect.appendChild(option);
                     });
                 } else {
                     resultSubjectSelect.innerHTML = '<option value="">اس کلاس میں کوئی مضمون نہیں</option>';
                     resultsEntryTableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی مضمون شامل نہیں۔</td></tr>';
                     return;
                 }

                 // Load Students for the selected class
                 resultsEntryTableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';
                 const students = await getAll(STORE_STUDENTS, 'classId', classId);

                 if (students.length === 0) {
                     resultsEntryTableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
                     return;
                 }

                  // Load existing marks if exam, class, and subject are selected
                  const examName = resultExamNameInput.value.trim();
                  const subject = resultSubjectSelect.value;
                  let marksMap = {};
                  if (examName && subject) {
                     const existingResults = await getAll(STORE_RESULTS, 'exam_class_subject_student'); // Fetch all results first
                      existingResults.forEach(res => {
                         // Manual filtering as compound index get is complex
                         if (res.examName === examName && res.classId === classId && res.subject === subject) {
                            marksMap[res.studentId] = { total: res.totalMarks, obtained: res.obtainedMarks };
                         }
                     });
                  }


                 resultsEntryTableBody.innerHTML = '';
                 students
                     .sort((a, b) => a.name.localeCompare(b.name))
                     .forEach(student => {
                        const existingMark = marksMap[student.id] || { total: 100, obtained: '' }; // Default total 100
                        const row = resultsEntryTableBody.insertRow();
                         row.innerHTML = `
                             <td>${student.name} (${student.admissionNo})</td>
                             <td><input type="number" class="result-total-marks" value="${existingMark.total}" min="0" style="width: 80px;"></td>
                             <td><input type="number" class="result-obtained-marks" value="${existingMark.obtained}" min="0" data-student-id="${student.id}" style="width: 80px;"></td>
                         `;
                    });

             } catch (error) {
                 console.error("Error loading students/subjects for results:", error);
                 resultsEntryTableBody.innerHTML = '<tr><td colspan="3">نتائج کے لیے طلباء/مضامین لوڈ کرنے میں خرابی۔</td></tr>';
             }
         }

         resultClassSelect.addEventListener('change', loadStudentsAndSubjectsForResult);
         //resultSubjectSelect.addEventListener('change', loadStudentsAndSubjectsForResult); // Reload marks when subject changes
         resultExamNameInput.addEventListener('change', loadStudentsAndSubjectsForResult); // Reload marks when exam changes


         async function saveResults() {
             const examName = resultExamNameInput.value.trim();
             const classId = parseInt(resultClassSelect.value);
             const subject = resultSubjectSelect.value;
             const date = resultDateInput.value || new Date().toISOString().split('T')[0];
             const marksRows = resultsEntryTableBody.querySelectorAll('tr');

             if (!examName || !classId || !subject || marksRows.length === 0 || resultsEntryTableBody.textContent.includes('کوئی طالب علم نہیں')) {
                 alert('براہ کرم امتحان کا نام، کلاس، مضمون منتخب کریں اور نمبر درج کریں۔');
                 return;
             }

             const resultsData = [];
             let valid = true;
             marksRows.forEach(row => {
                 const totalInput = row.querySelector('.result-total-marks');
                 const obtainedInput = row.querySelector('.result-obtained-marks');
                 if (obtainedInput && totalInput) {
                      const studentId = parseInt(obtainedInput.dataset.studentId);
                      const totalMarks = parseInt(totalInput.value);
                      const obtainedMarksStr = obtainedInput.value; // Can be empty if not entered

                      // Only save if obtained marks are entered
                      if (obtainedMarksStr !== '' && !isNaN(studentId) && !isNaN(totalMarks) && totalMarks > 0) {
                          const obtainedMarks = parseInt(obtainedMarksStr);
                           if (!isNaN(obtainedMarks) && obtainedMarks >= 0 && obtainedMarks <= totalMarks) {
                                resultsData.push({
                                    examName: examName,
                                    classId: classId,
                                    subject: subject,
                                    studentId: studentId,
                                    totalMarks: totalMarks,
                                    obtainedMarks: obtainedMarks,
                                    date: date
                                });
                            } else if (!isNaN(obtainedMarks)) { // Entered but invalid marks
                                 alert(`طالب علم ID ${studentId} کے لیے غلط نمبر درج کیے گئے ہیں۔ حاصل کردہ نمبر 0 اور ${totalMarks} کے درمیان ہونے چاہئیں۔`);
                                 valid = false;
                            }
                      } else if (obtainedMarksStr !== '') { // Entered but total marks might be missing or invalid
                          alert(`طالب علم ID ${studentId} کے لیے کل نمبر درست نہیں ہیں یا حاصل کردہ نمبر خالی ہیں۔`);
                          valid = false;
                      }
                 }
             });

             if (!valid || resultsData.length === 0) {
                 if(valid) alert('محفوظ کرنے کے لیے کوئی درست نتائج درج نہیں کیے گئے۔');
                 return;
             }

             try {
                  const store = await getObjectStore(STORE_RESULTS, 'readwrite');
                  const index = store.index('exam_class_subject_student');
                  let completed = 0;
                  const transaction = store.transaction;

                 resultsData.forEach(record => {
                     const keyRange = IDBKeyRange.only([record.examName, record.classId, record.subject, record.studentId]);
                     const request = index.get(keyRange);

                     request.onsuccess = () => {
                         const existingRecord = request.result;
                         if (existingRecord) {
                            // Update existing record
                             existingRecord.totalMarks = record.totalMarks;
                             existingRecord.obtainedMarks = record.obtainedMarks;
                             existingRecord.date = record.date;
                             const updateRequest = store.put(existingRecord);
                             updateRequest.onsuccess = () => checkCompletion();
                             updateRequest.onerror = (e) => console.error("Error updating result record:", e.target.error);
                         } else {
                             // Add new record
                             const addRequest = store.add(record);
                             addRequest.onsuccess = () => checkCompletion();
                             addRequest.onerror = (e) => console.error("Error adding result record:", e.target.error);
                         }
                     };
                      request.onerror = (e) => console.error("Error querying existing result:", e.target.error);
                 });

                 function checkCompletion() {
                     completed++;
                     if (completed === resultsData.length) {
                         transaction.oncomplete = () => {
                             alert('نتائج کامیابی سے محفوظ ہو گئے۔');
                             loadExamsForResultCard(); // Update exam list for result card
                         };
                         transaction.onerror = (event) => {
                             console.error("Transaction error saving results:", event.target.error);
                             alert('نتائج محفوظ کرنے میں خرابی: ٹرانزیکشن ناکام۔');
                         };
                     }
                 }
                 // Fallback alert
                 setTimeout(() => {
                     if (completed === resultsData.length) alert('نتائج کامیابی سے محفوظ ہو گئے۔ (Fallback)');
                 }, 500);


             } catch (error) {
                 console.error("Error saving results:", error);
                 alert('نتائج کو محفوظ کرنے میں خرابی۔');
             }
         }

         async function loadStudentsForResultCard() {
            await loadStudentsIntoSelect('resultCardStudent');
         }

         async function loadExamsForResultCard() {
             resultCardExamSelect.innerHTML = '<option value="">-- امتحان منتخب کریں --</option>';
             try {
                 const results = await getAll(STORE_RESULTS);
                 const examNames = [...new Set(results.map(r => r.examName))]; // Unique exam names
                 examNames.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    resultCardExamSelect.appendChild(option);
                 });
             } catch (error) {
                 console.error("Error loading exams for result card:", error);
             }
         }


         async function printResultCard() {
             const studentId = parseInt(resultCardStudentSelect.value);
             const examName = resultCardExamSelect.value;

             if (!studentId || !examName) {
                 alert('براہ کرم طالب علم اور امتحان منتخب کریں۔');
                 return;
             }

             const printContainer = document.getElementById('resultCardPrintContainer');
             const printTableBody = document.getElementById('resultCardPrintTable').querySelector('tbody');
             printTableBody.innerHTML = '<tr><td colspan="4">لوڈ ہو رہا ہے...</td></tr>';

            try {
                const student = await getById(STORE_STUDENTS, studentId);
                if (!student) throw new Error("Student not found");
                 const cls = await getById(STORE_CLASSES, student.classId);

                 document.getElementById('printResultExamName').textContent = examName;
                 document.getElementById('printResultStudentName').textContent = student.name;
                 document.getElementById('printResultClassName').textContent = cls ? cls.name : 'N/A';

                 // Fetch results for this student and exam
                 const allResults = await getAll(STORE_RESULTS, 'studentId', studentId);
                 const studentExamResults = allResults.filter(r => r.examName === examName);

                 if (studentExamResults.length === 0) {
                     alert('اس طالب علم کے لیے منتخب امتحان کا کوئی نتیجہ نہیں ملا۔');
                     printTableBody.innerHTML = '<tr><td colspan="4">کوئی نتیجہ نہیں۔</td></tr>';
                      document.getElementById('printResultTotalObtained').textContent = '0';
                      document.getElementById('printResultTotalMarks').textContent = '0';
                      document.getElementById('printResultOverallPercentage').textContent = '0.00';
                      document.getElementById('printResultStatus').textContent = '-';
                     return;
                 }

                 printTableBody.innerHTML = '';
                 let totalObtained = 0;
                 let totalMarks = 0;

                 studentExamResults.forEach(res => {
                     const percentage = (res.obtainedMarks / res.totalMarks) * 100;
                     // Simple grading logic (example)
                     let grade = 'F';
                     if (percentage >= 90) grade = 'A+';
                     else if (percentage >= 80) grade = 'A';
                     else if (percentage >= 70) grade = 'B';
                     else if (percentage >= 60) grade = 'C';
                     else if (percentage >= 50) grade = 'D';
                     else if (percentage >= 40) grade = 'E';

                     const row = printTableBody.insertRow();
                     row.innerHTML = `
                         <td>${res.subject}</td>
                         <td>${res.totalMarks}</td>
                         <td>${res.obtainedMarks}</td>
                         <td>${percentage.toFixed(2)}% (${grade})</td>
                     `;
                     totalObtained += res.obtainedMarks;
                     totalMarks += res.totalMarks;
                 });

                 const overallPercentage = totalMarks > 0 ? (totalObtained / totalMarks) * 100 : 0;
                 const status = overallPercentage >= 40 ? 'پاس' : 'فیل'; // Example pass mark

                 document.getElementById('printResultTotalObtained').textContent = totalObtained;
                 document.getElementById('printResultTotalMarks').textContent = totalMarks;
                 document.getElementById('printResultOverallPercentage').textContent = overallPercentage.toFixed(2);
                 document.getElementById('printResultStatus').textContent = status;

                  const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                  const schoolName = schoolNameSetting ? schoolNameSetting.value : 'مدرسہ کا نام';
                  const printHeader = document.createElement('h3');
                  printHeader.textContent = `${schoolName} - رزلٹ کارڈ`;
                  const existingHeader = printContainer.querySelector('h3');
                  if (existingHeader) existingHeader.remove();
                  printContainer.prepend(printHeader);


                 printContainer.style.display = 'block';
                 printContainer.classList.add('printable');
                 window.print();
                 printContainer.classList.remove('printable');
                 printContainer.style.display = 'none';

             } catch (error) {
                 console.error("Error preparing result card for print:", error);
                 alert('رزلٹ کارڈ تیار کرنے میں خرابی: ' + error.message);
                 printTableBody.innerHTML = '<tr><td colspan="4">خرابی۔</td></tr>';
             }
         }


        // Timetable / Duty Roaster
        const timetableClassSelect = document.getElementById('timetableClass');
        const classTimetableTableBody = document.getElementById('classTimetableTable').querySelector('tbody');
        const dutyRoasterTeacherSelect = document.getElementById('dutyRoasterTeacher');
        const teacherRoasterTableBody = document.getElementById('teacherRoasterTable').querySelector('tbody');
        const daysOfWeek = ["پیر", "منگل", "بدھ", "جمعرات", "جمعہ", "ہفتہ"]; // Adjust as needed
        const periods = 4; // Example number of periods

        async function loadClassesForTimetable() {
            await loadClassesIntoSelect('timetableClass');
        }
        async function loadTeachersForRoaster() {
            await loadTeachersIntoSelect('dutyRoasterTeacher');
        }

        async function loadTimetable() {
            const classId = parseInt(timetableClassSelect.value);
            classTimetableTableBody.innerHTML = '';

            if (!classId) {
                 classTimetableTableBody.innerHTML = `<tr><td colspan="${periods + 1}">براہ کرم کلاس منتخب کریں۔</td></tr>`;
                 return;
             }

             classTimetableTableBody.innerHTML = `<tr><td colspan="${periods + 1}">لوڈ ہو رہا ہے...</td></tr>`;

             try {
                 const cls = await getById(STORE_CLASSES, classId);
                 const teachers = await getAll(STORE_TEACHERS); // Needed for dropdowns
                 const timetableData = await getAll(STORE_TIMETABLE, 'classId', classId);
                 const timetableMap = timetableData.reduce((map, entry) => {
                     if (!map[entry.day]) map[entry.day] = {};
                     map[entry.day][entry.period] = { subject: entry.subject, teacherId: entry.teacherId };
                     return map;
                 }, {});


                 if (!cls) throw new Error("Class not found");

                 classTimetableTableBody.innerHTML = ''; // Clear loading message

                 daysOfWeek.forEach(day => {
                     const row = classTimetableTableBody.insertRow();
                     row.insertCell().textContent = day; // Day name

                     for (let period = 1; period <= periods; period++) {
                         const cell = row.insertCell();
                         const entry = timetableMap[day]?.[period] || { subject: '', teacherId: '' };

                         // Create Subject Dropdown
                         const subjectSelect = document.createElement('select');
                         subjectSelect.classList.add('timetable-subject');
                          subjectSelect.dataset.day = day;
                          subjectSelect.dataset.period = period;
                         subjectSelect.innerHTML = '<option value="">-- مضمون --</option>';
                         (cls.subjects || []).forEach(sub => {
                             const option = document.createElement('option');
                             option.value = sub;
                             option.textContent = sub;
                             if (sub === entry.subject) option.selected = true;
                             subjectSelect.appendChild(option);
                         });
                         cell.appendChild(subjectSelect);

                         // Create Teacher Dropdown
                         const teacherSelect = document.createElement('select');
                         teacherSelect.classList.add('timetable-teacher');
                          teacherSelect.dataset.day = day;
                          teacherSelect.dataset.period = period;
                         teacherSelect.innerHTML = '<option value="">-- استاد --</option>';
                         teachers.forEach(teacher => {
                             const option = document.createElement('option');
                             option.value = teacher.id;
                             option.textContent = teacher.name;
                              if (teacher.id === entry.teacherId) option.selected = true;
                             teacherSelect.appendChild(option);
                         });
                          cell.appendChild(document.createElement('br')); // Line break for layout
                         cell.appendChild(teacherSelect);
                     }
                 });

             } catch (error) {
                console.error("Error loading timetable:", error);
                 classTimetableTableBody.innerHTML = `<tr><td colspan="${periods + 1}">ٹائم ٹیبل لوڈ کرنے میں خرابی۔</td></tr>`;
             }
        }

        async function saveTimetable() {
            const classId = parseInt(timetableClassSelect.value);
             if (!classId) {
                 alert('براہ کرم کلاس منتخب کریں۔');
                 return;
             }

             const timetableEntries = [];
             const cells = classTimetableTableBody.querySelectorAll('td:not(:first-child)'); // Get all period cells
             let hasData = false;

             daysOfWeek.forEach(day => {
                 for (let period = 1; period <= periods; period++) {
                     const subjectSelect = classTimetableTableBody.querySelector(`select.timetable-subject[data-day="${day}"][data-period="${period}"]`);
                     const teacherSelect = classTimetableTableBody.querySelector(`select.timetable-teacher[data-day="${day}"][data-period="${period}"]`);

                     if (subjectSelect && teacherSelect) {
                         const subject = subjectSelect.value;
                         const teacherId = teacherSelect.value ? parseInt(teacherSelect.value) : null;

                          // Only save if both subject and teacher are selected (or explicitly cleared)
                         if (subject || teacherId) {
                              hasData = true;
                             timetableEntries.push({
                                 classId: classId,
                                 day: day,
                                 period: period,
                                 subject: subject || null, // Store null if empty
                                 teacherId: teacherId // Store null if empty
                             });
                         }
                     }
                 }
             });

             if (!hasData) {
                 if (!confirm("کوئی مضمون یا استاد منتخب نہیں کیا گیا۔ کیا آپ اس کلاس کا ٹائم ٹیبل صاف کرنا چاہتے ہیں؟")) {
                     return;
                 }
                  // If confirmed, proceed with saving empty/null entries which effectively clears
             }


             try {
                 const store = await getObjectStore(STORE_TIMETABLE, 'readwrite');
                 const index = store.index('classId_day_period');
                 let completed = 0;
                 const transaction = store.transaction;

                  // First, clear existing entries for this class? Or upsert? Upsert is better.
                 timetableEntries.forEach(entry => {
                     const keyRange = IDBKeyRange.only([entry.classId, entry.day, entry.period]);
                     const request = index.get(keyRange);

                     request.onsuccess = () => {
                         const existingEntry = request.result;
                          if (existingEntry) {
                              // If subject and teacher are now null, delete? Or update with null? Update is safer.
                             if (entry.subject === null && entry.teacherId === null) {
                                 const deleteRequest = store.delete(existingEntry.id);
                                 deleteRequest.onsuccess = () => checkCompletion();
                                 deleteRequest.onerror = (e) => console.error("Error deleting timetable entry:", e.target.error);
                              } else {
                                 existingEntry.subject = entry.subject;
                                 existingEntry.teacherId = entry.teacherId;
                                 const updateRequest = store.put(existingEntry);
                                 updateRequest.onsuccess = () => checkCompletion();
                                 updateRequest.onerror = (e) => console.error("Error updating timetable entry:", e.target.error);
                             }
                         } else if (entry.subject || entry.teacherId) { // Only add if there's data
                             const addRequest = store.add(entry);
                             addRequest.onsuccess = () => checkCompletion();
                             addRequest.onerror = (e) => console.error("Error adding timetable entry:", e.target.error);
                         } else {
                             // If no existing entry and no new data, just increment completion count
                             checkCompletion();
                         }
                     };
                     request.onerror = (e) => console.error("Error querying existing timetable entry:", e.target.error);
                 });


                 function checkCompletion() {
                     completed++;
                     if (completed === timetableEntries.length) {
                         transaction.oncomplete = () => {
                             alert('ٹائم ٹیبل کامیابی سے محفوظ ہو گیا۔');
                             // If current teacher roaster is displayed, reload it
                             if (dutyRoasterTeacherSelect.value) loadTeacherRoaster();
                         };
                         transaction.onerror = (event) => {
                             console.error("Transaction error saving timetable:", event.target.error);
                             alert('ٹائم ٹیبل محفوظ کرنے میں خرابی: ٹرانزیکشن ناکام۔');
                         };
                     }
                 }
                 // Fallback
                 setTimeout(() => {
                     if (completed === timetableEntries.length) alert('ٹائم ٹیبل کامیابی سے محفوظ ہو گیا۔ (Fallback)');
                 }, 500);


             } catch (error) {
                 console.error("Error saving timetable:", error);
                 alert('ٹائم ٹیبل کو محفوظ کرنے میں خرابی۔');
             }
        }

        async function loadTeacherRoaster() {
            const teacherId = parseInt(dutyRoasterTeacherSelect.value);
            teacherRoasterTableBody.innerHTML = '';

            if (!teacherId) {
                teacherRoasterTableBody.innerHTML = `<tr><td colspan="${periods + 1}">براہ کرم استاد منتخب کریں۔</td></tr>`;
                 return;
             }

             teacherRoasterTableBody.innerHTML = `<tr><td colspan="${periods + 1}">لوڈ ہو رہا ہے...</td></tr>`;

            try {
                 const timetableData = await getAll(STORE_TIMETABLE, 'teacherId', teacherId);
                 const classes = await getAll(STORE_CLASSES); // Needed for class names
                 const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

                 const roasterMap = timetableData.reduce((map, entry) => {
                     if (!map[entry.day]) map[entry.day] = {};
                     map[entry.day][entry.period] = { subject: entry.subject, classId: entry.classId };
                     return map;
                 }, {});

                 teacherRoasterTableBody.innerHTML = ''; // Clear loading message

                 daysOfWeek.forEach(day => {
                     const row = teacherRoasterTableBody.insertRow();
                     row.insertCell().textContent = day; // Day name

                     for (let period = 1; period <= periods; period++) {
                         const cell = row.insertCell();
                         const entry = roasterMap[day]?.[period];
                         if (entry) {
                            cell.textContent = `${classMap[entry.classId] || 'N/A'} - ${entry.subject || 'N/A'}`;
                         } else {
                            cell.textContent = '-'; // Free period
                         }
                     }
                 });

             } catch (error) {
                console.error("Error loading teacher roaster:", error);
                 teacherRoasterTableBody.innerHTML = `<tr><td colspan="${periods + 1}">ڈیوٹی روسٹر لوڈ کرنے میں خرابی۔</td></tr>`;
             }
        }


        // Expense Management
        const expenseForm = document.getElementById('expenseForm');
        const expensesTableBody = document.getElementById('expensesTable').querySelector('tbody');
        const expenseFilterDateInput = document.getElementById('expenseFilterDate');

         expenseForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             const expenseId = document.getElementById('expenseId').value;
            const expense = {
                date: document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0],
                type: document.getElementById('expenseType').value.trim(),
                amount: parseFloat(document.getElementById('expenseAmount').value),
                paidTo: document.getElementById('expensePaidTo').value.trim(),
                description: document.getElementById('expenseDescription').value.trim()
             };

             if (!expense.type || isNaN(expense.amount) || expense.amount <= 0) {
                 alert('براہ کرم تاریخ، قسم اور رقم درست درج کریں۔');
                 return;
             }

             try {
                 if (expenseId) {
                     expense.id = parseInt(expenseId);
                     await updateData(STORE_EXPENSES, expense);
                     alert('خرچہ اپ ڈیٹ ہو گیا۔');
                 } else {
                     await addData(STORE_EXPENSES, expense);
                     alert('نیا خرچہ شامل ہو گیا۔');
                 }
                 resetExpenseForm();
                 loadExpenses();
                 loadDashboardStats(); // Update dashboard
            } catch (error) {
                 console.error("Error saving expense:", error);
                 alert('خرچہ محفوظ کرنے میں خرابی۔');
            }
        });

        function resetExpenseForm() {
            expenseForm.reset();
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0]; // Default to today
        }

        async function loadExpenses() {
             expensesTableBody.innerHTML = '<tr><td colspan="6">لوڈ ہو رہا ہے...</td></tr>';
             const filterDate = expenseFilterDateInput.value;

             try {
                 let expenses;
                 if (filterDate) {
                     expenses = await getAll(STORE_EXPENSES, 'date', filterDate);
                 } else {
                     expenses = await getAll(STORE_EXPENSES);
                 }

                 expensesTableBody.innerHTML = '';
                 expenses
                     .sort((a, b) => new Date(b.date) - new Date(a.date)) // Sort by date descending
                     .forEach(expense => {
                        const row = expensesTableBody.insertRow();
                        row.innerHTML = `
                            <td>${expense.date}</td>
                            <td>${expense.type}</td>
                            <td>${expense.description || '-'}</td>
                            <td>${expense.paidTo || '-'}</td>
                            <td>${expense.amount.toLocaleString()}</td>
                            <td>
                                <button class="edit" onclick="editExpense(${expense.id})">ترمیم</button>
                                <button class="delete" onclick="deleteExpense(${expense.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                  if (expenses.length === 0) {
                     expensesTableBody.innerHTML = `<tr><td colspan="6">${filterDate ? 'اس تاریخ کو کوئی خرچہ نہیں ملا۔' : 'کوئی خرچہ نہیں ملا۔'}</td></tr>`;
                  }
             } catch (error) {
                console.error("Error loading expenses:", error);
                 expensesTableBody.innerHTML = '<tr><td colspan="6">اخراجات لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }

        async function editExpense(id) {
            try {
                const expense = await getById(STORE_EXPENSES, id);
                if (expense) {
                    document.getElementById('expenseId').value = expense.id;
                    document.getElementById('expenseDate').value = expense.date;
                    document.getElementById('expenseType').value = expense.type;
                    document.getElementById('expenseAmount').value = expense.amount;
                    document.getElementById('expensePaidTo').value = expense.paidTo || '';
                    document.getElementById('expenseDescription').value = expense.description || '';
                     showModule('expenses');
                     window.scrollTo(0, 0);
                }
             } catch (error) {
                console.error("Error fetching expense for edit:", error);
                alert('ترمیم کے لیے خرچہ لانے میں خرابی۔');
            }
        }

        async function deleteExpense(id) {
            if (confirm('کیا آپ واقعی اس خرچے کو حذف کرنا چاہتے ہیں؟')) {
                 try {
                    await deleteData(STORE_EXPENSES, id);
                    alert('خرچہ حذف ہو گیا۔');
                    loadExpenses();
                    loadDashboardStats(); // Update dashboard
                 } catch (error) {
                    console.error("Error deleting expense:", error);
                    alert('خرچہ حذف کرنے میں خرابی۔');
                }
            }
        }


        // Reports
         const reportContent = document.getElementById('reportContent');
         const reportTypeSelect = document.getElementById('reportType');
         const reportStartDateInput = document.getElementById('reportStartDate');
         const reportEndDateInput = document.getElementById('reportEndDate');
         const reportClassFilterSelect = document.getElementById('reportClassFilter');


         async function loadClassesForReportFilter() {
             await loadClassesIntoSelect('reportClassFilter');
         }

        async function generateReport() {
             const reportType = reportTypeSelect.value;
             const startDate = reportStartDateInput.value;
             const endDate = reportEndDateInput.value;
             const classFilterId = reportClassFilterSelect.value ? parseInt(reportClassFilterSelect.value) : null;

             reportContent.innerHTML = '<p>رپورٹ تیار کی جا رہی ہے...</p>';

             if (!reportType) {
                 reportContent.innerHTML = '<p>براہ کرم رپورٹ کی قسم منتخب کریں۔</p>';
                 return;
             }

            try {
                let html = `<h4>رپورٹ: ${reportTypeSelect.options[reportTypeSelect.selectedIndex].text}</h4>`;
                 if (startDate) html += `<p>شروع تاریخ: ${startDate}</p>`;
                 if (endDate) html += `<p>اختتامی تاریخ: ${endDate}</p>`;
                 if (classFilterId) {
                     const cls = await getById(STORE_CLASSES, classFilterId);
                     html += `<p>کلاس: ${cls ? cls.name : 'N/A'}</p>`;
                 }
                 html += '<hr>';

                 switch (reportType) {
                     case 'fee_collection':
                         html += await generateFeeCollectionReport(startDate, endDate, classFilterId);
                         break;
                     case 'outstanding_fees':
                         html += await generateOutstandingFeesReport(classFilterId);
                         break;
                     case 'attendance_summary':
                          html += await generateAttendanceReport(startDate, endDate, classFilterId);
                         break;
                     case 'expense_report':
                          html += await generateExpenseReport(startDate, endDate);
                         break;
                      case 'student_list':
                         html += await generateStudentListReport(classFilterId);
                         break;
                     default:
                         html += '<p>منتخب کردہ رپورٹ کی قسم ابھی دستیاب نہیں۔</p>';
                 }
                 reportContent.innerHTML = html;
            } catch (error) {
                 console.error("Error generating report:", error);
                 reportContent.innerHTML = `<p>رپورٹ بنانے میں خرابی: ${error.message}</p>`;
            }
        }

        function printReport() {
            const reportOutput = document.getElementById('reportOutput');
            const schoolNameSetting = getById(STORE_SETTINGS, 'schoolName').then(setting => {
                 const schoolName = setting ? setting.value : 'مدرسہ کا نام';
                 const reportHeader = document.createElement('h3');
                 reportHeader.textContent = `${schoolName} - رپورٹ`;
                  const existingHeader = reportOutput.querySelector('h3');
                  if (existingHeader) existingHeader.remove();
                 reportOutput.prepend(reportHeader);

                 reportOutput.classList.add('printable');
                 window.print();
                 reportOutput.classList.remove('printable');
             }).catch(err => { // Fallback if settings load fails
                 console.error("Error getting school name for printing report:", err);
                 reportOutput.classList.add('printable');
                 window.print();
                 reportOutput.classList.remove('printable');
             });
        }

        async function generateFeeCollectionReport(startDate, endDate, classFilterId) {
             let fees = await getAll(STORE_FEES);
             let students = await getAll(STORE_STUDENTS);
             let classes = await getAll(STORE_CLASSES);
             const studentMap = students.reduce((map, std) => { map[std.id] = std; return map; }, {});
             const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});


             let filteredFees = fees.filter(fee => {
                 const student = studentMap[fee.studentId];
                 const dateMatch = (!startDate || fee.date >= startDate) && (!endDate || fee.date <= endDate);
                 const classMatch = !classFilterId || (student && student.classId === classFilterId);
                 return dateMatch && classMatch;
             });

             if (filteredFees.length === 0) return '<p>اس معیار پر کوئی فیس وصولی نہیں ملی۔</p>';

             let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                 <thead><tr><th>تاریخ</th><th>طالب علم</th><th>کلاس</th><th>فیس قسم</th><th>رقم</th><th>رعایت</th><th>طریقہ</th></tr></thead>
                                 <tbody>`;
             let totalCollected = 0;
             let totalDiscount = 0;

             filteredFees.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(fee => {
                 const student = studentMap[fee.studentId];
                 tableHTML += `<tr>
                                 <td>${fee.date}</td>
                                 <td>${student ? student.name : 'N/A'}</td>
                                 <td>${student ? classMap[student.classId] : 'N/A'}</td>
                                 <td>${fee.feeType}</td>
                                 <td>${fee.paidAmount.toLocaleString()}</td>
                                 <td>${fee.discount.toLocaleString()}</td>
                                 <td>${fee.method}</td>
                              </tr>`;
                 totalCollected += fee.paidAmount;
                 totalDiscount += fee.discount;
             });

             tableHTML += `</tbody><tfoot>
                            <tr><td colspan="4"><b>کل</b></td><td><b>${totalCollected.toLocaleString()}</b></td><td><b>${totalDiscount.toLocaleString()}</b></td><td></td></tr>
                          </tfoot></table>`;
             return tableHTML;
         }


        async function generateOutstandingFeesReport(classFilterId) {
             let students = await getAll(STORE_STUDENTS);
             let feeStructures = await getAll(STORE_FEE_STRUCTURES);
             let feesPaid = await getAll(STORE_FEES);
             let classes = await getAll(STORE_CLASSES);
             const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

            if (classFilterId) {
                students = students.filter(std => std.classId === classFilterId);
             }

             if (students.length === 0) return '<p>اس معیار پر کوئی طالب علم نہیں ملا۔</p>';

             let reportData = [];
             let grandTotalDue = 0;

             for (const student of students) {
                 const studentClassId = student.classId;
                 const studentFeeStructures = feeStructures.filter(fs => fs.classId === studentClassId);
                 const studentFeesPaid = feesPaid.filter(fp => fp.studentId === student.id);

                 let totalDueForStudent = 0;
                 let details = [];

                 studentFeeStructures.forEach(structure => {
                     const paidForType = studentFeesPaid
                         .filter(fp => fp.feeType === structure.feeType)
                         .reduce((sum, fp) => sum + fp.paidAmount + fp.discount, 0);
                     const dueAmount = structure.amount - paidForType;
                     if (dueAmount > 0) {
                         totalDueForStudent += dueAmount;
                         details.push(`${structure.feeType}: ${dueAmount.toLocaleString()}`);
                     }
                 });

                 if (totalDueForStudent > 0) {
                     reportData.push({
                         studentName: student.name,
                         className: classMap[studentClassId] || 'N/A',
                         totalDue: totalDueForStudent,
                         details: details.join(', ')
                     });
                     grandTotalDue += totalDueForStudent;
                 }
             }

             if (reportData.length === 0) return '<p>اس معیار پر کوئی واجب الادا فیس نہیں ملی۔</p>';

             let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                 <thead><tr><th>طالب علم</th><th>کلاس</th><th>تفصیلات واجب الادا</th><th>کل واجب الادا</th></tr></thead>
                                 <tbody>`;

             reportData.sort((a,b) => a.className.localeCompare(b.className) || a.studentName.localeCompare(b.studentName)).forEach(data => {
                 tableHTML += `<tr>
                                 <td>${data.studentName}</td>
                                 <td>${data.className}</td>
                                 <td>${data.details}</td>
                                 <td>${data.totalDue.toLocaleString()}</td>
                              </tr>`;
             });

             tableHTML += `</tbody><tfoot>
                             <tr><td colspan="3"><b>کل مجموعی واجب الادا</b></td><td><b>${grandTotalDue.toLocaleString()}</b></td></tr>
                          </tfoot></table>`;
             return tableHTML;
         }

          async function generateAttendanceReport(startDate, endDate, classFilterId) {
              if (!startDate || !endDate) return '<p>براہ کرم حاضری رپورٹ کے لیے شروع اور اختتامی تاریخ منتخب کریں۔</p>';

              let attendance = await getAll(STORE_ATTENDANCE);
              let students = await getAll(STORE_STUDENTS);
              let classes = await getAll(STORE_CLASSES);
              const studentMap = students.reduce((map, std) => { map[std.id] = std; return map; }, {});
              const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

              let filteredAttendance = attendance.filter(att => {
                  const student = studentMap[att.studentId];
                  const dateMatch = att.date >= startDate && att.date <= endDate;
                  const classMatch = !classFilterId || (student && student.classId === classFilterId && att.classId === classFilterId); // Match both student's class and attendance record's class
                  return dateMatch && classMatch;
              });

               if (filteredAttendance.length === 0) return '<p>اس معیار پر کوئی حاضری ریکارڈ نہیں ملا۔</p>';

              // Aggregate data: { studentId: { name: '...', className: '...', present: 0, absent: 0, total: 0 } }
              const summary = filteredAttendance.reduce((acc, att) => {
                  const studentId = att.studentId;
                  if (!acc[studentId]) {
                      const student = studentMap[studentId];
                      if (student) { // Only include if student exists
                          acc[studentId] = {
                              name: student.name,
                              className: classMap[student.classId] || 'N/A',
                              present: 0,
                              absent: 0,
                              total: 0
                          };
                      } else {
                          return acc; // Skip if student not found
                      }
                  }
                  if (acc[studentId]) { // Check again if student was found
                       acc[studentId].total++;
                       if (att.status === 'Present') {
                           acc[studentId].present++;
                       } else {
                           acc[studentId].absent++;
                       }
                  }
                  return acc;
              }, {});


              if (Object.keys(summary).length === 0) return '<p>خلاصہ کرنے کے لیے کوئی حاضری ڈیٹا نہیں۔</p>';


              let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                  <thead><tr><th>طالب علم</th><th>کلاس</th><th>کل دن</th><th>حاضر</th><th>غیر حاضر</th><th>فیصد حاضری</th></tr></thead>
                                  <tbody>`;

              Object.values(summary)
                  .sort((a, b) => a.className.localeCompare(b.className) || a.name.localeCompare(b.name))
                  .forEach(data => {
                      const percentage = data.total > 0 ? ((data.present / data.total) * 100).toFixed(2) : '0.00';
                      tableHTML += `<tr>
                                      <td>${data.name}</td>
                                      <td>${data.className}</td>
                                      <td>${data.total}</td>
                                      <td>${data.present}</td>
                                      <td>${data.absent}</td>
                                      <td>${percentage}%</td>
                                   </tr>`;
                  });

              tableHTML += `</tbody></table>`;
              return tableHTML;
          }

          async function generateExpenseReport(startDate, endDate) {
              let expenses = await getAll(STORE_EXPENSES);

              let filteredExpenses = expenses.filter(exp => {
                  const dateMatch = (!startDate || exp.date >= startDate) && (!endDate || exp.date <= endDate);
                  return dateMatch;
              });

              if (filteredExpenses.length === 0) return '<p>اس معیار پر کوئی اخراجات نہیں ملے۔</p>';

               let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                  <thead><tr><th>تاریخ</th><th>قسم</th><th>تفصیل</th><th>ادا کیا گیا</th><th>رقم</th></tr></thead>
                                  <tbody>`;
               let totalExpenses = 0;

              filteredExpenses.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(exp => {
                  tableHTML += `<tr>
                                  <td>${exp.date}</td>
                                  <td>${exp.type}</td>
                                  <td>${exp.description || '-'}</td>
                                  <td>${exp.paidTo || '-'}</td>
                                  <td>${exp.amount.toLocaleString()}</td>
                               </tr>`;
                  totalExpenses += exp.amount;
              });

              tableHTML += `</tbody><tfoot>
                              <tr><td colspan="4"><b>کل اخراجات</b></td><td><b>${totalExpenses.toLocaleString()}</b></td></tr>
                           </tfoot></table>`;
              return tableHTML;
          }


        async function generateStudentListReport(classFilterId) {
             let students = await getAll(STORE_STUDENTS);
             let classes = await getAll(STORE_CLASSES);
             const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});

             if (classFilterId) {
                students = students.filter(std => std.classId === classFilterId);
             }

             if (students.length === 0) return '<p>اس معیار پر کوئی طالب علم نہیں ملا۔</p>';

             let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                 <thead><tr><th>داخلہ نمبر</th><th>نام</th><th>والد کا نام</th><th>کلاس</th><th>داخلہ تاریخ</th><th>رابطہ</th></tr></thead>
                                 <tbody>`;

             students.sort((a,b) => (classMap[a.classId] || '').localeCompare(classMap[b.classId] || '') || a.name.localeCompare(b.name)).forEach(student => {
                 tableHTML += `<tr>
                                 <td>${student.admissionNo}</td>
                                 <td>${student.name}</td>
                                 <td>${student.fatherName}</td>
                                 <td>${classMap[student.classId] || 'N/A'}</td>
                                 <td>${student.admissionDate}</td>
                                  <td>${student.contact || '-'}</td>
                              </tr>`;
             });

             tableHTML += `</tbody></table>`;
             return tableHTML;
         }


        // Settings & Data Management
         const importFileInput = document.getElementById('importFile');

         async function backupData() {
             if (!confirm('تمام ڈیٹا کو JSON فائل کے طور پر ایکسپورٹ کیا جائے گا۔ جاری رکھیں؟')) return;

             try {
                 const backup = {};
                 const storeNames = db.objectStoreNames;
                 for (let i = 0; i < storeNames.length; i++) {
                     const storeName = storeNames[i];
                      // Skip settings store? Maybe not, it might contain school name etc.
                     // if (storeName === STORE_SETTINGS) continue;
                     backup[storeName] = await getAll(storeName);
                 }

                 const jsonString = JSON.stringify(backup, null, 2);
                 const blob = new Blob([jsonString], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `school_backup_${new Date().toISOString().split('T')[0]}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
                 alert('ڈیٹا بیک اپ کامیابی سے ڈاؤن لوڈ ہو گیا۔');
             } catch (error) {
                 console.error("Error backing up data:", error);
                 alert('ڈیٹا بیک اپ کرنے میں خرابی۔');
             }
         }

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('خبردار! امپورٹ کرنے سے موجودہ تمام ڈیٹا مٹ جائے گا اور اس فائل کے ڈیٹا سے تبدیل ہو جائے گا۔ کیا آپ واقعی جاری رکھنا چاہتے ہیں؟')) {
                importFileInput.value = ''; // Reset file input
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                 try {
                     const importedData = JSON.parse(e.target.result);
                     const storeNames = db.objectStoreNames;

                     // Clear existing data first
                     const clearPromises = [];
                      for (let i = 0; i < storeNames.length; i++) {
                         clearPromises.push(clearStore(storeNames[i]));
                     }
                     await Promise.all(clearPromises);
                     console.log("Existing data cleared.");

                     // Import new data
                     const importPromises = [];
                      for (const storeName in importedData) {
                         if (db.objectStoreNames.contains(storeName)) {
                             const dataToImport = importedData[storeName];
                             if (Array.isArray(dataToImport)) {
                                 const store = await getObjectStore(storeName, 'readwrite');
                                 dataToImport.forEach(item => {
                                     // Remove potential old 'id' if store uses autoIncrement to avoid conflicts?
                                     // Or trust the backup IDs? Let's trust backup IDs for now.
                                     // If autoIncrement was used, importing specific IDs might fail if they conflict.
                                     // A safer import would iterate and add without specifying ID, letting autoIncrement work.
                                     // But for restore, keeping original IDs is usually desired.
                                     importPromises.push(new Promise((resolve, reject) => {
                                          // Use put to potentially overwrite if needed, although store is clear.
                                         const req = store.put(item);
                                         req.onsuccess = resolve;
                                         req.onerror = reject;
                                     }));
                                 });
                             }
                         } else {
                             console.warn(`Store "${storeName}" from backup file not found in current database schema. Skipping.`);
                         }
                     }

                     await Promise.all(importPromises);
                     alert('ڈیٹا کامیابی سے امپورٹ ہو گیا۔ براہ کرم صفحہ ریفریش کریں۔');
                     // Reload necessary data or prompt refresh
                     showModule('dashboard'); // Go to dashboard
                      loadDashboardStats(); // Reload stats
                      location.reload(); // Force reload to ensure all states are fresh

                 } catch (error) {
                     console.error("Error importing data:", error);
                     alert('ڈیٹا امپورٹ کرنے میں خرابی۔ یقینی بنائیں کہ فائل درست JSON فارمیٹ میں ہے۔\n' + error.message);
                 } finally {
                     importFileInput.value = ''; // Reset file input
                 }
             };
             reader.onerror = () => {
                 alert('فائل پڑھنے میں خرابی۔');
                 importFileInput.value = '';
             };
             reader.readAsText(file);
        });

         async function savePrintSettings() {
             const schoolName = document.getElementById('schoolNamePrint').value.trim();
             if (!schoolName) {
                 alert('براہ کرم مدرسہ کا نام درج کریں۔');
                 return;
             }
             try {
                 await updateData(STORE_SETTINGS, { key: 'schoolName', value: schoolName });
                 alert('پرنٹ سیٹنگز محفوظ ہو گئیں۔');
             } catch (error) {
                 console.error("Error saving print settings:", error);
                 alert('سیٹنگز محفوظ کرنے میں خرابی۔');
             }
         }

         async function loadPrintSettings() {
             try {
                 const setting = await getById(STORE_SETTINGS, 'schoolName');
                 if (setting) {
                     document.getElementById('schoolNamePrint').value = setting.value;
                 }
             } catch (error) {
                 console.error("Error loading print settings:", error);
             }
         }

        // Initial load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDatabase();
                showModule('dashboard'); // Show dashboard first
            } catch (error) {
                 console.error("Initialization error:", error);
                alert("ڈیٹا بیس لوڈ کرنے میں ناکام: " + error);
            }
        });


// Function to apply Urdu font to specific elements
function applyUrduFont(elements) {
  elements.forEach(element => {
    element.style.fontFamily = 'Jameel Noori Nastaleeq, sans-serif';
  });
}

// Function to change labels from "School" to "Madrasa"
function updateLabels() {
  const labels = document.querySelectorAll('label, h1, h2, h3, h4, h5, h6, th');
  labels.forEach(label => {
    if (label.textContent.toLowerCase().includes('school')) {
      label.textContent = label.textContent.replace(/school/gi, 'Madrasa');
    }
  });
}

// Function to add Madrasa-specific fields (example: add a field for "Memorization Status")
function addMadrasaFields() {
  const studentForm = document.getElementById('studentForm'); // Assuming you have a student form with this ID
  if (studentForm) {
    const memorizationStatusLabel = document.createElement('label');
    memorizationStatusLabel.textContent = 'حفظ کی حالت:'; // Memorization Status in Urdu
    memorizationStatusLabel.style.fontFamily = 'Jameel Noori Nastaleeq, sans-serif';

    const memorizationStatusInput = document.createElement('select');
    memorizationStatusInput.innerHTML = `
      <option value="hafiz">حافظ</option>
      <option value="non-hafiz">غیر حافظ</option>
      <option value="in-progress">زیرِ تکمیل</option>
    `;
    memorizationStatusInput.style.fontFamily = 'Jameel Noori Nastaleeq, sans-serif';

    studentForm.appendChild(memorizationStatusLabel);
    studentForm.appendChild(memorizationStatusInput);
  }
}

// Call the functions
document.addEventListener('DOMContentLoaded', () => {
  // Apply Urdu font to all text elements
  const allTextElements = document.querySelectorAll('body *');
  applyUrduFont(allTextElements);

  // Update labels from "School" to "Madrasa"
  updateLabels();

  // Add Madrasa-specific fields
  addMadrasaFields();
});





document.addEventListener('DOMContentLoaded', async function() {
    // Load required libraries
    try {
        // Load jsPDF, autoTable and html2canvas libraries
        const scripts = [
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
        ];

        for (const src of scripts) {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            document.head.appendChild(script);
            await new Promise((resolve, reject) => {
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
            });
        }

        console.log('All libraries loaded successfully');
    } catch (error) {
        console.error('Error loading libraries:', error);
        return;
    }

    // Function to check if table or its parent (e.g., popup) is visible
    function isTableVisible(table) {
        const rect = table.getBoundingClientRect();
        let parent = table;
        while (parent && parent !== document.body) {
            const style = window.getComputedStyle(parent);
            if (style.display === 'none' || style.visibility === 'hidden') {
                return false;
            }
            parent = parent.parentElement;
        }
        return (
            table.offsetParent !== null &&
            rect.top < window.innerHeight &&
            rect.bottom > 0 &&
            rect.left < window.innerWidth &&
            rect.right > 0
        );
    }

    // Function to get parent z-index for popups
    function getParentZIndex(table) {
        let parent = table;
        while (parent && parent !== document.body) {
            const zIndex = window.getComputedStyle(parent).zIndex;
            if (zIndex && zIndex !== 'auto') {
                return parseInt(zIndex) + 1;
            }
            parent = parent.parentElement;
        }
        return 10;
    }

    // Function to add export icon to tables
    function addExportIconToTables() {
        const tables = document.querySelectorAll('table');
        tables.forEach(table => {
            if (!table.dataset.pdfIconAdded) {
                // Create icon container
                const iconContainer = document.createElement('div');
                iconContainer.className = 'pdf-export-container';
                iconContainer.style.position = 'absolute';
                iconContainer.style.pointerEvents = 'none';

                // Create icon
                const icon = document.createElement('span');
                icon.className = 'pdf-export-icon';
                icon.style.display = 'inline-block';
                icon.style.cursor = 'pointer';
                icon.style.pointerEvents = 'auto';
                icon.style.fontSize = '14px';
                icon.style.background = '#ffffff';
                icon.style.border = '1px solid #ccc';
                icon.style.borderRadius = '50%';
                icon.style.padding = '4px';
                icon.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                icon.style.transition = 'transform 0.2s';
                icon.innerHTML = '📄';
                icon.title = 'Export to PDF';

                // Hover effect
                icon.addEventListener('mouseenter', () => {
                    icon.style.transform = 'scale(1.2)';
                });
                icon.addEventListener('mouseleave', () => {
                    icon.style.transform = 'scale(1)';
                });

                // Position icon and set z-index
                const updateIconPosition = () => {
                    if (isTableVisible(table)) {
                        const tablePos = table.getBoundingClientRect();
                        iconContainer.style.left = `${tablePos.left + window.scrollX - 20}px`;
                        iconContainer.style.top = `${tablePos.top + window.scrollY - 20}px`;
                        iconContainer.style.zIndex = getParentZIndex(table);
                        iconContainer.style.display = 'block';
                    } else {
                        iconContainer.style.display = 'none';
                    }
                };

                // Add click event for PDF export
                icon.addEventListener('click', async () => {
                    try {
                        if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
                            alert('Required libraries not loaded. Please try again.');
                            return;
                        }

                        const { jsPDF } = window.jspdf;
                        
                        // Create loading indicator
                        const loadingEl = document.createElement('div');
                        loadingEl.style.position = 'fixed';
                        loadingEl.style.top = '50%';
                        loadingEl.style.left = '50%';
                        loadingEl.style.transform = 'translate(-50%, -50%)';
                        loadingEl.style.padding = '15px 20px';
                        loadingEl.style.background = 'rgba(0,0,0,0.7)';
                        loadingEl.style.color = 'white';
                        loadingEl.style.borderRadius = '5px';
                        loadingEl.style.zIndex = '9999';
                        loadingEl.textContent = 'Generating PDF...';
                        document.body.appendChild(loadingEl);

                        // Create a clone of the table to avoid modifying the original
                        const tableClone = table.cloneNode(true);
                        
                        // Apply styles for better rendering
                        tableClone.style.width = table.offsetWidth + 'px';
                        tableClone.style.fontFamily = 'Arial, sans-serif';
                        tableClone.style.borderCollapse = 'collapse';
                        tableClone.style.direction = 'rtl'; // For RTL support
                        
                        // Style all cells
                        tableClone.querySelectorAll('th, td').forEach(cell => {
                            cell.style.border = '1px solid #ddd';
                            cell.style.padding = '8px';
                            cell.style.textAlign = 'right'; // For RTL languages
                        });
                        
                        // Style header cells
                        tableClone.querySelectorAll('th').forEach(th => {
                            th.style.backgroundColor = '#f2f2f2';
                            th.style.fontWeight = 'bold';
                        });

                        // Create container for the cloned table
                        const container = document.createElement('div');
                        container.style.position = 'absolute';
                        container.style.left = '-9999px';
                        container.style.top = '-9999px';
                        container.style.direction = 'rtl'; // Set RTL direction
                        container.appendChild(tableClone);
                        document.body.appendChild(container);

                        // Get title from caption or create default
                        let title = '';
                        const caption = table.querySelector('caption');
                        if (caption) {
                            title = caption.textContent.trim();
                        } else {
                            title = 'Table Export';
                        }

                        // Add title to container
                        const titleEl = document.createElement('h2');
                        titleEl.textContent = title;
                        titleEl.style.textAlign = 'center';
                        titleEl.style.margin = '10px 0';
                        titleEl.style.fontFamily = 'Arial, sans-serif';
                        container.insertBefore(titleEl, tableClone);
                        
                        // Wait for a small timeout to ensure rendering
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Use html2canvas to capture the table as an image
                        const canvas = await html2canvas(container, {
                            scale: 2, // Higher scale for better quality
                            useCORS: true,
                            logging: false,
                            allowTaint: true,
                            backgroundColor: '#ffffff'
                        });
                        
                        // Create PDF with appropriate dimensions
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 210; // A4 width in mm
                        const pageHeight = 297; // A4 height in mm
                        const imgHeight = canvas.height * imgWidth / canvas.width;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        let position = 0;
                        
                        // Add image to PDF, handling pagination if needed
                        if (imgHeight < pageHeight) {
                            // If image fits on one page
                            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        } else {
                            // If image needs multiple pages
                            let heightLeft = imgHeight;
                            let page = 1;
                            
                            while (heightLeft > 0) {
                                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, '', 'FAST');
                                heightLeft -= pageHeight;
                                position -= pageHeight;
                                
                                if (heightLeft > 0) {
                                    doc.addPage();
                                    page++;
                                }
                            }
                        }
                        
                        // Clean up
                        document.body.removeChild(container);
                        document.body.removeChild(loadingEl);
                        
                        // Save PDF
                        const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${Date.now()}.pdf`;
                        doc.save(filename);
                        
                    } catch (error) {
                        console.error('Error generating PDF:', error);
                        // Remove loading indicator if exists
                        const loadingEl = document.querySelector('div[style*="Generating PDF"]');
                        if (loadingEl) document.body.removeChild(loadingEl);
                        alert('Failed to export PDF. Check console for details.');
                    }
                });

                // Append icon to container and container to body
                iconContainer.appendChild(icon);
                document.body.appendChild(iconContainer);

                // Mark table as processed
                table.dataset.pdfIconAdded = 'true';

                // Update position initially
                updateIconPosition();

                // Observe table visibility and position changes
                const mutationObserver = new MutationObserver(updateIconPosition);
                mutationObserver.observe(table, { attributes: true, attributeFilter: ['style', 'class'] });

                // Observe table size/position changes
                const resizeObserver = new ResizeObserver(updateIconPosition);
                resizeObserver.observe(table);

                // Update on scroll and resize
                window.addEventListener('scroll', updateIconPosition);
                window.addEventListener('resize', updateIconPosition);
            }
        });
    }

    // Initial run
    try {
        addExportIconToTables();
    } catch (error) {
        console.error('Error in initial table processing:', error);
    }

    // Watch for dynamically added tables (including popups) with debouncing
    let timeout;
    const observer = new MutationObserver(() => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            try {
                addExportIconToTables();
            } catch (error) {
                console.error('Error in dynamic table processing:', error);
            }
        }, 1000);
    });

    observer.observe(document.documentElement, {
        childList: true,
        subtree: true
    });
});




(function () {
  const icon = document.createElement("div");
  icon.textContent = "💾";
  icon.title = "Save Offline Copy";
  Object.assign(icon.style, {
    position: "fixed",
    top: "10px",
    left: "10px",
    fontSize: "24px",
    cursor: "pointer",
    zIndex: "9999",
    background: "#fff",
    padding: "5px",
    borderRadius: "5px",
    boxShadow: "0 0 5px rgba(0,0,0,0.5)"
  });

  icon.onclick = function () {
    const doctype = "<!DOCTYPE html>";
    const htmlTag = document.documentElement.cloneNode(true);
    const local = JSON.stringify(localStorage);
    const session = JSON.stringify(sessionStorage);
    const cookies = document.cookie;

    const restoreScript = document.createElement("script");
    restoreScript.textContent = `
      (function(){
        const l=${local};
        const s=${session};
        const c=${JSON.stringify(cookies)};
        for(let k in l) localStorage.setItem(k, l[k]);
        for(let k in s) sessionStorage.setItem(k, s[k]);
        document.cookie = c;
      })();`;

    htmlTag.querySelector("head").appendChild(restoreScript);
    const fullHtml = doctype + "\n" + htmlTag.outerHTML;

    const blob = new Blob([fullHtml], { type: "text/html" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "yasin_offline_copy.html";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.body.appendChild(icon);
})();



document.addEventListener('DOMContentLoaded', () => {
    console.log('Breadcrumb script running'); // Debug: Check if script runs

    // Check if device is mobile (screen width <= 768px)
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    console.log('Is mobile:', isMobile); // Debug: Confirm mobile detection
    if (!isMobile) return;

    const nav = document.querySelector('nav');
    if (!nav) {
        console.error('Navigation bar not found'); // Debug: Check if nav exists
        return;
    }

    const originalButtons = nav.querySelectorAll('button');
    if (originalButtons.length === 0) {
        console.error('No buttons found in navigation'); // Debug: Check buttons
        return;
    }

    const container = document.querySelector('.container');
    if (!container) {
        console.error('Container not found'); // Debug: Check container
        return;
    }

    // Create breadcrumb container
    const breadcrumb = document.createElement('div');
    breadcrumb.className = 'breadcrumb';
    breadcrumb.style.cssText = `
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #5a8dee;
        color: white;
        font-family: 'Noto Nastaliq Urdu', sans-serif;
        font-size: 1.2em;
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 1000;
    `;

    // Create menu button
    const menuButton = document.createElement('button');
    menuButton.textContent = '☰';
    menuButton.style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 1.5em;
        cursor: pointer;
        margin-left: 10px;
        padding: 5px 10px;
    `;

    // Create current page display
    const currentPage = document.createElement('span');
    currentPage.textContent = 'ڈیش بورڈ'; // Default
    currentPage.style.cssText = `
        flex: 1;
        text-align: right;
    `;

    // Create dropdown menu
    const dropdown = document.createElement('div');
    dropdown.className = 'dropdown-menu';
    dropdown.style.cssText = `
        display: none;
        position: absolute;
        top: 100%;
        right: 10px;
        background-color: #4a7bdc;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1001;
        min-width: 200px;
    `;

    // Populate dropdown with menu items
    originalButtons.forEach(button => {
        const moduleIdMatch = button.getAttribute('onclick')?.match(/showModule\('([^']+)'\)/);
        if (!moduleIdMatch) {
            console.warn('Button missing valid onclick:', button.textContent); // Debug: Check button onclick
            return;
        }
        const moduleId = moduleIdMatch[1];
        const menuItem = document.createElement('button');
        menuItem.textContent = button.textContent;
        menuItem.style.cssText = `
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: white;
            text-align: right;
            cursor: pointer;
            font-family: 'Noto Nastaliq Urdu', sans-serif;
            font-size: 1.2em;
        `;
        menuItem.addEventListener('click', () => {
            console.log('Menu item clicked:', moduleId); // Debug: Check click
            window.showModule(moduleId); // Call global showModule
            currentPage.textContent = button.textContent;
            dropdown.style.display = 'none'; // Explicitly hide dropdown
            console.log('Dropdown hidden after menu item click'); // Debug: Confirm hide
        });
        dropdown.appendChild(menuItem);
    });

    // Toggle dropdown on menu button click
    menuButton.addEventListener('click', () => {
        const isVisible = dropdown.style.display === 'block';
        dropdown.style.display = isVisible ? 'none' : 'block';
        console.log('Dropdown toggled:', dropdown.style.display); // Debug: Check toggle
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!breadcrumb.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
            console.log('Dropdown closed (outside click)'); // Debug: Check close
        }
    });

    // Assemble breadcrumb
    breadcrumb.appendChild(menuButton);
    breadcrumb.appendChild(currentPage);
    breadcrumb.appendChild(dropdown);

    // Hide original nav and insert breadcrumb
    nav.style.display = 'none';
    container.insertBefore(breadcrumb, container.firstChild);
    console.log('Breadcrumb inserted'); // Debug: Confirm insertion

    // Override showModule to update current page text
    const originalShowModule = window.showModule;
    window.showModule = function(moduleId) {
        console.log('showModule called:', moduleId); // Debug: Check showModule
        originalShowModule(moduleId);
        const activeButton = Array.from(originalButtons).find(btn => 
            btn.getAttribute('onclick')?.includes(moduleId));
        if (activeButton) {
            currentPage.textContent = activeButton.textContent;
            dropdown.style.display = 'none'; // Ensure dropdown closes on module change
            console.log('Current page updated:', activeButton.textContent); // Debug: Check update
        }
    };
});










document.addEventListener('DOMContentLoaded', () => {
    // Configuration for tables
    const tableConfigs = [
        { id: 'studentsTable', searchable: true, sortable: true, paginated: true },
        { id: 'teachersTable', searchable: true, sortable: true, paginated: true },
        { id: 'classesTable', searchable: true, sortable: true, paginated: true },
        { id: 'feeStructuresTable', searchable: true, sortable: true, paginated: true },
        { id: 'feeHistoryTable', searchable: true, sortable: true, paginated: true },
        { id: 'attendanceTable', searchable: true, sortable: true, paginated: true },
        { id: 'resultsEntryTable', searchable: true, sortable: true, paginated: true },
        { id: 'classTimetableTable', searchable: true, sortable: true, paginated: true },
        { id: 'teacherRoasterTable', searchable: true, sortable: true, paginated: true },
        { id: 'expensesTable', searchable: true, sortable: true, paginated: true }
    ];

    // Utility function for debouncing
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func(...args), wait);
        };
    }

    // Throttle function to limit MutationObserver triggers
    function throttle(func, limit) {
        let inThrottle;
        return function (...args) {
            if (!inThrottle) {
                func(...args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        };
    }

    // Function to check if table is visible
    function isTableVisible(table) {
        return table && table.offsetParent !== null;
    }

    // Store initialized table IDs to prevent duplicates
    const initializedTables = new Set();

    // Function to initialize enhanced features for a table
    function enhanceTable(config) {
        const table = document.getElementById(config.id);
        if (!table) {
            console.warn(`Table with ID ${config.id} not found.`);
            return;
        }

        // Skip if table is not visible or already initialized
        if (!isTableVisible(table) || initializedTables.has(config.id)) {
            return;
        }

        try {
            initializedTables.add(config.id);

            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('thead th');
            let originalRows = Array.from(tbody.querySelectorAll('tr')); // Store original rows
            let rows = [...originalRows]; // Working copy of rows
            let currentPage = 1;
            const rowsPerPage = 10;

            // Check for existing controls container
            let controlsContainer = table.parentNode.querySelector(`.controls-${config.id}`);
            if (!controlsContainer) {
                controlsContainer = document.createElement('div');
                controlsContainer.className = `controls-${config.id}`;
                controlsContainer.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                    flex-wrap: wrap;
                    gap: 10px;
                `;
                table.parentNode.insertBefore(controlsContainer, table);
            }

            // Search functionality
            let searchInput;
            if (config.searchable && !controlsContainer.querySelector('input')) {
                searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'تلاش کریں...';
                searchInput.style.cssText = `
                    padding: 8px;
                    width: 200px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-family: 'Noto Nastaliq Urdu', sans-serif;
                    font-size: 1.2em;
                `;
                controlsContainer.appendChild(searchInput);

                searchInput.addEventListener('input', debounce(() => {
                    try {
                        const searchTerm = searchInput.value.toLowerCase();
                        if (searchTerm) {
                            rows = originalRows.filter(row =>
                                Array.from(row.cells).some(cell =>
                                    cell.textContent.toLowerCase().includes(searchTerm)
                                )
                            );
                        } else {
                            rows = [...originalRows]; // Restore original rows when search is cleared
                        }
                        currentPage = 1;
                        renderTable();
                    } catch (error) {
                        console.error(`Error in search for ${config.id}:`, error);
                    }
                }, 500));
            }

            // Sorting functionality
            if (config.sortable) {
                headers.forEach((th, index) => {
                    // Skip action columns
                    if (th.textContent.includes('عمل')) return;

                    th.style.cursor = 'pointer';
                    th.dataset.sortDir = 'asc';
                    th.addEventListener('click', () => {
                        try {
                            const sortDir = th.dataset.sortDir === 'asc' ? 'desc' : 'asc';
                            th.dataset.sortDir = sortDir;

                            headers.forEach(h => {
                                if (h !== th) h.dataset.sortDir = 'asc';
                            });

                            rows.sort((a, b) => {
                                let aText = a.cells[index].textContent.trim();
                                let bText = b.cells[index].textContent.trim();

                                const isNumeric = !isNaN(parseFloat(aText)) && isFinite(aText);
                                const isDate = Date.parse(aText) && aText.includes('-');

                                if (isDate) {
                                    aText = new Date(aText).getTime();
                                    bText = new Date(bText).getTime();
                                } else if (isNumeric) {
                                    aText = parseFloat(aText);
                                    bText = parseFloat(bText);
                                }

                                return sortDir === 'asc'
                                    ? aText > bText ? 1 : -1
                                    : aText < bText ? 1 : -1;
                            });

                            renderTable();
                        } catch (error) {
                            console.error(`Error in sorting for ${config.id}:`, error);
                        }
                    });
                });
            }

            // Pagination functionality
            let paginationContainer;
            if (config.paginated && !controlsContainer.querySelector('.pagination')) {
                paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination';
                paginationContainer.style.cssText = `
                    display: flex;
                    gap: 5px;
                    align-items: center;
                `;
                controlsContainer.appendChild(paginationContainer);
            } else {
                paginationContainer = controlsContainer.querySelector('.pagination');
            }

            // Function to render table rows
            function renderTable() {
                try {
                    tbody.innerHTML = '';
                    const start = (currentPage - 1) * rowsPerPage;
                    const end = Math.min(start + rowsPerPage, rows.length);
                    const paginatedRows = rows.slice(start, end);

                    paginatedRows.forEach(row => tbody.appendChild(row));

                    if (config.paginated) {
                        updatePagination();
                    }

                    if (rows.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="${headers.length}">کوئی ڈیٹا نہیں ملا</td></tr>`;
                    }
                } catch (error) {
                    console.error(`Error rendering table ${config.id}:`, error);
                    tbody.innerHTML = `<tr><td colspan="${headers.length}">جدول رینڈر کرنے میں خرابی</td></tr>`;
                }
            }

            // Function to update pagination controls
            function updatePagination() {
                try {
                    paginationContainer.innerHTML = '';
                    const totalPages = Math.ceil(rows.length / rowsPerPage);

                    const prevButton = document.createElement('button');
                    prevButton.textContent = 'پچھلا';
                    prevButton.style.cssText = `
                        padding: 8px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                        background-color: #5cb85c;
                        color: white;
                        cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};
                        font-family: 'Noto Nastaliq Urdu', sans-serif;
                        font-size: 1.2em;
                    `;
                    prevButton.disabled = currentPage === 1;
                    prevButton.addEventListener('click', () => {
                        try {
                            if (currentPage > 1) {
                                currentPage--;
                                renderTable();
                            }
                        } catch (error) {
                            console.error(`Error in prev button for ${config.id}:`, error);
                        }
                    });
                    paginationContainer.appendChild(prevButton);

                    const pageNumbers = document.createElement('span');
                    pageNumbers.textContent = `صفحہ ${currentPage} از ${totalPages}`;
                    pageNumbers.style.cssText = `
                        padding: 8px;
                        font-family: 'Noto Nastaliq Urdu', sans-serif;
                        font-size: 1.2em;
                    `;
                    paginationContainer.appendChild(pageNumbers);

                    const nextButton = document.createElement('button');
                    nextButton.textContent = 'اگلا';
                    nextButton.style.cssText = `
                        padding: 8px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                        background-color: #5cb85c;
                        color: white;
                        cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};
                        font-family: 'Noto Nastaliq Urdu', sans-serif;
                        font-size: 1.2em;
                    `;
                    nextButton.disabled = currentPage === totalPages;
                    nextButton.addEventListener('click', () => {
                        try {
                            if (currentPage < totalPages) {
                                currentPage++;
                                renderTable();
                            }
                        } catch (error) {
                            console.error(`Error in next button for ${config.id}:`, error);
                        }
                    });
                    paginationContainer.appendChild(nextButton);
                } catch (error) {
                    console.error(`Error updating pagination for ${config.id}:`, error);
                }
            }

            // Initial render
            renderTable();

            // Throttled MutationObserver for dynamic updates
            const observer = new MutationObserver(throttle(() => {
                try {
                    originalRows = Array.from(tbody.querySelectorAll('tr'));
                    rows = [...originalRows];
                    currentPage = 1;
                    renderTable();
                } catch (error) {
                    console.error(`Error in MutationObserver for ${config.id}:`, error);
                }
            }, 1000));
            observer.observe(tbody, { childList: true, subtree: true });
        } catch (error) {
            console.error(`Error initializing table ${config.id}:`, error);
        }
    }

    // Initialize enhanced features for all configured tables
    function initializeTables() {
        tableConfigs.forEach(config => {
            try {
                enhanceTable(config);
            } catch (error) {
                console.error(`Error initializing table ${config.id}:`, error);
            }
        });
    }

    // Run initialization
    try {
        initializeTables();
    } catch (error) {
        console.error('Error during table initialization:', error);
    }

    // Re-run initialization when module changes (for dynamically loaded tables)
    const originalShowModule = window.showModule || function() {};
    window.showModule = function(moduleId) {
        try {
            originalShowModule(moduleId);
            // Clear initialized tables to allow reinitialization
            initializedTables.clear();
            // Remove existing controls to prevent duplicates
            document.querySelectorAll('[class^="controls-"]').forEach(container => container.remove());
            setTimeout(initializeTables, 500); // Delay to allow DOM updates
        } catch (error) {
            console.error('Error in showModule override:', error);
        }
    };
});



document.querySelectorAll("*").forEach(el => {
  if (el.childNodes.length) {
    el.childNodes.forEach(node => {
      if (node.nodeType === 3) {
        let text = node.nodeValue;
        // Replace known Hindi/Bengali words with Urdu
        text = text.replace(/পিরিয়ড/g, 'پیریڈ');
        text = text.replace(/شروع/g, 'شروع');
        text = text.replace(/শেষ/g, 'ختم');
        text = text.replace(/দিন/g, 'دن');

        // Replace Bengali digits with Urdu digits
        const bengaliToUrduDigits = {
          '০': '۰', '১': '۱', '২': '۲', '৩': '۳', '৪': '۴',
          '৫': '۵', '৬': '۶', '৭': '۷', '৮': '۸', '৯': '۹'
        };
        text = text.replace(/[০-৯]/g, m => bengaliToUrduDigits[m]);

        node.nodeValue = text;
      }
    });
  }
});




function createResultsModule() {
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = ''; // Clear existing content

    // Main heading
    const h2 = document.createElement('h2');
    h2.textContent = 'نتائج کا انتظام';
    resultsDiv.appendChild(h2);

    // Entry section
    const entryH3 = document.createElement('h3');
    entryH3.textContent = 'نتائج درج کریں';
    resultsDiv.appendChild(entryH3);

    const formGrid = document.createElement('div');
    formGrid.className = 'form-grid';
    formGrid.innerHTML = `
        <div>
            <label for="resultExamName">امتحان کا نام</label>
            <input type="text" id="resultExamName" placeholder="مثال: Mid Term" required>
        </div>
        <div>
            <label for="resultClass">کلاس</label>
            <select id="resultClass" required onchange="loadStudentsAndSubjectsForResult()">
                <option value="">-- کلاس منتخب کریں --</option>
            </select>
        </div>
        <div>
            <label for="resultSubject">مضمون</label>
            <select id="resultSubject" required>
                <option value="">-- مضمون منتخب کریں --</option>
            </select>
        </div>
        <div>
            <label for="resultDate">تاریخ</label>
            <input type="date" id="resultDate" required>
        </div>
    `;
    resultsDiv.appendChild(formGrid);

    const entryTable = document.createElement('table');
    entryTable.id = 'resultsEntryTable';
    entryTable.innerHTML = `
        <thead>
            <tr>
                <th>طالب علم</th>
                <th>کل نمبر</th>
                <th>حاصل کردہ نمبر</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="3">کلاس منتخب کریں۔</td></tr>
        </tbody>
    `;
    resultsDiv.appendChild(entryTable);

    const saveButton = document.createElement('button');
    saveButton.textContent = 'محفوظ کریں';
    saveButton.onclick = saveResults;
    resultsDiv.appendChild(saveButton);

    // View section
    const viewH3 = document.createElement('h3');
    viewH3.textContent = 'موجودہ نتائج دیکھیں';
    resultsDiv.appendChild(viewH3);

    const filterGrid = document.createElement('div');
    filterGrid.className = 'form-grid';
    filterGrid.innerHTML = `
        <div>
            <label for="filterResultExam">امتحان</label>
            <select id="filterResultExam" onchange="loadPastResults()">
                <option value="">-- تمام --</option>
            </select>
        </div>
        <div>
            <label for="filterResultStudent">طالب علم</label>
            <select id="filterResultStudent" onchange="loadPastResults()">
                <option value="">-- تمام --</option>
            </select>
        </div>
        <div>
            <label for="filterResultClass">کلاس</label>
            <select id="filterResultClass" onchange="loadPastResults()">
                <option value="">-- تمام --</option>
            </select>
        </div>
    `;
    resultsDiv.appendChild(filterGrid);

    const pastTable = document.createElement('table');
    pastTable.id = 'pastResultsTable';
    pastTable.innerHTML = `
        <thead>
            <tr>
                <th>امتحان</th>
                <th>کلاس</th>
                <th>طالب علم</th>
                <th>مضمون</th>
                <th>تاریخ</th>
                <th>کل نمبر</th>
                <th>حاصل کردہ نمبر</th>
                <th>عمل</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="8">فلٹر منتخب کریں۔</td></tr>
        </tbody>
    `;
    resultsDiv.appendChild(pastTable);

    // Print section
    const printH3 = document.createElement('h3');
    printH3.textContent = 'رزلٹ کارڈ پرنٹ کریں';
    resultsDiv.appendChild(printH3);

    const printGrid = document.createElement('div');
    printGrid.className = 'form-grid';
    printGrid.innerHTML = `
        <div>
            <label for="resultCardStudent">طالب علم</label>
            <select id="resultCardStudent" required>
                <option value="">-- طالب علم منتخب کریں --</option>
            </select>
        </div>
        <div>
            <label for="resultCardExam">امتحان</label>
            <select id="resultCardExam" required>
                <option value="">-- امتحان منتخب کریں --</option>
            </select>
        </div>
    `;
    resultsDiv.appendChild(printGrid);

    const printButton = document.createElement('button');
    printButton.className = 'print';
    printButton.textContent = 'پرنٹ کریں';
    printButton.onclick = printResultCard;
    resultsDiv.appendChild(printButton);

    const printContainer = document.createElement('div');
    printContainer.id = 'resultCardPrintContainer';
    printContainer.className = 'printable';
    printContainer.innerHTML = `
        <h3>رزلٹ کارڈ</h3>
        <p><strong>مدرسہ:</strong> <span id="printResultSchoolName"></span></p>
        <p><strong>امتحان:</strong> <span id="printResultExamName"></span></p>
        <p><strong>طالب علم:</strong> <span id="printResultStudentName"></span></p>
        <p><strong>کلاس:</strong> <span id="printResultClassName"></span></p>
        <table id="resultCardPrintTable" class="printable-content">
            <thead>
                <tr>
                    <th>مضمون</th>
                    <th>کل نمبر</th>
                    <th>حاصل کردہ نمبر</th>
                    <th>فیصد</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p><strong>کل نمبر:</strong> <span id="printResultTotalMarks"></span></p>
        <p><strong>حاصل کردہ:</strong> <span id="printResultTotalObtained"></span></p>
        <p><strong>فیصد:</strong> <span id="printResultOverallPercentage"></span>%</p>
        <p><strong>نتیجہ:</strong> <span id="printResultStatus"></span></p>
    `;
    resultsDiv.appendChild(printContainer);
}

async function loadClassesForResults() {
    const classSelect = document.getElementById('resultClass');
    const filterClassSelect = document.getElementById('filterResultClass');
    classSelect.innerHTML = '<option value="">-- کلاس منتخب کریں --</option>';
    filterClassSelect.innerHTML = '<option value="">-- تمام --</option>';
    try {
        const classes = await getAll(STORE_CLASSES);
        classes.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
            const option1 = document.createElement('option');
            option1.value = cls.id;
            option1.textContent = cls.name;
            classSelect.appendChild(option1);
            const option2 = option1.cloneNode(true);
            filterClassSelect.appendChild(option2);
        });
    } catch (error) {
        console.error("Error loading classes:", error);
    }
}

async function loadStudentsForResultCard() {
    const studentSelect = document.getElementById('resultCardStudent');
    const filterStudentSelect = document.getElementById('filterResultStudent');
    studentSelect.innerHTML = '<option value="">-- طالب علم منتخب کریں --</option>';
    filterStudentSelect.innerHTML = '<option value="">-- تمام --</option>';
    try {
        const students = await getAll(STORE_STUDENTS);
        students.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
            const option1 = document.createElement('option');
            option1.value = student.id;
            option1.textContent = student.name;
            studentSelect.appendChild(option1);
            const option2 = option1.cloneNode(true);
            filterStudentSelect.appendChild(option2);
        });
    } catch (error) {
        console.error("Error loading students:", error);
    }
}

async function loadExamsForResultCard() {
    const examSelect = document.getElementById('resultCardExam');
    const filterExamSelect = document.getElementById('filterResultExam');
    examSelect.innerHTML = '<option value="">-- امتحان منتخب کریں --</option>';
    filterExamSelect.innerHTML = '<option value="">-- تمام --</option>';
    try {
        const results = await getAll(STORE_RESULTS);
        const exams = [...new Set(results.map(r => r.examName))].sort();
        exams.forEach(exam => {
            const option1 = document.createElement('option');
            option1.value = exam;
            option1.textContent = exam;
            examSelect.appendChild(option1);
            const option2 = option1.cloneNode(true);
            filterExamSelect.appendChild(option2);
        });
    } catch (error) {
        console.error("Error loading exams:", error);
    }
}

async function loadStudentsAndSubjectsForResult() {
    const classId = document.getElementById('resultClass').value;
    const tableBody = document.getElementById('resultsEntryTable').querySelector('tbody');
    const subjectSelect = document.getElementById('resultSubject');

    tableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';
    subjectSelect.innerHTML = '<option value="">-- مضمون منتخب کریں --</option>';

    if (!classId) {
        tableBody.innerHTML = '<tr><td colspan="3">کلاس منتخب کریں۔</td></tr>';
        return;
    }

    try {
        const cls = await getById(STORE_CLASSES, parseInt(classId));
        if (!cls) {
            tableBody.innerHTML = '<tr><td colspan="3">کلاس نہیں ملی۔</td></tr>';
            return;
        }

        const students = await getAll(STORE_STUDENTS, 'classId', parseInt(classId));
        students.sort((a, b) => a.name.localeCompare(b.name));

        // Handle subjects (string or array)
        let subjects = [];
        if (cls.subjects) {
            if (typeof cls.subjects === 'string') {
                subjects = cls.subjects.split(',').map(s => s.trim()).filter(s => s);
            } else if (Array.isArray(cls.subjects)) {
                subjects = cls.subjects.filter(s => s).map(s => s.trim());
            }
        }

        subjects.sort().forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelect.appendChild(option);
        });

        tableBody.innerHTML = '';
        if (students.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
            return;
        }

        students.forEach(student => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${student.name}</td>
                <td><input type="number" class="totalMarks" min="0" value="100"></td>
                <td><input type="number" class="obtainedMarks" min="0" max="100" value="0"></td>
            `;
            row.dataset.studentId = student.id;
        });
    } catch (error) {
        console.error("Error loading students/subjects:", error);
        tableBody.innerHTML = '<tr><td colspan="3">خرابی: ڈیٹا لوڈ نہیں ہو سکا۔</td></tr>';
    }
}

async function saveResults() {
    const examName = document.getElementById('resultExamName').value.trim();
    const classId = parseInt(document.getElementById('resultClass').value);
    const subject = document.getElementById('resultSubject').value;
    const date = document.getElementById('resultDate').value;

    if (!examName || !classId || !subject || !date) {
        alert('تمام فیلڈز پُر کریں۔');
        return;
    }

    const tableBody = document.getElementById('resultsEntryTable').querySelector('tbody');
    const rows = tableBody.querySelectorAll('tr');

    try {
        for (const row of rows) {
            const studentId = parseInt(row.dataset.studentId);
            const totalMarks = parseInt(row.querySelector('.totalMarks').value) || 0;
            const obtainedMarks = parseInt(row.querySelector('.obtainedMarks').value) || 0;

            if (obtainedMarks > totalMarks) {
                alert('حاصل کردہ نمبر کل نمبروں سے زیادہ نہیں ہو سکتے۔');
                return;
            }

            const result = { examName, classId, subject, studentId, date, totalMarks, obtainedMarks };
            const existing = await getAll(STORE_RESULTS, 'exam_class_subject_student', 
                [examName, classId, subject, studentId]);

            if (existing.length > 0) {
                result.id = existing[0].id;
                await updateData(STORE_RESULTS, result);
            } else {
                await addData(STORE_RESULTS, result);
            }
        }

        alert('نتائج محفوظ ہو گئے۔');
        loadStudentsAndSubjectsForResult();
        loadPastResults();
        loadExamsForResultCard();
    } catch (error) {
        console.error("Error saving results:", error);
        alert('خرابی: ' + error.message);
    }
}

async function loadPastResults() {
    const tableBody = document.getElementById('pastResultsTable').querySelector('tbody');
    const examName = document.getElementById('filterResultExam').value;
    const studentId = parseInt(document.getElementById('filterResultStudent').value) || null;
    const classId = parseInt(document.getElementById('filterResultClass').value) || null;

    tableBody.innerHTML = '<tr><td colspan="8">لوڈ ہو رہا ہے...</td></tr>';

    try {
        let results = await getAll(STORE_RESULTS);
        results = results.filter(r => 
            (!examName || r.examName === examName) && 
            (!studentId || r.studentId === studentId) && 
            (!classId || r.classId === classId)
        );

        tableBody.innerHTML = '';
        if (results.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8">کوئی نتائج نہیں۔</td></tr>';
            return;
        }

        for (const r of results.sort((a, b) => new Date(b.date) - new Date(a.date))) {
            const className = await getClassName(r.classId);
            const studentName = await getStudentName(r.studentId);
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${r.examName}</td>
                <td>${className}</td>
                <td>${studentName}</td>
                <td>${r.subject}</td>
                <td>${r.date}</td>
                <td>${r.totalMarks}</td>
                <td>${r.obtainedMarks}</td>
                <td>
                    <button class="edit" onclick="editResult(${r.id})">ترمیم</button>
                    <button class="delete" onclick="deleteResult(${r.id})">حذف</button>
                </td>
            `;
        }
    } catch (error) {
        console.error("Error loading past results:", error);
        tableBody.innerHTML = '<tr><td colspan="8">خرابی۔</td></tr>';
    }
}

async function editResult(id) {
    try {
        const result = await getById(STORE_RESULTS, id);
        document.getElementById('resultExamName').value = result.examName;
        document.getElementById('resultClass').value = result.classId;
        document.getElementById('resultDate').value = result.date;
        await loadStudentsAndSubjectsForResult();
        document.getElementById('resultSubject').value = result.subject;

        const row = document.getElementById('resultsEntryTable')
            .querySelector(`tr[data-student-id="${result.studentId}"]`);
        row.querySelector('.totalMarks').value = result.totalMarks;
        row.querySelector('.obtainedMarks').value = result.obtainedMarks;

        showModule('results');
        window.scrollTo(0, 0);
    } catch (error) {
        console.error("Error editing result:", error);
        alert('ترمیم میں خرابی۔');
    }
}

async function deleteResult(id) {
    if (!confirm('کیا آپ اس نتیجہ کو حذف کرنا چاہتے ہیں؟')) return;

    try {
        await deleteData(STORE_RESULTS, id);
        alert('نتیجہ حذف ہو گیا۔');
        loadPastResults();
        loadExamsForResultCard();
    } catch (error) {
        console.error("Error deleting result:", error);
        alert('حذف کرنے میں خرابی۔');
    }
}

async function printResultCard() {
    const studentId = parseInt(document.getElementById('resultCardStudent').value);
    const examName = document.getElementById('resultCardExam').value;

    if (!studentId || !examName) {
        alert('طالب علم اور امتحان منتخب کریں۔');
        return;
    }

    try {
        const student = await getById(STORE_STUDENTS, studentId);
        const results = await getAll(STORE_RESULTS);
        const filteredResults = results.filter(r => r.studentId === studentId && r.examName === examName);

        if (filteredResults.length === 0) {
            alert('کوئی نتائج نہیں ملے۔');
            return;
        }

        const classId = filteredResults[0].classId;
        const className = await getClassName(classId);
        const schoolSetting = await getById(STORE_SETTINGS, 'schoolName');
        const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';

        const tableBody = document.getElementById('resultCardPrintTable').querySelector('tbody');
        tableBody.innerHTML = '';

        let totalMarks = 0;
        let totalObtained = 0;

        filteredResults.sort((a, b) => a.subject.localeCompare(b.subject)).forEach(result => {
            const percentage = ((result.obtainedMarks / result.totalMarks) * 100).toFixed(2);
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td>${result.subject}</td>
                <td>${result.totalMarks}</td>
                <td>${result.obtainedMarks}</td>
                <td>${percentage}%</td>
            `;
            totalMarks += result.totalMarks;
            totalObtained += result.obtainedMarks;
        });

        const overallPercentage = ((totalObtained / totalMarks) * 100).toFixed(2);
        const status = overallPercentage >= 33 ? 'کامیاب' : 'ناکام';

        document.getElementById('printResultSchoolName').textContent = schoolName;
        document.getElementById('printResultExamName').textContent = examName;
        document.getElementById('printResultStudentName').textContent = student.name;
        document.getElementById('printResultClassName').textContent = className;
        document.getElementById('printResultTotalMarks').textContent = totalMarks;
        document.getElementById('printResultTotalObtained').textContent = totalObtained;
        document.getElementById('printResultOverallPercentage').textContent = overallPercentage;
        document.getElementById('printResultStatus').textContent = status;

        window.print();
    } catch (error) {
        console.error("Error printing result card:", error);
        alert('پرنٹ میں خرابی: ' + error.message);
    }
}





document.addEventListener('DOMContentLoaded', () => {
    // Function to convert printable area to image and print
    async function printContent(containerId) {
        try {
            const container = document.getElementById(containerId);
            if (!container) {
                alert('پرنٹ ایریا نہیں ملا۔');
                return;
            }

            // Show the printable container temporarily for rendering
            container.style.display = 'block';

            // Use html2canvas to capture the printable area
            const canvas = await html2canvas(container, {
                scale: 2, // Higher scale for better quality
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff'
            });

            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            if (!printWindow) {
                alert('پرنٹ ونڈو کھولنے میں ناکامی۔ براہ کرم پاپ اپ بلاکر چیک کریں۔');
                container.style.display = 'none';
                return;
            }

            // Write the image to the new window
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>پرنٹ</title>
                    <style>
                        body { margin: 0; display: flex; justify-content: center; align-items: center; }
                        img { max-width: 100%; height: auto; }
                    </style>
                </head>
                <body>
                    <img src="${canvas.toDataURL('image/png')}" onload="window.print(); window.close();" />
                </body>
                </html>
            `);
            printWindow.document.close();

            // Hide the container again
            container.style.display = 'none';
        } catch (error) {
            console.error('پرنٹنگ میں خرابی:', error);
            alert('پرنٹنگ میں خرابی: ' + error.message);
        }
    }

    // Override printAttendanceRegister
    window.printAttendanceRegister = async function() {
        const attendanceDate = document.getElementById('attendanceDate').value;
        const classId = document.getElementById('attendanceClass').value;
        if (!attendanceDate || !classId) {
            alert('براہ کرم تاریخ اور کلاس منتخب کریں۔');
            return;
        }

        try {
            const className = await getClassName(parseInt(classId));
            const students = await getAll(STORE_STUDENTS, 'classId', parseInt(classId));
            const attendanceRecords = await getAll(STORE_ATTENDANCE, 'date_classId', [attendanceDate, parseInt(classId)]);

            const tableBody = document.getElementById('attendancePrintTable').querySelector('tbody');
            tableBody.innerHTML = '';
            students.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                const record = attendanceRecords.find(r => r.studentId === student.id);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${student.admissionNo}</td>
                    <td>${student.name}</td>
                    <td>${record && record.status === 'Present' ? 'حاضر' : 'غیر حاضر'}</td>
                `;
            });

            document.getElementById('printAttendanceDate').textContent = attendanceDate;
            document.getElementById('printAttendanceClass').textContent = className;

            await printContent('attendancePrintContainer');
        } catch (error) {
            console.error("Error printing attendance:", error);
            alert('حاضری پرنٹ کرنے میں خرابی: ' + error.message);
        }
    };

    // Override printResultCard
    window.printResultCard = async function() {
        const studentId = parseInt(document.getElementById('resultCardStudent').value);
        const examName = document.getElementById('resultCardExam').value;

        if (!studentId || !examName) {
            alert('طالب علم اور امتحان منتخب کریں۔');
            return;
        }

        try {
            const student = await getById(STORE_STUDENTS, studentId);
            const results = await getAll(STORE_RESULTS);
            const filteredResults = results.filter(r => r.studentId === studentId && r.examName === examName);

            if (filteredResults.length === 0) {
                alert('کوئی نتائج نہیں ملے۔');
                return;
            }

            const classId = filteredResults[0].classId;
            const className = await getClassName(classId);
            const schoolSetting = await getById(STORE_SETTINGS, 'schoolName');
            const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';

            const tableBody = document.getElementById('resultCardPrintTable').querySelector('tbody');
            tableBody.innerHTML = '';

            let totalMarks = 0;
            let totalObtained = 0;

            filteredResults.sort((a, b) => a.subject.localeCompare(b.subject)).forEach(result => {
                const percentage = ((result.obtainedMarks / result.totalMarks) * 100).toFixed(2);
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${result.subject}</td>
                    <td>${result.totalMarks}</td>
                    <td>${result.obtainedMarks}</td>
                    <td>${percentage}%</td>
                `;
                totalMarks += result.totalMarks;
                totalObtained += result.obtainedMarks;
            });

            const overallPercentage = ((totalObtained / totalMarks) * 100).toFixed(2);
            const status = overallPercentage >= 33 ? 'کامیاب' : 'ناکام';

            document.getElementById('printResultSchoolName').textContent = schoolName;
            document.getElementById('printResultExamName').textContent = examName;
            document.getElementById('printResultStudentName').textContent = student.name;
            document.getElementById('printResultClassName').textContent = className;
            document.getElementById('printResultTotalMarks').textContent = totalMarks;
            document.getElementById('printResultTotalObtained').textContent = totalObtained;
            document.getElementById('printResultOverallPercentage').textContent = overallPercentage;
            document.getElementById('printResultStatus').textContent = status;

            await printContent('resultCardPrintContainer');
        } catch (error) {
            console.error("Error printing result card:", error);
            alert('رزلٹ کارڈ پرنٹ کرنے میں خرابی: ' + error.message);
        }
    };

    // Override generateReceipt
    window.generateReceipt = async function() {
        const studentId = parseInt(document.getElementById('feeStudentSelect').value);
        const date = document.getElementById('feeCollectionDate').value;
        const feeType = document.getElementById('feeCollectionType').value;
        const paidAmount = parseInt(document.getElementById('feePaidAmount').value);
        const discount = parseInt(document.getElementById('feeDiscount').value) || 0;
        const method = document.getElementById('feePaymentMethod').value;
        const notes = document.getElementById('feeNotes').value;

        if (!studentId || !date || !feeType || !paidAmount) {
            alert('تمام ضروری فیلڈز پُر کریں۔');
            return;
        }

        try {
            const student = await getById(STORE_STUDENTS, studentId);
            const className = await getClassName(student.classId);
            const receiptId = 'R' + Date.now();

            document.getElementById('receiptId').textContent = receiptId;
            document.getElementById('receiptDate').textContent = date;
            document.getElementById('receiptStudentName').textContent = student.name;
            document.getElementById('receiptStudentClass').textContent = className;
            document.getElementById('receiptFeeType').textContent = feeType;
            document.getElementById('receiptPaidAmount').textContent = paidAmount.toLocaleString();
            document.getElementById('receiptDiscount').textContent = discount.toLocaleString();
            document.getElementById('receiptMethod').textContent = method;
            document.getElementById('receiptNotes').textContent = notes || 'کوئی نوٹس نہیں';

            await printContent('feeReceiptContainer');
        } catch (error) {
            console.error("Error generating receipt:", error);
            alert('رسید بنانے میں خرابی: ' + error.message);
        }
    };

    // Override printReport
    window.printReport = async function() {
        const reportType = document.getElementById('reportType').value;
        if (!reportType) {
            alert('براہ کرم رپورٹ کی قسم منتخب کریں۔');
            return;
        }

        try {
            const content = document.getElementById('reportContent');
            if (content.innerHTML.includes('رپورٹ کا مواد یہاں ظاہر ہوگا')) {
                alert('براہ کرم پہلے رپورٹ بنائیں۔');
                return;
            }

            await printContent('reportOutput');
        } catch (error) {
            console.error("Error printing report:", error);
            alert('رپورٹ پرنٹ کرنے میں خرابی: ' + error.message);
        }
    };
});
</script>
	
	
	
</body>
</html>
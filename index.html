<!DOCTYPE html>
<html lang="ur" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرسہ مینجمنٹ سسٹم Yasin's</title>
    <style>
        body {
            font-family: 'Noto Nastaliq Urdu', 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif !important;
            direction: rtl;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        nav {
            background-color: #5a8dee;
            padding: 10px 0;
            margin-bottom: 20px;
            text-align: center;
        }

        nav button {
            background-color: #4a7bdc;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 0 5px;
            cursor: pointer;
            font-size: 1em;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-bottom: 5px;
            border-bottom: 1px solid;
            font-size: large;
        }

        nav button:hover {
            background-color: #3a6bcc;
        }

        nav button.active {
            background-color: #2a5bad;
        }

        .module {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            background-color: #fff;
        }

        .module.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: calc(100% - 22px);
            padding: 5px;
            margin-bottom: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: larger;
        }

        .container div,
        p {
            font-size: large;
        }

        button,
        input[type="submit"] {
            background-color: #5cb85c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.3em;
            margin-top: 10px;
            margin-left: 5px;
        }

        button:hover,
        input[type="submit"]:hover {
            background-color: #4cae4c;
        }

        button.delete {
            background-color: #d9534f;
        }

        button.delete:hover {
            background-color: #c9302c;
        }

        button.edit {
            background-color: #f0ad4e;
        }

        button.edit:hover {
            background-color: #ec971f;
        }

        button.print {
            background-color: #5bc0de;
        }

        button.print:hover {
            background-color: #31b0d5;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        #feeReceiptContainer,
        #attendancePrintContainer,
        #resultCardPrintContainer {
            display: none;

            border: 1px solid #000;
            padding: 20px;
            margin: 20px 0;
        }

        #feeReceiptContainer h3,
        #attendancePrintContainer h3,
        #resultCardPrintContainer h3 {
            text-align: center;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            nav,
            .container>h1,
            .container>button,
            .module:not(.printable),
            .module>*:not(.printable-content) {
                display: none !important;
            }

            .printable,
            .printable * {
                visibility: visible;
            }

            .printable {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10px;
                border: none;
                box-shadow: none;
                font-size: 12pt;
            }

            .printable table,
            .printable th,
            .printable td {
                border: 1px solid #666;
                padding: 5px;
            }

            button {
                display: none;
            }
        }

        * {
            font-family: Calibri, Calibri, 'Jameel Noori Nastaleeq', Arial, sans-serif;
        }

        #dm_modal_trigger span:first-child {
            font-size: 42px;
            margin: 0 -30px;
        }

        .dm_modal_trigger {
            left: 4px !important;
        }

        * {
            font-family: calibri;
        }

        .form-grid div span {
            margin-right: 23px;
            background: #0000ff82;
            color: white;
            padding: 0px 18px;
        }

        .id-card .photo.qr-code-image {
            width: 96px;
            /* Match the new QR size */
            height: 96px;
            /* Match the new QR size */
            padding: 5px;
            /* Add some padding around the QR code */
            box-sizing: border-box;
            /* Ensure padding is included in width/height */
            object-fit: contain;
            /* Make sure QR code is not stretched */
            background-color: #fff;
            /* Ensure white background for QR if needed */
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>مدرسہ مینجمنٹ سسٹم</h1>
        <nav>
            <button onclick="showModule('dashboard')">ڈیش بورڈ</button>
            <button onclick="showModule('students')">طلباء</button>
            <button onclick="showModule('teachers')">اساتذہ</button>
            <button onclick="showModule('classes')">کلاسیں</button>
            <button onclick="showModule('fees')">فیس</button>
            <button onclick="showModule('feeStructures')">فیس اسٹرکچر</button>
            <button onclick="showModule('attendance')">حاضری</button>
            <button onclick="showModule('results')">نتائج</button>
            <button onclick="showModule('timetable')">ٹائم ٹیبل / ڈیوٹی روسٹر</button>
            <button onclick="showModule('expenses')">اخراجات</button>
            <button onclick="showModule('reports')">رپورٹس</button>
            <button onclick="showModule('settings')">سیٹنگز</button>
        </nav>
        <div id="dashboard" class="module active">
            <h2>ڈیش بورڈ</h2>
            <p>سسٹم میں خوش آمدید۔ یہاں آپ اہم اعدادوشمار دیکھ سکیں گے۔</p>
            <h3>فوری اعدادوشمار (آج)</h3>
            <div class="form-grid">
                <div>کل طلباء: <span id="totalStudents">0</span></div>
                <div>کل اساتذہ: <span id="totalTeachers">0</span></div>
                <div>کل کلاسیں: <span id="totalClasses">0</span></div>
                <div>آج کی آمدنی (مع فیس): <span id="todayFees">0</span></div>
                <div>آج کے اخراجات: <span id="todayExpenses">0</span></div>
            </div>
            <hr style="margin: 20px 0;">
            <h3>تفصیلی رپورٹس</h3>
            <div class="form-grid">
                <div>
                    <label for="dashboardReportType">رپورٹ کی قسم:</label>
                    <select id="dashboardReportType" onchange="toggleDashboardReportInputs()">
                        <option value="monthly">ماہانہ خلاصہ</option>
                        <option value="yearly">سالانہ خلاصہ</option>
                        <option value="custom_range">مخصوص مدت</option>
                    </select>
                </div>
                <div id="dashboardMonthSelectorDiv">
                    <label for="dashboardReportMonth">مہینہ:</label>
                    <select id="dashboardReportMonth" style="width:auto; padding:5px; margin-right:5px;"></select>
                </div>
                <div id="dashboardYearSelectorDiv">
                    <label for="dashboardReportYear">سال:</label>
                    <input type="number" id="dashboardReportYear" placeholder="YYYY" style="width:100px; padding:5px;">
                </div>
                <div id="dashboardDateRangeSelectorDiv" style="display:none; grid-column: span 2;">
                    <div>
                        <label for="dashboardReportStartDate">شروع تاریخ:</label>
                        <input type="date" id="dashboardReportStartDate">
                    </div>
                    <div>
                        <label for="dashboardReportEndDate">اختتامی تاریخ:</label>
                        <input type="date" id="dashboardReportEndDate">
                    </div>
                </div>
                <div style="grid-column: 1 / -1; text-align:left;">
                    <button onclick="generateDashboardDetailedReport()">رپورٹ دیکھیں</button>
                </div>
            </div>
            <div id="dashboardDetailedReportOutput"
                style="margin-top:20px; padding:15px; background-color:#e9ecef; border-radius:5px;">
                <h4 id="dashboardReportTitle">منتخب مدت کے لیے خلاصہ:</h4>
                <div class="form-grid">
                    <div>کل آمدنی (مع فیس): <span id="periodTotalFees">0</span></div>
                    <div>کل اخراجات: <span id="periodTotalExpenses">0</span></div>
                    <div title="Loss is shown with a red background | نقصان کو سرخ پس منظر کے ساتھ ظاہر کیا جاتا ہے">
                        نفع/نقصان: <span id="periodNetProfit">0</span></div>
                    <div>نئے داخلے اس مدت میں: <span id="periodNewAdmissions">0</span></div>
                </div>
            </div>
        </div>
        <div id="students" class="module">
            <h2>طلباء کا انتظام</h2>
            <h3>نیا طالب علم شامل کریں / ترمیم کریں</h3>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-grid">
                    <div>
                        <label for="admissionNo">داخلہ نمبر</label>
                        <input type="text" id="admissionNo" required>
                    </div>
                    <div>
                        <label for="studentName">نام</label>
                        <input type="text" id="studentName" required>
                    </div>
                    <div>
                        <label for="fatherName">والد کا نام</label>
                        <input type="text" id="fatherName" required>
                    </div>
                    <div>
                        <label for="studentClass">کلاس</label>
                        <select id="studentClass" required></select>
                    </div>
                    <div>
                        <label for="admissionDate">داخلہ تاریخ</label>
                        <input type="date" id="admissionDate" required>
                    </div>
                    <div>
                        <label for="studentContact">رابطہ نمبر</label>
                        <input type="text" id="studentContact">
                    </div>
                    <div>
                        <label for="studentAddress">پتہ</label>
                        <input type="text" id="studentAddress">
                    </div>
                </div>
                <button type="submit">محفوظ کریں</button>
                <button type="button" onclick="resetStudentForm()">منسوخ کریں</button>
            </form>
            <h3>طلباء کی فہرست</h3>
            <input type="text" id="studentSearch" placeholder="نام یا داخلہ نمبر سے تلاش کریں..."
                onkeyup="loadStudents()">
            <table id="studentsTable">
                <thead>
                    <tr>
                        <th>داخلہ نمبر</th>
                        <th>نام</th>
                        <th>والد کا نام</th>
                        <th>کلاس</th>
                        <th>داخلہ تاریخ</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="teachers" class="module">
            <h2>اساتذہ کا انتظام</h2>
            <h3>نیا استاد شامل کریں / ترمیم کریں</h3>
            <form id="teacherForm">
                <input type="hidden" id="teacherId">
                <div class="form-grid">
                    <div>
                        <label for="teacherName">نام</label>
                        <input type="text" id="teacherName" required>
                    </div>
                    <div>
                        <label for="teacherSubjects">مضامین</label>
                        <input type="text" id="teacherSubjects" required>
                    </div>
                    <div>
                        <label for="teacherContact">موبائل نمبر</label>
                        <input type="text" id="teacherContact" required>
                    </div>
                    <div>
                        <label for="teacherSalary">طے شدہ تنخواہ</label>
                        <input type="number" id="teacherSalary" required>
                    </div>
                    <div>
                        <label for="appointmentDate">تقرری تاریخ</label>
                        <input type="date" id="appointmentDate" required>
                    </div>
                    <div>
                        <label for="teacherQualification">قابلیت</label>
                        <input type="text" id="teacherQualification">
                    </div>
                </div>
                <button type="submit">محفوظ کریں</button>
                <button type="button" onclick="resetTeacherForm()">منسوخ کریں</button>
            </form>
            <h3>اساتذہ کی فہرست</h3>
            <table id="teachersTable">
                <thead>
                    <tr>
                        <th>نام</th>
                        <th>مضامین</th>
                        <th>موبائل نمبر</th>
                        <th>تنخواہ</th>
                        <th>تقرری تاریخ</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="classes" class="module">
            <h2>کلاسوں کا انتظام</h2>
            <h3>نئی کلاس شامل کریں / ترمیم کریں</h3>
            <form id="classForm">
                <input type="hidden" id="classId">
                <div class="form-grid">
                    <div>
                        <label for="className">کلاس کا نام</label>
                        <input type="text" id="className" required>
                    </div>
                    <div>
                        <label for="classTeacher">استاد</label>
                        <select id="classTeacher" required></select>
                    </div>
                    <div>
                        <label for="classSubjects">مضامین (کوما سے الگ کریں)</label>
                        <input type="text" id="classSubjects" required>
                    </div>
                </div>
                <button type="submit">محفوظ کریں</button>
                <button type="button" onclick="resetClassForm()">منسوخ کریں</button>
            </form>
            <h3>کلاسوں کی فہرست</h3>
            <table id="classesTable">
                <thead>
                    <tr>
                        <th>کلاس کا نام</th>
                        <th>استاد</th>
                        <th>مضامین</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="feeStructures" class="module">
            <h2>فیس اسٹرکچر</h2>
            <h3>نیا فیس اسٹرکچر شامل کریں / ترمیم کریں</h3>
            <form id="feeStructureForm">
                <input type="hidden" id="feeStructureId">
                <div class="form-grid">
                    <div>
                        <label for="feeStructureClass">کلاس</label>
                        <select id="feeStructureClass" required></select>
                    </div>
                    <div>
                        <label for="feeType">فیس کی قسم</label>
                        <input type="text" id="feeType" required placeholder="مثال: ٹیوشن فیس, داخلہ فیس">
                    </div>
                    <div>
                        <label for="feeAmount">رقم</label>
                        <input type="number" id="feeAmount" required>
                    </div>
                </div>
                <button type="submit">محفوظ کریں</button>
                <button type="button" onclick="resetFeeStructureForm()">منسوخ کریں</button>
            </form>
            <h3>موجودہ فیس اسٹرکچر</h3>
            <label for="filterFeeStructureClass">کلاس کے لحاظ سے فلٹر کریں:</label>
            <select id="filterFeeStructureClass" onchange="loadFeeStructures()">
                <option value="">تمام کلاسیں</option>
            </select>
            <table id="feeStructuresTable">
                <thead>
                    <tr>
                        <th>کلاس</th>
                        <th>فیس کی قسم</th>
                        <th>رقم</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="fees" class="module">
            <h2>فیس کا انتظام</h2>
            <h3>فیس وصولی</h3>
            <form id="feeCollectionForm">
                <div class="form-grid">
                    <div>
                        <label for="feeStudentSelect">طالب علم منتخب کریں</label>
                        <select id="feeStudentSelect" required onchange="loadStudentFeeDetails()">
                            <option value="">-- طالب علم منتخب کریں --</option>
                        </select>
                    </div>
                    <div>
                        <label for="feeCollectionDate">تاریخ</label>
                        <input type="date" id="feeCollectionDate" required>
                    </div>
                    <div>
                        <label for="feeCollectionType">فیس کی قسم (واجب الادا سے)</label>
                        <select id="feeCollectionType" required>
                            <option value="">-- پہلے طالب علم منتخب کریں --</option>
                        </select>
                    </div>
                    <div>
                        <label for="feePaidAmount">ادا شدہ رقم</label>
                        <input type="number" id="feePaidAmount" required>
                    </div>
                    <div>
                        <label for="feeDiscount">رعایت</label>
                        <input type="number" id="feeDiscount" value="0">
                    </div>
                    <div>
                        <label for="feePaymentMethod">طریقہ</label>
                        <select id="feePaymentMethod" required>
                            <option value="Cash">نقد</option>
                            <option value="Bank">بینک</option>
                            <option value="Cheque">چیک</option>
                        </select>
                    </div>
                    <div class="full-width">
                        <label for="feeNotes">تفصیل/نوٹس</label>
                        <textarea id="feeNotes" rows="2"></textarea>
                    </div>
                </div>
                <button type="submit">فیس وصول کریں</button>
                <button type="button" onclick="generateReceipt()">رسید بنائیں</button>
            </form>
            <h3>منتخب طالب علم کی فیس کی تفصیلات</h3>
            <p id="noStudentSelectedMsg">براہ کرم اوپر سے طالب علم منتخب کریں۔</p>
            <div id="studentFeeDetailsContainer" style="display: none;">
                <h4>واجب الادا فیس</h4>
                <ul id="dueFeesList"></ul>
                <h4>جمع شدہ فیس کی تاریخ</h4>
                <table id="feeHistoryTable">
                    <thead>
                        <tr>
                            <th>تاریخ</th>
                            <th>فیس کی قسم</th>
                            <th>تفصیل/نوٹس</th>
                            <th>ادا شدہ رقم</th>
                            <th>رعایت</th>
                            <th>طریقہ</th>
                            <th>عمل</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div id="feeReceiptContainer" class="printable">
                <h3>فیس رسید</h3>
                <p><strong>رسید نمبر:</strong> <span id="receiptId"></span></p>
                <p><strong>تاریخ:</strong> <span id="receiptDate"></span></p>
                <p><strong>طالب علم کا نام:</strong> <span id="receiptStudentName"></span></p>
                <p><strong>کلاس:</strong> <span id="receiptStudentClass"></span></p>
                <p><strong>فیس کی قسم:</strong> <span id="receiptFeeType"></span></p>
                <p><strong>ادا شدہ رقم:</strong> <span id="receiptPaidAmount"></span></p>
                <p><strong>رعایت:</strong> <span id="receiptDiscount"></span></p>
                <p><strong>طریقہ:</strong> <span id="receiptMethod"></span></p>
                <p><strong>نوٹس:</strong> <span id="receiptNotes"></span></p>
                <br><br>
                <p>دستخط وصول کنندہ: _______________</p>
                <p style="font-size: 0.8em; text-align: center;">یہ کمپیوٹر سے تیار کردہ رسید ہے۔</p>
            </div>
        </div>
        <div id="attendance" class="module">
            <h2>حاضری کا انتظام</h2>
            <h3>حاضری لگائیں</h3>
            <div class="form-grid">
                <div>
                    <label for="attendanceDate">تاریخ</label>
                    <input type="date" id="attendanceDate" required>
                </div>
                <div>
                    <label for="attendanceClass">کلاس</label>
                    <select id="attendanceClass" required onchange="loadStudentsForAttendance()">
                        <option value="">-- کلاس منتخب کریں --</option>
                    </select>
                </div>
            </div>
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>داخلہ نمبر</th>
                        <th>نام</th>
                        <th>حاضری (Present/Absent)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3">براہ کرم تاریخ اور کلاس منتخب کریں۔</td>
                    </tr>
                </tbody>
            </table>
            <button onclick="saveAttendance()">حاضری محفوظ کریں</button>
            <button class="print" onclick="printAttendanceRegister()">حاضری رجسٹر پرنٹ کریں</button>
            <div id="attendancePrintContainer" class="printable">
                <h3>حاضری رجسٹر</h3>
                <p><strong>تاریخ:</strong> <span id="printAttendanceDate"></span></p>
                <p><strong>کلاس:</strong> <span id="printAttendanceClass"></span></p>
                <table id="attendancePrintTable" class="printable-content">
                    <thead>
                        <tr>
                            <th>داخلہ نمبر</th>
                            <th>نام</th>
                            <th>حالت</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="results" class="module">
            <h2>نتائج کا انتظام</h2>
            <h3>نتائج درج کریں / ترمیم کریں</h3>
            <div class="form-grid">
                <div>
                    <label for="resultExamName">امتحان کا نام</label>
                    <input type="text" id="resultExamName" placeholder="مثال: Mid Term, Final Term">
                </div>
                <div>
                    <label for="resultClass">کلاس</label>
                    <select id="resultClass" required onchange="loadStudentsAndSubjectsForResult()">
                        <option value="">-- کلاس منتخب کریں --</option>
                    </select>
                </div>
                <div>
                    <label for="resultSubject">مضمون</label>
                    <select id="resultSubject" required>
                        <option value="">-- کلاس منتخب کریں --</option>
                    </select>
                </div>
                <div>
                    <label for="resultDate">تاریخ</label>
                    <input type="date" id="resultDate">
                </div>
            </div>
            <table id="resultsEntryTable">
                <thead>
                    <tr>
                        <th>طالب علم کا نام</th>
                        <th>کل نمبر</th>
                        <th>حاصل کردہ نمبر</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3">براہ کرم امتحان، کلاس اور مضمون منتخب کریں۔</td>
                    </tr>
                </tbody>
            </table>
            <button onclick="saveResults()">نتائج محفوظ کریں</button>
            <h3>رزلٹ کارڈ دیکھیں/پرنٹ کریں</h3>
            <div class="form-grid">
                <div>
                    <label for="resultCardStudent">طالب علم</label>
                    <select id="resultCardStudent">
                        <option value="">-- طالب علم منتخب کریں --</option>
                    </select>
                </div>
                <div>
                    <label for="resultCardExam">امتحان</label>
                    <select id="resultCardExam">
                        <option value="">-- امتحان منتخب کریں --</option>
                    </select>
                </div>
            </div>
            <button class="print" onclick="printResultCard()">رزلٹ کارڈ پرنٹ کریں (منتخب طالب علم)</button>
            <div id="resultCardPrintContainer" class="printable">
                <h3>رزلٹ کارڈ</h3>
                <p><strong>امتحان:</strong> <span id="printResultExamName"></span></p>
                <p><strong>طالب علم:</strong> <span id="printResultStudentName"></span></p>
                <p><strong>کلاس:</strong> <span id="printResultClassName"></span></p>
                <table id="resultCardPrintTable" class="printable-content">
                    <thead>
                        <tr>
                            <th>مضمون</th>
                            <th>کل نمبر</th>
                            <th>حاصل کردہ نمبر</th>
                            <th>گریڈ/فیصد</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <p><strong>کل حاصل کردہ نمبر:</strong> <span id="printResultTotalObtained"></span></p>
                <p><strong>کل نمبر:</strong> <span id="printResultTotalMarks"></span></p>
                <p><strong>مجموعی فیصد:</strong> <span id="printResultOverallPercentage"></span>%</p>
                <p><strong>نتیجہ:</strong> <span id="printResultStatus"></span></p>
            </div>
        </div>
        <div id="timetable" class="module">
            <h2>ٹائم ٹیبل / ڈیوٹی روسٹر</h2>
            <h3>کلاس ٹائم ٹیبل بنائیں / ترمیم کریں</h3>
            <div class="form-grid">
                <div>
                    <label for="timetableClass">کلاس</label>
                    <select id="timetableClass" onchange="loadTimetable()">
                        <option value="">-- کلاس منتخب کریں --</option>
                    </select>
                </div>
            </div>
            <table id="classTimetableTable">
                <thead>
                    <tr>
                        <th>دن / وقت</th>
                        <th>পিরিয়ড ১ (شروع - ختم)</th>
                        <th>পিরিয়ড ২ (شروع - ختم)</th>
                        <th>পিরিয়ড ৩ (شروع - ختم)</th>
                        <th>পিরিয়ড ৪ (شروع - ختم)</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <button onclick="saveTimetable()">ٹائم ٹیبل محفوظ کریں</button>
            <h3>اساتذہ کا ڈیوٹی روسٹر دیکھیں</h3>
            <div>
                <label for="dutyRoasterTeacher">استاد منتخب کریں</label>
                <select id="dutyRoasterTeacher" onchange="loadTeacherRoaster()">
                    <option value="">-- استاد منتخب کریں --</option>
                </select>
            </div>
            <table id="teacherRoasterTable">
                <thead>
                    <tr>
                        <th>دن / وقت</th>
                        <th>পিরিয়ড ১</th>
                        <th>পিরিয়ড ২</th>
                        <th>পিরিয়ড ৩</th>
                        <th>পিরিয়ড ৪</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">براہ کرم استاد منتخب کریں۔</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="expenses" class="module">
            <h2>اخراجات کا انتظام</h2>
            <h3>نیا خرچہ شامل کریں / ترمیم کریں</h3>
            <form id="expenseForm">
                <input type="hidden" id="expenseId">
                <div class="form-grid">
                    <div>
                        <label for="expenseDate">تاریخ</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div>
                        <label for="expenseType">قسم</label>
                        <input type="text" id="expenseType" placeholder="مثال: تنخواہ, بجلی کا بل, اسٹیشنری" required>
                    </div>
                    <div>
                        <label for="expenseAmount">رقم</label>
                        <input type="number" id="expenseAmount" required>
                    </div>
                    <div>
                        <label for="expensePaidTo">ادا کیا گیا (استاد/وغیرہ)</label>
                        <input type="text" id="expensePaidTo">
                    </div>
                    <div class="full-width">
                        <label for="expenseDescription">تفصیل</label>
                        <textarea id="expenseDescription" rows="2"></textarea>
                    </div>
                </div>
                <button type="submit">محفوظ کریں</button>
                <button type="button" onclick="resetExpenseForm()">منسوخ کریں</button>
            </form>
            <h3>اخراجات کی فہرست</h3>
            <label for="expenseFilterDate">تاریخ کے لحاظ سے فلٹر کریں:</label>
            <input type="date" id="expenseFilterDate" onchange="loadExpenses()">
            <table id="expensesTable">
                <thead>
                    <tr>
                        <th>تاریخ</th>
                        <th>قسم</th>
                        <th>تفصیل</th>
                        <th>ادا کیا گیا</th>
                        <th>رقم</th>
                        <th>عمل</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div id="reports" class="module">
            <h2>رپورٹس</h2>
            <p>براہ کرم رپورٹ کی قسم منتخب کریں اور فلٹرز کا اطلاق کریں۔</p>
            <div class="form-grid">
                <div>
                    <label for="reportType">رپورٹ کی قسم:</label>
                    <select id="reportType">
                        <option value="">-- منتخب کریں --</option>
                        <option value="fee_collection">فیس وصولی رپورٹ</option>
                        <option value="outstanding_fees">واجب الادا فیس رپورٹ</option>
                        <option value="attendance_summary">حاضری خلاصہ</option>
                        <option value="expense_report">اخراجات رپورٹ</option>
                        <option value="student_list">طلباء کی فہرست (کلاس وار)</option>
                    </select>
                </div>
                <div>
                    <label for="reportStartDate">شروع تاریخ:</label>
                    <input type="date" id="reportStartDate">
                </div>
                <div>
                    <label for="reportEndDate">اختتامی تاریخ:</label>
                    <input type="date" id="reportEndDate">
                </div>
                <div>
                    <label for="reportClassFilter">کلاس (اگر قابل اطلاق ہو):</label>
                    <select id="reportClassFilter">
                        <option value="">-- تمام --</option>
                    </select>
                </div>
            </div>
            <button onclick="generateReport()">رپورٹ بنائیں</button>
            <button onclick="printReport()" class="print">رپورٹ پرنٹ کریں</button>
            <div id="reportOutput" class="printable">
                <h3>رپورٹ</h3>
                <div id="reportContent" class="printable-content">
                    <p>رپورٹ کا مواد یہاں ظاہر ہوگا۔</p>
                </div>
            </div>
        </div>
        <div id="settings" class="module">
            <h2>سیٹنگز</h2>
            <h3>ڈیٹا مینجمنٹ</h3>
            <button onclick="backupData()">ڈیٹا بیک اپ کریں (Export JSON)</button>
            <input type="file" id="importFile" accept=".json" style="display: none;">
            <button onclick="document.getElementById('importFile').click()">ڈیٹا امپورٹ کریں (Import JSON)</button>
            <p style="color: red;">نوٹ: امپورٹ کرنے سے موجودہ ڈیٹا مٹ سکتا ہے۔ پہلے بیک اپ ضرور بنا لیں۔</p>
            <h3>پرنٹ سیٹنگز</h3>
            <label for="schoolNamePrint">مدرسہ کا نام (رسیدوں/رپورٹس پر)</label>
            <input type="text" id="schoolNamePrint" placeholder="مدرسہ کا نام درج کریں">
            <button onclick="savePrintSettings()">سیٹنگز محفوظ کریں</button>
        </div>
    </div>
    <script>
        const DB_NAME = 'SchoolManagementDB';
        const DB_VERSION = 14;
        let db;
        const STORE_STUDENTS = 'students';
        const STORE_TEACHERS = 'teachers';
        const STORE_CLASSES = 'classes';
        const STORE_FEES = 'fees';
        const STORE_ATTENDANCE = 'attendance';
        const STORE_RESULTS = 'results';
        const STORE_EXPENSES = 'expenses';
        const STORE_FEE_STRUCTURES = 'feeStructures';
        const STORE_TIMETABLE = 'timetable';
        const STORE_SETTINGS = 'settings';
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => {
                    console.error("Database error:", event.target.errorCode);
                    reject("Database error: " + event.target.errorCode);
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Database opened successfully");

                    window.db = db;
                    window.addData = addData;
                    window.updateData = updateData;
                    window.getById = getById;
                    window.getAll = getAll;
                    window.getObjectStore = getObjectStore;

                    window.getClassName = getClassName;
                    window.getTeacherName = getTeacherName;
                    window.getStudentName = getStudentName;
                    window.showModule = showModule;
                    window.loadDashboardStats = loadDashboardStats;


                    window.STORE_SETTINGS = STORE_SETTINGS;
                    window.STORE_TEACHERS = STORE_TEACHERS;
                    window.STORE_CLASSES = STORE_CLASSES;
                    window.STORE_STUDENTS = STORE_STUDENTS;
                    window.STORE_FEE_STRUCTURES = STORE_FEE_STRUCTURES;
                    window.STORE_FEES = STORE_FEES;
                    window.STORE_ATTENDANCE = STORE_ATTENDANCE;
                    window.STORE_RESULTS = STORE_RESULTS;
                    window.STORE_TIMETABLE = STORE_TIMETABLE;
                    window.STORE_EXPENSES = STORE_EXPENSES;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    console.log("Upgrading database...");
                    const upgradeTransaction = event.target.transaction;
                    if (!db.objectStoreNames.contains(STORE_STUDENTS)) {
                        const studentStore = db.createObjectStore(STORE_STUDENTS, { keyPath: 'id', autoIncrement: true });
                        studentStore.createIndex('admissionNo', 'admissionNo', { unique: true });
                        studentStore.createIndex('name', 'name', { unique: false });
                        studentStore.createIndex('classId', 'classId', { unique: false });
                    } else {
                        const studentStore = upgradeTransaction.objectStore(STORE_STUDENTS);
                        if (!studentStore.indexNames.contains('classId')) {
                            studentStore.createIndex('classId', 'classId', { unique: false });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_TEACHERS)) {
                        const teacherStore = db.createObjectStore(STORE_TEACHERS, { keyPath: 'id', autoIncrement: true });
                        teacherStore.createIndex('name', 'name', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_CLASSES)) {
                        const classStore = db.createObjectStore(STORE_CLASSES, { keyPath: 'id', autoIncrement: true });
                        classStore.createIndex('name', 'name', { unique: true });
                        classStore.createIndex('teacherId', 'teacherId', { unique: false });
                    } else {
                        const classStore = upgradeTransaction.objectStore(STORE_CLASSES);
                        if (!classStore.indexNames.contains('teacherId')) {
                            classStore.createIndex('teacherId', 'teacherId', { unique: false });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_FEE_STRUCTURES)) {
                        const feeStructureStore = db.createObjectStore(STORE_FEE_STRUCTURES, { keyPath: 'id', autoIncrement: true });
                        feeStructureStore.createIndex('classId_feeType', ['classId', 'feeType'], { unique: true });
                        feeStructureStore.createIndex('classId', 'classId', { unique: false });
                    } else {
                        const feeStructureStore = upgradeTransaction.objectStore(STORE_FEE_STRUCTURES);
                        if (!feeStructureStore.indexNames.contains('classId')) {
                            feeStructureStore.createIndex('classId', 'classId', { unique: false });
                        }
                        if (!feeStructureStore.indexNames.contains('classId_feeType')) {
                            try { feeStructureStore.deleteIndex('classId_feeType'); } catch (e) { }
                            feeStructureStore.createIndex('classId_feeType', ['classId', 'feeType'], { unique: true });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_FEES)) {
                        const feeStore = db.createObjectStore(STORE_FEES, { keyPath: 'id', autoIncrement: true });
                        feeStore.createIndex('studentId', 'studentId', { unique: false });
                        feeStore.createIndex('date', 'date', { unique: false });
                        feeStore.createIndex('studentId_date', ['studentId', 'date'], { unique: false });
                    } else {
                        const feeStore = upgradeTransaction.objectStore(STORE_FEES);
                        if (!feeStore.indexNames.contains('studentId_date')) {
                            feeStore.createIndex('studentId_date', ['studentId', 'date'], { unique: false });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_ATTENDANCE)) {
                        const attendanceStore = db.createObjectStore(STORE_ATTENDANCE, { keyPath: 'id', autoIncrement: true });
                        attendanceStore.createIndex('date_classId', ['date', 'classId'], { unique: false });
                        attendanceStore.createIndex('date_classId_studentId', ['date', 'classId', 'studentId'], { unique: true });
                    } else {
                        const attendanceStore = upgradeTransaction.objectStore(STORE_ATTENDANCE);
                        if (!attendanceStore.indexNames.contains('date_classId_studentId')) {
                            try { attendanceStore.deleteIndex('date_classId_studentId'); } catch (e) { }
                            attendanceStore.createIndex('date_classId_studentId', ['date', 'classId', 'studentId'], { unique: true });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_RESULTS)) {
                        const resultStore = db.createObjectStore(STORE_RESULTS, { keyPath: 'id', autoIncrement: true });
                        resultStore.createIndex('exam_class_subject_student', ['examName', 'classId', 'subject', 'studentId'], { unique: true });
                        resultStore.createIndex('studentId', 'studentId', { unique: false });
                        resultStore.createIndex('examName', 'examName', { unique: false });
                    } else {
                        const resultStore = upgradeTransaction.objectStore(STORE_RESULTS);
                        if (!resultStore.indexNames.contains('exam_class_subject_student')) {
                            try { resultStore.deleteIndex('exam_class_subject_student'); } catch (e) { }
                            resultStore.createIndex('exam_class_subject_student', ['examName', 'classId', 'subject', 'studentId'], { unique: true });
                        }
                        if (!resultStore.indexNames.contains('studentId')) {
                            resultStore.createIndex('studentId', 'studentId', { unique: false });
                        }
                        if (!resultStore.indexNames.contains('examName')) {
                            resultStore.createIndex('examName', 'examName', { unique: false });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_EXPENSES)) {
                        const expenseStore = db.createObjectStore(STORE_EXPENSES, { keyPath: 'id', autoIncrement: true });
                        expenseStore.createIndex('date', 'date', { unique: false });
                    }
                    if (!db.objectStoreNames.contains(STORE_TIMETABLE)) {
                        const timetableStore = db.createObjectStore(STORE_TIMETABLE, { keyPath: 'id', autoIncrement: true });
                        timetableStore.createIndex('classId_day_period', ['classId', 'day', 'period'], { unique: true });
                        timetableStore.createIndex('classId', 'classId', { unique: false });
                        timetableStore.createIndex('teacherId', 'teacherId', { unique: false });
                    } else {
                        const timetableStore = upgradeTransaction.objectStore(STORE_TIMETABLE);
                        if (!timetableStore.indexNames.contains('classId')) {
                            timetableStore.createIndex('classId', 'classId', { unique: false });
                        }
                        if (!timetableStore.indexNames.contains('teacherId')) {
                            timetableStore.createIndex('teacherId', 'teacherId', { unique: false });
                        }
                        if (!timetableStore.indexNames.contains('classId_day_period')) {
                            try { timetableStore.deleteIndex('classId_day_period'); } catch (e) { }
                            timetableStore.createIndex('classId_day_period', ['classId', 'day', 'period'], { unique: true });
                        }
                    }
                    if (!db.objectStoreNames.contains(STORE_SETTINGS)) {
                        const settingsStore = db.createObjectStore(STORE_SETTINGS, { keyPath: 'key' });
                    }
                    console.log("Database upgrade complete");
                };
            });
        }
        function populateDashboardDateSelectors() {
            const monthSelect = document.getElementById('dashboardReportMonth');
            if (monthSelect.options.length <= 1) {
                const urduMonths = ["جنوری", "فروری", "مارچ", "اپریل", "مئی", "جون", "جولائی", "اگست", "ستمبر", "اکتوبر", "نومبر", "دسمبر"];
                monthSelect.innerHTML = '';
                urduMonths.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
                monthSelect.value = new Date().getMonth() + 1;
            }
            const yearInput = document.getElementById('dashboardReportYear');
            if (!yearInput.value) {
                yearInput.value = new Date().getFullYear();
            }
        }
        function toggleDashboardReportInputs() {
            const reportType = document.getElementById('dashboardReportType').value;
            const monthDiv = document.getElementById('dashboardMonthSelectorDiv');
            const yearDiv = document.getElementById('dashboardYearSelectorDiv');
            const dateRangeDiv = document.getElementById('dashboardDateRangeSelectorDiv');
            monthDiv.style.display = 'none';
            yearDiv.style.display = 'none';
            dateRangeDiv.style.display = 'none';
            if (reportType === 'monthly') {
                monthDiv.style.display = 'block';
                yearDiv.style.display = 'block';
            } else if (reportType === 'yearly') {
                yearDiv.style.display = 'block';
            } else if (reportType === 'custom_range') {
                dateRangeDiv.style.display = 'grid';
            }
        }
        async function generateDashboardDetailedReport() {
            const reportType = document.getElementById('dashboardReportType').value;
            const reportTitleEl = document.getElementById('dashboardReportTitle');
            let startDate, endDate;
            let titlePeriod = "";
            if (reportType === 'monthly') {
                const month = parseInt(document.getElementById('dashboardReportMonth').value);
                const year = parseInt(document.getElementById('dashboardReportYear').value);
                if (!month || !year) { alert('براہ کرم مہینہ اور سال منتخب کریں۔'); return; }
                startDate = new Date(year, month - 1, 1);
                endDate = new Date(year, month, 0);
                titlePeriod = `${document.getElementById('dashboardReportMonth').options[month - 1].text} ${year}`;
            } else if (reportType === 'yearly') {
                const year = parseInt(document.getElementById('dashboardReportYear').value);
                if (!year) { alert('براہ کرم سال منتخب کریں۔'); return; }
                startDate = new Date(year, 0, 1);
                endDate = new Date(year, 11, 31);
                titlePeriod = `سال ${year}`;
            } else if (reportType === 'custom_range') {
                const startStr = document.getElementById('dashboardReportStartDate').value;
                const endStr = document.getElementById('dashboardReportEndDate').value;
                if (!startStr || !endStr) { alert('براہ کرم شروع اور اختتامی تاریخ منتخب کریں۔'); return; }
                startDate = new Date(startStr);
                endDate = new Date(endStr);
                endDate.setHours(23, 59, 59, 999);
                titlePeriod = `${startStr} سے ${endStr}`;
            }
            reportTitleEl.textContent = `${titlePeriod} کے لیے خلاصہ:`;
            const startDateString = startDate.toISOString().split('T')[0];
            const endDateString = endDate.toISOString().split('T')[0];
            try {
                const allTransactions = await getAll(STORE_EXPENSES);
                const allStudents = await getAll(STORE_STUDENTS);
                const periodTransactions = allTransactions.filter(t => t.date >= startDateString && t.date <= endDateString);
                const periodIncome = periodTransactions.filter(t => t.recordType === 'income');
                const periodExpenses = periodTransactions.filter(t => t.recordType === 'expense');
                const periodNewAdmissions = allStudents.filter(std => std.admissionDate >= startDateString && std.admissionDate <= endDateString);
                const totalPeriodIncome = periodIncome.reduce((sum, inc) => sum + inc.amount, 0);
                const totalPeriodExpenses = periodExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const netProfit = totalPeriodIncome - totalPeriodExpenses;
                document.getElementById('periodTotalFees').textContent = totalPeriodIncome.toLocaleString();
                document.getElementById('periodTotalExpenses').textContent = totalPeriodExpenses.toLocaleString();
                document.getElementById('periodNetProfit').textContent = netProfit.toLocaleString();
                document.getElementById('periodNewAdmissions').textContent = periodNewAdmissions.length;
            } catch (error) {
                console.error("Error generating dashboard detailed report:", error);
                alert("رپورٹ بنانے میں خرابی۔");
                document.getElementById('periodTotalFees').textContent = 'خرابی';
                document.getElementById('periodTotalExpenses').textContent = 'خرابی';
                document.getElementById('periodNetProfit').textContent = 'خرابی';
                document.getElementById('periodNewAdmissions').textContent = 'خرابی';
            }
        }

        function showModule(moduleId) {
            document.querySelectorAll('.module').forEach(module => module.classList.remove('active', 'printable'));
            document.getElementById(moduleId).classList.add('active');
            document.querySelectorAll('nav button').forEach(button => {
                button.classList.remove('active');
                const moduleName = document.querySelector(`#${moduleId} h2`)?.textContent || '';
                if (button.textContent === moduleName ||
                    (moduleId === 'dashboard' && button.textContent === 'ڈیش بورڈ') ||
                    (moduleId === 'students' && button.textContent === 'طلباء') ||
                    (moduleId === 'teachers' && button.textContent === 'اساتذہ') ||
                    (moduleId === 'classes' && button.textContent === 'کلاسیں') ||
                    (moduleId === 'feeStructures' && button.textContent === 'فیس اسٹرکچر') ||
                    (moduleId === 'fees' && button.textContent === 'فیس') ||
                    (moduleId === 'attendance' && button.textContent === 'حاضری') ||
                    (moduleId === 'results' && button.textContent === 'نتائج') ||
                    (moduleId === 'timetable' && button.textContent === 'ٹائم ٹیبل / ڈیوٹی روسٹر') ||
                    (moduleId === 'expenses' && button.textContent === 'اخراجات') ||
                    (moduleId === 'reports' && button.textContent === 'رپورٹس') ||
                    (moduleId === 'settings' && button.textContent === 'سیٹنگز')) {
                    button.classList.add('active');
                }
            });
            if (moduleId === 'students') loadStudents();
            if (moduleId === 'teachers') loadTeachers();
            if (moduleId === 'classes') loadClasses();
            if (moduleId === 'fees') { loadStudentsForFeeSelect(); loadStudentFeeDetails(); }
            if (moduleId === 'attendance') { loadClassesForAttendance(); loadStudentsForAttendance(); }
            if (moduleId === 'results') {
                createResultsModule();
                loadClassesForResults();
                loadStudentsForResultCard();
                loadExamsForResultCard();
                loadPastResults();
            }
            if (moduleId === 'expenses') {
                if (typeof window.loadTransactions === 'function') {
                    window.loadTransactions();
                    const transactionDateInput = document.getElementById('transactionDate');
                    const transactionRecordTypeSel = document.getElementById('transactionRecordType');
                    if (transactionDateInput) transactionDateInput.value = new Date().toISOString().split('T')[0];
                    if (transactionRecordTypeSel) transactionRecordTypeSel.value = 'expense';
                    if (typeof window.toggleTransactionFields === 'function') window.toggleTransactionFields();
                } else {
                    console.warn("loadTransactions function not yet defined when trying to show 'expenses' module.");
                }
            }
            if (moduleId === 'feeStructures') { loadClassesForFeeStructureFilter(); loadFeeStructures(); }
            if (moduleId === 'timetable') { loadClassesForTimetable(); loadTeachersForRoaster(); loadTimetable(); }

            if (moduleId === 'dashboard') {
                loadDashboardStats();
                populateDashboardDateSelectors();
                toggleDashboardReportInputs();

                document.getElementById('dashboardReportTitle').textContent = "منتخب مدت کے لیے خلاصہ:";
                document.getElementById('periodTotalFees').textContent = '0';
                document.getElementById('periodTotalExpenses').textContent = '0';
                document.getElementById('periodNetProfit').textContent = '0';
                document.getElementById('periodNewAdmissions').textContent = '0';
            }
            if (moduleId === 'reports') loadClassesForReportFilter();
            if (moduleId === 'settings') loadPrintSettings();
            loadClassesForStudentForm();
            loadTeachersForClassForm();
        }
        async function getObjectStore(storeName, mode) {
            if (!db) await openDatabase();
            const transaction = db.transaction(storeName, mode);
            transaction.onerror = event => console.error(`Transaction error on ${storeName}:`, event.target.error);
            return transaction.objectStore(storeName);
        }
        async function getAll(storeName, indexName = null, query = null) {
            const store = await getObjectStore(storeName, 'readonly');
            const request = indexName ? store.index(indexName).getAll(query) : store.getAll();
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                    console.error(`Error getting all from ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        async function getById(storeName, id) {
            const store = await getObjectStore(storeName, 'readonly');
            const request = store.get(id);
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        async function addData(storeName, data) {
            const store = await getObjectStore(storeName, 'readwrite');
            const request = store.add(data);
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                    console.error(`Error adding data to ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        async function updateData(storeName, data) {
            const store = await getObjectStore(storeName, 'readwrite');
            const request = store.put(data);
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => {
                    console.error(`Error updating data in ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        async function deleteData(storeName, id) {
            const store = await getObjectStore(storeName, 'readwrite');
            const request = store.delete(id);
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error(`Error deleting data from ${storeName}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        }
        async function clearStore(storeName) {
            const store = await getObjectStore(storeName, 'readwrite');
            const request = store.clear();
            return new Promise((resolve, reject) => {
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        async function loadClassesIntoSelect(selectElementId, addDefaultOption = true) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = addDefaultOption ? '<option value="">-- منتخب کریں --</option>' : '';
            try {
                const classes = await getAll(STORE_CLASSES);
                classes.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading classes into select:", error);
            }
        }
        async function loadTeachersIntoSelect(selectElementId, addDefaultOption = true) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = addDefaultOption ? '<option value="">-- منتخب کریں --</option>' : '';
            try {
                const teachers = await getAll(STORE_TEACHERS);
                teachers.sort((a, b) => a.name.localeCompare(b.name));
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading teachers into select:", error);
            }
        }
        async function loadStudentsIntoSelect(selectElementId, filterByClassId = null, addDefaultOption = true) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = addDefaultOption ? '<option value="">-- طالب علم منتخب کریں --</option>' : '';
            try {
                let students;
                if (filterByClassId) {
                    students = await getAll(STORE_STUDENTS, 'classId', parseInt(filterByClassId));
                } else {
                    students = await getAll(STORE_STUDENTS);
                }
                students.sort((a, b) => a.name.localeCompare(b.name));
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.admissionNo})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading students into select:", error);
            }
        }
        async function getClassName(classId) {
            if (!classId) return 'N/A';
            try {
                const cls = await getById(STORE_CLASSES, parseInt(classId));
                return cls ? cls.name : 'Unknown';
            } catch (error) {
                console.error("Error getting class name:", error);
                return 'Error';
            }
        }
        async function getTeacherName(teacherId) {
            if (!teacherId) return 'N/A';
            try {
                const teacher = await getById(STORE_TEACHERS, parseInt(teacherId));
                return teacher ? teacher.name : 'Unknown';
            } catch (error) {
                console.error("Error getting teacher name:", error);
                return 'Error';
            }
        }
        async function getStudentName(studentId) {
            if (!studentId) return 'N/A';
            try {
                const student = await getById(STORE_STUDENTS, parseInt(studentId));
                return student ? student.name : 'Unknown';
            } catch (error) {
                console.error("Error getting student name:", error);
                return 'Error';
            }
        }
        async function getStudentDetails(studentId) {
            if (!studentId) return null;
            try {
                return await getById(STORE_STUDENTS, parseInt(studentId));
            } catch (error) {
                console.error("Error getting student details:", error);
                return null;
            }
        }
        async function loadDashboardStats() {
            try {
                const students = await getAll(STORE_STUDENTS);
                const teachers = await getAll(STORE_TEACHERS);
                const classes = await getAll(STORE_CLASSES);
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('totalTeachers').textContent = teachers.length;
                document.getElementById('totalClasses').textContent = classes.length;
                const today = new Date().toISOString().split('T')[0];

                const allTransactions = await getAll(STORE_EXPENSES);

                const transactionsToday = allTransactions.filter(t => t.date === today);
                const incomeToday = transactionsToday.filter(t => t.recordType === 'income');
                const expensesToday = transactionsToday.filter(t => t.recordType === 'expense');
                const totalIncomeToday = incomeToday.reduce((sum, inc) => sum + inc.amount, 0);
                const totalExpensesToday = expensesToday.reduce((sum, exp) => sum + exp.amount, 0);

                document.getElementById('todayFees').textContent = totalIncomeToday.toLocaleString();
                document.getElementById('todayExpenses').textContent = totalExpensesToday.toLocaleString();
            } catch (error) {
                console.error("Error loading dashboard stats:", error);
                document.getElementById('todayFees').textContent = 'خرابی';
                document.getElementById('todayExpenses').textContent = 'خرابی';
            }
        }
        const studentForm = document.getElementById('studentForm');
        const studentTableBody = document.getElementById('studentsTable').querySelector('tbody');
        const studentSearchInput = document.getElementById('studentSearch');
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value;
            const student = {
                admissionNo: document.getElementById('admissionNo').value,
                name: document.getElementById('studentName').value,
                fatherName: document.getElementById('fatherName').value,
                classId: parseInt(document.getElementById('studentClass').value),
                admissionDate: document.getElementById('admissionDate').value,
                contact: document.getElementById('studentContact').value,
                address: document.getElementById('studentAddress').value,
            };
            try {
                if (studentId) {
                    student.id = parseInt(studentId);
                    await updateData(STORE_STUDENTS, student);
                    alert('طالب علم کی معلومات اپ ڈیٹ ہو گئی۔');
                } else {

                    const store = await getObjectStore(STORE_STUDENTS, 'readonly');
                    const index = store.index('admissionNo');
                    const request = index.get(student.admissionNo);
                    request.onsuccess = async () => {
                        if (request.result) {
                            alert('یہ داخلہ نمبر پہلے سے موجود ہے۔');
                        } else {
                            await addData(STORE_STUDENTS, student);
                            alert('نیا طالب علم شامل ہو گیا۔');
                        }
                        resetStudentForm();
                        loadStudents();
                        loadDashboardStats();
                    };
                    request.onerror = (event) => {
                        console.error("Error checking admission number uniqueness:", event.target.error);
                        alert('ڈیٹا بیس میں خرابی۔');
                    };

                    return;
                }
                resetStudentForm();
                loadStudents();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving student:", error);
                alert('طالب علم کو محفوظ کرنے میں خرابی: ' + error);
            }
        });
        function resetStudentForm() {
            studentForm.reset();
            document.getElementById('studentId').value = '';
        }
        async function loadStudents() {
            studentTableBody.innerHTML = '<tr><td colspan="6">لوڈ ہو رہا ہے...</td></tr>';
            const searchTerm = studentSearchInput.value.toLowerCase();
            try {
                const students = await getAll(STORE_STUDENTS);
                const classes = await getAll(STORE_CLASSES);
                const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
                studentTableBody.innerHTML = '';
                students
                    .filter(student =>
                        student.name.toLowerCase().includes(searchTerm) ||
                        student.admissionNo.toLowerCase().includes(searchTerm)
                    )
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(student => {
                        const row = studentTableBody.insertRow();
                        row.innerHTML = `
                            <td>${student.admissionNo}</td>
                            <td>${student.name}</td>
                            <td>${student.fatherName}</td>
                            <td>${classMap[student.classId] || 'N/A'}</td>
                            <td>${student.admissionDate}</td>
                            <td>
                                <button class="edit" onclick="editStudent(${student.id})">ترمیم</button>
                                <button class="delete" onclick="deleteStudent(${student.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                if (studentTableBody.rows.length === 0) {
                    studentTableBody.innerHTML = '<tr><td colspan="6">کوئی طالب علم نہیں ملا۔</td></tr>';
                }
            } catch (error) {
                console.error("Error loading students:", error);
                studentTableBody.innerHTML = '<tr><td colspan="6">طلباء کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        async function editStudent(id) {
            try {
                const student = await getById(STORE_STUDENTS, id);
                if (student) {
                    document.getElementById('studentId').value = student.id;
                    document.getElementById('admissionNo').value = student.admissionNo;
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('fatherName').value = student.fatherName;
                    document.getElementById('studentClass').value = student.classId;
                    document.getElementById('admissionDate').value = student.admissionDate;
                    document.getElementById('studentContact').value = student.contact || '';
                    document.getElementById('studentAddress').value = student.address || '';
                    showModule('students');
                    window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching student for edit:", error);
                alert('ترمیم کے لیے طالب علم لانے میں خرابی۔');
            }
        }
        async function deleteStudent(id) {
            if (confirm('کیا آپ واقعی اس طالب علم کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await deleteData(STORE_STUDENTS, id);

                    alert('طالب علم حذف ہو گیا۔');
                    loadStudents();
                    loadDashboardStats();
                } catch (error) {
                    console.error("Error deleting student:", error);
                    alert('طالب علم کو حذف کرنے میں خرابی۔');
                }
            }
        }
        async function loadClassesForStudentForm() {
            await loadClassesIntoSelect('studentClass');
        }
        const teacherForm = document.getElementById('teacherForm');
        const teacherTableBody = document.getElementById('teachersTable').querySelector('tbody');
        teacherForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const teacherId = document.getElementById('teacherId').value;
            const teacher = {
                name: document.getElementById('teacherName').value,
                subjects: document.getElementById('teacherSubjects').value,
                contact: document.getElementById('teacherContact').value,
                salary: parseFloat(document.getElementById('teacherSalary').value),
                appointmentDate: document.getElementById('appointmentDate').value,
                qualification: document.getElementById('teacherQualification').value,
            };
            try {
                if (teacherId) {
                    teacher.id = parseInt(teacherId);
                    await updateData(STORE_TEACHERS, teacher);
                    alert('استاد کی معلومات اپ ڈیٹ ہو گئیں۔');
                } else {
                    await addData(STORE_TEACHERS, teacher);
                    alert('نیا استاد شامل ہو گیا۔');
                }
                resetTeacherForm();
                loadTeachers();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving teacher:", error);
                alert('استاد کو محفوظ کرنے میں خرابی۔');
            }
        });
        function resetTeacherForm() {
            teacherForm.reset();
            document.getElementById('teacherId').value = '';
        }
        async function loadTeachers() {
            teacherTableBody.innerHTML = '<tr><td colspan="6">لوڈ ہو رہا ہے...</td></tr>';
            try {
                const teachers = await getAll(STORE_TEACHERS);
                teacherTableBody.innerHTML = '';
                teachers
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(teacher => {
                        const row = teacherTableBody.insertRow();
                        row.innerHTML = `
                            <td>${teacher.name}</td>
                            <td>${teacher.subjects}</td>
                            <td>${teacher.contact}</td>
                            <td>${teacher.salary}</td>
                            <td>${teacher.appointmentDate}</td>
                            <td>
                                <button class="edit" onclick="editTeacher(${teacher.id})">ترمیم</button>
                                <button class="delete" onclick="deleteTeacher(${teacher.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                if (teachers.length === 0) {
                    teacherTableBody.innerHTML = '<tr><td colspan="6">کوئی استاد نہیں ملا۔</td></tr>';
                }
            } catch (error) {
                console.error("Error loading teachers:", error);
                teacherTableBody.innerHTML = '<tr><td colspan="6">اساتذہ کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        async function editTeacher(id) {
            try {
                const teacher = await getById(STORE_TEACHERS, id);
                if (teacher) {
                    document.getElementById('teacherId').value = teacher.id;
                    document.getElementById('teacherName').value = teacher.name;
                    document.getElementById('teacherSubjects').value = teacher.subjects;
                    document.getElementById('teacherContact').value = teacher.contact;
                    document.getElementById('teacherSalary').value = teacher.salary;
                    document.getElementById('appointmentDate').value = teacher.appointmentDate;
                    document.getElementById('teacherQualification').value = teacher.qualification || '';
                    showModule('teachers');
                    window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching teacher for edit:", error);
                alert('ترمیم کے لیے استاد لانے میں خرابی۔');
            }
        }
        async function deleteTeacher(id) {
            if (confirm('کیا آپ واقعی اس استاد کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await deleteData(STORE_TEACHERS, id);

                    alert('استاد حذف ہو گیا۔');
                    loadTeachers();
                    loadDashboardStats();
                    loadTeachersForClassForm();
                    loadTeachersForRoaster();
                } catch (error) {
                    console.error("Error deleting teacher:", error);
                    alert('استاد کو حذف کرنے میں خرابی۔');
                }
            }
        }
        const classForm = document.getElementById('classForm');
        const classTableBody = document.getElementById('classesTable').querySelector('tbody');
        classForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const classId = document.getElementById('classId').value;
            const subjectsArray = document.getElementById('classSubjects').value.split(',').map(s => s.trim()).filter(s => s);
            const cls = {
                name: document.getElementById('className').value,
                teacherId: parseInt(document.getElementById('classTeacher').value),
                subjects: subjectsArray,
            };
            try {
                if (classId) {
                    cls.id = parseInt(classId);
                    await updateData(STORE_CLASSES, cls);
                    alert('کلاس کی معلومات اپ ڈیٹ ہو گئیں۔');
                } else {

                    const store = await getObjectStore(STORE_CLASSES, 'readonly');
                    const index = store.index('name');
                    const request = index.get(cls.name);
                    request.onsuccess = async () => {
                        if (request.result) {
                            alert('اس نام کی کلاس پہلے سے موجود ہے۔');
                        } else {
                            await addData(STORE_CLASSES, cls);
                            alert('نئی کلاس شامل ہو گئی۔');
                        }
                        resetClassForm();
                        loadClasses();
                        loadDashboardStats();
                        loadClassesForStudentForm();
                        loadClassesForAttendance();
                        loadClassesForResults();
                        loadClassesForFeeStructureFilter();
                        loadClassesForTimetable();
                        loadClassesForReportFilter();
                    };
                    request.onerror = (event) => {
                        console.error("Error checking class name uniqueness:", event.target.error);
                        alert('ڈیٹا بیس میں خرابی۔');
                    };
                    return;
                }
                resetClassForm();
                loadClasses();
                loadDashboardStats();
                loadClassesForStudentForm();
                loadClassesForAttendance();
                loadClassesForResults();
                loadClassesForFeeStructureFilter();
                loadClassesForTimetable();
                loadClassesForReportFilter();
            } catch (error) {
                console.error("Error saving class:", error);
                alert('کلاس کو محفوظ کرنے میں خرابی: ' + error);
            }
        });
        function resetClassForm() {
            classForm.reset();
            document.getElementById('classId').value = '';
        }
        async function loadClasses() {
            classTableBody.innerHTML = '<tr><td colspan="4">لوڈ ہو رہا ہے...</td></tr>';
            try {
                const classes = await getAll(STORE_CLASSES);
                const teachers = await getAll(STORE_TEACHERS);
                const teacherMap = teachers.reduce((map, teacher) => { map[teacher.id] = teacher.name; return map; }, {});
                classTableBody.innerHTML = '';
                classes
                    .sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }))
                    .forEach(cls => {
                        const row = classTableBody.insertRow();
                        row.innerHTML = `
                            <td>${cls.name}</td>
                            <td>${teacherMap[cls.teacherId] || 'N/A'}</td>
                             <td>${cls.subjects ? cls.subjects.join(', ') : ''}</td>
                            <td>
                                <button class="edit" onclick="editClass(${cls.id})">ترمیم</button>
                                <button class="delete" onclick="deleteClass(${cls.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                if (classes.length === 0) {
                    classTableBody.innerHTML = '<tr><td colspan="4">کوئی کلاس نہیں ملی۔</td></tr>';
                }
            } catch (error) {
                console.error("Error loading classes:", error);
                classTableBody.innerHTML = '<tr><td colspan="4">کلاسوں کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        async function editClass(id) {
            try {
                const cls = await getById(STORE_CLASSES, id);
                if (cls) {
                    document.getElementById('classId').value = cls.id;
                    document.getElementById('className').value = cls.name;
                    document.getElementById('classTeacher').value = cls.teacherId;
                    document.getElementById('classSubjects').value = cls.subjects ? cls.subjects.join(', ') : '';
                    showModule('classes');
                    window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching class for edit:", error);
                alert('ترمیم کے لیے کلاس لانے میں خرابی۔');
            }
        }
        async function deleteClass(id) {
            if (confirm('کیا آپ واقعی اس کلاس کو حذف کرنا چاہتے ہیں؟ اس سے متعلقہ طلباء، فیس اسٹرکچر، حاضری، نتائج اور ٹائم ٹیبل بھی متاثر ہو سکتے ہیں۔')) {
                try {

                    const studentsInClass = await getAll(STORE_STUDENTS, 'classId', id);
                    if (studentsInClass.length > 0) {
                        alert(`کلاس حذف نہیں کی جا سکتی کیونکہ اس میں ${studentsInClass.length} طلباء ہیں۔ پہلے طلباء کو منتقل کریں یا حذف کریں۔`);
                        return;
                    }

                    const feeStructuresInClass = await getAll(STORE_FEE_STRUCTURES, 'classId', id);
                    if (feeStructuresInClass.length > 0) {
                        alert(`کلاس حذف نہیں کی جا سکتی کیونکہ اس کے لیے فیس اسٹرکچر موجود ہیں۔ پہلے فیس اسٹرکچر حذف کریں۔`);
                        return;
                    }

                    await deleteData(STORE_CLASSES, id);
                    alert('کلاس حذف ہو گئی۔');
                    loadClasses();
                    loadDashboardStats();
                    loadClassesForStudentForm();
                    loadClassesForAttendance();
                    loadClassesForResults();
                    loadClassesForFeeStructureFilter();
                    loadClassesForTimetable();
                    loadClassesForReportFilter();
                } catch (error) {
                    console.error("Error deleting class:", error);
                    alert('کلاس کو حذف کرنے میں خرابی۔');
                }
            }
        }
        async function loadTeachersForClassForm() {
            await loadTeachersIntoSelect('classTeacher');
        }

        const feeStructureForm = document.getElementById('feeStructureForm');
        const feeStructuresTableBody = document.getElementById('feeStructuresTable').querySelector('tbody');
        const filterFeeStructureClassSelect = document.getElementById('filterFeeStructureClass');
        feeStructureForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const structureId = document.getElementById('feeStructureId').value;
            const structure = {
                classId: parseInt(document.getElementById('feeStructureClass').value),
                feeType: document.getElementById('feeType').value.trim(),
                amount: parseFloat(document.getElementById('feeAmount').value),
            };
            if (!structure.classId || !structure.feeType || isNaN(structure.amount) || structure.amount <= 0) {
                alert('براہ کرم تمام فیلڈز درست طریقے سے بھریں۔');
                return;
            }
            try {
                const indexKey = [structure.classId, structure.feeType];
                const store = await getObjectStore(STORE_FEE_STRUCTURES, 'readwrite');
                const index = store.index('classId_feeType');
                const request = index.get(IDBKeyRange.only(indexKey));
                request.onsuccess = async () => {
                    const existing = request.result;
                    if (existing && (!structureId || parseInt(structureId) !== existing.id)) {
                        alert('اس کلاس کے لیے یہ فیس کی قسم پہلے سے موجود ہے۔');
                        return;
                    }
                    if (structureId) {
                        structure.id = parseInt(structureId);
                        await updateData(STORE_FEE_STRUCTURES, structure);
                        alert('فیس اسٹرکچر اپ ڈیٹ ہو گیا۔');
                    } else {
                        await addData(STORE_FEE_STRUCTURES, structure);
                        alert('نیا فیس اسٹرکچر شامل ہو گیا۔');
                    }
                    resetFeeStructureForm();
                    loadFeeStructures();
                };
                request.onerror = (event) => {
                    console.error("Error checking fee structure uniqueness:", event.target.error);
                    alert('ڈیٹا بیس میں خرابی۔');
                };
            } catch (error) {
                console.error("Error saving fee structure:", error);
                alert('فیس اسٹرکچر کو محفوظ کرنے میں خرابی: ' + error.message);
            }
        });
        function resetFeeStructureForm() {
            feeStructureForm.reset();
            document.getElementById('feeStructureId').value = '';
        }
        async function loadFeeStructures() {
            feeStructuresTableBody.innerHTML = '<tr><td colspan="4">لوڈ ہو رہا ہے...</td></tr>';
            const filterClassId = filterFeeStructureClassSelect.value ? parseInt(filterFeeStructureClassSelect.value) : null;
            try {
                let structures;
                if (filterClassId) {
                    structures = await getAll(STORE_FEE_STRUCTURES, 'classId', filterClassId);
                } else {
                    structures = await getAll(STORE_FEE_STRUCTURES);
                }
                const classes = await getAll(STORE_CLASSES);
                const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
                feeStructuresTableBody.innerHTML = '';
                structures
                    .sort((a, b) => {
                        const classCompare = (classMap[a.classId] || '').localeCompare(classMap[b.classId] || '', undefined, { numeric: true });
                        if (classCompare !== 0) return classCompare;
                        return a.feeType.localeCompare(b.feeType);
                    })
                    .forEach(structure => {
                        const row = feeStructuresTableBody.insertRow();
                        row.innerHTML = `
                            <td>${classMap[structure.classId] || 'N/A'}</td>
                            <td>${structure.feeType}</td>
                            <td>${structure.amount.toLocaleString()}</td>
                            <td>
                                <button class="edit" onclick="editFeeStructure(${structure.id})">ترمیم</button>
                                <button class="delete" onclick="deleteFeeStructure(${structure.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                if (structures.length === 0) {
                    feeStructuresTableBody.innerHTML = '<tr><td colspan="4">کوئی فیس اسٹرکچر نہیں ملا۔</td></tr>';
                }
            } catch (error) {
                console.error("Error loading fee structures:", error);
                feeStructuresTableBody.innerHTML = '<tr><td colspan="4">فیس اسٹرکچر کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        async function editFeeStructure(id) {
            try {
                const structure = await getById(STORE_FEE_STRUCTURES, id);
                if (structure) {
                    document.getElementById('feeStructureId').value = structure.id;
                    document.getElementById('feeStructureClass').value = structure.classId;
                    document.getElementById('feeType').value = structure.feeType;
                    document.getElementById('feeAmount').value = structure.amount;
                    showModule('feeStructures');
                    window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching fee structure for edit:", error);
                alert('ترمیم کے لیے فیس اسٹرکچر لانے میں خرابی۔');
            }
        }
        async function deleteFeeStructure(id) {
            if (confirm('کیا آپ واقعی اس فیس اسٹرکچر کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await deleteData(STORE_FEE_STRUCTURES, id);
                    alert('فیس اسٹرکچر حذف ہو گیا۔');
                    loadFeeStructures();
                } catch (error) {
                    console.error("Error deleting fee structure:", error);
                    alert('فیس اسٹرکچر کو حذف کرنے میں خرابی۔');
                }
            }
        }
        async function loadClassesForFeeStructureFilter() {
            await loadClassesIntoSelect('feeStructureClass');
            await loadClassesIntoSelect('filterFeeStructureClass');
        }

        const feeCollectionForm = document.getElementById('feeCollectionForm');
        const feeStudentSelect = document.getElementById('feeStudentSelect');
        const feeHistoryTableBody = document.getElementById('feeHistoryTable').querySelector('tbody');
        const studentFeeDetailsContainer = document.getElementById('studentFeeDetailsContainer');
        const noStudentSelectedMsg = document.getElementById('noStudentSelectedMsg');
        const dueFeesList = document.getElementById('dueFeesList');
        const feeCollectionTypeSelect = document.getElementById('feeCollectionType');
        feeCollectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = parseInt(feeStudentSelect.value);
            const feeType = feeCollectionTypeSelect.value;
            const paidAmount = parseFloat(document.getElementById('feePaidAmount').value);
            if (!studentId || !feeType || isNaN(paidAmount) || paidAmount <= 0) {
                alert('براہ کرم طالب علم، فیس کی قسم، اور ادا شدہ رقم درست درج کریں۔');
                return;
            }
            const feeRecord = {
                studentId: studentId,
                date: document.getElementById('feeCollectionDate').value || new Date().toISOString().split('T')[0],
                feeType: feeType,
                paidAmount: paidAmount,
                discount: parseFloat(document.getElementById('feeDiscount').value) || 0,
                method: document.getElementById('feePaymentMethod').value,
                notes: document.getElementById('feeNotes').value.trim()
            };
            try {
                await addData(STORE_FEES, feeRecord);
                alert('فیس کامیابی سے وصول ہو گئی۔');
                feeCollectionForm.reset();
                document.getElementById('feePaidAmount').value = '';
                document.getElementById('feeDiscount').value = '0';
                document.getElementById('feeNotes').value = '';
                if (typeof window.addFeeIncomeToTransactions === 'function') {
                    await window.addFeeIncomeToTransactions(fullFeeRecord);
                }

                loadStudentFeeDetails(studentId);
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving fee record:", error);
                alert('فیس ریکارڈ کو محفوظ کرنے میں خرابی۔');
            }
        });
        async function loadStudentsForFeeSelect() {
            await loadStudentsIntoSelect('feeStudentSelect', null, true);
        }
        async function loadStudentFeeDetails(selectedStudentId = null) {
            const studentId = selectedStudentId || parseInt(feeStudentSelect.value);
            feeHistoryTableBody.innerHTML = '';
            dueFeesList.innerHTML = '';
            feeCollectionTypeSelect.innerHTML = '<option value="">-- پہلے طالب علم منتخب کریں --</option>';
            if (!studentId || isNaN(studentId)) {
                studentFeeDetailsContainer.style.display = 'none';
                noStudentSelectedMsg.style.display = 'block';
                return;
            }
            studentFeeDetailsContainer.style.display = 'block';
            noStudentSelectedMsg.style.display = 'none';
            feeHistoryTableBody.innerHTML = '<tr><td colspan="7">لوڈ ہو رہا ہے...</td></tr>';
            dueFeesList.innerHTML = '<li>لوڈ ہو رہا ہے...</li>';
            try {
                const student = await getById(STORE_STUDENTS, studentId);
                if (!student || !student.classId) {
                    throw new Error('Student or student class not found.');
                }

                const feeStructures = await getAll(STORE_FEE_STRUCTURES, 'classId', student.classId);

                const feePayments = await getAll(STORE_FEES, 'studentId', studentId);

                const paidAmounts = feePayments.reduce((acc, payment) => {
                    acc[payment.feeType] = (acc[payment.feeType] || 0) + payment.paidAmount + payment.discount;
                    return acc;
                }, {});

                dueFeesList.innerHTML = '';
                feeCollectionTypeSelect.innerHTML = '<option value="">-- فیس کی قسم منتخب کریں --</option>';
                let hasDueFees = false;
                feeStructures.forEach(structure => {
                    const totalPaid = paidAmounts[structure.feeType] || 0;
                    const dueAmount = structure.amount - totalPaid;
                    if (dueAmount > 0) {
                        hasDueFees = true;
                        const li = document.createElement('li');
                        li.textContent = `${structure.feeType}: ${structure.amount.toLocaleString()} (واجب الادا: ${dueAmount.toLocaleString()})`;
                        dueFeesList.appendChild(li);
                        const option = document.createElement('option');
                        option.value = structure.feeType;
                        option.textContent = `${structure.feeType} (${dueAmount.toLocaleString()} واجب الادا)`;
                        feeCollectionTypeSelect.appendChild(option);
                    }
                });
                if (!hasDueFees) {
                    dueFeesList.innerHTML = '<li>کوئی فیس واجب الادا نہیں۔</li>';
                }
                if (feeCollectionTypeSelect.options.length <= 1) {
                    feeCollectionTypeSelect.innerHTML = '<option value="">کوئی واجب الادا فیس نہیں۔</option>';
                    feeCollectionTypeSelect.disabled = true;
                } else {
                    feeCollectionTypeSelect.disabled = false;
                }

                feeHistoryTableBody.innerHTML = '';
                feePayments
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(payment => {
                        const row = feeHistoryTableBody.insertRow();
                        row.innerHTML = `
                            <td>${payment.date}</td>
                            <td>${payment.feeType}</td>
                            <td>${payment.notes || '-'}</td>
                            <td>${payment.paidAmount.toLocaleString()}</td>
                            <td>${payment.discount.toLocaleString()}</td>
                            <td>${payment.method}</td>
                             <td><button class="delete" onclick="deleteFeeRecord(${payment.id})">حذف کریں</button></td>
                        `;
                    });
                if (feePayments.length === 0) {
                    feeHistoryTableBody.innerHTML = '<tr><td colspan="7">کوئی فیس جمع نہیں کرائی گئی۔</td></tr>';
                }
            } catch (error) {
                console.error("Error loading student fee details:", error);
                feeHistoryTableBody.innerHTML = '<tr><td colspan="7">فیس کی تفصیلات لوڈ کرنے میں خرابی۔</td></tr>';
                dueFeesList.innerHTML = '<li>فیس کی تفصیلات لوڈ کرنے میں خرابی۔</li>';
                studentFeeDetailsContainer.style.display = 'none';
                noStudentSelectedMsg.style.display = 'block';
                noStudentSelectedMsg.textContent = 'فیس کی تفصیلات لوڈ کرنے میں خرابی۔';
            }
        }
        async function deleteFeeRecord(id) {
            if (confirm('کیا آپ واقعی اس فیس ریکارڈ کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    const studentId = parseInt(feeStudentSelect.value);
                    await deleteData(STORE_FEES, id);
                    alert('فیس ریکارڈ حذف ہو گیا۔');
                    loadStudentFeeDetails(studentId);
                    loadDashboardStats();
                } catch (error) {
                    console.error("Error deleting fee record:", error);
                    alert('فیس ریکارڈ کو حذف کرنے میں خرابی۔');
                }
            }
        }
        async function generateReceipt() {
            const studentId = parseInt(feeStudentSelect.value);
            const paidAmount = parseFloat(document.getElementById('feePaidAmount').value);
            const feeType = feeCollectionTypeSelect.value;
            if (!studentId || !feeType || isNaN(paidAmount) || paidAmount <= 0) {
                alert('رسید بنانے کے لیے براہ کرم طالب علم منتخب کریں، واجب الادا فیس کی قسم منتخب کریں، اور ادا شدہ رقم درج کریں۔');
                return;
            }
            try {
                const student = await getById(STORE_STUDENTS, studentId);
                const cls = student ? await getById(STORE_CLASSES, student.classId) : null;
                document.getElementById('receiptId').textContent = `F-${Date.now()}`;
                document.getElementById('receiptDate').textContent = document.getElementById('feeCollectionDate').value || new Date().toLocaleDateString('en-CA');
                document.getElementById('receiptStudentName').textContent = student ? student.name : 'N/A';
                document.getElementById('receiptStudentClass').textContent = cls ? cls.name : 'N/A';
                document.getElementById('receiptFeeType').textContent = feeType;
                document.getElementById('receiptPaidAmount').textContent = paidAmount.toLocaleString();
                document.getElementById('receiptDiscount').textContent = (parseFloat(document.getElementById('feeDiscount').value) || 0).toLocaleString();
                document.getElementById('receiptMethod').textContent = document.getElementById('feePaymentMethod').value;
                document.getElementById('receiptNotes').textContent = document.getElementById('feeNotes').value || '-';
                const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                const schoolName = schoolNameSetting ? schoolNameSetting.value : 'مدرسہ کا نام';
                const receiptHeader = document.createElement('h3');
                receiptHeader.textContent = `${schoolName} - فیس رسید`;
                const receiptContainer = document.getElementById('feeReceiptContainer');

                const existingHeader = receiptContainer.querySelector('h3');
                if (existingHeader) existingHeader.remove();
                receiptContainer.prepend(receiptHeader);

                receiptContainer.style.display = 'block';
                receiptContainer.classList.add('printable');
                window.print();
                receiptContainer.classList.remove('printable');
                receiptContainer.style.display = 'none';
            } catch (error) {
                console.error("Error generating receipt:", error);
                alert('رسید بنانے میں خرابی۔');
            }
        }

        const attendanceClassSelect = document.getElementById('attendanceClass');
        const attendanceDateInput = document.getElementById('attendanceDate');
        const attendanceTableBody = document.getElementById('attendanceTable').querySelector('tbody');
        async function loadClassesForAttendance() {
            await loadClassesIntoSelect('attendanceClass');
        }
        async function loadStudentsForAttendance() {
            const classId = parseInt(attendanceClassSelect.value);
            const date = attendanceDateInput.value;
            attendanceTableBody.innerHTML = '';
            if (!classId || !date) {
                attendanceTableBody.innerHTML = '<tr><td colspan="3">براہ کرم تاریخ اور کلاس منتخب کریں۔</td></tr>';
                return;
            }
            attendanceTableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';
            try {
                const students = await getAll(STORE_STUDENTS, 'classId', classId);
                if (students.length === 0) {
                    attendanceTableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
                    return;
                }

                const existingAttendance = await getAll(STORE_ATTENDANCE, 'date_classId', [date, classId]);
                const attendanceMap = existingAttendance.reduce((map, record) => {
                    map[record.studentId] = record.status;
                    return map;
                }, {});
                attendanceTableBody.innerHTML = '';
                students
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(student => {
                        const row = attendanceTableBody.insertRow();
                        const existingStatus = attendanceMap[student.id] || 'Present';
                        row.innerHTML = `
                            <td>${student.admissionNo}</td>
                            <td>${student.name}</td>
                            <td>
                                <label>
                                    <input type="radio" name="attendance_${student.id}" value="Present" data-student-id="${student.id}" ${existingStatus === 'Present' ? 'checked' : ''}> حاضر
                                </label>
                                <label style="margin-right: 15px;">
                                    <input type="radio" name="attendance_${student.id}" value="Absent" data-student-id="${student.id}" ${existingStatus === 'Absent' ? 'checked' : ''}> غیر حاضر
                                </label>
                             </td>
                        `;
                    });
            } catch (error) {
                console.error("Error loading students for attendance:", error);
                attendanceTableBody.innerHTML = '<tr><td colspan="3">حاضری کے لیے طلباء کو لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        async function saveAttendance() {
            const date = attendanceDateInput.value;
            const classId = parseInt(attendanceClassSelect.value);
            const attendanceRows = attendanceTableBody.querySelectorAll('input[type="radio"]:checked');
            if (!date || !classId || attendanceRows.length === 0) {
                alert('براہ کرم تاریخ، کلاس منتخب کریں اور حاضری لگائیں۔');
                return;
            }
            const attendanceData = [];
            attendanceRows.forEach(input => {
                attendanceData.push({
                    date: date,
                    classId: classId,
                    studentId: parseInt(input.dataset.studentId),
                    status: input.value
                });
            });
            try {
                const store = await getObjectStore(STORE_ATTENDANCE, 'readwrite');
                const index = store.index('date_classId_studentId');
                let completed = 0;

                const transaction = store.transaction;
                attendanceData.forEach(record => {







                    const request = index.get([record.date, record.classId, record.studentId]);
                    request.onsuccess = () => {
                        const existingRecord = request.result;
                        if (existingRecord) {

                            existingRecord.status = record.status;
                            const updateRequest = store.put(existingRecord);
                            updateRequest.onsuccess = () => checkCompletion();
                            updateRequest.onerror = (e) => console.error("Error updating attendance record:", e.target.error);
                        } else {

                            const addRequest = store.add(record);
                            addRequest.onsuccess = () => checkCompletion();
                            addRequest.onerror = (e) => console.error("Error adding attendance record:", e.target.error);
                        }
                    };
                    request.onerror = (e) => console.error("Error querying existing attendance:", e.target.error);
                });
                function checkCompletion() {
                    completed++;
                    if (completed === attendanceData.length) {
                        transaction.oncomplete = () => {
                            alert('حاضری کامیابی سے محفوظ ہو گئی۔');
                        };
                        transaction.onerror = (event) => {
                            console.error("Transaction error saving attendance:", event.target.error);
                            alert('حاضری محفوظ کرنے میں خرابی: ٹرانزیکشن ناکام۔');
                        };



                    }
                }

                setTimeout(() => {
                    if (completed === attendanceData.length) alert('حاضری کامیابی سے محفوظ ہو گئی۔ (Fallback)');
                }, 500);
            } catch (error) {
                console.error("Error saving attendance:", error);
                alert('حاضری کو محفوظ کرنے میں خرابی۔');
            }
        }
        async function printAttendanceRegister() {
            const date = attendanceDateInput.value;
            const classId = parseInt(attendanceClassSelect.value);
            const className = attendanceClassSelect.options[attendanceClassSelect.selectedIndex]?.text || 'N/A';
            if (!date || !classId) {
                alert('پرنٹ کرنے کے لیے براہ کرم تاریخ اور کلاس منتخب کریں۔');
                return;
            }
            const printContainer = document.getElementById('attendancePrintContainer');
            const printTableBody = document.getElementById('attendancePrintTable').querySelector('tbody');
            printTableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';
            document.getElementById('printAttendanceDate').textContent = date;
            document.getElementById('printAttendanceClass').textContent = className;
            try {
                const attendanceRecords = await getAll(STORE_ATTENDANCE, 'date_classId', [date, classId]);
                if (attendanceRecords.length === 0) {
                    alert('اس تاریخ اور کلاس کے لیے کوئی حاضری ریکارڈ نہیں ملا۔');
                    printTableBody.innerHTML = '<tr><td colspan="3">کوئی حاضری ریکارڈ نہیں۔</td></tr>';
                    return;
                }
                const studentIds = attendanceRecords.map(rec => rec.studentId);
                const students = await Promise.all(studentIds.map(id => getById(STORE_STUDENTS, id)));
                const studentMap = students.reduce((map, student) => {
                    if (student) map[student.id] = student;
                    return map;
                }, {});
                printTableBody.innerHTML = '';
                attendanceRecords
                    .sort((a, b) => (studentMap[a.studentId]?.name || '').localeCompare(studentMap[b.studentId]?.name || ''))
                    .forEach(record => {
                        const student = studentMap[record.studentId];
                        if (student) {
                            const row = printTableBody.insertRow();
                            row.innerHTML = `
                                 <td>${student.admissionNo}</td>
                                 <td>${student.name}</td>
                                 <td>${record.status === 'Present' ? 'حاضر' : 'غیر حاضر'}</td>
                             `;
                        }
                    });
                const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                const schoolName = schoolNameSetting ? schoolNameSetting.value : 'مدرسہ کا نام';
                const printHeader = document.createElement('h3');
                printHeader.textContent = `${schoolName} - حاضری رجسٹر`;
                const existingHeader = printContainer.querySelector('h3');
                if (existingHeader) existingHeader.remove();
                printContainer.prepend(printHeader);
                printContainer.style.display = 'block';
                printContainer.classList.add('printable');
                window.print();
                printContainer.classList.remove('printable');
                printContainer.style.display = 'none';
            } catch (error) {
                console.error("Error preparing attendance register for print:", error);
                alert('حاضری رجسٹر تیار کرنے میں خرابی۔');
                printTableBody.innerHTML = '<tr><td colspan="3">خرابی۔</td></tr>';
            }
        }

        const resultClassSelect = document.getElementById('resultClass');
        const resultSubjectSelect = document.getElementById('resultSubject');
        const resultsEntryTableBody = document.getElementById('resultsEntryTable').querySelector('tbody');
        const resultExamNameInput = document.getElementById('resultExamName');
        const resultDateInput = document.getElementById('resultDate');
        const resultCardStudentSelect = document.getElementById('resultCardStudent');
        const resultCardExamSelect = document.getElementById('resultCardExam');
        async function loadClassesForResults() {
            await loadClassesIntoSelect('resultClass');
        }
        async function loadStudentsAndSubjectsForResult() {
            const classId = parseInt(resultClassSelect.value);
            resultsEntryTableBody.innerHTML = '';
            resultSubjectSelect.innerHTML = '<option value="">-- کلاس منتخب کریں --</option>';
            if (!classId) {
                resultsEntryTableBody.innerHTML = '<tr><td colspan="3">براہ کرم امتحان، کلاس اور مضمون منتخب کریں۔</td></tr>';
                return;
            }
            try {

                const cls = await getById(STORE_CLASSES, classId);
                if (cls && cls.subjects && cls.subjects.length > 0) {
                    resultSubjectSelect.innerHTML = '<option value="">-- مضمون منتخب کریں --</option>';
                    cls.subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject;
                        option.textContent = subject;
                        resultSubjectSelect.appendChild(option);
                    });
                } else {
                    resultSubjectSelect.innerHTML = '<option value="">اس کلاس میں کوئی مضمون نہیں</option>';
                    resultsEntryTableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی مضمون شامل نہیں۔</td></tr>';
                    return;
                }

                resultsEntryTableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';
                const students = await getAll(STORE_STUDENTS, 'classId', classId);
                if (students.length === 0) {
                    resultsEntryTableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
                    return;
                }

                const examName = resultExamNameInput.value.trim();
                const subject = resultSubjectSelect.value;
                let marksMap = {};
                if (examName && subject) {
                    const existingResults = await getAll(STORE_RESULTS, 'exam_class_subject_student');
                    existingResults.forEach(res => {

                        if (res.examName === examName && res.classId === classId && res.subject === subject) {
                            marksMap[res.studentId] = { total: res.totalMarks, obtained: res.obtainedMarks };
                        }
                    });
                }
                resultsEntryTableBody.innerHTML = '';
                students
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(student => {
                        const existingMark = marksMap[student.id] || { total: 100, obtained: '' };
                        const row = resultsEntryTableBody.insertRow();
                        row.innerHTML = `
                             <td>${student.name} (${student.admissionNo})</td>
                             <td><input type="number" class="result-total-marks" value="${existingMark.total}" min="0" style="width: 80px;"></td>
                             <td><input type="number" class="result-obtained-marks" value="${existingMark.obtained}" min="0" data-student-id="${student.id}" style="width: 80px;"></td>
                         `;
                    });
            } catch (error) {
                console.error("Error loading students/subjects for results:", error);
                resultsEntryTableBody.innerHTML = '<tr><td colspan="3">نتائج کے لیے طلباء/مضامین لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        resultClassSelect.addEventListener('change', loadStudentsAndSubjectsForResult);

        resultExamNameInput.addEventListener('change', loadStudentsAndSubjectsForResult);
        async function saveResults() {
            const examName = resultExamNameInput.value.trim();
            const classId = parseInt(resultClassSelect.value);
            const subject = resultSubjectSelect.value;
            const date = resultDateInput.value || new Date().toISOString().split('T')[0];
            const marksRows = resultsEntryTableBody.querySelectorAll('tr');
            if (!examName || !classId || !subject || marksRows.length === 0 || resultsEntryTableBody.textContent.includes('کوئی طالب علم نہیں')) {
                alert('براہ کرم امتحان کا نام، کلاس، مضمون منتخب کریں اور نمبر درج کریں۔');
                return;
            }
            const resultsData = [];
            let valid = true;
            marksRows.forEach(row => {
                const totalInput = row.querySelector('.result-total-marks');
                const obtainedInput = row.querySelector('.result-obtained-marks');
                if (obtainedInput && totalInput) {
                    const studentId = parseInt(obtainedInput.dataset.studentId);
                    const totalMarks = parseInt(totalInput.value);
                    const obtainedMarksStr = obtainedInput.value;

                    if (obtainedMarksStr !== '' && !isNaN(studentId) && !isNaN(totalMarks) && totalMarks > 0) {
                        const obtainedMarks = parseInt(obtainedMarksStr);
                        if (!isNaN(obtainedMarks) && obtainedMarks >= 0 && obtainedMarks <= totalMarks) {
                            resultsData.push({
                                examName: examName,
                                classId: classId,
                                subject: subject,
                                studentId: studentId,
                                totalMarks: totalMarks,
                                obtainedMarks: obtainedMarks,
                                date: date
                            });
                        } else if (!isNaN(obtainedMarks)) {
                            alert(`طالب علم ID ${studentId} کے لیے غلط نمبر درج کیے گئے ہیں۔ حاصل کردہ نمبر 0 اور ${totalMarks} کے درمیان ہونے چاہئیں۔`);
                            valid = false;
                        }
                    } else if (obtainedMarksStr !== '') {
                        alert(`طالب علم ID ${studentId} کے لیے کل نمبر درست نہیں ہیں یا حاصل کردہ نمبر خالی ہیں۔`);
                        valid = false;
                    }
                }
            });
            if (!valid || resultsData.length === 0) {
                if (valid) alert('محفوظ کرنے کے لیے کوئی درست نتائج درج نہیں کیے گئے۔');
                return;
            }
            try {
                const store = await getObjectStore(STORE_RESULTS, 'readwrite');
                const index = store.index('exam_class_subject_student');
                let completed = 0;
                const transaction = store.transaction;
                resultsData.forEach(record => {
                    const keyRange = IDBKeyRange.only([record.examName, record.classId, record.subject, record.studentId]);
                    const request = index.get(keyRange);
                    request.onsuccess = () => {
                        const existingRecord = request.result;
                        if (existingRecord) {

                            existingRecord.totalMarks = record.totalMarks;
                            existingRecord.obtainedMarks = record.obtainedMarks;
                            existingRecord.date = record.date;
                            const updateRequest = store.put(existingRecord);
                            updateRequest.onsuccess = () => checkCompletion();
                            updateRequest.onerror = (e) => console.error("Error updating result record:", e.target.error);
                        } else {

                            const addRequest = store.add(record);
                            addRequest.onsuccess = () => checkCompletion();
                            addRequest.onerror = (e) => console.error("Error adding result record:", e.target.error);
                        }
                    };
                    request.onerror = (e) => console.error("Error querying existing result:", e.target.error);
                });
                function checkCompletion() {
                    completed++;
                    if (completed === resultsData.length) {
                        transaction.oncomplete = () => {
                            alert('نتائج کامیابی سے محفوظ ہو گئے۔');
                            loadExamsForResultCard();
                        };
                        transaction.onerror = (event) => {
                            console.error("Transaction error saving results:", event.target.error);
                            alert('نتائج محفوظ کرنے میں خرابی: ٹرانزیکشن ناکام۔');
                        };
                    }
                }

                setTimeout(() => {
                    if (completed === resultsData.length) alert('نتائج کامیابی سے محفوظ ہو گئے۔ (Fallback)');
                }, 500);
            } catch (error) {
                console.error("Error saving results:", error);
                alert('نتائج کو محفوظ کرنے میں خرابی۔');
            }
        }
        async function loadStudentsForResultCard() {
            await loadStudentsIntoSelect('resultCardStudent');
        }
        async function loadExamsForResultCard() {
            resultCardExamSelect.innerHTML = '<option value="">-- امتحان منتخب کریں --</option>';
            try {
                const results = await getAll(STORE_RESULTS);
                const examNames = [...new Set(results.map(r => r.examName))];
                examNames.sort().forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    resultCardExamSelect.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading exams for result card:", error);
            }
        }
        async function printResultCard() {
            const studentId = parseInt(resultCardStudentSelect.value);
            const examName = resultCardExamSelect.value;
            if (!studentId || !examName) {
                alert('براہ کرم طالب علم اور امتحان منتخب کریں۔');
                return;
            }
            const printContainer = document.getElementById('resultCardPrintContainer');
            const printTableBody = document.getElementById('resultCardPrintTable').querySelector('tbody');
            printTableBody.innerHTML = '<tr><td colspan="4">لوڈ ہو رہا ہے...</td></tr>';
            try {
                const student = await getById(STORE_STUDENTS, studentId);
                if (!student) throw new Error("Student not found");
                const cls = await getById(STORE_CLASSES, student.classId);
                document.getElementById('printResultExamName').textContent = examName;
                document.getElementById('printResultStudentName').textContent = student.name;
                document.getElementById('printResultClassName').textContent = cls ? cls.name : 'N/A';

                const allResults = await getAll(STORE_RESULTS, 'studentId', studentId);
                const studentExamResults = allResults.filter(r => r.examName === examName);
                if (studentExamResults.length === 0) {
                    alert('اس طالب علم کے لیے منتخب امتحان کا کوئی نتیجہ نہیں ملا۔');
                    printTableBody.innerHTML = '<tr><td colspan="4">کوئی نتیجہ نہیں۔</td></tr>';
                    document.getElementById('printResultTotalObtained').textContent = '0';
                    document.getElementById('printResultTotalMarks').textContent = '0';
                    document.getElementById('printResultOverallPercentage').textContent = '0.00';
                    document.getElementById('printResultStatus').textContent = '-';
                    return;
                }
                printTableBody.innerHTML = '';
                let totalObtained = 0;
                let totalMarks = 0;
                studentExamResults.forEach(res => {
                    const percentage = (res.obtainedMarks / res.totalMarks) * 100;

                    let grade = 'F';
                    if (percentage >= 90) grade = 'A+';
                    else if (percentage >= 80) grade = 'A';
                    else if (percentage >= 70) grade = 'B';
                    else if (percentage >= 60) grade = 'C';
                    else if (percentage >= 50) grade = 'D';
                    else if (percentage >= 40) grade = 'E';
                    const row = printTableBody.insertRow();
                    row.innerHTML = `
                         <td>${res.subject}</td>
                         <td>${res.totalMarks}</td>
                         <td>${res.obtainedMarks}</td>
                         <td>${percentage.toFixed(2)}% (${grade})</td>
                     `;
                    totalObtained += res.obtainedMarks;
                    totalMarks += res.totalMarks;
                });
                const overallPercentage = totalMarks > 0 ? (totalObtained / totalMarks) * 100 : 0;
                const status = overallPercentage >= 40 ? 'پاس' : 'فیل';
                document.getElementById('printResultTotalObtained').textContent = totalObtained;
                document.getElementById('printResultTotalMarks').textContent = totalMarks;
                document.getElementById('printResultOverallPercentage').textContent = overallPercentage.toFixed(2);
                document.getElementById('printResultStatus').textContent = status;
                const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                const schoolName = schoolNameSetting ? schoolNameSetting.value : 'مدرسہ کا نام';
                const printHeader = document.createElement('h3');
                printHeader.textContent = `${schoolName} - رزلٹ کارڈ`;
                const existingHeader = printContainer.querySelector('h3');
                if (existingHeader) existingHeader.remove();
                printContainer.prepend(printHeader);
                printContainer.style.display = 'block';
                printContainer.classList.add('printable');
                window.print();
                printContainer.classList.remove('printable');
                printContainer.style.display = 'none';
            } catch (error) {
                console.error("Error preparing result card for print:", error);
                alert('رزلٹ کارڈ تیار کرنے میں خرابی: ' + error.message);
                printTableBody.innerHTML = '<tr><td colspan="4">خرابی۔</td></tr>';
            }
        }

        const timetableClassSelect = document.getElementById('timetableClass');
        const classTimetableTableBody = document.getElementById('classTimetableTable').querySelector('tbody');
        const dutyRoasterTeacherSelect = document.getElementById('dutyRoasterTeacher');
        const teacherRoasterTableBody = document.getElementById('teacherRoasterTable').querySelector('tbody');
        const daysOfWeek = ["پیر", "منگل", "بدھ", "جمعرات", "جمعہ", "ہفتہ"];
        const periods = 4;
        async function loadClassesForTimetable() {
            await loadClassesIntoSelect('timetableClass');
        }
        async function loadTeachersForRoaster() {
            await loadTeachersIntoSelect('dutyRoasterTeacher');
        }
        async function loadTimetable() {
            const classId = parseInt(timetableClassSelect.value);
            classTimetableTableBody.innerHTML = '';
            if (!classId) {
                classTimetableTableBody.innerHTML = `<tr><td colspan="${periods + 1}">براہ کرم کلاس منتخب کریں۔</td></tr>`;
                return;
            }
            classTimetableTableBody.innerHTML = `<tr><td colspan="${periods + 1}">لوڈ ہو رہا ہے...</td></tr>`;
            try {
                const cls = await getById(STORE_CLASSES, classId);
                const teachers = await getAll(STORE_TEACHERS);
                const timetableData = await getAll(STORE_TIMETABLE, 'classId', classId);
                const timetableMap = timetableData.reduce((map, entry) => {
                    if (!map[entry.day]) map[entry.day] = {};
                    map[entry.day][entry.period] = { subject: entry.subject, teacherId: entry.teacherId };
                    return map;
                }, {});
                if (!cls) throw new Error("Class not found");
                classTimetableTableBody.innerHTML = '';
                daysOfWeek.forEach(day => {
                    const row = classTimetableTableBody.insertRow();
                    row.insertCell().textContent = day;
                    for (let period = 1; period <= periods; period++) {
                        const cell = row.insertCell();
                        const entry = timetableMap[day]?.[period] || { subject: '', teacherId: '' };

                        const subjectSelect = document.createElement('select');
                        subjectSelect.classList.add('timetable-subject');
                        subjectSelect.dataset.day = day;
                        subjectSelect.dataset.period = period;
                        subjectSelect.innerHTML = '<option value="">-- مضمون --</option>';
                        (cls.subjects || []).forEach(sub => {
                            const option = document.createElement('option');
                            option.value = sub;
                            option.textContent = sub;
                            if (sub === entry.subject) option.selected = true;
                            subjectSelect.appendChild(option);
                        });
                        cell.appendChild(subjectSelect);

                        const teacherSelect = document.createElement('select');
                        teacherSelect.classList.add('timetable-teacher');
                        teacherSelect.dataset.day = day;
                        teacherSelect.dataset.period = period;
                        teacherSelect.innerHTML = '<option value="">-- استاد --</option>';
                        teachers.forEach(teacher => {
                            const option = document.createElement('option');
                            option.value = teacher.id;
                            option.textContent = teacher.name;
                            if (teacher.id === entry.teacherId) option.selected = true;
                            teacherSelect.appendChild(option);
                        });
                        cell.appendChild(document.createElement('br'));
                        cell.appendChild(teacherSelect);
                    }
                });
            } catch (error) {
                console.error("Error loading timetable:", error);
                classTimetableTableBody.innerHTML = `<tr><td colspan="${periods + 1}">ٹائم ٹیبل لوڈ کرنے میں خرابی۔</td></tr>`;
            }
        }
        async function saveTimetable() {
            const classId = parseInt(timetableClassSelect.value);
            if (!classId) {
                alert('براہ کرم کلاس منتخب کریں۔');
                return;
            }
            const timetableEntries = [];
            const cells = classTimetableTableBody.querySelectorAll('td:not(:first-child)');
            let hasData = false;
            daysOfWeek.forEach(day => {
                for (let period = 1; period <= periods; period++) {
                    const subjectSelect = classTimetableTableBody.querySelector(`select.timetable-subject[data-day="${day}"][data-period="${period}"]`);
                    const teacherSelect = classTimetableTableBody.querySelector(`select.timetable-teacher[data-day="${day}"][data-period="${period}"]`);
                    if (subjectSelect && teacherSelect) {
                        const subject = subjectSelect.value;
                        const teacherId = teacherSelect.value ? parseInt(teacherSelect.value) : null;

                        if (subject || teacherId) {
                            hasData = true;
                            timetableEntries.push({
                                classId: classId,
                                day: day,
                                period: period,
                                subject: subject || null,
                                teacherId: teacherId
                            });
                        }
                    }
                }
            });
            if (!hasData) {
                if (!confirm("کوئی مضمون یا استاد منتخب نہیں کیا گیا۔ کیا آپ اس کلاس کا ٹائم ٹیبل صاف کرنا چاہتے ہیں؟")) {
                    return;
                }

            }
            try {
                const store = await getObjectStore(STORE_TIMETABLE, 'readwrite');
                const index = store.index('classId_day_period');
                let completed = 0;
                const transaction = store.transaction;

                timetableEntries.forEach(entry => {
                    const keyRange = IDBKeyRange.only([entry.classId, entry.day, entry.period]);
                    const request = index.get(keyRange);
                    request.onsuccess = () => {
                        const existingEntry = request.result;
                        if (existingEntry) {

                            if (entry.subject === null && entry.teacherId === null) {
                                const deleteRequest = store.delete(existingEntry.id);
                                deleteRequest.onsuccess = () => checkCompletion();
                                deleteRequest.onerror = (e) => console.error("Error deleting timetable entry:", e.target.error);
                            } else {
                                existingEntry.subject = entry.subject;
                                existingEntry.teacherId = entry.teacherId;
                                const updateRequest = store.put(existingEntry);
                                updateRequest.onsuccess = () => checkCompletion();
                                updateRequest.onerror = (e) => console.error("Error updating timetable entry:", e.target.error);
                            }
                        } else if (entry.subject || entry.teacherId) {
                            const addRequest = store.add(entry);
                            addRequest.onsuccess = () => checkCompletion();
                            addRequest.onerror = (e) => console.error("Error adding timetable entry:", e.target.error);
                        } else {

                            checkCompletion();
                        }
                    };
                    request.onerror = (e) => console.error("Error querying existing timetable entry:", e.target.error);
                });
                function checkCompletion() {
                    completed++;
                    if (completed === timetableEntries.length) {
                        transaction.oncomplete = () => {
                            alert('ٹائم ٹیبل کامیابی سے محفوظ ہو گیا۔');

                            if (dutyRoasterTeacherSelect.value) loadTeacherRoaster();
                        };
                        transaction.onerror = (event) => {
                            console.error("Transaction error saving timetable:", event.target.error);
                            alert('ٹائم ٹیبل محفوظ کرنے میں خرابی: ٹرانزیکشن ناکام۔');
                        };
                    }
                }

                setTimeout(() => {
                    if (completed === timetableEntries.length) alert('ٹائم ٹیبل کامیابی سے محفوظ ہو گیا۔ (Fallback)');
                }, 500);
            } catch (error) {
                console.error("Error saving timetable:", error);
                alert('ٹائم ٹیبل کو محفوظ کرنے میں خرابی۔');
            }
        }
        async function loadTeacherRoaster() {
            const teacherId = parseInt(dutyRoasterTeacherSelect.value);
            teacherRoasterTableBody.innerHTML = '';
            if (!teacherId) {
                teacherRoasterTableBody.innerHTML = `<tr><td colspan="${periods + 1}">براہ کرم استاد منتخب کریں۔</td></tr>`;
                return;
            }
            teacherRoasterTableBody.innerHTML = `<tr><td colspan="${periods + 1}">لوڈ ہو رہا ہے...</td></tr>`;
            try {
                const timetableData = await getAll(STORE_TIMETABLE, 'teacherId', teacherId);
                const classes = await getAll(STORE_CLASSES);
                const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
                const roasterMap = timetableData.reduce((map, entry) => {
                    if (!map[entry.day]) map[entry.day] = {};
                    map[entry.day][entry.period] = { subject: entry.subject, classId: entry.classId };
                    return map;
                }, {});
                teacherRoasterTableBody.innerHTML = '';
                daysOfWeek.forEach(day => {
                    const row = teacherRoasterTableBody.insertRow();
                    row.insertCell().textContent = day;
                    for (let period = 1; period <= periods; period++) {
                        const cell = row.insertCell();
                        const entry = roasterMap[day]?.[period];
                        if (entry) {
                            cell.textContent = `${classMap[entry.classId] || 'N/A'} - ${entry.subject || 'N/A'}`;
                        } else {
                            cell.textContent = '-';
                        }
                    }
                });
            } catch (error) {
                console.error("Error loading teacher roaster:", error);
                teacherRoasterTableBody.innerHTML = `<tr><td colspan="${periods + 1}">ڈیوٹی روسٹر لوڈ کرنے میں خرابی۔</td></tr>`;
            }
        }

        const expenseForm = document.getElementById('expenseForm');
        const expensesTableBody = document.getElementById('expensesTable').querySelector('tbody');
        const expenseFilterDateInput = document.getElementById('expenseFilterDate');
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const expenseId = document.getElementById('expenseId').value;
            const expense = {
                date: document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0],
                type: document.getElementById('expenseType').value.trim(),
                amount: parseFloat(document.getElementById('expenseAmount').value),
                paidTo: document.getElementById('expensePaidTo').value.trim(),
                description: document.getElementById('expenseDescription').value.trim()
            };
            if (!expense.type || isNaN(expense.amount) || expense.amount <= 0) {
                alert('براہ کرم تاریخ، قسم اور رقم درست درج کریں۔');
                return;
            }
            try {
                if (expenseId) {
                    expense.id = parseInt(expenseId);
                    await updateData(STORE_EXPENSES, expense);
                    alert('خرچہ اپ ڈیٹ ہو گیا۔');
                } else {
                    await addData(STORE_EXPENSES, expense);
                    alert('نیا خرچہ شامل ہو گیا۔');
                }
                resetExpenseForm();
                loadExpenses();
                loadDashboardStats();
            } catch (error) {
                console.error("Error saving expense:", error);
                alert('خرچہ محفوظ کرنے میں خرابی۔');
            }
        });
        function resetExpenseForm() {
            expenseForm.reset();
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        }
        async function loadExpenses() {
            expensesTableBody.innerHTML = '<tr><td colspan="6">لوڈ ہو رہا ہے...</td></tr>';
            const filterDate = expenseFilterDateInput.value;
            try {
                let expenses;
                if (filterDate) {
                    expenses = await getAll(STORE_EXPENSES, 'date', filterDate);
                } else {
                    expenses = await getAll(STORE_EXPENSES);
                }
                expensesTableBody.innerHTML = '';
                expenses
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(expense => {
                        const row = expensesTableBody.insertRow();
                        row.innerHTML = `
                            <td>${expense.date}</td>
                            <td>${expense.type}</td>
                            <td>${expense.description || '-'}</td>
                            <td>${expense.paidTo || '-'}</td>
                            <td>${expense.amount.toLocaleString()}</td>
                            <td>
                                <button class="edit" onclick="editExpense(${expense.id})">ترمیم</button>
                                <button class="delete" onclick="deleteExpense(${expense.id})">حذف کریں</button>
                            </td>
                        `;
                    });
                if (expenses.length === 0) {
                    expensesTableBody.innerHTML = `<tr><td colspan="6">${filterDate ? 'اس تاریخ کو کوئی خرچہ نہیں ملا۔' : 'کوئی خرچہ نہیں ملا۔'}</td></tr>`;
                }
            } catch (error) {
                console.error("Error loading expenses:", error);
                expensesTableBody.innerHTML = '<tr><td colspan="6">اخراجات لوڈ کرنے میں خرابی۔</td></tr>';
            }
        }
        async function editExpense(id) {
            try {
                const expense = await getById(STORE_EXPENSES, id);
                if (expense) {
                    document.getElementById('expenseId').value = expense.id;
                    document.getElementById('expenseDate').value = expense.date;
                    document.getElementById('expenseType').value = expense.type;
                    document.getElementById('expenseAmount').value = expense.amount;
                    document.getElementById('expensePaidTo').value = expense.paidTo || '';
                    document.getElementById('expenseDescription').value = expense.description || '';
                    showModule('expenses');
                    window.scrollTo(0, 0);
                }
            } catch (error) {
                console.error("Error fetching expense for edit:", error);
                alert('ترمیم کے لیے خرچہ لانے میں خرابی۔');
            }
        }
        async function deleteExpense(id) {
            if (confirm('کیا آپ واقعی اس خرچے کو حذف کرنا چاہتے ہیں؟')) {
                try {
                    await deleteData(STORE_EXPENSES, id);
                    alert('خرچہ حذف ہو گیا۔');
                    loadExpenses();
                    loadDashboardStats();
                } catch (error) {
                    console.error("Error deleting expense:", error);
                    alert('خرچہ حذف کرنے میں خرابی۔');
                }
            }
        }

        const reportContent = document.getElementById('reportContent');
        const reportTypeSelect = document.getElementById('reportType');
        const reportStartDateInput = document.getElementById('reportStartDate');
        const reportEndDateInput = document.getElementById('reportEndDate');
        const reportClassFilterSelect = document.getElementById('reportClassFilter');
        async function loadClassesForReportFilter() {
            await loadClassesIntoSelect('reportClassFilter');
        }
        async function generateReport() {
            const reportType = reportTypeSelect.value;
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const classFilterId = reportClassFilterSelect.value ? parseInt(reportClassFilterSelect.value) : null;
            reportContent.innerHTML = '<p>رپورٹ تیار کی جا رہی ہے...</p>';
            if (!reportType) {
                reportContent.innerHTML = '<p>براہ کرم رپورٹ کی قسم منتخب کریں۔</p>';
                return;
            }
            try {
                let html = `<h4>رپورٹ: ${reportTypeSelect.options[reportTypeSelect.selectedIndex].text}</h4>`;
                if (startDate) html += `<p>شروع تاریخ: ${startDate}</p>`;
                if (endDate) html += `<p>اختتامی تاریخ: ${endDate}</p>`;
                if (classFilterId) {
                    const cls = await getById(STORE_CLASSES, classFilterId);
                    html += `<p>کلاس: ${cls ? cls.name : 'N/A'}</p>`;
                }
                html += '<hr>';
                switch (reportType) {
                    case 'fee_collection':
                        html += await generateFeeCollectionReport(startDate, endDate, classFilterId);
                        break;
                    case 'outstanding_fees':
                        html += await generateOutstandingFeesReport(classFilterId);
                        break;
                    case 'attendance_summary':
                        html += await generateAttendanceReport(startDate, endDate, classFilterId);
                        break;
                    case 'expense_report':
                        html += await generateExpenseReport(startDate, endDate);
                        break;
                    case 'student_list':
                        html += await generateStudentListReport(classFilterId);
                        break;
                    default:
                        html += '<p>منتخب کردہ رپورٹ کی قسم ابھی دستیاب نہیں۔</p>';
                }
                reportContent.innerHTML = html;
            } catch (error) {
                console.error("Error generating report:", error);
                reportContent.innerHTML = `<p>رپورٹ بنانے میں خرابی: ${error.message}</p>`;
            }
        }
        function printReport() {
            const reportOutput = document.getElementById('reportOutput');
            const schoolNameSetting = getById(STORE_SETTINGS, 'schoolName').then(setting => {
                const schoolName = setting ? setting.value : 'مدرسہ کا نام';
                const reportHeader = document.createElement('h3');
                reportHeader.textContent = `${schoolName} - رپورٹ`;
                const existingHeader = reportOutput.querySelector('h3');
                if (existingHeader) existingHeader.remove();
                reportOutput.prepend(reportHeader);
                reportOutput.classList.add('printable');
                window.print();
                reportOutput.classList.remove('printable');
            }).catch(err => {
                console.error("Error getting school name for printing report:", err);
                reportOutput.classList.add('printable');
                window.print();
                reportOutput.classList.remove('printable');
            });
        }
        async function generateFeeCollectionReport(startDate, endDate, classFilterId) {
            let fees = await getAll(STORE_FEES);
            let students = await getAll(STORE_STUDENTS);
            let classes = await getAll(STORE_CLASSES);
            const studentMap = students.reduce((map, std) => { map[std.id] = std; return map; }, {});
            const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
            let filteredFees = fees.filter(fee => {
                const student = studentMap[fee.studentId];
                const dateMatch = (!startDate || fee.date >= startDate) && (!endDate || fee.date <= endDate);
                const classMatch = !classFilterId || (student && student.classId === classFilterId);
                return dateMatch && classMatch;
            });
            if (filteredFees.length === 0) return '<p>اس معیار پر کوئی فیس وصولی نہیں ملی۔</p>';
            let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                 <thead><tr><th>تاریخ</th><th>طالب علم</th><th>کلاس</th><th>فیس قسم</th><th>رقم</th><th>رعایت</th><th>طریقہ</th></tr></thead>
                                 <tbody>`;
            let totalCollected = 0;
            let totalDiscount = 0;
            filteredFees.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(fee => {
                const student = studentMap[fee.studentId];
                tableHTML += `<tr>
                                 <td>${fee.date}</td>
                                 <td>${student ? student.name : 'N/A'}</td>
                                 <td>${student ? classMap[student.classId] : 'N/A'}</td>
                                 <td>${fee.feeType}</td>
                                 <td>${fee.paidAmount.toLocaleString()}</td>
                                 <td>${fee.discount.toLocaleString()}</td>
                                 <td>${fee.method}</td>
                              </tr>`;
                totalCollected += fee.paidAmount;
                totalDiscount += fee.discount;
            });
            tableHTML += `</tbody><tfoot>
                            <tr><td colspan="4"><b>کل</b></td><td><b>${totalCollected.toLocaleString()}</b></td><td><b>${totalDiscount.toLocaleString()}</b></td><td></td></tr>
                          </tfoot></table>`;
            return tableHTML;
        }
        async function generateOutstandingFeesReport(classFilterId) {
            let students = await getAll(STORE_STUDENTS);
            let feeStructures = await getAll(STORE_FEE_STRUCTURES);
            let feesPaid = await getAll(STORE_FEES);
            let classes = await getAll(STORE_CLASSES);
            const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
            if (classFilterId) {
                students = students.filter(std => std.classId === classFilterId);
            }
            if (students.length === 0) return '<p>اس معیار پر کوئی طالب علم نہیں ملا۔</p>';
            let reportData = [];
            let grandTotalDue = 0;
            for (const student of students) {
                const studentClassId = student.classId;
                const studentFeeStructures = feeStructures.filter(fs => fs.classId === studentClassId);
                const studentFeesPaid = feesPaid.filter(fp => fp.studentId === student.id);
                let totalDueForStudent = 0;
                let details = [];
                studentFeeStructures.forEach(structure => {
                    const paidForType = studentFeesPaid
                        .filter(fp => fp.feeType === structure.feeType)
                        .reduce((sum, fp) => sum + fp.paidAmount + fp.discount, 0);
                    const dueAmount = structure.amount - paidForType;
                    if (dueAmount > 0) {
                        totalDueForStudent += dueAmount;
                        details.push(`${structure.feeType}: ${dueAmount.toLocaleString()}`);
                    }
                });
                if (totalDueForStudent > 0) {
                    reportData.push({
                        studentName: student.name,
                        className: classMap[studentClassId] || 'N/A',
                        totalDue: totalDueForStudent,
                        details: details.join(', ')
                    });
                    grandTotalDue += totalDueForStudent;
                }
            }
            if (reportData.length === 0) return '<p>اس معیار پر کوئی واجب الادا فیس نہیں ملی۔</p>';
            let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                 <thead><tr><th>طالب علم</th><th>کلاس</th><th>تفصیلات واجب الادا</th><th>کل واجب الادا</th></tr></thead>
                                 <tbody>`;
            reportData.sort((a, b) => a.className.localeCompare(b.className) || a.studentName.localeCompare(b.studentName)).forEach(data => {
                tableHTML += `<tr>
                                 <td>${data.studentName}</td>
                                 <td>${data.className}</td>
                                 <td>${data.details}</td>
                                 <td>${data.totalDue.toLocaleString()}</td>
                              </tr>`;
            });
            tableHTML += `</tbody><tfoot>
                             <tr><td colspan="3"><b>کل مجموعی واجب الادا</b></td><td><b>${grandTotalDue.toLocaleString()}</b></td></tr>
                          </tfoot></table>`;
            return tableHTML;
        }
        async function generateAttendanceReport(startDate, endDate, classFilterId) {
            if (!startDate || !endDate) return '<p>براہ کرم حاضری رپورٹ کے لیے شروع اور اختتامی تاریخ منتخب کریں۔</p>';
            let attendance = await getAll(STORE_ATTENDANCE);
            let students = await getAll(STORE_STUDENTS);
            let classes = await getAll(STORE_CLASSES);
            const studentMap = students.reduce((map, std) => { map[std.id] = std; return map; }, {});
            const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
            let filteredAttendance = attendance.filter(att => {
                const student = studentMap[att.studentId];
                const dateMatch = att.date >= startDate && att.date <= endDate;
                const classMatch = !classFilterId || (student && student.classId === classFilterId && att.classId === classFilterId);
                return dateMatch && classMatch;
            });
            if (filteredAttendance.length === 0) return '<p>اس معیار پر کوئی حاضری ریکارڈ نہیں ملا۔</p>';

            const summary = filteredAttendance.reduce((acc, att) => {
                const studentId = att.studentId;
                if (!acc[studentId]) {
                    const student = studentMap[studentId];
                    if (student) {
                        acc[studentId] = {
                            name: student.name,
                            className: classMap[student.classId] || 'N/A',
                            present: 0,
                            absent: 0,
                            total: 0
                        };
                    } else {
                        return acc;
                    }
                }
                if (acc[studentId]) {
                    acc[studentId].total++;
                    if (att.status === 'Present') {
                        acc[studentId].present++;
                    } else {
                        acc[studentId].absent++;
                    }
                }
                return acc;
            }, {});
            if (Object.keys(summary).length === 0) return '<p>خلاصہ کرنے کے لیے کوئی حاضری ڈیٹا نہیں۔</p>';
            let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                  <thead><tr><th>طالب علم</th><th>کلاس</th><th>کل دن</th><th>حاضر</th><th>غیر حاضر</th><th>فیصد حاضری</th></tr></thead>
                                  <tbody>`;
            Object.values(summary)
                .sort((a, b) => a.className.localeCompare(b.className) || a.name.localeCompare(b.name))
                .forEach(data => {
                    const percentage = data.total > 0 ? ((data.present / data.total) * 100).toFixed(2) : '0.00';
                    tableHTML += `<tr>
                                      <td>${data.name}</td>
                                      <td>${data.className}</td>
                                      <td>${data.total}</td>
                                      <td>${data.present}</td>
                                      <td>${data.absent}</td>
                                      <td>${percentage}%</td>
                                   </tr>`;
                });
            tableHTML += `</tbody></table>`;
            return tableHTML;
        }
        async function generateExpenseReport(startDate, endDate) {
            let expenses = await getAll(STORE_EXPENSES);
            let filteredExpenses = expenses.filter(exp => {
                const dateMatch = (!startDate || exp.date >= startDate) && (!endDate || exp.date <= endDate);
                return dateMatch;
            });
            if (filteredExpenses.length === 0) return '<p>اس معیار پر کوئی اخراجات نہیں ملے۔</p>';
            let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                  <thead><tr><th>تاریخ</th><th>قسم</th><th>تفصیل</th><th>ادا کیا گیا</th><th>رقم</th></tr></thead>
                                  <tbody>`;
            let totalExpenses = 0;
            filteredExpenses.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(exp => {
                tableHTML += `<tr>
                                  <td>${exp.date}</td>
                                  <td>${exp.type}</td>
                                  <td>${exp.description || '-'}</td>
                                  <td>${exp.paidTo || '-'}</td>
                                  <td>${exp.amount.toLocaleString()}</td>
                               </tr>`;
                totalExpenses += exp.amount;
            });
            tableHTML += `</tbody><tfoot>
                              <tr><td colspan="4"><b>کل اخراجات</b></td><td><b>${totalExpenses.toLocaleString()}</b></td></tr>
                           </tfoot></table>`;
            return tableHTML;
        }
        async function generateStudentListReport(classFilterId) {
            let students = await getAll(STORE_STUDENTS);
            let classes = await getAll(STORE_CLASSES);
            const classMap = classes.reduce((map, cls) => { map[cls.id] = cls.name; return map; }, {});
            if (classFilterId) {
                students = students.filter(std => std.classId === classFilterId);
            }
            if (students.length === 0) return '<p>اس معیار پر کوئی طالب علم نہیں ملا۔</p>';
            let tableHTML = `<table border="1" style="width:100%; border-collapse: collapse;">
                                 <thead><tr><th>داخلہ نمبر</th><th>نام</th><th>والد کا نام</th><th>کلاس</th><th>داخلہ تاریخ</th><th>رابطہ</th></tr></thead>
                                 <tbody>`;
            students.sort((a, b) => (classMap[a.classId] || '').localeCompare(classMap[b.classId] || '') || a.name.localeCompare(b.name)).forEach(student => {
                tableHTML += `<tr>
                                 <td>${student.admissionNo}</td>
                                 <td>${student.name}</td>
                                 <td>${student.fatherName}</td>
                                 <td>${classMap[student.classId] || 'N/A'}</td>
                                 <td>${student.admissionDate}</td>
                                  <td>${student.contact || '-'}</td>
                              </tr>`;
            });
            tableHTML += `</tbody></table>`;
            return tableHTML;
        }

        const importFileInput = document.getElementById('importFile');
        async function backupData() {
            if (!confirm('تمام ڈیٹا کو JSON فائل کے طور پر ایکسپورٹ کیا جائے گا۔ جاری رکھیں؟')) return;
            try {
                const backup = {};
                const storeNames = db.objectStoreNames;
                for (let i = 0; i < storeNames.length; i++) {
                    const storeName = storeNames[i];


                    backup[storeName] = await getAll(storeName);
                }
                const jsonString = JSON.stringify(backup, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `school_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('ڈیٹا بیک اپ کامیابی سے ڈاؤن لوڈ ہو گیا۔');
            } catch (error) {
                console.error("Error backing up data:", error);
                alert('ڈیٹا بیک اپ کرنے میں خرابی۔');
            }
        }
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('خبردار! امپورٹ کرنے سے موجودہ تمام ڈیٹا مٹ جائے گا اور اس فائل کے ڈیٹا سے تبدیل ہو جائے گا۔ کیا آپ واقعی جاری رکھنا چاہتے ہیں؟')) {
                importFileInput.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const storeNames = db.objectStoreNames;

                    const clearPromises = [];
                    for (let i = 0; i < storeNames.length; i++) {
                        clearPromises.push(clearStore(storeNames[i]));
                    }
                    await Promise.all(clearPromises);
                    console.log("Existing data cleared.");

                    const importPromises = [];
                    for (const storeName in importedData) {
                        if (db.objectStoreNames.contains(storeName)) {
                            const dataToImport = importedData[storeName];
                            if (Array.isArray(dataToImport)) {
                                const store = await getObjectStore(storeName, 'readwrite');
                                dataToImport.forEach(item => {





                                    importPromises.push(new Promise((resolve, reject) => {

                                        const req = store.put(item);
                                        req.onsuccess = resolve;
                                        req.onerror = reject;
                                    }));
                                });
                            }
                        } else {
                            console.warn(`Store "${storeName}" from backup file not found in current database schema. Skipping.`);
                        }
                    }
                    await Promise.all(importPromises);
                    alert('ڈیٹا کامیابی سے امپورٹ ہو گیا۔ براہ کرم صفحہ ریفریش کریں۔');

                    showModule('dashboard');
                    loadDashboardStats();
                    location.reload();
                } catch (error) {
                    console.error("Error importing data:", error);
                    alert('ڈیٹا امپورٹ کرنے میں خرابی۔ یقینی بنائیں کہ فائل درست JSON فارمیٹ میں ہے۔\n' + error.message);
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert('فائل پڑھنے میں خرابی۔');
                importFileInput.value = '';
            };
            reader.readAsText(file);
        });
        function setupIncomeExpensesModule() {
            console.log("Setting up Income & Expenses module via JS...");
            const expensesModule = document.getElementById('expenses');
            if (!expensesModule) {
                console.error("Original 'expenses' module not found. Cannot transform.");
                return;
            }

            expensesModule.innerHTML = `
        <h2>آمدنی و اخراجات کا انتظام</h2>
        <h3>نیا لین دین شامل کریں / ترمیم کریں</h3>
        <form id="transactionForm">
            <input type="hidden" id="transactionId">
            <div class="form-grid">
                <div>
                    <label for="transactionDate">تاریخ</label>
                    <input type="date" id="transactionDate" required>
                </div>
                <div>
                    <label for="transactionRecordType">قسم (آمدنی/خرچہ)</label>
                    <select id="transactionRecordType" required>
                        <option value="expense">خرچہ</option>
                        <option value="income">آمدنی</option>
                    </select>
                </div>
                <div>
                    <label for="transactionCategory">زمرہ/نوعیت</label>
                    <input type="text" id="transactionCategory" placeholder="مثال: تنخواہ, بجلی کا بل, فیس, چندہ" required>
                </div>
                <div>
                    <label for="transactionAmount">رقم</label>
                    <input type="number" id="transactionAmount" required>
                </div>
                <div id="paidToDiv">
                    <label for="transactionPaidTo">ادا کیا گیا (استاد/وغیرہ)</label>
                    <input type="text" id="transactionPaidTo">
                </div>
                <div id="receivedFromDiv" style="display:none;">
                    <label for="transactionReceivedFrom">وصول کیا گیا (شخص/ادارہ)</label>
                    <input type="text" id="transactionReceivedFrom">
                </div>
                <div class="full-width">
                    <label for="transactionDescription">تفصیل</label>
                    <textarea id="transactionDescription" rows="2"></textarea>
                </div>
            </div>
            <button type="submit">محفوظ کریں</button>
            <button type="button" id="resetTransactionBtn">منسوخ کریں</button>
        </form>
        <h3>آمدنی و اخراجات کی فہرست</h3>
        <div class="form-grid">
            <div>
                <label for="transactionFilterDate">تاریخ کے لحاظ سے فلٹر کریں:</label>
                <input type="date" id="transactionFilterDate">
            </div>
            <div>
                <label for="transactionFilterType">قسم کے لحاظ سے فلٹر کریں:</label>
                <select id="transactionFilterType">
                    <option value="">تمام</option>
                    <option value="expense">صرف اخراجات</option>
                    <option value="income">صرف آمدنی</option>
                </select>
            </div>
        </div>
        <table id="transactionsTable">
            <thead>
                <tr>
                    <th>تاریخ</th>
                    <th>قسم</th>
                    <th>زمرہ/نوعیت</th>
                    <th>تفصیل</th>
                    <th>وصول/ادا کیا گیا</th>
                    <th>رقم (آمدنی)</th>
                    <th>رقم (خرچہ)</th>
                    <th>عمل</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    `;




            const transactionForm = document.getElementById('transactionForm');
            const transactionsTableBody = document.getElementById('transactionsTable').querySelector('tbody');
            const transactionFilterDateInput = document.getElementById('transactionFilterDate');
            const transactionFilterTypeSelect = document.getElementById('transactionFilterType');
            const transactionRecordTypeSelect = document.getElementById('transactionRecordType');
            const resetTransactionBtn = document.getElementById('resetTransactionBtn');
            window.toggleTransactionFields = function () {
                const recordType = transactionRecordTypeSelect.value;
                const paidToDiv = document.getElementById('paidToDiv');
                const receivedFromDiv = document.getElementById('receivedFromDiv');
                const transactionPaidToInput = document.getElementById('transactionPaidTo');
                const transactionReceivedFromInput = document.getElementById('transactionReceivedFrom');
                if (paidToDiv) paidToDiv.style.display = (recordType === 'expense') ? 'block' : 'none';
                if (receivedFromDiv) receivedFromDiv.style.display = (recordType === 'income') ? 'block' : 'none';
                if (recordType === 'expense' && transactionReceivedFromInput) {
                    transactionReceivedFromInput.value = '';
                } else if (transactionPaidToInput) {
                    transactionPaidToInput.value = '';
                }
            }

            if (transactionRecordTypeSelect) toggleTransactionFields();
            if (transactionRecordTypeSelect) {
                transactionRecordTypeSelect.addEventListener('change', window.toggleTransactionFields);
            }
            if (transactionForm) {
                transactionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const transactionId = document.getElementById('transactionId').value;
                    const recordType = document.getElementById('transactionRecordType').value;
                    const transaction = {
                        date: document.getElementById('transactionDate').value || new Date().toISOString().split('T')[0],
                        recordType: recordType,
                        category: document.getElementById('transactionCategory').value.trim(),
                        amount: parseFloat(document.getElementById('transactionAmount').value),
                        description: document.getElementById('transactionDescription').value.trim()
                    };
                    if (recordType === 'expense') {
                        transaction.paidTo = document.getElementById('transactionPaidTo').value.trim();
                    } else {
                        transaction.receivedFrom = document.getElementById('transactionReceivedFrom').value.trim();
                    }
                    if (!transaction.category || isNaN(transaction.amount) || transaction.amount <= 0) {
                        alert('براہ کرم تاریخ، قسم، زمرہ اور رقم درست درج کریں۔');
                        return;
                    }
                    try {
                        if (transactionId) {
                            transaction.id = parseInt(transactionId);
                            await window.updateData(window.STORE_EXPENSES, transaction);
                            alert('لین دین اپ ڈیٹ ہو گیا۔');
                        } else {
                            await window.addData(window.STORE_EXPENSES, transaction);
                            alert('نیا لین دین شامل ہو گیا۔');
                        }
                        window.resetTransactionForm();
                        window.loadTransactions();
                        if (typeof window.loadDashboardStats === 'function') window.loadDashboardStats();
                    } catch (error) {
                        console.error("Error saving transaction:", error);
                        alert('لین دین محفوظ کرنے میں خرابی۔');
                    }
                });
            }
            window.resetTransactionForm = function () {
                if (transactionForm) transactionForm.reset();
                const transactionIdInput = document.getElementById('transactionId');
                const transactionDateInput = document.getElementById('transactionDate');
                const transactionRecordTypeSel = document.getElementById('transactionRecordType');
                if (transactionIdInput) transactionIdInput.value = '';
                if (transactionDateInput) transactionDateInput.value = new Date().toISOString().split('T')[0];
                if (transactionRecordTypeSel) transactionRecordTypeSel.value = 'expense';
                window.toggleTransactionFields();
            }
            if (resetTransactionBtn) {
                resetTransactionBtn.addEventListener('click', window.resetTransactionForm);
            }
            window.loadTransactions = async function () {
                if (!transactionsTableBody) return;
                transactionsTableBody.innerHTML = '<tr><td colspan="8">لوڈ ہو رہا ہے...</td></tr>';
                const filterDate = transactionFilterDateInput ? transactionFilterDateInput.value : '';
                const filterType = transactionFilterTypeSelect ? transactionFilterTypeSelect.value : '';
                try {
                    let transactions = await window.getAll(window.STORE_EXPENSES);
                    if (filterDate) {
                        transactions = transactions.filter(t => t.date === filterDate);
                    }
                    if (filterType) {
                        transactions = transactions.filter(t => t.recordType === filterType);
                    }
                    transactionsTableBody.innerHTML = '';
                    transactions
                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                        .forEach(transaction => {
                            const row = transactionsTableBody.insertRow();
                            const incomeAmount = transaction.recordType === 'income' ? transaction.amount.toLocaleString() : '-';
                            const expenseAmount = transaction.recordType === 'expense' ? transaction.amount.toLocaleString() : '-';
                            const paidOrReceivedParty = transaction.recordType === 'expense' ? (transaction.paidTo || '-') : (transaction.receivedFrom || '-');
                            row.innerHTML = `
                        <td>${transaction.date}</td>
                        <td>${transaction.recordType === 'income' ? 'آمدنی' : 'خرچہ'}</td>
                        <td>${transaction.category}</td>
                        <td>${transaction.description || '-'}</td>
                        <td>${paidOrReceivedParty}</td>
                        <td>${incomeAmount}</td>
                        <td>${expenseAmount}</td>
                        <td>
                            <button class="edit" onclick="window.editTransaction(${transaction.id})">ترمیم</button>
                            <button class="delete" onclick="window.deleteTransaction(${transaction.id})">حذف کریں</button>
                        </td>
                    `;
                        });
                    if (transactions.length === 0) {
                        let msg = 'کوئی لین دین نہیں ملا۔';
                        if (filterDate || filterType) msg = 'اس معیار پر کوئی لین دین نہیں ملا۔';
                        transactionsTableBody.innerHTML = `<tr><td colspan="8">${msg}</td></tr>`;
                    }
                } catch (error) {
                    console.error("Error loading transactions:", error);
                    transactionsTableBody.innerHTML = '<tr><td colspan="8">آمدنی و اخراجات لوڈ کرنے میں خرابی۔</td></tr>';
                }
            }
            if (transactionFilterDateInput) transactionFilterDateInput.addEventListener('change', window.loadTransactions);
            if (transactionFilterTypeSelect) transactionFilterTypeSelect.addEventListener('change', window.loadTransactions);
            window.editTransaction = async function (id) {
                try {
                    const transaction = await window.getById(window.STORE_EXPENSES, id);
                    if (transaction) {
                        document.getElementById('transactionId').value = transaction.id;
                        document.getElementById('transactionDate').value = transaction.date;
                        document.getElementById('transactionRecordType').value = transaction.recordType || 'expense';
                        document.getElementById('transactionCategory').value = transaction.category;
                        document.getElementById('transactionAmount').value = transaction.amount;
                        document.getElementById('transactionDescription').value = transaction.description || '';
                        window.toggleTransactionFields();
                        if (transaction.recordType === 'expense') {
                            document.getElementById('transactionPaidTo').value = transaction.paidTo || '';
                        } else if (transaction.recordType === 'income') {
                            document.getElementById('transactionReceivedFrom').value = transaction.receivedFrom || '';
                        }
                        if (typeof window.showModule === 'function') window.showModule('expenses');
                        window.scrollTo(0, 0);
                    }
                } catch (error) {
                    console.error("Error fetching transaction for edit:", error);
                    alert('ترمیم کے لیے لین دین لانے میں خرابی۔');
                }
            }
            window.deleteTransaction = async function (id) {
                const transaction = await window.getById(window.STORE_EXPENSES, id);
                let confirmDelete = true;
                if (transaction && transaction.category === "طالب علم فیس - خودکار") {
                    confirmDelete = confirm('یہ ایک خودکار طور پر شامل کردہ فیس کی آمدنی ہے۔ کیا آپ واقعی اسے حذف کرنا چاہتے ہیں؟ اس سے رپورٹس متاثر ہو سکتی ہیں۔');
                } else {
                    confirmDelete = confirm('کیا آپ واقعی اس لین دین کو حذف کرنا چاہتے ہیں؟');
                }
                if (!confirmDelete) return;
                try {
                    await window.deleteData(window.STORE_EXPENSES, id);
                    alert('لین دین حذف ہو گیا۔');
                    window.loadTransactions();
                    if (typeof window.loadDashboardStats === 'function') window.loadDashboardStats();
                } catch (error) {
                    console.error("Error deleting transaction:", error);
                    alert('لین دین حذف کرنے میں خرابی۔');
                }
            }

            window.addFeeIncomeToTransactions = async function (feeRecord) {
                const student = await window.getById(window.STORE_STUDENTS, feeRecord.studentId);
                const className = student ? ((typeof window.getClassName === 'function') ? await window.getClassName(student.classId) : 'N/A') : 'N/A';
                const incomeTransaction = {
                    date: feeRecord.date,
                    recordType: 'income',
                    category: 'طالب علم فیس - خودکار',
                    amount: feeRecord.paidAmount,
                    description: `فیس برائے ${student ? student.name : 'N/A'} (کلاس: ${className}), قسم: ${feeRecord.feeType}`,
                    receivedFrom: student ? student.name : 'طالب علم',
                };
                try {
                    await window.addData(window.STORE_EXPENSES, incomeTransaction);
                    console.log("Fee income automatically added to transactions.");
                    const expensesMod = document.getElementById('expenses');
                    if (expensesMod && expensesMod.classList.contains('active')) {
                        window.loadTransactions();
                    }
                } catch (error) {
                    console.error("Error auto-adding fee income to transactions:", error);
                }
            }

            console.log("Income & Expenses module setup complete.");
        }
        async function savePrintSettings() {
            const schoolName = document.getElementById('schoolNamePrint').value.trim();
            if (!schoolName) {
                alert('براہ کرم مدرسہ کا نام درج کریں۔');
                return;
            }
            try {
                await updateData(STORE_SETTINGS, { key: 'schoolName', value: schoolName });
                alert('پرنٹ سیٹنگز محفوظ ہو گئیں۔');
            } catch (error) {
                console.error("Error saving print settings:", error);
                alert('سیٹنگز محفوظ کرنے میں خرابی۔');
            }
        }
        async function loadPrintSettings() {
            try {
                const setting = await getById(STORE_SETTINGS, 'schoolName');
                if (setting) {
                    document.getElementById('schoolNamePrint').value = setting.value;
                }
            } catch (error) {
                console.error("Error loading print settings:", error);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDatabase();
                setupIncomeExpensesModule();
                showModule('dashboard');
            } catch (error) {
                console.error("Initialization error:", error);
                alert("ڈیٹا بیس لوڈ کرنے میں ناکام: " + error);
            }
        });

        function applyUrduFont(elements) {
            elements.forEach(element => {
                element.style.fontFamily = 'Calibri, Jameel Noori Nastaleeq, sans-serif';
            });
        }

        function updateLabels() {
            const labels = document.querySelectorAll('label, h1, h2, h3, h4, h5, h6, th');
            labels.forEach(label => {
                if (label.textContent.toLowerCase().includes('school')) {
                    label.textContent = label.textContent.replace(/school/gi, 'Madrasa');
                }
            });
        }

        function addMadrasaFields() {
            const studentForm = document.getElementById('studentForm');
            if (studentForm) {
                const memorizationStatusLabel = document.createElement('label');
                memorizationStatusLabel.textContent = 'حفظ کی حالت:';
                memorizationStatusLabel.style.fontFamily = 'Calibri, Jameel Noori Nastaleeq, sans-serif';
                const memorizationStatusInput = document.createElement('select');
                memorizationStatusInput.innerHTML = `
      <option value="hafiz">حافظ</option>
      <option value="non-hafiz">غیر حافظ</option>
      <option value="in-progress">زیرِ تکمیل</option>
    `;
                memorizationStatusInput.style.fontFamily = 'Calibri, Jameel Noori Nastaleeq, sans-serif';
                studentForm.appendChild(memorizationStatusLabel);
                studentForm.appendChild(memorizationStatusInput);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {

            const allTextElements = document.querySelectorAll('body *');
            applyUrduFont(allTextElements);

            updateLabels();

            addMadrasaFields();
        });
        document.addEventListener('DOMContentLoaded', async function () {

            try {

                const scripts = [
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
                ];
                for (const src of scripts) {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    document.head.appendChild(script);
                    await new Promise((resolve, reject) => {
                        script.onload = resolve;
                        script.onerror = () => reject(new Error(`Failed to load ${src}`));
                    });
                }
                console.log('All libraries loaded successfully');
            } catch (error) {
                console.error('Error loading libraries:', error);
                return;
            }

            function isTableVisible(table) {
                const rect = table.getBoundingClientRect();
                let parent = table;
                while (parent && parent !== document.body) {
                    const style = window.getComputedStyle(parent);
                    if (style.display === 'none' || style.visibility === 'hidden') {
                        return false;
                    }
                    parent = parent.parentElement;
                }
                return (
                    table.offsetParent !== null &&
                    rect.top < window.innerHeight &&
                    rect.bottom > 0 &&
                    rect.left < window.innerWidth &&
                    rect.right > 0
                );
            }

            function getParentZIndex(table) {
                let parent = table;
                while (parent && parent !== document.body) {
                    const zIndex = window.getComputedStyle(parent).zIndex;
                    if (zIndex && zIndex !== 'auto') {
                        return parseInt(zIndex) + 1;
                    }
                    parent = parent.parentElement;
                }
                return 10;
            }

            function addExportIconToTables() {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    if (!table.dataset.pdfIconAdded) {

                        const iconContainer = document.createElement('div');
                        iconContainer.className = 'pdf-export-container';
                        iconContainer.style.position = 'absolute';
                        iconContainer.style.pointerEvents = 'none';

                        const icon = document.createElement('span');
                        icon.className = 'pdf-export-icon';
                        icon.style.display = 'inline-block';
                        icon.style.cursor = 'pointer';
                        icon.style.pointerEvents = 'auto';
                        icon.style.fontSize = '14px';
                        icon.style.background = '#ffffff';
                        icon.style.border = '1px solid #ccc';
                        icon.style.borderRadius = '50%';
                        icon.style.padding = '4px';
                        icon.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                        icon.style.transition = 'transform 0.2s';
                        icon.innerHTML = '📄';
                        icon.title = 'Export to PDF';

                        icon.addEventListener('mouseenter', () => {
                            icon.style.transform = 'scale(1.2)';
                        });
                        icon.addEventListener('mouseleave', () => {
                            icon.style.transform = 'scale(1)';
                        });

                        const updateIconPosition = () => {
                            if (isTableVisible(table)) {
                                const tablePos = table.getBoundingClientRect();
                                iconContainer.style.left = `${tablePos.left + window.scrollX - 20}px`;
                                iconContainer.style.top = `${tablePos.top + window.scrollY - 20}px`;
                                iconContainer.style.zIndex = getParentZIndex(table);
                                iconContainer.style.display = 'block';
                            } else {
                                iconContainer.style.display = 'none';
                            }
                        };

                        icon.addEventListener('click', async () => {
                            try {
                                if (!window.jspdf || !window.jspdf.jsPDF || !window.html2canvas) {
                                    alert('Required libraries not loaded. Please try again.');
                                    return;
                                }
                                const { jsPDF } = window.jspdf;

                                const loadingEl = document.createElement('div');
                                loadingEl.style.position = 'fixed';
                                loadingEl.style.top = '50%';
                                loadingEl.style.left = '50%';
                                loadingEl.style.transform = 'translate(-50%, -50%)';
                                loadingEl.style.padding = '15px 20px';
                                loadingEl.style.background = 'rgba(0,0,0,0.7)';
                                loadingEl.style.color = 'white';
                                loadingEl.style.borderRadius = '5px';
                                loadingEl.style.zIndex = '9999';
                                loadingEl.textContent = 'Generating PDF...';
                                document.body.appendChild(loadingEl);

                                const tableClone = table.cloneNode(true);

                                tableClone.style.width = table.offsetWidth + 'px';
                                tableClone.style.fontFamily = 'Arial, sans-serif';
                                tableClone.style.borderCollapse = 'collapse';
                                tableClone.style.direction = 'rtl';

                                tableClone.querySelectorAll('th, td').forEach(cell => {
                                    cell.style.border = '1px solid #ddd';
                                    cell.style.padding = '8px';
                                    cell.style.textAlign = 'right';
                                });

                                tableClone.querySelectorAll('th').forEach(th => {
                                    th.style.backgroundColor = '#f2f2f2';
                                    th.style.fontWeight = 'bold';
                                });

                                const container = document.createElement('div');
                                container.style.position = 'absolute';
                                container.style.left = '-9999px';
                                container.style.top = '-9999px';
                                container.style.direction = 'rtl';
                                container.appendChild(tableClone);
                                document.body.appendChild(container);

                                let title = '';
                                const caption = table.querySelector('caption');
                                if (caption) {
                                    title = caption.textContent.trim();
                                } else {
                                    title = 'Table Export';
                                }

                                const titleEl = document.createElement('h2');
                                titleEl.textContent = title;
                                titleEl.style.textAlign = 'center';
                                titleEl.style.margin = '10px 0';
                                titleEl.style.fontFamily = 'Arial, sans-serif';
                                container.insertBefore(titleEl, tableClone);

                                await new Promise(resolve => setTimeout(resolve, 100));

                                const canvas = await html2canvas(container, {
                                    scale: 2,
                                    useCORS: true,
                                    logging: false,
                                    allowTaint: true,
                                    backgroundColor: '#ffffff'
                                });

                                const imgData = canvas.toDataURL('image/png');
                                const imgWidth = 210;
                                const pageHeight = 297;
                                const imgHeight = canvas.height * imgWidth / canvas.width;
                                const doc = new jsPDF('p', 'mm', 'a4');
                                let position = 0;

                                if (imgHeight < pageHeight) {

                                    doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                                } else {

                                    let heightLeft = imgHeight;
                                    let page = 1;
                                    while (heightLeft > 0) {
                                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight, '', 'FAST');
                                        heightLeft -= pageHeight;
                                        position -= pageHeight;
                                        if (heightLeft > 0) {
                                            doc.addPage();
                                            page++;
                                        }
                                    }
                                }

                                document.body.removeChild(container);
                                document.body.removeChild(loadingEl);

                                const filename = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${Date.now()}.pdf`;
                                doc.save(filename);
                            } catch (error) {
                                console.error('Error generating PDF:', error);

                                const loadingEl = document.querySelector('div[style*="Generating PDF"]');
                                if (loadingEl) document.body.removeChild(loadingEl);
                                alert('Failed to export PDF. Check console for details.');
                            }
                        });

                        iconContainer.appendChild(icon);
                        document.body.appendChild(iconContainer);

                        table.dataset.pdfIconAdded = 'true';

                        updateIconPosition();

                        const mutationObserver = new MutationObserver(updateIconPosition);
                        mutationObserver.observe(table, { attributes: true, attributeFilter: ['style', 'class'] });

                        const resizeObserver = new ResizeObserver(updateIconPosition);
                        resizeObserver.observe(table);

                        window.addEventListener('scroll', updateIconPosition);
                        window.addEventListener('resize', updateIconPosition);
                    }
                });
            }

            try {
                addExportIconToTables();
            } catch (error) {
                console.error('Error in initial table processing:', error);
            }

            let timeout;
            const observer = new MutationObserver(() => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    try {
                        addExportIconToTables();
                    } catch (error) {
                        console.error('Error in dynamic table processing:', error);
                    }
                }, 1000);
            });
            observer.observe(document.documentElement, {
                childList: true,
                subtree: true
            });
        });
        (function () {
            async function savePageOffline() {
                try {
                    // 1. Capture the current localStorage and sessionStorage data
                    const localData = JSON.stringify(localStorage);
                    const sessionData = JSON.stringify(sessionStorage);

                    // 2. Create the script that will restore the data when the offline file is opened.
                    // This script is created as a string to be injected into the raw HTML.
                    const restoreScriptText = `
                <script id="restore-storage-script">
                    try {
                        const local = ${localData};
                        const session = ${sessionData};
                        if (local) Object.keys(local).forEach(key => localStorage.setItem(key, local[key]));
                        if (session) Object.keys(session).forEach(key => sessionStorage.setItem(key, session[key]));
                    } catch (e) {
                        console.error('Error restoring storage:', e);
                    }
                <\/script> 
            `; // The <\/script> is to prevent parsing issues.

                    // 3. Fetch the original HTML source of the current page. This is the key step.
                    const response = await fetch(window.location.href);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch page source: ${response.statusText}`);
                    }
                    let originalHtml = await response.text();

                    // 4. Inject the restoration script right after the opening <head> tag using string replacement.
                    // This ensures it runs before any other scripts on the page.
                    originalHtml = originalHtml.replace(
                        /(<head.*?>)/i,
                        `$1\n${restoreScriptText}`
                    );

                    // 5. Create a Blob from the modified HTML string and trigger the download.
                    const blob = new Blob([originalHtml], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'madrasa_system_offline_copy.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Failed to save offline copy:', error);
                    alert('Could not save offline copy. Check the console for more details.');
                }
            }

            // This creates the save icon button on the page.
            const icon = document.createElement('div');
            icon.textContent = "💾";
            icon.title = "Save Offline Copy";
            Object.assign(icon.style, {
                position: 'fixed',
                top: '5px',
                left: '10px',
                fontSize: '24px',
                cursor: 'pointer',
                zIndex: '9999',
                background: '#fff',
                padding: '5px',
                borderRadius: '5px',
                boxShadow: '0 0 5px rgba(0,0,0,0.5)'
            });
            icon.onclick = savePageOffline;
            document.body.appendChild(icon);
        })();
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Breadcrumb script running');

            const isMobile = window.matchMedia("(max-width: 768px)").matches;
            console.log('Is mobile:', isMobile);
            if (!isMobile) return;
            const nav = document.querySelector('nav');
            if (!nav) {
                console.error('Navigation bar not found');
                return;
            }
            const originalButtons = nav.querySelectorAll('button');
            if (originalButtons.length === 0) {
                console.error('No buttons found in navigation');
                return;
            }
            const container = document.querySelector('.container');
            if (!container) {
                console.error('Container not found');
                return;
            }

            const breadcrumb = document.createElement('div');
            breadcrumb.className = 'breadcrumb';
            breadcrumb.style.cssText = `
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #5a8dee;
        color: white;
        font-family: 'Noto Nastaliq Urdu', sans-serif;
        font-size: 1.2em;
        margin-bottom: 10px;
        width: 100%;
        box-sizing: border-box;
        position: relative;
        z-index: 1000;
    `;

            const menuButton = document.createElement('button');
            menuButton.textContent = '☰';
            menuButton.style.cssText = `
        background: none;
        border: none;
        color: white;
        font-size: 1em;
        cursor: pointer;
        margin-left: 10px;
        padding: 5px 10px;
    `;

            const currentPage = document.createElement('span');
            currentPage.textContent = 'ڈیش بورڈ';
            currentPage.style.cssText = `
        flex: 1;
        text-align: right;
    `;

            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown-menu';
            dropdown.style.cssText = `
        display: none;
        position: absolute;
        top: 100%;
        right: 10px;
        background-color: #4a7bdc;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1001;
        min-width: 200px;
    `;

            originalButtons.forEach(button => {
                const moduleIdMatch = button.getAttribute('onclick')?.match(/showModule\('([^']+)'\)/);
                if (!moduleIdMatch) {
                    console.warn('Button missing valid onclick:', button.textContent);
                    return;
                }
                const moduleId = moduleIdMatch[1];
                const menuItem = document.createElement('button');
                menuItem.textContent = button.textContent;
                menuItem.style.cssText = `
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: none;
            border: none;
            color: white;
            text-align: right;
            cursor: pointer;
            font-family: 'Noto Nastaliq Urdu', sans-serif;
            font-size: 1.2em;
        `;
                menuItem.addEventListener('click', () => {
                    console.log('Menu item clicked:', moduleId);
                    window.showModule(moduleId);
                    currentPage.textContent = button.textContent;
                    dropdown.style.display = 'none';
                    console.log('Dropdown hidden after menu item click');
                });
                dropdown.appendChild(menuItem);
            });

            menuButton.addEventListener('click', () => {
                const isVisible = dropdown.style.display === 'block';
                dropdown.style.display = isVisible ? 'none' : 'block';
                console.log('Dropdown toggled:', dropdown.style.display);
            });

            document.addEventListener('click', (e) => {
                if (!breadcrumb.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.style.display = 'none';
                    console.log('Dropdown closed (outside click)');
                }
            });

            breadcrumb.appendChild(menuButton);
            breadcrumb.appendChild(currentPage);
            breadcrumb.appendChild(dropdown);

            nav.style.display = 'none';
            container.insertBefore(breadcrumb, container.firstChild);
            console.log('Breadcrumb inserted');

            const originalShowModule = window.showModule;
            window.showModule = function (moduleId) {
                console.log('showModule called:', moduleId);
                originalShowModule(moduleId);
                const activeButton = Array.from(originalButtons).find(btn =>
                    btn.getAttribute('onclick')?.includes(moduleId));
                if (activeButton) {
                    currentPage.textContent = activeButton.textContent;
                    dropdown.style.display = 'none';
                    console.log('Current page updated:', activeButton.textContent);
                }
            };
        });
        document.addEventListener('DOMContentLoaded', () => {

            const tableConfigs = [
                { id: 'studentsTable', searchable: true, sortable: true, paginated: true },
                { id: 'teachersTable', searchable: true, sortable: true, paginated: true },
                { id: 'classesTable', searchable: true, sortable: true, paginated: true },
                { id: 'feeStructuresTable', searchable: true, sortable: true, paginated: true },
                { id: 'feeHistoryTable', searchable: true, sortable: true, paginated: true },
                { id: 'attendanceTable', searchable: true, sortable: true, paginated: true },
                { id: 'resultsEntryTable', searchable: true, sortable: true, paginated: true },
                { id: 'classTimetableTable', searchable: true, sortable: true, paginated: true },
                { id: 'teacherRoasterTable', searchable: true, sortable: true, paginated: true },
                { id: 'expensesTable', searchable: true, sortable: true, paginated: true }
            ];

            function debounce(func, wait) {
                let timeout;
                return function (...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }

            function throttle(func, limit) {
                let inThrottle;
                return function (...args) {
                    if (!inThrottle) {
                        func(...args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }

            function isTableVisible(table) {
                return table && table.offsetParent !== null;
            }

            const initializedTables = new Set();

            function enhanceTable(config) {
                const table = document.getElementById(config.id);
                if (!table) {
                    console.warn(`Table with ID ${config.id} not found.`);
                    return;
                }

                if (!isTableVisible(table) || initializedTables.has(config.id)) {
                    return;
                }
                try {
                    initializedTables.add(config.id);
                    const tbody = table.querySelector('tbody');
                    const headers = table.querySelectorAll('thead th');
                    let originalRows = Array.from(tbody.querySelectorAll('tr'));
                    let rows = [...originalRows];
                    let currentPage = 1;
                    const rowsPerPage = 10;

                    let controlsContainer = table.parentNode.querySelector(`.controls-${config.id}`);
                    if (!controlsContainer) {
                        controlsContainer = document.createElement('div');
                        controlsContainer.className = `controls-${config.id}`;
                        controlsContainer.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                    flex-wrap: wrap;
                    gap: 10px;
                `;
                        table.parentNode.insertBefore(controlsContainer, table);
                    }

                    let searchInput;
                    if (config.searchable && !controlsContainer.querySelector('input')) {
                        searchInput = document.createElement('input');
                        searchInput.type = 'text';
                        searchInput.placeholder = 'تلاش کریں...';
                        searchInput.style.cssText = `
                    padding: 0px;
                    width: 200px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-family: 'Noto Nastaliq Urdu', sans-serif;
                    font-size: large;
                `;
                        controlsContainer.appendChild(searchInput);
                        searchInput.addEventListener('input', debounce(() => {
                            try {
                                const searchTerm = searchInput.value.toLowerCase();
                                if (searchTerm) {
                                    rows = originalRows.filter(row =>
                                        Array.from(row.cells).some(cell =>
                                            cell.textContent.toLowerCase().includes(searchTerm)
                                        )
                                    );
                                } else {
                                    rows = [...originalRows];
                                }
                                currentPage = 1;
                                renderTable();
                            } catch (error) {
                                console.error(`Error in search for ${config.id}:`, error);
                            }
                        }, 500));
                    }

                    if (config.sortable) {
                        headers.forEach((th, index) => {

                            if (th.textContent.includes('عمل')) return;
                            th.style.cursor = 'pointer';
                            th.dataset.sortDir = 'asc';
                            th.addEventListener('click', () => {
                                try {
                                    const sortDir = th.dataset.sortDir === 'asc' ? 'desc' : 'asc';
                                    th.dataset.sortDir = sortDir;
                                    headers.forEach(h => {
                                        if (h !== th) h.dataset.sortDir = 'asc';
                                    });
                                    rows.sort((a, b) => {
                                        let aText = a.cells[index].textContent.trim();
                                        let bText = b.cells[index].textContent.trim();
                                        const isNumeric = !isNaN(parseFloat(aText)) && isFinite(aText);
                                        const isDate = Date.parse(aText) && aText.includes('-');
                                        if (isDate) {
                                            aText = new Date(aText).getTime();
                                            bText = new Date(bText).getTime();
                                        } else if (isNumeric) {
                                            aText = parseFloat(aText);
                                            bText = parseFloat(bText);
                                        }
                                        return sortDir === 'asc'
                                            ? aText > bText ? 1 : -1
                                            : aText < bText ? 1 : -1;
                                    });
                                    renderTable();
                                } catch (error) {
                                    console.error(`Error in sorting for ${config.id}:`, error);
                                }
                            });
                        });
                    }

                    let paginationContainer;
                    if (config.paginated && !controlsContainer.querySelector('.pagination')) {
                        paginationContainer = document.createElement('div');
                        paginationContainer.className = 'pagination';
                        paginationContainer.style.cssText = `
                    display: flex;
                    gap: 5px;
                    align-items: center;
                `;
                        controlsContainer.appendChild(paginationContainer);
                    } else {
                        paginationContainer = controlsContainer.querySelector('.pagination');
                    }

                    function renderTable() {
                        try {
                            tbody.innerHTML = '';
                            const start = (currentPage - 1) * rowsPerPage;
                            const end = Math.min(start + rowsPerPage, rows.length);
                            const paginatedRows = rows.slice(start, end);
                            paginatedRows.forEach(row => tbody.appendChild(row));
                            if (config.paginated) {
                                updatePagination();
                            }
                            if (rows.length === 0) {
                                tbody.innerHTML = `<tr><td colspan="${headers.length}">کوئی ڈیٹا نہیں ملا</td></tr>`;
                            }
                        } catch (error) {
                            console.error(`Error rendering table ${config.id}:`, error);
                            tbody.innerHTML = `<tr><td colspan="${headers.length}">جدول رینڈر کرنے میں خرابی</td></tr>`;
                        }
                    }

                    function updatePagination() {
                        try {
                            paginationContainer.innerHTML = '';
                            const totalPages = Math.ceil(rows.length / rowsPerPage);
                            const prevButton = document.createElement('button');
                            prevButton.textContent = 'پچھلا';
                            prevButton.style.cssText = `
                        padding: 3px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                        background-color: #5cb85c;
                        color: white;
                        cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};
                        font-family: 'Noto Nastaliq Urdu', sans-serif;
                        font-size: small;
                    `;
                            prevButton.disabled = currentPage === 1;
                            prevButton.addEventListener('click', () => {
                                try {
                                    if (currentPage > 1) {
                                        currentPage--;
                                        renderTable();
                                    }
                                } catch (error) {
                                    console.error(`Error in prev button for ${config.id}:`, error);
                                }
                            });
                            paginationContainer.appendChild(prevButton);
                            const pageNumbers = document.createElement('span');
                            pageNumbers.textContent = `صفحہ ${currentPage} از ${totalPages}`;
                            pageNumbers.style.cssText = `
                        padding: 8px;
                        font-family: 'Noto Nastaliq Urdu', sans-serif;
                        font-size: 1.2em;
                    `;
                            paginationContainer.appendChild(pageNumbers);
                            const nextButton = document.createElement('button');
                            nextButton.textContent = 'اگلا';
                            nextButton.style.cssText = `
                        padding: 3px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                        background-color: #5cb85c;
                        color: white;
                        cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};
                        font-family: 'Noto Nastaliq Urdu', sans-serif;
                        font-size: small;
                    `;
                            nextButton.disabled = currentPage === totalPages;
                            nextButton.addEventListener('click', () => {
                                try {
                                    if (currentPage < totalPages) {
                                        currentPage++;
                                        renderTable();
                                    }
                                } catch (error) {
                                    console.error(`Error in next button for ${config.id}:`, error);
                                }
                            });
                            paginationContainer.appendChild(nextButton);
                        } catch (error) {
                            console.error(`Error updating pagination for ${config.id}:`, error);
                        }
                    }

                    renderTable();

                    const observer = new MutationObserver(throttle(() => {
                        try {
                            originalRows = Array.from(tbody.querySelectorAll('tr'));
                            rows = [...originalRows];
                            currentPage = 1;
                            renderTable();
                        } catch (error) {
                            console.error(`Error in MutationObserver for ${config.id}:`, error);
                        }
                    }, 1000));
                    observer.observe(tbody, { childList: true, subtree: true });
                } catch (error) {
                    console.error(`Error initializing table ${config.id}:`, error);
                }
            }

            function initializeTables() {
                tableConfigs.forEach(config => {
                    try {
                        enhanceTable(config);
                    } catch (error) {
                        console.error(`Error initializing table ${config.id}:`, error);
                    }
                });
            }

            try {
                initializeTables();
            } catch (error) {
                console.error('Error during table initialization:', error);
            }

            const originalShowModule = window.showModule || function () { };
            window.showModule = function (moduleId) {
                try {
                    originalShowModule(moduleId);

                    initializedTables.clear();

                    document.querySelectorAll('[class^="controls-"]').forEach(container => container.remove());
                    setTimeout(initializeTables, 500);
                } catch (error) {
                    console.error('Error in showModule override:', error);
                }
            };
        });
        document.querySelectorAll("*").forEach(el => {
            if (el.childNodes.length) {
                el.childNodes.forEach(node => {
                    if (node.nodeType === 3) {
                        let text = node.nodeValue;

                        text = text.replace(/পিরিয়ড/g, 'پیریڈ');
                        text = text.replace(/شروع/g, 'شروع');
                        text = text.replace(/শেষ/g, 'ختم');
                        text = text.replace(/দিন/g, 'دن');

                        const bengaliToUrduDigits = {
                            '০': '۰', '১': '۱', '২': '۲', '৩': '۳', '৪': '۴',
                            '৫': '۵', '৬': '۶', '৭': '۷', '৮': '۸', '৯': '۹'
                        };
                        text = text.replace(/[০-৯]/g, m => bengaliToUrduDigits[m]);
                        node.nodeValue = text;
                    }
                });
            }
        });
        function createResultsModule() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const h2 = document.createElement('h2');
            h2.textContent = 'نتائج کا انتظام';
            resultsDiv.appendChild(h2);

            const entryH3 = document.createElement('h3');
            entryH3.textContent = 'نتائج درج کریں';
            resultsDiv.appendChild(entryH3);
            const formGrid = document.createElement('div');
            formGrid.className = 'form-grid';
            formGrid.innerHTML = `
        <div>
            <label for="resultExamName">امتحان کا نام</label>
            <input type="text" id="resultExamName" placeholder="مثال: Mid Term" required>
        </div>
        <div>
            <label for="resultClass">کلاس</label>
            <select id="resultClass" required onchange="loadStudentsAndSubjectsForResult()">
                <option value="">-- کلاس منتخب کریں --</option>
            </select>
        </div>
        <div>
            <label for="resultSubject">مضمون</label>
            <select id="resultSubject" required>
                <option value="">-- مضمون منتخب کریں --</option>
            </select>
        </div>
        <div>
            <label for="resultDate">تاریخ</label>
            <input type="date" id="resultDate" required>
        </div>
    `;
            resultsDiv.appendChild(formGrid);
            const entryTable = document.createElement('table');
            entryTable.id = 'resultsEntryTable';
            entryTable.innerHTML = `
        <thead>
            <tr>
                <th>طالب علم</th>
                <th>کل نمبر</th>
                <th>حاصل کردہ نمبر</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="3">کلاس منتخب کریں۔</td></tr>
        </tbody>
    `;
            resultsDiv.appendChild(entryTable);
            const saveButton = document.createElement('button');
            saveButton.textContent = 'محفوظ کریں';
            saveButton.onclick = saveResults;
            resultsDiv.appendChild(saveButton);

            const viewH3 = document.createElement('h3');
            viewH3.textContent = 'موجودہ نتائج دیکھیں';
            resultsDiv.appendChild(viewH3);
            const filterGrid = document.createElement('div');
            filterGrid.className = 'form-grid';
            filterGrid.innerHTML = `
        <div>
            <label for="filterResultExam">امتحان</label>
            <select id="filterResultExam" onchange="loadPastResults()">
                <option value="">-- تمام --</option>
            </select>
        </div>
        <div>
            <label for="filterResultStudent">طالب علم</label>
            <select id="filterResultStudent" onchange="loadPastResults()">
                <option value="">-- تمام --</option>
            </select>
        </div>
        <div>
            <label for="filterResultClass">کلاس</label>
            <select id="filterResultClass" onchange="loadPastResults()">
                <option value="">-- تمام --</option>
            </select>
        </div>
    `;
            resultsDiv.appendChild(filterGrid);
            const pastTable = document.createElement('table');
            pastTable.id = 'pastResultsTable';
            pastTable.innerHTML = `
        <thead>
            <tr>
                <th>امتحان</th>
                <th>کلاس</th>
                <th>طالب علم</th>
                <th>مضمون</th>
                <th>تاریخ</th>
                <th>کل نمبر</th>
                <th>حاصل کردہ نمبر</th>
                <th>عمل</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="8">فلٹر منتخب کریں۔</td></tr>
        </tbody>
    `;
            resultsDiv.appendChild(pastTable);

            const printH3 = document.createElement('h3');
            printH3.textContent = 'رزلٹ کارڈ پرنٹ کریں';
            resultsDiv.appendChild(printH3);
            const printGrid = document.createElement('div');
            printGrid.className = 'form-grid';
            printGrid.innerHTML = `
        <div>
            <label for="resultCardStudent">طالب علم</label>
            <select id="resultCardStudent" required>
                <option value="">-- طالب علم منتخب کریں --</option>
            </select>
        </div>
        <div>
            <label for="resultCardExam">امتحان</label>
            <select id="resultCardExam" required>
                <option value="">-- امتحان منتخب کریں --</option>
            </select>
        </div>
    `;
            resultsDiv.appendChild(printGrid);
            const printButton = document.createElement('button');
            printButton.className = 'print';
            printButton.textContent = 'پرنٹ کریں';
            printButton.onclick = printResultCard;
            resultsDiv.appendChild(printButton);
            const printContainer = document.createElement('div');
            printContainer.id = 'resultCardPrintContainer';
            printContainer.className = 'printable';
            printContainer.innerHTML = `
        <h3>رزلٹ کارڈ</h3>
        <p><strong>مدرسہ:</strong> <span id="printResultSchoolName"></span></p>
        <p><strong>امتحان:</strong> <span id="printResultExamName"></span></p>
        <p><strong>طالب علم:</strong> <span id="printResultStudentName"></span></p>
        <p><strong>کلاس:</strong> <span id="printResultClassName"></span></p>
        <table id="resultCardPrintTable" class="printable-content">
            <thead>
                <tr>
                    <th>مضمون</th>
                    <th>کل نمبر</th>
                    <th>حاصل کردہ نمبر</th>
                    <th>فیصد</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p><strong>کل نمبر:</strong> <span id="printResultTotalMarks"></span></p>
        <p><strong>حاصل کردہ:</strong> <span id="printResultTotalObtained"></span></p>
        <p><strong>فیصد:</strong> <span id="printResultOverallPercentage"></span>%</p>
        <p><strong>نتیجہ:</strong> <span id="printResultStatus"></span></p>
    `;
            resultsDiv.appendChild(printContainer);
        }
        async function loadClassesForResults() {
            const classSelect = document.getElementById('resultClass');
            const filterClassSelect = document.getElementById('filterResultClass');
            classSelect.innerHTML = '<option value="">-- کلاس منتخب کریں --</option>';
            filterClassSelect.innerHTML = '<option value="">-- تمام --</option>';
            try {
                const classes = await getAll(STORE_CLASSES);
                classes.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
                    const option1 = document.createElement('option');
                    option1.value = cls.id;
                    option1.textContent = cls.name;
                    classSelect.appendChild(option1);
                    const option2 = option1.cloneNode(true);
                    filterClassSelect.appendChild(option2);
                });
            } catch (error) {
                console.error("Error loading classes:", error);
            }
        }
        async function loadStudentsForResultCard() {
            const studentSelect = document.getElementById('resultCardStudent');
            const filterStudentSelect = document.getElementById('filterResultStudent');
            studentSelect.innerHTML = '<option value="">-- طالب علم منتخب کریں --</option>';
            filterStudentSelect.innerHTML = '<option value="">-- تمام --</option>';
            try {
                const students = await getAll(STORE_STUDENTS);
                students.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                    const option1 = document.createElement('option');
                    option1.value = student.id;
                    option1.textContent = student.name;
                    studentSelect.appendChild(option1);
                    const option2 = option1.cloneNode(true);
                    filterStudentSelect.appendChild(option2);
                });
            } catch (error) {
                console.error("Error loading students:", error);
            }
        }
        async function loadExamsForResultCard() {
            const examSelect = document.getElementById('resultCardExam');
            const filterExamSelect = document.getElementById('filterResultExam');
            examSelect.innerHTML = '<option value="">-- امتحان منتخب کریں --</option>';
            filterExamSelect.innerHTML = '<option value="">-- تمام --</option>';
            try {
                const results = await getAll(STORE_RESULTS);
                const exams = [...new Set(results.map(r => r.examName))].sort();
                exams.forEach(exam => {
                    const option1 = document.createElement('option');
                    option1.value = exam;
                    option1.textContent = exam;
                    examSelect.appendChild(option1);
                    const option2 = option1.cloneNode(true);
                    filterExamSelect.appendChild(option2);
                });
            } catch (error) {
                console.error("Error loading exams:", error);
            }
        }
        // --- QR Code Generation and Library Loader ---

        let qrCodeLibraryLoaded = false; // Keep track of library loading status

        async function ensureQRCodeLibrary() {
            if (qrCodeLibraryLoaded && window.QRCode) return true; // Already loaded and available

            if (!window.QRCode) { // Check if QRCode constructor exists
                console.log("QRCode.js library not found, attempting to load...");
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                script.async = true;
                document.head.appendChild(script);

                try {
                    await new Promise((resolve, reject) => {
                        script.onload = () => {
                            if (window.QRCode) {
                                console.log("QRCode.js library loaded successfully.");
                                qrCodeLibraryLoaded = true;
                                resolve();
                            } else {
                                console.error("QRCode.js loaded but QRCode constructor not found.");
                                reject(new Error("QRCode.js loaded but QRCode constructor not found."));
                            }
                        };
                        script.onerror = () => {
                            console.error("Failed to load QRCode.js library.");
                            alert("QR کوڈ لائبریری لوڈ کرنے میں ناکامی۔");
                            reject(new Error("QRCode.js library load failed"));
                        };
                        // Timeout for loading
                        setTimeout(() => {
                            if (!qrCodeLibraryLoaded) {
                                console.warn("QRCode.js loading timeout.");
                                reject(new Error("QRCode.js loading timeout."));
                            }
                        }, 5000); // 5 seconds timeout
                    });
                    return true;
                } catch (error) {
                    qrCodeLibraryLoaded = false;
                    console.error("Error in ensureQRCodeLibrary:", error);
                    return false;
                }
            } else {
                qrCodeLibraryLoaded = true; // Already present
                return true;
            }
        }

        async function generateQRCodeDataURL(textData, size = 80) {
            const libLoaded = await ensureQRCodeLibrary();
            if (!libLoaded || !window.QRCode) {
                console.error("QRCode library is not available for QR generation.");
                return null;
            }

            return new Promise((resolve) => {
                const tempElement = document.createElement('div');
                // QRCode.js appends to the element it's given
                try {
                    new QRCode(tempElement, {
                        text: textData,
                        width: size,
                        height: size,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.L // Medium error correction
                    });

                    // QRCode.js might create a canvas or an img tag
                    // We need to wait for it to render
                    setTimeout(() => {
                        const canvas = tempElement.querySelector('canvas');
                        const img = tempElement.querySelector('img');

                        if (canvas) {
                            resolve(canvas.toDataURL('image/png'));
                        } else if (img && img.src.startsWith('data:image')) {
                            // If it generated an img tag with a data URL (some versions might)
                            resolve(img.src);
                        } else {
                            console.warn("QR Code was generated, but couldn't extract data URL (no canvas or img found).");
                            resolve(null); // Fallback
                        }
                    }, 100); // Give it a moment to render
                } catch (e) {
                    console.error("Error during QRCode instantiation:", e);
                    resolve(null);
                }
            });
        }
        async function loadStudentsAndSubjectsForResult() {
            const classId = document.getElementById('resultClass').value;
            const tableBody = document.getElementById('resultsEntryTable').querySelector('tbody');
            const subjectSelect = document.getElementById('resultSubject');
            tableBody.innerHTML = '<tr><td colspan="3">لوڈ ہو رہا ہے...</td></tr>';
            subjectSelect.innerHTML = '<option value="">-- مضمون منتخب کریں --</option>';
            if (!classId) {
                tableBody.innerHTML = '<tr><td colspan="3">کلاس منتخب کریں۔</td></tr>';
                return;
            }
            try {
                const cls = await getById(STORE_CLASSES, parseInt(classId));
                if (!cls) {
                    tableBody.innerHTML = '<tr><td colspan="3">کلاس نہیں ملی۔</td></tr>';
                    return;
                }
                const students = await getAll(STORE_STUDENTS, 'classId', parseInt(classId));
                students.sort((a, b) => a.name.localeCompare(b.name));

                let subjects = [];
                if (cls.subjects) {
                    if (typeof cls.subjects === 'string') {
                        subjects = cls.subjects.split(',').map(s => s.trim()).filter(s => s);
                    } else if (Array.isArray(cls.subjects)) {
                        subjects = cls.subjects.filter(s => s).map(s => s.trim());
                    }
                }
                subjects.sort().forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectSelect.appendChild(option);
                });
                tableBody.innerHTML = '';
                if (students.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3">اس کلاس میں کوئی طالب علم نہیں۔</td></tr>';
                    return;
                }
                students.forEach(student => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                <td>${student.name}</td>
                <td><input type="number" class="totalMarks" min="0" value="100"></td>
                <td><input type="number" class="obtainedMarks" min="0" max="100" value="0"></td>
            `;
                    row.dataset.studentId = student.id;
                });
            } catch (error) {
                console.error("Error loading students/subjects:", error);
                tableBody.innerHTML = '<tr><td colspan="3">خرابی: ڈیٹا لوڈ نہیں ہو سکا۔</td></tr>';
            }
        }
        async function saveResults() {
            const examName = document.getElementById('resultExamName').value.trim();
            const classId = parseInt(document.getElementById('resultClass').value);
            const subject = document.getElementById('resultSubject').value;
            const date = document.getElementById('resultDate').value;
            if (!examName || !classId || !subject || !date) {
                alert('تمام فیلڈز پُر کریں۔');
                return;
            }
            const tableBody = document.getElementById('resultsEntryTable').querySelector('tbody');
            const rows = tableBody.querySelectorAll('tr');
            try {
                for (const row of rows) {
                    const studentId = parseInt(row.dataset.studentId);
                    const totalMarks = parseInt(row.querySelector('.totalMarks').value) || 0;
                    const obtainedMarks = parseInt(row.querySelector('.obtainedMarks').value) || 0;
                    if (obtainedMarks > totalMarks) {
                        alert('حاصل کردہ نمبر کل نمبروں سے زیادہ نہیں ہو سکتے۔');
                        return;
                    }
                    const result = { examName, classId, subject, studentId, date, totalMarks, obtainedMarks };
                    const existing = await getAll(STORE_RESULTS, 'exam_class_subject_student',
                        [examName, classId, subject, studentId]);
                    if (existing.length > 0) {
                        result.id = existing[0].id;
                        await updateData(STORE_RESULTS, result);
                    } else {
                        await addData(STORE_RESULTS, result);
                    }
                }
                alert('نتائج محفوظ ہو گئے۔');
                loadStudentsAndSubjectsForResult();
                loadPastResults();
                loadExamsForResultCard();
            } catch (error) {
                console.error("Error saving results:", error);
                alert('خرابی: ' + error.message);
            }
        }
        async function loadPastResults() {
            const tableBody = document.getElementById('pastResultsTable').querySelector('tbody');
            const examName = document.getElementById('filterResultExam').value;
            const studentId = parseInt(document.getElementById('filterResultStudent').value) || null;
            const classId = parseInt(document.getElementById('filterResultClass').value) || null;
            tableBody.innerHTML = '<tr><td colspan="8">لوڈ ہو رہا ہے...</td></tr>';
            try {
                let results = await getAll(STORE_RESULTS);
                results = results.filter(r =>
                    (!examName || r.examName === examName) &&
                    (!studentId || r.studentId === studentId) &&
                    (!classId || r.classId === classId)
                );
                tableBody.innerHTML = '';
                if (results.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="8">کوئی نتائج نہیں۔</td></tr>';
                    return;
                }
                for (const r of results.sort((a, b) => new Date(b.date) - new Date(a.date))) {
                    const className = await getClassName(r.classId);
                    const studentName = await getStudentName(r.studentId);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                <td>${r.examName}</td>
                <td>${className}</td>
                <td>${studentName}</td>
                <td>${r.subject}</td>
                <td>${r.date}</td>
                <td>${r.totalMarks}</td>
                <td>${r.obtainedMarks}</td>
                <td>
                    <button class="edit" onclick="editResult(${r.id})">ترمیم</button>
                    <button class="delete" onclick="deleteResult(${r.id})">حذف</button>
                </td>
            `;
                }
            } catch (error) {
                console.error("Error loading past results:", error);
                tableBody.innerHTML = '<tr><td colspan="8">خرابی۔</td></tr>';
            }
        }
        async function editResult(id) {
            try {
                const result = await getById(STORE_RESULTS, id);
                document.getElementById('resultExamName').value = result.examName;
                document.getElementById('resultClass').value = result.classId;
                document.getElementById('resultDate').value = result.date;
                await loadStudentsAndSubjectsForResult();
                document.getElementById('resultSubject').value = result.subject;
                const row = document.getElementById('resultsEntryTable')
                    .querySelector(`tr[data-student-id="${result.studentId}"]`);
                row.querySelector('.totalMarks').value = result.totalMarks;
                row.querySelector('.obtainedMarks').value = result.obtainedMarks;
                showModule('results');
                window.scrollTo(0, 0);
            } catch (error) {
                console.error("Error editing result:", error);
                alert('ترمیم میں خرابی۔');
            }
        }
        async function deleteResult(id) {
            if (!confirm('کیا آپ اس نتیجہ کو حذف کرنا چاہتے ہیں؟')) return;
            try {
                await deleteData(STORE_RESULTS, id);
                alert('نتیجہ حذف ہو گیا۔');
                loadPastResults();
                loadExamsForResultCard();
            } catch (error) {
                console.error("Error deleting result:", error);
                alert('حذف کرنے میں خرابی۔');
            }
        }
        async function printResultCard() {
            const studentId = parseInt(document.getElementById('resultCardStudent').value);
            const examName = document.getElementById('resultCardExam').value;
            if (!studentId || !examName) {
                alert('طالب علم اور امتحان منتخب کریں۔');
                return;
            }
            try {
                const student = await getById(STORE_STUDENTS, studentId);
                const results = await getAll(STORE_RESULTS);
                const filteredResults = results.filter(r => r.studentId === studentId && r.examName === examName);
                if (filteredResults.length === 0) {
                    alert('کوئی نتائج نہیں ملے۔');
                    return;
                }
                const classId = filteredResults[0].classId;
                const className = await getClassName(classId);
                const schoolSetting = await getById(STORE_SETTINGS, 'schoolName');
                const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';
                const tableBody = document.getElementById('resultCardPrintTable').querySelector('tbody');
                tableBody.innerHTML = '';
                let totalMarks = 0;
                let totalObtained = 0;
                filteredResults.sort((a, b) => a.subject.localeCompare(b.subject)).forEach(result => {
                    const percentage = ((result.obtainedMarks / result.totalMarks) * 100).toFixed(2);
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                <td>${result.subject}</td>
                <td>${result.totalMarks}</td>
                <td>${result.obtainedMarks}</td>
                <td>${percentage}%</td>
            `;
                    totalMarks += result.totalMarks;
                    totalObtained += result.obtainedMarks;
                });
                const overallPercentage = ((totalObtained / totalMarks) * 100).toFixed(2);
                const status = overallPercentage >= 33 ? 'کامیاب' : 'ناکام';
                document.getElementById('printResultSchoolName').textContent = schoolName;
                document.getElementById('printResultExamName').textContent = examName;
                document.getElementById('printResultStudentName').textContent = student.name;
                document.getElementById('printResultClassName').textContent = className;
                document.getElementById('printResultTotalMarks').textContent = totalMarks;
                document.getElementById('printResultTotalObtained').textContent = totalObtained;
                document.getElementById('printResultOverallPercentage').textContent = overallPercentage;
                document.getElementById('printResultStatus').textContent = status;
                window.print();
            } catch (error) {
                console.error("Error printing result card:", error);
                alert('پرنٹ میں خرابی: ' + error.message);
            }
        }
        document.addEventListener('DOMContentLoaded', () => {

            async function printContent(containerId) {
                try {
                    const container = document.getElementById(containerId);
                    if (!container) {
                        alert('پرنٹ ایریا نہیں ملا۔');
                        return;
                    }

                    container.style.display = 'block';

                    const canvas = await html2canvas(container, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    });

                    const printWindow = window.open('', '_blank');
                    if (!printWindow) {
                        alert('پرنٹ ونڈو کھولنے میں ناکامی۔ براہ کرم پاپ اپ بلاکر چیک کریں۔');
                        container.style.display = 'none';
                        return;
                    }

                    printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>پرنٹ</title>
                    <style>
                        body { margin: 0; display: flex; justify-content: center; align-items: center; }
                        img { max-width: 100%; height: auto; }
                    </style>
                </head>
                <body>
                    <img src="${canvas.toDataURL('image/png')}" onload="window.print(); window.close();" />
                </body>
                </html>
            `);
                    printWindow.document.close();

                    container.style.display = 'none';
                } catch (error) {
                    console.error('پرنٹنگ میں خرابی:', error);
                    alert('پرنٹنگ میں خرابی: ' + error.message);
                }
            }

            window.printAttendanceRegister = async function () {
                const attendanceDate = document.getElementById('attendanceDate').value;
                const classId = document.getElementById('attendanceClass').value;
                if (!attendanceDate || !classId) {
                    alert('براہ کرم تاریخ اور کلاس منتخب کریں۔');
                    return;
                }
                try {
                    const className = await getClassName(parseInt(classId));
                    const students = await getAll(STORE_STUDENTS, 'classId', parseInt(classId));
                    const attendanceRecords = await getAll(STORE_ATTENDANCE, 'date_classId', [attendanceDate, parseInt(classId)]);
                    const tableBody = document.getElementById('attendancePrintTable').querySelector('tbody');
                    tableBody.innerHTML = '';
                    students.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                        const record = attendanceRecords.find(r => r.studentId === student.id);
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                    <td>${student.admissionNo}</td>
                    <td>${student.name}</td>
                    <td>${record && record.status === 'Present' ? 'حاضر' : 'غیر حاضر'}</td>
                `;
                    });
                    document.getElementById('printAttendanceDate').textContent = attendanceDate;
                    document.getElementById('printAttendanceClass').textContent = className;
                    await printContent('attendancePrintContainer');
                } catch (error) {
                    console.error("Error printing attendance:", error);
                    alert('حاضری پرنٹ کرنے میں خرابی: ' + error.message);
                }
            };

            window.printResultCard = async function () {
                const studentId = parseInt(document.getElementById('resultCardStudent').value);
                const examName = document.getElementById('resultCardExam').value;
                if (!studentId || !examName) {
                    alert('طالب علم اور امتحان منتخب کریں۔');
                    return;
                }
                try {
                    const student = await getById(STORE_STUDENTS, studentId);
                    const results = await getAll(STORE_RESULTS);
                    const filteredResults = results.filter(r => r.studentId === studentId && r.examName === examName);
                    if (filteredResults.length === 0) {
                        alert('کوئی نتائج نہیں ملے۔');
                        return;
                    }
                    const classId = filteredResults[0].classId;
                    const className = await getClassName(classId);
                    const schoolSetting = await getById(STORE_SETTINGS, 'schoolName');
                    const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';
                    const tableBody = document.getElementById('resultCardPrintTable').querySelector('tbody');
                    tableBody.innerHTML = '';
                    let totalMarks = 0;
                    let totalObtained = 0;
                    filteredResults.sort((a, b) => a.subject.localeCompare(b.subject)).forEach(result => {
                        const percentage = ((result.obtainedMarks / result.totalMarks) * 100).toFixed(2);
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                    <td>${result.subject}</td>
                    <td>${result.totalMarks}</td>
                    <td>${result.obtainedMarks}</td>
                    <td>${percentage}%</td>
                `;
                        totalMarks += result.totalMarks;
                        totalObtained += result.obtainedMarks;
                    });
                    const overallPercentage = ((totalObtained / totalMarks) * 100).toFixed(2);
                    const status = overallPercentage >= 33 ? 'کامیاب' : 'ناکام';
                    document.getElementById('printResultSchoolName').textContent = schoolName;
                    document.getElementById('printResultExamName').textContent = examName;
                    document.getElementById('printResultStudentName').textContent = student.name;
                    document.getElementById('printResultClassName').textContent = className;
                    document.getElementById('printResultTotalMarks').textContent = totalMarks;
                    document.getElementById('printResultTotalObtained').textContent = totalObtained;
                    document.getElementById('printResultOverallPercentage').textContent = overallPercentage;
                    document.getElementById('printResultStatus').textContent = status;
                    await printContent('resultCardPrintContainer');
                } catch (error) {
                    console.error("Error printing result card:", error);
                    alert('رزلٹ کارڈ پرنٹ کرنے میں خرابی: ' + error.message);
                }
            };

            window.generateReceipt = async function () {
                const studentId = parseInt(document.getElementById('feeStudentSelect').value);
                const date = document.getElementById('feeCollectionDate').value;
                const feeType = document.getElementById('feeCollectionType').value;
                const paidAmount = parseInt(document.getElementById('feePaidAmount').value);
                const discount = parseInt(document.getElementById('feeDiscount').value) || 0;
                const method = document.getElementById('feePaymentMethod').value;
                const notes = document.getElementById('feeNotes').value;
                if (!studentId || !date || !feeType || !paidAmount) {
                    alert('تمام ضروری فیلڈز پُر کریں۔');
                    return;
                }
                try {
                    const student = await getById(STORE_STUDENTS, studentId);
                    const className = await getClassName(student.classId);
                    const receiptId = 'R' + Date.now();
                    document.getElementById('receiptId').textContent = receiptId;
                    document.getElementById('receiptDate').textContent = date;
                    document.getElementById('receiptStudentName').textContent = student.name;
                    document.getElementById('receiptStudentClass').textContent = className;
                    document.getElementById('receiptFeeType').textContent = feeType;
                    document.getElementById('receiptPaidAmount').textContent = paidAmount.toLocaleString();
                    document.getElementById('receiptDiscount').textContent = discount.toLocaleString();
                    document.getElementById('receiptMethod').textContent = method;
                    document.getElementById('receiptNotes').textContent = notes || 'کوئی نوٹس نہیں';
                    await printContent('feeReceiptContainer');
                } catch (error) {
                    console.error("Error generating receipt:", error);
                    alert('رسید بنانے میں خرابی: ' + error.message);
                }
            };

            window.printReport = async function () {
                const reportType = document.getElementById('reportType').value;
                if (!reportType) {
                    alert('براہ کرم رپورٹ کی قسم منتخب کریں۔');
                    return;
                }
                try {
                    const content = document.getElementById('reportContent');
                    if (content.innerHTML.includes('رپورٹ کا مواد یہاں ظاہر ہوگا')) {
                        alert('براہ کرم پہلے رپورٹ بنائیں۔');
                        return;
                    }
                    await printContent('reportOutput');
                } catch (error) {
                    console.error("Error printing report:", error);
                    alert('رپورٹ پرنٹ کرنے میں خرابی: ' + error.message);
                }
            };
        });
        document.addEventListener('DOMContentLoaded', () => {

            if (!window.XLSX) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.async = false;
                document.head.appendChild(script);
            }

            const excelIcon = document.createElement('div');
            excelIcon.id = 'excelExportIcon';
            excelIcon.style.cssText = `
        position: fixed;
        top: 5px;
        right: 20px;
        z-index: 1000;
        cursor: pointer;
        background-color: #28a745;
        border-radius: 50%;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
            excelIcon.innerHTML = `
<svg width="24" height="24" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">
  <rect width="256" height="256" fill="none"/>
  <path d="M48 32H160l48 48v144a16 16 0 0 1-16 16H48a16 16 0 0 1-16-16V48a16 16 0 0 1 16-16z" fill="#217346"/>
  <polygon points="160 32 160 80 208 80" fill="#1E6F42"/>
  <path d="M88 104h16l16 24 16-24h16l-24 32 24 32h-16l-16-24-16 24H88l24-32-24-32z" fill="#fff"/>
</svg>
`;
            excelIcon.setAttribute('onclick', "showModule('exportData')");
            document.body.appendChild(excelIcon);

            const container = document.querySelector('.container');
            const exportModule = document.createElement('div');
            exportModule.id = 'exportData';
            exportModule.className = 'module';
            exportModule.innerHTML = `
        <h2>ڈیٹا ایکسپورٹ</h2>
        <p>براہ کرم ایکسپورٹ کرنے کے لیے ڈیٹا کی قسم منتخب کریں۔</p>
        <div class="form-grid">
            <button onclick="exportAllToOneFile()">سب ایک فائل میں ایکسپورٹ کریں</button>
            <button onclick="exportAllData('students')">طلباء ایکسپورٹ کریں</button>
            <button onclick="exportAllData('teachers')">اساتذہ ایکسپورٹ کریں</button>
            <button onclick="exportAllData('classes')">کلاسیں ایکسپورٹ کریں</button>
            <button onclick="exportAllData('fees')">فیس ایکسپورٹ کریں</button>
            <button onclick="exportAllData('feeStructures')">فیس اسٹرکچر ایکسپورٹ کریں</button>
            <button onclick="exportAllData('attendance')">حاضری ایکسپورٹ کریں</button>
            <button onclick="exportAllData('results')">نتائج ایکسپورٹ کریں</button>
            <button onclick="exportAllData('timetable')">ٹائم ٹیبل ایکسپورٹ کریں</button>
            <button onclick="exportAllData('expenses')">اخراجات ایکسپورٹ کریں</button>
            <button onclick="exportAllData('settings')">سیٹنگز ایکسپورٹ کریں</button>
        </div>
        <h3>منتخب ڈیٹا ایکسپورٹ</h3>
        <div class="form-grid">
            <div>
                <label for="exportStoreSelect">ڈیٹا کی قسم</label>
                <select id="exportStoreSelect" onchange="loadExportTable()">
                    <option value="">-- منتخب کریں --</option>
                    <option value="students">طلباء</option>
                    <option value="teachers">اساتذہ</option>
                    <option value="classes">کلاسیں</option>
                    <option value="fees">فیس</option>
                    <option value="feeStructures">فیس اسٹرکچر</option>
                    <option value="attendance">حاضری</option>
                    <option value="results">نتائج</option>
                    <option value="timetable">ٹائم ٹیبل</option>
                    <option value="expenses">اخراجات</option>
                    <option value="settings">سیٹنگز</option>
                </select>
            </div>
        </div>
        <div id="exportTableContainer" style="display: none;">
            <button onclick="exportSelectedData()">منتخب ڈیٹا ایکسپورٹ کریں</button>
            <table id="exportTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    `;
            container.appendChild(exportModule);

            const storeConfigs = {
                students: {
                    headers: ['داخلہ نمبر', 'نام', 'والد کا نام', 'کلاس', 'داخلہ تاریخ', 'رابطہ نمبر', 'پتہ'],
                    fields: ['admissionNo', 'name', 'fatherName', async (row) => await getClassName(row.classId), 'admissionDate', 'contact', 'address']
                },
                teachers: {
                    headers: ['نام', 'مضامین', 'موبائل نمبر', 'تنخواہ', 'تقرری تاریخ', 'قابلیت'],
                    fields: ['name', 'subjects', 'contact', 'salary', 'appointmentDate', 'qualification']
                },
                classes: {
                    headers: ['کلاس کا نام', 'استاد', 'مضامین'],
                    fields: ['name', async (row) => await getTeacherName(row.teacherId), 'subjects']
                },
                fees: {
                    headers: ['طالب علم', 'تاریخ', 'فیس کی قسم', 'ادا شدہ رقم', 'رعایت', 'طریقہ', 'نوٹس'],
                    fields: [async (row) => await getStudentName(row.studentId), 'date', 'feeType', 'paidAmount', 'discount', 'method', 'notes']
                },
                feeStructures: {
                    headers: ['کلاس', 'فیس کی قسم', 'رقم'],
                    fields: [async (row) => await getClassName(row.classId), 'feeType', 'amount']
                },
                attendance: {
                    headers: ['تاریخ', 'کلاس', 'طالب علم', 'حالت'],
                    fields: ['date', async (row) => await getClassName(row.classId), async (row) => await getStudentName(row.studentId), 'status']
                },
                results: {
                    headers: ['امتحان', 'کلاس', 'طالب علم', 'مضمون', 'تاریخ', 'کل نمبر', 'حاصل کردہ نمبر'],
                    fields: ['examName', async (row) => await getClassName(row.classId), async (row) => await getStudentName(row.studentId), 'subject', 'date', 'totalMarks', 'obtainedMarks']
                },
                timetable: {
                    headers: ['کلاس', 'دن', 'پیریڈ', 'مضمون', 'استاد'],
                    fields: [async (row) => await getClassName(row.classId), 'day', 'period', 'subject', async (row) => await getTeacherName(row.teacherId)]
                },
                expenses: {
                    headers: ['تاریخ', 'قسم', 'تفصیل', 'ادا کیا گیا', 'رقم'],
                    fields: ['date', 'type', 'description', 'paidTo', 'amount']
                },
                settings: {
                    headers: ['کلید', 'قدر'],
                    fields: ['key', 'value']
                }
            };

            window.exportAllData = async function (storeName) {
                try {
                    const data = await getAll(storeName);
                    if (data.length === 0) {
                        alert('کوئی ڈیٹا نہیں ملا۔');
                        return;
                    }
                    const config = storeConfigs[storeName];
                    const headers = config.headers;
                    const rows = [];
                    for (const row of data) {
                        const rowData = [];
                        for (const field of config.fields) {
                            rowData.push(typeof field === 'function' ? await field(row) : row[field] || '');
                        }
                        rows.push(rowData);
                    }
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                    XLSX.utils.book_append_sheet(wb, ws, storeName);
                    XLSX.writeFile(wb, `${storeName}_${Date.now()}.xlsx`);
                } catch (error) {
                    console.error(`Error exporting ${storeName}:`, error);
                    alert('ایکسپورٹ میں خرابی: ' + error.message);
                }
            };

            window.exportAllToOneFile = async function () {
                try {
                    const wb = XLSX.utils.book_new();
                    const storeNames = Object.keys(storeConfigs);
                    for (const storeName of storeNames) {
                        const data = await getAll(storeName);
                        const config = storeConfigs[storeName];
                        const headers = config.headers;
                        const rows = [];
                        for (const row of data) {
                            const rowData = [];
                            for (const field of config.fields) {
                                rowData.push(typeof field === 'function' ? await field(row) : row[field] || '');
                            }
                            rows.push(rowData);
                        }

                        if (rows.length > 0) {
                            const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                            XLSX.utils.book_append_sheet(wb, ws, storeName);
                        }
                    }
                    if (Object.keys(wb.Sheets).length === 0) {
                        alert('ایکسپورٹ کے لیے کوئی ڈیٹا نہیں ملا۔');
                        return;
                    }
                    XLSX.writeFile(wb, `all_data_${Date.now()}.xlsx`);
                } catch (error) {
                    console.error('Error exporting all data:', error);
                    alert('تمام ڈیٹا ایکسپورٹ کرنے میں خرابی: ' + error.message);
                }
            };

            window.loadExportTable = async function () {
                const storeName = document.getElementById('exportStoreSelect').value;
                const tableContainer = document.getElementById('exportTableContainer');
                const table = document.getElementById('exportTable');
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                tableContainer.style.display = storeName ? 'block' : 'none';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                if (!storeName) return;
                try {
                    const data = await getAll(storeName);
                    const config = storeConfigs[storeName];

                    const headerRow = thead.insertRow();
                    headerRow.insertCell().innerHTML = '<input type="checkbox" class="select-all">';
                    config.headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });

                    data.forEach(row => {
                        const tr = tbody.insertRow();
                        tr.dataset.id = row.id || JSON.stringify(row);
                        tr.insertCell().innerHTML = '<input type="checkbox" class="row-select">';
                        config.fields.forEach(async (field, index) => {
                            const td = tr.insertCell();
                            td.textContent = typeof field === 'function' ? await field(row) : row[field] || '';
                        });
                    });

                    const selectAll = thead.querySelector('.select-all');
                    selectAll.addEventListener('change', () => {
                        tbody.querySelectorAll('.row-select').forEach(cb => cb.checked = selectAll.checked);
                    });
                } catch (error) {
                    console.error(`Error loading table for ${storeName}:`, error);
                    tbody.innerHTML = '<tr><td colspan="' + (storeConfigs[storeName].headers.length + 1) + '">ڈیٹا لوڈ کرنے میں خرابی۔</td></tr>';
                }
            };

            window.exportSelectedData = async function () {
                const storeName = document.getElementById('exportStoreSelect').value;
                const tbody = document.getElementById('exportTable').querySelector('tbody');
                const selectedRows = Array.from(tbody.querySelectorAll('tr input.row-select:checked')).map(cb => cb.parentNode.parentNode);
                if (selectedRows.length === 0) {
                    alert('براہ کرم کم از کم ایک ریکارڈ منتخب کریں۔');
                    return;
                }
                try {
                    const config = storeConfigs[storeName];
                    const headers = config.headers;
                    const rows = [];
                    for (const row of selectedRows) {
                        const rowData = [];
                        const cells = row.querySelectorAll('td');
                        for (let i = 1; i < cells.length; i++) {
                            rowData.push(cells[i].textContent);
                        }
                        rows.push(rowData);
                    }
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                    XLSX.utils.book_append_sheet(wb, ws, storeName);
                    XLSX.writeFile(wb, `${storeName}_selected_${Date.now()}.xlsx`);
                } catch (error) {
                    console.error(`Error exporting selected ${storeName}:`, error);
                    alert('منتخب ڈیٹا ایکسپورٹ کرنے میں خرابی: ' + error.message);
                }
            };

            const originalShowModule = window.showModule || function () { };
            window.showModule = function (moduleId) {
                originalShowModule(moduleId);
                if (moduleId === 'exportData') {
                    document.getElementById('exportStoreSelect').value = '';
                    document.getElementById('exportTableContainer').style.display = 'none';
                }
            };
        });
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('.container');
            const idCardModule = document.createElement('div');
            idCardModule.id = 'idCardGenerator';
            idCardModule.className = 'module';
            idCardModule.innerHTML = `
        <style>
            .id-card {
                width: 320px;
                height: 200px;
                background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                padding: 10px;
                display: flex;
                font-family: 'Noto Nastaliq Urdu', sans-serif;
                position: relative;
                overflow: hidden;
            }
            .id-card.front {
                flex-direction: row;
            }
            .id-card.back {
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            .id-card .photo {
                width: 80px;
                height: 80px;
                border-radius: 5px;
                background-color: #fff;
                margin: 10px;
                object-fit: cover;
            }
            .id-card .content {
                flex: 1;
                padding: 5px;
                font-size: 12px;
                color: #333;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }
            .id-card .content p {
                margin: 3px 0;
                line-height: 1.2;
            }
            .id-card .header {
                font-size: 14px;
                font-weight: bold;
                color: #1a73e8;
                text-align: center;
                margin-bottom: 5px;
            }
            .id-card .footer {
                font-size: 10px;
                color: #666;
                text-align: center;
                position: absolute;
                bottom: 5px;
                width: 100%;
            }
            .preview .id-card {
                transform: scale(1);
                transform-origin: top left;
                width: 320px;
                height: 200px;
            }
            .printable {
                margin: 20px auto;
                display: flex;
                justify-content: center;
            }
            .export-container {
                position: absolute;
                left: -9999px;
                width: 480px;
                height: 300px;
            }
            .export-container .id-card {
                width: 480px;
                height: 300px;
                padding: 15px;
                font-size: 18px;
            }
            .export-container .id-card .photo {
                width: 120px;
                height: 120px;
                margin: 15px;
            }
            .export-container .id-card .header {
                font-size: 21px;
                margin-bottom: 8px;
            }
            .export-container .id-card .content p {
                margin: 5px 0;
                line-height: 1.3;
            }
            .export-container .id-card .footer {
                font-size: 15px;
                bottom: 8px;
            }
        </style>
        <h2>آئی ڈی کارڈ جنریٹر</h2>
        <h3>انفرادی آئی ڈی کارڈ جنریٹ کریں</h3>
        <div class="form-grid">
            <div>
                <label for="idCardType">قسم</label>
                <select id="idCardType" onchange="loadIDCardSelect()" required>
                    <option value="">-- منتخب کریں --</option>
                    <option value="student">طالب علم</option>
                    <option value="teacher">استاد</option>
                </select>
            </div>
            <div>
                <label for="idCardSelect">شخص منتخب کریں</label>
                <select id="idCardSelect" required>
                    <option value="">-- منتخب کریں --</option>
                </select>
            </div>
            <div>
                <label for="idCardTemplate">ٹیمپلیٹ</label>
                <select id="idCardTemplate" required>
                    <option value="front">فرنٹ</option>
                    <option value="back">بیک</option>
                </select>
            </div>
            <div>
                <label for="idCardPhoto">تصویر اپ لوڈ کریں (اختیاری)</label>
                <input type="file" id="idCardPhoto" accept="image/*">
            </div>
        </div>
        <button onclick="generateSingleIDCard()">آئی ڈی کارڈ جنریٹ کریں</button>
        <button onclick="exportSingleIDCard()">ایکسپورٹ کریں (PNG)</button>
        <div id="singleIDCardPreview" class="printable" style="display: none;">
            <div id="idCardContent"></div>
        </div>
        <h3>بڑی تعداد میں آئی ڈی کارڈز جنریٹ کریں</h3>
        <div class="form-grid">
            <div>
                <label for="bulkIdCardType">قسم</label>
                <select id="bulkIdCardType" onchange="loadBulkIDCardSelect()" required>
                    <option value="">-- منتخب کریں --</option>
                    <option value="student">طالب علم</option>
                    <option value="teacher">استاد</option>
                </select>
            </div>
            <div>
                <label for="bulkIdCardClass">کلاس (طلباء کے لیے)</label>
                <select id="bulkIdCardClass" onchange="loadBulkIDCardSelect()">
                    <option value="">-- تمام --</option>
                </select>
            </div>
            <div>
                <label for="bulkIdCardTemplate">ٹیمپلیٹ</label>
                <select id="bulkIdCardTemplate" required>
                    <option value="front">فرنٹ</option>
                    <option value="back">بیک</option>
                </select>
            </div>
        </div>
        <button onclick="generateBulkIDCards()">بڑی تعداد میں آئی ڈی کارڈز جنریٹ کریں</button>
        <button onclick="exportBulkIDCards()">ایکسپورٹ کریں (ZIP)</button>
        <div id="bulkIDCardResult" style="margin-top: 10px;">
            <table id="bulkIDCardTable" style="display: none;">
                <thead>
                    <tr>
                        <th>آئی ڈی</th>
                        <th>نام</th>
                        <th>پریویو</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    `;
            container.appendChild(idCardModule);

            const nav = document.querySelector('nav');
            const idCardButton = document.createElement('button');
            idCardButton.textContent = 'آئی ڈی کارڈ جنریٹر';
            idCardButton.onclick = () => showModule('idCardGenerator');
            nav.appendChild(idCardButton);
            let currentPhoto = null;

            async function loadClassesForBulk() {
                const select = document.getElementById('bulkIdCardClass');
                select.innerHTML = '<option value="">-- تمام --</option>';
                try {
                    const classes = await getAll(STORE_CLASSES);
                    classes.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.id;
                        option.textContent = cls.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error loading classes:", error);
                }
            }

            window.loadIDCardSelect = async function () {
                const type = document.getElementById('idCardType').value;
                const select = document.getElementById('idCardSelect');
                select.innerHTML = '<option value="">-- منتخب کریں --</option>';
                if (!type) return;
                try {
                    const storeName = type === 'student' ? STORE_STUDENTS : STORE_TEACHERS;
                    const persons = await getAll(storeName);
                    persons.sort((a, b) => a.name.localeCompare(b.name)).forEach(person => {
                        const option = document.createElement('option');
                        option.value = person.id;
                        option.textContent = type === 'student' ? `${person.name} (${person.admissionNo})` : person.name;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error("Error loading persons:", error);
                }
            };

            window.loadBulkIDCardSelect = async function () {
                const type = document.getElementById('bulkIdCardType').value;
                const classId = document.getElementById('bulkIdCardClass').value;
                const table = document.getElementById('bulkIDCardTable');
                const tbody = table.querySelector('tbody');
                tbody.innerHTML = '';
                table.style.display = 'none';
                if (!type) return;
                try {
                    const storeName = type === 'student' ? STORE_STUDENTS : STORE_TEACHERS;
                    let persons = await getAll(storeName);
                    if (type === 'student' && classId) {
                        persons = persons.filter(p => p.classId === parseInt(classId));
                    }
                    persons.sort((a, b) => a.name.localeCompare(b.name)).forEach(person => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                    <td>${type === 'student' ? person.admissionNo : person.name}</td>
                    <td>${person.name}</td>
                    <td><input type="checkbox" class="bulk-select" checked></td>
                `;
                        row.dataset.id = person.id;
                    });
                    table.style.display = persons.length > 0 ? 'table' : 'none';
                } catch (error) {
                    console.error("Error loading bulk persons:", error);
                    tbody.innerHTML = '<tr><td colspan="3">خرابی: ڈیٹا لوڈ نہیں ہو سکا۔</td></tr>';
                    table.style.display = 'table';
                }
            };

            document.getElementById('idCardPhoto')?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        currentPhoto = event.target.result;
                    };
                    reader.readAsDataURL(file);
                } else {
                    currentPhoto = null;
                    alert('براہ کرم درست تصویر منتخب کریں۔');
                }
            });

            async function tryLoadImage(id, name, type) {
                const numericId = parseInt(id.toString().replace(/\D/g, '')) || 0;
                const paddedId = numericId.toString().padStart(4, '0');
                const idVariants = [
                    id.toString(),
                    `TCH${paddedId}`,
                    `TCH${numericId}`,
                    paddedId,
                    numericId.toString()
                ];
                const nameVariants = [
                    name,
                    name.replace(/_/g, ' '),
                    name.replace(/\s+/g, '_'),
                    name.replace(/\s+/g, ''),
                    name.toLowerCase(),
                    name.toUpperCase()
                ];
                const filenames = [
                    ...idVariants.map(v => `${v}.png`),
                    ...nameVariants.map(v => `${v}.png`)
                ];
                const uniquePaths = [...new Set(filenames.map(f => `images/${f}`))];
                for (const path of uniquePaths) {
                    try {
                        const response = await fetch(path, { method: 'HEAD' });
                        if (response.ok) return path;
                    } catch { }
                }
                return null;
            }

            window.generateSingleIDCard = async function () {
                const type = document.getElementById('idCardType').value;
                const personIdElement = document.getElementById('idCardSelect');
                const personId = personIdElement ? parseInt(personIdElement.value) : null;
                const template = document.getElementById('idCardTemplate').value;
                const preview = document.getElementById('singleIDCardPreview');
                const content = document.getElementById('idCardContent');

                // Ensure currentPhoto is accessible or defined within this scope
                // If it's a global variable set by file input, it should be fine.
                // Otherwise, you might need to pass it or retrieve it here.
                // For this example, assuming 'currentPhoto' is a global or accessible variable.

                if (!type || !personId) {
                    if (content) content.textContent = 'براہ کرم تمام فیلڈز پُر کریں۔';
                    if (preview) preview.style.display = 'block';
                    return;
                }

                try {
                    const storeName = type === 'student' ? window.STORE_STUDENTS : window.STORE_TEACHERS;
                    const person = await window.getById(storeName, personId);
                    if (!person) {
                        if (content) content.textContent = 'شخص نہیں ملا۔';
                        if (preview) preview.style.display = 'block';
                        return;
                    }

                    const schoolSetting = await window.getById(window.STORE_SETTINGS, 'schoolName');
                    const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';

                    const idNumber = type === 'student' ? person.admissionNo : `TCH${person.id.toString().padStart(4, '0')}`;
                    const className = type === 'student' ? ((typeof window.getClassName === 'function') ? await window.getClassName(person.classId) : 'N/A') : 'N/A';
                    const autoImage = (typeof window.tryLoadImage === 'function') ? await window.tryLoadImage(person.id, person.name, type) : null;
                    const photoSrc = window.currentPhoto || autoImage || null; // Assuming window.currentPhoto is set by your file input

                    let imageElementHTML;
                    if (photoSrc) {
                        imageElementHTML = `<img src="${photoSrc}" class="photo" alt="تصویر">`;
                    } else {
                        console.log("No photo found, generating QR code for single ID card...");
                        let qrData = `${idNumber}|${person.name}`; // Using "|" as a separator
                        if (type === 'student') {
                            qrData += `|C:${className.substring(0, 10)}`; // Max 10 chars for class name
                        } else { // teacher
                            qrData += `|T`; // "T" for Teacher
                        }

                        const qrCodeDataURL = await generateQRCodeDataURL(qrData.trim(), 80);
                        if (qrCodeDataURL) {
                            imageElementHTML = `<img src="${qrCodeDataURL}" class="photo qr-code-image" alt="QR Code">`;
                        } else {
                            imageElementHTML = `<div class="photo"><span>کوئی تصویر/<br>کیو آر کوڈ نہیں</span></div>`;
                        }
                    }

                    if (content) {
                        content.innerHTML = template === 'front' ? `
                <div class="id-card front">
                    ${imageElementHTML}
                    <div class="content">
                        <div class="header">${schoolName}</div>
                        <p><strong>${type === 'student' ? 'طالب علم' : 'استاد'}</strong></p>
                        <p><strong>نام:</strong> ${person.name}</p>
                        <p><strong>آئی ڈی:</strong> ${idNumber}</p>
                        ${type === 'student' ? `<p><strong>کلاس:</strong> ${className}</p>` : ''}
                        <div class="footer">تاریخ اجرا: ${new Date().toISOString().split('T')[0]}</div>
                    </div>
                </div>
            ` : `
                <div class="id-card back">
                    <div class="content">
                        <div class="header">${schoolName}</div>
                        <p><strong>رابطہ:</strong> ${person.contact || 'N/A'}</p>
                        ${type === 'student' ? `<p><strong>والد کا نام:</strong> ${person.fatherName}</p>` : ''}
                        <p><strong>پتہ:</strong> ${person.address || person.qualification || 'N/A'}</p>
                        <div class="footer">یہ کارڈ مدرسہ کی ملکیت ہے۔</div>
                    </div>
                </div>
            `;
                    }
                    if (preview) preview.style.display = 'block';
                } catch (error) {
                    console.error('Error generating ID card:', error);
                    if (content) content.textContent = 'خرابی: آئی ڈی کارڈ جنریٹ نہیں ہو سکا۔';
                    if (preview) preview.style.display = 'block';
                }
            };
            window.exportSingleIDCard = async function () {
                const preview = document.getElementById('singleIDCardPreview');
                if (preview.style.display === 'none' || !document.getElementById('idCardContent').innerHTML) {
                    alert('پہلے آئی ڈی کارڈ جنریٹ کریں۔');
                    return;
                }
                try {
                    const canvas = await html2canvas(preview.querySelector('.id-card'), { scale: 3, useCORS: true, backgroundColor: null });
                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `id_card_${Date.now()}.png`;
                    link.click();
                } catch (error) {
                    console.error('Error exporting ID card:', error);
                    alert('ایکسپورٹ میں خرابی: ' + error.message);
                }
            };
            // Bulk generate with QR Code Yasin
            /*
            window.generateBulkIDCards = async function () {
                const type = document.getElementById('bulkIdCardType').value;
                const classIdElement = document.getElementById('bulkIdCardClass');
                const classId = classIdElement ? classIdElement.value : null;
                const template = document.getElementById('bulkIdCardTemplate').value;
                const table = document.getElementById('bulkIDCardTable');
                const tbody = table ? table.querySelector('tbody') : null;
            
                if (!tbody) {
                    console.error("Bulk ID card table body not found.");
                    return;
                }
            
                if (!type) {
                    tbody.innerHTML = '<tr><td colspan="3">براہ کرم قسم منتخب کریں۔</td></tr>';
                    if (table) table.style.display = 'table';
                    return;
                }
            
                try {
                    const storeName = type === 'student' ? window.STORE_STUDENTS : window.STORE_TEACHERS;
                    let persons = await window.getAll(storeName);
                    if (type === 'student' && classId) {
                        persons = persons.filter(p => p.classId === parseInt(classId));
                    }
            
                    // Filter based on checkboxes if they exist and are part of the table structure
                    const selectedPersons = [];
                    if (tbody.rows.length === persons.length) { // Check if checkboxes were rendered
                         persons.forEach((person, i) => {
                            const rowCheckbox = tbody.rows[i]?.querySelector('.bulk-select');
                            if (rowCheckbox && rowCheckbox.checked) {
                                selectedPersons.push(person);
                            }
                        });
                    } else { // Fallback if checkboxes not integrated or issue with row matching
                        console.warn("Mismatch between persons data and table rows for bulk selection, or checkboxes not found. Processing all loaded persons for the selected criteria.");
                        selectedPersons.push(...persons); // Process all if selection mechanism is unclear
                    }
            
            
                    if (selectedPersons.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3">کوئی شخص منتخب نہیں کیا گیا یا اس معیار پر کوئی شخص نہیں۔</td></tr>';
                        if (table) table.style.display = 'table';
                        return;
                    }
            
                    const schoolSetting = await window.getById(window.STORE_SETTINGS, 'schoolName');
                    const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';
            
                    tbody.innerHTML = ''; // Clear for new previews
                    for (const person of selectedPersons.sort((a, b) => a.name.localeCompare(b.name))) {
                        const idNumber = type === 'student' ? person.admissionNo : `TCH${person.id.toString().padStart(4, '0')}`;
                        const currentClassName = type === 'student' ? ( (typeof window.getClassName === 'function') ? await window.getClassName(person.classId) : 'N/A' ) : 'N/A';
                        const autoImage = (typeof window.tryLoadImage === 'function') ? await window.tryLoadImage(person.id, person.name, type) : null;
            
                        let imageElementHTMLBulk;
                        if (autoImage) {
                            imageElementHTMLBulk = `<img src="${autoImage}" class="photo" alt="تصویر">`;
                        } else {
                            console.log(`No photo for bulk ID: ${person.name}, generating QR code...`);
                let qrData = `${idNumber}|${person.name}`; // Using "|" as a separator
                const currentClassName = type === 'student' ? ( (typeof window.getClassName === 'function') ? await window.getClassName(person.classId) : 'N/A' ) : 'N/A';
                if (type === 'student') {
                    qrData += `|C:${currentClassName.substring(0, 10)}`; // Max 10 chars for class name
                } else {
                    qrData += `|T`; // "T" for Teacher
                }
            
                            const qrCodeDataURL = await generateQRCodeDataURL(qrData.trim(), 98);
                            if (qrCodeDataURL) {
                                imageElementHTMLBulk = `<img src="${qrCodeDataURL}" class="photo qr-code-image" alt="QR Code">`;
                            } else {
                                imageElementHTMLBulk = `<div class="photo"><span>N/A</span></div>`;
                            }
                        }
            
                        const row = tbody.insertRow();
                        row.dataset.id = person.id;
                        // The preview in the table is just for a quick look. The actual export will regenerate.
                        row.innerHTML = `
                            <td>${idNumber}</td>
                            <td>${person.name}</td>
                            <td>
                                <div class="preview" style="transform: scale(0.5); transform-origin: top left; width: 160px; height:100px; overflow:hidden; border: 1px solid #ccc;">
                                    <div class="id-card ${template}" style="width: 320px; height: 200px;">
                                        ${imageElementHTMLBulk}
                                        <div class="content">
                                            <div class="header">${schoolName}</div>
                                            ${template === 'front' ? `
                                                <p style="font-size:10px;"><strong>${type === 'student' ? 'طالب علم' : 'استاد'}</strong></p>
                                                <p style="font-size:10px;"><strong>نام:</strong> ${person.name}</p>
                                                <p style="font-size:10px;"><strong>آئی ڈی:</strong> ${idNumber}</p>
                                                ${type === 'student' ? `<p style="font-size:10px;"><strong>کلاس:</strong> ${currentClassName}</p>` : ''}
                                                <div class="footer" style="font-size:8px;">${new Date().toISOString().split('T')[0]}</div>
                                            ` : `
                                                <p style="font-size:10px;"><strong>رابطہ:</strong> ${person.contact || 'N/A'}</p>
                                                ${type === 'student' ? `<p style="font-size:10px;"><strong>والد کا نام:</strong> ${person.fatherName}</p>` : ''}
                                                <p style="font-size:10px;"><strong>پتہ:</strong> ${person.address || person.qualification || 'N/A'}</p>
                                                <div class="footer" style="font-size:8px;">مدرسہ کی ملکیت</div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </td>
                        `;
                    }
                    if (table) table.style.display = 'table';
                } catch (error) {
                    console.error('Error generating bulk ID cards:', error);
                    tbody.innerHTML = '<tr><td colspan="3">خرابی: آئی ڈی کارڈز جنریٹ نہیں ہو سکیں۔</td></tr>';
                    if (table) table.style.display = 'table';
                }
            };
            */

            //Bulk Generate without Qr Code
            window.generateBulkIDCards = async function () {
                const type = document.getElementById('bulkIdCardType').value;
                const classId = document.getElementById('bulkIdCardClass').value;
                const template = document.getElementById('bulkIdCardTemplate').value;
                const table = document.getElementById('bulkIDCardTable');
                const tbody = table.querySelector('tbody');
                if (!type) {
                    tbody.innerHTML = '<tr><td colspan="3">براہ کرم قسم منتخب کریں۔</td></tr>';
                    table.style.display = 'table';
                    return;
                }
                try {
                    const storeName = type === 'student' ? STORE_STUDENTS : STORE_TEACHERS;
                    let persons = await getAll(storeName);
                    if (type === 'student' && classId) {
                        persons = persons.filter(p => p.classId === parseInt(classId));
                    }
                    persons = persons.filter((_, i) => tbody.rows[i]?.querySelector('.bulk-select').checked);
                    if (persons.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3">کوئی شخص منتخب نہیں کیا گیا۔</td></tr>';
                        table.style.display = 'table';
                        return;
                    }
                    const schoolSetting = await getById(STORE_SETTINGS, 'schoolName');
                    const schoolName = schoolSetting ? schoolSetting.value : 'مدرسہ کا نام';
                    tbody.innerHTML = '';
                    persons.sort((a, b) => a.name.localeCompare(b.name)).forEach(async person => {
                        const idNumber = type === 'student' ? person.admissionNo : `TCH${person.id.toString().padStart(4, '0')}`;
                        const className = type === 'student' ? await getClassName(person.classId) : 'N/A';
                        const autoImage = await tryLoadImage(person.id, person.name, type);
                        const row = tbody.insertRow();
                        row.dataset.id = person.id;
                        row.innerHTML = `
                    <td>${idNumber}</td>
                    <td>${person.name}</td>
                    <td>
                        <div class="preview">
                            <div class="id-card ${template}">
                                ${autoImage ? `<img src="${autoImage}" class="photo">` : `<div class="photo"></div>`}
                                <div class="content">
                                    <div class="header">${schoolName}</div>
                                    ${template === 'front' ? `
                                        <p><strong>${type === 'student' ? 'طالب علم' : 'استاد'}</strong></p>
                                        <p><strong>نام:</strong> ${person.name}</p>
                                        <p><strong>آئی ڈی:</strong> ${idNumber}</p>
                                        ${type === 'student' ? `<p><strong>کلاس:</strong> ${className}</p>` : ''}
                                        <div class="footer">${new Date().toISOString().split('T')[0]}</div>
                                    ` : `
                                        <p><strong>رابطہ:</strong> ${person.contact || 'N/A'}</p>
                                        ${type === 'student' ? `<p><strong>والد کا نام:</strong> ${person.fatherName}</p>` : ''}
                                        <p><strong>پتہ:</strong> ${person.address || person.qualification || 'N/A'}</p>
                                        <div class="footer">مدرسہ کی ملکیت</div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                    });
                    table.style.display = 'table';
                } catch (error) {
                    console.error('Error generating bulk ID cards:', error);
                    tbody.innerHTML = '<tr><td colspan="3">خرابی: آئی ڈی کارڈز جنریٹ نہیں ہو سکیں۔</td></tr>';
                    table.style.display = 'table';
                }
            };

            window.exportBulkIDCards = async function () {
                const table = document.getElementById('bulkIDCardTable');
                const rows = table.querySelectorAll('tbody tr');
                if (rows.length === 0 || rows[0].textContent.includes('خرابی')) {
                    alert('ایکسپورٹ کرنے کے لیے کوئی آئی ڈی کارڈز نہیں ہیں۔');
                    return;
                }
                try {
                    const zip = new JSZip();
                    const exportContainer = document.createElement('div');
                    exportContainer.className = 'export-container';
                    document.body.appendChild(exportContainer);
                    for (const row of rows) {
                        const idNumber = row.cells[0].textContent;
                        const preview = row.querySelector('.id-card').cloneNode(true);
                        exportContainer.innerHTML = '';
                        exportContainer.appendChild(preview);
                        const canvas = await html2canvas(preview, { scale: 5, useCORS: true, backgroundColor: null });
                        const imgData = canvas.toDataURL('image/png').split(',')[1];
                        zip.file(`${idNumber}.png`, imgData, { base64: true });
                    }
                    document.body.removeChild(exportContainer);
                    const content = await zip.generateAsync({ type: 'blob' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = `id_cards_${Date.now()}.zip`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                } catch (error) {
                    console.error('Error exporting bulk ID cards:', error);
                    alert('ایکسپورٹ میں خرابی: ' + error.message);
                }
            };

            const originalShowModule = window.showModule || function () { };
            window.showModule = function (moduleId) {
                originalShowModule(moduleId);
                if (moduleId === 'idCardGenerator') {
                    ensureQRCodeLibrary().then(loaded => {
                        if (loaded) console.log("ID Card module shown, QR library ready/loading.");
                        else console.warn("ID Card module shown, QR library failed/loading.");
                    });
                    if (typeof loadClassesForBulk === 'function') loadClassesForBulk();
                    if (typeof loadIDCardSelect === 'function') loadIDCardSelect();
                    if (typeof loadBulkIDCardSelect === 'function') loadBulkIDCardSelect();
                }
            };

            if (!window.JSZip) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.async = false;
                document.head.appendChild(script);
            }

            const link = document.createElement('link');
            link.href = 'https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap';
            link.rel = 'stylesheet';
            document.head.appendChild(link);
        });

        function initializeMobileNav() {
            const nav = document.querySelector('nav');
            if (!nav) {
                console.error('Navigation element not found');
                return;
            }

            nav.innerHTML = '';

            const navButtons = [
                { text: 'ڈیش بورڈ', module: 'dashboard' },
                { text: 'طلباء', module: 'students' },
                { text: 'اساتذہ', module: 'teachers' },
                { text: 'کلاسیں', module: 'classes' },
                { text: 'فیس', module: 'fees' },
                { text: 'فیس اسٹرکچر', module: 'feeStructures' },
                { text: 'حاضری', module: 'attendance' },
                { text: 'نتائج', module: 'results' },
                { text: 'ٹائم ٹیبل / ڈیوٹی روسٹر', module: 'timetable' },
                { text: 'اخراجات', module: 'expenses' },
                { text: 'رپورٹس', module: 'reports' },
                { text: 'سیٹنگز', module: 'settings' },
                { text: 'ڈیٹا ایکسپورٹ', module: 'exportData' },
                { text: 'آئی ڈی کارڈ جنریٹر', module: 'idCardGenerator' }
            ];

            const navDesktop = document.createElement('div');
            navDesktop.className = 'nav-desktop';
            navButtons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.onclick = () => showModule(btn.module);
                navDesktop.appendChild(button);
            });
            nav.appendChild(navDesktop);

            const navMobile = document.createElement('div');
            navMobile.className = 'nav-mobile';
            const hamburger = document.createElement('button');
            hamburger.className = 'hamburger';
            hamburger.innerHTML = '☰';
            hamburger.onclick = toggleMobileMenu;
            const mobileMenu = document.createElement('div');
            mobileMenu.className = 'mobile-menu';
            mobileMenu.id = 'mobileMenu';

            function populateMobileMenu() {
                mobileMenu.innerHTML = '';
                navButtons.forEach(btn => {
                    const button = document.createElement('button');
                    button.textContent = btn.text;
                    button.onclick = () => showModule(btn.module);
                    mobileMenu.appendChild(button);
                });

                const desktopButtons = Array.from(navDesktop.querySelectorAll('button'));
                desktopButtons.forEach(desktopBtn => {
                    if (!navButtons.some(b => b.text === desktopBtn.textContent)) {
                        const button = document.createElement('button');
                        button.textContent = desktopBtn.textContent;
                        button.onclick = () => desktopBtn.click();
                        mobileMenu.appendChild(button);
                    }
                });
            }

            populateMobileMenu();
            navMobile.appendChild(hamburger);
            navMobile.appendChild(mobileMenu);
            nav.appendChild(navMobile);

            const existingStyle = document.head.querySelector('style[data-nav-mobile]');
            if (existingStyle) existingStyle.remove();
            const style = document.createElement('style');
            style.dataset.navMobile = 'true';
            style.textContent = `
        .nav-desktop {
            display: block;
            text-align: center;
        }
        .nav-mobile {
            display: none;
        }
        .hamburger {
            background-color: #4a7bdc;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            border-radius: 4px;
        }
        .hamburger:hover {
            background-color: #3a6bcc;
        }
        .mobile-menu {
            display: none;
            flex-direction: column;
            background-color: #5a8dee;
            padding: 10px;
            position: absolute;
            top: 50px;
            right: 0;
            width: 200px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .mobile-menu button {
            background-color: #4a7bdc;
            color: white;
            border: none;
            padding: 10px;
            margin: 5px 0;
            cursor: pointer;
            font-size: 1.2em;
            border-radius: 4px;
            text-align: right;
        }
        .mobile-menu button:hover {
            background-color: #3a6bcc;
        }
        .mobile-menu button.active {
            background-color: #2a5bad;
        }
        @media screen and (max-width: 768px) {
            nav {
                position: relative;
                text-align: right;
                padding: 10px;
            }
            .nav-desktop {
                display: none !important;
            }
            .nav-mobile {
                display: block !important;
            }
        }
        .mobile-menu.active {
            display: flex;
        }
    `;
            document.head.appendChild(style);

            const observer = new MutationObserver(() => {
                populateMobileMenu();
            });
            observer.observe(navDesktop, { childList: true });

            window.dispatchEvent(new Event('resize'));
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.toggle('active');
            }
        }

        const originalShowModule = window.showModule || function () { };
        window.showModule = function (moduleId) {
            originalShowModule(moduleId);

            const allButtons = document.querySelectorAll('nav button');
            allButtons.forEach(button => {
                button.classList.remove('active');
                const moduleName = document.querySelector(`#${moduleId} h2`)?.textContent || '';
                if (
                    button.textContent === moduleName ||
                    (moduleId === 'dashboard' && button.textContent === 'ڈیش بورڈ') ||
                    (moduleId === 'students' && button.textContent === 'طلباء') ||
                    (moduleId === 'teachers' && button.textContent === 'اساتذہ') ||
                    (moduleId === 'classes' && button.textContent === 'کلاسیں') ||
                    (moduleId === 'feeStructures' && button.textContent === 'فیس اسٹرکچر') ||
                    (moduleId === 'fees' && button.textContent === 'فیس') ||
                    (moduleId === 'attendance' && button.textContent === 'حاضری') ||
                    (moduleId === 'results' && button.textContent === 'نتائج') ||
                    (moduleId === 'timetable' && button.textContent === 'ٹائم ٹیبل / ڈیوٹی روسٹر') ||
                    (moduleId === 'expenses' && button.textContent === 'اخراجات') ||
                    (moduleId === 'reports' && button.textContent === 'رپورٹس') ||
                    (moduleId === 'settings' && button.textContent === 'سیٹنگز') ||
                    (moduleId === 'exportData' && button.textContent === 'ڈیٹا ایکسپورٹ') ||
                    (moduleId === 'idCardGenerator' && button.textContent === 'آئی ڈی کارڈ جنریٹر')
                ) {
                    button.classList.add('active');
                }
            });

            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu && mobileMenu.classList.contains('active')) {
                mobileMenu.classList.remove('active');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {

            setTimeout(initializeMobileNav, 200);
        });
    </script>
    <script>
        (function () {
            const dm_uniquePrefix = 'dm_modal_';
            const dm_easypaisaNumber = '03139842219';
            const dm_content = {
                ur: {
                    langCode: 'ur',
                    dir: 'rtl',
                    title: 'عطیات کی اپیل',
                    instructionsTitle: 'عطیہ کیسے بھیجیں:',
                    instructionsText: `اپنے EasyPaisa اکاؤنٹ سے ہمارے EasyPaisa نمبر ${dm_easypaisaNumber} پر رقم بھیجیں۔`,
                    projectMessage: 'آپ کے تمام عطیات صرف اسی پروجیکٹ کو بڑھانے کے لیے استعمال ہوں گے، کسی اور مقصد کے لیے نہیں۔ آپ کا تعاون ہمارے لیے قیمتی ہے۔',
                    closeButton: 'X',
                    verses: [
                        { text: 'جو لوگ اللہ کی راہ میں اپنے مال خرچ کرتے ہیں ان کی مثال اس دانے کی سی ہے جس سے سات بالیں اگیں، ہر بال میں سو دانے ہوں، اور اللہ جس کے لئے چاہتا ہے بڑھا دیتا ہے، اور اللہ وسعت والا، علم والا ہے۔', source: 'القرآن - البقرۃ 2:261' },
                        { text: 'رسول اللہ ﷺ نے فرمایا: "جب انسان مر جاتا ہے تو اس کے اعمال کا سلسلہ منقطع ہو جاتا ہے سوائے تین چیزوں کے: صدقہ جاریہ، یا علم جس سے نفع اٹھایا جائے، یا نیک اولاد جو اس کے لیے دعا کرے۔"', source: 'صحیح مسلم' },
                        { text: 'تم نیکی کو ہرگز نہیں پا سکو گے جب تک تم اپنی پسندیدہ چیزوں میں سے خرچ نہ کرو۔', source: 'القرآن - آل عمران 3:92' },
                        { text: 'رسول اللہ ﷺ نے فرمایا: "صدقہ گناہوں کو اس طرح مٹا دیتا ہے جس طرح پانی آگ کو بجھا دیتا ہے۔"', source: 'سنن الترمذی' },
                        { text: 'اور جو کچھ تم خرچ کرتے ہو وہ اس کا بدلہ دے گا اور وہ سب سے بہتر رزق دینے والا ہے۔', source: 'القرآن - سبا 34:39' },
                        { text: 'ان کے مال میں سے صدقہ (زکوٰۃ) وصول کرو جس کے ذریعہ سے تم انہیں پاک صاف کردو گے اور ان کے حق میں دعائے خیر کرو، بے شک تمہاری دعا ان کیلئے باعث تسکین ہے، اور اللہ سب کچھ سننے والا، سب کچھ جاننے والا ہے۔', source: 'القرآن - التوبۃ 9:103' },
                        { text: 'اگر تم اللہ کو قرضِ حسنہ دو گے تو وہ اُسے تمہارے لیے کئی گنا بڑھا دے گا اور تمہیں معاف فرما دے گا، اور اللہ بڑا قدردان، بڑا بردبار ہے۔', source: 'القرآن - التغابن 64:17' },
                        { text: 'بے شک جو لوگ ایمان لائے اور انہوں نے نیک عمل کئے اور نماز قائم رکھی اور زکوٰۃ ادا کرتے رہے اُن کے لئے اُن کے رب کے پاس اُن کا اجر ہے، ان پر نہ کوئی خوف ہوگا اور نہ وہ رنجیدہ ہوں گے۔', source: 'القرآن - البقرۃ 2:277' },
                        { text: 'رسول اللہ ﷺ نے فرمایا: "جہنم کی آگ سے بچو چاہے کھجور کے ایک ٹکڑے (صدقہ کرنے) کے ذریعے ہی ہو۔"', source: 'صحیح البخاری' },
                        { text: 'رسول اللہ ﷺ نے فرمایا: "صدقہ مال میں کمی نہیں کرتا..."', source: 'صحیح مسلم' },
                        { text: 'رسول اللہ ﷺ نے فرمایا: "قیامت کے دن مومن کا سایہ اس کا صدقہ ہوگا۔"', source: 'سنن الترمذی' }
                    ]
                },
                en: {
                    langCode: 'en',
                    dir: 'ltr',
                    title: 'Donation Appeal',
                    instructionsTitle: 'How to Donate:',
                    instructionsText: `Send your donation via EasyPaisa to our number: ${dm_easypaisaNumber}.`,
                    projectMessage: 'All your donations will be used exclusively for growing this project and not for any other purpose. Your support is valuable to us.',
                    closeButton: 'X',
                    verses: [
                        { text: 'The example of those who spend their wealth in the way of Allah is like a seed [of grain] which grows seven spikes; in each spike is a hundred grains. And Allah multiplies [His reward] for whom He wills. And Allah is all-Encompassing and Knowing.', source: 'Quran - Al-Baqarah 2:261' },
                        { text: 'The Messenger of Allah (ﷺ) said: "When a man dies, his deeds come to an end except for three things: Sadaqah Jariyah (ceaseless charity); knowledge which is beneficial; or a virtuous descendant who prays for him."', source: 'Sahih Muslim' },
                        { text: 'Never will you attain the good [reward] until you spend [in the way of Allah ] from that which you love.', source: 'Quran - Aal-E-Imran 3:92' },
                        { text: 'The Prophet (ﷺ) said: "Charity extinguishes sins just as water extinguishes fire."', source: 'Sunan al-Tirmidhi' },
                        { text: 'And whatever you spend of anything (in Allah’s Cause), He will replace it. And He is the Best of providers.', source: 'Quran - Saba 34:39' },
                        { text: 'Take, [O, Muhammad], from their wealth a charity by which you purify them and cause them increase, and invoke [ Allah \'s blessings] upon them. Indeed, your invocations are reassurance for them. And Allah is Hearing and Knowing.', source: 'Quran - At-Tawbah 9:103' },
                        { text: 'If you loan Allah a goodly loan, He will multiply it for you and forgive you. And Allah is Most Appreciative and Forbearing.', source: 'Quran - At-Taghabun 64:17' },
                        { text: 'Indeed, those who believe and do righteous deeds and establish prayer and give zakah will have their reward with their Lord, and there will be no fear concerning them, nor will they grieve.', source: 'Quran - Al-Baqarah 2:277' },
                        { text: 'The Prophet (ﷺ) said: "Protect yourself from hell-fire even by giving a piece of a date as charity."', source: 'Sahih al-Bukhari' },
                        { text: 'The Prophet (ﷺ) said: "Charity does not in any way decrease the wealth..."', source: 'Sahih Muslim' },
                        { text: 'The Prophet (ﷺ) said: "The believer\'s shade on the Day of Resurrection will be his charity."', source: 'Tirmidhi' }
                    ]
                },
                ar: {
                    langCode: 'ar',
                    dir: 'rtl',
                    title: 'نداء للتبرع',
                    instructionsTitle: 'كيفية التبرع:',
                    instructionsText: `أرسل تبرعك عبر EasyPaisa إلى رقمنا: ${dm_easypaisaNumber}.`,
                    projectMessage: 'سيتم استخدام جميع تبرعاتكم حصريًا لتنمية هذا المشروع وليس لأي غرض آخر. دعمكم قيم بالنسبة لنا.',
                    closeButton: 'X',
                    verses: [
                        { text: 'مَّثَلُ الَّذِينَ يُنفِقُونَ أَمْوَالَهُمْ فِي سَبِيلِ اللَّهِ كَمَثَلِ حَبَّةٍ أَنبَتَتْ سَبْعَ سَنَابِلَ فِي كُلِّ سُنبُلَةٍ مِّائَةُ حَبَّةٍ ۗ وَاللَّهُ يُضَاعِفُ لِمَن يَشَاءُ ۗ وَاللَّهُ وَاسِعٌ عَلِيمٌ', source: 'القرآن - البقرة 2:261' },
                        { text: 'قال رسول الله صلى الله عليه وسلم: "إِذَا مَاتَ الْإِنْسَانُ انْقَطَعَ عَنْهُ عَمَلُهُ إِلَّا مِنْ ثَلَاثَةٍ: إِلَّا مِنْ صَدَقَةٍ جَارِيَةٍ، أَوْ عِلْمٍ يُنْتَفَعُ بِهِ، أَوْ وَلَدٍ صَالِحٍ يَدْعُو لَهُ"', source: 'صحيح مسلم' },
                        { text: 'لَن تَنَالُوا الْبِرَّ حَتَّىٰ تُنفِقُوا مِمَّا تُحِبُّونَ ۚ وَمَا تُنفِقُوا مِن شَيْءٍ فَإِنَّ اللَّهَ بِهِ عَلِيمٌ', source: 'القرآن - آل عمران 3:92' },
                        { text: 'قال النبي صلى الله عليه وسلم: "الصَّدَقَةُ تُطْفِئُ الْخَطِيئَةَ كَمَا يُطْفِئُ الْمَاءُ النَّارَ"', source: 'سنن الترمذي' },
                        { text: 'وَمَا أَنفَقْتُم مِّن شَيْءٍ فَهُوَ يُخْلِفُهُ ۖ وَهُوَ خَيْرُ الرَّازِقِينَ', source: 'القرآن - سبأ 34:39' },
                        { text: 'خُذْ مِنْ أَمْوَالِهِمْ صَدَقَةً تُطَهِّرُهُمْ وَتُزَكِّيهِم بِهَا وَصَلِّ عَلَيْهِمْ ۖ إِنَّ صَلَاتَكَ سَكَنٌ لَّهُمْ ۗ وَاللَّهُ سَمِيعٌ عَلِيمٌ', source: 'القرآن - التوبة 9:103' },
                        { text: 'إِن تُقْرِضُوا اللَّهَ قَرْضًا حَسَنًا يُضَاعِفْهُ لَكُمْ وَيَغْفِرْ لَكُمْ ۚ وَاللَّهُ شَكُورٌ حَلِيمٌ', source: 'القرآن - التغابن 64:17' },
                        { text: 'إِنَّ الَّذِينَ آمَنُوا وَعَمِلُوا الصَّالِحَاتِ وَأَقَامُوا الصَّلَاةَ وَآتَوُا الزَّكَاةَ لَهُمْ أَجْرُهُمْ عِندَ رَبِّهِمْ وَلَا خَوْفٌ عَلَيْهِمْ وَلَا هُمْ يَحْزَنُونَ', source: 'القرآن - البقرة 2:277' },
                        { text: 'قال رسول الله صلى الله عليه وسلم: "اتَّقُوا النَّارَ وَلَوْ بِشِقِّ تَمْرَةٍ"', source: 'صحيح البخاري' },
                        { text: 'قال رسول الله صلى الله عليه وسلم: "مَا نَقَصَتْ صَدَقَةٌ مِنْ مَالٍ..."', source: 'صحيح مسلم' },
                        { text: 'قال رسول الله صلى الله عليه وسلم: "ظِلُّ الْمُؤْمِنِ يَوْمَ الْقِيَامَةِ صَدَقَتُهُ"', source: 'سنن الترمذي' }
                    ]
                }
            };
            let dm_currentLang = 'ur';
            let dm_modalElement = null;
            let dm_modalContentElement = null;
            let dm_titleElement = null;
            let dm_instructionsTitleElement = null;
            let dm_instructionsTextElement = null;
            let dm_projectMessageElement = null;
            let dm_verseElement = null;
            let dm_verseSourceElement = null;
            let dm_closeButtonElement = null;
            let dm_triggerButton = null;
            function dm_applyStyles() {
                const styles = `
            .${dm_uniquePrefix}trigger {
                position: fixed;
                bottom: 20px;
                left: 20px;
                background-color: #007bff;
                color: white;
                border: none;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                font-size: 24px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                z-index: 9999;
                transition: background-color 0.3s ease;
            }
            .${dm_uniquePrefix}trigger:hover {
                background-color: #0056b3;
            }
             .${dm_uniquePrefix}trigger span {
                 margin: 0 -13px;
             }
            .${dm_uniquePrefix}modal {
                display: none;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.8);
                opacity: 0;
                transition: opacity 0.3s ease-in-out;
            }
            .${dm_uniquePrefix}modal.active {
                display: flex;
                opacity: 1;
                align-items: center;
                justify-content: center;
            }
            .${dm_uniquePrefix}content {
                background-color: #fefefe;
                margin: auto;
                padding: 30px;
                border: 1px solid #888;
                width: 90%;
                max-width: 78%;
                max-height: 98vh;
                overflow-y: auto;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                position: relative;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                line-height: 1.6;
                color: #333;
            }
            .${dm_uniquePrefix}content[dir="rtl"] {
                text-align: right;
            }
             .${dm_uniquePrefix}content[dir="ltr"] {
                text-align: left;
            }
            .${dm_uniquePrefix}header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
                margin-bottom: 20px;
            }
            .${dm_uniquePrefix}title {
                margin: 0;
                font-size: 1.8em;
                font-weight: 600;
            }
            .${dm_uniquePrefix}lang-switcher button {
                background: green;
                border: 1px solid #ccc;
                padding: 5px 10px;
                margin: 0 3px;
                cursor: pointer;
                border-radius: 4px;
                font-size: 0.9em;
                transition: background-color 0.2s ease, color 0.2s ease;
            }
            .${dm_uniquePrefix}lang-switcher button:hover {
                background-color: #f0f0f0;
            }
            .${dm_uniquePrefix}lang-switcher button.active {
                background-color: #007bff;
                color: white;
                border-color: #007bff;
            }
            .${dm_uniquePrefix}close {
                background: none;
                border: none;
                font-size: 2.5em;
                font-weight: bold;
                cursor: pointer;
                color: #aaa;
                padding: 0 10px;
                line-height: 1;
            }
            .${dm_uniquePrefix}close:hover,
            .${dm_uniquePrefix}close:focus {
                color: black;
                text-decoration: none;
            }
             .${dm_uniquePrefix}section {
                 margin-bottom: 25px;
             }
             .${dm_uniquePrefix}section h3 {
                 font-size: 1.4em;
                 margin-bottom: 10px;
                 color: #0056b3;
             }
            .${dm_uniquePrefix}instructions-text {
                font-size: 1.1em;
                font-weight: bold;
                color: #1a1a1a;
                word-break: break-all; 
            }
            .${dm_uniquePrefix}project-message {
                font-size: 1em;
                color: #555;
                 background-color: #f9f9f9;
                 padding: 15px;
                 border-left: 4px solid #007bff;
                 border-right: 4px solid #007bff;
                 border-radius: 4px;
            }
            .${dm_uniquePrefix}content[dir="rtl"] .${dm_uniquePrefix}project-message {
                border-left: none;
                border-right: 4px solid #007bff;
            }
            .${dm_uniquePrefix}content[dir="ltr"] .${dm_uniquePrefix}project-message {
                border-right: none;
                border-left: 4px solid #007bff;
            }
            .${dm_uniquePrefix}verse {
                font-style: italic;
                margin-top: 15px;
                padding: 15px;
                background-color: #eef;
                border-radius: 4px;
                border-left: 4px solid #6f42c1;
                border-right: 4px solid #6f42c1;
            }
            .${dm_uniquePrefix}content[dir="rtl"] .${dm_uniquePrefix}verse {
                border-left: none;
                border-right: 4px solid #6f42c1;
            }
            .${dm_uniquePrefix}content[dir="ltr"] .${dm_uniquePrefix}verse {
                border-right: none;
                border-left: 4px solid #6f42c1;
            }
            .${dm_uniquePrefix}verse-text {
                 display: block;
                 margin-bottom: 8px;
                 font-size: 1.1em;
             }
            .${dm_uniquePrefix}verse-source {
                 display: block;
                 text-align: end;
                 font-size: 0.9em;
                 color: #555;
             }
             .${dm_uniquePrefix}content[dir="ltr"] .${dm_uniquePrefix}verse-source {
                 text-align: right;
             }
              .${dm_uniquePrefix}content[dir="rtl"] .${dm_uniquePrefix}verse-source {
                 text-align: left;
             }
            @media (max-width: 600px) {
                .${dm_uniquePrefix}trigger {
                    width: 50px;
                    height: 50px;
                    font-size: 20px;
                    bottom: 15px;
                    left: 15px;
                }
                .${dm_uniquePrefix}content {
                    width: 95%;
                    padding: 20px;
                    max-height: 95vh;
                }
                 .${dm_uniquePrefix}title {
                     font-size: 1.5em;
                 }
                 .${dm_uniquePrefix}lang-switcher button {
                     padding: 4px 8px;
                     font-size: 0.8em;
                 }
                 .${dm_uniquePrefix}close {
                     font-size: 2em;
                 }
                 .${dm_uniquePrefix}section h3 {
                     font-size: 1.2em;
                 }
                 .${dm_uniquePrefix}instructions-text, .${dm_uniquePrefix}project-message, .${dm_uniquePrefix}verse-text {
                     font-size: 1em;
                 }
            }
        `;
                const styleSheet = document.createElement("style");
                styleSheet.type = "text/css";
                styleSheet.innerText = styles;
                document.head.appendChild(styleSheet);
            }
            function dm_getRandomVerse(lang) {
                const verses = dm_content[lang].verses;
                const randomIndex = Math.floor(Math.random() * verses.length);
                return verses[randomIndex];
            }
            function dm_updateContent(lang) {
                dm_currentLang = lang;
                const contentData = dm_content[lang];
                const verse = dm_getRandomVerse(lang);
                if (!dm_modalContentElement) return;
                dm_modalContentElement.lang = contentData.langCode;
                dm_modalContentElement.dir = contentData.dir;
                dm_titleElement.textContent = contentData.title;
                dm_instructionsTitleElement.textContent = contentData.instructionsTitle;
                dm_instructionsTextElement.textContent = contentData.instructionsText;
                dm_projectMessageElement.textContent = contentData.projectMessage;
                dm_verseElement.textContent = verse.text;
                dm_verseSourceElement.textContent = `- ${verse.source}`;
                dm_closeButtonElement.textContent = contentData.closeButton;
                dm_closeButtonElement.setAttribute('aria-label', contentData.closeButton);
                document.querySelectorAll(`.${dm_uniquePrefix}lang-switcher button`).forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-lang') === lang) {
                        btn.classList.add('active');
                    }
                });
            }
            function dm_createModal() {
                dm_modalElement = document.createElement('div');
                dm_modalElement.id = `${dm_uniquePrefix}modal`;
                dm_modalElement.className = `${dm_uniquePrefix}modal`;
                dm_modalElement.setAttribute('role', 'dialog');
                dm_modalElement.setAttribute('aria-modal', 'true');
                dm_modalElement.setAttribute('aria-labelledby', `${dm_uniquePrefix}title`);
                dm_modalElement.setAttribute('aria-describedby', `${dm_uniquePrefix}desc`);
                dm_modalContentElement = document.createElement('div');
                dm_modalContentElement.className = `${dm_uniquePrefix}content`;
                const header = document.createElement('div');
                header.className = `${dm_uniquePrefix}header`;
                dm_titleElement = document.createElement('h2');
                dm_titleElement.id = `${dm_uniquePrefix}title`;
                dm_titleElement.className = `${dm_uniquePrefix}title`;
                const langSwitcher = document.createElement('div');
                langSwitcher.className = `${dm_uniquePrefix}lang-switcher`;
                ['ur', 'en', 'ar'].forEach(lang => {
                    const button = document.createElement('button');
                    button.textContent = lang.toUpperCase();
                    button.setAttribute('data-lang', lang);
                    button.setAttribute('aria-label', `Switch to ${dm_content[lang].title}`);
                    button.onclick = () => dm_updateContent(lang);
                    langSwitcher.appendChild(button);
                });
                dm_closeButtonElement = document.createElement('button');
                dm_closeButtonElement.className = `${dm_uniquePrefix}close`;
                dm_closeButtonElement.innerHTML = '&times;';
                dm_closeButtonElement.onclick = dm_closeModal;
                header.appendChild(dm_titleElement);
                header.appendChild(langSwitcher);
                header.appendChild(dm_closeButtonElement);
                const descriptionDiv = document.createElement('div');
                descriptionDiv.id = `${dm_uniquePrefix}desc`;
                const instructionsSection = document.createElement('div');
                instructionsSection.className = `${dm_uniquePrefix}section`;
                dm_instructionsTitleElement = document.createElement('h3');
                dm_instructionsTextElement = document.createElement('p');
                dm_instructionsTextElement.className = `${dm_uniquePrefix}instructions-text`;
                instructionsSection.appendChild(dm_instructionsTitleElement);
                instructionsSection.appendChild(dm_instructionsTextElement);
                const projectMessageSection = document.createElement('div');
                projectMessageSection.className = `${dm_uniquePrefix}section`;
                dm_projectMessageElement = document.createElement('p');
                dm_projectMessageElement.className = `${dm_uniquePrefix}project-message`;
                projectMessageSection.appendChild(dm_projectMessageElement);
                const verseSection = document.createElement('div');
                verseSection.className = `${dm_uniquePrefix}section`;
                const verseBlock = document.createElement('blockquote');
                verseBlock.className = `${dm_uniquePrefix}verse`;
                dm_verseElement = document.createElement('span');
                dm_verseElement.className = `${dm_uniquePrefix}verse-text`;
                dm_verseSourceElement = document.createElement('cite');
                dm_verseSourceElement.className = `${dm_uniquePrefix}verse-source`;
                verseBlock.appendChild(dm_verseElement);
                verseBlock.appendChild(dm_verseSourceElement);
                verseSection.appendChild(verseBlock);
                descriptionDiv.appendChild(instructionsSection);
                descriptionDiv.appendChild(projectMessageSection);
                descriptionDiv.appendChild(verseSection);
                dm_modalContentElement.appendChild(header);
                dm_modalContentElement.appendChild(descriptionDiv);
                dm_modalElement.appendChild(dm_modalContentElement);
                document.body.appendChild(dm_modalElement);
                dm_modalElement.addEventListener('click', function (event) {
                    if (event.target === dm_modalElement) {
                        dm_closeModal();
                    }
                });
                dm_updateContent(dm_currentLang);
            }
            function dm_createTriggerButton() {
                dm_triggerButton = document.createElement('button');
                dm_triggerButton.id = `${dm_uniquePrefix}trigger`;
                dm_triggerButton.className = `${dm_uniquePrefix}trigger`;
                dm_triggerButton.setAttribute('aria-label', dm_content[dm_currentLang].title || 'Open Donation Modal');
                dm_triggerButton.innerHTML = '<span>❤️</span><span>💰</span>';
                dm_triggerButton.onclick = dm_openModal;
                document.body.appendChild(dm_triggerButton);
            }
            function dm_openModal() {
                if (!dm_modalElement) {
                    dm_createModal();
                }
                dm_updateContent(dm_currentLang);
                dm_modalElement.style.display = 'flex';
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        dm_modalElement.classList.add('active');
                        dm_closeButtonElement.focus();
                    });
                });
                document.body.style.overflow = 'hidden';
                dm_triggerButton.setAttribute('aria-expanded', 'true');
            }
            function dm_closeModal() {
                dm_modalElement.classList.remove('active');
                dm_modalElement.addEventListener('transitionend', () => {
                    dm_modalElement.style.display = 'none';
                    document.body.style.overflow = '';
                    dm_triggerButton.focus();
                    dm_triggerButton.setAttribute('aria-expanded', 'false');
                }, { once: true });
            }
            function dm_init() {
                dm_applyStyles();
                dm_createTriggerButton();
                dm_createModal();
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', dm_init);
            } else {
                dm_init();
            }
        })();
        const target = document.querySelector('#dashboardDetailedReportOutput > div');

        const observer = new MutationObserver(() => {
            const el = document.querySelector('#dashboardDetailedReportOutput > div > div:nth-child(3)');
            if (!el) return;
            const text = el.textContent;
            if (text.includes('-')) {
                el.style.background = 'red';
                el.style.padding = '5px';
                el.style.color = 'white';
            } else {
                el.style.background = '';
                el.style.padding = '';
                el.style.color = '';
            }
        });

        observer.observe(target, { childList: true, subtree: true, characterData: true });



        (function () {
            // --- Start of Communication Module ---

            function initializeCommunicationModule() {
                // 1. Create the button in the Settings module to launch the new feature
                const settingsModule = document.getElementById('settings');
                if (settingsModule) {
                    const launcherButton = document.createElement('button');
                    launcherButton.textContent = 'SMS / WhatsApp براڈکاسٹ';
                    launcherButton.style.backgroundColor = '#007bff';
                    launcherButton.onclick = () => launchCommunicationModal();

                    // Find the "Print Settings" section to insert the button before it
                    const printSettingsHeader = Array.from(settingsModule.querySelectorAll('h3')).find(h => h.textContent.includes('Print Settings'));
                    if (printSettingsHeader) {
                        printSettingsHeader.parentNode.insertBefore(launcherButton, printSettingsHeader);
                    } else {
                        settingsModule.appendChild(launcherButton);
                    }
                }

                // 2. Create the Modal HTML structure dynamically
                const modal = document.createElement('div');
                modal.id = 'communicationModal';
                modal.className = 'comm-modal';
                modal.innerHTML = `
            <div class="comm-modal-content">
                <div class="comm-modal-header">
                    <h2>SMS / WhatsApp براڈکاسٹ</h2>
                    <button class="comm-close-btn" onclick="closeCommunicationModal()">×</button>
                </div>
                <div class="comm-modal-body">
                    <div class="comm-grid">
                        <!-- Column 1: Configuration -->
                        <div class="comm-config-panel">
                            <h3>مرحلہ ۱: سیٹ اپ</h3>
                            
                            <label for="commPlatform">پلیٹ فارم منتخب کریں:</label>
                            <select id="commPlatform">
                                <option value="sms">SMS (Text Message)</option>
                                <option value="whatsapp">WhatsApp</option>
                            </select>

                            <label for="commRecipientType">وصول کنندہ کی قسم:</label>
                            <select id="commRecipientType" onchange="handleRecipientTypeChange()">
                                <option value="">-- منتخب کریں --</option>
                                <option value="students">طلباء</option>
                                <option value="teachers">اساتذہ</option>
                            </select>

                            <div id="commClassFilterContainer" style="display:none;">
                                <label for="commClassFilter">کلاس کے لحاظ سے فلٹر کریں:</label>
                                <select id="commClassFilter" onchange="handleRecipientTypeChange()">
                                    <option value="">تمام کلاسیں</option>
                                </select>
                            </div>
                        </div>

                        <!-- Column 2: Recipient List -->
                        <div class="comm-recipients-panel">
                            <h3>مرحلہ ۲: وصول کنندگان منتخب کریں</h3>
                            <div class="comm-select-all-container">
                                <input type="checkbox" id="commSelectAll" onchange="toggleSelectAllRecipients(this.checked)">
                                <label for="commSelectAll">سب کو منتخب کریں</label>
                            </div>
                            <div id="commRecipientList">
                                <p>براہ کرم وصول کنندہ کی قسم منتخب کریں۔</p>
                            </div>
                        </div>

                        <!-- Column 3: Message Composition -->
                        <div class="comm-message-panel">
                            <h3>مرحلہ ۳: پیغام لکھیں</h3>
                            <label for="commMessageType">پیغام کی قسم:</label>
                            <select id="commMessageType" onchange="handleMessageTypeChange()">
                                <option value="custom">اپنی مرضی کا پیغام</option>
                                <option value="fee_reminder">فیس یاد دہانی</option>
                                <option value="attendance_absent">غیر حاضری کی اطلاع</option>
                                <option value="exam_result">امتحانی نتیجہ</option>
                                <option value="salary_notification">تنخواہ کی اطلاع</option>
                            </select>

                            <label for="commMessageBody">پیغام کا متن:</label>
                            <textarea id="commMessageBody" rows="6" placeholder="یہاں اپنا پیغام لکھیں۔"></textarea>
                            <div class="comm-placeholders">
                                <strong>Placeholders:</strong> [name], [father_name], [class], [contact], [date]
                            </div>

                            <label>پیغام کا پیش نظارہ (پہلے وصول کنندہ کی بنیاد پر):</label>
                            <div id="commMessagePreview"></div>
                        </div>
                    </div>
                </div>
                <div class="comm-modal-footer">
                    <button id="commSendButton" onclick="handleSendMessages()">پیغامات بھیجیں</button>
                </div>
            </div>
        `;
                document.body.appendChild(modal);
                const messageBodyTextarea = document.getElementById('commMessageBody');
                if (messageBodyTextarea) {
                    messageBodyTextarea.addEventListener('input', updateMessagePreview);
                }
                // 3. Inject the necessary CSS
                const style = document.createElement('style');
                style.textContent = `
            .comm-modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0; top: 0;
                width: 100%; height: 100%;
                overflow: auto;
                background-color: rgba(0,0,0,0.6);
                align-items: center;
                justify-content: center;
                font-family: 'Noto Nastaliq Urdu', sans-serif;
            }
            .comm-modal-content {
                background-color: #f8f9fa;
                color: #333;
                margin: auto;
                padding: 20px;
                border-radius: 8px;
                width: 95%;
                max-width: 1400px;
                /* height: 90vh; */
                display: flex;
                flex-direction: column;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            .comm-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 15px;
                direction: rtl;
            }
            .comm-modal-header h2 { margin: 0; color: #007bff; }
            .comm-close-btn {
                background: none; border: none; font-size: 2.5rem;
                cursor: pointer; color: #6c757d; line-height: 1;
            }
            .comm-modal-body {
                flex-grow: 1;
                overflow-y: auto;
                padding: 20px 0;
            }
            .comm-grid {
                display: grid;
                grid-template-columns: 250px 1fr 1fr;
                gap: 20px;
                height: 100%;
                direction: rtl;
            }
            .comm-grid > div {
                background-color: #fff;
                padding: 15px;
                border-radius: 5px;
                border: 1px solid #e9ecef;
                display: flex;
                flex-direction: column;
            }
            .comm-grid h3 {
                margin-top: 0;
                border-bottom: 2px solid #007bff;
                padding-bottom: 10px;
                margin-bottom: 15px;
            }
            .comm-recipients-panel #commRecipientList {
                flex-grow: 1;
                overflow-y: auto;
                border: 1px solid #ccc;
                padding: 10px;
                background: #f9f9f9;
            }
            .comm-recipient-item { margin-bottom: 5px; }
            .comm-select-all-container { margin-bottom: 10px; }
            .comm-modal-body label { font-weight: bold; margin-top: 10px; display: block; }
            .comm-modal-body select, .comm-modal-body textarea {
                width: 100%; padding: 8px; margin-top: 5px;
                border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem;
            }
            .comm-placeholders { font-size: 0.8rem; color: #6c757d; margin-top: 5px; direction: ltr; }
            #commMessagePreview {
                margin-top: 10px; padding: 10px; background: #e9ecef;
                border-radius: 4px; min-height: 50px; white-space: pre-wrap;
            }
            .comm-modal-footer {
                border-top: 1px solid #dee2e6;
                padding-top: 15px; text-align: left;
            }
            #commSendButton {
                background-color: #28a745; color: white; padding: 12px 25px;
                border: none; border-radius: 5px; cursor: pointer; font-size: 1.2rem;
            }
            #commSendButton:hover { background-color: #218838; }

            @media (max-width: 992px) {
                .comm-grid { grid-template-columns: 1fr; }
                .comm-recipients-panel { min-height: 250px; }
            }
        `;
                document.head.appendChild(style);
            }

            // --- Module Logic ---

            window.launchCommunicationModal = async function () {
                const modal = document.getElementById('communicationModal');
                if (modal) {
                    modal.style.display = 'flex';
                    // Populate class filter dropdown
                    const classSelect = document.getElementById('commClassFilter');
                    classSelect.innerHTML = '<option value="">تمام کلاسیں</option>';
                    try {
                        const classes = await getAll(STORE_CLASSES);
                        classes.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
                            const option = document.createElement('option');
                            option.value = cls.id;
                            option.textContent = cls.name;
                            classSelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error("Error loading classes for comms module:", error);
                    }
                }
            }

            window.closeCommunicationModal = function () {
                const modal = document.getElementById('communicationModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            window.handleRecipientTypeChange = async function () {
                const type = document.getElementById('commRecipientType').value;
                const classFilterContainer = document.getElementById('commClassFilterContainer');
                const recipientListDiv = document.getElementById('commRecipientList');
                const classId = document.getElementById('commClassFilter').value;

                classFilterContainer.style.display = type === 'students' ? 'block' : 'none';
                recipientListDiv.innerHTML = '<p>لوڈ ہو رہا ہے...</p>';

                if (!type) {
                    recipientListDiv.innerHTML = '<p>براہ کرم وصول کنندہ کی قسم منتخب کریں۔</p>';
                    return;
                }

                try {
                    const storeName = type === 'students' ? STORE_STUDENTS : STORE_TEACHERS;
                    let recipients = await getAll(storeName);

                    if (type === 'students' && classId) {
                        recipients = recipients.filter(s => s.classId === parseInt(classId));
                    }

                    if (recipients.length === 0) {
                        recipientListDiv.innerHTML = '<p>کوئی وصول کنندہ نہیں ملا۔</p>';
                        return;
                    }

                    let listHtml = '';
                    for (const person of recipients) {
                        if (person.contact) { // Only show recipients with a contact number
                            const className = type === 'students' ? `(${await getClassName(person.classId) || 'N/A'})` : '';
                            listHtml += `
                        <div class="comm-recipient-item">
                            <input type="checkbox" class="comm-recipient-checkbox" value="${person.id}" onchange="updateMessagePreview()">
                            <label>${person.name} ${className} - ${person.contact}</label>
                        </div>
                    `;
                        }
                    }
                    recipientListDiv.innerHTML = listHtml || '<p>اس معیار پر کوئی وصول کنندہ نہیں ملا جس کا رابطہ نمبر موجود ہو۔</p>';
                    setTimeout(() => {
                        document.querySelectorAll(".comm-recipient-item label").forEach(label => {
                            const text = label.textContent;
                            const match = text.match(/\d{4}-\d{7}/);
                            if (match) {
                                const nameClass = text.replace(/\s*-\s*\d{4}-\d{7}/, '').trim();
                                label.innerHTML = `${nameClass}<br><small style="color:#555">${match[0]}</small>`;
                            }
                        });
                    }, 300);
                    updateMessagePreview();

                } catch (error) {
                    console.error("Error fetching recipients:", error);
                    recipientListDiv.innerHTML = '<p>وصول کنندگان کو لوڈ کرنے میں خرابی۔</p>';
                }
            }

            window.toggleSelectAllRecipients = function (checked) {
                document.querySelectorAll('.comm-recipient-checkbox').forEach(cb => {
                    cb.checked = checked;
                });
                updateMessagePreview();
            }

            window.handleMessageTypeChange = function () {
                const type = document.getElementById('commMessageType').value;
                const messageBody = document.getElementById('commMessageBody');
                let template = '';

                switch (type) {
                    case 'fee_reminder':
                        template = 'محترم والد صاحب/سرپرست،\n[name] کی فیس واجب الادا ہے۔ برائے مہربانی جلد از جلد جمع کرائیں۔\nشکریہ،\n[مدرسہ کا نام]';
                        break;
                    case 'attendance_absent':
                        template = 'محترم والد صاحب/سرپرست،\nآپ کو مطلع کیا جاتا ہے کہ [name] آج، [date]، کو مدرسہ سے غیر حاضر ہے۔\nشکریہ،\n[مدرسہ کا نام]';
                        break;
                    case 'exam_result':
                        template = 'محترم والد صاحب/سرپرست،\n[name] کے امتحانی نتائج تیار ہیں۔ آپ مدرسہ سے نتیجہ کارڈ حاصل کر سکتے ہیں۔\nشکریہ،\n[مدرسہ کا نام]';
                        break;
                    case 'salary_notification':
                        template = 'محترم [name]،\nآپ کی ماہانہ تنخواہ آپ کے اکاؤنٹ میں منتقل کر دی گئی ہے۔\nشکریہ،\n[مدرسہ کا نام]';
                        break;
                    case 'custom':
                    default:
                        template = '';
                        break;
                }
                messageBody.value = template;
                updateMessagePreview();
            }

            window.updateMessagePreview = async function () {
                const previewDiv = document.getElementById('commMessagePreview');
                const messageTemplate = document.getElementById('commMessageBody').value;
                const firstSelected = document.querySelector('.comm-recipient-checkbox:checked');

                if (!firstSelected) {
                    previewDiv.textContent = 'ایک پیغام دیکھنے کے لیے کم از کم ایک وصول کنندہ منتخب کریں۔';
                    return;
                }

                try {
                    const recipientType = document.getElementById('commRecipientType').value;
                    const storeName = recipientType === 'students' ? STORE_STUDENTS : STORE_TEACHERS;
                    const person = await getById(storeName, parseInt(firstSelected.value));
                    if (!person) return;

                    const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                    const schoolName = schoolNameSetting ? schoolNameSetting.value : "مدرسہ";

                    let personalizedMessage = messageTemplate
                        .replace(/\[name\]/g, person.name || '')
                        .replace(/\[father_name\]/g, person.fatherName || '')
                        .replace(/\[contact\]/g, person.contact || '')
                        .replace(/\[date\]/g, new Date().toLocaleDateString('ur-PK'))
                        .replace(/\[مدرسہ کا نام\]/g, schoolName);

                    if (recipientType === 'students') {
                        const className = await getClassName(person.classId);
                        personalizedMessage = personalizedMessage.replace(/\[class\]/g, className || '');
                    }

                    previewDiv.textContent = personalizedMessage;
                } catch (error) {
                    console.error("Error updating preview:", error);
                    previewDiv.textContent = 'پیش نظارہ بنانے میں خرابی۔';
                }
            }

            function formatPhoneNumberForWhatsApp(number) {
                if (!number) return null;
                let cleaned = number.replace(/[^0-9]/g, ''); // Remove all non-numeric characters
                if (cleaned.startsWith('03')) {
                    return '92' + cleaned.substring(1); // Replace leading 0 with 92
                }
                if (cleaned.startsWith('92')) {
                    return cleaned; // Already in correct format
                }
                // Add other country code logic here if needed
                return cleaned; // Fallback
            }

            window.handleSendMessages = async function () {
                const platform = document.getElementById('commPlatform').value;
                const messageTemplate = document.getElementById('commMessageBody').value;
                const selectedCheckboxes = Array.from(document.querySelectorAll('.comm-recipient-checkbox:checked'));

                if (selectedCheckboxes.length === 0) {
                    alert('براہ کرم کم از کم ایک وصول کنندہ منتخب کریں۔');
                    return;
                }

                if (!messageTemplate.trim()) {
                    alert('پیغام خالی نہیں ہو سکتا۔');
                    return;
                }

                const confirmMessage = `آپ ${selectedCheckboxes.length} وصول کنندگان کو پیغام بھیجنے والے ہیں۔\nنوٹ: یہ آپ کے آلہ پر ${platform.toUpperCase()} ایپ میں ہر وصول کنندہ کے لیے ایک نیا چیٹ/ڈرافٹ کھولے گا۔\n\nکیا آپ جاری رکھنا چاہتے ہیں؟`;
                if (!confirm(confirmMessage)) {
                    return;
                }

                const recipientType = document.getElementById('commRecipientType').value;
                const storeName = recipientType === 'students' ? STORE_STUDENTS : STORE_TEACHERS;
                const schoolNameSetting = await getById(STORE_SETTINGS, 'schoolName');
                const schoolName = schoolNameSetting ? schoolNameSetting.value : "مدرسہ";

                let sentCount = 0;
                for (const cb of selectedCheckboxes) {
                    try {
                        const person = await getById(storeName, parseInt(cb.value));
                        if (!person || !person.contact) continue;

                        let personalizedMessage = messageTemplate
                            .replace(/\[name\]/g, person.name || '')
                            .replace(/\[father_name\]/g, person.fatherName || '')
                            .replace(/\[contact\]/g, person.contact || '')
                            .replace(/\[date\]/g, new Date().toLocaleDateString('ur-PK'))
                            .replace(/\[مدرسہ کا نام\]/g, schoolName);
                        if (recipientType === 'students') {
                            const className = await getClassName(person.classId);
                            personalizedMessage = personalizedMessage.replace(/\[class\]/g, className || '');
                        }

                        const encodedMessage = encodeURIComponent(personalizedMessage);
                        let url;

                        if (platform === 'sms') {
                            url = `sms:${person.contact}?body=${encodedMessage}`;
                        } else { // whatsapp
                            const formattedNumber = formatPhoneNumberForWhatsApp(person.contact);
                            if (formattedNumber) {
                                url = `https://wa.me/${formattedNumber}?text=${encodedMessage}`;
                            } else {
                                console.warn(`Skipping invalid WhatsApp number: ${person.contact}`);
                                continue;
                            }
                        }

                        window.open(url, '_blank');
                        sentCount++;
                        // A small delay to prevent browsers from blocking too many popups at once
                        if (sentCount % 5 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }

                    } catch (error) {
                        console.error(`Failed to generate message link for person ID ${cb.value}:`, error);
                    }
                }

                alert(`${sentCount} پیغامات کے لیے لنکس تیار کر دیے گئے ہیں۔ براہ کرم ہر ٹیب/ایپ میں بھیجنے کی تصدیق کریں۔`);
            }

            // Initialize the module when the DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCommunicationModule);
            } else {
                initializeCommunicationModule();
            }

        })();
    </script>
</body>

</html>